try{(self.webpackChunkvk=self.webpackChunkvk||[]).push([[30996],{731803:(e,t,s)=>{s.d(t,{T:()=>o,a:()=>a});var i=s(386404),r=s(932216);function o(e){return!(!e||"object"!=typeof e)&&e.type===i.$.NETWORK_ERROR}const a=({debugPrefix:e="[Sentry Logger]",isConsoleEnabled:t=!1,environment:s,catchNetworkError:i})=>{function a(t,s){return`${e} `+(s?`${s}: ${t}`:t)}return function(n){const{error:h,additionalText:d,extra:c,environment:l}=n,u=l||s;if(t&&console.error(e,{error:h,additionalText:d||"Some error happened",extra:c,environment:u}),i&&o(h)&&i(n))return;const v=c?{environment:l,breadcrumb:{data:{extra:c}}}:{environment:u};if(h instanceof Error){const e=new Error(a(h.message,d));return e.name=h.name,e.stack=h.stack,void(0,r.vV)(e,v)}if("string"!=typeof h)return h instanceof Object?(v.breadcrumb?.data?v.breadcrumb.data.object=h:v.breadcrumb={...v.breadcrumb,data:{object:h}},void(0,r.vV)(new Error(a("Error as object",d)),v)):void(h||!d?(0,r.vV)(new Error(a("Unknown error")),v):(0,r.vV)(new Error(a(d)),v));(0,r.vV)(new Error(a(h,d)),v)}}},288602:(e,t,s)=>{s.d(t,{RB:()=>r,ez:()=>n,i1:()=>d,rY:()=>h,sI:()=>a});var i=s(9467),r=function(e){return e.FEED_LOADED="stories_feed_loaded",e.FEED_FAILED="stories_feed_failed",e.GROUPS_LOADED="stories_groups_loaded",e.DISCOVER_LOADED="stories_discover_loaded",e.SEARCH_FEED_LOADED="stories_search_feed_loaded",e.SEARCH_FEED_FAILED="stories_search_feed_failed",e}({});function o(){return(0,i.z2)("stories_web_dispatch_events_from_microtasks")?queueMicrotask:setTimeout}function a(){o()((()=>{window.dispatchEvent(new CustomEvent("stories_feed_loaded"))}))}function n(){o()((()=>{window.dispatchEvent(new CustomEvent("stories_feed_failed"))}))}function h(){o()((()=>{window.dispatchEvent(new CustomEvent("stories_discover_loaded"))}))}function d(){o()((()=>{window.dispatchEvent(new CustomEvent("stories_search_feed_loaded"))}))}},311730:(e,t,s)=>{function i(e){if(!e)return!1;if(void 0!==e.has_unseen)return e.has_unseen;let t=e.stories?.some((e=>!e.seen));return!!t||(t=e.grouped?.some((e=>i(e))),Boolean(t))}s.d(t,{q:()=>i})},861650:(e,t,s)=>{s.d(t,{J:()=>d});var i=s(331635),r=s(288602),o=function(e){return e.BLOCK_SCROLL_TO_CENTER="block_scroll_to_center",e.BLOCK_RESET_SCROLL="block_reset_scroll",e}({}),a=s(42107),n=s(327813),h=s(946164);class d{dispatchDiscoverLoadedEvent(){(0,r.rY)()}dispatchFeedLoadedEvent(){(0,r.sI)()}dispatchFeedFailedEvent(){(0,r.ez)()}dispatchSearchFeedLoadedEvent(){(0,r.i1)()}subscribe(e,t){return window.addEventListener(e,t),()=>window.removeEventListener(e,t)}dispatchStoryBlockScrollToCenterEvent(e){window.dispatchEvent(new CustomEvent(o.BLOCK_SCROLL_TO_CENTER,{detail:e}))}dispatchStoryBlockResetScrollEvent(){window.dispatchEvent(new CustomEvent(o.BLOCK_RESET_SCROLL))}dispatchFeedListModifiedEvent(e){window.dispatchEvent(new CustomEvent(h.qm.LIST_MODIFIED,{detail:e}))}constructor(){(0,n.l_)(this)}}d=(0,i.Cg)([a.z8.global(),(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[])],d)},830996:(e,t,s)=>{s.d(t,{W:()=>Z});var i=s(331635),r=s(42107),o=s(645189),a=s(144819),n=s(327813),h=s(646642),d=s(946164),c=s(311730),l=s(612495),u=s(323763),v=s(800191),L=s(349785);class g{constructor(e,t){this.storiesApi=e,this.statLog=t,(0,n.l_)(this),this.list=new u.n(this.storiesApi,this.statLog)}}g=(0,i.Cg)([r.z8.global(),(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[void 0===v.o?Object:v.o,void 0===L.R?Object:L.R])],g);var f=s(223548),p=s(193132),E=s(38078),_=s(529931);class w{hasStoryList(e){return Boolean((0,E.uW)(e))}setApiStoryList(e,t){(0,E.y0)(e,(0,p.mZ)(t,e,!1))}saveDiscover(e){const t=(0,E.uW)(h.Jg.feed);if(t){const s=t.find((e=>e.type===_.zE.discover));if(s){const t=(0,E.qn)(h.Jg.discover,e);s.grouped=[...s.grouped||[],...t],s.next_from=e?.next_from||""}(0,E.y0)(h.Jg.feed,t)}}constructor(){(0,n.l_)(this)}}w=(0,i.Cg)([r.z8.global(),(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[])],w);var m=s(861650),S=s(227210);class y{get storiesEvents(){if(!this.events)throw new Error("storiesEvents not initialized");return this.events}get storiesCache(){if(!this.cache)throw new Error("storiesCache not initialized");return this.cache}get discoverList(){return(0,S.vB)()?{discover:this.storiesProvider.discover}:this.discoverListProvider.list}get discover(){return this.discoverList.discover}async getThisPromise(e,t,s){try{const s=await this.discover.fetch({start_from:t,track_code:e});return this.prepareResponseForStoryViewer(s),this.storiesEvents.dispatchDiscoverLoadedEvent(),s}catch(e){throw e}finally{s?.()}}fetch(e,t){return this.promise||(this.promise=this.getThisPromise(e,t,(()=>{delete this.promise}))),this.promise}prepareResponseForStoryViewer(e){this.storiesCache.saveDiscover(e)}getList(){return this.discover}isLoading(){return this.discover.isLoading()}isLoaded(){return this.discover.isLoaded()}abort(){this.discover.isLoading()&&this.discover.abort()}reset(){this.discover.reset()}constructor(e,t,s,i,r){this.discoverListProvider=e,this.storiesProvider=t,this.userEnv=s,this.cache=i,this.events=r,(0,n.l_)(this)}}y=(0,i.Cg)([r.z8.container(),(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[void 0===g?Object:g,void 0===f.k?Object:f.k,void 0===o.J?Object:o.J,void 0===w?Object:w,void 0===m.J?Object:m.J])],y);var b=s(369544),F=s(103700),C=s(316396);class D{getKeyByParams(e){return(0,F.B)(e)}ensureList(e){const t=(0,F.B)(e);this.searchLists[t]||(this.searchLists[t]=new b.g(this.storiesApi,this.statLog,e));const s=Object.keys(this.searchLists);if(s.length>C.vt){const e=s.find((e=>e!==t));e&&this.searchLists.hasOwnProperty(e)&&delete this.searchLists[e]}return this.searchLists[t]}constructor(e,t){this.storiesApi=e,this.statLog=t,this.searchLists={},(0,n.l_)(this)}}D=(0,i.Cg)([r.z8.global(),(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[void 0===v.o?Object:v.o,void 0===L.R?Object:L.R])],D);var O=s(99677),R=s(709472),P=s(433674),k=s(412264);class A extends k.W{constructor(...e){super(...e),this.schema={version:1,name:"storiesCache"}}}A=(0,i.Cg)([r.z8.global()],A);var j=s(916533);class B{async fetchUser(){return(await this.userProvider.fetchUsersByIds({userIds:this.authService.userId?[this.authService.userId]:[],fields:["photo_50","photo_100","photo_200","photo_200_orig"]},{signal:this.controller?.signal},!0))[0]??null}preloadUser(){return new Promise(((e,t)=>{let s=0;const i=()=>{s++,s>1&&t()};this.fetch().then(e).catch(i),this.storiesCache.get("storiesViewer").then((t=>{t?(this.onSuccess(t),e(t)):i()})).catch(i)}))}async fetch(){if(this.promise)return this.promise;this.data||(this.status="loading"),this.controller=new AbortController,this.promise=this.fetchUser();try{const e=await this.promise;return this.saveDataToCache(e),this.onSuccess(e)}catch(e){return this.data||this.onFail(e),null}finally{delete this.promise}}onSuccess(e){return this.data=e,this.status="loaded",e}onFail(e){e?.error&&(0,O.E)(e.error)||(this.status="failed")}isLoading(){return"loading"===this.status}isLoaded(){return"loaded"===this.status}isFailed(){return"failed"===this.status}abort(){this.controller&&(this.controller.abort(),this.status=this.data?"loaded":"initial",delete this.promise)}async saveDataToCache(e){e&&await this.storiesCache.set("storiesViewer",(0,n.HO)(e))}reset(){this.abort(),this.data=null,this.status="initial"}constructor(e,t,s,i){this.userProvider=e,this.authService=t,this.storiesCache=s,this.userEnv=i,this.data=null,this.status="initial",(0,n.l_)(this)}}B=(0,i.Cg)([r.z8.global(),(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[void 0===P.y?Object:P.y,void 0===j.u?Object:j.u,void 0===A?Object:A,void 0===o.J?Object:o.J])],B);var T=s(819300);class I{async fetch(){if(this.promise)return this.promise;this.status="loading",this.controller=new AbortController,this.promise=this.fetchGroups();try{const e=await this.promise;return this.onSuccess(e)}catch(e){return this.onFail(e),null}finally{delete this.promise}}isLoading(){return"loading"===this.status}isLoaded(){return"loaded"===this.status}isFailed(){return"failed"===this.status}abort(){this.controller&&(this.controller.abort(),this.status=this.data?"loaded":"initial",delete this.promise)}reset(){this.abort(),this.data=null,this.status="initial"}onSuccess(e){return this.data=e,this.status="loaded",e}onFail(e){e?.error&&(0,O.E)(e.error)||(this.status="failed")}async fetchGroups(){return await this.groupsProvider.fetchGroupsExtended({filter:"editor"},{controller:this.controller})??null}constructor(e){this.groupsProvider=e,this.data=null,this.status="initial",(0,n.l_)(this)}}I=(0,i.Cg)([r.z8.global(),(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[void 0===T.s?Object:T.s])],I);class V{getCacheData(){return this.dataPromise||(this.dataPromise=this.storiesCacheStore.get("storiesFeedList")),this.dataPromise}getActualData(e){if(e?.items?.length){const t=Number(new Date),s=e.items.reduce(((e,s)=>{const i=s.stories?.filter((e=>e.expires_at&&1e3*e.expires_at>t))??[];return i.length&&e.push({...s,stories:i}),e}),[]);if(s.length)return{...e,items:s}}return null}isLoading(){return this.loading}isLoaded(){return Boolean(!this.isLoading()&&this.data)}isFailed(){return this.failed}async getData(){if(this.failed=!1,!this.data)try{this.loading=!0;const e=await this.getCacheData();this.data=this.getActualData(e),this.loading=!1}catch(e){throw this.failed=!0,this.loading=!1,this.statLog.send({name:"stories_cache_error",value:e}),e}return this.data}async nextLoad(){await this.getData()}async setData(e){await this.storiesCacheStore.set("storiesFeedList",e),this.data=this.getActualData(e)}constructor(e,t){this.storiesCacheStore=e,this.statLog=t,this.data=null,this.loading=!1,this.failed=!1,this.dataPromise=void 0,(0,n.l_)(this)}}V=(0,i.Cg)([r.z8.container(),(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[void 0===A?Object:A,void 0===L.R?Object:L.R])],V);class z{getFeedList(){return this.feedList=(0,S.vB)()?this.storiesProvider.feed.ensure({}):this.feedListProvider.ensureList({})}get storiesEvents(){if(!this.events)throw new Error("storiesEvents not initialized");return this.events}get storiesCacheLegacy(){if(!this.cacheLegacy)throw new Error("StoriesCacheLegacy not initialized");return this.cacheLegacy}async getDataFromCache(){return await Promise.all([this.storiesCache.getData(),this.viewer.preloadUser()]),this.prepareListForStoryViewer(),(0,S.vB)()&&this.userEnv.partConfigEnabled("frontend.web_stories_viewer_index_db")&&!this.feedList.feed.data&&this.storiesCache.data&&this.feedList.feed.addData(this.storiesCache.data,!1),this.storiesCache.data}saveDataToCache(){this.feedList?.feed?.data&&this.storiesCache.setData((0,n.HO)(this.feedList.feed.data))}async tryFetchViewer(){try{return await this.viewer.fetch()}catch(e){return console.log("Viewer fetch failed",e),null}}preloadData(e=!0,t){return new Promise(((s,i)=>{let r,o=0;const a=e=>{const t=e?.error&&(0,O.E)(e.error);o++,(o>1||t)&&i(e??r),r=e};this.fetch(e).then(s).catch(a),this.getDataFromCache().then((e=>{const i=!t||e?.items?.some((e=>e.stories?.some((e=>String(e.id)===t))));e&&i?s(e):a()})).catch(a)}))}fetch(e=!0){return this.storiesCache.data||this.getDataFromCache(),this.promise||(this.promise=this.getThisPromise(e,(()=>{delete this.promise})),this.groups.fetch()),this.promise}isDataLoading(){return this.feedList.feed.isLoading()&&this.storiesCache.isLoading()}isDataLoaded(){return this.feedList.feed.isLoaded()||this.storiesCache.isLoaded()}isLoading(){return this.isDataLoading()||this.viewer.isLoading()}async getFetchingPromise(){this.promise&&await this.promise}prepareListForStoryViewer(){const e=this.feedList.feed.data??this.storiesCache.data;e&&!(0,S.vB)()&&this.storiesCacheLegacy.setApiStoryList(this.listName,e)}getList(){return this.feedList.feed}getViewer(){return this.viewer}isLoaded(){return this.isDataLoaded()&&this.viewer.isLoaded()}async getThisPromise(e,t){try{const t=await Promise.all([this.feedList.feed.fetch(void 0,void 0,!0),this.tryFetchViewer()]);if(this.cacheDataShownTime){const e=performance.now()-this.cacheDataShownTime;e<300&&(this.forceShowingCache=!0,await(0,R.y)(300-e),this.forceShowingCache=!1)}return e&&this.prepareListForStoryViewer(),this.storiesEvents.dispatchFeedLoadedEvent(),this.saveDataToCache(),t}catch(e){throw e?.error&&(0,O.E)(e.error)||this.storiesEvents.dispatchFeedFailedEvent(),e}finally{t()}}abort(){this.feedList.feed.isLoading()&&this.feedList.feed.abort(),this.viewer.isLoading()&&this.viewer.abort(),delete this.promise}reset(){this.viewer.reset(),this.feedList.feed.reset()}constructor(e,t,s,i,r,o,a,d){this.viewer=e,this.groups=t,this.storiesCache=s,this.feedListProvider=i,this.storiesProvider=r,this.userEnv=o,this.events=a,this.cacheLegacy=d,this.listName=h.Jg.feed,this.feedList=this.getFeedList(),this.cacheDataShownTime=void 0,this.forceShowingCache=!1,this.onCacheDataShown=()=>{this.cacheDataShownTime=performance.now()},(0,n.l_)(this)}}z=(0,i.Cg)([r.z8.container(),(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[void 0===B?Object:B,void 0===I?Object:I,void 0===V?Object:V,void 0===D?Object:D,void 0===f.k?Object:f.k,void 0===o.J?Object:o.J,void 0===m.J?Object:m.J,void 0===w?Object:w])],z);var q=s(747180);class J{getKeyByParams(e){return(0,F.B)(e)}ensureList(e){const t=this.getKeyByParams(e);this.searchLists[t]||(this.searchLists[t]=new q.A(this.storiesApi,this.statLog,e));const s=Object.keys(this.searchLists);if(s.length>C.vt){const e=s.find((e=>e!==t));e&&this.searchLists.hasOwnProperty(e)&&delete this.searchLists[e]}return this.searchLists[t].search}constructor(e,t){this.storiesApi=e,this.statLog=t,this.searchLists={},(0,n.l_)(this)}}J=(0,i.Cg)([r.z8.global(),(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[void 0===v.o?Object:v.o,void 0===L.R?Object:L.R])],J);class M{get storiesEvents(){if(!this.events)throw new Error("storiesEvents not initialized");return this.events}get storiesCache(){if(!this.cache)throw new Error("storiesCache not initialized");return this.cache}async getThisPromise(e,t){try{this.searchFeed.isLoading()&&this.searchFeed.abort(),this.searchFeed=this.getSearchFeed(e);const t=await this.searchFeed.fetch();return this.prepareListForStoryViewer(),this.storiesEvents.dispatchSearchFeedLoadedEvent(),t}catch(e){throw e?.error&&(0,O.E)(e.error)||this.storiesEvents.dispatchFeedFailedEvent(),e}finally{t()}}fetch(e){return this.promise||(this.promise=this.getThisPromise(e,(()=>{delete this.promise}))),this.promise}async getFetchingPromise(){this.promise&&await this.promise}prepareListForStoryViewer(){const e=this.searchFeed.data;e&&this.storiesCache.setApiStoryList(this.listName,e)}getList(){return this.searchFeed}isLoading(){return this.searchFeed.isLoading()}isLoaded(){return this.searchFeed.isLoaded()}isFailed(){return this.searchFeed.isFailed()}abort(){this.searchFeed.isLoading()&&this.searchFeed.abort()}reset(){this.searchFeed.reset()}constructor(e,t,s,i){this.searchListProvider=e,this.events=t,this.cache=s,this.searchListSharedProvider=i,this.getSearchFeed=e=>(0,S.vB)()?this.searchListSharedProvider.search.ensure({query:e}):this.searchListProvider.ensureList({query:e}),this.listName=h.Jg.feed,this.searchFeed=this.getSearchFeed(""),this.searchFeed=this.getSearchFeed(""),(0,n.l_)(this)}}M=(0,i.Cg)([r.z8.container(),(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[void 0===J?Object:J,void 0===m.J?Object:m.J,void 0===w?Object:w,void 0===f.k?Object:f.k])],M);var N=s(2096),x=s(731803),K=s(419299);const U=(0,x.a)({debugPrefix:"[Stories]",catchNetworkError:()=>((0,K.Jx)("stories_api_web_errors","network error"),!0)});var W=s(571559),H=s(472978),G=s(259137),Y=s(959832);class ${preloadDiscoverList(e,t){if(window.cur.storiesDiscoverFetchingPromise)return window.cur.storiesDiscoverFetchingPromise;let s,i;const r=(0,E.uW)(h.Jg.feed);return r&&(i=r.find((e=>e.type===_.zE.discover)),i&&(s=i.track_code)),t&&(0,N.a5)(),window.cur.storiesDiscoverFetchingPromise=e.fetch(s).then((()=>{let e;const t=(0,E.uW)(h.Jg.feed);if(t){const s=t.find((e=>e.type===_.zE.discover));s?.grouped&&(e=s?.grouped)}return e||Promise.reject(new Error("empty discover list"))})).finally((()=>{t&&(0,N.dk)(),delete window.cur.storiesDiscoverFetchingPromise})),window.cur.storiesDiscoverFetchingPromise}async preloadList(e,t,s){const i=(0,H.aM)(),r=(0,G.Y)().isAjaxNav?0:1;try{s?await t.fetch(s):await e.fetch(),(this.userEnv.partConfigEnabled("web_spa_feed_reversed")||this.userEnv.isToggleEnabled("feed_spa_web"))&&i&&(0,Y.ld)({nonce:i,isFullPageLoad:Boolean(r)})}catch(e){(this.userEnv.partConfigEnabled("web_spa_feed_reversed")||this.userEnv.isToggleEnabled("feed_spa_web"))&&i&&(0,Y.uC)({error:e,nonce:i,isFullPageLoad:Boolean(r)}),console.error(e);const t=e.error?.error_code;if(t===W.Z9b||t===W.XlB||0===t)return;U({error:e,additionalText:s?"could not fetch search list":"could not fetch feed list",extra:s?{query:s}:void 0})}}constructor(e){this.userEnv=e,(0,n.l_)(this)}}$=(0,i.Cg)([r.z8.global(),(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[void 0===o.J?Object:o.J])],$);class Z{get storiesEvents(){if(!this.events)throw new Error("storiesEvents not initialized");return this.events}get storiesCache(){if(!this.cache)throw new Error("storiesCache not initialized");return this.cache}get preloaderService(){if(!this.preloader)throw new Error("preloader not initialized");return this.preloader}init(){this.initiated=!0,this.addCustomEvents(),this.processList()}buildBlockMap(){this.listData&&(this.blocksById={},this.listData.items.forEach(((e,t)=>{this.blocksById[e.id||t]={block:e},e.grouped?.forEach((s=>{this.blocksById[s.id||t]={block:s,parentBlock:e}}))})))}applyCacheSeenEvents(){this.storiesSeenEventsFromCache.forEach((e=>{this.onStoriesSeen(e)})),this.storiesSeenEventsFromCache.clear()}onStoriesSeen(e){this.isFeedModeActive&&!this.feed.getList().data&&this.storiesSeenEventsFromCache.add(e);e.detail.forEach((e=>{const t=e.storyRawIdSet,s=this.blocksById[e.blockId]?.block,i=this.blocksById[e.blockId]?.parentBlock;if(s&&(0,c.q)(s)){let e=!1;if(s.stories?.forEach((s=>{s.seen||(t.has((0,a.WO)({ownerId:s.owner_id,id:s.id}))?s.seen=1:e=!0)})),s.grouped?.forEach((t=>{(0,c.q)(t)&&(e=!0)})),e!==s.has_unseen&&(s.has_unseen=e,i)){let e=!1;i.grouped?.forEach((t=>{(0,c.q)(t)&&(e=!0)})),e!==i.has_unseen&&(i.has_unseen=e)}}}))}onListModifiedOutside(e){e.detail.listName===this.listName&&this.loadList()}onStoryViewerLayerClose(e){this.storiesEvents.dispatchStoryBlockScrollToCenterEvent({blockItemId:e.detail.currentBlockId})}get isSearchFeedModeActive(){return this.isCurrentListSearchList}get isFeedModeActive(){return!this.isSearchFeedModeActive}isSearchFeedListLoading(){return this.searchFeed.isLoading()}isListLoaded(){return this.isFeedModeActive?this.feed.isLoaded():this.searchFeed.isLoaded()}isListLoading(){return this.isFeedModeActive?this.feed.isLoading():(this.feed.fetch(),this.searchFeed.isLoading())}getFetchingPromise(){return this.isFeedModeActive?this.feed.getFetchingPromise():this.searchFeed.getFetchingPromise()}isListEmpty(){return!this.listData}isFeedListEmpty(){return!this.feed.getList().data}addCustomEvents(){const e=[[d.qm.STORIES_SEEN,this.onStoriesSeen.bind(this)],[d.qm.CLOSE_LAYER,this.onStoryViewerLayerClose.bind(this)],[d.qm.LIST_MODIFIED,this.onListModifiedOutside.bind(this)],[d.RB.FEED_LOADED,this.onFeedListLoaded.bind(this)],[d.RB.SEARCH_FEED_LOADED,this.onSearchFeedListLoaded.bind(this)],[d.RB.DISCOVER_LOADED,this.onDiscoverListLoaded.bind(this)]];this.removeCustomEvents(),this.unsubscribeListeners=e.map((([e,t])=>this.storiesEvents.subscribe(String(e),t)))}removeCustomEvents(){for(;this.unsubscribeListeners.length;)this.unsubscribeListeners.pop()?.()}setList(e){e!==this.list&&(this.list=e,this.isCurrentListSearchList=e===this.searchFeed.getList(),this.onListChanged(),this.resetScroll())}processList(){this.buildBlockMap(),this.listData&&(this.hasEmptyDiscover=Boolean(this.listData.items.find((e=>"discover"===e.type)))),this.isListLoaded()&&this.isStoryViewerListEmpty()&&(this.isFeedModeActive?this.feed.prepareListForStoryViewer():this.searchFeed.prepareListForStoryViewer())}isStoryViewerListEmpty(){return!this.storiesCache.hasStoryList(this.listName)}onFeedListLoaded(){this.isFeedModeActive&&(this.setList(this.feed.getList()),this.applyCacheSeenEvents(),(this.userEnv.partConfigEnabled("web_spa_feed_reversed")||this.userEnv.isToggleEnabled("feed_spa_web"))&&this.processList())}onSearchFeedListLoaded(){this.query&&(this.setList(this.searchFeed.getList()),(this.userEnv.partConfigEnabled("web_spa_feed_reversed")||this.userEnv.isToggleEnabled("feed_spa_web"))&&this.processList())}onDiscoverListLoaded(){const e=this.discover.getList();if(e.data&&this.listData){const t=this.listData.items.find((e=>"discover"===e.type));if(t){t.grouped=e.data.items;let s=t.has_unseen;s||t.grouped?.forEach((e=>{(0,c.q)(e)&&(s=!0)})),t.has_unseen=s,this.onListChanged()}}}async preloadDiscoverList(){try{await this.preloaderService.preloadDiscoverList(this.discover),this.hasEmptyDiscover=!1}catch(e){}finally{this.isDiscoverPending=!1}}loadList(){this.cancelLoadSearchFeedRequest(),this.preloaderService.preloadList(this.feed,this.searchFeed,this.query)}prepareListForViewer(){this.feed.prepareListForStoryViewer()}get onCacheDataShown(){if(this.isFeedModeActive)return this.feed.onCacheDataShown}get cacheList(){if(this.isFeedModeActive)return this.feed.storiesCache}get forceShowingCache(){return!!this.isFeedModeActive&&this.feed.forceShowingCache}get listData(){return this.list.data??this.cacheList?.data}setQuery(e){e!==this.query&&(this.query=e,(this.isInitiated()||(this.setList(this.query?this.searchFeed.getList():this.feed.getList()),this.query))&&(this.query?this.loadList():(this.isFeedListEmpty()?this.loadList():this.prepareListForViewer(),this.setList(this.feed.getList()))))}cancelLoadSearchFeedRequest(){this.searchFeed.abort()}cancelLoadFeedRequest(){this.feed.abort()}resetScroll(){this.storiesEvents.dispatchStoryBlockResetScrollEvent()}onListChanged(){this.processList()}isInitiated(){return this.initiated}reset(){this.initiated&&(this.query="",this.setList(this.feed.getList()),this.cancelLoadFeedRequest(),this.cancelLoadSearchFeedRequest(),this.initiated=!1)}[r.zr](){this.removeCustomEvents(),this.storiesViewerDataService.resetListData({listName:"discover"})}constructor(e,t,s,i,r,o,a,d){this.feed=e,this.searchFeed=t,this.discover=s,this.userEnv=i,this.storiesViewerDataService=r,this.events=o,this.cache=a,this.preloader=d,this.isCurrentListSearchList=!1,this.storiesSeenEventsFromCache=new Set,this.blocksById={},this.unsubscribeListeners=[],this.initiated=!1,this.listName=h.Jg.feed,this.list=this.feed.getList(),this.isDiscoverPending=!1,this.hasEmptyDiscover=!1,this.query="",this.list=this.feed.getList(),(0,n.l_)(this)}}Z=(0,i.Cg)([r.z8.container(),(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[void 0===z?Object:z,void 0===M?Object:M,void 0===y?Object:y,void 0===o.J?Object:o.J,void 0===l.f?Object:l.f,void 0===m.J?Object:m.J,void 0===w?Object:w,void 0===$?Object:$])],Z)},946164:(e,t,s)=>{s.d(t,{E5:()=>o,RB:()=>i,qm:()=>r});var i=function(e){return e.FEED_LOADED="stories_feed_loaded",e.FEED_FAILED="stories_feed_failed",e.GROUPS_LOADED="stories_groups_loaded",e.DISCOVER_LOADED="stories_discover_loaded",e.SEARCH_FEED_LOADED="stories_search_feed_loaded",e.SEARCH_FEED_FAILED="stories_search_feed_failed",e}({}),r=function(e){return e.STORIES_SEEN="stories_seen",e.CLOSE_LAYER="close_layer",e.LIST_MODIFIED="list_modified",e.BLOCK_SCROLL_TO_CENTER="block_scroll_to_center",e.STORIES_REMOVE="stories_remove",e.STORIES_LIVE_ENDED="stories_live_ended",e.STORIES_LIVE_VIEWERS_COUNT_CHANGE="stories_live_viewers_count_change",e}({}),o=function(e){return e.BLOCK_SCROLL_TO_CENTER="block_scroll_to_center",e.BLOCK_RESET_SCROLL="block_reset_scroll",e}({})}}]),"undefined"!=typeof window&&window.stManager?.done?.("dist/core_spa/chunks/30996.a49fd5bb.js")}catch(e){throw"undefined"!=typeof window&&window.stManager?.fail?.("dist/core_spa/chunks/30996.a49fd5bb.js",e),e}