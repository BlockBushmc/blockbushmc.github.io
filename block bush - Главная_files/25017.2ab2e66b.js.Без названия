try{(self.webpackChunkvk=self.webpackChunkvk||[]).push([[25017],{83413:(t,e,s)=>{s.d(e,{E:()=>I});var i=s(221020),o=s(356035),a=s(946918),r=s(187233),d=s(772812),n=s(432275),c=s(42107),l=s(16496),h=s(327595),u=s(782281),p=s(631012),g=s(298096),_=s(331635),m=s(327813),f=s(508461),v=s(916533),b=s(273193),y=s(705144),D=s(52955),C=s(216626),w=s(533520);const L={1:"document",2:"archive",3:"gif",4:"image",5:"audio",6:"video",7:"book",8:"unknown"};class S{get doc(){return this.props.current.doc}delete(){this.docsListsProvider.deleteDoc(this.doc.data)}restore(){this.docsListsProvider.restoreDoc(this.doc.data)}add(){this.docsListsProvider.addDocToAuthedUserList(this.doc.data)}deleteFromAdded(){this.docsListsProvider.deleteDocFromAddedAuthedUserList(this.doc.data)}edit(){this.props.current.onEdit?.(this.doc)}attach(){this.props.current.onAttach?.(this.doc)}get attachMode(){return Boolean(this.props.current.onAttach)}get canManage(){return this.authService.ensureUserId()===this.doc.data.owner_id||this.doc.data.can_manage}get canEdit(){return Boolean(this.canManage&&this.props.current.onEdit)}get isDeleted(){return this.docsListsProvider.isDeletedDoc(this.doc.rawId)}get isAdded(){return this.docsListsProvider.isAddedToAuthedUserList(this.doc.rawId)}get isSelected(){return Boolean(this.props.current.isSelected)}get isSelectable(){return Boolean(this.props.current.onClick)}get isLoading(){return this.docsListsProvider.isAddingToAuthedUserList(this.doc.rawId)||this.docsListsProvider.isDeletingDoc(this.doc.rawId)||this.docsListsProvider.isRestoringDoc(this.doc.rawId)}get labels(){const t=this.doc.data.tags,{systemTags:e}=(0,D.W)(this.langs);if(t)return t.map((t=>({id:t,title:e[t]??t,onClick:()=>{(0,y.eG)(0),this.props.current.onSelectTag?.(t)}})))}get fileType(){return L[this.doc.data.type]||"unknown"}get thub(){const t=(this.doc.data.preview?.photo?.sizes||[]).find((t=>"s"===t.type));return t?.src}get subTitle(){return[(0,w.v)(this.doc.data.size),(0,C.r)(this.doc.data.date),this.doc.data.is_licensed&&this.langs.getLang("docs_litres_license")].filter(Boolean).join(", ")}constructor(t,e,s,i){this.docsListsProvider=t,this.authService=e,this.langs=s,this.props=i,this.onSelect=()=>{this.props.current.onClick?.(this.doc)},(0,m.l_)(this)}}S=(0,_.Cg)([c.z8.transient(),(0,_.Sn)("design:type",Function),(0,_.Sn)("design:paramtypes",[void 0===f.O?Object:f.O,void 0===v.u?Object:v.u,void 0===b.Y?Object:b.Y,void 0===c.Ji?Object:c.Ji])],S);const{Provider:U,useModel:k}=(0,c.Qd)(S,{initInEffect:!1,isolatedContext:!1,onlyTransient:!1}),Y=(0,o.P)((function(){const t=k(),e=(0,a.B)(),s=(0,o.P)((()=>t.isSelected?(0,i.Y)(r.i,{children:(0,i.Y)(l.d,{className:(0,d.I)("color_icon_accent_themed")})}):t.isSelectable?void 0:t.attachMode?(0,i.Y)(n.d.Button,{"data-testid":"doc_item_attach_button",onClick:e=>{e.preventDefault(),t.attach()},children:e.getLang("docs_attach_btn")}):t.isDeleted?(0,i.Y)(n.d.Button,{"data-testid":"doc_item_remove_cancel_button",onClick:e=>{e.preventDefault(),t.restore()},children:e.getLang("global_cancel")}):t.canManage?(0,i.FD)(i.FK,{children:[t.canEdit&&(0,i.Y)(n.d.IconButton,{"data-testid":"doc_item_edit_button",onClick:e=>{e.preventDefault(),t.edit()},children:(0,i.Y)(h.v,{})},"editFile"),(0,i.Y)(n.d.IconButton,{"data-testid":"doc_item_remove_button",onClick:e=>{e.preventDefault(),t.delete()},children:(0,i.Y)(u.P,{})},"removeFile")]}):(0,i.Y)(n.d.IconButton,{"data-testid":"doc_item_add_button",onClick:e=>{e.preventDefault(),t.isAdded?t.deleteFromAdded():t.add()},children:t.isAdded?(0,i.Y)(p.E,{}):(0,i.Y)(g.p,{})},"toggleAdd")));return(0,i.Y)(n.d,{deleted:!!t.isDeleted,loading:t.isLoading,selected:t.isSelected,after:(0,i.Y)(s,{}),onClick:t.onSelect,href:t.isSelectable?void 0:t.doc.data.private_url,title:t.doc.data.title,subtitle:t.subTitle,labels:t.labels,thumb:t.thub,fileType:t.fileType})})),I=(0,c.jn)(U,Y)},52955:(t,e,s)=>{s.d(e,{W:()=>i});const i=t=>{const e={docs_system_abstract:t.getLang("docs_system_abstract"),docs_system_thesis:t.getLang("docs_system_thesis"),docs_system_coursework:t.getLang("docs_system_coursework"),docs_system_diploma:t.getLang("docs_system_diploma")};return{systemTags:e,localize:t=>t.map((t=>e[t]??t))}}},713581:(t,e,s)=>{s.d(e,{P:()=>at});var i=s(221020),o=s(356035),a=s(432317),r=s(917128),d=s(46644),n=s(47417),c=s(946918),l=s(42107),h=s(331635),u=s(327813),p=s(273193),g=s(75105),_=s(150575);class m{fetchUploadServer({groupId:t}={},e={}){return this.docsApi.getUploadServer({group_id:t},{signal:e.controller?.signal})}constructor(t){this.docsApi=t,(0,u.l_)(this)}}m=(0,h.Cg)([l.z8.container(),(0,h.Sn)("design:type",Function),(0,h.Sn)("design:paramtypes",[void 0===_.Q?Object:_.Q])],m);var f=s(140347);class v{startUpload(){this.isUploading=!0,this.error=null}setUploadError(t){this.reset(),this.error=t}setProgressUpload(t){this.progressUpload=t}uploadDocFail(t){this.reset();const e=this.getUploadError(t);e&&(this.error=e)}getUploadError(t){const e=this.langs.getLang("docs_upload_fail_title"),s={title:e,description:this.langs.getLang("docs_upload_fail_description")};if("upload_doc_error"!==t.type)return s;if(!t.error.includes("ERR_UPLOAD_TERMINATED"))switch(t.error){case"wrong_arch_file":return{title:e,description:this.langs.getLang("docs_upload_arch_fail")};case"wrong_mp3_file":return{title:e,description:this.langs.getLang("docs_upload_mp3_fail")};case"wrong_music_file":return{title:e,description:this.langs.getLang("docs_upload_music_fail")};case"wrong_arch_mp3_file":return{title:e,description:this.langs.getLang("docs_upload_arch_mp3_fail")};case"empty_archive":return{title:e,description:this.langs.getLang("docs_upload_arch_empty_fail")};default:return s}}reset(){this.isUploading=!1,this.progressUpload=0,this.error=null}constructor(t){this.langs=t,this.isUploading=!1,this.progressUpload=0,this.error=null,(0,u.l_)(this)}}class b{setConfig({groupId:t}){this.groupId=t}async fetchUploadUrl(){try{this.isUploadUrlLoading=!0;const t=await this.docsUploaderService.fetchUploadServer({groupId:this.groupId});this.uploadUrl=t.upload_url,this.isUploadUrlLoading=!1}catch{(0,u.h5)((()=>{this.isUploadUrlLoading=!1;const t=this.langs.getLang("docs_upload_unavalaible");this.uploadUrlError={description:t}}))}}uploadSuccess(t){this.config.onUploadSuccess(t)}uploadStart(t,e){this.config.onUploadStart?.(t,e)}uploadError(t){this.config.onUploadError?.(String(t))}constructor(t,e,s){this.config=t,this.docsUploaderService=e,this.langs=s,this.uploadProcess=new v(this.langs),this.isUploadUrlLoading=!1,(0,u.l_)(this)}}class y{setDefaultData(t){this.fields.title=t.title||this.fields.title,this.fields.tags=t.tags||this.fields.tags,this.fields.folderId=t.folderId||this.fields.folderId}constructor(){this.fields={title:"",tags:[],folderId:0},this.handleChangeInput=t=>{this.fields.title=t.target.value},this.handleChangeFolderId=t=>{this.fields.folderId=Number(t.currentTarget.value)},this.handleSelectExampleTag=t=>{t.preventDefault();const e=t.currentTarget.dataset?.tag;e&&!this.fields.tags.includes(e)&&this.fields.tags.push(e)},this.setTags=t=>{this.fields.tags=t},(0,u.l_)(this)}}class D{get folders(){return{private:{id:0,title:this.langs.getLang("docs_type_private_title"),description:`(${this.langs.getLang("docs_type_private_description")})`},trainingFile:{id:2,title:this.langs.getLang("docs_type_uni")},book:{id:3,title:this.langs.getLang("docs_type_lit")},other:{id:4,title:this.langs.getLang("docs_type_other")}}}setConfig({doc:t}){const{title:e,tags:s,folder_id:i}=t.data;this.doc=t,this.form.setDefaultData({title:e,tags:[...s||[]],folderId:i})}constructor(t,e,s){this.config=t,this.docsProvider=e,this.langs=s,this.form=new y,this.isSaving=!1,this.setDataFormUploadDoc=({docRaw:t,title:e})=>{this.docRaw=t,this.form.setDefaultData({title:e})},this.submitForm=async()=>{try{if(this.isSaving=!0,this.doc)await this.doc.edit(this.form.fields),this.config.onEditSuccess();else if(this.docRaw){const t=await this.docsProvider.saveDoc({docRaw:this.docRaw,...this.form.fields});this.config.onSaveSuccess(t)}}catch{(0,u.h5)((()=>{this.isSaving=!1,this.saveError={description:this.langs.getLang("docs_edit_file_error")}}))}},(0,u.l_)(this)}}var C=function(t){return t[t.upload=0]="upload",t[t.saveOrEdit=1]="saveOrEdit",t}({});class w{[l.Ts](t){this._config=t;const e="doc"in t?t.doc:void 0;e?(this.currentStep=C.saveOrEdit,this.saveOrEditStep.setConfig({doc:e})):(this.currentStep=C.upload,this.uploadStep.setConfig({groupId:t.groupId}))}get config(){if(!this._config)throw new Error("DocsFormModal: Empty Config!");return this._config}constructor(t,e,s,i){this.docsProvider=t,this.docsCache=i,this.currentStep=C.upload,this.close=()=>{this.config.onClose()},this.uploadSuccess=t=>{this.saveOrEditStep.setDataFormUploadDoc(t),this.currentStep=C.saveOrEdit,"onUploadSuccess"in this.config&&this.config?.onUploadSuccess?.(t.title)},this.uploadStart=(t,e)=>{"onUploadStart"in this.config&&this.config?.onUploadStart?.(t,e)},this.uploadError=t=>{"onUploadError"in this.config&&this.config?.onUploadError?.(t)},this.editDocSuccess=()=>{this.docsCache.clearStore(),this.config.onClose()},this.saveDocSuccess=t=>{"onSaveSuccess"in this.config&&this.config?.onSaveSuccess(t)},this.uploadStep=new b({onUploadSuccess:this.uploadSuccess,onUploadStart:this.uploadStart,onUploadError:this.uploadError},s,e),this.saveOrEditStep=new D({onEditSuccess:this.editDocSuccess,onSaveSuccess:this.saveDocSuccess},this.docsProvider,e),(0,u.l_)(this)}}w=(0,h.Cg)([l.z8.transient(),(0,h.Sn)("design:type",Function),(0,h.Sn)("design:paramtypes",[void 0===g.Z?Object:g.Z,void 0===p.Y?Object:p.Y,void 0===m?Object:m,void 0===f.o?Object:f.o])],w);const{Provider:L,useModel:S}=(0,l.Qd)(w,{initInEffect:!1,isolatedContext:!1,onlyTransient:!1});var U=s(815287),k=s(428330);function Y(){const t=(0,c.B)(),{uploadStep:e}=S(),{uploadProcess:i}=e,o={title:i.error?.title||e.uploadUrlError?.title||"",description:i.error?.description||e.uploadUrlError?.description||""};return(0,U.useEffect)((()=>{e.fetchUploadUrl()}),[]),(0,U.useEffect)((()=>{let a=null,r=!1,d="";if(e.uploadUrl)return s._dG("Upload",window.Upload||k._),a=window.Upload.init("docs_upload",e.uploadUrl,{},{file_name:"file",file_types_description:"Documents",file_types:"*.*;",flat_button:!0,lang:{button_browse:t.getLang("docs_select_file"),switch_mode:t.getLang("docs_switch_def_uploader"),cannot_upload_title:t.getLang("global_error"),cannot_upload_text:t.getLang("docs_upload_unavalaible"),filesize_error:t.getLang("docs_upload_filesize_error")},onUploadStart:({fileName:t,file:s})=>{d=t,i.startUpload(),i.setProgressUpload(0),e.uploadStart(t,s.size),r=!0},onUploadComplete:(t,s)=>{const a=JSON.parse(s);if(r=!1,a.file){const t=a;e.uploadSuccess({docRaw:t.file,title:d})}else if("string"!=typeof a.error)i.uploadDocFail({type:"unsupported_upload_doc_error",error:o});else{const t={type:"upload_doc_error",error:a.error};i.uploadDocFail(t)}},onUploadProgress:(t,e,s)=>{const o=Math.min(Math.floor(e/s*100),98);i.setProgressUpload(o)},onUploadError:(t,s)=>{r=!1,i.uploadDocFail(s),e.uploadError(s)},filterCallback:function(e,s){return s.filter((function(e){const s=e.name.substr(-3).toLowerCase();return"mp3"===s?(i.setUploadError({title:t.getLang("docs_upload_fail_title"),description:t.getLang("docs_upload_mp3_fail")}),!1):"exe"!==s||(i.setUploadError({title:t.getLang("docs_upload_fail_title"),description:t.getLang("docs_upload_fail_description")}),!1)}))},clear:1,error:1,type:"doc",max_attempts:1,dropbox:"docs_dropbox"}),()=>{if(null===a)return;const t=window.Upload.options[a].xhr;r&&t&&t.abort(),r&&window.Upload.terminateAllUploads(),setTimeout((()=>window.Upload.deinit(a)),0)}}),[e.uploadUrl]),{isUploadUrlLoading:e.isUploadUrlLoading,uploadProcess:e.uploadProcess,error:o}}var I=s(311029),E=s(187233),F=s(339672),T=s(243989),A=s(541687),P=s(978325),N=s(358553),O=s(782536),j=s(999051),M=s(959757),B=s(37390),z=s(409698),R=s(962644),q=s(405697);const x="DragAndDropUpload__container--AZW2h";function Q(t){return(0,i.Y)(R.h,{Component:q.O,...t,className:x,style:{display:"none"}})}const $="UploadStep__container--tETfB",K=(0,o.P)((function({onClose:t}){const{error:e,uploadProcess:s,isUploadUrlLoading:o}=Y(),a=(0,c.B)();return(0,i.FD)(i.FK,{children:[(0,i.Y)(I.c,{insetLevel:1,children:(0,i.FD)("div",{className:$,children:[!!e.title&&(0,i.Y)(E.i,{mode:"horizontal",spacing:8,children:(0,i.Y)(F.N,{"data-testid":"docs_modal_upload_error_banner",header:e.title,text:(0,i.Y)(T.E,{children:e.description}),mode:"negative"})}),(0,i.Y)(A.H,{children:(0,i.Y)(P.e,{top:a.getLang("docs_file_limits"),children:(0,i.FD)(N.Y,{children:[(0,i.Y)(N.Y.Item,{children:a.getLang("docs_file_limit1")}),(0,i.Y)(N.Y.Item,{children:(0,i.Y)(T.E,{children:a.getLang("docs_file_limit2")})}),(0,i.Y)(N.Y.Item,{children:a.getLang("docs_file_limit3")})]})})}),(0,i.FD)(E.i,{children:[(0,i.Y)("div",{style:s.isUploading?{display:"none"}:void 0,children:(0,i.FD)(O.e,{align:"center",stretched:!0,mode:"vertical",children:[o&&(0,i.Y)(j.y,{size:"medium"}),(0,i.Y)("div",{id:"docs_upload","data-testid":"docs_modal_upload_button_wrapper"})]})}),s.isUploading&&(0,i.Y)(M.k,{"aria-labelledby":"progresslabel",value:s.progressUpload})]}),(0,i.Y)(Q,{id:"docs_dropbox","data-testid":"docs_modal_upload_dnd",children:a.getLang("drop_files_here")})]})}),(0,i.Y)(B.j,{actions:(0,i.Y)(z.$,{size:"m",mode:"primary",onClick:t,"data-testid":"docs_modal_upload_close_button",children:a.getLang("global_close")})})]})}));var W=s(423654),Z=s(516427),V=s(489445),J=s(52955),H=s(652097),G=s(876084),X=s(799649);const tt=t=>t.split(",").map((t=>t.trim())).filter(Boolean),et=(0,o.P)((function({tags:t,systemTags:e,onChangeTags:s}){const[o,a]=(0,U.useState)(""),r=(0,c.B)(),d=Object.fromEntries(Object.entries(e).map((([t,e])=>[e,t])));return(0,i.Y)(Z.aK6,{value:t.map((t=>({label:e[t]??t,value:t}))),inputValue:o,onInputChange:t=>t?.currentTarget&&a(t.currentTarget.value),onChange:t=>{const e=(0,H.jw)(t.reduce(((t,{label:e})=>(tt(e).forEach((e=>{const s=d[e];t.push(s??e)})),t)),[]));s(e)},onBlur:e=>{const{value:i}=e.currentTarget;a("");const o=tt(i),r=(0,H.jw)([...t,...o.map((t=>d[t.toLowerCase()]??t))]);s(r)},placeholder:r.getLang("docs_enter_tag"),"data-testid":"docs_modal_tags_input",after:!!t.length&&(0,i.Y)(X.K,{hoverMode:"opacity",label:r.getLang("global_clear_field"),onClick:()=>{s([])},"data-testid":"docs_modal_tags_clear_button",children:(0,i.Y)(G.M,{})})})})),st=(0,o.P)((function({onClose:t}){const{saveOrEditStep:e}=S(),s=(0,c.B)(),{form:o}=e,{title:a,tags:r,folderId:d}=o.fields,{systemTags:n}=(0,J.W)(s),l=(0,U.useMemo)((()=>!a.trim().length),[a]),{descriptionTags:h,exampleTags:u}=(0,U.useMemo)((()=>{const t=s.getLang("docs_tags_desc_test"),e=[];for(const s of t.matchAll(/{tag}(.*?){\/tag}/gm))e.push(s[1]);return{descriptionTags:t.replace(/{.*/,""),exampleTags:e.map(((t,s)=>{const a=e.length===s+1;return(0,i.FD)("span",{children:[(0,i.Y)(W.N,{href:"#",onClick:o.handleSelectExampleTag,"data-tag":t,children:n[t]}),!a&&", "]},t)}))}}),[r]);return(0,i.FD)(i.FK,{children:[(0,i.Y)(I.c,{insetLevel:1,children:(0,i.FD)(A.H,{children:[!!e.saveError&&(0,i.Y)(E.i,{mode:"horizontal",spacing:8,children:(0,i.Y)(F.N,{"data-testid":"docs_modal_error_banner",header:s.getLang("global_error"),text:e.saveError.description,mode:"negative"})}),e.folders.private.id!==d&&(0,i.Y)(E.i,{mode:"horizontal",spacing:8,children:(0,i.Y)(F.N,{"data-testid":"docs_modal_not_private_banner",header:s.getLang("docs_upload_type_info_title"),text:s.getLang("docs_upload_type_info_description")})}),(0,i.Y)(P.e,{status:a?"default":"error",top:s.getLang("docs_title_field"),children:(0,i.Y)(Z.pde,{value:a,onChange:o.handleChangeInput,maxLength:120,"data-testid":"docs_modal_file_name_input"})}),(0,i.Y)(P.e,{children:(0,i.Y)(Z.z6M,{children:Object.values(e.folders).map((t=>(0,i.Y)(V.s,{"data-testid":`docs_modal_folder_radio_button_${t.id}`,name:"folderId",value:t.id,checked:t.id===d,onChange:o.handleChangeFolderId,description:t.description,children:t.title},t.id)))})}),(0,i.Y)(P.e,{top:s.getLang("docs_tags_field"),bottom:(0,i.FD)(i.FK,{children:[h," ",u,"."]}),children:(0,i.Y)(et,{tags:r,systemTags:n,onChangeTags:o.setTags})})]})}),(0,i.Y)(B.j,{actions:(0,i.FD)(i.FK,{children:[(0,i.Y)(z.$,{"data-testid":"docs_modal_cancel_button",size:"m",mode:"secondary",onClick:t,children:s.getLang("box_cancel")}),(0,i.Y)(z.$,{"data-testid":"docs_modal_save_button",size:"m",mode:"primary",onClick:e.submitForm,loading:e.isSaving,disabled:l,children:s.getLang("box_save")})]})})]})})),it=(0,o.P)((function(){const t=S(),{uploadProcess:e}=Y(),s=(0,c.B)(),{hideBox:o}=(0,a.VS)((t=>{const i=t?.force;if(!i&&e.isUploading){const t=(0,r.NL)(s.getLang("docs_unsaved_data_title"),s.getLang("docs_unsaved_data"),s.getLang("global_close"),(()=>{t.hide(),o({force:!0})}),s.getLang("global_cancel"));return!1}return!0})),l=()=>{o()};return(0,i.FD)(d.n,{children:[(0,i.Y)(n.r,{onClose:l,closeAriaLabel:s.getLang("global_close"),children:s.getLang("docs_add_title")}),t.currentStep===C.saveOrEdit?(0,i.Y)(st,{onClose:l},C.saveOrEdit):(0,i.Y)(K,{onClose:l},C.upload)]})})),ot=(0,o.P)((function(){const t=S();return(0,i.Y)(a.wI,{onDestroy:t.close,children:()=>(0,i.Y)(it,{})})})),at=(0,l.jn)(L,ot)},75105:(t,e,s)=>{s.d(e,{Z:()=>c});var i=s(331635),o=s(327813),a=s(150575),r=s(42107),d=s(592008);class n{get rawId(){return(0,d.E)({id:this.data.id,owner_id:this.data.owner_id})}get data(){return this._data}async edit(t){await this.docsApi.edit({doc_id:this.data.id,owner_id:this.data.owner_id,title:t.title,folder_id:t.folderId,tags:t.tags.join(",")}),this._data.title=t.title,this._data.folder_id=t.folderId,this._data.tags=t.tags}constructor(t,e){this._data=t,this.docsApi=e,(0,o.l_)(this)}}class c{getDoc(t){return this.data.docsMap.get(t)}createDocFromApi(t){const e=new n(t,this.docsApi);return this.data.docsMap.set(e.rawId,e),e}async saveDoc({docRaw:t,title:e,tags:s,folderId:i}){const o=(await this.docsApi.save({file:t,title:e,tags:s.join(","),return_tags:1,folder_id:i})).doc;if(o)return this.createDocFromApi(o)}constructor(t){this.docsApi=t,this.data={docsMap:new Map},(0,o.l_)(this)}}c=(0,i.Cg)([r.z8.container(),(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[void 0===a.Q?Object:a.Q])],c)},592008:(t,e,s)=>{s.d(e,{E:()=>a,L:()=>r});var i=s(328911),o=s(206588);function a(t){return(0,i.o)({itemId:t.id,ownerId:t.owner_id})}function r(t){const e=(0,o.O)(t);return{id:e.itemId,owner_id:e.ownerId}}},140347:(t,e,s)=>{s.d(e,{o:()=>r});var i=s(331635),o=s(42107),a=s(412264);class r extends a.W{constructor(...t){super(...t),this.schema={version:1,name:"docsCache"}}}r=(0,i.Cg)([o.z8.global()],r)},508461:(t,e,s)=>{s.d(e,{O:()=>p});var i=s(331635),o=s(327813),a=s(916533),r=s(150575),d=s(645189),n=s(42107),c=s(592008),l=s(75105);class h{get count(){const{count:t}=this.data;return-1===t?0:t}get totalCount(){const{totalCount:t}=this.data;return-1===t?0:t}get filters(){return this.data.prevRequestParams}get isLoadedFully(){return-1!==this.data.count&&this.data.count<=this.items.length}get offset(){return this.items.filter((t=>!this.docsListsProvider.isDeletedDoc(t.rawId))).length}mapItems(){const t=[];for(const e of this.data.ids){const s=this.docsProvider.getDoc(e);if(!s)return t;t.push(s)}return t}get visibleItems(){return this.isLoading?this.prevItems:{items:this.items,count:this.count,totalCount:this.totalCount,type:this.filters?.type,q:this.filters?.q}}setPrevItems({items:t,count:e,totalCount:s,q:i,type:o}){this.prevItems={items:t,count:e,totalCount:s,q:i,type:o}}get items(){return this.mapItems()}get itemsWithCache(){let t=[];if(this.data.ids.length)t=this.mapItems();else if(this.cachedDocs.length)return this.cachedDocs;return t}reset(){this.controller?.abort(),this.resetState()}resetState(){this.data.count=-1,this.data.totalCount=-1,this.data.ids=[],this.data.prevRequestParams=null,this.isLoading=!1,this.controller=null}async fetch(t,{controller:e,withCache:s=!1,saveToCache:i=!1}={}){this.controller&&this.controller.abort(),this.setPrevItems({items:this.items,count:this.count,totalCount:this.totalCount,q:this.filters?.q,type:this.filters?.type}),this.resetState(),this.isLoading=!0,this.controller=e||new AbortController;const o=await this.request(t,this.controller,s,i);this.done(t,o)}async fetchNext(t,{controller:e}={}){if(this.isLoading||this.isLoadedFully)return;this.setPrevItems({items:this.items,count:this.count,totalCount:this.totalCount,q:this.filters?.q,type:this.filters?.type});const s={...this.data.prevRequestParams,count:t||this.data.prevRequestParams?.count||0,offset:this.offset};this.isLoading=!0,this.controller=e||new AbortController;const i=await this.request(s,this.controller);this.done(s,i)}done(t,e){const s=e.items.map((t=>t.rawId));this.data.count=e.count,this.data.totalCount=e.totalCount,this.data.prevRequestParams=t,this.data.ids=[...this.data.ids.slice(0,this.items.length),...s],this.cachedDocs=this.mapItems(),this.isLoading=!1,this.controller=null}constructor(t,e,s,i){this.docsListsProvider=t,this.docsProvider=e,this.docsApi=s,this.docsCache=i,this.data={count:-1,totalCount:-1,ids:[],prevRequestParams:null},this.controller=null,this.isLoading=!1,this.prevItems={items:[],count:0,totalCount:0,q:void 0,type:void 0},this.cachedDocs=[],this.willUseCache=!1,this.request=async(t,e,s=!1,i=!1)=>{let a;const r=t.q?.length||t.type;(0,o.h5)((()=>{this.willUseCache=!r&&s,this.cachedDocs=r?[]:this.cachedDocs})),s?a=await this.docsCache.get("docsApi"):(a=await this.docsApi[t.q?"search":"get"]({q:t.q,count:t.count,offset:t.offset,owner_id:t.ownerId,type:t.type,tags:t.tags?.join(","),search_type:t.searchType,return_tags:1},{signal:e.signal}),i&&!r&&this.docsCache.set("docsApi",a));const d=a.items.map((t=>this.docsProvider.createDocFromApi(t)));return{count:a.count,totalCount:a.total_count,items:d}},(0,o.l_)(this)}}var u=s(140347);class p{isDeletingDoc(t){return!!this.deletingDocs.get(t)}isRestoringDoc(t){return!!this.restoringDocs.get(t)}isDeletedDoc(t){return!!this.deletedDocs.get(t)}isAddingToAuthedUserList(t){return!!this.addingDocs.get(t)}isAddedToAuthedUserList(t){return!!this.addedDocs[t]}getTypes(t){return this.data.docsTypes.get(t)}async clearIDBDocsStore(){if(this.userEnv.partConfigEnabled("frontend.docs_idb_cache"))return this.docsCache.clearStore()}async addDocToAuthedUserList(t){const e=(0,c.E)(t);this.addingDocs.set(e,!0);try{const s=await this.docsApi.add({doc_id:t.id,owner_id:t.owner_id,access_key:t.accessKey});await this.clearIDBDocsStore(),(0,o.h5)((()=>{this.addingDocs.set(e,!1),this.addedDocs[e]=(0,c.E)({id:s,owner_id:this.authService.ensureUserId()})}))}catch(t){throw(0,o.h5)((()=>{this.addingDocs.set(e,!1)})),t}}async deleteDoc(t){const e=(0,c.E)(t),s=Object.keys(this.addedDocs).find((t=>this.addedDocs[t]===e));this.deletingDocs.set(e,!0),s&&this.addingDocs.set(s,!0);try{await this.docsApi.delete({owner_id:t.owner_id,doc_id:t.id}),(0,o.h5)((()=>{this.deletingDocs.set(e,!1),this.deletedDocs.set(e,!0),s&&(this.addingDocs.set(s,!1),delete this.addedDocs[s])})),await this.clearIDBDocsStore()}catch(t){throw(0,o.h5)((()=>{this.deletingDocs.set(e,!1),s&&this.addingDocs.set(s,!1)})),t}}async deleteDocFromAddedAuthedUserList(t){const e=this.addedDocs[(0,c.E)(t)];if(e)return await this.clearIDBDocsStore(),this.deleteDoc((0,c.L)(e))}async restoreDoc(t){const e=(0,c.E)(t);this.restoringDocs.set(e,!0);try{await this.docsApi.restore({doc_id:t.id,owner_id:t.owner_id}),(0,o.h5)((()=>{this.restoringDocs.set(e,!1),this.deletedDocs.set(e,!1)}))}catch(t){throw(0,o.h5)((()=>{this.restoringDocs.set(e,!1)})),t}}createSearchList(){return new h(this,this.docsProvider,this.docsApi,this.docsCache)}async fetchTypes({ownerId:t},{controller:e}={}){const s=await this.docsApi.getTypes({owner_id:t},{signal:e?.signal});return(0,o.h5)((()=>{this.data.docsTypes.set(t,s.items)})),s}constructor(t,e,s,i,a){this.docsProvider=t,this.authService=e,this.docsApi=s,this.docsCache=i,this.userEnv=a,this.data={docsTypes:new Map},this.deletingDocs=new Map,this.addingDocs=new Map,this.restoringDocs=new Map,this.deletedDocs=new Map,this.addedDocs={},(0,o.l_)(this)}}p=(0,i.Cg)([n.z8.container(),(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[void 0===l.Z?Object:l.Z,void 0===a.u?Object:a.u,void 0===r.Q?Object:r.Q,void 0===u.o?Object:u.o,void 0===d.J?Object:d.J])],p)},412264:(t,e,s)=>{s.d(e,{W:()=>r});var i=s(331635),o=s(901025),a=s(42107);class r{get(t){return this.dataCache.get(this.schema,t)}set(t,e){return this.dataCache.set(this.schema,t,e)}clearStore(){return this.dataCache.clearStore(this.schema)}constructor(t){this.dataCache=t}}r=(0,i.Cg)([a.z8.global({abstract:!0}),(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[void 0===o.r?Object:o.r])],r)},150575:(t,e,s)=>{s.d(e,{Q:()=>c});var i=s(331635),o=s(685431),a=s(820282),r=s(42107),d=s(174701),n=s(645189);class c extends a.S{get namespace(){return"docs"}constructor(t,e,s){super(e,s),this.userEnv=t,this._apiClient=e,this._apiPrefetch=s,this.add=this.makeMethod("add"),this.delete=this.makeMethod("delete"),this.restore=this.makeMethod("restore"),this.edit=this.makeMethod("edit"),this.save=this.makeMethod("save"),this.search=this.makeMethod("search",!0),this.get=this.makeMethod("get",!0),this.getTypes=this.makeMethod("getTypes",!0),this.getUploadServer=this.makeMethod("getUploadServer"),this.getTags=this.makeMethod("getTags",!0)}}c=(0,i.Cg)([r.z8.global(),(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[void 0===n.J?Object:n.J,void 0===o.Q?Object:o.Q,void 0===d.C?Object:d.C])],c)},432275:(t,e,s)=>{s.d(e,{d:()=>H});var i=s(221020),o=s(634164),a=s(516427),r=s(638945),d=s(782536),n=s(999051),c=s(880414),l=s(409698),h=s(799649);const u="vkitButtons__iconButton--vIUVN",p="vkitButtons__button--zB6nF",g=t=>(0,i.Y)(h.K,{onClick:e=>{e.stopPropagation(),t.onClick?.(e)},...t,className:(0,o.$)(u,t.className)});var _=s(928959),m=s(815287),f=s(674585);const v="vkitLabels__container--M75of",b="vkitLabels__label--wmpdk",y="vkitLabels__labelClickable--RwX5Z",D=({labels:t})=>(0,i.Y)(r.tW,{className:v,onClick:_.T,children:t.map((({id:t,href:e,title:s,onClick:a},d)=>{const n=(0,f.b)({href:e,onClick:a});return(0,i.FD)(m.Fragment,{children:[d>0&&", ",(0,i.Y)(r.tW,{Component:e?"a":"span",className:(0,o.$)(b,n&&y),onClick:a,href:e,children:s})]},t)}))});var C=s(352039),w=s(338786),L=s(804199),S=s(578544),U=s(563063),k=s(131369),Y=s(140675),I=s(413621);const E="vkitThumb__icon--CpSY7",F="vkitThumb__typeVideo--57fN3",T="vkitThumb__typeBook--jLV8Q",A="vkitThumb__typeMusic--QjzIn",P="vkitThumb__typeDocument--L9swq",N="vkitThumb__typeArticle--rBLpd",O="vkitThumb__typePicture--UmsRU",j="vkitThumb__typeZip--7fCAb",M={Icon:C.R,className:P},B={document:{Icon:w.L,className:N},archive:{Icon:L.v,className:j},gif:{Icon:S.g,className:O},image:{Icon:S.g,className:O},audio:{Icon:U.F,className:A},video:{Icon:k.o,className:F},book:{Icon:Y.L,className:T},unknown:M},z=({fileType:t,src:e,alt:s})=>{if(e&&"string"==typeof e)return(0,i.Y)(I._,{src:e,size:40,borderRadius:"l",alt:s});const{Icon:a,className:r}=B[t]||M;return(0,i.Y)("div",{className:(0,o.$)(E,r),style:{width:40,height:40},children:(0,m.isValidElement)(e)?e:(0,i.Y)(a,{})})},R="vkitFileCell__tappable--nlGvQ",q="vkitFileCell__fileCell--BxoLm",x="vkitFileCell__before--qLa2i",Q="vkitFileCell__content--k7SFv",$="vkitFileCell__title--BuvmC",K="vkitFileCell__subtitle--94DIQ",W="vkitFileCell__after--8zuBU",Z="vkitFileCell__tappableDeleted--TVtN5",V="vkitFileCell__tappableSelected--AUOSh",J="vkitFileCell__tappableLoading--ZvBtr",H=Object.assign((({title:t,subtitle:e,thumb:s,fileType:l,labels:h,loading:u,alt:p,deleted:_,selected:m,after:f,onClick:v,href:b})=>(0,i.Y)(a.SB4,{Component:b&&!_?"a":"div",href:b,target:b&&"_blank",rel:b&&"noopener noreferrer",hasHover:!_,hasActive:!_,className:(0,o.$)(R,_&&Z,u&&J,m&&V),onClick:v,"data-testid":"file_cell",children:(0,i.FD)("div",{className:q,children:[(0,i.Y)("div",{className:x,children:(0,i.Y)(z,{fileType:l,src:s,alt:p})}),(0,i.FD)("div",{className:Q,children:[(0,i.Y)(c.b,{className:$,lines:1,Component:r.$j,children:t}),e&&(0,i.Y)(c.b,{lines:1,Component:r.tW,className:K,children:e}),Array.isArray(h)&&h.length>0&&(0,i.Y)(D,{labels:h})]}),(f||u)&&(0,i.Y)("div",{className:W,children:(0,i.Y)(d.e,{gap:"none",children:u?(0,i.Y)(g,{hasActive:!1,hasHover:!1,children:(0,i.Y)(n.y,{size:"regular"})}):f})})]})})),{Button:t=>(0,i.Y)(l.$,{onClick:e=>{e.stopPropagation(),t.onClick?.(e)},mode:"tertiary",...t,size:"s",className:(0,o.$)(p,t.className)}),IconButton:g})},358553:(t,e,s)=>{s.d(e,{Y:()=>h});var i=s(221020),o=s(634164),a=s(638945);const r="vkitRecordListItem__root--pThK5",d="vkitRecordListItem__subtitle--i6Hup",n="vkitRecordList__root--KQ4rd",c="vkitRecordList__rootDecimal--PqV2S",l="vkitRecordList__rootDisc--8auao",h=Object.assign((({className:t,mode:e,...s})=>(0,i.Y)(a.EY,{className:t,children:(0,i.Y)("ul",{...s,className:(0,o.$)(n,"decimal"===e?c:l)})})),{Item:({children:t,subtitle:e,className:s,...n})=>(0,i.FD)("li",{...n,className:(0,o.$)(r,"vkitInternalRecordListItem",s),children:[t,!!e&&(0,i.Y)(a.tW,{className:d,children:e})]})})}}]),"undefined"!=typeof window&&window.stManager?.done?.("dist/core_spa/chunks/25017.2ab2e66b.js")}catch(t){throw"undefined"!=typeof window&&window.stManager?.fail?.("dist/core_spa/chunks/25017.2ab2e66b.js",t),t}