try{(self.webpackChunkvkweb=self.webpackChunkvkweb||[]).push([[47582],{646938:(e,t,i)=>{i.d(t,{DynamicStickersTypes:()=>d,StickerTypes:()=>c,StoryBlockType:()=>n,StoryEntryPoint:()=>o,StoryListName:()=>s.StoryListName,StoryPollBackgroundType:()=>u,StorySource:()=>a,StoryType:()=>r,dynamicStickerIds:()=>h,staticStickerIds:()=>l});var s=i(652469),r=function(e){return e.PHOTO="photo",e.VIDEO="video",e.LIVE="live",e}({}),o=function(e){return e.SWIPE="swipe",e.NAVIGATION_BUTTON="navigation_button",e.SIT_POSTING="sit_posting",e.LINK="link",e.STORY_REPLY="story_reply",e.STORY_REPOST="story_repost",e.CATALOG_ADD="catalog_add",e.DIALOG="dialog",e.STORY_LIVE_FINISHED="story_live_finished",e.DIALOG_VKME="dialog_vkme",e.STORY_VIEWER_FINISHED="story_viewer_finished",e.PUSH_TRY_MASK="push_try_mask",e.STORY_VIEWER_TRY_MASK="story_viewer_try_mask",e.LINK_MASK="link_mask",e.POSTING="posting",e.NEW_STORY_AVATAR="new_story_avatar",e.STORY_REPLIES_LIST="story_replies_list",e.STORIES_FEED="stories_feed",e.STORIES_SEARCH_NEWS="stories_search_news",e.QUESTION_STICKER="question_sticker",e.LIST_MIDDLE="list_middle",e.ARCHIVE_EMPTY_BUTTON="archive_empty_button",e.ARCHIVE_MENU_BUTTON="archive_menu_button",e.IM="im",e.PROFILE_BUTTON="profile_button",e.SHARE="share",e.MINI_APP="mini_app",e.SYSTEM_SHARING="system_sharing",e.SHORTCUT="shortcut",e.ARCHIVE_SHARING="archive_sharing",e.STORY_VIEWER_CAMERA_BUTTON="story_viewer_camera_button",e.STORY_VIEWER_MUSIC="story_viewer_music",e.STORY_VIEWER_MUSIC_SHEET="story_viewer_music_sheet",e.REPOST_TO_STORY_ACTIVITY="repost_to_story_activity",e.CHANGE_AVATAR="change_avatar",e.GROUP_ADD_STORIES_PAGE="group_add_stories_page",e.MUSIC_COVER_SHARING="music_cover_sharing",e}({}),a=function(e){return e.FEED="feed",e.FEED_MIDDLE="feed_middle",e.LINK="link",e.PROFILE="profile",e.IM_DIALOGS="im_dialogs",e.IM_DIALOG_HEADER="im_dialog_header",e.SNIPPET="snippet",e.REPLY="reply",e.REPLIES_LIST="replies_list",e.REPLY_STORY="reply_story",e.DISCOVER="discover",e.STORIES_MANAGE="stories_manage",e.USER_PERSONAL_CARD="user_personal_card",e.GROUP_PERSONAL_CARD="group_personal_card",e.NARRATIVE_SNIPPET="narrative_snippet",e.NARRATIVE_STORY="narrative_story",e.NARRATIVE_LINK="narrative_link",e.NARRATIVE_RECOMMENDATIONS="narrative_recommendations",e.NARRATIVE_SECTION="narrative_section",e.FAVE="fave",e.SPAMFEED="sf",e.ADS_PREVIEW="ads_preview",e.LIST_MIDDLE="list_middle",e.PLACE_STORY_LIST="place_story_list",e.SEARCH_STORY_LIST="search_story_list",e.STORY_ARCHIVE="story_archive",e.IM_MSG_LIST="im_msg_list",e.NOSPAM="nospam",e.PROFILE_SNACKBAR="profile_snackbar",e.MY_QUESTIONS="question_story",e}({}),n=function(e){return e.stories="stories",e.promoStories="promo_stories",e.discover="discover",e.liveActive="live_active",e.liveFinished="live_finished",e}({});const c={hashtag:1,mention:2,question:3,place:4,music:5,storyReply:6,owner:7,link:8,marketItem:9,post:10,poll:11,sticker:12,app:13,situationalTheme:14,playlist:15,videoButton:16,situationalTemplate:17,spoiler:18,service_yc_item:19,photo:20,album:21},d={situationalTemplate:c.situationalTemplate},h=Object.values(d),l=Object.values(c).filter((e=>!h.includes(e)));var u=function(e){return e.photo="photo",e.gradient="gradient",e.default="default",e}({})},894675:(e,t,i)=>{i.d(t,{showNearPhotos:()=>a,showStoryBlackList:()=>o});var s=i(270959),r=i(586573);function o(e){window.cur.storyLayer&&window.cur.storyLayer.pauseStory(),(0,s.showBox)("al_stories.php",{act:"black_list"},{stat:["stories.css",window.jsc("web/stories.js")],onDone(){window.cur.storiesBlackListScroll=new r.UiScroll("stories_black_list_result")},params:{onHide:()=>{window.cur.storyLayer&&window.cur.storyLayer.playStory(),e?.()}}})}function a(e){(0,s.showBox)("al_places.php",{act:"show_photo_place",place_id:e,from_wall:1,photos_only:1},{cache:1})}},588210:(e,t,i)=>{i.d(t,{StoriesViewerStatsEventType:()=>a,StoriesViewerStatsService:()=>n});var s=i(331635),r=i(132028),o=i(245549),a=function(e){return e.addToFriends="add_to_friends",e.claim="claim",e.clickOnBadge="click_on_badge",e.clickOnClickableSticker="click_on_clickable_sticker",e.clickToLike="click_to_like",e.clickToShare="click_to_share",e.clickToMetaAvatar="click_to_meta_avatar",e.clickToMetaPrivacy="click_to_meta_privacy",e.clickToMetaMask="click_to_meta_mask",e.clickToMetaMemories="click_to_meta_memories",e.clickToMetaMusic="click_to_meta_music",e.clickToMetaAd="click_to_meta_ad",e.clickToMetaRepost="click_to_meta_repost",e.clickToMetaQuestions="click_to_meta_questions",e.clickToMetaClip="click_to_meta_clip",e.clickToTTooltip="click_to_tooltip",e.clickToUnlike="click_to_unlike",e.copyERID="copy_ERID",e.goToNextStoryAutoByTime="go_to_next_story_auto_by_time",e.goToNextStoryTap="go_to_next_story_tap",e.goToPreviousStory="go_to_previous_story",e.closeAutoByTime="close_auto_by_time",e.closeTap="close_tap",e.commentSend="comment_send",e.commentTap="comment_tap",e.copyErid="copy_erid",e.delete="delete",e.deleteFromNarrative="delete_from_narrative",e.hideDiscover="hide_discover",e.hideFromStories="hide_from_stories",e.goToNextAuthor="go_to_next_author",e.goToPreviousAuthor="go_to_previous_author",e.goToStoryClick="go_to_story_click",e.goToAuthor="go_to_author",e.linkClick="link_click",e.livePlayerShow="live_player_show",e.markNotInterested="mark_not_interested",e.musicAdded="music_added",e.openAdvertiserInformation="open_advertiser_information",e.openEmptyFeedback="open_empty_feedback",e.openRepliesList="open_replies_list",e.openViewer="open_viewer",e.questionBanAuthor="question_ban_author",e.questionBanAnonymousAuthor="question_ban_anonymous_author",e.questionDelete="question_delete",e.questionGoToAuthor="question_go_to_author",e.questionReply="question_reply",e.pauseLongTap="pause_long_tap",e.playNext="play_next",e.resumeRelease="resume_release",e.shareToMessage="share_to_message",e.stickerReactionSend="sticker_reaction_send",e.stickerSuggestionSend="sticker_suggestion_send",e.viewStory="view_story",e.deleteNarrative="delete_narrative",e}({});class n{init(e){this.getActionData=e}destroy(){this.getActionData=void 0}saveStoryViewStats(e,t={}){const i=this.getActionData?.(e);i&&this.storyViewStats.send({...i,...t})}constructor(e){this.storyViewStats=e,this.getActionData=void 0}}n=(0,s.__decorate)([r.scope.container(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===o.StoryViewStats?Object:o.StoryViewStats])],n)},304487:(e,t,i)=>{i.d(t,{getStoryPerfData:()=>s});const s=e=>({owner_id:e?.owner_id??0,content_id:e?.id??0,content_type:"photo"===e?.type?"photo":"video",content_subtype:e?.type??"photo",width:0,height:0,duration:e?.video?.duration??0})},973866:(e,t,i)=>{i.d(t,{StoriesViewerMediaEntity:()=>s});class s{setParams(e){this.props=e}play(e){}pause(){}destroy(){}constructor(){this.props={pause:()=>{},play:()=>{},loading:()=>{},setError:()=>{}}}}},543802:(e,t,i)=>{i.d(t,{StoriesViewerPhotoEntity:()=>a});var s=i(789310),r=i(489633),o=i(652469);class a extends s.StoriesViewerMediaEntity{render(){return this.photoUrl}getDuration(){return r.PHOTO_STORY_DURATION}changeVolume(){}constructor(e){super(),this.type=o.StoryType.PHOTO,this.photoUrl=e}}},826889:(e,t,i)=>{i.d(t,{StoriesViewerVideoEntity:()=>n});var s=i(789310),r=i(489633),o=i(662285),a=i(652469);class n extends s.StoriesViewerMediaEntity{render(){return this.video}play(e=!1){e&&(this.video.muted=!0),this.asyncPlay()}async asyncPlay(){if(this.video.paused)try{await this.video.play()}catch(e){this.props.pause()}}pause(){this.video.pause()}destroy(){this.video.currentTime=0;for(let e of this.listeners)this.video.removeEventListener(e.eventName,e.listener);this.videoElementManager.detachAndMarkForDisposal(this.videoUrl)}getDuration(e){const t=this.video.duration||e;return t?1e3*t+100:r.VIDEO_STORY_MAX_DURATION}changeVolume(e){this.video.volume=e}constructor(e,t){super(),this.type=a.StoryType.VIDEO,this.listeners=[{eventName:"waiting",listener:()=>{this.props.loading()}},{eventName:"playing",listener:()=>{this.props.play()}},{eventName:"error",listener:e=>{this.props.setError(o.StoriesViewerTechErrors.FAIL_FETCH_VIDEO,e.error)}}],this.videoElementManager=e,this.videoUrl=t,this.video=e.getVideoElement(t),this.video.classList.add("videoStoriesViewerPlayer"),this.video.setAttribute("autoplay","false"),this.video.setAttribute("x-yandex-pip","false"),this.video.setAttribute("disablePictureInPicture","true");for(const e of this.listeners)this.video.addEventListener(e.eventName,e.listener)}}},380176:(e,t,i)=>{i.d(t,{StoriesViewerVkVideoEntity:()=>c});var s=i(789310),r=i(773439),o=i(489633),a=i(662285),n=i(652469);class c extends s.StoriesViewerMediaEntity{render(){return this.vkVideo.videoContainer}play(e=!1){e?this.vkVideo.player.setMuted(!0):this.isMutedByAutoplay&&(this.vkVideo.player.setMuted(!1),this.isMutedByAutoplay=!1),this.vkVideo.player.play()}pause(){this.vkVideo.player.pause()}destroy(){this.vkVideo.reset(),this.subscriptions.unsubscribe()}getDuration(e){const t=this.vkVideo.duration||e;return t?1e3*t+100:o.VIDEO_STORY_MAX_DURATION}changeVolume(e){this.vkVideo.player.setVolume(e)}constructor(e){super(),this.type=n.StoryType.VIDEO,this.subscriptions=new r.Subscription,this.isMutedByAutoplay=!1,this.vkVideo=e,this.vkVideo.addContainerClass("videoStoriesViewerContainer"),this.vkVideo.addVideoClass("videoStoriesViewerPlayer"),this.subscriptions.add(this.vkVideo.player.events.autoplaySoundProhibited$.subscribe((()=>{this.props.pause(),this.isMutedByAutoplay=!0}))).add(this.vkVideo.player.events.fatalError$.subscribe((()=>{this.props.setError(a.StoriesViewerTechErrors.FAIL_FETCH_VK_VIDEO)}))).add(this.vkVideo.player.info.isStalled$.subscribe((e=>{if(e){const e=this.vkVideo.player.info.position$.getValue();1e3*(this.vkVideo.player.info.duration$.getValue()-e)>250&&this.props.loading()}}))).add(this.vkVideo.player.events.playing$.subscribe((()=>{this.props.play()})))}}},789310:(e,t,i)=>{i.d(t,{StoriesViewerMediaEntity:()=>s.StoriesViewerMediaEntity,StoriesViewerPhotoEntity:()=>r.StoriesViewerPhotoEntity,StoriesViewerVideoEntity:()=>o.StoriesViewerVideoEntity,StoriesViewerVkVideoEntity:()=>a.StoriesViewerVkVideoEntity});var s=i(973866),r=i(543802),o=i(826889),a=i(380176)},557006:(e,t,i)=>{i.d(t,{NarrativeCoverUploadService:()=>n});var s=i(331635),r=i(132028),o=i(327813),a=i(415836);class n{setCustomCover(e,t,i,s){this.customCoverUrl=t,this.customCoverOriginalUrl=i,this.customCoverUploadResponse=s,this.checkedCoverId=e}async saveCustomCover(){if(this.customCoverUrl&&this.customCoverUploadResponse)try{const e=await this.narrativesApi.saveCustomCover({response_json:this.customCoverUploadResponse});(0,o.runInAction)((()=>(this.customCoverPhoto=e.photo,e)))}catch(e){throw new Error(e)}}async getCustomCoverUploadUrl(e){return await this.narrativesApi.getCustomCoverUploadServer({owner_id:e})}finishUploading(e,t,i,s){(0,o.runInAction)((()=>{this.customCoverUrl=e,this.customCoverOriginalUrl=e,this.customCoverUploadResponse=t,this.customCoverPercent=100,this.customCoverStatus="uploaded",this.customCoverSizes={width:i,height:s}}))}resetUploadState(){this.isUploading=!1}clearCustomCover(){this.customCoverUrl="",this.customCoverOriginalUrl="",this.customCoverUploadResponse="",this.customCoverPhoto=void 0,this.checkedCoverId="",this.file=null,this.customCoverPercent=0,this.customCoverStatus="idle",this.isUploading=!1}setProgress(e,t){this.customCoverPercent=Math.round(e/t*100)}startUploading(){(0,o.runInAction)((()=>{this.customCoverStatus="uploading",this.customCoverPercent=0,this.customCoverUploadResponse=""}))}handleUploadError(){(0,o.runInAction)((()=>{this.customCoverStatus="failed",this.customCoverPercent=0}))}get isUploadingCover(){return this.isUploading}reset(){this.checkedCoverId="",this.customCoverUrl="",this.customCoverOriginalUrl="",this.customCoverUploadResponse="",this.customCoverPhoto=void 0,this.file=null,this.customCoverPercent=0,this.customCoverStatus="idle",this.isUploading=!1,this.customCoverSizes={width:0,height:0}}constructor(e){this.narrativesApi=e,this.checkedCoverId="",this.customCoverUrl="",this.customCoverOriginalUrl="",this.customCoverUploadResponse="",this.customCoverPhoto=void 0,this.file=null,this.customCoverPercent=0,this.customCoverStatus="idle",this.isUploading=!1,this.customCoverSizes={width:0,height:0},(0,o.makeAutoObservable)(this)}}n=(0,s.__decorate)([r.scope.global(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===a.NarrativesApi?Object:a.NarrativesApi])],n)},454095:(e,t,i)=>{i.d(t,{NarrativeListModalService:()=>g});var s=i(331635),r=i(327813),o=i(840532),a=i(415836),n=i(972573),c=i(951652),d=i(670252),h=i(712600),l=i(132028),u=i(489633),S=i(468073),v=i(873900),p=i(501332),y=i(536490);class g{async init(e,t){this.props=e,t&&(this.modalParams=t),this.popout=null,this.isUpdating=!1,this.needReturnToNarrativeListModal=!1,this.narrativeEntity=this.narrativesList.byOwner.ensure({owner_id:this.props.ownerId,with_empty:this.isOwner?1:0,extended:1}),this.narratives.length||(this.scrollPosition=0,await this.fetch())}get isGroup(){return this.props.ownerId<0}async fetch(){this.narrativeEntity?.reset(),this.isErrorLoading=!1;try{await(this.narrativeEntity?.fetch({limit:u.NARRATIVE_LIST_LIMIT}))}catch(e){console.error(e),this.isErrorLoading=!0,this.snackbar.show({type:"error",text:this.langs.getLang("stories_narrative_list_load_error"),action:{label:this.langs.getLang("stories_narrative_list_load_error_reload"),onClick:()=>this.fetch()}})}}get narratives(){return this.narrativeEntity?.data?.items||[]}get owner(){return(0,y.findOwnerById)(this.props.ownerId,this.narrativeEntity?.data?.profiles,this.narrativeEntity?.data?.groups)}get hasLoaded(){return!this.narrativeEntity?.data?.next_from}get isOwner(){return this.modalParams.canEdit||this.props.ownerId===this.authService.userId}get showLoader(){return this.isLoading&&!this.narratives.length}get showLoadMoreLoader(){return this.isLoading&&!!this.narratives.length}get needLoadMore(){return!(this.isLoading||!this.narratives.length||this.hasLoaded||this.isErrorLoading)}get showOwnerButtons(){return this.isOwner&&!this.showLoader}get showArchiveButton(){return this.isOwner&&!this.showLoader&&S.Ranges.isUserId(this.props.ownerId)}get isLoading(){return this.narrativeEntity?.isLoading()||!1}get isEmpty(){return!this.isLoading&&!this.narratives.length}goToAnotherModal(){this.needReturnToNarrativeListModal=!0,this.scrollPosition=this.scrollElement.current?.scrollTop||window.scrollY||document.documentElement.scrollTop||0}destroy(){this.scrollElement={current:null},this.popout=null}constructor(e,t,i,s,o,a,n){this.narrativesList=e,this.narrativesApi=t,this.narrativePublishAnalytics=i,this.faveApi=s,this.authService=o,this.snackbar=a,this.langs=n,this.props={ownerId:0,close:()=>null},this.modalParams={ownerId:0},this.narrativeEntity=null,this.popout=null,this.isUpdating=!1,this.isErrorLoading=!1,this.scrollElement={current:null},this.needReturnToNarrativeListModal=!1,this.scrollPosition=0,this.loadMore=async()=>{if(!(this.hasLoaded||this.isLoading||this.isErrorLoading))try{await(this.narrativeEntity?.fetch({limit:u.NARRATIVE_LIST_LIMIT,start_from:this.narrativeEntity?.data?.next_from},{},!1,!0))}catch(e){console.error(e),this.isErrorLoading=!0,this.snackbar.show({type:"error",text:this.langs.getLang("stories_narrative_list_load_more_error")})}},this.updateData=async e=>{try{this.isErrorLoading=!1,this.isUpdating=!0;const t=e?this.narratives.length+1:this.narratives.length;await(this.narrativeEntity?.fetch({limit:t}))}catch(e){console.error(e),this.isErrorLoading=!0}finally{this.isUpdating=!1}},this.openPopout=e=>{this.popout=e},this.closePopout=()=>{this.popout=null},this.close=()=>{this.narrativeEntity?.reset(),this.props.close?.(),this.modalParams.onClose?.()},this.handleNarrativeReorder=async({from:e,to:t})=>{if(e===t)return;const i=this.narratives[e].id,s={owner_id:this.props.ownerId,narrative_id:i};t<e?s.before=this.narratives[t].id:s.after=this.narratives[t].id,(0,r.runInAction)((()=>{const i=this.narratives[e];this.narrativePublishAnalytics.send(p.NarrativeAnalyticEventType.changeSort,i,this.modalParams.navScreen),this.narratives.splice(e,1),this.narratives.splice(t,0,i)}));try{await this.narrativesApi.reorder(s),this.modalParams.onReorder?.()}catch(i){(0,r.runInAction)((()=>{console.error(i);const s=this.narratives[t];this.narratives.splice(t,1),this.narratives.splice(e,0,s),this.snackbar.show({type:"error",text:this.langs.getLang("stories_narrative_list_reorder_error")})}))}this.narrativePublishAnalytics.send(p.NarrativeAnalyticEventType.changeSort,{owner_id:this.props.ownerId,id:i},p.NarrativeAnalyticNavScreen.storyViewer)},this.deleteNarrative=async e=>{const t=this.narratives.findIndex((({id:t})=>t===e)),i=this.narratives[t];this.narratives.splice(t,1),this.narrativePublishAnalytics.send(p.NarrativeAnalyticEventType.deleteNarrative,i,this.modalParams.navScreen);try{await this.narrativesApi.delete({owner_id:this.props.ownerId,narrative_id:e}),this.modalParams.onRemove?.()}catch(e){console.error(e),this.narratives.splice(t,0,i),this.snackbar.show({type:"error",text:this.langs.getLang("stories_narrative_list_delete_error")})}},this.bookmarkRequest=async e=>{try{e.is_favorite?(e.is_favorite=!1,await this.faveApi.removeNarrative({owner_id:this.props.ownerId,narrative_id:e.id}),this.snackbar.show({type:"ok",text:this.langs.getLang("stories_narrative_list_bookmark_deleted")})):(this.narrativePublishAnalytics.send(p.NarrativeAnalyticEventType.addToBookmarks,e,this.modalParams.navScreen),e.is_favorite=!0,await this.faveApi.addNarrative({owner_id:this.props.ownerId,narrative_id:e.id}),this.snackbar.show({type:"ok",text:this.langs.getLang("stories_narrative_list_bookmark_added"),interpolate:!0,action:{href:"/bookmarks?type=narrative&is_from_snackbar=1",label:this.langs.getLang("stories_narrative_list_bookmark_added_link")}}))}catch(t){console.error(t),this.snackbar.show({type:"error",text:this.langs.getLang(e.is_favorite?"stories_narrative_list_bookmark_error":"stories_narrative_list_bookmark_delete_error")}),e.is_favorite=!e.is_favorite}},this.getFullNarrative=async e=>{const t=this.narrativesList.byId.ensure({narratives:(0,v.getIdentityRawId)({id:e,ownerId:this.props.ownerId}),extended:1});try{await t.fetch()}catch(e){console.error(e)}return t.data?.items?.[0]},this.returnToNarrativeModal=()=>{this.needReturnToNarrativeListModal=!1,this.narratives.length||(this.scrollPosition=0,this.fetch())},this.resetScrollPosition=()=>{this.scrollPosition=0},this.resetEntity=()=>{this.narrativeEntity?.reset()},(0,r.makeAutoObservable)(this)}}g=(0,s.__decorate)([l.scope.global(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===o.NarrativesListProvider?Object:o.NarrativesListProvider,void 0===a.NarrativesApi?Object:a.NarrativesApi,void 0===p.NarrativePublishAnalytics?Object:p.NarrativePublishAnalytics,void 0===n.FaveApi?Object:n.FaveApi,void 0===c.AuthService?Object:c.AuthService,void 0===d.Snackbar?Object:d.Snackbar,void 0===h.Langs?Object:h.Langs])],g)},669928:(e,t,i)=>{i.d(t,{NarrativesEditorService:()=>S});var s=i(331635),r=i(132028),o=i(327813),a=i(415836),n=i(188546),c=i(738100),d=i(489633),h=i(536490),l=i(557006),u=i(351118);class S{setScreen(e){this.screen=e}getStory(e){return this.selectedStories.get(e)}get selectedStoriesArray(){return Array.from(this.selectedStories.values())}isStorySelected(e){return this.storySelectionState.has(e)}toggleStorySelection(e,t){this.storySelectionState.has(e.id)?(this.storySelectionState.delete(e.id),t?.removeOnUnselect&&this.selectedStories.delete(e.id)):(this.storySelectionState.add(e.id),this.selectedStories.set(e.id,e)),this.selectedStories.forEach(((e,t)=>{this.storySelectionState.add(t),this.setStoryCoverSize(t)}))}removeStoryFromSelected(e){this.selectedStories.delete(e),this.storySelectionState.delete(e)}clearSelectedStories(){this.selectedStories.clear(),this.storySelectionState.clear(),this.storyCoverSizes.clear()}setSelectedStories(e){this.selectedStories=e,this.storySelectionState.clear(),e.forEach(((e,t)=>{this.storySelectionState.add(t),this.setStoryCoverSize(e.id)}))}async createNarrative(e){return(await this.narrativesApi.create(e)).narrative}async editNarrative(e){return(await this.narrativesApi.edit(e)).narrative}get isLoading(){return Boolean(this.archiveEntity?.isLoading())}get isFirstLoading(){return!this.isFirstLoaded}getStories(){return this.archiveEntity?.data?.items||[]}setIsFirstLoaded(e){this.isFirstLoaded=e}createRawId(e,t){return`${e}_${t}`}async fetchData(){try{this.archiveEntity||(this.archiveEntity=this.storiesListProvider.archive.ensure(this.reqParams));const e=(this.reqParams.offset??0)>0;await this.archiveEntity.fetch(this.reqParams,{},!1,e);const t=this.archiveEntity.data?.items??[];if(!t.length)return void(this.hasMore=!1);const i=t.map((e=>e.id?`${this.reqParams.owner_id??0}_${e.id}`:"")).filter(Boolean),s=this.storiesIds.get(this.reqParams.owner_id??0)??[];let r,o;if(0===this.reqParams.offset)r=i,o=i.length;else{const e=i.filter((e=>!s.includes(e)));r=[...s,...e],o=e.length}this.storiesIds.set(this.reqParams.owner_id??0,r),this.reqParams={...this.reqParams,offset:(this.reqParams.offset??0)+o},this.hasMore=o>0&&o>=(this.reqParams.count??0),this.isError=!1}catch(e){throw this.hasMore=!1,this.isError=!0,new Error(e)}}async fetchStories(e){this.setIsFirstLoaded(!1),this.reqParams={...this.reqParams,offset:0,...e||{}},await this.fetchData(),this.setIsFirstLoaded(!0)}async fetchNarratives(e,t){if(this.isNarrativesFetched)return;const{items:i}=await this.narrativesApi.getById({narratives:`${e}_${t}`});this.isNarrativesFetched=!0;const s=i[0];if(!s)return;const r=s.stories||[],o=new Map;r.forEach((e=>{o.set(e.id,e)})),this.setSelectedStories(o),this.title=s.title;const a=s.cover;if(a){this.crop={height:a.crop_height||0,width:a.crop_width||0,x:a.crop_x||0,y:a.crop_y||0};const e=(0,u.getPhotoSize)(a.cropped_sizes||[],(0,u.isRetina)()?200:400)?.url||"";this.narrativeCoverUrl=e,a.custom_photo&&(this.narrativeCoverUploadService.customCoverPhoto=a.custom_photo,this.narrativeCoverUploadService.checkedCoverId="custom",this.narrativeCoverUploadService.customCoverUrl=a.custom_photo.orig_photo?.url||e,this.narrativeCoverUploadService.customCoverStatus="uploaded",this.narrativeCoverUploadService.customCoverPercent=100,this.narrativeCoverUploadService.customCoverSizes={width:a.custom_photo.orig_photo?.width||0,height:a.custom_photo.orig_photo?.height||0}),a.cover_story_id&&(this.narrativeCoverUploadService.checkedCoverId=`${s.owner_id}_${a.cover_story_id}`)}}async fetchNextStories(){this.hasMore&&!this.isLoading&&await this.fetchData()}reset(){this.selectedStories.clear(),this.storySelectionState.clear(),this.storyCoverSizes.clear(),this.screen="main",this.crop={width:0,height:0,x:0,y:0},this.narrativeCoverUrl="",this.archiveEntity=null,this.storiesIds.clear(),this.reqParams={count:d.STORIES_ARCHIVE_LIMIT,offset:0},this.hasMore=!0,this.isFirstLoaded=!1,this.isNarrativesFetched=!1,this.title="",this.narrativeCoverUploadService.reset()}constructor(e,t,i){this.narrativesApi=e,this.storiesListProvider=t,this.narrativeCoverUploadService=i,this.selectedStories=new Map,this.storySelectionState=new Set,this.storyCoverSizes=new Map,this.screen="main",this.crop={width:0,height:0,x:0,y:0},this.narrativeCoverUrl="",this.archiveEntity=null,this.storiesIds=new Map,this.reqParams={count:d.STORIES_ARCHIVE_LIMIT,offset:0},this.hasMore=!0,this.isError=!1,this.isFirstLoaded=!1,this.title="",this.setStoryCoverSize=e=>{const t=this.storyCoverSizes.get(e);if(t)return t;const i=this.selectedStories.get(e);if(!i)return;const s=200*window.devicePixelRatio;if(!((0,h.getStoryPreview)(i,s)||""))return;let r={width:0,height:0,url:""};if(i?.photo){const e=(0,u.getPhotoSize)(i.photo.sizes||[],s);r={url:e?.url||"",width:e?.width||0,height:e?.height||0}}else if(i?.video){const e=(0,n.findBaseImage)(i.video.image);if(e){r={url:(0,n.getBaseImageUrl)(e.url,e.width,e.height),width:e.width,height:e.height}}else{const e=(0,u.getPhotoSize)(i.video.image||[],s);r={url:e?.url||"",width:e?.width||0,height:e?.height||0}}}this.storyCoverSizes.set(e,r)},this.isNarrativesFetched=!1,(0,o.makeAutoObservable)(this)}}S=(0,s.__decorate)([r.scope.global(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===a.NarrativesApi?Object:a.NarrativesApi,void 0===c.StoriesListProvider?Object:c.StoriesListProvider,void 0===l.NarrativeCoverUploadService?Object:l.NarrativeCoverUploadService])],S)},51238:(e,t,i)=>{i.d(t,{StoriesArchiveScrollService:()=>h});var s=i(331635),r=i(327813),o=i(132028),a=i(351118),n=i(281285);const c=1e3,d=100;class h{init(e,t,i){this.config={...this.config,...e},this.scrollHandlers=t,this.createScrollHandler(),this.config.restoreMethod=i}createScrollHandler(){this.onScrollHandler=(0,a.throttle)((()=>{if(!this.scrollElement)return;this.timeout&&clearTimeout(this.timeout),this.isScrolling=!0;this.scrollElement.scrollTop>=this.config.dateThreshold?(this.showDate=!0,this.timeout=setTimeout((()=>{this.isScrolling||(this.showDate=!1)}),this.config.hideDelay??c)):this.showDate=!1,setTimeout((()=>{this.isScrolling=!1}),50)}),this.config.throttleDelay??d)}handleVirtualizerChange(e){const t=e.scrollElement;if(t&&this.scrollElement!==t&&(this.scrollElement&&this.onScrollHandler&&this.scrollElement.removeEventListener("scroll",this.onScrollHandler),this.scrollElement=t,this.onScrollHandler&&this.scrollElement.addEventListener("scroll",this.onScrollHandler)),this.storiesArchiveService.scrollPosition&&e.getVirtualItems().length>0&&("scrollToOffset"===this.config.restoreMethod?e.scrollToOffset(this.storiesArchiveService.scrollPosition):e.scrollToIndex(this.storiesArchiveService.scrollPosition,{align:"start"}),this.scrollHandlers.clear()),!e.range)return;const{startIndex:i}=e.range;this.scrollIndex=i}updateStoryDate(e){this.storyDate=e?new Date(1e3*e):null}saveScrollPosition(){this.scrollElement&&("scrollToOffset"===this.config.restoreMethod?this.storiesArchiveService.scrollPosition=this.scrollElement.scrollTop:this.storiesArchiveService.scrollPosition=this.scrollIndex)}resetScrollPosition(){this.scrollElement&&(this.scrollElement.scrollTo(0,0),this.storiesArchiveService.scrollPosition=0)}destroy(){this.scrollElement&&this.onScrollHandler&&this.scrollElement.removeEventListener("scroll",this.onScrollHandler),this.timeout&&clearTimeout(this.timeout)}createWebConfig(e){return{dateThreshold:e,hideDelay:c,throttleDelay:d}}createMobileConfig(){return{dateThreshold:0,hideDelay:c,throttleDelay:d}}createScrollHandlers(e){return{save:t=>{this.storiesArchiveService.scrollPosition=e(t)},clear:()=>{this.storiesArchiveService.scrollPosition=0}}}constructor(e){this.storiesArchiveService=e,this.showDate=!1,this.isScrolling=!1,this.storyDate=null,this.scrollElement=void 0,this.timeout=null,this.config={dateThreshold:0,hideDelay:c,throttleDelay:d},this.scrollHandlers={save:()=>{},clear:()=>{}},this.scrollIndex=0,(0,r.makeAutoObservable)(this)}}h=(0,s.__decorate)([o.scope.transient(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===n.StoriesArchiveService?Object:n.StoriesArchiveService])],h)},281285:(e,t,i)=>{i.d(t,{StoriesArchiveService:()=>S});var s=i(331635),r=i(132028),o=i(873900),a=i(746310),n=i(327813),c=i(199484),d=i(738100),h=i(489633),l=i(536490),u=i(858628);class S{get isLoading(){return Boolean(this.archiveEntity?.isLoading())}cleanStoriesArchive(){this.storiesIds.clear()}getStories(e){return this.storiesIds.get(e??0)?.reduce(((e,t)=>{const i=this.getStory(t);return i&&e.push(i),e}),[])??[]}setIsFirstLoaded(e){this.isFirstLoaded=e}addStories(e,t){if(!t.length)return;this.storiesProvider.createStoriesFromApi(t);const i=t.map((e=>(0,o.getIdentityRawId)({ownerId:e.owner_id,id:e.id}))),s=Math.floor((t[0].date||0)/86400),r=this.storiesIds.get(e)??[];let a=r.findIndex((e=>{const t=this.getStory(e)?.data;if(!t)return!1;return Math.floor((t.date||0)/86400)<s}));-1===a&&(a=r.length),this.reqParams.offset&&(this.reqParams.offset+=t.length),r.splice(a,0,...i)}async fetchData(){this.archiveEntity=this.listProvider.archive.ensure(this.reqParams),await this.archiveEntity.fetch();const e=this.storiesProvider.createStoriesFromApi(this.archiveEntity.data?.items??[]);if(!e.length)return void(this.hasMore=!1);const t=e.map((e=>e.createRawId())),i=this.storiesIds.get(this.reqParams.owner_id??0)??[],s=0===this.reqParams.offset?t:[...i,...t];this.storiesIds.set(this.reqParams.owner_id??0,s);const r=this.archiveEntity.data?.items.length??0;this.reqParams={...this.reqParams,offset:(this.reqParams.offset??0)+r},this.hasMore=r>0&&r>=(this.reqParams.count??0)}get isFirstLoading(){return!this.isFirstLoaded}async fetch(e){this.setIsFirstLoaded(!1),this.reqParams={...this.reqParams,offset:0,...e||{}},await this.fetchData(),this.setIsFirstLoaded(!0)}async fetchNext(){this.hasMore&&!this.isLoading&&await this.fetchData()}getStory(e){return this.storiesProvider.getStory(e)}deleteStoryFromList(e){const[t]=e.split("_"),i=this.storiesIds.get(Number(t))??[],s=i.indexOf(e);-1!==s&&(i.splice(s,1),"number"==typeof this.reqParams.offset&&this.reqParams.offset>0&&(this.reqParams.offset-=1))}async deleteStories(e){const t=this.reqParams.owner_id??0;await this.storiesApi.delete({stories:e.join(",")});const i=(this.storiesIds.get(t)??[]).filter((t=>!e.includes(t)));this.storiesIds.set(t,i),this.reqParams.offset="number"==typeof this.reqParams.offset&&this.reqParams.offset-e.length>=0?this.reqParams.offset-e.length:0}constructor(e,t,i,s){this.storiesProvider=e,this.storiesListSharedProvider=t,this.listProvider=i,this.storiesApi=s,this.archiveEntity=null,this.storiesIds=new Map,this.reqParams={count:h.STORIES_ARCHIVE_LIMIT,extended:1,offset:0},this.hasMore=!0,this.needReturnToArchiveModal=!1,this.scrollPosition=0,this.isFirstLoaded=!1,this.setArchiveDataForStoriesViewer=(e,t)=>{const i=this.storiesListSharedProvider.archive.ensure({date:e,owner_id:t,extended:1}),s=this.getStories(t).map((e=>e.data)).filter((t=>e===(0,l.getStoryZeroTime)(t.date??0)));i.addData({count:s.length,items:s,groups:this.archiveEntity?.data?.groups??[],profiles:this.archiveEntity?.data?.profiles??[]})},(0,n.makeAutoObservable)(this)}}S=(0,s.__decorate)([r.scope.global(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===c.StoriesProvider?Object:c.StoriesProvider,void 0===u.StoriesListSharedProvider?Object:u.StoriesListSharedProvider,void 0===d.StoriesListProvider?Object:d.StoriesListProvider,void 0===a.StoriesApi?Object:a.StoriesApi])],S)},206160:(e,t,i)=>{i.d(t,{StoriesViewerActionsService:()=>M});var s=i(331635),r=i(132028),o=i(327813),a=i(746310),n=i(734979),c=i(591301),d=i(208214),h=i(962005),l=i(21632),u=i(972573),S=i(415836),v=i(740177),p=i(670252),y=i(712600),g=i(24516),m=i(909209),_=i(662285),w=i(652469),f=i(873900),E=i(33305),A=i(468073),k=i(209761),I=i(98710),b=i(311763),L=i(113326),P=i(536490),T=i(351118),V=i(97650),O=i(588210),C=i(501332);class M{sendAudienceResearchData(e){if(!this.userEnv.isToggleEnabled("st_audience_research"))return;const{research:t}=e;t&&this.audienceResearchService.send({urls:t.urls||[],events:t.events||[],surface:k.AUDIENCE_RESEARCH_SURFACE.story_sticker})}constructor(e,t,i,s,r,a,n,c,d,h,l,u,S,v,p,y,g,m,k,L){this.storiesApi=e,this.pollsApi=t,this.likesApiService=i,this.friendsApi=s,this.groupsApi=r,this.accountApi=a,this.faveApi=n,this.narrativesApi=c,this.messagesApi=d,this.itemsListService=h,this.eventsService=l,this.errorsService=u,this.appService=S,this.snackbar=v,this.langs=p,this.userEnv=y,this.storiesListSharedProvider=g,this.audienceResearchService=m,this.statsService=k,this.narrativePublishAnalytics=L,this.statuses={feedback:{},viewers:{},ban:{},hide:{}},this.abortControllers={likes:{}},this.likeStory=async e=>{if(!e?.can_like)return;const t=e.is_liked,i=(0,f.getIdentityRawId)({ownerId:e.owner_id,id:e.id}),s=new AbortController;this.abortControllers.likes[i]?.abort(),this.abortControllers.likes[i]=s;const r=t?this.likesApiService.delete({owner_id:e.owner_id,type:"story",item_id:e.id,ref:this.appService.module},{signal:s.signal}):this.likesApiService.add({owner_id:e.owner_id,type:"story",item_id:e.id,ref:this.appService.module},{signal:s.signal});e.is_liked=!t;try{await r}catch(i){(0,I.isAbortError)(i)||(e.is_liked=t,this.snackbar.show({text:this.langs.getLang("global_error")}))}finally{this.abortControllers.likes[i]===s&&delete this.abortControllers.likes[i]}this.statsService.saveStoryViewStats(t?O.StoriesViewerStatsEventType.clickToUnlike:O.StoriesViewerStatsEventType.clickToLike)},this.hideReplyStory=async e=>{if(!e)return;const{owner_id:t,id:i}=e;this.appService.props?.layerParams.listName?.includes("replies")&&(this.itemsListService.repliesDeleteStoriesOnClose[t]||(this.itemsListService.repliesDeleteStoriesOnClose[t]=[]),this.itemsListService.repliesDeleteStoriesOnClose[t].push(i));try{await this.storiesApi.hideReply({owner_id:t,story_id:i})}catch(e){this.errorsService.error(_.StoriesViewerTechErrors.FAIL_HIDE_REPLY,e),this.snackbar.show({type:"error",text:(0,P.mapStoryViewerErrorToLang)(_.StoriesViewerTechErrors.FAIL_HIDE_REPLY,this.langs)})}},this.hideAllUserReplies=async e=>{if(!e)return;const t=e.owner?.id||0;this.appService.props?.layerParams.listName?.includes("replies")&&(this.itemsListService.repliesDeleteStoriesOnClose[t]||(this.itemsListService.repliesDeleteStoriesOnClose[t]=[]),this.itemsListService.repliesDeleteStoriesOnClose[t].push(...e.stories.map((e=>e.id)))),this.statuses.hide[t]=w.StoriesViewerRequestStatus.LOADING;try{await this.storiesApi.hideAllReplies({owner_id:t}),this.statuses.hide[t]=w.StoriesViewerRequestStatus.SUCCESS}catch(e){this.errorsService.error(_.StoriesViewerTechErrors.FAIL_HIDE_ALL_REPLIES,e),this.statuses.hide[t]=w.StoriesViewerRequestStatus.ERROR}},this.addToBlacklistCurrentStory=async e=>{if(!e)return;const t=e.owner_id;try{await this.storiesApi.banOwner({owners_ids:String(t)}),this.eventsService.emitter.emit(b.StoriesViewerEventType.addToBlackList,{authorId:t})}catch(e){this.errorsService.error(_.StoriesViewerTechErrors.FAIL_BAN_OWNER,e)}},this.banOwner=async e=>{if(e){this.statuses.ban[e.owner_id]=w.StoriesViewerRequestStatus.LOADING;try{await this.accountApi.ban({owner_id:e.owner_id}),this.statuses.ban[e.owner_id]=w.StoriesViewerRequestStatus.SUCCESS}catch(t){this.errorsService.error(_.StoriesViewerTechErrors.FAIL_BAN_OWNER,t),this.statuses.ban[e.owner_id]=w.StoriesViewerRequestStatus.ERROR}}},this.markPacksSkipped=async(e,t)=>{if(t<=e)return;const i=this.itemsListService.storyPacks.slice(e,t+1),s=[],r=[],o=[];for(const[,e]of i.entries()){if(!e.stories?.length)continue;this.itemsListService.markSeenIds.add(e.id);const t=[];for(const i of e.stories)i.seen||(i.seen=1,t.push({owner_id:i.owner_id,story_id:i.id}));s.push(...t),r.push({blockId:e.id,storyRawIdSet:new Set(t.map((e=>(0,f.getIdentityRawId)({ownerId:e.owner_id,id:e.story_id})))),authorId:e.stories[0].owner_id}),o.push(e.stories[0].owner_id)}if(s.length){try{await this.storiesApi.markSkipped({stories:JSON.stringify(s)})}catch(e){this.errorsService.error(_.StoriesViewerTechErrors.FAIL_MARK_SKIPPED,e)}this.eventsService.emitter.emit(b.StoriesViewerEventType.markSeen,r),this.eventsService.emitter.emit(b.StoriesViewerEventType.markSeenAuthor,o)}},this.markStorySeen=async(e,t)=>{if(!e||!t)return;const{owner_id:i,id:s,seen:r,narrative_id:o,track_code:a}=t,{id:n,stories:c}=e;if(this.eventsService.emitter.emit(b.StoriesViewerEventType.markSeen,[{blockId:n,storyRawIdSet:new Set([(0,f.getIdentityRawId)({ownerId:i,id:s})]),authorId:i}]),t.id===c[c.length-1].id&&(this.eventsService.emitter.emit(b.StoriesViewerEventType.markSeenAuthor,[i]),this.itemsListService.markSeenIds.add(n)),!r){t.seen=1;try{await this.storiesApi.markSeen({owner_id:i,story_id:s,narrative_id:o,track_code:a,all:0})}catch(e){this.errorsService.error(_.StoriesViewerTechErrors.FAIL_MARK_SEEN,e)}this.sendAudienceResearchData(t)}},this.followRequest=async(e,t,i=!1)=>{if(!e||!t)return;const{owner:s,id:r}=e,{track_code:o}=t;if(s){this.itemsListService.changedCanFollowStoryPacks.add(r),(0,P.changeFollowOwner)(s,i);try{(0,E.isOwnerUser)(s)?i?(await this.friendsApi.add({user_id:s.id,source:"stories",track_code:o}),this.statsService.saveStoryViewStats(O.StoriesViewerStatsEventType.addToFriends)):await this.friendsApi.delete({user_id:s.id}):i?await this.groupsApi.join({group_id:s.id,source:"stories",track_code:o},this.userEnv.partConfigEnabled("frontend.api_groups_join_disable_grouping")?{grouping:!1}:{}):await this.groupsApi.leave({group_id:s.id})}catch(e){const t=i?_.StoriesViewerTechErrors.FAIL_FOLLOW:_.StoriesViewerTechErrors.FAIL_UNFOLLOW;this.errorsService.error(t,e),this.snackbar.show({type:"error",text:(0,P.mapStoryViewerErrorToLang)(t,this.langs)}),(0,P.changeFollowOwner)(s,!i)}}},this.notInterestedStory=async e=>{if(!e)return;const{track_code:t,owner_id:i,id:s}=e;try{await this.storiesApi.markNotInterested({track_code:t,owner_id:i,story_id:s}),this.snackbar.show({type:"ok",text:this.langs.getLang("stories_viewer_mark_not_interested_success")})}catch(e){this.errorsService.error(_.StoriesViewerTechErrors.FAIL_MARK_NOT_INTERESTED,e),this.snackbar.show({type:"error",text:(0,P.mapStoryViewerErrorToLang)(_.StoriesViewerTechErrors.FAIL_MARK_NOT_INTERESTED,this.langs)})}this.statsService.saveStoryViewStats(O.StoriesViewerStatsEventType.markNotInterested)},this.copyERID=async e=>{if(!e)return;const t=(0,T.decodeHTMLEntities)(e.ad_marker||"");t&&(await navigator.clipboard.writeText(t),this.snackbar.show({type:"ok",text:this.langs.getLang("stories_viewer_menu_copied_erid")})),this.statsService.saveStoryViewStats(O.StoriesViewerStatsEventType.copyErid)},this.copyLink=async e=>{if(!e)return;const t=e.id,i=e.owner_id,s=`${window.location.origin}/narrative${i}_${t}`;await navigator.clipboard.writeText(s),this.snackbar.show({type:"ok",text:this.langs.getLang("stories_viewer_menu_copied_url")})},this.toggleNarrativeBookmark=async e=>{if(e)if(e.is_favorite)try{e.is_favorite=!1,await this.faveApi.removeNarrative({owner_id:e.owner_id,narrative_id:e.id}),this.snackbar.show({type:"ok",text:this.langs.getLang("stories_viewer_menu_bookmark_deleted")})}catch(e){this.errorsService.error(_.StoriesViewerTechErrors.FAIL_BOOKMARK_NARRATIVE_DELETE,e)}else{try{e.is_favorite=!0,await this.faveApi.addNarrative({owner_id:e.owner_id,narrative_id:e.id}),this.snackbar.show({type:"ok",text:this.langs.getLang("stories_viewer_menu_bookmark_added"),interpolate:!0,bottomAction:{href:"/bookmarks?type=narrative&is_from_snackbar=1",label:this.langs.getLang("stories_viewer_menu_bookmark_added_link")}})}catch(e){this.errorsService.error(_.StoriesViewerTechErrors.FAIL_BOOKMARK_NARRATIVE_ADD,e)}this.narrativePublishAnalytics.send(C.NarrativeAnalyticEventType.addToBookmarks,e,C.NarrativeAnalyticNavScreen.storyViewer)}},this.deleteStory=async e=>{if(!e)return;const{owner_id:t,id:i}=e;try{await this.storiesApi.delete({owner_id:t,story_id:i}),this.eventsService.emitter.emit(b.StoriesViewerEventType.deleteStory,{storyId:i,ownerId:t})}catch(e){this.itemsListService.reload(),this.errorsService.error(_.StoriesViewerTechErrors.FAIL_DELETE_STORY,e)}},this.deleteStoryFromNarrative=async(e,t)=>{if(e&&t&&e.story_ids){e.story_ids=e.story_ids.filter((e=>e!==t.id));try{await this.narrativesApi.edit({owner_id:e.owner_id,story_ids:e.story_ids.join(","),narrative_id:e.id,title:e.title,...e.cover}),this.eventsService.emitter.emit(b.StoriesViewerEventType.deleteStoryFromNarrative,{storyId:t.id,ownerId:t.owner_id,narrativeId:e.id})}catch(e){this.itemsListService.reload(),this.errorsService.error(_.StoriesViewerTechErrors.FAIL_DELETE_STORY_FROM_NARRATIVE,e)}}},this.deleteNarrative=async e=>{if(e)try{await this.narrativesApi.delete({narrative_id:e.id,owner_id:e.owner_id}),this.eventsService.emitter.emit(b.StoriesViewerEventType.deleteNarrative,{narrativeId:e.id,ownerId:e.owner_id})}catch(e){this.itemsListService.reload(),this.errorsService.error(_.StoriesViewerTechErrors.FAIL_DELETE_NARRATIVE,e)}},this.getFeedbackData=async(e,t=!1)=>{if(!e||this.itemsListService.feedbackData[e.id]&&!t||this.statuses.feedback[e.id]===w.StoriesViewerRequestStatus.LOADING)return;const{owner_id:i,id:s,clickable_stickers:r}=e,o=r?.clickable_stickers?.find((e=>"poll"===e?.type));this.statuses.feedback[e.id]=w.StoriesViewerRequestStatus.LOADING;try{const t=this.storiesListSharedProvider.replies.ensure({owner_id:i,story_id:s,extended:1}),r=await Promise.all([this.storiesApi.getViewers({owner_id:i,story_id:s,extended:1,with_anons:1,count:100,fields:["photo_100","screen_name","domain"].join(",")}),t.fetch(),o?.poll?.id?this.pollsApi.getById({owner_id:i,poll_id:o.poll.id}):null,this.storiesApi.getQuestions({owner_id:i,story_id:s,with_anons:1,extended:1,count:100,fields:["first_name_gen","last_name_gen","first_name_dat","last_name_dat","photo_100","screen_name"].join(",")}),this.storiesApi.getDetailedStats({owner_id:i,story_id:s})]);this.itemsListService.feedbackData[e.id]={viewers:r[0],replies:t.data,polls:r[2],questions:r[3],stats:r[4]},this.statuses.feedback[e.id]=w.StoriesViewerRequestStatus.SUCCESS}catch(t){this.statuses.feedback[e.id]=w.StoriesViewerRequestStatus.ERROR,this.errorsService.error(_.StoriesViewerTechErrors.FAIL_FETCH_FEEDBACK,t)}},this.markSeenFeedback=async e=>{try{await this.storiesApi.seenReplies({owner_id:e.owner_id,story_id:e.id})}catch(e){this.errorsService.error(_.StoriesViewerTechErrors.FAIL_SEEN_FEEDBACK,e)}},this.addAudioTrackToMyMusic=async e=>{if(e)try{await e.like.toggle(!0),this.appService.isMvk&&this.snackbar.show({type:"ok",text:this.langs.getLang("stories_audio_added")})}catch(e){this.errorsService.error(_.StoriesViewerTechErrors.FAIL_AUDIO_TRACK_ADD_TO_MY_MUSIC,e),this.snackbar.show({type:"error",text:(0,P.mapStoryViewerErrorToLang)(_.StoriesViewerTechErrors.FAIL_AUDIO_TRACK_ADD_TO_MY_MUSIC,this.langs)})}},this.deleteAudioTrackFromMyMusic=async e=>{if(!e)return;const t=this.appService.isMvk;try{await e.like.toggle(!1),t&&this.snackbar.show({type:"ok",text:this.langs.getLang("stories_audio_deleted")})}catch(e){this.errorsService.error(_.StoriesViewerTechErrors.FAIL_AUDIO_TRACK_DELETE_FROM_MY_MUSIC,e),t&&this.snackbar.show({type:"error",text:(0,P.mapStoryViewerErrorToLang)(_.StoriesViewerTechErrors.FAIL_AUDIO_TRACK_DELETE_FROM_MY_MUSIC,this.langs)})}},this.followPlaylist=e=>{if(e)try{e.actions.toggleFollowing?.onExecute?.(),this.snackbar.show({type:"ok",text:this.langs.getLang("stories_follow_playlist_done")})}catch(e){this.errorsService.error(_.StoriesViewerTechErrors.FAIL_PLAYLIST_FOLLOW,e),this.snackbar.show({type:"error",text:(0,P.mapStoryViewerErrorToLang)(_.StoriesViewerTechErrors.FAIL_PLAYLIST_FOLLOW,this.langs)})}},this.unfollowPlaylist=e=>{if(e)try{e.actions.toggleFollowing?.onExecute?.(),this.snackbar.show({type:"ok",text:this.langs.getLang("stories_unfollow_playlist_done")})}catch(e){this.errorsService.error(_.StoriesViewerTechErrors.FAIL_PLAYLIST_UNFOLLOW,e),this.snackbar.show({type:"error",text:(0,P.mapStoryViewerErrorToLang)(_.StoriesViewerTechErrors.FAIL_PLAYLIST_UNFOLLOW,this.langs)})}},this.setDiscoverVisibility=async(e=!1)=>{try{this.statuses.setDiscoverVisibilityStatus=w.StoriesViewerRequestStatus.LOADING,await this.storiesApi.setDiscoverVisible({is_discover_visible:e?1:0}),this.statuses.setDiscoverVisibilityStatus=w.StoriesViewerRequestStatus.SUCCESS,this.snackbar.show({type:"ok",text:this.langs.getLang("stories_discover_hidden_text")})}catch(e){this.statuses.setDiscoverVisibilityStatus=w.StoriesViewerRequestStatus.ERROR,this.errorsService.error(_.StoriesViewerTechErrors.FAIL_SET_DISCOVER_VISIBILITY,e),this.snackbar.show({type:"error",text:(0,P.mapStoryViewerErrorToLang)(_.StoriesViewerTechErrors.FAIL_SET_DISCOVER_VISIBILITY,this.langs)})}},this.loadMoreViewers=async e=>{if(!e)return;const t=this.itemsListService.feedbackData[e.id].viewers;if(t&&t.next_from&&this.statuses.viewers[e.id]!==w.StoriesViewerRequestStatus.LOADING&&this.statuses.viewers[e.id]!==w.StoriesViewerRequestStatus.ERROR){this.statuses.viewers[e.id]=w.StoriesViewerRequestStatus.LOADING;try{const i=await this.storiesApi.getViewers({owner_id:e.owner_id,story_id:e.id,extended:1,count:100,start_from:t.next_from,fields:["photo_100","photo_50"].join(",")});this.statuses.viewers[e.id]=w.StoriesViewerRequestStatus.SUCCESS,t.next_from=i.next_from,t.items.push(...i.items)}catch(t){this.statuses.viewers[e.id]=w.StoriesViewerRequestStatus.ERROR,this.errorsService.error(_.StoriesViewerTechErrors.FAIL_FETCH_FEEDBACK_VIEWERS,t)}}},this.deleteQuestion=async(e,t)=>{if(!e||!t)return;const{id:i}=e,{id:s,owner_id:r}=t,o=this.itemsListService.feedbackData[s]?.questions,a=o?.items.findIndex((e=>e.id===i));o&&void 0!==a&&a>=0&&(o.count--,o.items.splice(a,1));try{await this.storiesApi.deleteQuestion({story_id:s,owner_id:r,question_id:i}),this.snackbar.show({text:this.langs.getLang("stories_viewer_feedback_question_delete_ok")})}catch(t){o&&void 0!==a&&a>=0&&(o.count++,o.items.splice(a,0,e)),this.errorsService.error(_.StoriesViewerTechErrors.FAIL_DELETE_QUESTION,t),this.snackbar.show({type:"error",text:(0,P.mapStoryViewerErrorToLang)(_.StoriesViewerTechErrors.FAIL_DELETE_QUESTION,this.langs)})}this.statsService.saveStoryViewStats(O.StoriesViewerStatsEventType.questionDelete,{questionId:i})},this.banOrUnbanQuestionAuthor=async(e,t)=>{if(!e||!t)return;const{id:i}=e,{id:s,owner_id:r}=t,o=()=>{const t=this.itemsListService.feedbackData[s].questions;if(t&&0!==t.items.length)for(let i of t.items)i.owner_id===e.owner_id&&(i.is_owner_blocked=!i.is_owner_blocked)};o();try{e.is_owner_blocked?(await this.storiesApi.banQuestionAuthor({story_id:s,owner_id:r,question_id:i}),this.snackbar.show({type:"ok",text:this.langs.getLang("stories_viewer_feedback_question_block_author_ok")})):(await this.storiesApi.unbanQuestionAuthor({story_id:s,owner_id:r,question_id:i}),this.snackbar.show({type:"ok",text:this.langs.getLang("stories_viewer_feedback_question_unblock_author_ok")}))}catch(t){const i=e.is_owner_blocked?_.StoriesViewerTechErrors.FAIL_BAN_QUESTION_AUTHOR:_.StoriesViewerTechErrors.FAIL_UNBAN_QUESTION_AUTHOR;this.errorsService.error(i,t),this.snackbar.show({type:"error",text:(0,P.mapStoryViewerErrorToLang)(i,this.langs)}),o()}this.statsService.saveStoryViewStats(e.is_anonymous?O.StoriesViewerStatsEventType.questionBanAnonymousAuthor:O.StoriesViewerStatsEventType.questionBanAuthor,{questionId:e.id})},this.sendQuestionMessage=async(e,t,i)=>{if(!t||!i)return;const{question:s,owner_id:r}=t,{id:o,owner_id:a}=i,n=`${e}\n\n🗣 ${(0,V.unclean)(s)}`,c=`story${(0,f.getIdentityRawId)({id:o,ownerId:a})}`;try{await this.messagesApi.send({user_id:r,...A.Ranges.isGroupId(a)&&{group_id:A.Ranges.convertOwnerIdToGroupId(a)},attachment:c,entrypoint:"stories_comment",random_id:Math.round(2147483647*Math.random()),message:n}),this.snackbar.show({type:"ok",text:this.langs.getLang("stories_viewer_feedback_question_send_message_ok")})}catch(e){this.errorsService.error(_.StoriesViewerTechErrors.FAIL_QUESTION_SEND_MESSAGE,e),this.snackbar.show({type:"error",text:this.langs.getLang("stories_viewer_feedback_question_send_message_error")})}},this.askQuestion=async({askMessage:e,withMention:t,isAnonymous:i,story:s,name:r})=>{if(!s)return;const{id:o,owner_id:a}=s;try{await this.storiesApi.askQuestion({owner_id:a,story_id:o,question:e,with_mention:t?1:0,is_anonymous:i?1:0}),this.snackbar.show({type:"ok",text:this.langs.langReplace(this.langs.getLang("stories_viewer_question_ask_ok"),{name:r||""})})}catch(e){this.errorsService.error(_.StoriesViewerTechErrors.FAIL_QUESTION_SEND_MESSAGE,e),this.snackbar.show({type:"error",text:this.langs.getLang("stories_viewer_question_ask_error")})}},(0,o.makeAutoObservable)(this)}}M=(0,s.__decorate)([r.scope.container(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===a.StoriesApi?Object:a.StoriesApi,void 0===n.PollsApi?Object:n.PollsApi,void 0===c.LikesApi?Object:c.LikesApi,void 0===d.FriendsApi?Object:d.FriendsApi,void 0===h.GroupsApi?Object:h.GroupsApi,void 0===l.AccountApi?Object:l.AccountApi,void 0===u.FaveApi?Object:u.FaveApi,void 0===S.NarrativesApi?Object:S.NarrativesApi,void 0===v.MessagesApi?Object:v.MessagesApi,void 0===m.StoriesViewerItemsListService?Object:m.StoriesViewerItemsListService,void 0===b.StoriesViewerEventsService?Object:b.StoriesViewerEventsService,void 0===m.StoriesViewerErrorsService?Object:m.StoriesViewerErrorsService,void 0===m.StoriesViewerAppService?Object:m.StoriesViewerAppService,void 0===p.Snackbar?Object:p.Snackbar,void 0===y.Langs?Object:y.Langs,void 0===g.UserEnv?Object:g.UserEnv,void 0===m.StoriesListSharedProvider?Object:m.StoriesListSharedProvider,void 0===L.AudienceResearchService?Object:L.AudienceResearchService,void 0===O.StoriesViewerStatsService?Object:O.StoriesViewerStatsService,void 0===C.NarrativePublishAnalytics?Object:C.NarrativePublishAnalytics])],M)},529160:(e,t,i)=>{i.d(t,{StoriesViewerAppService:()=>h});var s=i(331635),r=i(132028),o=i(652469),a=i(327813),n=i(951652),c=i(536490);const d=(0,i(178018).getSharedStoriesViewerOpenParams)();class h{init(e){this.props=e.props,e.platform&&(this.platform=e.platform),e.module&&(this.module=e.module)}update(e){this.props=e.props}get isWeb(){return this.platform===o.StoriesViewerPlatform.WEB}get isMvk(){return this.platform===o.StoriesViewerPlatform.MVK}get viewerId(){return this.authService.userId||0}get ownerId(){return Number(this.props?.layerParams?.ownerId)}get listName(){return this.props?.layerParams.listName||o.StoryListName.feed}constructor(e){this.authService=e,this.props=null,this.platform=o.StoriesViewerPlatform.WEB,this.module="",this.openParamsState=d.state,this.getIsStoryOrNarrativeOwner=(e,t)=>!!(t&&e&&e.owner)&&(e.narrative?(0,c.canViewerEditNarrative)(e.narrative,e.owner,this.viewerId):(0,c.canViewerManageStory)(e.owner,t,this.viewerId)),(0,a.makeAutoObservable)(this,{openParamsState:a.observable.ref})}}h=(0,s.__decorate)([r.scope.container(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===n.AuthService?Object:n.AuthService])],h)},740777:(e,t,i)=>{i.d(t,{StoriesViewerInitService:()=>w});var s=i(331635),r=i(132028),o=i(652469),a=i(909209),n=i(588210),c=i(327813),d=i(796828),h=i(692482),l=i(712600),u=i(809424),S=i(786686),v=i(662285),p=i(792138),y=i(873900),g=i(511356),m=i(304487),_=i(178018);class w{getSourceMvk(){const e=(0,_.getSharedStoriesViewerOpenParams)()?.state?.source;if(e)return e;const t=this.currentConfig?.props?.layerParams.listName??"";return t.includes("feed")?"feed":t.includes("replies")?"reply":""}getSourceWeb(){const e=this.metadata.get();return[o.Modules.USER_INFO_MODULE,o.Modules.GROUP_INFO_MODULE,o.Modules.SPAMFEED_MODULE,o.Modules.ABUSE_MODULE,o.Modules.ADMIN_STORY_VIEW_MODULE].includes(e.module)?e.module:(0,_.getSharedStoriesViewerOpenParams)()?.state?.source??"list"}async init(e){this.storyService.init({preloadNeighbourStoryPacks:e.preloadNeighbourStoryPacks,elementsCountEachSide:e.elementsCountEachSide}),this.stats.init(this.getStatsData),this.appService.init(e),(0,d.isEqualParams)(this.currentConfig?.props?.layerParams,e?.props?.layerParams)||(this.currentConfig=e,this.navigationService.init(),await Promise.all([this.itemsListService.init({getSearchQuery:e.getSearchQuery,dispatchDiscoverLoadedEvent:e.dispatchDiscoverLoadedEvent}),this.preloadService.init({makeLive:e?.makeLive})]),this.checkExistStoryAndStart(),this.stats.saveStoryViewStats(n.StoriesViewerStatsEventType.openViewer))}async update(e){this.appService.update(e),(0,d.isEqualParams)(this.currentConfig?.props?.layerParams,e?.props?.layerParams)||(this.currentConfig=e,await this.itemsListService.update(),this.checkExistStoryAndStart())}destroy(){this.storyService.destroy(),this.itemsListService.destroy(),this.stats.destroy()}isEqualConfigs(e,t){return(0,d.isEqualParams)(this.extractElementSelector(e),this.extractElementSelector(t))}extractElementSelector(e){if(!e)return e;const{getParentElementSelector:t,...i}=e.props;return{...e,props:i}}constructor(e,t,i,s,r,a,n,d,h,l,u,_){this.itemsListService=e,this.preloadService=t,this.storyService=i,this.navigationService=s,this.appService=r,this.actionsService=a,this.messageService=n,this.dialogsService=d,this.modalsService=h,this.stats=l,this.langs=u,this.metadata=_,this.currentConfig=void 0,this.getStatsData=e=>{const t=this.itemsListService.needToStory,i=this.itemsListService.needToPack,s=this.itemsListService.needToStoryIndex,r=t?.id,a=t?.owner_id;if(!(t&&r&&a&&i))return;const n=this.metadata.get(),c=s,d=i.stories.length-s,h={event_type:e,story_owner_id:a,story_id:r,time:window.vk.ts+Math.floor(((new Date).getTime()-window.vk.started)/1e3),volume:100*this.storyService.volume,view_entry_point:this.currentConfig?.platform===o.StoriesViewerPlatform.MVK?this.getSourceMvk():this.getSourceWeb(),stories_author_before:c,stories_author_after:d,nav_screen:n.module,view_event_timeline_position:this.storyService.progressService.currentStoryProgress,story_type:t.type,track_code:t.track_code,...(0,p.storyViewClickableToStoryStat)(t)};"discover"===i?.listName&&i?.listIndex&&Object.assign(h,{story_index:i?.listIndex});const l=i?.narrative;return l&&Object.assign(h,{narrative_id:l.id,narrative_owner_id:l.owner_id}),h},this.showConfirmBanOwner=async()=>{this.modalsService.openedExternalModal();await this.dialogsService.fastMessage({title:this.langs.getLang("stories_viewer_ban_modal_header"),text:this.langs.langReplace(this.langs.getLang("stories_viewer_ban_modal_text"),{name:(0,S.getOwnerName)(this.itemsListService.currentPack?.owner,!1,"gen")}),yesButtonLabel:this.langs.getLang("global_continue"),noButtonLabel:this.langs.getLang("global_cancel"),forceColorScheme:"dark"})&&this.actionsService.banOwner(this.itemsListService.currentStory),this.modalsService.closedExternalModal()},this.showConfirmHideUserReplies=async()=>{this.modalsService.openedExternalModal();await this.dialogsService.fastMessage({title:this.langs.getLang("stories_viewer_hide_all_replies_modal_header"),text:this.langs.langReplace(this.langs.getLang("stories_viewer_hide_all_replies_modal_text"),{name:(0,S.getOwnerName)(this.itemsListService.currentPack?.owner,!1,"gen")}),yesButtonLabel:this.langs.getLang("global_continue"),noButtonLabel:this.langs.getLang("global_cancel"),forceColorScheme:"dark"})&&this.actionsService.hideAllUserReplies(this.itemsListService.currentPack),this.modalsService.closedExternalModal()},this.onAskQuestion=async(e,t)=>{const i=this.itemsListService.currentStory,s=this.itemsListService.currentPack;this.modalsService.closeModal();const r=(0,S.getOwnerName)(s?.owner,!1,"ins");await this.actionsService.askQuestion({askMessage:e.trim(),withMention:t===o.StoriesViewerQuestionAnswerPrivate.PUBLIC,isAnonymous:t===o.StoriesViewerQuestionAnswerPrivate.ANONYMOUS,story:i,name:r}),this.appService.getIsStoryOrNarrativeOwner(s,i)&&this.actionsService.getFeedbackData(i,!0)},this.checkExistStoryAndStart=()=>{this.messageService.reset();try{if(-1===this.itemsListService.needToPackIndex){const e=(0,y.getIdentityRawId)({ownerId:Number(this.appService.props?.layerParams.ownerId),id:Number(this.appService.props?.layerParams.storyId)});if(0===this.itemsListService.storyPacks.length&&this.appService.props?.layerParams.listName!==e)this.navigationService.openStory({ownerId:String(this.appService.props?.layerParams.ownerId),storyId:String(this.appService.props?.layerParams.storyId),narrativeId:this.appService.props?.layerParams.narrativeId,listName:e});else{const e=this.itemsListService.storyPacks.find((e=>e.listName===this.appService.props?.layerParams?.listName))||this.itemsListService.storyPacks[0],t=e.stories[0];this.navigationService.openStory({ownerId:String(t?.owner_id),storyId:String(t?.id),narrativeId:e.narrative?String(e.narrative?.id):void 0,listName:e?.listName})}}else if(-1===this.itemsListService.needToStoryIndex){const e=this.itemsListService.currentPack,t=e?.stories[0];this.navigationService.openStory({ownerId:String(t?.owner_id),storyId:String(t?.id),narrativeId:e?.narrative?String(e.narrative?.id):void 0,listName:e?.listName})}else this.navigationService.runOrDeferUntilNavigateTransitionEnds((()=>{this.storyService.reset(),this.itemsListService.changeActiveStory(this.itemsListService.needToPackIndex),this.storyService.start(),(0,g.trackStoryOpened)({nonce:this.appService.openParamsState.nonce||"",storyDetails:(0,m.getStoryPerfData)(this.itemsListService.currentStory)})}))}catch(e){this.storyService.setError(v.StoriesViewerTechErrors.FAIL_STORY_VIEWER_DATA_PARSE,e)}},(0,c.makeAutoObservable)(this)}}w=(0,s.__decorate)([r.scope.container(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===a.StoriesViewerItemsListService?Object:a.StoriesViewerItemsListService,void 0===a.StoriesViewerPreloadService?Object:a.StoriesViewerPreloadService,void 0===a.StoriesViewerStoryService?Object:a.StoriesViewerStoryService,void 0===a.StoriesViewerNavigationService?Object:a.StoriesViewerNavigationService,void 0===a.StoriesViewerAppService?Object:a.StoriesViewerAppService,void 0===a.StoriesViewerActionsService?Object:a.StoriesViewerActionsService,void 0===a.StoriesViewerMessageService?Object:a.StoriesViewerMessageService,void 0===h.CommonDialogsService?Object:h.CommonDialogsService,void 0===a.StoriesViewerModalsService?Object:a.StoriesViewerModalsService,void 0===n.StoriesViewerStatsService?Object:n.StoriesViewerStatsService,void 0===l.Langs?Object:l.Langs,void 0===u.MetaData?Object:u.MetaData])],w)},913117:(e,t,i)=>{i.d(t,{StoriesViewerItemsListService:()=>g});var s=i(331635),r=i(327813),o=i(182807),a=i(909209),n=i(652469),c=i(391948),d=i(132028),h=i(873900),l=i(536490),u=i(951652),S=i(26530),v=i(311763),p=i(169019),y=i(489633);class g{get events(){return this.emitter.listenable}async init({getSearchQuery:e,dispatchDiscoverLoadedEvent:t}){this.getSearchQuery=e,this.dispatchDiscoverLoadedEvent=t,this.initAdditionalList(),await this.update(),this.additionalList&&this.checkAndLoadAdditionalListData(),this.updateCurrentIndexes(),this.checkReloadingStories()}async update(){await this.fetchListData(),this.needToPackIndex>this.currentPackIndex&&this.checkAndLoadAdditionalListData()}async reload(){await this.fetchListData(!0),this.updateCurrentIndexes()}async fetchListData(e){await this.dataService.ensureListData(this.listParams,e)}get isFailed(){return this.dataService.getIsListHasFailed(this.baseListParams)}get isLoading(){return this.dataService.getIsListLoading(this.baseListParams)&&0===this.storyPacks.length}get additionalListIsLoading(){return!!this.additionalList?.listName&&this.dataService.getIsListLoading({listName:this.additionalList.listName})}failListData(){return this.dataService.failListData(this.listParams)}filterBySeen(e=[]){return"all"===this.seenFilter?e:e.filter((e=>"seen"===this.seenFilter?!e.has_unseen:"unseen"===this.seenFilter?e.id&&this.markSeenIds.has(e.id)||e.has_unseen:void 0))}get storyPacks(){const{single:e,multiple:t,narratives:i}=this.dataService.getListData(this.baseListParams);let s=[];if(e&&e.items&&e.items.length>0){const t=e.items?.[0]?.owner_id??0;s=[{id:String(t),stories:e.items??[],type:"stories",owner:(0,l.findOwnerById)(t,e.profiles,e.groups),profiles:e.profiles??[],groups:e.groups??[]}]}else t?s=this.filterBySeen(t.items).filter((e=>e?.type!==n.StoryListName.discover)).map(((e,i)=>{const s=e.stories?.[0]?.owner_id??0;return{id:String(e.id??i),stories:e.stories??[],type:"stories",listName:this.additionalList?.baseListName,owner:(0,l.findOwnerById)(s,t.profiles,t.groups),profiles:t.profiles??[],groups:t.groups??[]}})):i&&(s=i.items.map((e=>({id:String(e.id),stories:e.stories??[],type:"narratives",owner:(0,l.findOwnerById)(e.owner_id,i.profiles,i.groups),profiles:i.profiles??[],groups:i.groups??[],narrative:e}))));if(!this.additionalList?.listName)return s;let r=[];const o=this.dataService.getListData({listName:this.additionalList.listName});return o.multiple&&(r=o.multiple.items.map(((e,t)=>{const i=e.stories?.[0]?.owner_id??0;return{id:String(e.id??t),listName:this.additionalList?.listName,listIndex:t,stories:e.stories??[],type:"stories",owner:(0,l.findOwnerById)(i,o.multiple?.profiles,o.multiple?.groups),profiles:o.multiple?.profiles??[],groups:o.multiple?.groups??[],isAdditionalListPlaceholderShown:!this.additionalList?.isPlaceholderHidden&&0===t}}))),r.length?(0,l.mergeUnique)(s,r,"id","first"):s}get storyPacksWithLoader(){const e=this.storyPacks;if(!this.additionalList?.baseListName||!this.additionalListIsLoading)return e;const{multiple:t}=this.dataService.getListData({listName:this.additionalList.baseListName}),i=t?.items.find((e=>e?.type===n.StoryListName.discover)),s={type:"loading",id:String(e.length),preview:(0,l.calcPreviewSize)(i?.preview?.sizes,n.StoryPreviewMinSizes.MEDIUM),stories:[],profiles:[],groups:[]};return[...e,s]}get needToPackIndex(){return this.appService.props?.layerParams?this.findPackIndex(this.appService.props.layerParams):-1}findPackIndex({narrativeId:e,ownerId:t,storyId:i}){const s=this.storyPacks;return s?s.findIndex((({stories:s,id:r})=>{const o=!e||e===r,a=String(s?.[0]?.owner_id)===t,n=!i||s?.some((e=>String(e.id)===i));return o&&a&&n})):-1}get needToPack(){return this.storyPacks[this.needToPackIndex]}get needToStoryIndex(){const e=this.storyPacks[this.needToPackIndex];return e?!this.appService.props?.layerParams.listName&&!this.appService.props?.layerParams.storyId&&e.stories.length>0?0:e.stories.findIndex((e=>String(e.id)===this.appService.props?.layerParams.storyId)):-1}get needToStory(){return this.needToPack?.stories[this.needToStoryIndex]}changeActiveStory(e){this.updateCurrentIndexes(e),this.eventsService.emitter.emit(v.StoriesViewerEventType.activeStoryChanged)}getPackStoryMedia(e,t){if(!e||!t)return;const i=(0,h.getIdentityRawId)({ownerId:e.id,id:t.id});return this.packStoryMedia[i]}setPackStoryMedia(e,t,i){if(!e||!t)return;const s=(0,h.getIdentityRawId)({ownerId:e.id,id:t.id});i?this.packStoryMedia[s]=i:delete this.packStoryMedia[s]}get nextStory(){let e,t;return this.currentPack&&this.currentStoryIndex<this.currentPack.stories.length-1?(t=this.currentPack,e=this.currentPack?.stories[this.currentStoryIndex+1]):this.currentPackIndex<this.storyPacks.length-1&&(t=this.storyPacks[this.currentPackIndex+1],e=this.getLastSeenStory(this.storyPacks[this.currentPackIndex+1])),{pack:t,story:e}}get nextPackStory(){const e=this.currentPackIndex+1;if(e<this.storyPacks.length)return this.getLastSeenStory(this.storyPacks[e])}get prevPackStory(){const e=this.currentPackIndex-1;if(e<this.storyPacks.length&&e>-1)return this.getLastSeenStory(this.storyPacks[e])}getStoryFromPackWithShift(e){const t=this.currentPackIndex+e;if(t<this.storyPacks.length&&t>-1)return this.getLastSeenStory(this.storyPacks[t])}get prevStory(){let e,t;return this.currentStoryIndex>0?(t=this.currentPack,e=this.currentPack?.stories[this.currentStoryIndex-1]):this.currentPackIndex>0&&(t=this.storyPacks[this.currentPackIndex-1],e=this.getLastSeenStory(this.storyPacks[this.currentPackIndex-1])),{pack:t,story:e}}isActivePack(e){return this.currentPack?.id===e?.id}getActivePackStory(e){return this.isActivePack(e)?this.currentStory:this.getLastSeenStory(e)}getStoryPackByStory(e){if(e)return this.storyPacks.find((t=>t.stories.some((t=>t.id===e.id))))}getActiveStoryIndex(e){const t=this.getActivePackStory(e);return t&&e.stories?e.stories.indexOf(t):-1}getIsOwnStory(e){return e.owner_id===this.authService.userId}getLayerData(e){return this.dataService.getListData(this.calculateListParams(e))}calculateListParams({listName:e,storyId:t,ownerId:i,narrativeId:s}){const r=(0,p.parseExtra)(e),o=s?`narrative${(0,h.getIdentityRawId)({ownerId:Number(i),id:Number(s)})}`:(0,h.getIdentityRawId)({ownerId:Number(i),id:Number(t??0)});return{listName:r||!e?o:e,query:this.getSearchQuery?.(),...r}}get listParams(){const e=this.appService.props?.layerParams;return e?this.calculateListParams(e):{}}get baseListParams(){const e=this.listParams;return this.additionalList?.baseListName&&(e.listName=this.additionalList.baseListName),e}get isCurrentPackCanFollow(){return(0,l.canViewerFollowOwner)(this.currentPack?.owner,this.authService.userId)}get isCurrentPackCanFollowWithChanged(){return this.isCurrentPackCanFollow||this.currentPack&&this.changedCanFollowStoryPacks.has(this.currentPack.id)}checkAndLoadAdditionalListData(){if(!this.additionalList||this.additionalList.isAllDataLoaded||this.additionalListIsLoading)return;this.storyPacks.length-1-this.needToPackIndex<y.ADDITIONAL_LIST_PRELOAD_DIFF_PACKS_NUM&&this.loadAdditionalData(this.additionalList)}async loadAdditionalData(e){e.listName===n.StoryListName.discover&&(await this.dataService.fetchDiscoverDataWithPagination({...e.startFrom&&{start_from:e.startFrom},...e.trackCode&&{track_code:e.trackCode}}),this.dispatchDiscoverLoadedEvent?.());const t=this.dataService.getListData({listName:e.listName});t?.multiple&&(e.startFrom=t.multiple.next_from,e.isAllDataLoaded=!t.multiple.next_from)}updateCurrentIndexes(e=this.needToPackIndex,t=this.needToStoryIndex){const i=this.currentPackIndex!==e,s=this.currentStoryIndex!==t;i&&(this.currentPackIndex=e,this.currentPack=this.storyPacks[this.currentPackIndex],this.emitter.emit("currentPack",this.currentPack)),(i||s)&&(this.currentStoryIndex=t,this.currentStory=this.currentPack?.stories[this.currentStoryIndex],this.emitter.emit("currentStory",this.currentStory))}constructor(e,t,i,s,a){this.dataService=e,this.appService=t,this.authService=i,this.eventsService=s,this.emitterFactory=a,this.getSearchQuery=void 0,this.emitter=this.emitterFactory.create(),this.dispatchDiscoverLoadedEvent=void 0,this.changedCanFollowStoryPacks=new Set,this.feedbackData={},this.lastAuthorSeenStory={},this.packStoryMedia={},this.previewThumbHash=new o.default({maxSize:3}),this.seenFilter="all",this.markSeenIds=new Set,this.repliesDeleteStoriesOnClose={},this.currentPackIndex=-1,this.currentStoryIndex=-1,this.animatingSecondaryToActivePackIndex=-1,this.additionalList=void 0,this.currentPack=void 0,this.currentStory=void 0,this.initAdditionalList=()=>{const e=this.appService.props?.layerParams;if(!e)return;const t=e.listName===n.StoryListName.discover;if(e.listName!==n.StoryListName.feed&&!t)return;const i=this.getLayerData(t?{...e,listName:n.StoryListName.feed}:e);if(!i?.multiple?.items?.length)return;const s=i.multiple.items.find((e=>e?.type===n.StoryListName.discover)),r=t?s:i.multiple.items.find((t=>t?.stories?.some((t=>String(t?.id)===e.storyId))));r&&(this.seenFilter=r.has_unseen?"unseen":"all");if(t||s&&(!r?.has_unseen||s?.has_unseen)){const e=this.dataService.getListData({listName:n.StoryListName.discover});this.additionalList={listName:n.StoryListName.discover,baseListName:n.StoryListName.feed,trackCode:s?.track_code,startFrom:e?.multiple?e.multiple.next_from:void 0,isAllDataLoaded:!!e?.multiple&&!e.multiple.next_from}}},this.getLastSeenStory=e=>{if(!e)return;if("number"==typeof this.lastAuthorSeenStory[e.id]){const t=this.lastAuthorSeenStory[e.id];if(e.stories[t])return e.stories[t];delete this.lastAuthorSeenStory[e.id]}const t=(0,c.getFirstStoryForRenderingFromStoriesList)(e.stories);return t&&(this.lastAuthorSeenStory[e.id]=e.stories.findIndex((e=>e.id===t.id))),t},this.saveCurrentAsLastStory=()=>{this.currentPack&&(this.lastAuthorSeenStory[this.currentPack.id]=this.currentStoryIndex)},this.deleteCurrentStory=()=>{this.currentPack&&this.currentPack.stories.splice(this.currentStoryIndex,1)},this.deletePack=e=>{if(!e)return;const{single:t,multiple:i,narratives:s}=this.dataService.getListData(this.listParams);if(t)Object.keys(t).forEach((e=>{delete t[e]}));else if(i){const t=i.items.findIndex((t=>t?.id===e));i.items.splice(t,1)}else if(s){const t=s.items.findIndex((t=>String(t?.id)===e));s.items.splice(t,1)}},this.isStoryInReplies=e=>{if(!e)return!1;const t=this.repliesDeleteStoriesOnClose[e.owner_id];return!!t&&t.includes(e.id)},this.destroy=()=>{const{multiple:e}=this.dataService.getListData(this.listParams);if(Object.values(this.repliesDeleteStoriesOnClose).length&&e)for(let[t,i]of Object.entries(this.repliesDeleteStoriesOnClose)){const s=this.storyPacks.findIndex((e=>e.owner?.id===Number(t))),r=this.storyPacks[s];if(r){const t=r.stories.length;r.stories=r.stories.filter((e=>!i.includes(e.id))),e.count=e.count-t+r.stories.length,0===r.stories.length&&this.deletePack(r.id)}}this.appService.isMvk&&this.syncSeenPacks(),this.previewThumbHash.clear()},this.syncSeenPacks=()=>{const{multiple:e}=this.dataService.getListData(this.listParams);if(e?.items)for(let t of e.items)t?.id&&this.markSeenIds.has(t.id)&&(t.has_unseen=!1)},this.hideAdditionalListPlaceholder=()=>{this.additionalList&&(this.additionalList.isPlaceholderHidden=!0)},this.checkReloadingStories=()=>{this.dataService.getIsListLoading(this.baseListParams)&&this.reload()},(0,r.makeAutoObservable)(this,{previewThumbHash:r.observable.ref})}}g=(0,s.__decorate)([d.scope.container(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===a.StoriesViewerDataService?Object:a.StoriesViewerDataService,void 0===a.StoriesViewerAppService?Object:a.StoriesViewerAppService,void 0===u.AuthService?Object:u.AuthService,void 0===v.StoriesViewerEventsService?Object:v.StoriesViewerEventsService,void 0===S.EmitterFactory?Object:S.EmitterFactory])],g)},587900:(e,t,i)=>{i.d(t,{StoriesViewerMessageService:()=>v});var s=i(331635),r=i(327813),o=i(132028),a=i(740177),n=i(882044),c=i(670252),d=i(712600),h=i(909209),l=i(662285),u=i(536490),S=i(588210);class v{isMessageEmpty(){return!this.messageText.trim()}constructor(e,t,i,s,o,a,n,c,d){this.storyService=e,this.messagesApi=t,this.videoApi=i,this.errorService=s,this.listService=o,this.snackbar=a,this.langs=n,this.stats=c,this.appService=d,this.isMessageFocused=!1,this.messageText="",this.isMessageSending=!1,this.hidden=!0,this.getIsMessageFieldHidden=e=>{if(this.storyService.getStoryLink(e))return this.hidden},this.onMessageFocus=()=>{this.stats.saveStoryViewStats(S.StoriesViewerStatsEventType.commentTap),this.isMessageFocused=!0,this.storyService.forbiddenStatuses.message=!0,this.storyService.pause()},this.onMessageBlur=e=>{if(!this.isMessageFocused)return;this.isMessageFocused=!1,this.hidden=!0;(!e||this.isMessageEmpty())&&(this.storyService.forbiddenStatuses.message=!1,this.storyService.play())},this.showMessageField=()=>{this.hidden=!1},this.onMessageTextChanged=e=>{this.changeText(e.target.innerText)},this.changeText=e=>{this.messageText=e},this.sendVideoChatMessage=async e=>{try{await this.videoApi.createComment(e),this.snackbar.show({type:"ok",text:this.langs.getLang("stories_answer_sent")}),this.changeText(""),this.onMessageBlur()}catch(e){this.errorService.error(l.StoriesViewerTechErrors.FAIL_SEND_MESSAGE,e),this.snackbar.show({type:"error",text:this.langs.getLang("global_unknown_error")})}},this.getSendContentType=e=>e.startsWith("story_suggestion")?S.StoriesViewerStatsEventType.stickerSuggestionSend:e.startsWith("story_reaction")?S.StoriesViewerStatsEventType.stickerReactionSend:S.StoriesViewerStatsEventType.commentSend,this.sendMessage=async e=>{try{this.isMessageSending=!0,await this.messagesApi.send(e),this.snackbar.show({type:"ok",text:this.langs.getLang("stories_answer_sent")}),this.changeText("");const t=!!e.ref&&this.getSendContentType(e.ref);t&&this.stats.saveStoryViewStats(t)}catch(e){this.errorService.error(l.StoriesViewerTechErrors.FAIL_SEND_MESSAGE,e),this.snackbar.show({type:"error",text:this.langs.getLang("global_unknown_error")})}finally{this.isMessageSending=!1,this.onMessageBlur()}},this.sendTextMessage=async e=>{const t=this.listService.getActivePackStory(e);if(this.isMessageEmpty()||!t)return;const{owner_id:i}=t;(0,u.isLiveStory)(t.type)?await this.sendVideoChatMessage({message:this.messageText,owner_id:i,video_id:t.video?.id??0,ref:"story"}):await this.sendMessage({message:this.messageText,peer_id:i,ref:"story",attachment:(0,u.toStoryAttachment)(e,t),random_id:0})},this.sendSticker=async({stickerId:e,stickerReferrer:t,storiesPack:i})=>{const s=this.listService.getActivePackStory(i);if(!s)return;const{owner_id:r}=s;(0,u.isLiveStory)(s.type)?await this.sendVideoChatMessage({sticker_id:e,owner_id:r,ref:t,video_id:s.video?.id??0}):await this.sendMessage({sticker_id:e,peer_id:r,ref:t,attachment:(0,u.toStoryAttachment)(i,s),random_id:0})},this.reset=()=>{this.changeText(""),this.storyService.forbiddenStatuses.message=!1,this.isMessageFocused=!1,this.hidden=!0},(0,r.makeAutoObservable)(this)}}v=(0,s.__decorate)([o.scope.container(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===h.StoriesViewerStoryService?Object:h.StoriesViewerStoryService,void 0===a.MessagesApi?Object:a.MessagesApi,void 0===n.VideoApi?Object:n.VideoApi,void 0===h.StoriesViewerErrorsService?Object:h.StoriesViewerErrorsService,void 0===h.StoriesViewerItemsListService?Object:h.StoriesViewerItemsListService,void 0===c.Snackbar?Object:c.Snackbar,void 0===d.Langs?Object:d.Langs,void 0===S.StoriesViewerStatsService?Object:S.StoriesViewerStatsService,void 0===h.StoriesViewerAppService?Object:h.StoriesViewerAppService])],v)},648817:(e,t,i)=>{i.d(t,{StoriesViewerModalsService:()=>f});var s=i(331635),r=i(132028),o=i(652469),a=i(909209),n=i(327813),c=i(662285),d=i(351118),h=i(530451),l=i(875216),u=i(85228),S=i(563412),v=i(735360),p=i(658145),y=i(670252),g=i(712600),m=i(159391),_=i(873900),w=i(588210);class f{async openStoriesCreatorWithSituationalTemplateSticker({sticker:e,action:t,pickPrefabs:i}){const s=e=>{this.errorsService.error(c.StoriesViewerTechErrors.FAIL_TO_OPEN_PUBLISHER_BY_SITUATIONAL_TEMPLATE_STICKER,e),this.returnToViewer()},r=e.situational_theme_id;if(r)try{i&&await this.storiesCreatorConfigService.pickPrefabsMVK();const e=await this.situationalSuggestProvider.ensure({themeIds:[String(r)]}).ensure();this.navigationService.hideGallery();const a=e?.items?.[0]?.story_box;if((0,d.isString)(a))try{const e=JSON.parse(a);if((0,d.isArray)(e?.stickers)&&(0,h.stickerContainerTypeGuard)(e.stickers)){const i=e.stickers.map((e=>"native"===e?.sticker_type&&"situational_template"===e?.sticker?.action_type?{...e,sticker:{...e.sticker,action:t}}:e)),s={entrypoint:"stories_viewer",defaultColor:"#585f67",...e,photoUrl:e.url,stickers:i,serviceInfo:{situational_suggest_id:r}};this.storiesCreatorConfigService.setConfig({storyBox:s,close:()=>{this.closeModal(),this.returnToViewer()}}),this.setActiveModalId(o.StoriesViewerModal.STORIES_CREATOR)}}catch(e){s(e)}else s(new Error("StoriesViewerModel.tsx storyBox is undefined"))}catch(e){s(e)}else this.returnToViewer()}async openStoriesCreatorWithStoryMemorySticker(e){this.storyService.pause(),this.navigationService.hideGallery();const{date:t}=e;if(!t)return void this.returnToViewer();const i=(0,_.getIdentityRawId)({id:e.id,ownerId:e.owner_id}),s=new Date(1e3*t),r=new l.MemoryStory(i).getStructure(),a=this.langs.getLang("stories_creator_common_date",!0),n=new u.MemoryStoryDate(s,(()=>a[3]),(()=>a[2]),((e,t,i)=>a[1].replace("{day}",e.toString()).replace("{month}",this.langs.getLang("months_of")[t+1]).replace("{year}",String(i))),(e=>{const t=this.langs.getLang("stories_creator_memories_n_years_ago",!0);return this.langs.numeric(e,t).replace("{N}",String(e))})).getStructure(),c={entrypoint:"stories_viewer",serviceInfo:{memory_type:"story",memory_date:(0,m.formatDateToYYYYMMDD)(s)},stickers:[r,n]};this.storiesCreatorConfigService.setConfig({storyBox:c,close:()=>{this.closeModal(),this.returnToViewer()}}),this.setActiveModalId(o.StoriesViewerModal.STORIES_CREATOR)}returnToViewer(){this.navigationService.showGallery(),this.storyService.play()}constructor(e,t,i,s,r,a,c,d,h){this.storyService=e,this.errorsService=t,this.itemsListService=i,this.situationalSuggestProvider=s,this.navigationService=r,this.snackbar=a,this.storiesCreatorConfigService=c,this.langs=d,this.stats=h,this.popout=null,this.activeModalId=null,this.previousModalsIds=[],this.setActiveModalId=(e,t=!1)=>{if(!e){const e=this.previousModalsIds.pop();if(e)return void(this.activeModalId=e)}t&&this.activeModalId&&this.previousModalsIds.push(this.activeModalId),this.activeModalId=e,this.storyService.pause(),this.storyService.forbiddenStatuses.modal=!0},this.closeModal=()=>{this.setActiveModalId(null),this.storyService.forbiddenStatuses.modal=!1,this.storyService.isPaused&&this.storyService.play()},this.setPopout=e=>{this.popout=e,e&&(this.storyService.pause(),this.storyService.forbiddenStatuses.popout=!0)},this.closePopout=e=>{this.setPopout(null),this.storyService.forbiddenStatuses.popout=!1,e&&this.storyService.play()},this.openedExternalModal=()=>{this.storyService.pause(),this.storyService.forbiddenStatuses.modal=!0},this.closedExternalModal=e=>{this.storyService.forbiddenStatuses.modal=!1,e&&this.storyService.play()},this.openFeedbackModal=()=>{this.storyService.changeFeedbackTab(o.StoriesViewerFeedbackTab.VIEWERS),this.setActiveModalId(o.StoriesViewerModal.FEEDBACK),this.stats.saveStoryViewStats(w.StoriesViewerStatsEventType.openRepliesList)},this.emptyFeedbackModal=()=>{this.stats.saveStoryViewStats(w.StoriesViewerStatsEventType.openEmptyFeedback)},this.openQuestionAnswerModal=()=>this.itemsListService.currentStory?.can_ask?(this.setActiveModalId(o.StoriesViewerModal.QUESTION_ANSWER_MODAL),!0):(this.snackbar.show({type:"error",text:this.langs.getLang("stories_viewer_question_answer_cant_ask")}),!1),(0,n.makeAutoObservable)(this)}}f=(0,s.__decorate)([r.scope.container(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===a.StoriesViewerStoryService?Object:a.StoriesViewerStoryService,void 0===a.StoriesViewerErrorsService?Object:a.StoriesViewerErrorsService,void 0===a.StoriesViewerItemsListService?Object:a.StoriesViewerItemsListService,void 0===S.SituationalSuggestsProvider?Object:S.SituationalSuggestsProvider,void 0===p.StoriesViewerNavigationService?Object:p.StoriesViewerNavigationService,void 0===y.Snackbar?Object:y.Snackbar,void 0===v.StoriesCreatorConfigService?Object:v.StoriesCreatorConfigService,void 0===g.Langs?Object:g.Langs,void 0===w.StoriesViewerStatsService?Object:w.StoriesViewerStatsService])],f)},658145:(e,t,i)=>{i.d(t,{StoriesViewerNavigationService:()=>l});var s=i(331635),r=i(132028),o=i(327813),a=i(909209),n=i(311763),c=i(536490),d=i(588210),h=i(393891);class l{hideGallery(){this.galleryHiddenWithoutClosing=!0}showGallery(){this.galleryHiddenWithoutClosing=!1}get galleryHidden(){return this.galleryClosing||this.galleryHiddenWithoutClosing}get isNavigating(){return void 0!==this.navigatingIndex}getIsActiveIndex(e){return e===(this.navigatingIndex??this.itemsListService.currentPackIndex)}constructor(e,t,i,s,r){this.itemsListService=e,this.actionsService=t,this.eventsService=i,this.appService=s,this.statsService=r,this.galleryClosing=void 0,this.galleryHiddenWithoutClosing=void 0,this.navigatingIndex=void 0,this.closingAllLayers=void 0,this.storageAfterNavigationFuntions=[],this.parentElement={current:null},this.init=()=>{this.getParentElement(),this.parentElement.current&&(this.galleryClosing=!1),this.appService.props?.layerParams&&this.sendPerfStoryOpen({...this.appService.props.layerParams,newLayer:{list:this.appService.props.layerParams.listName??"",withAnimate:this.appService.props.withAnimate,getElementSelector:this.appService.props.getParentElementSelector,onLayerClose:this.appService.props.onLayerClose}})},this.onVisibilityAnimationEnded=e=>{e&&!this.galleryHiddenWithoutClosing&&(this.checkAfterAnimationFunctions(),this.closingAllLayers?this.appService.props?.onClose?.():this.appService.props?.onLayerClose?.(),this.closingAllLayers=!1)},this.onAllClose=()=>{this.getParentElement(),this.galleryClosing=!0,this.parentElement.current&&!this.appService.props?.isNotRootLayer?(this.eventsService.emitter.emit(n.StoriesViewerEventType.blockScrollToCenter,{blockItemId:this.itemsListService.currentPack?.id||""}),this.closingAllLayers=!0):this.appService.props?.onClose?.()},this.onLayerClose=()=>{this.getParentElement(),this.parentElement.current?this.galleryClosing=!0:this.appService.props?.onLayerClose?.()},this.onAllCloseClick=()=>{this.onAllClose(),this.statsService.saveStoryViewStats(d.StoriesViewerStatsEventType.closeTap)},this.onCloseClick=()=>{this.onClose()},this.onClose=e=>{this.appService.props?.isNotRootLayer?this.onLayerClose():this.onAllClose(),this.statsService.saveStoryViewStats(e?d.StoriesViewerStatsEventType.closeAutoByTime:d.StoriesViewerStatsEventType.closeTap)},this.openStory=e=>{const{ownerId:t,storyId:i,narrativeId:s,newLayer:r,listName:o}=e;if(this.sendPerfStoryOpen(e),r){const e={listName:r.list,ownerId:t,storyId:i,narrativeId:s};this.appService.props?.pushLayer?.({layerOpenData:{layerParams:e,replace:!0},getParentElementSelector:r.getElementSelector,withAnimate:r.withAnimate,onLayerClose:r.onLayerClose})}else{const{listName:e,...r}=this.appService.props?.layerParams??{},a={...r,listName:o||e,ownerId:t,storyId:i,narrativeId:s};this.appService.props?.setLayerParams?.({layerOpenData:{layerParams:a,replace:!0}})}},this.onNavigationEnd=e=>{if(this.navigatingIndex=void 0,this.itemsListService.needToPackIndex!==e){this.actionsService.markPacksSkipped(this.itemsListService.currentPackIndex,e);const t=this.itemsListService.storyPacks[e],i=this.itemsListService.getLastSeenStory(t);this.openStory({ownerId:String(i?.owner_id||0),storyId:String(i?.id||0),narrativeId:(0,c.isNarrativeStoriesPack)(t.type)?String(t.id):void 0,listName:t.listName})}this.itemsListService.updateCurrentIndexes(),this.checkAfterAnimationFunctions()},this.onNavigationStarted=e=>{this.navigatingIndex=e},this.toPreviousPack=()=>{this.goToPack(this.itemsListService.currentPackIndex-1,!0)},this.toNextPack=()=>{this.goToPack(this.itemsListService.currentPackIndex+1,!0)},this.toNextStoryTap=()=>{this.toNextStory(),this.statsService.saveStoryViewStats(d.StoriesViewerStatsEventType.goToNextStoryTap)},this.toNextStory=e=>{this.actionsService.markStorySeen(this.itemsListService.currentPack,this.itemsListService.currentStory);const{story:t,pack:i}=this.itemsListService.nextStory;if(t&&i)this.openStory({ownerId:String(t.owner_id),storyId:String(t.id),narrativeId:(0,c.isNarrativeStoriesPack)(i.type)?String(i.id):void 0,listName:i.listName}),e&&this.statsService.saveStoryViewStats(d.StoriesViewerStatsEventType.goToNextStoryAutoByTime);else{if(this.itemsListService.additionalListIsLoading)return;this.onClose(e)}},this.toPrevStory=()=>{this.actionsService.markStorySeen(this.itemsListService.currentPack,this.itemsListService.currentStory);const{story:e,pack:t}=this.itemsListService.prevStory;e&&t?(this.openStory({ownerId:String(e.owner_id),storyId:String(e.id),narrativeId:(0,c.isNarrativeStoriesPack)(t.type)?String(t.id):void 0,listName:t.listName}),this.statsService.saveStoryViewStats(d.StoriesViewerStatsEventType.goToPreviousStory)):this.onClose()},this.runOrDeferUntilNavigateTransitionEnds=e=>{this.isNavigating||this.galleryHidden?this.storageAfterNavigationFuntions.push(e):e()},this.checkAfterAnimationFunctions=()=>{if(this.storageAfterNavigationFuntions){for(let e of this.storageAfterNavigationFuntions)e();this.storageAfterNavigationFuntions=[]}},this.goToPack=(e,t)=>{if(e===this.itemsListService.currentPackIndex)return;const i=this.itemsListService.storyPacks[e],s=this.itemsListService.getLastSeenStory(i);if(s)this.onNavigationStarted(e),this.openStory({ownerId:String(s.owner_id),storyId:String(s.id),narrativeId:(0,c.isNarrativeStoriesPack)(i.type)?String(i.id):void 0,listName:i.listName}),!t&&this.statsService.saveStoryViewStats(this.itemsListService.currentPackIndex>e?d.StoriesViewerStatsEventType.goToPreviousAuthor:d.StoriesViewerStatsEventType.goToNextAuthor);else{if(this.itemsListService.additionalListIsLoading)return;this.onClose()}},this.getRootLayerParentElementSelector=()=>{if(!this.appService.props)return;const e=this.itemsListService.getLayerData(this.appService.props.layerParams),t=e?.multiple?.items.find((e=>e.stories?.some((e=>String(e.id)===String(this.appService.props?.layerParams?.storyId)&&String(e.owner_id)===String(this.appService.props?.layerParams?.ownerId)))))?.id;return t?`#${this.appService.props.layerParams.listName}_${t}`:void 0},this.getParentElement=()=>{const e=this.appService.props;if(!e?.withAnimate)return;const t=e.isNotRootLayer?e.getParentElementSelector?.(this.itemsListService.currentStory):this.getRootLayerParentElementSelector();if(t)try{let i=document.querySelector(t);i||"discover"!==e.layerParams.listName||(i=document.querySelector('[data-type="story_card_discover"]')),this.parentElement.current=i}catch{this.parentElement.current=null}},this.sendPerfStoryOpen=e=>{const{ownerId:t,storyId:i,narrativeId:s,newLayer:r}=e;let o,a=!1,n=!1,c=h.StoryTypeOpen.NEXT_OPEN_STORY;if(r)a=r.withAnimate||!1,c=h.StoryTypeOpen.OPEN_STORY_BY_CLICK;else{const e=this.itemsListService.currentStoryIndex,r=this.itemsListService.currentPackIndex,c=this.itemsListService.findPackIndex({ownerId:t,narrativeId:s,storyId:i});if(c===r){n=!0;o=(this.itemsListService.currentPack?.stories.findIndex((e=>String(e.id)===i))??-1)>e?h.StoryTypeNext.NEXT_STORY:h.StoryTypeNext.PREV_STORY}else a=!0,o=c>r?h.StoryTypeNext.NEXT_CONTAINER_STORY:h.StoryTypeNext.PREV_CONTAINER_STORY}this.appService.openParamsState.nonce=String(performance.now()),(0,h.trackStoryOpeningStart)({nonce:this.appService.openParamsState.nonce,time:performance.now(),isColdStart:!1,isAnimated:a,isLocalWithinViewer:!0,isLocalWithinSameAuthor:n,viewSource:this.appService.module,navigationSource:c,navigationNextSpecifier:o})},(0,o.makeAutoObservable)(this)}}l=(0,s.__decorate)([r.scope.container(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===a.StoriesViewerItemsListService?Object:a.StoriesViewerItemsListService,void 0===a.StoriesViewerActionsService?Object:a.StoriesViewerActionsService,void 0===n.StoriesViewerEventsService?Object:n.StoriesViewerEventsService,void 0===a.StoriesViewerAppService?Object:a.StoriesViewerAppService,void 0===d.StoriesViewerStatsService?Object:d.StoriesViewerStatsService])],l)},374302:(e,t,i)=>{i.d(t,{StoriesViewerPreloadService:()=>m});var s=i(331635),r=i(24516),o=i(809424),a=i(645043),n=i(652469),c=i(536490),d=i(702736),h=i(132028),l=i(852487),u=i(789310),S=i(897976),v=i(909209),p=i(662285),y=i(182807),g=i(75385);class m{async init(e){this.makeLive=e?.makeLive,this.withoutVkVideoPlayer=this.appService.isMvk?this.userEnv.partConfigEnabled("frontend.mvk_spa_stories_viewer_without_vk_player"):!this.userEnv.partConfigEnabled("frontend.web_stories_viewer_redesign_with_vk_player"),this.withoutVkVideoPlayer||(this.vkVideoConfig=await this.videoPlayerConfigProvider.ensure({module:"stories"}))}getVkVideoPlayer(e,t){let i=this.vkVideoPlayers.get(e);return i&&i.videoContainer||(i=new d.StoriesVkVideoPlayer({unitedVideoId:e,sources:t,vkVideoConfig:this.vkVideoConfig},this.userEnv,this.metaData),this.vkVideoPlayers.set(e,i)),i}async preloadVideoStory(e,t=!1){if(e.type!==n.StoryType.VIDEO)return null;const i=(0,S.constructSources)(e.video||{}),s=(0,c.getVideoUrl)(e);if(this.vkVideoConfig&&!this.withoutVkVideoPlayer&&i){const s=this.getVkVideoPlayer(e.video?.ov_id||"",i);return await s.preload(),t?null:(s.reset(),new u.StoriesViewerVkVideoEntity(s))}return s?t?(await this.videoElementManager.preloadVideo(s),null):new u.StoriesViewerVideoEntity(this.videoElementManager,s):void 0}async getImage(e,t=!1){const i=this.getPhotoUrl(e),s=await this.loadImageAsDataUrl(i);return t?null:new u.StoriesViewerPhotoEntity(s)}async getNextLoadImagePromise(e){const t=this.getImageFromCache(e);return t||(this.nextLoadImagePromises[e]||(this.nextLoadImagePromises[e]=Promise.withResolvers()),await this.nextLoadImagePromises[e].promise)}getLive(e){if(!this.makeLive)throw new Error("lives are not supported!");return this.makeLive(e)}async getStory(e,t=!1){try{switch(e.type){case n.StoryType.PHOTO:return await this.getImage(e,t);case n.StoryType.VIDEO:return await this.preloadVideoStory(e,t);case n.StoryType.LIVE_ACTIVE:case n.StoryType.LIVE_FINISHED:return this.getLive(e)}}catch(e){if("Cancelled"===e.message)return;this.errorsService.error(p.StoriesViewerTechErrors.FAIL_FETCH_PRELOAD,e)}return null}removeVideoStoryFromPreloadCache(e){if(!e)return;this.vkVideoPlayers.delete(e.video?.ov_id||"");const t=(0,c.getVideoUrl)(e);t&&this.videoElementManager.discardOne(t)}[h.destroy](){this.vkVideoPlayers.forEach((e=>{e.destroy()})),this.vkVideoPlayers.clear(),this.videoElementManager.destroy()}constructor(e,t,i,s,r){this.videoPlayerConfigProvider=e,this.userEnv=t,this.metaData=i,this.errorsService=s,this.appService=r,this.videoElementManager=new c.VideoElementManager((0,g.isSpaStoriesViewerPreloadAuthorsWebEnabled)()?5:3,"canplay"),this.makeLive=void 0,this.withoutVkVideoPlayer=!1,this.vkVideoConfig=null,this.nextLoadImagePromises={},this.vkVideoPlayers=new y.default({maxSize:3,onEviction:(e,t)=>{t.destroy()}}),this.getPhotoUrl=c.getPhotoUrl,this.getImageFromCache=a.getImageExistFromCache,this.loadImageAsDataUrl=async e=>{const t=await(0,a.loadImageAsDataUrl)(e);return this.nextLoadImagePromises[e]&&(this.nextLoadImagePromises[e].resolve(t),delete this.nextLoadImagePromises[e]),t},this.loadImageByUrl=async e=>(0,g.isSpaStoriesViewerControlledPreloadImagesEnabled)()?this.getNextLoadImagePromise(e):this.loadImageAsDataUrl(e)}}m=(0,s.__decorate)([h.scope.container(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===l.VideoPlayerConfigProvider?Object:l.VideoPlayerConfigProvider,void 0===r.UserEnv?Object:r.UserEnv,void 0===o.MetaData?Object:o.MetaData,void 0===v.StoriesViewerErrorsService?Object:v.StoriesViewerErrorsService,void 0===v.StoriesViewerAppService?Object:v.StoriesViewerAppService])],m)},418122:(e,t,i)=>{i.d(t,{StoriesViewerProgressService:()=>a});var s=i(331635),r=i(327813),o=i(132028);class a{init(e){this.onStoryEnd=e}pause(){this.timer&&(clearInterval(this.timer),this.timer=null,this.isStoryStarted=!1)}start(e){this.leftStoryTime=e,this.storyDuration=e}play(){if(this.isStoryStarted)return!1;const e=new Date(Date.now()+this.leftStoryTime).getTime();this.isStoryStarted=!0,this.timer=setInterval((()=>{const t=(new Date).getTime();this.leftStoryTime=e-t,this.leftStoryTime<=0?(this.changeCurrentStoryProgress(100),this.pause(),this.onStoryEnd()):this.changeCurrentStoryProgress(100-Math.min(Math.max(this.leftStoryTime,0)/this.storyDuration*100,100)||0)}),10)}changeCurrentStoryProgress(e){this.currentStoryProgress=e}reset(){this.pause(),this.currentStoryProgress=0,this.storyDuration=0,this.leftStoryTime=0}constructor(){this.currentStoryProgress=0,this.isStoryStarted=!1,this.onStoryEnd=()=>{},this.timer=null,this.leftStoryTime=0,this.storyDuration=0,(0,r.makeAutoObservable)(this)}}a=(0,s.__decorate)([o.scope.transient(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[])],a)},813990:(e,t,i)=>{i.d(t,{StoriesViewerStoryService:()=>I});var s=i(331635),r=i(132028),o=i(909209),a=i(327813),n=i(652469),c=i(351118),d=i(630186),h=i(417360),l=i(657009),u=i(662285),S=i(536490),v=i(744521),p=i(631576),y=i(797540),g=i(670252),m=i(510454),_=i(489633),w=i(588210),f=i(393891),E=i(873900),A=i(304487),k=i(75385);class I{init({preloadNeighbourStoryPacks:e,elementsCountEachSide:t=1}){this.preloadNeighbourStoryPacks=Boolean(e),this.elementsCountEachSide=t}setElementsCountEachSide(e=1){const t=this.elementsCountEachSide;this.elementsCountEachSide=e,this.elementsCountEachSide>t&&this.preloadPreview()}getStoryLink(e,t){return(0,y.toStoryLink)(e,t)}getIsAudioLink(e){const t=this.getStoryLink(e);return Boolean(t?.object&&"audio"===t?.type)}getAudio(e){return this.musicAudioModelFactory.createTrack({getSource:()=>({audio:e,trackCode:null})})}getPlaylist(e){return this.musicPlaylistProvider.provideFromAPI(e,{ref:null})}getAudioList(e){return this.audioListProvider.createFromAPI([e])}getIsLinkAudioActive(e){const t=this.getStoryLink(e);return!!t?.object&&this.globalPlayer.main.currentAudio?.data.apiAudio?.id===t?.object?.id}getIsLinkAudioPaused(e){const t=this.getStoryLink(e);return!!t?.object&&(this.getIsLinkAudioActive(e)&&this.globalPlayer.main.paused)}getIsLinkAudioPlaying(e){const t=this.getStoryLink(e);return!!t?.object&&(this.getIsLinkAudioActive(e)&&this.globalPlayer.main?.playing)}getAudioRestrictionClickableSticker(e){return e.clickable_stickers?.clickable_stickers?.find((e=>{if(e?.audio_restrictions)return e}))}toggleStoryAudio(e){if(this.getAudioRestrictionClickableSticker(e))return;const t=this.getStoryLink(e)?.object;t&&(this.getIsLinkAudioPlaying(e)?(this.globalPlayer?.main.stop(),this.play()):this.getIsLinkAudioPaused(e)?(this.pause(),this.globalPlayer?.main.resume()):(this.pause(),this.globalPlayer?.main.playAudio(this.getAudio(t).entity,this.getAudioList(t))))}get isForbiddenToStartStory(){return this.forbiddenStatuses.message||this.forbiddenStatuses.modal||this.error||this.navigationService.galleryHidden}get isForbiddenToNavigateStory(){return this.forbiddenStatuses.message||this.forbiddenStatuses.modal||this.forbiddenStatuses.popout}async start(){if(this.navigationService.galleryHidden||!this.itemsListService.currentStory)return;const e=this.currentMedia,t=performance.now();this.itemsListService.saveCurrentAsLastStory(),this.isLoading=!0,this.currentMedia=null;let i=(0,S.getStoryHideReason)(this.itemsListService.currentStory);if(this.itemsListService.isStoryInReplies(this.itemsListService.currentStory)&&(i=u.StoriesViewerHideReasons.IS_REPLY_HIDE),i)this.setError(i);else try{const i=this.itemsListService.currentPack,s=this.itemsListService.currentStory,r=await this.preloadService.getStory(s);if(r&&this.itemsListService.setPackStoryMedia(i,s,r),this.itemsListService.currentStory.id!==s.id)return;if(!r)return void this.setError(u.StoriesViewerTechErrors.FAIL_GET_CURRENT_MEDIA);this.appService.getIsStoryOrNarrativeOwner(i,s)&&!this.itemsListService.feedbackData[s.id]&&this.actionsService.getFeedbackData(s),r.setParams({pause:this.pauseWithButton,play:this.play,loading:this.loading,setError:this.setError}),this.setCurrentMedia(r),this.isVolumeShown&&r.changeVolume(this.isMuted?0:this.volume),this.setIsLoading(!1),this.progressService.start(r.getDuration(s?.video?.duration||0)||0),this.actionsService.markStorySeen(i,s),this.preloadNeighbourStories(),this.navigationService.navigatingIndex||i?.isAdditionalListPlaceholderShown||("photo"===s.type&&this.play(),e!==r&&(this.statsService.saveStoryViewStats(w.StoriesViewerStatsEventType.viewStory,{preloading_duration:performance.now()-t}),(0,k.isSpaStoriesViewerFixUrlChangeEnabled)()&&requestAnimationFrame((()=>{this.layersService.syncLayerParamsWithUrl()}))));const o=this.getAudioRestrictionClickableSticker(s);if(o?.audio_restrictions){const{title:e,text:t,button:i}=o.audio_restrictions;this.snackbar.show({text:e,subtitle:t,action:i?{label:i.title||"",href:i.action?.url}:void 0})}}catch(e){this.errorsService.error(u.StoriesViewerTechErrors.FAIL_GET_CURRENT_MEDIA,e)}}get isPlaying(){return!this.isPaused&&!this.isLoading&&!this.isForbiddenToStartStory}setIsLoading(e){this.isLoading=e}setCurrentMedia(e){this.currentMedia=e}reset(){this.progressService.reset(),this.currentMedia?.destroy(),this.currentMedia=null,this.isLoading=!1,this.isPaused=!1,this.showPauseButton=!1,this.error=null}getPreview(e,t=n.StoryPreviewMinSizes.MEDIUM){if((0,k.isSpaStoriesViewerLoadMainSizeOnlyEnabled)()&&"photo"===e?.type)return this.preloadService.getPhotoUrl(e);if(!e)return;const i=e?.photo?.sizes||e?.video?.first_frame;return(0,S.calcPreviewSize)(i,t)}async preloadStory(e){e&&!(0,S.getStoryHideReason)(e)&&(await this.preloadService.getStory(e,!0),e.owner_id!==this.appService.viewerId||this.itemsListService.feedbackData[e.id]||this.actionsService.getFeedbackData(e))}async preloadPreview(){for(let e=1;e<=this.elementsCountEachSide;e++){const t=this.itemsListService.getStoryFromPackWithShift(e),i=this.itemsListService.getStoryFromPackWithShift(-e);await Promise.all([this.preloadStoryPreview(t),this.preloadStoryPreview(i)])}}async preloadStoryPreview(e){if(!e)return;const t=this.getPreview(e);t&&await this.preloadService.loadImageAsDataUrl(t)}async preloadNeighbourStories(){await this.preloadStory(this.itemsListService.nextStory.story),await this.preloadStory(this.itemsListService.prevStory.story),this.preloadNeighbourStoryPacks&&await Promise.all([this.preloadStory(this.itemsListService.nextPackStory),this.preloadStory(this.itemsListService.prevPackStory)]),(0,k.isSpaStoriesViewerControlledPreloadImagesEnabled)()&&this.preloadPreview()}mediaFocusChange(){const e=this.itemsListService.currentStory?.type;this.isMuted?this.mediaFocus.active&&this.mediaFocus.stop():e===n.StoryType.PHOTO&&this.mediaFocus.active?this.mediaFocus.stop():e===n.StoryType.VIDEO&&(this.isPaused?this.mediaFocus.stop():this.mediaFocus.active||this.mediaFocus.start())}get isVolumeShown(){if(this.appService.isMvk)return!1;const e=this.itemsListService.currentStory;if(!e||e.no_sound||e.need_mute)return!1;if(e.type!==n.StoryType.PHOTO)return!0;let t=!1;const i=e.clickable_stickers?.clickable_stickers?.some((e=>e.audio_restrictions?(t=!0,!1):!!["music","playlist"].includes(e.type)||e.audio))??!1;if(t)return!1;if(i)return!0;const s=this.getStoryLink(e);return!!s?.object}destroy(){this.mediaFocus.stop(),this.reset()}constructor(e,t,i,s,r,o,d,h,l,S,v,p,y,g,m,k){this.itemsListService=e,this.preloadService=t,this.mediaFocus=i,this.errorsService=s,this.actionsService=r,this.navigationService=o,this.globalPlayer=d,this.musicAudioModelFactory=h,this.musicPlaylistProvider=l,this.audioListProvider=S,this.snackbar=v,this.localStorage=p,this.appService=y,this.progressService=g,this.statsService=m,this.layersService=k,this.currentMedia=null,this.isLoading=!0,this.isPaused=!1,this.error=null,this.showPauseButton=!1,this.volume=1,this.isMuted=!1,this.forbiddenStatuses={message:!1,modal:!1,popout:!1},this.activeTab=n.StoriesViewerFeedbackTab.VIEWERS,this.lastPlayedStoryRawId=void 0,this.preloadNeighbourStoryPacks=!1,this.elementsCountEachSide=1,this.onActiveStoryPackChangeStarted=e=>{this.pause(),this.navigationService.onNavigationStarted(e),this.itemsListService.animatingSecondaryToActivePackIndex=e},this.onCurrentPackIndexChange=e=>{this.navigationService.onNavigationEnd(e)},this.play=()=>{if(this.isForbiddenToStartStory)return;const e=this.itemsListService.currentStory;this.isLoading=!1,this.showPauseButton=!1,this.isPaused=!1,this.mediaFocusChange(),this.currentMedia?.play(e?.no_sound||e?.need_mute),this.progressService.play();const t=(0,E.getIdentityRawId)({ownerId:(this.itemsListService.currentPack?.narrative?this.itemsListService.currentPack?.narrative.id:this.itemsListService.currentStory?.owner_id)??0,id:this.itemsListService.currentStory?.id??0});this.lastPlayedStoryRawId!==t&&(this.lastPlayedStoryRawId=t,(0,f.trackStoryDownloadEnd)({nonce:this.appService.openParamsState.nonce||"",viewSource:this.appService.module,storyDetails:(0,A.getStoryPerfData)(this.itemsListService.currentStory)}))},this.pause=()=>{this.isPaused=!0,this.mediaFocusChange(),this.currentMedia?.pause(),this.progressService.pause()},this.pauseWithButton=()=>{this.pause(),this.showPauseButton=!0},this.togglePlayPause=(e=!1)=>{this.isPaused?this.play():e?this.pauseWithButton():this.pause()},this.loading=()=>{this.isLoading=!0,this.progressService.pause()},this.setError=(e,t)=>{this.error=e,this.isLoading=!1,this.progressService.pause(),this.preloadService.removeVideoStoryFromPreloadCache(this.itemsListService.currentStory),e in u.StoriesViewerTechErrors&&this.errorsService.error(e,t),e===u.StoriesViewerTechErrors.FAIL_STORY_VIEWER_DATA_PARSE&&this.itemsListService.failListData(),e!==u.StoriesViewerTechErrors.FAIL_FETCH_VIDEO&&e!==u.StoriesViewerTechErrors.FAIL_FETCH_VK_VIDEO||(0,f.trackStoryDownloadFailure)({error:e,nonce:this.appService.openParamsState.nonce||""})},this.restart=()=>{this.reset(),this.start()},this.onStoryProgressBarClick=e=>{const t=this.itemsListService.currentPack,i=t?.stories[e];i&&i.id!==this.itemsListService.currentStory?.id&&(this.navigationService.openStory({ownerId:String(i.owner_id),storyId:String(i.id),listName:t.listName}),this.statsService.saveStoryViewStats(w.StoriesViewerStatsEventType.goToStoryClick))},this.changeVolume=e=>{this.volume=e,this.currentMedia?.changeVolume?.(e),this.setStorageVolume(e);const t=this.isMuted;0===this.volume?this.isMuted=!0:this.isMuted&&(this.isMuted=!1),this.isMuted!==t&&this.mediaFocusChange()},this.toggleMute=()=>{this.isMuted?this.changeVolume(this.volume||1):(this.isMuted=!0,this.currentMedia?.changeVolume?.(0),this.setStorageVolume(0)),this.mediaFocusChange()},this.setStorageVolume=(0,c.debounce)((e=>{this.localStorage.setItem(_.STORY_VIEWER_VOLUME_STORAGE,String(e))}),300),this.deleteCurrentStory=()=>{const e=this.itemsListService.currentPack;e&&e.stories.length>1?(this.navigationService.toNextStory(),this.itemsListService.deleteCurrentStory()):this.deleteCurrentPack()},this.deleteCurrentPack=()=>{const e=this.itemsListService.currentPackIndex,t=this.itemsListService.storyPacks.length-1===e,i=this.itemsListService.currentPack;t?this.navigationService.toPreviousPack():this.navigationService.toNextPack(),this.navigationService.runOrDeferUntilNavigateTransitionEnds((()=>this.itemsListService.deletePack(i?.id)))},this.changeFeedbackTab=e=>{this.activeTab=e},this.hideCurrentStory=()=>{this.reset(),this.error=u.StoriesViewerHideReasons.IS_REPLY_HIDE,this.actionsService.hideReplyStory(this.itemsListService.currentStory)},this.mediaFocus.setActions({pause:()=>this.isPaused?{isAlreadyPaused:!0}:(this.pause(),{isAlreadyPaused:!1}),resume:()=>{this.play()}});const I=this.localStorage.getItem(_.STORY_VIEWER_VOLUME_STORAGE);I&&(this.volume=Number(I),this.volume||(this.isMuted=!0)),this.progressService.init((()=>{this.navigationService.toNextStory(!0)})),(0,a.makeAutoObservable)(this)}}I=(0,s.__decorate)([r.scope.container(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===o.StoriesViewerItemsListService?Object:o.StoriesViewerItemsListService,void 0===o.StoriesViewerPreloadService?Object:o.StoriesViewerPreloadService,void 0===d.MediaFocusStoriesChannel?Object:d.MediaFocusStoriesChannel,void 0===o.StoriesViewerErrorsService?Object:o.StoriesViewerErrorsService,void 0===o.StoriesViewerActionsService?Object:o.StoriesViewerActionsService,void 0===o.StoriesViewerNavigationService?Object:o.StoriesViewerNavigationService,void 0===v.AudioPlayer?Object:v.AudioPlayer,void 0===p.MusicAudioModelFactory?Object:p.MusicAudioModelFactory,void 0===h.MusicPlaylistProvider?Object:h.MusicPlaylistProvider,void 0===l.AttachmentAudioListProvider?Object:l.AttachmentAudioListProvider,void 0===g.Snackbar?Object:g.Snackbar,void 0===m.LocalStorage?Object:m.LocalStorage,void 0===o.StoriesViewerAppService?Object:o.StoriesViewerAppService,void 0===o.StoriesViewerProgressService?Object:o.StoriesViewerProgressService,void 0===w.StoriesViewerStatsService?Object:w.StoriesViewerStatsService,void 0===o.StoriesViewerLayersService?Object:o.StoriesViewerLayersService])],I)},809540:(e,t,i)=>{i.d(t,{StoriesViewerTouchService:()=>d});var s=i(331635),r=i(132028),o=i(327813),a=i(896412),n=i(909209),c=i(588210);class d{get touchDisabled(){return this.storyService.forbiddenStatuses.message}isSwipeUpStoryLink(e,t){return Boolean(this.appService.isMvk&&t?.link&&e.shiftY<-60)}reset(){this.isActionsHidden=void 0,this.isSwipeUpElementsVisible=void 0,this.swipeClosePhase=void 0,clearTimeout(this.longTapTimeout)}[r.destroy](){this.reset()}constructor(e,t,i,s){this.storyService=e,this.appService=t,this.navigationService=i,this.statsService=s,this.isActionsHidden=void 0,this.isSwipeUpElementsVisible=void 0,this.swipeClosePhase=void 0,this.longTapTimeout=void 0,this.onTouchStart=()=>{this.touchDisabled||(this.longTapTimeout=setTimeout((()=>{this.isActionsHidden=!0,this.storyService.pause(),this.statsService.saveStoryViewStats(c.StoriesViewerStatsEventType.pauseLongTap)}),200))},this.onTouchMove=(e,t,i)=>{if((0,a.cancelEvent)(e.originalEvent),!this.touchDisabled&&this.appService.isMvk&&t.current)if(e.isSlideY&&e.shiftY>0){const i=t.current.offsetHeight;t.current.style.transform=`translateY(${e.shiftY}px)`,t.current.style.opacity=String(Math.max(1-e.shiftY/i,.6)),this.swipeClosePhase=e.shiftY<.2*i?"move":"close"}else this.swipeClosePhase=void 0,this.isSwipeUpElementsVisible=this.isSwipeUpStoryLink(e,i)},this.onTouchEnd=(e,t,i,s)=>{if(!this.touchDisabled){if(this.isActionsHidden&&(this.isActionsHidden=!1,this.storyService.play(),this.statsService.saveStoryViewStats(c.StoriesViewerStatsEventType.resumeRelease)),this.swipeClosePhase&&t.current&&("move"===this.swipeClosePhase?(t.current.style.transform="translateY(0)",t.current.style.opacity="1"):"close"===this.swipeClosePhase&&this.navigationService.onClose()),this.isSwipeUpStoryLink(e,i)){const e=this.storyService.getStoryLink(i,this.appService.isMvk);e&&s?.(e.url)}this.reset()}},(0,o.makeAutoObservable)(this)}}d=(0,s.__decorate)([r.scope.container(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===n.StoriesViewerStoryService?Object:n.StoriesViewerStoryService,void 0===n.StoriesViewerAppService?Object:n.StoriesViewerAppService,void 0===n.StoriesViewerNavigationService?Object:n.StoriesViewerNavigationService,void 0===c.StoriesViewerStatsService?Object:c.StoriesViewerStatsService])],d)},909209:(e,t,i)=>{i.d(t,{NarrativeCoverUploadService:()=>f.NarrativeCoverUploadService,NarrativeListModalService:()=>y.NarrativeListModalService,NarrativesEditorService:()=>w.NarrativesEditorService,StoriesArchiveScrollService:()=>m.StoriesArchiveScrollService,StoriesArchiveService:()=>g.StoriesArchiveService,StoriesListSharedProvider:()=>s.StoriesListSharedProvider,StoriesViewerActionsService:()=>h.StoriesViewerActionsService,StoriesViewerAppService:()=>c.StoriesViewerAppService,StoriesViewerDataService:()=>a.StoriesViewerDataService,StoriesViewerErrorsService:()=>r.StoriesViewerErrorsService,StoriesViewerInitService:()=>E.StoriesViewerInitService,StoriesViewerItemsListService:()=>d.StoriesViewerItemsListService,StoriesViewerLayersService:()=>n.StoriesViewerLayersService,StoriesViewerMessageService:()=>_.StoriesViewerMessageService,StoriesViewerModalsService:()=>p.StoriesViewerModalsService,StoriesViewerNavigationService:()=>l.StoriesViewerNavigationService,StoriesViewerPreloadService:()=>u.StoriesViewerPreloadService,StoriesViewerProgressService:()=>o.StoriesViewerProgressService,StoriesViewerStoryService:()=>S.StoriesViewerStoryService,StoriesViewerTouchService:()=>v.StoriesViewerTouchService});i(792266);var s=i(858628),r=i(125422),o=i(418122),a=i(727027),n=i(392233),c=i(529160),d=i(913117),h=i(206160),l=i(658145),u=i(374302),S=i(813990),v=i(809540),p=i(648817),y=i(454095),g=i(281285),m=i(51238),_=i(587900),w=i(669928),f=i(557006),E=i(740777)},702736:(e,t,i)=>{i.d(t,{StoriesVkVideoPlayer:()=>a});var s=i(773439),r=i(819705),o=i(698499);class a{setPlace(e){this.place=e}addContainerClass(e){this.videoContainer?.classList.add(e)}addVideoClass(e){this.videoElement?.classList.add(e)}get duration(){return this.player.info.duration$.getValue()}get currentTime(){return this.player.getExactTime()||this.player.info.position$.getValue()||this.videoElement.currentTime}seekTime(e){this.player.seekTime(e)}preload(e=!1){return this.preloadPromise||(this.preloadPromise=new Promise(((t,i)=>{this.player.initVideo({container:this.videoContainer,sources:this.data.sources,meta:{videoId:this.data.unitedVideoId}}),this.player.prepare(),this.player.setLooped(!1),this.player.setMuted(e);const s=e=>{i(e),delete this.preloadPromise},o=this.player.events.canplay$.pipe((0,r.mapTo)({isError:!1,error:null})),a=this.player.events.fatalError$.pipe((0,r.map)((e=>({isError:!0,error:e}))));(0,r.merge)(o,a).pipe((0,r.once)()).subscribe((({isError:e,error:i})=>{e?s(i):t()}))}))),this.preloadPromise}reset(){this.player.pause(),this.seekTime(0)}destroy(){this.destroyOneStat?.(),this.player.destroy(),this.videoContainer?.remove(),delete this.preloadPromise}constructor(e,t,i){this.data=e,this.userEnv=t,this.metaData=i,this.place="",this.videoContainer=document.createElement("div"),this.videoElement=document.createElement("video"),this.videoContainer.appendChild(this.videoElement),this.videoElement.setAttribute("x-yandex-pip","false"),this.videoElement.setAttribute("disablePictureInPicture","true"),this.player=new s.Player(this.data.vkVideoConfig?.core);const{platformId:r}=this.metaData.get();this.destroyOneStat=(0,o.attachOneStatToVkVideoPlayer)(this.player,{movieId:Number(this.data.unitedVideoId),place:this.place,mobile:!1,autoplay:!1,vkAppId:String(r)},this.data.vkVideoConfig?.statistics)}}},698499:(e,t,i)=>{i.d(t,{attachOneStatToVkVideoPlayer:()=>c});var s=i(89923),r=i(191977),o=i(859738);const a={apiEnv:s.ApiEnv.PROD,requestRetryCount:1},n=async e=>{try{const t=await(0,r.get)();await e.authorize(t),e.resume()}catch(e){(0,o.trackOneStatError)("video.getStatsToken")}};function c(e,t,i=a){if(!e)return;const c=!!window.vk.id,d=c?async()=>{try{return await(0,r.get)({refresh:!0})}catch(e){throw(0,o.trackOneStatError)("video.getStatsToken"),e}}:void 0,h=new s.OneStat(t,{refreshAuthToken:d,config:i});return h.pause(),c?n(h):(h.authorize(),h.resume()),h.attachTo(e),()=>{h.destroy()}}},792138:(e,t,i)=>{i.d(t,{storyViewClickableToStoryStat:()=>r});var s=i(873900);function r(e){if(e?.parent_story)return{is_reply_to_story:1,reply_to_story_id:e.parent_story.id,reply_to_story_owner_id:e.parent_story.owner_id,clickable_sticker:{type:"story_reply",style:"preview"}};const t=e?.clickable_stickers?.clickable_stickers??[];for(const e of t){if(e.post_id&&e.post_owner_id)return{is_reply_to_story:0,clickable_sticker:{type:"post",style:"preview",text_value:(0,s.getIdentityRawId)({id:e.post_id,ownerId:e.post_owner_id})}};if(e.clip_id&&e.owner_id)return{is_reply_to_story:0,clickable_sticker:{type:"clip",style:"preview",text_value:(0,s.getIdentityRawId)({id:e.clip_id,ownerId:e.owner_id})}};if(e.video_id&&e.owner_id)return{is_reply_to_story:0,clickable_sticker:{type:"vk_video",style:"preview",text_value:(0,s.getIdentityRawId)({id:e.video_id,ownerId:e.owner_id})}}}return{is_reply_to_story:0}}},797540:(e,t,i)=>{i.d(t,{toStoryLink:()=>S});var s=i(724913),r=i(70148),o=i(768035),a=i(873900),n=i(884921),c=i(501397),d=i(351118),h=i(34231);const l=RegExp(`^\\/?audio${s.ANY_RAW_ID_INCLUDABLE_PATTERN}\\/?$`),u=e=>{if(!e)return null;const{link:t,clickable_stickers:i}=e,d=i?.clickable_stickers;if(!t||!d)return null;const h=(e=>{const t=URL.parse(e.url);if(!t||!n.VK_URL_REGEX.test(t.host))return null;const i=t.pathname;if(!l.test(i))return null;const a=i.match(s.ANY_RAW_ID_INCLUDABLE_REGEXP)?.[0];if(!a)return null;try{return new r.OwnedIdentity((0,o.parseRawId)(a))}catch(e){return(0,c.logError)(e),null}})(t);if(!h)return null;const u=d.find((({audio:e})=>{if(!e)return!1;const t=(0,a.getIdentityRawId)({id:e.id,ownerId:e.owner_id});return[h.rawId,h.accessRawId].includes(t)}));if(!u?.audio)return null;const{url:S,text:v}=t;return{url:S,text:v,type:"audio",object:u.audio}},S=(e,t)=>{const i=e?.link;if(!i)return null;const{url:s,text:r}=i,o=u(e)??{url:s,text:r};let a=(0,d.decodeHTMLEntities)(o.url);if(t&&(a=a.replace("music/playlist/","audio?act=audio_playlist")),e?.is_profile_question){const e=new URL(a);e.searchParams.set("ref","story"),a=e.toString()}return{...o,url:(0,h.wrapAwayIfExternal)(a,!0)}}},838269:(e,t,i)=>{i.d(t,{getEditorFonts:()=>s});const s=e=>[{label:e("stories_creator_text_label_modern"),fontFamily:"TT Firs Neue"},{label:e("stories_creator_text_label_playful"),fontFamily:"TT Knickerbockers Script"},{label:e("stories_creator_text_label_aesthetic"),fontFamily:"TT Knickerbockers Grotesk"},{label:e("stories_creator_text_label_dynamic"),fontFamily:"TT Commons Bold",fontStyle:"italic"},{label:e("stories_creator_text_label_classic"),fontFamily:"TT Barrels Trl"},{label:e("stories_creator_text_label_elegant"),fontFamily:"TT Barrels Trl Italic",fontStyle:"italic"},{label:e("stories_creator_text_label_rounded"),fontFamily:"TT Rounds Neue",textTransform:"uppercase"},{label:e("stories_creator_text_label_standard"),fontFamily:"TT Commons"},{label:e("stories_creator_text_label_handwritten"),fontFamily:"TT Lovelies Script"},{label:e("stories_creator_text_label_bookish"),fontFamily:"TT Phobos"}]},735360:(e,t,i)=>{i.d(t,{StoriesCreatorConfigService:()=>s.StoriesCreatorConfigService,getEditorFonts:()=>r.getEditorFonts});var s=i(468541),r=i(838269)},822247:(e,t,i)=>{i.d(t,{StoriesCreatorConfigService:()=>p});var s=i(331635),r=i(132028),o=i(327813),a=i(591269),n=i(928178),c=i(379411),d=i(720903),h=i(809424),l=i(712600),u=i(735360),S=i(291350);const v=()=>{if(window?.audio)return window?.audio};class p{[r.destroy](){this.audioTimer&&(clearTimeout(this.audioTimer),this.audioTimer=void 0)}setConfig(e){const t=this.metadata.get().module||window.cur?.module;this.config=(0,c.defaultsDeep)(this.config,{navScreen:t},e)}getConfig(){return this.config}reset(){this.startMusic(),this.config=this.createConfig()}async pickPrefabsMVK(){this.stopMusic();const e=await(0,a.getPrefabsFromFileSystem)();return e.length?(this.setConfig({prefabs:e}),!0):(this.startMusic(),!1)}stopMusic(){const e=v();e&&e?.playing?.()&&(this.needAudioRestore=!0,e?.pause())}startMusic(){const e=v();e&&this.needAudioRestore&&(this.needAudioRestore=!1,this.audioTimer=setTimeout((()=>{e?.play(),this.audioTimer=void 0}),2e3))}createConfig(){const e=(0,u.getEditorFonts)(this.langs.getLang);if(!this.emitter)throw new Error("Emitter обязателен для работы! Нарушен порядок вызова создания конфига");return(0,c.defaultsDeep)((0,d.default)(n.STORIES_CREATOR_DEFAULT_CONFIG),{editor:{text:{fonts:e,defaultFont:{fontFamily:e[0].fontFamily}}},emitter:this.emitter})}constructor(e,t){this.metadata=e,this.langs=t,this.emitter=(0,S.storyPublisherEmitter)(),this.config=this.createConfig(),this.needAudioRestore=!1,(0,o.makeAutoObservable)(this)}}p=(0,s.__decorate)([r.scope.global(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===h.MetaData?Object:h.MetaData,void 0===l.Langs?Object:l.Langs])],p)},468541:(e,t,i)=>{i.d(t,{StoriesCreatorConfigService:()=>s.StoriesCreatorConfigService});var s=i(822247)},265896:(e,t,i)=>{i.d(t,{storyPublisherEmitter:()=>o});var s=i(558137),r=i(584053);const o=(0,s.makeSharedState)("StoryPublisherV2",(()=>new r.Emitter),{version:1})},228615:(e,t,i)=>{i.d(t,{getStoriesCreatorMergedEntrypoint:()=>r});var s=i(928178);function r(...e){for(let t of e){if(t?.storyBox?.entrypoint)return t.storyBox.entrypoint;if(t?.entrypoint)return t.entrypoint}return s.STORIES_CREATOR_DEFAULT_CONFIG.entrypoint}},497036:(e,t,i)=>{i.d(t,{getStoriesPublishedCollectionStats:()=>r});var s=i(636039);function r(e){const{materials:t,stories:i,renderMaterialDurations:r,uploadMaterialDurations:o}=e;return t.map(((e,t)=>{const a=i[t],n=r[e.id]||0,c=o[e.id]||0;return{story:a,material:e,materialType:e.type||s.StoriesCreatorMaterialType.PHOTO,elapsedTime:n+c,width:a.clickable_stickers?.original_width||0,height:a.clickable_stickers?.original_height||0,videoDuration:a.video?.duration||0}}))}},291350:(e,t,i)=>{i.d(t,{getStoriesCreatorMergedEntrypoint:()=>r.getStoriesCreatorMergedEntrypoint,getStoriesPublishedCollectionStats:()=>o.getStoriesPublishedCollectionStats,storyPublisherEmitter:()=>s.storyPublisherEmitter});var s=i(265896),r=i(228615),o=i(497036)},422483:(e,t,i)=>{function s({multiple:e=!1,accept:t=""}){return new Promise((i=>{const s=document.createElement("input");s.type="file",s.multiple=e,s.accept=t,s.style.display="none",s.addEventListener("change",(e=>{const t=e.target.files;i(t?[...t]:[]),document.body.removeChild(s)}),{once:!0}),s.addEventListener("cancel",(()=>{i([]),document.body.removeChild(s)}),{once:!0}),document.body.appendChild(s),s.click()}))}i.d(t,{chooseFile:()=>s})},97650:(e,t,i)=>{let s;function r(e){return e&&"undefined"!=typeof window?(s||(s=document.createElement("textarea")),s.innerHTML=(e||"").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"),s.value.replace(/\t/g,"\n")):e}i.d(t,{unclean:()=>r})},562871:(e,t,i)=>{i.d(t,{AudioList:()=>l});var s=i(434518),r=i(763812),o=i(327813),a=i(702130),n=(0,r._)("_identity"),c=(0,r._)("_context"),d=(0,r._)("_getData"),h=(0,r._)("_attachContext");class l extends a.AudioList{get identity(){return(0,s._)(this,n)[n]}get context(){return(0,s._)(this,c)[c]}attachContext(e){const t=(0,s._)(this,h)[h];if(!t)throw new Error("Audio is not contextable");return t(e)}get data(){return(0,s._)(this,d)[d]()}get length(){return this.items.length}get type(){return this.data.type}audioAtStrict(e){const t=this.audioAt(e);if(!t)throw new Error("Audio not found");return t}getContextStrict(){const{context:e}=this;if(!e)throw new Error("AudioList is not contextual");return e}constructor(e){super(),Object.defineProperty(this,n,{writable:!0,value:void 0}),Object.defineProperty(this,c,{writable:!0,value:void 0}),Object.defineProperty(this,d,{writable:!0,value:void 0}),Object.defineProperty(this,h,{writable:!0,value:void 0}),(0,s._)(this,n)[n]=e.identity,(0,s._)(this,c)[c]=e.context,(0,s._)(this,d)[d]=e.getData,(0,s._)(this,h)[h]=e.attachContext,(0,o.makeObservable)(this)}}},138316:(e,t,i)=>{i.d(t,{LoadedAudioList:()=>c});var s=i(434518),r=i(763812),o=i(562871),a=(0,r._)("_attachContextToAudio"),n=(0,r._)("_createItems");class c extends o.AudioList{get isEmpty(){return!this.items.length}get head(){return this.items}audioAt(e){return this.items.at(e)}async fetchAt(e){return this.audioAtStrict(e)}async fetchNext(){return[]}constructor(e){super(e),Object.defineProperty(this,n,{value:d}),Object.defineProperty(this,a,{writable:!0,value:void 0}),(0,s._)(this,a)[a]=null,e.attachContextToAudio&&((0,s._)(this,a)[a]=e.attachContextToAudio),this.items=(0,s._)(this,n)[n](e.audios)}}function d(e){const t=[];let i;if(!e)return t;for(const r of e)i=r,!i.context.list&&(0,s._)(this,a)[a]&&(i=(0,s._)(this,a)[a](i,{...i.context,list:this})),t.push(i);return t}},678627:(e,t,i)=>{i.d(t,{GroupsProviderV2:()=>h});var s=i(331635),r=i(327813),o=i(962005),a=i(132028),n=i(662518),c=i(831197),d=i(511399);class h{getGroup(e){const t="number"==typeof e?e:this.data.screenNameToIdMap.get(e);if(t)return this.groupsStore.getGroup(t)}createGroupFromApi({apiGroup:e,fields:t=[]}){let i=(0,n.mapApiGroupToEntity)(e);"string"==typeof i.screen_name&&this.data.screenNameToIdMap.set(i.screen_name,i.id);const s=this.getGroup(i.id);if(s){const e=Object.keys(i),r=t.filter((t=>!e.includes(t)));i={...s,...i},Object.keys(i).forEach((e=>{r.includes(e)&&i.hasOwnProperty(e)&&delete i[e]}))}const r=this.data.fieldsMap.get(i.id),o=r?[...new Set([...t,...r])]:t;return this.groupsStore.setGroup(i),this.data.fieldsMap.set(i.id,o),i}async createGroup(e){const t=await this.groupsApi.create(e);return this.createGroupFromApi({apiGroup:t})}async fetchGroupsByIds(e,t){const{groupIds:i,fields:s=[],...r}=e,o=[...this.fetchGroupsRequiredFields,...s],a=await this.groupsApi.getById({...r,group_ids:i.join(","),fields:o.join(",")},t);(a.profiles||[]).forEach((e=>{this.profilesStore.setProfile(e)}));return(a.groups||[]).map((e=>this.createGroupFromApi({apiGroup:e,fields:o})))}async ensureFetchGroupById(e,t){const{groupId:i,fields:s=[]}=e,r=this.getGroup(i),o=this.data.fieldsMap.get(i)||[];if(!r||s.some((e=>!o.includes(e)))){return(await this.fetchGroupsByIds({groupIds:[i],fields:s},t)).find((e=>e.id===i))}return r}async fetchGroupsExtended(e,{controller:t}={}){const i=await this.groupsApi.get({...e,extended:1},{signal:t?.signal}),s=i.items.map((t=>{const i=e.fields?.split(",")||[],s=[...new Set([...Object.keys(t),...i])];return this.createGroupFromApi({apiGroup:t,fields:s})}));return{...i,items:s}}async groupEdit(e,{controller:t,updateGroup:i=!0}={}){const s=e.group_id;if(!this.getGroup(s)&&i)return null;if(await this.groupsApi.edit(e,{signal:t?.signal}),!i)return null;const[r]=await this.fetchGroupsByIds({groupIds:[s]});return r}getProfile(e){return this.profilesStore.getProfile(e)}async getBlockedGroupInfo(e){return this.groupsApi.getBlockedInfo(e)}async unblockGroup(e){return this.groupsApi.unblock(e)}constructor(e,t,i){this.groupsApi=e,this.groupsStore=t,this.profilesStore=i,this.fetchGroupsRequiredFields=["is_member","member_status","is_closed"],this.data={fieldsMap:new Map,screenNameToIdMap:new Map},(0,r.makeAutoObservable)(this)}}h=(0,s.__decorate)([a.scope.global(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===o.GroupsApi?Object:o.GroupsApi,void 0===c.GroupsStore?Object:c.GroupsStore,void 0===d.ProfilesStore?Object:d.ProfilesStore])],h)},511399:(e,t,i)=>{i.d(t,{ProfilesStore:()=>a});var s=i(331635),r=i(132028),o=i(327813);class a{getProfile(e){if(e)return this.data.profilesMap.get(e)}setProfile(e){this.data.profilesMap.set(e.id,e)}constructor(){this.data={profilesMap:new Map},(0,o.makeAutoObservable)(this)}}a=(0,s.__decorate)([r.scope.global(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[])],a)},563412:(e,t,i)=>{i.d(t,{SituationalSuggestsProvider:()=>d});var s=i(331635),r=i(132028),o=i(927587),a=i(327813),n=i(939446),c=i(450554);class d{ensure(e){const t=this.getKeyByParams(e);if(this.cachedInstances[t])return this.cachedInstances[t];const i=Object.keys(this.cachedInstances);return i.length===c.MAX_CACHE_LENGTH&&delete this.cachedInstances[i[0]],this.cachedInstances[t]=new n.SituationalSuggestsInstance(this.situationalSuggestsApi,e),this.cachedInstances[t]}getKeyByParams(e){const{themeIds:t=[],fields:i=[],extended:s}=e;return t.concat(i,String(s||"")).filter(Boolean).join(",")}constructor(e){this.situationalSuggestsApi=e,this.cachedInstances={},(0,a.makeAutoObservable)(this)}}d=(0,s.__decorate)([r.scope.container(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===o.SituationalSuggestsApi?Object:o.SituationalSuggestsApi])],d)},450554:(e,t,i)=>{i.d(t,{MAX_CACHE_LENGTH:()=>s});const s=20},939446:(e,t,i)=>{i.d(t,{SituationalSuggestsInstance:()=>r});var s=i(327813);class r{fetch(){return this.loadingPromise||(this.loadingPromise=this.getDataPromise()),this.loadingPromise}async ensure(){return"done"===this.state?this.data:this.fetch()}async getDataPromise(){const{themeIds:e,fields:t,extended:i}=this.params;if(e?.length)try{this.state="loading";const s=await this.situationalSuggestsApi.getById({extended:i,theme_ids:e.join(","),fields:t?.join(",")});return this.state="done",this.data=s,this.data}catch(e){throw this.state="error",e}finally{this.loadingPromise=void 0}}constructor(e,t){this.situationalSuggestsApi=e,this.params=t,this.data=void 0,this.state="initial",this.loadingPromise=void 0,(0,s.makeAutoObservable)(this)}}},630186:(e,t,i)=>{i.d(t,{MediaFocusStoriesChannel:()=>l});var s=i(434518),r=i(763812),o=i(331635),a=i(132028),n=i(230414),c=(0,r._)("_channel"),d=(0,r._)("_actions"),h=(0,r._)("_ensureActions");class l{setActions(e){(0,s._)(this,d)[d]=e}get id(){return(0,s._)(this,c)[c].id}get mediaSession(){return(0,s._)(this,c)[c].mediaSession}get active(){return(0,s._)(this,c)[c].active}start(){return(0,s._)(this,c)[c].start()}stop(){return(0,s._)(this,c)[c].stop()}constructor(e){Object.defineProperty(this,h,{value:u}),Object.defineProperty(this,c,{writable:!0,value:void 0}),Object.defineProperty(this,d,{writable:!0,value:void 0}),(0,s._)(this,d)[d]=null,(0,s._)(this,c)[c]=e.createChannel("stories",{pause:()=>(0,s._)(this,h)[h]().pause(),resume:()=>(0,s._)(this,h)[h]().resume()})}}function u(){if(!(0,s._)(this,d)[d])throw new Error("Actions are not set. Forgot to call setActions?");return(0,s._)(this,d)[d]}l=(0,o.__decorate)([a.scope.global(),(0,o.__metadata)("design:type",Function),(0,o.__metadata)("design:paramtypes",[void 0===n.MediaFocus?Object:n.MediaFocus])],l)},422027:(e,t,i)=>{i.d(t,{StoriesOwnerService:()=>d});var s=i(331635),r=i(132028),o=i(468073),a=i(327813),n=i(678627),c=i(886837);class d{setGroup(e,t){this.groupsProvider.createGroupFromApi({apiGroup:e,fields:t})}setGroups(e,t){e.forEach((e=>{this.setGroup(e,t)}))}setUser(e,t){const i=this.usersProvider.createUserFromApiData({data:e,fields:t},!1);this.data.users.set(i.id,i.data)}setUsers(e,t){e.forEach((e=>{this.setUser(e,t)}))}addCreatedUser(e){this.data.users.set(e.id,e)}getOwnerById(e){if(o.Ranges.isGroupId(e)){const t=o.Ranges.convertOwnerIdToGroupId(e);return this.groupsProvider.getGroup(t)??null}return this.data.users.get(e)??null}constructor(e,t){this.groupsProvider=e,this.usersProvider=t,this.data={users:new Map},(0,a.makeAutoObservable)(this)}}d=(0,s.__decorate)([r.scope.container(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===n.GroupsProviderV2?Object:n.GroupsProviderV2,void 0===c.UserInstancesProvider?Object:c.UserInstancesProvider])],d)},199484:(e,t,i)=>{i.d(t,{StoriesProvider:()=>d});var s=i(331635),r=i(132028),o=i(746310),a=i(327813),n=i(466375),c=i(422027);class d{createStoryFromApi(e){const t=new n.Story(e,this.ownersService);return this.cacheMap.set(t.createRawId(),t),t}createStoriesFromApi(e){return e.reduce(((e,t)=>[...e,this.createStoryFromApi(t)]),[])}getStory(e){return this.cacheMap.get(e)}async fetch(e,t={}){const i=await this.storiesApi.getById({...e,extended:1},t),s=(e.fields||"").split(","),{items:r,groups:o,profiles:a}=i;return o&&this.ownersService.setGroups(o,s),a&&this.ownersService.setUsers(a,s),this.createStoriesFromApi(r)}constructor(e,t){this.storiesApi=e,this.ownersService=t,this.cacheMap=new Map,(0,a.makeAutoObservable)(this)}}d=(0,s.__decorate)([r.scope.container(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===o.StoriesApi?Object:o.StoriesApi,void 0===c.StoriesOwnerService?Object:c.StoriesOwnerService])],d)},465472:(e,t,i)=>{i.d(t,{StoriesSearchListProvider:()=>l});var s=i(331635),r=i(132028),o=i(327813),a=i(487067),n=i(746310),c=i(627876),d=i(877897),h=i(83833);class l{getKeyByParams(e){return(0,d.getKeyByParams)(e)}ensureList(e){const t=this.getKeyByParams(e);this.searchLists[t]||(this.searchLists[t]=new a.StoriesSearchList(this.storiesApi,this.statLog,e));const i=Object.keys(this.searchLists);if(i.length>h.MAX_CACHE_LENGTH){const e=i.find((e=>e!==t));e&&this.searchLists.hasOwnProperty(e)&&delete this.searchLists[e]}return this.searchLists[t].search}constructor(e,t){this.storiesApi=e,this.statLog=t,this.searchLists={},(0,o.makeAutoObservable)(this)}}l=(0,s.__decorate)([r.scope.global(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===n.StoriesApi?Object:n.StoriesApi,void 0===c.Statlog?Object:c.Statlog])],l)},466375:(e,t,i)=>{i.d(t,{Story:()=>o});var s=i(873900),r=i(327813);class o{get data(){return this._data}get owner(){return this.ownerService.getOwnerById(this._data.owner_id)}createRawId(){return(0,s.getIdentityRawId)({id:this.data.id,ownerId:this.data.owner_id})}get videoDuration(){return this._data.video?.duration||0}constructor(e,t){this._data=e,this.ownerService=t,(0,r.makeAutoObservable)(this)}}},886837:(e,t,i)=>{i.d(t,{UserInstancesProvider:()=>d});var s=i(331635),r=i(327813),o=i(488709),a=i(132028),n=i(136113),c=i(210388);class d{createUserFromApiData(e,t){const i=new n.UserInstance(e);return t&&(this._cacheByIds.set(i.data.id,i),i.data.domain&&this._cacheByDomains.set(i.data.domain,i.data.id)),i}async fetch({user_ids:e,domains:t,fields:i=[],usePrefetch:s=!1,...r}={},o){const a=Array.from(new Set(i)),n=Array.from(new Set(e)),c=Array.from(new Set(t));if(n.length||c.length){const t=r;e?.length&&(t.user_ids=e.join(",")),c?.length&&(t.domains=c.join(",")),a?.length&&(t.fields=a.join(","));const i=(await(s?this.usersApi.getWithPrefetch:this.usersApi.get)(t,o)).filter(Boolean).map((e=>({data:e,fields:a})));return this.addToCache(i,!0)}return this.getCachedUsers({ids:n,domains:c})}async ensure({user_ids:e,domains:t,fields:i=[],...s}={},r){const o=Array.from(new Set(e)),a=Array.from(new Set(t)),n=o.reduce(((e,t)=>(this.isInfoMissing(t,i)&&e.push(t),e)),[]),c=a.reduce(((e,t)=>{const s=this._cacheByDomains.get(t);return s&&this.isInfoMissing(s,i)&&e.push(t),e}),[]);return n.length||c.length?await this.fetch({user_ids:n,domains:c,fields:i,usePrefetch:!0,...s},r):this.getCachedUsers({ids:o,domains:a})}getCachedUsers({ids:e=[],domains:t=[]}){const i=new Map;return new Set([...e,...t.reduce(((e,t)=>{const i=this._cacheByDomains.get(t);return i&&e.push(i),e}),[])]).forEach((e=>{const t=this._cacheByIds.get(e);t&&i.set(e,t)})),i}addToCache(e,t=!0){const i=new Map;return e.forEach((e=>{const s=e.data.id,r=this._cacheByIds.get(s);r&&!t||(r?.data?.domain&&r.data.domain!==e.data.domain&&this._cacheByDomains.delete(r.data.domain),i.set(s,this.createUserFromApiData(e,!0)))})),i}isInfoMissing(e,t){const i=this._cacheByIds.get(e);return!i||!(0,c.isEnoughInfo)(i,t)}constructor(e){this.usersApi=e,this._cacheByIds=new Map,this._cacheByDomains=new Map,(0,r.makeAutoObservable)(this)}}d=(0,s.__decorate)([a.scope.container(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===o.UsersApi?Object:o.UsersApi])],d)},136113:(e,t,i)=>{i.d(t,{UserInstance:()=>r});var s=i(327813);class r{get fields(){return Array.from(this._fields.values())}get id(){return this.data.id}get data(){return this._data}async fetch({fields:e=[],...t}={},i){if(!this.usersApi)throw new Error("UsersApi instance is not provided");const s=Array.from(new Set([...e,...this.fields]).values()),[r]=await this.usersApi.get({user_ids:this.id.toString(),fields:s.join(","),name_case:"Nom",...t},i);if(!r)throw new Error("Could not fetch data for user, empty data was returned");return this.setData({data:r,fields:s}),this.data}setFields(e){this._fields.clear(),new Set(e).forEach((e=>this._fields.add(e)))}setData(e){const{data:t,fields:i=[]}=e;if(t.id!==this.id)throw new Error("Trying to change id of an existing User instance");this._data=t,this.setFields([...i])}constructor(e,t){this.usersApi=t,this._fields=new Set;const{data:i,fields:r=[]}=e;this._data=i,this.setFields([...r]),(0,s.makeAutoObservable)(this)}}},210388:(e,t,i)=>{i.d(t,{isEnoughInfo:()=>s});const s=(e,t=[])=>{const i=new Set(e.fields);return new Set([...e.fields,...t]).size===i.size}},852487:(e,t,i)=>{i.d(t,{VideoPlayerConfigProvider:()=>c});var s=i(331635),r=i(327813),o=i(882044),a=i(955060),n=i(132028);class c{isLoading(e){return Boolean(this.requestMap.get(e))}async request({prefetch:e,...t}){this.abortController=new AbortController;return(e?this.videoApi.getPlayerConfigWithPrefetch:this.videoApi.getPlayerConfig)(t,{signal:this.abortController?.signal})}async fetch(e){this.reset();try{const t=await this.request(e);return this.configMap.set(e.module,t.config),t.config}catch(e){return this.errorLogger.log(new Error("Video player config fetching failed",{cause:e})),{}}finally{this.requestMap.delete(e.module)}}async ensure(e){const t=this.requestMap.get(e.module);if(t)return t;const i=this.configMap.get(e.module);if(i)return i;const s=this.fetch(e);return this.requestMap.set(e.module,s),s}reset(){this.abortController?.abort()}constructor(e,t){this.videoApi=e,this.errorLogger=t,this.abortController=null,this.configMap=new Map,this.requestMap=new Map,(0,r.makeAutoObservable)(this)}}c=(0,s.__decorate)([n.scope.global(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===o.VideoApi?Object:o.VideoApi,void 0===a.ErrorLogger?Object:a.ErrorLogger])],c)},655758:(e,t,i)=>{i.d(t,{ProductionStats:()=>a});var s=i(331635),r=i(132028),o=i(422057);class a extends o.AnalyticsStats{getLastEvent(){return this.lastEvent}send(e,t){const i={...e,id:this.getIntId(),prev_id:this.getLastEvent()?.id,prev_nav_id:this.getIntId()??0,prev_event_id:this.getLastEvent()?.prev_nav_id??0,timestamp:this.getCurrentTime(),url:window.location.href};this.analytics.sendProductionStats(i,t),this.lastEvent=i}}a=(0,s.__decorate)([r.scope.global()],a)},245549:(e,t,i)=>{i.d(t,{StoryViewStats:()=>a});var s=i(331635),r=i(132028),o=i(668965);class a extends o.AnalyticsStats{send(e){this.analytics.sendStoryViewStats(e)}}a=(0,s.__decorate)([r.scope.global()],a)},591301:(e,t,i)=>{i.d(t,{LikesApi:()=>a});var s=i(331635),r=i(132028),o=i(641569);class a extends o.ApiNamespace{get namespace(){return"likes"}constructor(...e){super(...e),this.add=this.makeMethod("add"),this.delete=this.makeMethod("delete"),this.getList=this.makeMethod("getList"),this.isLiked=this.makeMethod("isLiked")}}a=(0,s.__decorate)([r.scope.global()],a)},740177:(e,t,i)=>{i.d(t,{MessagesApi:()=>a});var s=i(331635),r=i(132028),o=i(641569);class a extends o.ApiNamespace{get namespace(){return"messages"}constructor(...e){super(...e),this.getCallParticipants=this.makeMethod("getCallParticipants"),this.getCallPreview=this.makeMethod("getCallPreview"),this.getCurrentCalls=this.makeMethod("getCurrentCalls"),this.getInboundCalls=this.makeMethod("getInboundCalls"),this.searchConversations=this.makeMethod("searchConversations"),this.searchConversationMembers=this.makeMethod("searchConversationMembers"),this.getConversations=this.makeMethod("getConversations"),this.getGroupsForCall=this.makeMethod("getGroupsForCall"),this.getConversationMembers=this.makeMethod("getConversationMembers"),this.editCall=this.makeMethod("editCall"),this.getScheduledCalls=this.makeMethod("getScheduledCalls"),this.getConversationsById=this.makeMethod("getConversationsById"),this.deleteScheduledCall=this.makeMethod("deleteScheduledCall"),this.vkRoomsJoinCall=this.makeMethod("vkRoomsJoinCall"),this.send=this.makeMethod("send"),this.sendReaction=this.makeMethod("sendReaction"),this.deleteReaction=this.makeMethod("deleteReaction"),this.forceCallFinish=this.makeMethod("forceCallFinish"),this.denyMessagesFromGroup=this.makeMethod("denyMessagesFromGroup"),this.allowMessagesFromGroup=this.makeMethod("allowMessagesFromGroup"),this.getHistoryAttachments=this.makeMethod("getHistoryAttachments"),this.getById=this.makeMethod("getById"),this.getReactionsAssets=this.makeMethod("getReactionsAssets"),this.getChatPreview=this.makeMethod("getChatPreview")}}a=(0,s.__decorate)([r.scope.global()],a)},734979:(e,t,i)=>{i.d(t,{PollsApi:()=>a});var s=i(331635),r=i(641569),o=i(132028);class a extends r.ApiNamespace{get namespace(){return"polls"}constructor(...e){super(...e),this.getBackgrounds=this.makeMethod("getBackgrounds"),this.getAnswersLimit=this.makeMethod("getAnswersLimit"),this.create=this.makeMethod("create"),this.edit=this.makeMethod("edit"),this.getById=this.makeMethod("getById"),this.addVote=this.makeMethod("addVote"),this.deleteVote=this.makeMethod("deleteVote")}}a=(0,s.__decorate)([o.scope.global()],a)},927587:(e,t,i)=>{i.d(t,{SituationalSuggestsApi:()=>a});var s=i(331635),r=i(641569),o=i(132028);class a extends r.ApiNamespace{get namespace(){return"situationalSuggests"}constructor(...e){super(...e),this.getById=this.makeMethod("getById")}}a=(0,s.__decorate)([o.scope.global()],a)},786686:(e,t,i)=>{i.d(t,{getOwnerName:()=>s});const s=(e,t=!0,i)=>{let s="";return e&&("name"in e?s=e.name||"":!t&&"first_name"in e?s=i?e[`first_name_${i}`]||"":e.first_name||"":("first_name"in e||"last_name"in e)&&(s=i?`${e[`first_name_${i}`]} ${e[`last_name_${i}`]}`:`${e.first_name} ${e.last_name}`)),s}},928178:(e,t,i)=>{i.d(t,{AVAILABLE_IMAGE_MIME_TYPES:()=>c,AVAILABLE_VIDEO_MIME_TYPES:()=>h,AVAILABLE_VIDEO_MIME_TYPES_WITH_PARAMS:()=>d,COLUMN_PADDING_WEB:()=>k,COLUMN_RIGHT_WIDTH_WEB:()=>I,FALLBACK_COLOR:()=>v,FOOTER_HEIGHT_WEB:()=>E,MATERIAL_PREVIEW_SIZE_MVK:()=>_,MATERIAL_PREVIEW_SIZE_WEB:()=>w,MAX_MODAL_HEIGHT_WEB:()=>L,MAX_TEXT_LAYER_WIDTH_KOEF:()=>u,MIN_MODAL_HEIGHT_WEB:()=>b,MVK_OVERLAY_TEXTAREA_PADDING_LEFT:()=>g,MVK_OVERLAY_TEXTAREA_PADDING_RIGHT:()=>m,MVK_OVERLAY_TEXTAREA_PADDING_TOP:()=>y,NARRATIVE_MAX_TITLE_LENGTH:()=>o,PHOTO_EDITOR_SDK_DOCUMENT_BACKGROUND:()=>f,SPACING_FOOTER_WEB:()=>A,STORIES_CREATOR_ACTIVE_CAMERA_STORAGE_KEY:()=>a,STORIES_CREATOR_DEFAULT_CONFIG:()=>p,STORIES_CREATOR_PRIVACY_STORAGE_KEY:()=>n,TEXT_SIZE_KOEF:()=>l});var s=i(351118),r=i(675020);const o=23,a="stories-creator-active-camera",n="stories-creator-privacy",c=["image/png","image/jpeg","image/heic","image/heif","image/gif","image/webp","image/jpg"],d=["video/webm;codecs=vp8,opus","video/webm;codecs=vp9,opus","video/webm;codecs=h264,opus","video/webm;codecs=av01,opus","video/mp4;codecs=h264,aac","video/mp4;codecs=avc1,mp4a.40.2","video/mp4","video/mpeg","video/quicktime"],h=(0,s.uniqueArray)(d.map((e=>e.split(";")[0]))),l=2.82,u=.72,S=[{background:"#ffffff"},{background:"#181919"},{background:"#afa399"},{background:"#585f67"},{background:"#dad1ca"},{background:"#3f8ae0"},{background:"#22bdba"},{background:"#fac725"},{background:"#ff5773"},{background:"#a393f5"},{background:"#925cff"},{background:"#fa60a3"},{background:"#ff8000"},{background:"#b1e718"},{background:"#7ad3ff"}],v="#585F67",p={entrypoint:"link",navScreen:"",platform:r.StoriesCreatorPlatform.MVK,maxStoriesCount:10,workspace:{artBoardRatio:9/16},picker:{isEnabled:!0,mediaStreamExactConstraints:[1920,1280,854,640,426,256],devicePixelRatio:window?.devicePixelRatio||1},editor:{stickers:{text:{isEnabled:!0},vk:{isEnabled:!0},mention:{isEnabled:!0},link:{isEnabled:!0},photo:{isEnabled:!0,borderRadius:40},hashtag:{isEnabled:!0},poll:{isEnabled:!0},place:{isEnabled:!0},opinion:{isEnabled:!0},time:{isEnabled:!0},music:{isEnabled:!0},product:{isEnabled:!0},service:{isEnabled:!0},post:{isEnabled:!0,horizontalBorderGap:120,defaultBackgroundColor:"#333333"}},text:{isEnabled:!0,colors:S,defaultLightColor:S[0].background,defaultBlackColor:S[1].background,defaultFont:{fontFamily:"sans-serif"},defaultFontSize:36,fonts:[{label:"Без засечек",fontFamily:"sans-serif"},{label:"С засечками",fontFamily:"serif"}],fontSizeOptions:[12,16,20,24,32,36,40,48,64],minFontSize:12,maxFontSize:128,wysiwygMaxLength:2500},drawing:{isEnabled:!0,colors:S},backgroundSelect:{isEnabled:!0,blurEnabled:!0,backgrounds:[],colors:S},lifetimeSelect:{isEnabled:!0},bestFriendsSelect:{isEnabled:!0},hiddenFromFriendsSelect:{isEnabled:!0},ordSelect:{isEnabled:!0},addFrameAction:{isEnabled:!0},saveAction:{isEnabled:!0},settingsAction:{isEnabled:!0}},photoStory:{isEnabled:!0,maxFileSize:10485760,documentWidth:1080,documentHeight:1920,renderScale:1},videoStory:{isEnabled:!0,minDuration:1,maxDuration:60,maxFileSize:104857600},prefabs:[],close:()=>!0},y=60,g=30,m=30,_={width:32,height:44},w={width:24,height:36},f="#3a3a3a",E=40,A=8,k=8,I=320,b=610,L=950},675020:(e,t,i)=>{i.d(t,{StoriesCreatorPlatform:()=>s});var s=function(e){return e.MVK="mvk",e.WEB="web",e}({})},636039:(e,t,i)=>{i.d(t,{StoriesCreatorMaterialType:()=>s});var s=function(e){return e.PHOTO="photo",e.VIDEO="video",e}({})},319579:(e,t,i)=>{i.d(t,{getFileAccept:()=>o});var s=i(928178),r=i(636039);function o(e){switch(e){case r.StoriesCreatorMaterialType.PHOTO:return s.AVAILABLE_IMAGE_MIME_TYPES;case r.StoriesCreatorMaterialType.VIDEO:return s.AVAILABLE_VIDEO_MIME_TYPES;default:return[...s.AVAILABLE_IMAGE_MIME_TYPES,...s.AVAILABLE_VIDEO_MIME_TYPES]}}},591269:(e,t,i)=>{i.d(t,{getPrefabsFromFileSystem:()=>o});var s=i(422483),r=i(319579);async function o(){const e=(0,r.getFileAccept)().join(",");return(await(0,s.chooseFile)({multiple:!0,accept:e})).map((e=>({source:e})))}},530451:(e,t,i)=>{i.d(t,{stickerContainerTypeGuard:()=>s});const s=e=>e.some((e=>"native"===e.sticker_type||"renderable"===e.sticker_type))},875216:(e,t,i)=>{i.d(t,{MemoryStory:()=>r});var s=i(203862);class r extends s.StoryBoxJSON{getStructure(){return{sticker_type:"native",sticker:{can_delete:!1,action_type:"story",action:{story_id:this.storyId,show_author:!1}}}}constructor(e){super(),this.storyId=e}}},85228:(e,t,i)=>{i.d(t,{MemoryStoryDate:()=>o});var s=i(203862),r=i(265522);class o extends s.StoryBoxJSON{getStructure(){return{sticker_type:"native",sticker:{action_type:"text",can_delete:!0,transform:{gravity:"center_bottom",translation_y:-.08},action:{text:(0,r.formatDateForCardDateBadge)(this.dateOrTimestamp,this.getTodayLabel,this.getYesterdayLabel,this.getExactDateLabel,this.getYearsAgoLabel),alignment:"center",font_size:70,selection_color:"#FFFFFF"}}}}constructor(e,t,i,s,r){super(),this.dateOrTimestamp=e,this.getTodayLabel=t,this.getYesterdayLabel=i,this.getExactDateLabel=s,this.getYearsAgoLabel=r}}},203862:(e,t,i)=>{i.d(t,{StoryBoxJSON:()=>s});class s{}},265522:(e,t,i)=>{i.d(t,{formatDateForCardDateBadge:()=>l});var s=i(312378),r=i(546379);const o=1e3,a=31536e3,n=1e3,c=3600;function d(e,t,i,o,a){if(t){if((0,s.isDateToday)(e))return i();if((0,r.isDateYesterday)(e))return o()}return a(e.getDate(),e.getMonth(),e.getFullYear())}function h(e,t,i,s,r){const n=new Date,c=(h=n,l=e,Math.round(Math.abs(h.getTime()-l.getTime())/o/a));var h,l;return c<1?d(e,!0,t,i,s):r(c)}function l(e,t,i,s,r){const a=e instanceof Date?e:new Date(e*o);return function(e){const t=new Date(1e3*e),i=new Date;i.setMonth(t.getMonth(),t.getDate()),i.setHours(0,0,0,0);const s=Math.abs(Date.now()-i.valueOf())/n/c;return s>0&&s<48}(a.valueOf()/o)?function(e,t,i,s){return d(e,!1,t,i,s)}(a,t,i,s):h(a,t,i,s,r)}},159391:(e,t,i)=>{function s(e){const t=String(e.getDate()).padStart(2,"0"),i=String(e.getMonth()+1).padStart(2,"0");return`${e.getFullYear()}-${i}-${t}`}i.d(t,{formatDateToYYYYMMDD:()=>s})},312378:(e,t,i)=>{i.d(t,{isDateToday:()=>s});const s=e=>{const t=new Date,i=t.getDate(),s=t.getMonth(),r=t.getFullYear();return e.getFullYear()===r&&e.getMonth()===s&&e.getDate()===i}},546379:(e,t,i)=>{i.d(t,{isDateYesterday:()=>r});var s=i(312378);const r=e=>{const t=new Date(e.getTime()+864e5);return(0,s.isDateToday)(t)}},379411:(e,t,i)=>{function s(e,...t){const i=(e,t)=>{if(e&&t&&"object"==typeof t)for(const s in t)s in e?Array.isArray(e[s])&&Array.isArray(t[s])?e[s]=t[s]:"object"==typeof e[s]&&"object"==typeof t[s]?i(e[s],t[s]):e[s]=t[s]:e[s]=t[s]};for(let s of t)i(e,s);return e}i.d(t,{defaultsDeep:()=>s})},472641:(e,t,i)=>{i.d(t,{default:()=>s});const s=function(e,t){for(var i=-1,s=null==e?0:e.length;++i<s&&!1!==t(e[i],i,e););return e}},424285:(e,t,i)=>{i.d(t,{default:()=>o});var s=i(322031),r=i(327422);const o=function(e,t){return e&&(0,s.default)(t,(0,r.default)(t),e)}},763374:(e,t,i)=>{i.d(t,{default:()=>o});var s=i(322031),r=i(241865);const o=function(e,t){return e&&(0,s.default)(t,(0,r.default)(t),e)}},619007:(e,t,i)=>{i.d(t,{default:()=>T});var s=i(93265),r=i(472641),o=i(652851),a=i(424285),n=i(763374),c=i(180154),d=i(939759),h=i(657087),l=i(658340),u=i(719042),S=i(883973),v=i(935861),p=i(694573),y=i(866431),g=i(632729),m=i(292049),_=i(74616),w=i(429378),f=i(523149),E=i(222424),A=i(327422),k=i(241865),I="[object Arguments]",b="[object Function]",L="[object Object]",P={};P[I]=P["[object Array]"]=P["[object ArrayBuffer]"]=P["[object DataView]"]=P["[object Boolean]"]=P["[object Date]"]=P["[object Float32Array]"]=P["[object Float64Array]"]=P["[object Int8Array]"]=P["[object Int16Array]"]=P["[object Int32Array]"]=P["[object Map]"]=P["[object Number]"]=P[L]=P["[object RegExp]"]=P["[object Set]"]=P["[object String]"]=P["[object Symbol]"]=P["[object Uint8Array]"]=P["[object Uint8ClampedArray]"]=P["[object Uint16Array]"]=P["[object Uint32Array]"]=!0,P["[object Error]"]=P[b]=P["[object WeakMap]"]=!1;const T=function e(t,i,T,V,O,C){var M,R=1&i,N=2&i,D=4&i;if(T&&(M=O?T(t,V,O,C):T(t)),void 0!==M)return M;if(!(0,f.default)(t))return t;var F=(0,m.default)(t);if(F){if(M=(0,p.default)(t),!R)return(0,d.default)(t,M)}else{var x=(0,v.default)(t),j=x==b||"[object GeneratorFunction]"==x;if((0,_.default)(t))return(0,c.default)(t,R);if(x==L||x==I||j&&!O){if(M=N||j?{}:(0,g.default)(t),!R)return N?(0,l.default)(t,(0,n.default)(M,t)):(0,h.default)(t,(0,a.default)(M,t))}else{if(!P[x])return O?t:{};M=(0,y.default)(t,x,R)}}C||(C=new s.default);var U=C.get(t);if(U)return U;C.set(t,M),(0,E.default)(t)?t.forEach((function(s){M.add(e(s,i,T,s,t,C))})):(0,w.default)(t)&&t.forEach((function(s,r){M.set(r,e(s,i,T,r,t,C))}));var B=D?N?S.default:u.default:N?k.default:A.default,G=F?void 0:B(t);return(0,r.default)(G||t,(function(s,r){G&&(s=t[r=s]),(0,o.default)(M,r,e(s,i,T,r,t,C))})),M}},617764:(e,t,i)=>{i.d(t,{default:()=>o});var s=i(935861),r=i(753098);const o=function(e){return(0,r.default)(e)&&"[object Map]"==(0,s.default)(e)}},624566:(e,t,i)=>{i.d(t,{default:()=>o});var s=i(935861),r=i(753098);const o=function(e){return(0,r.default)(e)&&"[object Set]"==(0,s.default)(e)}},875641:(e,t,i)=>{i.d(t,{default:()=>r});var s=i(690565);const r=function(e,t){var i=t?(0,s.default)(e.buffer):e.buffer;return new e.constructor(i,e.byteOffset,e.byteLength)}},862113:(e,t,i)=>{i.d(t,{default:()=>r});var s=/\w*$/;const r=function(e){var t=new e.constructor(e.source,s.exec(e));return t.lastIndex=e.lastIndex,t}},61496:(e,t,i)=>{i.d(t,{default:()=>a});var s=i(700241),r=s.default?s.default.prototype:void 0,o=r?r.valueOf:void 0;const a=function(e){return o?Object(o.call(e)):{}}},657087:(e,t,i)=>{i.d(t,{default:()=>o});var s=i(322031),r=i(214792);const o=function(e,t){return(0,s.default)(e,(0,r.default)(e),t)}},658340:(e,t,i)=>{i.d(t,{default:()=>o});var s=i(322031),r=i(283511);const o=function(e,t){return(0,s.default)(e,(0,r.default)(e),t)}},883973:(e,t,i)=>{i.d(t,{default:()=>a});var s=i(833831),r=i(283511),o=i(241865);const a=function(e){return(0,s.default)(e,o.default,r.default)}},283511:(e,t,i)=>{i.d(t,{default:()=>n});var s=i(976912),r=i(315647),o=i(214792),a=i(613153);const n=Object.getOwnPropertySymbols?function(e){for(var t=[];e;)(0,s.default)(t,(0,o.default)(e)),e=(0,r.default)(e);return t}:a.default},694573:(e,t,i)=>{i.d(t,{default:()=>r});var s=Object.prototype.hasOwnProperty;const r=function(e){var t=e.length,i=new e.constructor(t);return t&&"string"==typeof e[0]&&s.call(e,"index")&&(i.index=e.index,i.input=e.input),i}},866431:(e,t,i)=>{i.d(t,{default:()=>c});var s=i(690565),r=i(875641),o=i(862113),a=i(61496),n=i(801801);const c=function(e,t,i){var c=e.constructor;switch(t){case"[object ArrayBuffer]":return(0,s.default)(e);case"[object Boolean]":case"[object Date]":return new c(+e);case"[object DataView]":return(0,r.default)(e,i);case"[object Float32Array]":case"[object Float64Array]":case"[object Int8Array]":case"[object Int16Array]":case"[object Int32Array]":case"[object Uint8Array]":case"[object Uint8ClampedArray]":case"[object Uint16Array]":case"[object Uint32Array]":return(0,n.default)(e,i);case"[object Map]":case"[object Set]":return new c;case"[object Number]":case"[object String]":return new c(e);case"[object RegExp]":return(0,o.default)(e);case"[object Symbol]":return(0,a.default)(e)}}},720903:(e,t,i)=>{i.d(t,{default:()=>r});var s=i(619007);const r=function(e){return(0,s.default)(e,5)}},429378:(e,t,i)=>{i.d(t,{default:()=>n});var s=i(617764),r=i(552789),o=i(364841),a=o.default&&o.default.isMap;const n=a?(0,r.default)(a):s.default},222424:(e,t,i)=>{i.d(t,{default:()=>n});var s=i(624566),r=i(552789),o=i(364841),a=o.default&&o.default.isSet;const n=a?(0,r.default)(a):s.default}}]),"undefined"!=typeof window&&window.stManager?.done?.("dist/web/chunks/f9803d10.18598c75.js")}catch(e){throw"undefined"!=typeof window&&window.stManager?.fail?.("dist/web/chunks/f9803d10.18598c75.js",e),e}