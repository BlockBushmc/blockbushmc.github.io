try{(self.webpackChunkvk=self.webpackChunkvk||[]).push([[43877],{446362:(t,e,s)=>{s.d(e,{Y1:()=>i,nS:()=>n,yf:()=>r});var i=function(t){return t.UGC="stickers.ugc",t.PROMO_VMOJI_COUNTER="vmoji.promo.avatar_suggestion.promo_counter",t.NEW_STICKER_PICKER="new_sticker_picker",t}({});function r(){return!0}function n(){return!0}},541832:(t,e,s)=>{s.d(e,{H:()=>r});var i=s(9467);function r(){return(0,i.AW)("vas_gift_modal_spa")}},141789:(t,e,s)=>{s.d(e,{E:()=>c});var i=s(77783),r=s(666861),n=s(59467);class o extends n.s{async get(){const t=this.getKey();try{return await(0,i.Jt)(t,this.base.store)||this.cache||null}catch(e){return console.log(`${t}: Ошибка чтения данных из хранилища`),console.log(e),this.cache||null}}async set(t,e){const s=this.getKey();try{await(0,i.hZ)(s,t,this.base.store)}catch(e){console.log(`${s}: Не удалось записать данные в хранилище`),console.log(e),this.cache=t}super.set(t,e)}async delete(){const t=this.getKey();delete this.cache;try{await(0,i.yH)(t,this.base.store),this.base.notify(this.key)}catch(e){console.log(`${t}: Ошибка удаления ключа из хранилища`),console.log(e)}}constructor(t){super(t);const{base:e}=t;this.base=e}}class a extends r.i{createAtom(t){return new o({key:t,base:this})}async clear(){await(0,i.IU)(this.store),this.notify()}constructor(t){super(t);const{dbName:e,version:s}=t;try{this.store=(0,i.y$)(`${e}-v${s}`,e)}catch{}}}function c(t){return new a(t)}},59467:(t,e,s)=>{s.d(e,{s:()=>i});class i{set(t,{notify:e=!0}={}){e&&this.base.notify(this.key)}getKey(){return`${this.base.options.storeName}-${this.key}`}constructor({key:t,base:e}){this.key=t,this.base=e}}},666861:(t,e,s)=>{s.d(e,{i:()=>i});class i{subscribe(t,e){const s=this.getListeners(e);return s.add(t),()=>{s.delete(t)}}notify(t,e){this.getListeners(e).forEach((e=>{e(t)}))}refresh(){try{localStorage.setItem(this.key,""),localStorage.removeItem(this.key)}catch{}}destroy(){this.listeners.clear(),this.syncListeners.clear(),i.instances.delete(this.key)}get key(){const{dbName:t,storeName:e,version:s}=this.options;return`${t}-v${s}-${e}`}getListeners(t){return t?this.syncListeners:this.listeners}constructor(t){this.listeners=new Set,this.syncListeners=new Set,this.options=t,i.instances.set(this.key,this)}}i.instances=new Map,window.addEventListener("storage",(({key:t,newValue:e})=>{if(!t||null===e)return;const s=i.instances.get(t);s?.notify()}))},837405:(t,e,s)=>{s.d(e,{B:()=>r,p:()=>n});var i=s(59467),r=function(t){return t.OBJECT="object",t.STRING="string",t.NUMBER="number",t.BOOLEAN="boolean",t.STRING_NUMBER="string_number",t}({});class n extends i.s{get(){const t=this.getKey();try{let e=localStorage.getItem(t);if(!e)return null;switch(this.type){case"object":try{e=JSON.parse(e)}catch{return null}break;case"number":e=Number(e)||0;break;case"string_number":e=Number(e)||e;break;case"boolean":e=Boolean(Number(e))}return e}catch(e){return console.log(`${t}: Ошибка чтения данных из хранилища`),console.log(e),this.cache||null}}set(t,e){const s=this.getKey();let i;switch(this.type){case"object":i=JSON.stringify(t);break;case"boolean":i=String(Number(t));break;default:i=String(t)}try{localStorage.setItem(s,i)}catch(e){console.log(`${s}: Не удалось записать данные в хранилище`),console.log(e),this.cache=t}super.set(t,e)}delete(){const t=this.getKey();try{delete this.cache,localStorage.removeItem(t)}catch(e){console.log(`${t}: Ошибка удаления ключа из хранилища`),console.log(e)}}getKey(){return`${this.base.key}-${this.key}`}constructor(t){super(t);const{base:e,type:s}=t;this.base=e,this.type=s}}},999278:(t,e,s)=>{s.d(e,{x:()=>o});var i=s(666861),r=s(837405);class n extends i.i{createAtom(t,e){return new r.p({key:t,type:e,base:this})}constructor(t){super(t)}}function o(t){return new n(t)}},836085:(t,e,s)=>{s.d(e,{a:()=>r});var i=s(815287);const r=()=>{const t=(0,i.useRef)(!1);return(0,i.useEffect)((()=>(t.current=!0,()=>{t.current=!1})),[]),(0,i.useCallback)((()=>t.current),[])}},455356:(t,e,s)=>{s.d(e,{X:()=>o});var i=s(836085),r=s(815287),n=s(526537);function o(t,{play:e,show:s}={}){const{animationUrl:o,animationData:a}=t,c=(0,r.useRef)(!1),h=(0,r.useRef)(null),d=(0,r.useRef)(null),[u,l]=(0,r.useState)(!1),[g,p]=(0,r.useState)(null),[k,_]=(0,r.useState)(!1),[f,v]=(0,r.useState)(!1),m=(0,i.a)();(0,r.useEffect)((()=>{const t=d.current;t&&!k&&(void 0!==e&&(e?t.play():t.pause()),void 0!==s&&(s?t.show():t.hide()))}),[k,e,s]),(0,r.useLayoutEffect)((()=>((async()=>{const e=d.current;e?c.current=!1:(_(!0),v(!1));const s=h.current;if((o||a)&&s&&!c.current){c.current=!0,l(!1),p(null);try{const e=await n.LottieManager.loadAnimation({containers:[s],...t});e.addEventListener("enterFrame",(()=>{requestAnimationFrame((()=>{v(!0)}))}),{once:!0}),e.addEventListener("destroy",(()=>{v(!1)}),{once:!0}),_(!1),d.current=e}catch(t){l(!0),p(t)}m()&&e?.destroy()}})(),()=>{d.current?.destroy()})),[o,a]);return{lottieError:u,lottieLoading:k,lottieLoaded:!k&&!u,lottieRendered:f,lottiePlayerRef:d,lottieContainerRef:h,lottieErrorMessage:g}}},836606:(t,e,s)=>{s.d(e,{KI:()=>h,lu:()=>c,tn:()=>a});var i=s(32489),r=s(293721),n=s(209314),o=s(522140);const a=n.W.createEvent(),c=n.W.createStore(new o.n({})).on(a,((t,{api:e})=>e)),h=(0,r.qD)();(0,i.forward)({from:h.state,to:a})},421773:(t,e,s)=>{s.d(e,{SK:()=>o,iX:()=>c,n2:()=>h});var i=s(32489),r=s(293721),n=s(209314),o=function(t){return t.PHOTO_EDITOR="photoEditor",t}({});const a=n.W.createEvent(),c=n.W.createStore(null).on(a,((t,{context:e})=>e??null)),h=(0,r.qD)();(0,i.forward)({from:h.state,to:a})},302611:(t,e,s)=>{s.d(e,{Av:()=>h,KN:()=>o,VF:()=>r,hs:()=>a,p7:()=>i,qP:()=>n});var i=function(t){return t.VMOJI_AVATAR_SUGGESTION="keyboard:stickers_vmoji_avatar_suggestion",t}({}),r=function(t){return t.VMOJI_AVATAR_SUGGESTION="vmoji_avatar_suggestion_stickers_keyboard_hint",t}({});const n="avatarSuggestion",o=[n],a={"keyboard:stickers_vmoji_avatar_suggestion":n},c="newAvatarSuggestionCounter",h={vmoji_avatar_suggestion_stickers_keyboard_hint:c}},209314:(t,e,s)=>{s.d(e,{W:()=>i});const i=(0,s(32489).createDomain)()},800947:(t,e,s)=>{s.d(e,{D:()=>r,h:()=>n});var i=s(209314);const r=i.W.createEvent(),n=i.W.createStore(null).on(r,((t,e)=>e))},321406:(t,e,s)=>{s.d(e,{i:()=>r,o:()=>n});var i=s(209314);const r=i.W.createEvent(),n=i.W.createStore(null).on(r,((t,e)=>e))},400338:(t,e,s)=>{s.d(e,{Ps:()=>y,M1:()=>m});var i=s(32489),r=s(421773),n=s(736225),o=s(671091),a=s(321406),c=s(787809),h=s(481268),d=s(687398),u=s(800947),l=s(434518),g=s(763812),p=(0,g._)("_options"),k=(0,g._)("_pack"),_=(0,g._)("_product"),f=(0,g._)("_stockItem");class v{get rawData(){return(0,l._)(this,k)[k]||(0,l._)(this,f)[f]||(0,l._)(this,_)[_]}get isPack(){return Boolean((0,l._)(this,k)[k])}get isProduct(){return Boolean((0,l._)(this,_)[_])}get isStockItem(){return Boolean((0,l._)(this,f)[f])}get isStoreItem(){return this.isProduct||this.isStockItem}get stockItem(){return(0,l._)(this,f)[f]}get id(){const t=(0,l._)(this,p)[p]?.redefine?.id;if(void 0!==t)return t;const e=(0,l._)(this,_)[_]?.id;return void 0!==e?e:(0,l._)(this,k)[k]?.id}setHint(t){return(0,l._)(this,p)[p]?((0,l._)(this,p)[p].hint=t,this):this}get hintId(){return(0,l._)(this,p)[p]?.hint?.id}get hintWidth(){return(0,l._)(this,p)[p]?.hint?.width}get index(){return(0,l._)(this,p)[p]?.index}get referrer(){return(0,l._)(this,p)[p]?.referrer}get tooltip(){return(0,l._)(this,p)[p]?.tooltip}get title(){return(0,l._)(this,p)[p]?.redefine?.title||(0,l._)(this,_)[_]?.title||""}get stickers(){return(0,l._)(this,p)[p]?.redefine?.stickers||(0,l._)(this,k)[k]?.stickers||(0,l._)(this,_)[_]?.stickers}get baseId(){return(0,l._)(this,_)[_]?.base_id}get isStyle(){return void 0!==this.baseId}get hasStyles(){return Boolean(this.styleIds?.length)}get styleIds(){return(0,l._)(this,_)[_]?.style_ids}get canGift(){return Boolean((0,l._)(this,f)[f]?.can_gift)}get vmojiAvatar(){return(0,l._)(this,_)[_]?.vmoji_avatar}get isVmoji(){return Boolean(this.vmojiAvatar||(0,l._)(this,_)[_]?.is_vmoji)}get isPopup(){return(0,l._)(this,_)[_]?.is_popup}get isNew(){return(0,l._)(this,_)[_]?.is_new}get previews(){return(0,l._)(this,_)[_]?.previews}constructor({pack:t,...e}){Object.defineProperty(this,p,{writable:!0,value:void 0}),Object.defineProperty(this,k,{writable:!0,value:void 0}),Object.defineProperty(this,_,{writable:!0,value:void 0}),Object.defineProperty(this,f,{writable:!0,value:void 0}),(0,l._)(this,p)[p]=e,t&&("product"in t?((0,l._)(this,f)[f]=t,(0,l._)(this,_)[_]=t.product):"id"in t&&"type"in t?(0,l._)(this,_)[_]=t:(0,l._)(this,k)[k]=t)}}var m=function(t){return t[t.FAVORITE=-1]="FAVORITE",t[t.RECENT=-2]="RECENT",t[t.VMOJI=-3]="VMOJI",t[t.UGC=-4]="UGC",t[t.PHOTO_EDITOR=-5]="PHOTO_EDITOR",t}({});const y=(0,i.combine)(n.y,o.w,c.p,h.O,d.K,u.h,a.o,((t,e,s,i,n,o,a)=>{const c=new Map;let h=[];const d=new Map;let u=0;if(!s||!i||!o||r.iX.getState()===r.SK.PHOTO_EDITOR&&!n)return{};n?.length&&(c.set(-5,new v({index:u,referrer:"keyboard",redefine:{id:-5,stickers:n}})),h.push(-5),u++),o.length&&(c.set(-1,new v({index:u,referrer:"favourite",redefine:{id:-1,title:"stickers_picker_favorite",stickers:o}})),h.push(-1),u++),i.length&&(c.set(-2,new v({index:u,referrer:"recent",redefine:{id:-2,title:"stickers_picker_recently_used",stickers:i}})),h.push(-2),u++);-1!==s?.findIndex((({product:{vmoji_avatar:t}})=>void 0!==t))||a||(c.set(-3,new v({index:u,referrer:"keyboard",redefine:{id:-3,title:"stickers_picker_vmoji"}})),h.push(-3),u++);const l=e?.[0],g=t?.can_edit,p=l?.stickers?.length,k=t?.show_keyboard_onboarding&&g;if(!t?.is_keyboard_hidden&&(p||k)){const t=new v({pack:l,index:u,referrer:"keyboard",tooltip:{header:"stickers_picker_ugc_tooltip_title",text:"stickers_picker_ugc_tooltip_description"},redefine:{id:-4,title:"stickers_picker_ugc"}});g&&t.setHint({id:"stickers:ugc_keyboard_onboarding_tooltip",width:176}),c.set(-4,t),h.push(-4),u++}return s.forEach((t=>{const{product:{id:e,is_vmoji:s,vmoji_avatar:i}}=t;if(!s||i){if(c.set(e,new v({index:u,referrer:"keyboard",pack:t})),i){let t=d.get(i.id);t||(t=h.push([])-1,d.set(i.id,t));const s=h[t];Array.isArray(s)&&s.push(e)}else h.push(e);u++}})),{packs:c,packsGroups:h}}))},787809:(t,e,s)=>{s.d(e,{p:()=>n,t:()=>r});var i=s(209314);const r=i.W.createEvent(),n=i.W.createStore(null).on(r,((t,e)=>e))},687398:(t,e,s)=>{s.d(e,{K:()=>n,W:()=>r});var i=s(209314);const r=i.W.createEvent(),n=i.W.createStore(null).on(r,((t,e)=>e))},481268:(t,e,s)=>{s.d(e,{M:()=>r,O:()=>n});var i=s(209314);const r=i.W.createEvent(),n=i.W.createStore(null).on(r,((t,e)=>e))},736225:(t,e,s)=>{s.d(e,{Oq:()=>a,x8:()=>c,y:()=>d});var i=s(32489),r=s(836606),n=s(209314),o=s(806951);const a=n.W.createEvent(),c=n.W.createEvent(),h=n.W.createEffect((t=>t.cache.ugcInfo.get().catch((()=>null)))),d=n.W.createStore(null).on(a,((t,e)=>e)).on(h.doneData,((t,e)=>e)).on(o.C.doneData,(()=>null));(0,i.sample)({clock:c,source:r.lu,target:h})},671091:(t,e,s)=>{s.d(e,{W:()=>n,w:()=>o});var i=s(209314),r=s(806951);const n=i.W.createEvent(),o=i.W.createStore(null).on(n,((t,e)=>e)).on(r.C.doneData,(()=>null))},806951:(t,e,s)=>{s.d(e,{C:()=>a,S:()=>o});var i=s(32489),r=s(836606),n=s(209314);const o=n.W.createEvent(),a=n.W.createEffect((t=>{t.cache.clearUGC()}));(0,i.sample)({clock:o,source:r.lu,target:a})},624300:(t,e,s)=>{s.d(e,{R:()=>r,b:()=>n});var i=s(209314);const r=i.W.createEvent(),n=i.W.createStore({}).on(r,((t,e)=>e))},522140:(t,e,s)=>{s.d(e,{n:()=>x});var i=s(125901),r=s(6456),n=s(999278),o=s(141789),a=s(837405);function c(){this.ugcInfo.delete(),this.ugcPacks.delete()}var h=s(725308),d=s(263496);async function u(t){if(!(0,d.fy)())return this.clearUGC(),!0;const{peerId:e}=this.options;if(!e||!h.z.isChatOrChannelPeer(e))return!0;const s=await this.ugcPacks.get();let i;try{i=(await this.options.api.stickers.getUGCPackLists({owner_ids:String(e),owner_global_ids:t})).lists[0]}catch{}if(!i)return this.ugcInfo.delete(),this.ugcPacks.delete(),!0;this.ugcInfo.set(i);const{items:r}=i;if(!r.length)return this.ugcPacks.delete(),!0;const n=s?new Map(s.map((({id:t,hash:e})=>[t,e]))):void 0,o=r.reduce(((t,{pack_id:e,hash:s})=>{const i=n?.get(e);return i!==s&&t.push(e),t}),[]);if(!o.length)return!0;let a;try{a=(await this.options.api.stickers.getUGCPacks({owner_id:e,pack_ids:String(o)})).packs}catch{}return!a||(this.ugcPacks.set(a),!0)}async function l(){if(this.hasAvatar.get())return!0;try{const t=await this.options.api.vmoji.getAvatar();this.hasAvatar.set(Boolean(t.characters?.length))}catch{}return!0}async function g(t){if(!t.length)return[];const e=await this.stickers.get()??new Map,s=[];let i=[];for(const r of t){const t=e.get(r);t?i.push(t):s.push(r)}if(!s.length)return i;const r=await this.options.api.store.getStickers({sticker_ids:String(s.join(","))});for(const t of r)t.sticker_id&&e.set(t.sticker_id,t);this.stickers.set(e),i=[];for(const s of t){const t=e.get(s);t&&i.push(t)}return i}async function p(t){this.clearHelpHintById(t);try{const e=await this.options.api.account.hideHelpHint({hint_id:t});return Boolean(e)}catch(t){return!1}}var k=s(421773);async function _(t){var e;if(this.reloading)return!0;this.setReloading(!0);const s=await this.global.get();let[i,r,n]=await Promise.all([this.options.api.store.hasNewItems({type:"stickers",version_hash:String(s?.stickers_version_hash)}).catch((()=>null)),this.stockItems.get(),this.imageConfigs.get()]);if(!i)return this.setReloading(!1),!1;(e=i).sticker_packs_version_hashes||(e.sticker_packs_version_hashes=s?.sticker_packs_version_hashes);const{stickers_version_hash:o,sticker_packs_version_hashes:a,favorite_stickers_version_hash:c,image_configs_version_hash:h,sticker_packs_chunk_size_limit:d,vmoji_promotion:u}=i;(o!==s?.stickers_version_hash||t)&&(r=null,await this.stickers.set(new Map));const l=[this.reloadStockItems({cachedStockItems:t?null:r,actualPacksHashes:t?void 0:a,chunkSize:d}),this.reloadUGC(),this.reloadVmoji(),this.reloadRecentStickers()];this.options.context===k.SK.PHOTO_EDITOR&&l.push(this.reloadPhotoEditorStickers()),(c!==s?.favorite_stickers_version_hash||t)&&l.push(this.reloadFavoriteStickers()),n&&h===s?.image_configs_version_hash&&!t||l.push(this.reloadImageConfigs());const g=!u?.avatar_suggestion?.character_id;!g&&u?.avatar_suggestion?.character_id!==s?.vmoji_promotion?.avatar_suggestion?.character_id?l.push(this.reloadHelpHint()):g&&this.clearAllHelpHint();const p=await Promise.all(l);this.setReloading(!1);const _=-1===p.findIndex((t=>!t));return _&&i&&(this.global.set(i),this.stickersSync.notify(void 0,!0)),_}async function f({active:t}){let e=await this.stockItems.get();return e&&(e=e.sort((({product:{vmoji_avatar:t}},{product:{vmoji_avatar:e}})=>Number(Boolean(e))-Number(Boolean(t)))),t&&(e=e.filter((({product:t})=>t.active)))),e}var v=s(302611);async function m(){let t=v.KN.slice(),e=null;try{e=await this.options.api.account.getHelpHints({categories:"vmoji_promo"})}catch{}return e?.items?(e.items.forEach((e=>{const s=e.id,i=v.hs[s];i in this&&(this[i]?.set(e,{notify:!0}),t=t.filter((t=>t!==i)))})),t.forEach((t=>{this[t].delete()})),!0):(this.clearAllHelpHint(),!0)}async function y({productId:t,stickerId:e}){const s=await this.stockItems.get();let i;if(s&&(t&&(i=s.find((({product:{id:e}})=>e===t))),e&&!i&&(i=s.find((({product:{stickers:t}})=>t&&-1!==t.findIndex((({sticker_id:t})=>t===e)))))),i)return i;if(t)try{i=await this.options.api.store.getStockItemByProductId({type:"stickers",product_id:String(t)})}catch(t){i=void 0}if(i)return this.updateStockItems([i]),i;if(e)try{i=await this.options.api.store.getStockItemByStickerId({sticker_id:e})}catch(t){i=void 0}return i&&this.updateStockItems([i]),i}var b=s(652097);const w=new Map;async function S({chunkSize:t=25,cachedStockItems:e,actualPacksHashes:s}){let i=w.get(this.stickersSync.key);i||(i=new Map,w.set(this.stickersSync.key,i));let r=e?.reduce(((t,{product:{id:e},version_hash:i})=>{const r=s?.find((({pack_id:t})=>t===e));if(!r)return t;return r.hash!==i&&t.push(e),t}),[]);const n=!r;if(n)try{const{items:t}=await this.options.api.store.getProducts({type:"stickers",filters:"purchased"});r=t.map((({id:t})=>t))}catch(t){r=void 0}if(!r?.length)return!0;await this.stickers.set(new Map);let o=await Promise.all((0,b.ln)(r,t).map((t=>{const e=String(t);return i?.get(e)||this.options.api.store.getStockItems({type:"stickers",product_ids:e}).then((t=>(i?.set(e,t),t)))}))).then((t=>t.reduce(((t,{items:e})=>(t.push(...e),t)),[]).filter((t=>!Array.isArray(t))))).catch((()=>null));if(!o)return!1;if(e?.length){const t=new Map(o.map((t=>[t.product.id,t])));o=e=e.map((e=>t.get(e.product.id)||e))}return o&&r&&n&&(o=o.sort((({product:{id:t}},{product:{id:e}})=>Number(r?.indexOf(t))-Number(r?.indexOf(e))))),await this.stockItems.set(o),w.delete(this.stickersSync.key),!0}async function I(t,e){let s=await this.stockItems.get();if(s){const e=new Map(s.map((t=>{const{product:{id:e}}=t;return[e,t]})));t.forEach((t=>{const{product:{id:s}}=t;e.set(s,t)})),s=[...e.values()]}return this.stockItems.set(s||t,e)}const E=(0,s(888817).n)((function(t,e,s){t.options.api.stickers.markPromoAsViewed({promo_id:e,count:s}).then((s=>{if(s){t[v.Av[e]].set(0)}}))}),3e4);function A(t){const e=this[v.Av[t]],s=(e?.get()||0)+1;e.set(s),E(this,t,s)}async function O(){const t=await this.ugcInfo.get();if(!t?.show_keyboard_onboarding)return!1;const{owner_id:e}=t;t.show_keyboard_onboarding=!1,this.ugcInfo.set(t);try{const t=await this.options.api.stickers.hideUGCKeyboardOnboarding({owner_id:e});return Boolean(t)}catch(t){return!1}}async function C(){let t=null;try{t=await this.options.api.store.getStickersImageConfigs()}catch{}return!!t&&(this.imageConfigs.set(t),!0)}async function P(){let t=null;try{t=(await this.options.api.messages.getRecentStickers()).items}catch{}return t&&this.recentStickers.set(t),!0}async function R(){try{const t=await this.options.api.photos.getEditorStickers();this.photoEditorStickers.set(t.items)}catch{}return!0}async function N(){const t=await this.global.get();t?.vmoji_promotion&&(t.vmoji_promotion.dot_color=void 0,this.global.set(t,{notify:!1}))}async function j(){let t=null;try{t=(await this.options.api.store.getFavoriteStickers()).items}catch{}return!!t&&(await this.favoriteStickers.set(t),!0)}function H(t){this[v.hs[t]]?.delete()}function T(){v.KN.forEach((t=>this[t].delete()))}class B{subscribe(t){return this.listeners.add(t),()=>{this.listeners.delete(t)}}get reloading(){return this.isReloading}setReloading(t){this.isReloading=t}destroy(){this.stickersSync.destroy(),this.stickersAsync.destroy()}constructor(t){this.isReloading=!1,this.listeners=new Set,this.reload=_.bind(this),this.reloadVmoji=l.bind(this),this.clearVmojiPromotionDot=N.bind(this),this.getStockItem=y.bind(this),this.getStockItems=f.bind(this),this.updateStockItems=I.bind(this),this.reloadStockItems=S.bind(this),this.reloadUGC=u.bind(this),this.clearUGC=c.bind(this),this.hideUGCOnboarding=O.bind(this),this.reloadRecentStickers=P.bind(this),this.reloadPhotoEditorStickers=R.bind(this),this.reloadFavoriteStickers=j.bind(this),this.reloadImageConfigs=C.bind(this),this.getStickers=g.bind(this),this.reloadHelpHint=m.bind(this),this.clearHelpHintById=H.bind(this),this.clearAllHelpHint=T.bind(this),this.hideHelpHint=p.bind(this),this.markHelpHintAsViewed=A.bind(this);const{userId:e,peerId:s}=t;this.options=t;const i=(0,n.x)({dbName:"stickers",storeName:String(e),version:1}),r=(0,o.E)({dbName:"stickers",storeName:String(e),version:1});this.stickersSync=i,this.stickersAsync=r,this.global=r.createAtom("global"),this.stockItems=r.createAtom("stockItems"),this.imageConfigs=r.createAtom("imageConfigs"),this.recentStickers=r.createAtom("recentStickers"),this.photoEditorStickers=r.createAtom("photoEditorStickers"),this.favoriteStickers=r.createAtom("favoriteStickers"),this.avatarSuggestion=r.createAtom("avatarSuggestion"),this.stickers=r.createAtom("stickers"),this.hasAvatar=i.createAtom("hasAvatar",a.B.BOOLEAN),this.recentEmoji=i.createAtom("recentEmoji",a.B.OBJECT),this.tabbarActiveTab=i.createAtom("tabbarActiveTab",a.B.STRING),this.stickersActiveTab=i.createAtom("stickersActiveTab",a.B.NUMBER),this.newAvatarSuggestionCounter=i.createAtom("newAvatarSuggestionCounter",a.B.NUMBER);const h=(0,o.E)({dbName:"stickers-ugc",storeName:`${e}-${s}`,version:1});this.ugcAsync=h,this.ugcInfo=h.createAtom("ugcInfo"),this.ugcPacks=h.createAtom("ugcPacks"),this.getStickersImageConfigs=this.imageConfigs.get.bind(this.imageConfigs)}}var W=s(872020),M=s(168524);class x extends i.n{constructor({onAPIRequest:t,language:e,context:s,logError:i,...n}){super({requestMethod:t,language:e,logError:i},(0,d.zI)()?void 0:{userId:n?.userId,source:"stickers"}),this.cache=new B({api:this,context:s,...n}),(0,d.zI)()||(this.updates.addEventListener(r.g.UGC_OWNER_UPDATE,W.S.bind(this)),this.updates.addEventListener(r.g.UGC_STICKER_UPDATE,M.u.bind(this)))}}},872020:(t,e,s)=>{function i({detail:{owner_global_id:t}}){this.cache.reloadUGC(t)}s.d(e,{S:()=>i})},168524:(t,e,s)=>{s.d(e,{u:()=>n});const i=new Map,r=new Set;async function n({detail:{stickers:t}}){const{peerId:e}=this.cache.options;t.forEach((t=>{if(t.owner_id!==e)return;let s=i.get(e);s||(s=[],i.set(e,s));const r=s.findIndex((e=>e.id===t.id&&e.pack_id===t.pack_id&&e.owner_id===t.owner_id));-1!==r?s[r]=t:s.push(t)})),o.call(this)}async function o(){const{peerId:t}=this.cache.options;if(!t||r.has(t))return;const e=i.get(t);if(!e?.length)return;r.add(t),i.delete(t);const s=await this.cache.ugcPacks.get();if(!s?.length)return;const n=new Map(s.map((t=>[t.id,t])));e.forEach((t=>{const{id:e,pack_id:s}=t;if(void 0===s)return;const i=n.get(s);if(!i)return;const r=i.stickers.findIndex((t=>t.id===e));-1!==r&&(i.stickers[r]=t)}));try{await this.cache.ugcPacks.set(s)}catch{}r.delete(t),o.call(this)}},263496:(t,e,s)=>{s.d(e,{DR:()=>h,YE:()=>o,fy:()=>n,mD:()=>a,zI:()=>c});var i=s(624300);function r(t){return Boolean(i.b.getState()[t])}const n=()=>r("stickers.ugc"),o=()=>r("vmoji.promo.avatar_suggestion.promo_counter"),a=()=>r("stickers.popup"),c=()=>r("static_updates_manager_in_sticker_picker"),h=()=>r("sticker_picker_fast_select_pack")}}]),"undefined"!=typeof window&&window.stManager?.done?.("dist/core_spa/chunks/43877.c58bfec4.js")}catch(t){throw"undefined"!=typeof window&&window.stManager?.fail?.("dist/core_spa/chunks/43877.c58bfec4.js",t),t}