try{(self.webpackChunkvk=self.webpackChunkvk||[]).push([[99758],{99758:(e,t,i)=>{i.d(t,{Fr:()=>ps,MF:()=>Gu,T4:()=>Qi,Xt:()=>Gi,ai:()=>Xu,di:()=>Xi,eS:()=>Yi,qE:()=>Es,ui:()=>Zi,wF:()=>Wi,xv:()=>Hi,zl:()=>ks});var s,r,a,n,o,u=i(319340),h=Object.create,d=Object.defineProperty,l=Object.getOwnPropertyDescriptor,c=Object.getOwnPropertyNames,p=Object.getPrototypeOf,f=Object.prototype.hasOwnProperty,m=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),g=(e,t,i)=>(i=null!=e?h(p(e)):{},((e,t,i,s)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let r of c(t))!f.call(e,r)&&r!==i&&d(e,r,{get:()=>t[r],enumerable:!(s=l(t,r))||s.enumerable});return e})(!t&&e&&e.__esModule?i:d(i,"default",{value:e,enumerable:!0}),e)),b=m(((e,t)=>{"use strict";var i=function(e){return e&&e.Math===Math&&e};t.exports=i("object"==typeof globalThis&&globalThis)||i("object"==typeof window&&window)||i("object"==typeof self&&self)||i("object"==typeof global&&global)||i("object"==typeof e&&e)||function(){return this}()||Function("return this")()})),v=m(((e,t)=>{"use strict";t.exports=function(e){try{return!!e()}catch{return!0}}})),y=m(((e,t)=>{"use strict";var i=v();t.exports=!i((function(){var e=function(){}.bind();return"function"!=typeof e||e.hasOwnProperty("prototype")}))})),S=m(((e,t)=>{"use strict";var i=y(),s=Function.prototype,r=s.apply,a=s.call;t.exports="object"==typeof Reflect&&Reflect.apply||(i?a.bind(r):function(){return a.apply(r,arguments)})})),w=m(((e,t)=>{"use strict";var i=y(),s=Function.prototype,r=s.call,a=i&&s.bind.bind(r,r);t.exports=i?a:function(e){return function(){return r.apply(e,arguments)}}})),T=m(((e,t)=>{"use strict";var i=w(),s=i({}.toString),r=i("".slice);t.exports=function(e){return r(s(e),8,-1)}})),$=m(((e,t)=>{"use strict";var i=T(),s=w();t.exports=function(e){if("Function"===i(e))return s(e)}})),x=m(((e,t)=>{"use strict";var i="object"==typeof document&&document.all;t.exports=typeof i>"u"&&void 0!==i?function(e){return"function"==typeof e||e===i}:function(e){return"function"==typeof e}})),k=m(((e,t)=>{"use strict";var i=v();t.exports=!i((function(){return 7!==Object.defineProperty({},1,{get:function(){return 7}})[1]}))})),L=m(((e,t)=>{"use strict";var i=y(),s=Function.prototype.call;t.exports=i?s.bind(s):function(){return s.apply(s,arguments)}})),R=m((e=>{"use strict";var t={}.propertyIsEnumerable,i=Object.getOwnPropertyDescriptor,s=i&&!t.call({1:2},1);e.f=s?function(e){var t=i(this,e);return!!t&&t.enumerable}:t})),E=m(((e,t)=>{"use strict";t.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}})),B=m(((e,t)=>{"use strict";var i=w(),s=v(),r=T(),a=Object,n=i("".split);t.exports=s((function(){return!a("z").propertyIsEnumerable(0)}))?function(e){return"String"===r(e)?n(e,""):a(e)}:a})),A=m(((e,t)=>{"use strict";t.exports=function(e){return null==e}})),M=m(((e,t)=>{"use strict";var i=A(),s=TypeError;t.exports=function(e){if(i(e))throw new s("Can't call method on "+e);return e}})),C=m(((e,t)=>{"use strict";var i=B(),s=M();t.exports=function(e){return i(s(e))}})),I=m(((e,t)=>{"use strict";var i=x();t.exports=function(e){return"object"==typeof e?null!==e:i(e)}})),D=m(((e,t)=>{"use strict";t.exports={}})),O=m(((e,t)=>{"use strict";var i=D(),s=b(),r=x(),a=function(e){return r(e)?e:void 0};t.exports=function(e,t){return arguments.length<2?a(i[e])||a(s[e]):i[e]&&i[e][t]||s[e]&&s[e][t]}})),P=m(((e,t)=>{"use strict";var i=w();t.exports=i({}.isPrototypeOf)})),V=m(((e,t)=>{"use strict";var i=b().navigator,s=i&&i.userAgent;t.exports=s?String(s):""})),_=m(((e,t)=>{"use strict";var i,s,r=b(),a=V(),n=r.process,o=r.Deno,u=n&&n.versions||o&&o.version,h=u&&u.v8;h&&(s=(i=h.split("."))[0]>0&&i[0]<4?1:+(i[0]+i[1])),!s&&a&&((!(i=a.match(/Edge\/(\d+)/))||i[1]>=74)&&((i=a.match(/Chrome\/(\d+)/))&&(s=+i[1]))),t.exports=s})),F=m(((e,t)=>{"use strict";var i=_(),s=v(),r=b().String;t.exports=!!Object.getOwnPropertySymbols&&!s((function(){var e=Symbol("symbol detection");return!r(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&i&&i<41}))})),N=m(((e,t)=>{"use strict";var i=F();t.exports=i&&!Symbol.sham&&"symbol"==typeof Symbol.iterator})),U=m(((e,t)=>{"use strict";var i=O(),s=x(),r=P(),a=N(),n=Object;t.exports=a?function(e){return"symbol"==typeof e}:function(e){var t=i("Symbol");return s(t)&&r(t.prototype,n(e))}})),j=m(((e,t)=>{"use strict";var i=String;t.exports=function(e){try{return i(e)}catch{return"Object"}}})),q=m(((e,t)=>{"use strict";var i=x(),s=j(),r=TypeError;t.exports=function(e){if(i(e))return e;throw new r(s(e)+" is not a function")}})),z=m(((e,t)=>{"use strict";var i=q(),s=A();t.exports=function(e,t){var r=e[t];return s(r)?void 0:i(r)}})),H=m(((e,t)=>{"use strict";var i=L(),s=x(),r=I(),a=TypeError;t.exports=function(e,t){var n,o;if("string"===t&&s(n=e.toString)&&!r(o=i(n,e))||s(n=e.valueOf)&&!r(o=i(n,e))||"string"!==t&&s(n=e.toString)&&!r(o=i(n,e)))return o;throw new a("Can't convert object to primitive value")}})),W=m(((e,t)=>{"use strict";t.exports=!0})),Q=m(((e,t)=>{"use strict";var i=b(),s=Object.defineProperty;t.exports=function(e,t){try{s(i,e,{value:t,configurable:!0,writable:!0})}catch{i[e]=t}return t}})),X=m(((e,t)=>{"use strict";var i=W(),s=b(),r=Q(),a="__core-js_shared__",n=t.exports=s[a]||r(a,{});(n.versions||(n.versions=[])).push({version:"3.43.0",mode:i?"pure":"global",copyright:"© 2014-2025 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.43.0/LICENSE",source:"https://github.com/zloirock/core-js"})})),G=m(((e,t)=>{"use strict";var i=X();t.exports=function(e,t){return i[e]||(i[e]=t||{})}})),Z=m(((e,t)=>{"use strict";var i=M(),s=Object;t.exports=function(e){return s(i(e))}})),Y=m(((e,t)=>{"use strict";var i=w(),s=Z(),r=i({}.hasOwnProperty);t.exports=Object.hasOwn||function(e,t){return r(s(e),t)}})),J=m(((e,t)=>{"use strict";var i=w(),s=0,r=Math.random(),a=i(1.1.toString);t.exports=function(e){return"Symbol("+(void 0===e?"":e)+")_"+a(++s+r,36)}})),K=m(((e,t)=>{"use strict";var i=b(),s=G(),r=Y(),a=J(),n=F(),o=N(),u=i.Symbol,h=s("wks"),d=o?u.for||u:u&&u.withoutSetter||a;t.exports=function(e){return r(h,e)||(h[e]=n&&r(u,e)?u[e]:d("Symbol."+e)),h[e]}})),ee=m(((e,t)=>{"use strict";var i=L(),s=I(),r=U(),a=z(),n=H(),o=K(),u=TypeError,h=o("toPrimitive");t.exports=function(e,t){if(!s(e)||r(e))return e;var o,d=a(e,h);if(d){if(void 0===t&&(t="default"),o=i(d,e,t),!s(o)||r(o))return o;throw new u("Can't convert object to primitive value")}return void 0===t&&(t="number"),n(e,t)}})),te=m(((e,t)=>{"use strict";var i=ee(),s=U();t.exports=function(e){var t=i(e,"string");return s(t)?t:t+""}})),ie=m(((e,t)=>{"use strict";var i=b(),s=I(),r=i.document,a=s(r)&&s(r.createElement);t.exports=function(e){return a?r.createElement(e):{}}})),se=m(((e,t)=>{"use strict";var i=k(),s=v(),r=ie();t.exports=!i&&!s((function(){return 7!==Object.defineProperty(r("div"),"a",{get:function(){return 7}}).a}))})),re=m((e=>{"use strict";var t=k(),i=L(),s=R(),r=E(),a=C(),n=te(),o=Y(),u=se(),h=Object.getOwnPropertyDescriptor;e.f=t?h:function(e,t){if(e=a(e),t=n(t),u)try{return h(e,t)}catch{}if(o(e,t))return r(!i(s.f,e,t),e[t])}})),ae=m(((e,t)=>{"use strict";var i=v(),s=x(),r=/#|\.prototype\./,a=function(e,t){var r=o[n(e)];return r===h||r!==u&&(s(t)?i(t):!!t)},n=a.normalize=function(e){return String(e).replace(r,".").toLowerCase()},o=a.data={},u=a.NATIVE="N",h=a.POLYFILL="P";t.exports=a})),ne=m(((e,t)=>{"use strict";var i=$(),s=q(),r=y(),a=i(i.bind);t.exports=function(e,t){return s(e),void 0===t?e:r?a(e,t):function(){return e.apply(t,arguments)}}})),oe=m(((e,t)=>{"use strict";var i=k(),s=v();t.exports=i&&s((function(){return 42!==Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype}))})),ue=m(((e,t)=>{"use strict";var i=I(),s=String,r=TypeError;t.exports=function(e){if(i(e))return e;throw new r(s(e)+" is not an object")}})),he=m((e=>{"use strict";var t=k(),i=se(),s=oe(),r=ue(),a=te(),n=TypeError,o=Object.defineProperty,u=Object.getOwnPropertyDescriptor,h="enumerable",d="configurable",l="writable";e.f=t?s?function(e,t,i){if(r(e),t=a(t),r(i),"function"==typeof e&&"prototype"===t&&"value"in i&&l in i&&!i[l]){var s=u(e,t);s&&s[l]&&(e[t]=i.value,i={configurable:d in i?i[d]:s[d],enumerable:h in i?i[h]:s[h],writable:!1})}return o(e,t,i)}:o:function(e,t,s){if(r(e),t=a(t),r(s),i)try{return o(e,t,s)}catch{}if("get"in s||"set"in s)throw new n("Accessors not supported");return"value"in s&&(e[t]=s.value),e}})),de=m(((e,t)=>{"use strict";var i=k(),s=he(),r=E();t.exports=i?function(e,t,i){return s.f(e,t,r(1,i))}:function(e,t,i){return e[t]=i,e}})),le=m(((e,t)=>{"use strict";var i=b(),s=S(),r=$(),a=x(),n=re().f,o=ae(),u=D(),h=ne(),d=de(),l=Y();X();var c=function(e){var t=function(i,r,a){if(this instanceof t){switch(arguments.length){case 0:return new e;case 1:return new e(i);case 2:return new e(i,r)}return new e(i,r,a)}return s(e,this,arguments)};return t.prototype=e.prototype,t};t.exports=function(e,t){var s,p,f,m,g,b,v,y,S,w=e.target,T=e.global,$=e.stat,x=e.proto,k=T?i:$?i[w]:i[w]&&i[w].prototype,L=T?u:u[w]||d(u,w,{})[w],R=L.prototype;for(m in t)p=!(s=o(T?m:w+($?".":"#")+m,e.forced))&&k&&l(k,m),b=L[m],p&&(e.dontCallGetSet?v=(S=n(k,m))&&S.value:v=k[m]),g=p&&v?v:t[m],(s||x||typeof b!=typeof g)&&(y=e.bind&&p?h(g,i):e.wrap&&p?c(g):x&&a(g)?r(g):g,(e.sham||g&&g.sham||b&&b.sham)&&d(y,"sham",!0),d(L,m,y),x&&(l(u,f=w+"Prototype")||d(u,f,{}),d(u[f],m,g),e.real&&R&&(s||!R[m])&&d(R,m,g)))}})),ce=m(((e,t)=>{"use strict";var i=G(),s=J(),r=i("keys");t.exports=function(e){return r[e]||(r[e]=s(e))}})),pe=m(((e,t)=>{"use strict";var i=v();t.exports=!i((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype}))})),fe=m(((e,t)=>{"use strict";var i=Y(),s=x(),r=Z(),a=ce(),n=pe(),o=a("IE_PROTO"),u=Object,h=u.prototype;t.exports=n?u.getPrototypeOf:function(e){var t=r(e);if(i(t,o))return t[o];var a=t.constructor;return s(a)&&t instanceof a?a.prototype:t instanceof u?h:null}})),me=m(((e,t)=>{"use strict";var i=Math.ceil,s=Math.floor;t.exports=Math.trunc||function(e){var t=+e;return(t>0?s:i)(t)}})),ge=m(((e,t)=>{"use strict";var i=me();t.exports=function(e){var t=+e;return t!=t||0===t?0:i(t)}})),be=m(((e,t)=>{"use strict";var i=ge(),s=Math.max,r=Math.min;t.exports=function(e,t){var a=i(e);return a<0?s(a+t,0):r(a,t)}})),ve=m(((e,t)=>{"use strict";var i=ge(),s=Math.min;t.exports=function(e){var t=i(e);return t>0?s(t,9007199254740991):0}})),ye=m(((e,t)=>{"use strict";var i=ve();t.exports=function(e){return i(e.length)}})),Se=m(((e,t)=>{"use strict";var i=C(),s=be(),r=ye(),a=function(e){return function(t,a,n){var o=i(t),u=r(o);if(0===u)return!e&&-1;var h,d=s(n,u);if(e&&a!=a){for(;u>d;)if((h=o[d++])!=h)return!0}else for(;u>d;d++)if((e||d in o)&&o[d]===a)return e||d||0;return!e&&-1}};t.exports={includes:a(!0),indexOf:a(!1)}})),we=m(((e,t)=>{"use strict";t.exports={}})),Te=m(((e,t)=>{"use strict";var i=w(),s=Y(),r=C(),a=Se().indexOf,n=we(),o=i([].push);t.exports=function(e,t){var i,u=r(e),h=0,d=[];for(i in u)!s(n,i)&&s(u,i)&&o(d,i);for(;t.length>h;)s(u,i=t[h++])&&(~a(d,i)||o(d,i));return d}})),$e=m(((e,t)=>{"use strict";t.exports=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"]})),xe=m(((e,t)=>{"use strict";var i=Te(),s=$e();t.exports=Object.keys||function(e){return i(e,s)}})),ke=m(((e,t)=>{"use strict";var i=k(),s=v(),r=w(),a=fe(),n=xe(),o=C(),u=r(R().f),h=r([].push),d=i&&s((function(){var e=Object.create(null);return e[2]=2,!u(e,2)})),l=function(e){return function(t){for(var s,r=o(t),l=n(r),c=d&&null===a(r),p=l.length,f=0,m=[];p>f;)s=l[f++],(!i||(c?s in r:u(r,s)))&&h(m,e?[s,r[s]]:r[s]);return m}};t.exports={entries:l(!0),values:l(!1)}})),Le=m((()=>{"use strict";var e=le(),t=ke().values;e({target:"Object",stat:!0},{values:function(e){return t(e)}})})),Re=m(((e,t)=>{"use strict";Le();var i=D();t.exports=i.Object.values})),Ee=m(((e,t)=>{"use strict";var i=Re();t.exports=i})),Be=m(((e,t)=>{"use strict";var i=Ee();t.exports=i})),Ae=m(((e,t)=>{"use strict";t.exports=function(){}})),Me=m((()=>{"use strict";var e=le(),t=Se().includes,i=v(),s=Ae();e({target:"Array",proto:!0,forced:i((function(){return!Array(1).includes()}))},{includes:function(e){return t(this,e,arguments.length>1?arguments[1]:void 0)}}),s("includes")})),Ce=m(((e,t)=>{"use strict";var i=O();t.exports=i})),Ie=m(((e,t)=>{"use strict";Me();var i=Ce();t.exports=i("Array","includes")})),De=m(((e,t)=>{"use strict";var i=Ie();t.exports=i})),Oe=m(((e,t)=>{"use strict";var i=De();t.exports=i})),Pe=m((()=>{"use strict";var e=le(),t=ke().entries;e({target:"Object",stat:!0},{entries:function(e){return t(e)}})})),Ve=m(((e,t)=>{"use strict";Pe();var i=D();t.exports=i.Object.entries})),_e=m(((e,t)=>{"use strict";var i=Ve();t.exports=i})),Fe=m(((e,t)=>{"use strict";var i=_e();t.exports=i})),Ne=m(((e,t)=>{"use strict";t.exports={}})),Ue=m(((e,t)=>{"use strict";var i=b(),s=x(),r=i.WeakMap;t.exports=s(r)&&/native code/.test(String(r))})),je=m(((e,t)=>{"use strict";var i,s,r,a,n,o=Ue(),u=b(),h=I(),d=de(),l=Y(),c=X(),p=ce(),f=we(),m="Object already initialized",g=u.TypeError,v=u.WeakMap;o||c.state?((a=c.state||(c.state=new v)).get=a.get,a.has=a.has,a.set=a.set,i=function(e,t){if(a.has(e))throw new g(m);return t.facade=e,a.set(e,t),t},s=function(e){return a.get(e)||{}},r=function(e){return a.has(e)}):(f[n=p("state")]=!0,i=function(e,t){if(l(e,n))throw new g(m);return t.facade=e,d(e,n,t),t},s=function(e){return l(e,n)?e[n]:{}},r=function(e){return l(e,n)}),t.exports={set:i,get:s,has:r,enforce:function(e){return r(e)?s(e):i(e,{})},getterFor:function(e){return function(t){var i;if(!h(t)||(i=s(t)).type!==e)throw new g("Incompatible receiver, "+e+" required");return i}}}})),qe=m(((e,t)=>{"use strict";var i=k(),s=Y(),r=Function.prototype,a=i&&Object.getOwnPropertyDescriptor,n=s(r,"name"),o=n&&"something"===function(){}.name,u=n&&(!i||i&&a(r,"name").configurable);t.exports={EXISTS:n,PROPER:o,CONFIGURABLE:u}})),ze=m((e=>{"use strict";var t=k(),i=oe(),s=he(),r=ue(),a=C(),n=xe();e.f=t&&!i?Object.defineProperties:function(e,t){r(e);for(var i,o=a(t),u=n(t),h=u.length,d=0;h>d;)s.f(e,i=u[d++],o[i]);return e}})),He=m(((e,t)=>{"use strict";var i=O();t.exports=i("document","documentElement")})),We=m(((e,t)=>{"use strict";var i,s=ue(),r=ze(),a=$e(),n=we(),o=He(),u=ie(),h=ce(),d="prototype",l="script",c=h("IE_PROTO"),p=function(){},f=function(e){return"<"+l+">"+e+"</"+l+">"},m=function(e){e.write(f("")),e.close();var t=e.parentWindow.Object;return e=null,t},g=function(){try{i=new ActiveXObject("htmlfile")}catch{}g=typeof document<"u"?document.domain&&i?m(i):function(){var e,t=u("iframe"),i="java"+l+":";return t.style.display="none",o.appendChild(t),t.src=String(i),(e=t.contentWindow.document).open(),e.write(f("document.F=Object")),e.close(),e.F}():m(i);for(var e=a.length;e--;)delete g[d][a[e]];return g()};n[c]=!0,t.exports=Object.create||function(e,t){var i;return null!==e?(p[d]=s(e),i=new p,p[d]=null,i[c]=e):i=g(),void 0===t?i:r.f(i,t)}})),Qe=m(((e,t)=>{"use strict";var i=de();t.exports=function(e,t,s,r){return r&&r.enumerable?e[t]=s:i(e,t,s),e}})),Xe=m(((e,t)=>{"use strict";var i,s,r,a=v(),n=x(),o=I(),u=We(),h=fe(),d=Qe(),l=K(),c=W(),p=l("iterator"),f=!1;[].keys&&("next"in(r=[].keys())?(s=h(h(r)))!==Object.prototype&&(i=s):f=!0),!o(i)||a((function(){var e={};return i[p].call(e)!==e}))?i={}:c&&(i=u(i)),n(i[p])||d(i,p,(function(){return this})),t.exports={IteratorPrototype:i,BUGGY_SAFARI_ITERATORS:f}})),Ge=m(((e,t)=>{"use strict";var i={};i[K()("toStringTag")]="z",t.exports="[object z]"===String(i)})),Ze=m(((e,t)=>{"use strict";var i=Ge(),s=x(),r=T(),a=K()("toStringTag"),n=Object,o="Arguments"===r(function(){return arguments}());t.exports=i?r:function(e){var t,i,u;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(i=function(e,t){try{return e[t]}catch{}}(t=n(e),a))?i:o?r(t):"Object"===(u=r(t))&&s(t.callee)?"Arguments":u}})),Ye=m(((e,t)=>{"use strict";var i=Ge(),s=Ze();t.exports=i?{}.toString:function(){return"[object "+s(this)+"]"}})),Je=m(((e,t)=>{"use strict";var i=Ge(),s=he().f,r=de(),a=Y(),n=Ye(),o=K()("toStringTag");t.exports=function(e,t,u,h){var d=u?e:e&&e.prototype;d&&(a(d,o)||s(d,o,{configurable:!0,value:t}),h&&!i&&r(d,"toString",n))}})),Ke=m(((e,t)=>{"use strict";var i=Xe().IteratorPrototype,s=We(),r=E(),a=Je(),n=Ne(),o=function(){return this};t.exports=function(e,t,u,h){var d=t+" Iterator";return e.prototype=s(i,{next:r(+!h,u)}),a(e,d,!1,!0),n[d]=o,e}})),et=m(((e,t)=>{"use strict";var i=w(),s=q();t.exports=function(e,t,r){try{return i(s(Object.getOwnPropertyDescriptor(e,t)[r]))}catch{}}})),tt=m(((e,t)=>{"use strict";var i=I();t.exports=function(e){return i(e)||null===e}})),it=m(((e,t)=>{"use strict";var i=tt(),s=String,r=TypeError;t.exports=function(e){if(i(e))return e;throw new r("Can't set "+s(e)+" as a prototype")}})),st=m(((e,t)=>{"use strict";var i=et(),s=I(),r=M(),a=it();t.exports=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,n={};try{(e=i(Object.prototype,"__proto__","set"))(n,[]),t=n instanceof Array}catch{}return function(i,n){return r(i),a(n),s(i)&&(t?e(i,n):i.__proto__=n),i}}():void 0)})),rt=m(((e,t)=>{"use strict";var i=le(),s=L(),r=W(),a=qe(),n=x(),o=Ke(),u=fe(),h=st(),d=Je(),l=de(),c=Qe(),p=K(),f=Ne(),m=Xe(),g=a.PROPER,b=a.CONFIGURABLE,v=m.IteratorPrototype,y=m.BUGGY_SAFARI_ITERATORS,S=p("iterator"),w="keys",T="values",$="entries",k=function(){return this};t.exports=function(e,t,a,p,m,x,L){o(a,t,p);var R,E,B,A=function(e){if(e===m&&O)return O;if(!y&&e&&e in I)return I[e];switch(e){case w:case T:case $:return function(){return new a(this,e)}}return function(){return new a(this)}},M=t+" Iterator",C=!1,I=e.prototype,D=I[S]||I["@@iterator"]||m&&I[m],O=!y&&D||A(m),P="Array"===t&&I.entries||D;if(P&&((R=u(P.call(new e)))!==Object.prototype&&R.next&&(!r&&u(R)!==v&&(h?h(R,v):n(R[S])||c(R,S,k)),d(R,M,!0,!0),r&&(f[M]=k))),g&&m===T&&D&&D.name!==T&&(!r&&b?l(I,"name",T):(C=!0,O=function(){return s(D,this)})),m)if(E={values:A(T),keys:x?O:A(w),entries:A($)},L)for(B in E)(y||C||!(B in I))&&c(I,B,E[B]);else i({target:t,proto:!0,forced:y||C},E);return(!r||L)&&I[S]!==O&&c(I,S,O,{name:m}),f[t]=O,E}})),at=m(((e,t)=>{"use strict";t.exports=function(e,t){return{value:e,done:t}}})),nt=m(((e,t)=>{"use strict";var i=C(),s=Ae(),r=Ne(),a=je(),n=he().f,o=rt(),u=at(),h=W(),d=k(),l="Array Iterator",c=a.set,p=a.getterFor(l);t.exports=o(Array,"Array",(function(e,t){c(this,{type:l,target:i(e),index:0,kind:t})}),(function(){var e=p(this),t=e.target,i=e.index++;if(!t||i>=t.length)return e.target=null,u(void 0,!0);switch(e.kind){case"keys":return u(i,!1);case"values":return u(t[i],!1)}return u([i,t[i]],!1)}),"values");var f=r.Arguments=r.Array;if(s("keys"),s("values"),s("entries"),!h&&d&&"values"!==f.name)try{n(f,"name",{value:"values"})}catch{}})),ot=m(((e,t)=>{"use strict";var i=K(),s=Ne(),r=i("iterator"),a=Array.prototype;t.exports=function(e){return void 0!==e&&(s.Array===e||a[r]===e)}})),ut=m(((e,t)=>{"use strict";var i=Ze(),s=z(),r=A(),a=Ne(),n=K()("iterator");t.exports=function(e){if(!r(e))return s(e,n)||s(e,"@@iterator")||a[i(e)]}})),ht=m(((e,t)=>{"use strict";var i=L(),s=q(),r=ue(),a=j(),n=ut(),o=TypeError;t.exports=function(e,t){var u=arguments.length<2?n(e):t;if(s(u))return r(i(u,e));throw new o(a(e)+" is not iterable")}})),dt=m(((e,t)=>{"use strict";var i=L(),s=ue(),r=z();t.exports=function(e,t,a){var n,o;s(e);try{if(!(n=r(e,"return"))){if("throw"===t)throw a;return a}n=i(n,e)}catch(e){o=!0,n=e}if("throw"===t)throw a;if(o)throw n;return s(n),a}})),lt=m(((e,t)=>{"use strict";var i=ne(),s=L(),r=ue(),a=j(),n=ot(),o=ye(),u=P(),h=ht(),d=ut(),l=dt(),c=TypeError,p=function(e,t){this.stopped=e,this.result=t},f=p.prototype;t.exports=function(e,t,m){var g,b,v,y,S,w,T,$=m&&m.that,x=!(!m||!m.AS_ENTRIES),k=!(!m||!m.IS_RECORD),L=!(!m||!m.IS_ITERATOR),R=!(!m||!m.INTERRUPTED),E=i(t,$),B=function(e){return g&&l(g,"normal"),new p(!0,e)},A=function(e){return x?(r(e),R?E(e[0],e[1],B):E(e[0],e[1])):R?E(e,B):E(e)};if(k)g=e.iterator;else if(L)g=e;else{if(!(b=d(e)))throw new c(a(e)+" is not iterable");if(n(b)){for(v=0,y=o(e);y>v;v++)if((S=A(e[v]))&&u(f,S))return S;return new p(!1)}g=h(e,b)}for(w=k?e.next:g.next;!(T=s(w,g)).done;){try{S=A(T.value)}catch(e){l(g,"throw",e)}if("object"==typeof S&&S&&u(f,S))return S}return new p(!1)}})),ct=m(((e,t)=>{"use strict";var i=k(),s=he(),r=E();t.exports=function(e,t,a){i?s.f(e,t,r(0,a)):e[t]=a}})),pt=m((()=>{"use strict";var e=le(),t=lt(),i=ct();e({target:"Object",stat:!0},{fromEntries:function(e){var s={};return t(e,(function(e,t){i(s,e,t)}),{AS_ENTRIES:!0}),s}})})),ft=m(((e,t)=>{"use strict";nt(),pt();var i=D();t.exports=i.Object.fromEntries})),mt=m(((e,t)=>{"use strict";t.exports={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0}})),gt=m((()=>{"use strict";nt();var e,t=mt(),i=b(),s=Je(),r=Ne();for(e in t)s(i[e],e),r[e]=r.Array})),bt=m(((e,t)=>{"use strict";var i=ft();gt(),t.exports=i})),vt=m(((e,t)=>{"use strict";var i=bt();t.exports=i})),yt=m((()=>{})),St=m(((e,t)=>{"use strict";var i=b(),s=V(),r=T(),a=function(e){return s.slice(0,e.length)===e};t.exports=a("Bun/")?"BUN":a("Cloudflare-Workers")?"CLOUDFLARE":a("Deno/")?"DENO":a("Node.js/")?"NODE":i.Bun&&"string"==typeof Bun.version?"BUN":i.Deno&&"object"==typeof Deno.version?"DENO":"process"===r(i.process)?"NODE":i.window&&i.document?"BROWSER":"REST"})),wt=m(((e,t)=>{"use strict";var i=St();t.exports="NODE"===i})),Tt=m(((e,t)=>{"use strict";var i=he();t.exports=function(e,t,s){return i.f(e,t,s)}})),$t=m(((e,t)=>{"use strict";var i=O(),s=Tt(),r=K(),a=k(),n=r("species");t.exports=function(e){var t=i(e);a&&t&&!t[n]&&s(t,n,{configurable:!0,get:function(){return this}})}})),xt=m(((e,t)=>{"use strict";var i=P(),s=TypeError;t.exports=function(e,t){if(i(t,e))return e;throw new s("Incorrect invocation")}})),kt=m(((e,t)=>{"use strict";var i=w(),s=x(),r=X(),a=i(Function.toString);s(r.inspectSource)||(r.inspectSource=function(e){return a(e)}),t.exports=r.inspectSource})),Lt=m(((e,t)=>{"use strict";var i=w(),s=v(),r=x(),a=Ze(),n=O(),o=kt(),u=function(){},h=n("Reflect","construct"),d=/^\s*(?:class|function)\b/,l=i(d.exec),c=!d.test(u),p=function(e){if(!r(e))return!1;try{return h(u,[],e),!0}catch{return!1}},f=function(e){if(!r(e))return!1;switch(a(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return c||!!l(d,o(e))}catch{return!0}};f.sham=!0,t.exports=!h||s((function(){var e;return p(p.call)||!p(Object)||!p((function(){e=!0}))||e}))?f:p})),Rt=m(((e,t)=>{"use strict";var i=Lt(),s=j(),r=TypeError;t.exports=function(e){if(i(e))return e;throw new r(s(e)+" is not a constructor")}})),Et=m(((e,t)=>{"use strict";var i=ue(),s=Rt(),r=A(),a=K()("species");t.exports=function(e,t){var n,o=i(e).constructor;return void 0===o||r(n=i(o)[a])?t:s(n)}})),Bt=m(((e,t)=>{"use strict";var i=w();t.exports=i([].slice)})),At=m(((e,t)=>{"use strict";var i=TypeError;t.exports=function(e,t){if(e<t)throw new i("Not enough arguments");return e}})),Mt=m(((e,t)=>{"use strict";var i=V();t.exports=/(?:ipad|iphone|ipod).*applewebkit/i.test(i)})),Ct=m(((e,t)=>{"use strict";var i,s,r,a,n=b(),o=S(),u=ne(),h=x(),d=Y(),l=v(),c=He(),p=Bt(),f=ie(),m=At(),g=Mt(),y=wt(),w=n.setImmediate,T=n.clearImmediate,$=n.process,k=n.Dispatch,L=n.Function,R=n.MessageChannel,E=n.String,B=0,A={},M="onreadystatechange";l((function(){i=n.location}));var C=function(e){if(d(A,e)){var t=A[e];delete A[e],t()}},I=function(e){return function(){C(e)}},D=function(e){C(e.data)},O=function(e){n.postMessage(E(e),i.protocol+"//"+i.host)};(!w||!T)&&(w=function(e){m(arguments.length,1);var t=h(e)?e:L(e),i=p(arguments,1);return A[++B]=function(){o(t,void 0,i)},s(B),B},T=function(e){delete A[e]},y?s=function(e){$.nextTick(I(e))}:k&&k.now?s=function(e){k.now(I(e))}:R&&!g?(a=(r=new R).port2,r.port1.onmessage=D,s=u(a.postMessage,a)):n.addEventListener&&h(n.postMessage)&&!n.importScripts&&i&&"file:"!==i.protocol&&!l(O)?(s=O,n.addEventListener("message",D,!1)):s=M in f("script")?function(e){c.appendChild(f("script"))[M]=function(){c.removeChild(this),C(e)}}:function(e){setTimeout(I(e),0)}),t.exports={set:w,clear:T}})),It=m(((e,t)=>{"use strict";var i=b(),s=k(),r=Object.getOwnPropertyDescriptor;t.exports=function(e){if(!s)return i[e];var t=r(i,e);return t&&t.value}})),Dt=m(((e,t)=>{"use strict";var i=function(){this.head=null,this.tail=null};i.prototype={add:function(e){var t={item:e,next:null},i=this.tail;i?i.next=t:this.head=t,this.tail=t},get:function(){var e=this.head;if(e)return null===(this.head=e.next)&&(this.tail=null),e.item}},t.exports=i})),Ot=m(((e,t)=>{"use strict";var i=V();t.exports=/ipad|iphone|ipod/i.test(i)&&typeof Pebble<"u"})),Pt=m(((e,t)=>{"use strict";var i=V();t.exports=/web0s(?!.*chrome)/i.test(i)})),Vt=m(((e,t)=>{"use strict";var i,s,r,a,n,o,u,h=b(),d=It(),l=ne(),c=Ct().set,p=Dt(),f=Mt(),m=Ot(),g=Pt(),v=wt(),y=h.MutationObserver||h.WebKitMutationObserver,S=h.document,w=h.process,T=h.Promise,$=d("queueMicrotask");$||(o=new p,u=function(){var e,t;for(v&&(e=w.domain)&&e.exit();t=o.get();)try{t()}catch(e){throw o.head&&i(),e}e&&e.enter()},f||v||g||!y||!S?!m&&T&&T.resolve?((a=T.resolve(void 0)).constructor=T,n=l(a.then,a),i=function(){n(u)}):v?i=function(){w.nextTick(u)}:(c=l(c,h),i=function(){c(u)}):(s=!0,r=S.createTextNode(""),new y(u).observe(r,{characterData:!0}),i=function(){r.data=s=!s}),$=function(e){o.head||i(),o.add(e)}),t.exports=$})),_t=m(((e,t)=>{"use strict";t.exports=function(e,t){try{1===arguments.length?console.error(e):console.error(e,t)}catch{}}})),Ft=m(((e,t)=>{"use strict";t.exports=function(e){try{return{error:!1,value:e()}}catch(e){return{error:!0,value:e}}}})),Nt=m(((e,t)=>{"use strict";var i=b();t.exports=i.Promise})),Ut=m(((e,t)=>{"use strict";var i=b(),s=Nt(),r=x(),a=ae(),n=kt(),o=K(),u=St(),h=W(),d=_(),l=s&&s.prototype,c=o("species"),p=!1,f=r(i.PromiseRejectionEvent),m=a("Promise",(function(){var e=n(s),t=e!==String(s);if(!t&&66===d||h&&(!l.catch||!l.finally))return!0;if(!d||d<51||!/native code/.test(e)){var i=new s((function(e){e(1)})),r=function(e){e((function(){}),(function(){}))};if((i.constructor={})[c]=r,!(p=i.then((function(){}))instanceof r))return!0}return!(t||"BROWSER"!==u&&"DENO"!==u||f)}));t.exports={CONSTRUCTOR:m,REJECTION_EVENT:f,SUBCLASSING:p}})),jt=m(((e,t)=>{"use strict";var i=q(),s=TypeError,r=function(e){var t,r;this.promise=new e((function(e,i){if(void 0!==t||void 0!==r)throw new s("Bad Promise constructor");t=e,r=i})),this.resolve=i(t),this.reject=i(r)};t.exports.f=function(e){return new r(e)}})),qt=m((()=>{"use strict";var e,t,i,s,r=le(),a=W(),n=wt(),o=b(),u=D(),h=L(),d=Qe(),l=st(),c=Je(),p=$t(),f=q(),m=x(),g=I(),v=xt(),y=Et(),S=Ct().set,w=Vt(),T=_t(),$=Ft(),k=Dt(),R=je(),E=Nt(),B=Ut(),A=jt(),M="Promise",C=B.CONSTRUCTOR,O=B.REJECTION_EVENT,P=B.SUBCLASSING,V=R.getterFor(M),_=R.set,F=E&&E.prototype,N=E,U=F,j=o.TypeError,z=o.document,H=o.process,Q=A.f,X=Q,G=!!(z&&z.createEvent&&o.dispatchEvent),Z="unhandledrejection",Y=function(e){var t;return!(!g(e)||!m(t=e.then))&&t},J=function(e,t){var i,s,r,a=t.value,n=1===t.state,o=n?e.ok:e.fail,u=e.resolve,d=e.reject,l=e.domain;try{o?(n||(2===t.rejection&&se(t),t.rejection=1),!0===o?i=a:(l&&l.enter(),i=o(a),l&&(l.exit(),r=!0)),i===e.promise?d(new j("Promise-chain cycle")):(s=Y(i))?h(s,i,u,d):u(i)):d(a)}catch(e){l&&!r&&l.exit(),d(e)}},K=function(e,t){e.notified||(e.notified=!0,w((function(){for(var i,s=e.reactions;i=s.get();)J(i,e);e.notified=!1,t&&!e.rejection&&te(e)})))},ee=function(e,t,i){var s,r;G?((s=z.createEvent("Event")).promise=t,s.reason=i,s.initEvent(e,!1,!0),o.dispatchEvent(s)):s={promise:t,reason:i},!O&&(r=o["on"+e])?r(s):e===Z&&T("Unhandled promise rejection",i)},te=function(e){h(S,o,(function(){var t,i=e.facade,s=e.value;if(ie(e)&&(t=$((function(){n?H.emit("unhandledRejection",s,i):ee(Z,i,s)})),e.rejection=n||ie(e)?2:1,t.error))throw t.value}))},ie=function(e){return 1!==e.rejection&&!e.parent},se=function(e){h(S,o,(function(){var t=e.facade;n?H.emit("rejectionHandled",t):ee("rejectionhandled",t,e.value)}))},re=function(e,t,i){return function(s){e(t,s,i)}},ae=function(e,t,i){e.done||(e.done=!0,i&&(e=i),e.value=t,e.state=2,K(e,!0))},ne=function(e,t,i){if(!e.done){e.done=!0,i&&(e=i);try{if(e.facade===t)throw new j("Promise can't be resolved itself");var s=Y(t);s?w((function(){var i={done:!1};try{h(s,t,re(ne,i,e),re(ae,i,e))}catch(t){ae(i,t,e)}})):(e.value=t,e.state=1,K(e,!1))}catch(t){ae({done:!1},t,e)}}};if(C&&(U=(N=function(t){v(this,U),f(t),h(e,this);var i=V(this);try{t(re(ne,i),re(ae,i))}catch(e){ae(i,e)}}).prototype,(e=function(e){_(this,{type:M,done:!1,notified:!1,parent:!1,reactions:new k,rejection:!1,state:0,value:null})}).prototype=d(U,"then",(function(e,t){var i=V(this),s=Q(y(this,N));return i.parent=!0,s.ok=!m(e)||e,s.fail=m(t)&&t,s.domain=n?H.domain:void 0,0===i.state?i.reactions.add(s):w((function(){J(s,i)})),s.promise})),t=function(){var t=new e,i=V(t);this.promise=t,this.resolve=re(ne,i),this.reject=re(ae,i)},A.f=Q=function(e){return e===N||e===i?new t(e):X(e)},!a&&m(E)&&F!==Object.prototype)){s=F.then,P||d(F,"then",(function(e,t){var i=this;return new N((function(e,t){h(s,i,e,t)})).then(e,t)}),{unsafe:!0});try{delete F.constructor}catch{}l&&l(F,U)}r({global:!0,constructor:!0,wrap:!0,forced:C},{Promise:N}),i=u.Promise,c(N,M,!1,!0),p(M)})),zt=m(((e,t)=>{"use strict";var i,s,r=K()("iterator"),a=!1;try{i=0,(s={next:function(){return{done:!!i++}},return:function(){a=!0}})[r]=function(){return this},Array.from(s,(function(){throw 2}))}catch{}t.exports=function(e,t){try{if(!t&&!a)return!1}catch{return!1}var i=!1;try{var s={};s[r]=function(){return{next:function(){return{done:i=!0}}}},e(s)}catch{}return i}})),Ht=m(((e,t)=>{"use strict";var i=Nt(),s=zt(),r=Ut().CONSTRUCTOR;t.exports=r||!s((function(e){i.all(e).then(void 0,(function(){}))}))})),Wt=m((()=>{"use strict";var e=le(),t=L(),i=q(),s=jt(),r=Ft(),a=lt();e({target:"Promise",stat:!0,forced:Ht()},{all:function(e){var n=this,o=s.f(n),u=o.resolve,h=o.reject,d=r((function(){var s=i(n.resolve),r=[],o=0,d=1;a(e,(function(e){var i=o++,a=!1;d++,t(s,n,e).then((function(e){a||(a=!0,r[i]=e,--d||u(r))}),h)})),--d||u(r)}));return d.error&&h(d.value),o.promise}})})),Qt=m((()=>{"use strict";var e,t=le(),i=W(),s=Ut().CONSTRUCTOR,r=Nt(),a=O(),n=x(),o=Qe(),u=r&&r.prototype;t({target:"Promise",proto:!0,forced:s,real:!0},{catch:function(e){return this.then(void 0,e)}}),!i&&n(r)&&(e=a("Promise").prototype.catch,u.catch!==e&&o(u,"catch",e,{unsafe:!0}))})),Xt=m((()=>{"use strict";var e=le(),t=L(),i=q(),s=jt(),r=Ft(),a=lt();e({target:"Promise",stat:!0,forced:Ht()},{race:function(e){var n=this,o=s.f(n),u=o.reject,h=r((function(){var s=i(n.resolve);a(e,(function(e){t(s,n,e).then(o.resolve,u)}))}));return h.error&&u(h.value),o.promise}})})),Gt=m((()=>{"use strict";var e=le(),t=jt();e({target:"Promise",stat:!0,forced:Ut().CONSTRUCTOR},{reject:function(e){var i=t.f(this);return(0,i.reject)(e),i.promise}})})),Zt=m(((e,t)=>{"use strict";var i=ue(),s=I(),r=jt();t.exports=function(e,t){if(i(e),s(t)&&t.constructor===e)return t;var a=r.f(e);return(0,a.resolve)(t),a.promise}})),Yt=m((()=>{"use strict";var e=le(),t=O(),i=W(),s=Nt(),r=Ut().CONSTRUCTOR,a=Zt(),n=t("Promise"),o=i&&!r;e({target:"Promise",stat:!0,forced:i||r},{resolve:function(e){return a(o&&this===n?s:this,e)}})})),Jt=m((()=>{"use strict";qt(),Wt(),Qt(),Xt(),Gt(),Yt()})),Kt=m((()=>{"use strict";var e,t=le(),i=W(),s=Nt(),r=v(),a=O(),n=x(),o=Et(),u=Zt(),h=Qe(),d=s&&s.prototype;t({target:"Promise",proto:!0,real:!0,forced:!!s&&r((function(){d.finally.call({then:function(){}},(function(){}))}))},{finally:function(e){var t=o(this,a("Promise")),i=n(e);return this.then(i?function(i){return u(t,e()).then((function(){return i}))}:e,i?function(i){return u(t,e()).then((function(){throw i}))}:e)}}),!i&&n(s)&&(e=a("Promise").prototype.finally,d.finally!==e&&h(d,"finally",e,{unsafe:!0}))})),ei=m(((e,t)=>{"use strict";yt(),Jt(),Kt();var i=Ce();t.exports=i("Promise","finally")})),ti=m(((e,t)=>{"use strict";var i=ei();t.exports=i})),ii=m(((e,t)=>{"use strict";var i=ti();t.exports=i})),si=m((()=>{"use strict";var e=le(),t=Z(),i=ye(),s=ge(),r=Ae();e({target:"Array",proto:!0},{at:function(e){var r=t(this),a=i(r),n=s(e),o=n>=0?n:a+n;return o<0||o>=a?void 0:r[o]}}),r("at")})),ri=m(((e,t)=>{"use strict";si();var i=Ce();t.exports=i("Array","at")})),ai=m(((e,t)=>{"use strict";var i=ri();t.exports=i})),ni=m(((e,t)=>{"use strict";var i=ai();t.exports=i})),oi=m(((e,t)=>{"use strict";var i=T();t.exports=Array.isArray||function(e){return"Array"===i(e)}})),ui=m(((e,t)=>{"use strict";var i=TypeError;t.exports=function(e){if(e>9007199254740991)throw i("Maximum allowed index exceeded");return e}})),hi=m(((e,t)=>{"use strict";var i=oi(),s=ye(),r=ui(),a=ne(),n=function(e,t,o,u,h,d,l,c){for(var p,f,m=h,g=0,b=!!l&&a(l,c);g<u;)g in o&&(p=b?b(o[g],g,t):o[g],d>0&&i(p)?(f=s(p),m=n(e,t,p,f,m,d-1)-1):(r(m+1),e[m]=p),m++),g++;return m};t.exports=n})),di=m(((e,t)=>{"use strict";var i=oi(),s=Lt(),r=I(),a=K()("species"),n=Array;t.exports=function(e){var t;return i(e)&&(t=e.constructor,s(t)&&(t===n||i(t.prototype))?t=void 0:r(t)&&(null===(t=t[a])&&(t=void 0))),void 0===t?n:t}})),li=m(((e,t)=>{"use strict";var i=di();t.exports=function(e,t){return new(i(e))(0===t?0:t)}})),ci=m((()=>{"use strict";var e=le(),t=hi(),i=q(),s=Z(),r=ye(),a=li();e({target:"Array",proto:!0},{flatMap:function(e){var n,o=s(this),u=r(o);return i(e),(n=a(o,0)).length=t(n,o,o,u,0,1,e,arguments.length>1?arguments[1]:void 0),n}})})),pi=m((()=>{"use strict";Ae()("flatMap")})),fi=m(((e,t)=>{"use strict";ci(),pi();var i=Ce();t.exports=i("Array","flatMap")})),mi=m(((e,t)=>{"use strict";var i=fi();t.exports=i})),gi=m(((e,t)=>{"use strict";var i=mi();t.exports=i})),bi=m(((e,t)=>{"use strict";var i=Ze(),s=String;t.exports=function(e){if("Symbol"===i(e))throw new TypeError("Cannot convert a Symbol value to a string");return s(e)}})),vi=m(((e,t)=>{"use strict";t.exports="\t\n\v\f\r                　\u2028\u2029\ufeff"})),yi=m(((e,t)=>{"use strict";var i=w(),s=M(),r=bi(),a=vi(),n=i("".replace),o=RegExp("^["+a+"]+"),u=RegExp("(^|[^"+a+"])["+a+"]+$"),h=function(e){return function(t){var i=r(s(t));return 1&e&&(i=n(i,o,"")),2&e&&(i=n(i,u,"$1")),i}};t.exports={start:h(1),end:h(2),trim:h(3)}})),Si=m(((e,t)=>{"use strict";var i=qe().PROPER,s=v(),r=vi();t.exports=function(e){return s((function(){return!!r[e]()||"​᠎"!=="​᠎"[e]()||i&&r[e].name!==e}))}})),wi=m(((e,t)=>{"use strict";var i=yi().start,s=Si();t.exports=s("trimStart")?function(){return i(this)}:"".trimStart})),Ti=m((()=>{"use strict";var e=le(),t=wi();e({target:"String",proto:!0,name:"trimStart",forced:"".trimLeft!==t},{trimLeft:t})})),$i=m((()=>{"use strict";Ti();var e=le(),t=wi();e({target:"String",proto:!0,name:"trimStart",forced:"".trimStart!==t},{trimStart:t})})),xi=m(((e,t)=>{"use strict";$i();var i=Ce();t.exports=i("String","trimLeft")})),ki=m(((e,t)=>{"use strict";var i=xi();t.exports=i})),Li=m(((e,t)=>{"use strict";var i=ki();t.exports=i})),Ri=m((()=>{})),Ei=m((()=>{})),Bi=m(((e,t)=>{"use strict";var i=I(),s=T(),r=K()("match");t.exports=function(e){var t;return i(e)&&(void 0!==(t=e[r])?!!t:"RegExp"===s(e))}})),Ai=m(((e,t)=>{"use strict";var i=b(),s=v(),r=i.RegExp,a=!s((function(){var e=!0;try{r(".","d")}catch{e=!1}var t={},i="",s=e?"dgimsy":"gimsy",a=function(e,s){Object.defineProperty(t,e,{get:function(){return i+=s,!0}})},n={dotAll:"s",global:"g",ignoreCase:"i",multiline:"m",sticky:"y"};for(var o in e&&(n.hasIndices="d"),n)a(o,n[o]);return Object.getOwnPropertyDescriptor(r.prototype,"flags").get.call(t)!==s||i!==s}));t.exports={correct:a}})),Mi=m(((e,t)=>{"use strict";var i=ue();t.exports=function(){var e=i(this),t="";return e.hasIndices&&(t+="d"),e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.unicodeSets&&(t+="v"),e.sticky&&(t+="y"),t}})),Ci=m(((e,t)=>{"use strict";var i=L(),s=Y(),r=P(),a=Ai(),n=Mi(),o=RegExp.prototype;t.exports=a.correct?function(e){return e.flags}:function(e){return a.correct||!r(o,e)||s(e,"flags")?e.flags:i(n,e)}})),Ii=m(((e,t)=>{"use strict";var i=w(),s=Z(),r=Math.floor,a=i("".charAt),n=i("".replace),o=i("".slice),u=/\$([$&'`]|\d{1,2}|<[^>]*>)/g,h=/\$([$&'`]|\d{1,2})/g;t.exports=function(e,t,i,d,l,c){var p=i+e.length,f=d.length,m=h;return void 0!==l&&(l=s(l),m=u),n(c,m,(function(s,n){var u;switch(a(n,0)){case"$":return"$";case"&":return e;case"`":return o(t,0,i);case"'":return o(t,p);case"<":u=l[o(n,1,-1)];break;default:var h=+n;if(0===h)return s;if(h>f){var c=r(h/10);return 0===c?s:c<=f?void 0===d[c-1]?a(n,1):d[c-1]+a(n,1):s}u=d[h-1]}return void 0===u?"":u}))}})),Di=m((()=>{"use strict";var e=le(),t=L(),i=w(),s=M(),r=x(),a=I(),n=Bi(),o=bi(),u=z(),h=Ci(),d=Ii(),l=K(),c=W(),p=l("replace"),f=TypeError,m=i("".indexOf),g=i("".replace),b=i("".slice),v=Math.max;e({target:"String",proto:!0},{replaceAll:function(e,i){var l,y,S,w,T,$,x,k,L,R,E=s(this),B=0,A="";if(a(e)){if((l=n(e))&&(y=o(s(h(e))),!~m(y,"g")))throw new f("`.replaceAll` does not allow non-global regexes");if(S=u(e,p))return t(S,e,E,i);if(c&&l)return g(o(E),e,i)}for(w=o(E),T=o(e),($=r(i))||(i=o(i)),x=T.length,k=v(1,x),L=m(w,T);-1!==L;)R=$?o(i(T,L,w)):d(T,w,L,[],void 0,i),A+=b(w,B,L)+R,B=L+x,L=L+k>w.length?-1:m(w,T,L+k);return B<w.length&&(A+=b(w,B)),A}})})),Oi=m(((e,t)=>{"use strict";Ri(),Ei(),Di();var i=Ce();t.exports=i("String","replaceAll")})),Pi=m(((e,t)=>{"use strict";var i=Oi();t.exports=i})),Vi=m(((e,t)=>{"use strict";var i=Pi();t.exports=i})),_i=m(((e,t)=>{"use strict";var i=ge(),s=bi(),r=M(),a=RangeError;t.exports=function(e){var t=s(r(this)),n="",o=i(e);if(o<0||o===1/0)throw new a("Wrong number of repetitions");for(;o>0;(o>>>=1)&&(t+=t))1&o&&(n+=t);return n}})),Fi=m(((e,t)=>{"use strict";var i=w(),s=ve(),r=bi(),a=_i(),n=M(),o=i(a),u=i("".slice),h=Math.ceil,d=function(e){return function(t,i,a){var d,l,c=r(n(t)),p=s(i),f=c.length,m=void 0===a?" ":r(a);return p<=f||""===m?c:((l=o(m,h((d=p-f)/m.length))).length>d&&(l=u(l,0,d)),e?c+l:l+c)}};t.exports={start:d(!1),end:d(!0)}})),Ni=m(((e,t)=>{"use strict";var i=V();t.exports=/Version\/10(?:\.\d+){1,2}(?: [\w./]+)?(?: Mobile\/\w+)? Safari\//.test(i)})),Ui=m((()=>{"use strict";var e=le(),t=Fi().start;e({target:"String",proto:!0,forced:Ni()},{padStart:function(e){return t(this,e,arguments.length>1?arguments[1]:void 0)}})})),ji=m(((e,t)=>{"use strict";Ui();var i=Ce();t.exports=i("String","padStart")})),qi=m(((e,t)=>{"use strict";var i=ji();t.exports=i})),zi=m(((e,t)=>{"use strict";var i=qi();t.exports=i})),Hi="2.0.149",Wi=((a=Wi||{}).STOPPED="stopped",a.READY="ready",a.PLAYING="playing",a.PAUSED="paused",a),Qi=((r=Qi||{}).MPEG="MPEG",r.DASH="DASH",r.DASH_SEP="DASH_SEP",r.DASH_SEP_VK="DASH_SEP",r.DASH_WEBM="DASH_WEBM",r.DASH_WEBM_AV1="DASH_WEBM_AV1",r.DASH_STREAMS="DASH_STREAMS",r.DASH_WEBM_VK="DASH_WEBM",r.DASH_ONDEMAND="DASH_ONDEMAND",r.DASH_ONDEMAND_VK="DASH_ONDEMAND",r.DASH_LIVE="DASH_LIVE",r.DASH_LIVE_CMAF="DASH_LIVE_CMAF",r.DASH_LIVE_WEBM="DASH_LIVE_WEBM",r.HLS="HLS",r.HLS_ONDEMAND="HLS_ONDEMAND",r.HLS_JS="HLS",r.HLS_FMP4="HLS_FMP4",r.HLS_LIVE="HLS_LIVE",r.HLS_LIVE_CMAF="HLS_LIVE_CMAF",r.WEB_RTC_LIVE="WEB_RTC_LIVE",r),Xi=(e=>(e.NOT_AVAILABLE="NOT_AVAILABLE",e.AVAILABLE="AVAILABLE",e.CONNECTING="CONNECTING",e.CONNECTED="CONNECTED",e))(Xi||{}),Gi=((n=Gi||{}).HTTP1="http1",n.HTTP2="http2",n.QUIC="quic",n),Zi=((o=Zi||{}).NONE="none",o.INLINE="inline",o.FULLSCREEN="fullscreen",o.SECOND_SCREEN="second_screen",o.PIP="pip",o.INVISIBLE="invisible",o),Yi=(e=>(e.TRAFFIC_SAVING="traffic_saving",e.HIGH_QUALITY="high_quality",e.UNKNOWN="unknown",e))(Yi||{}),Ji=g(Be(),1),Ki=g(Oe(),1),es=class{connect(){cast.framework.CastContext.getInstance()?.requestSession()}disconnect(){cast.framework.CastContext.getInstance()?.getCurrentSession()?.endSession(!0)}stopMedia(){return new Promise(((e,t)=>{cast.framework.CastContext.getInstance()?.getCurrentSession()?.getMediaSession()?.stop(new chrome.cast.media.StopRequest,e,t)}))}toggleConnection(){(0,u.R)(this.connection$.getValue())?this.disconnect():this.connect()}setVolume(e){let t=this.connection$.getValue();(0,u.wD)(t)||(t.remotePlayer.volumeLevel=e,t.remotePlayerController.setVolumeLevel())}setMuted(e){let t=this.connection$.getValue();(0,u.wD)(t)||e!==t.remotePlayer.isMuted&&t.remotePlayerController.muteOrUnmute()}destroy(){this.isDestroyed=!0,this.subscription.unsubscribe()}initListeners(){let e=new cast.framework.RemotePlayer,t=new cast.framework.RemotePlayerController(e),i=cast.framework.CastContext.getInstance();this.subscription.add((0,u.Rt)(i,cast.framework.CastContextEventType.SESSION_STATE_CHANGED).subscribe((e=>{switch(e.sessionState){case cast.framework.SessionState.SESSION_STARTED:case cast.framework.SessionState.SESSION_STARTING:case cast.framework.SessionState.SESSION_RESUMED:this.contentId=i.getCurrentSession()?.getMediaSession()?.media?.contentId;break;case cast.framework.SessionState.NO_SESSION:case cast.framework.SessionState.SESSION_ENDING:case cast.framework.SessionState.SESSION_ENDED:case cast.framework.SessionState.SESSION_START_FAILED:this.contentId=void 0;break;default:return(0,u.xb)(e.sessionState)}}))).add((0,u.h1)((0,u.Rt)(i,cast.framework.CastContextEventType.CAST_STATE_CHANGED).pipe((0,u.Mi)((e=>{this.log({message:`[cast.framework.RemotePlayerEventType.CAST_STATE_CHANGED]: ${JSON.stringify(e)}`})})),(0,u.Tj)((e=>e.castState))),(0,u.Ss)([i.getCastState()])).pipe((0,u.jX)(),(0,u.Tj)(ts),(0,u.Mi)((e=>{this.log({message:`realCastState$: ${e}`})}))).subscribe(this.realCastState$)).add(this.realCastState$.subscribe((s=>{let r="CONNECTED"===s,a=(0,u.R)(this.connection$.getValue());if(r&&!a){let s=i.getCurrentSession();(0,u.tZ)(s);let r=s.getCastDevice(),a=s.getMediaSession()?.media?.contentId;((0,u.wD)(a)||a===this.contentId)&&(this.log({message:"connection created"}),this.connection$.next({remotePlayer:e,remotePlayerController:t,session:s,castDevice:r}))}else!r&&a&&(this.log({message:"connection destroyed"}),this.connection$.next(void 0));this.castState$.next("CONNECTED"===s?(0,u.R)(this.connection$.getValue())?"CONNECTED":"AVAILABLE":s)})))}initializeCastApi(){let e,t,i;try{e=cast.framework.CastContext.getInstance(),t=chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,i=chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED}catch{return}try{e.setOptions({receiverApplicationId:this.params.receiverApplicationId??t,autoJoinPolicy:i}),this.initListeners()}catch(e){this.errorEvent$.next({id:"ChromecastInitializer",category:u.h.EXTERNAL_API,message:"[initializeCastApi] failed",thrown:e})}}constructor(e){this.connection$=new u.Ot(void 0),this.castState$=new u.Ot("NOT_AVAILABLE"),this.errorEvent$=new u.B7,this.realCastState$=new u.Ot("NOT_AVAILABLE"),this.subscription=new u.yU,this.isDestroyed=!1,this.params=e,this.log=this.params.dependencies.logger.createComponentLog("ChromecastInitializer");let t="chrome"in window;if(this.log({message:`[constructor] receiverApplicationId: ${this.params.receiverApplicationId}, isDisabled: ${this.params.isDisabled}, isSupported: ${t}`}),e.isDisabled||!t)return;let s=(0,u.R)(window.chrome?.cast),r=!!window.__onGCastApiAvailable;var a;s?this.initializeCastApi():(i._dG("__onGCastApiAvailable",(e=>{delete window.__onGCastApiAvailable,e&&!this.isDestroyed&&this.initializeCastApi()})),r||(a="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1",new Promise(((e,t)=>{let i=document.createElement("script");i.setAttribute("src",a),i.onload=()=>e(),i.onerror=e=>t(e),document.body.appendChild(i)}))).catch((()=>this.errorEvent$.next({id:"ChromecastLoading",category:u.h.NETWORK,message:"Script loading failed!"}))))}},ts=e=>{switch(e){case cast.framework.CastState.NO_DEVICES_AVAILABLE:return"NOT_AVAILABLE";case cast.framework.CastState.NOT_CONNECTED:return"AVAILABLE";case cast.framework.CastState.CONNECTING:return"CONNECTING";case cast.framework.CastState.CONNECTED:return"CONNECTED";default:return(0,u.xb)(e)}},is=(e,t=0,i=0)=>{switch(i){case 0:return e.replace("_offset_p",0===t?"":"_"+t.toFixed(0));case 1:{if(0===t)return e;let i=new URL(e);return i.searchParams.append("playback_shift",t.toFixed(0)),i.toString()}case 2:{let i=new URL(e);return i.searchParams.get("offset_p")||0!==t?(i.searchParams.set("offset_p",t.toFixed(0)),i.toString()):e}default:(0,u.xb)(i)}return e},ss=(e,t)=>{switch(t){case 0:return NaN;case 1:{let t=new URL(e);return Number(t.searchParams.get("playback_shift"))}case 2:{let t=new URL(e);return Number(t.searchParams.get("offset_p")??0)}default:(0,u.xb)(t)}},rs=e=>{let t,i,s,{source:r,format:a,meta:n,output:o}=e;switch(a){case"MPEG":{let e=r[a];(0,u.tZ)(e);let n=(0,u.sm)(Object.keys(e));(0,u.tZ)(n);let o=e[n];(0,u.tZ)(o),t=o,i="video/mp4",s=as();break}case"HLS":case"HLS_FMP4":case"HLS_ONDEMAND":{let e=r[a];(0,u.tZ)(e),t=e.url,i="application/x-mpegurl",s=as();break}case"DASH_SEP":case"DASH_ONDEMAND":case"DASH_WEBM":case"DASH_WEBM_AV1":case"DASH_STREAMS":{let e=r[a];(0,u.tZ)(e),t=e.url,i="application/dash+xml",s=as();break}case"DASH_LIVE_CMAF":{let e=r[a];(0,u.tZ)(e),t=e.url,i="application/dash+xml",s=ns();break}case"HLS_LIVE":case"HLS_LIVE_CMAF":{let e=r[a];(0,u.tZ)(e),t=is(e.url),i="application/x-mpegurl",s=ns();break}case"DASH_LIVE":case"WEB_RTC_LIVE":{let e="Unsupported format for Chromecast",t=new Error(e);throw o.error$.next({id:"ChromecastProvider.createMediaInfo()",category:u.h.VIDEO_PIPELINE,message:e,thrown:t}),t}case"DASH":case"DASH_LIVE_WEBM":throw new Error(`${a} is no longer supported`);default:return(0,u.xb)(a)}let h=function(e,t){return chrome.cast?.media?.MediaInfo?new chrome.cast.media.MediaInfo(e,t):{contentId:e,contentType:t,metadata:{title:"",subtitle:""},streamType:as()}}(n.videoId??t,i);h.contentUrl=t,h.streamType=s,h.metadata=chrome.cast?.media?.GenericMediaMetadata?new chrome.cast.media.GenericMediaMetadata:{images:[],metadataType:0,releaseDate:"",subtitle:"",title:"",releaseYear:1970,type:0};let{title:d,subtitle:l}=n;return(0,u.R)(d)&&(h.metadata.title=d),(0,u.R)(l)&&(h.metadata.subtitle=l),h};function as(){return chrome.cast?.media?.StreamType?.BUFFERED??"BUFFERED"}function ns(){return chrome.cast?.media?.StreamType?.LIVE??"LIVE"}var os,us=(e,t,i=!1)=>{let s=e.getTransition();(i||!s||s.to===t)&&e.setState(t)},hs=class{start(e=0){clearInterval(this.interval),this.startVideoPosition=e,this.startTs=Date.now(),this.interval=window.setInterval((()=>{let e=(Date.now()-this.startTs)/1e3,t=this.startVideoPosition+e;this.params.output.position$.next(t)}),1e3)}pause(){clearInterval(this.interval)}destroy(){clearInterval(this.interval)}constructor(e){this.interval=0,this.params=e}},ds=g(Oe(),1),ls=class{get current(){return this._current}get isChrome(){return"Chrome"===this.current}get isChromiumBased(){return(0,ds.default)(["Chrome","Chromium","Opera","Yandex","Edge","SamsungBrowser"],this.current)}get isFirefox(){return"Firefox"===this.current}get isSafari(){return"Safari"===this.current}get isOpera(){return"Opera"===this.current}get isEdge(){return"Edge"===this.current}get isYandex(){return"Yandex"===this.current}get isSamsungBrowser(){return"SamsungBrowser"===this.current}get currentVersion(){return this._current_version}get chromeVersion(){return this._chromeVersion}get firefoxVersion(){return this._firefoxVersion}get safariVersion(){return this._safariVersion}get operaVersion(){return this._operaVersion}get edgeVersion(){return this._edgeVersion}get yandexVersion(){return this._yandexVersion}get isMiuiBrowser(){return this._isMiuiBrowser}detect(){let{userAgent:e}=navigator;try{let t=/yabrowser/i.test(e)?"Yandex":void 0,i=/samsungbrowser/i.test(e)?"SamsungBrowser":void 0,s=/chrome|crios/i.test(e)?"Chrome":void 0,r=/chromium/i.test(e)?"Chromium":void 0,a=/firefox|fxios/i.test(e)?"Firefox":void 0,n=/webkit|safari|khtml/i.test(e)?"Safari":void 0,o=/opr\//i.test(e)?"Opera":void 0,u=/edg/i.test(e)?"Edge":void 0;this._isMiuiBrowser=/(XiaoMi)|(MiuiBrowser)/i.test(e),this._current=t||i||a||o||u||s||r||n||"Rest"}catch(e){console.error(e)}this.isChrome&&this.detectChromeVersion(),this.isFirefox&&this.detectFirefoxVersion(),this.isSafari&&this.detectSafariVersion(),this.isOpera&&this.detectOperaVersion(),this.isEdge&&this.detectEdgeVersion(),this.isYandex&&this.detectYandexVersion()}detectVersion(e){try{let{userAgent:t}=window.navigator,i=t.match(e);if(!i)return;let s=i[1],r=parseInt(s,10);if(!isNaN(r))return this._current_version=r,r}catch(e){console.error(e)}}detectChromeVersion(){this._chromeVersion=this.detectVersion(/Chrome\/(\d+\.\d+)/)}detectFirefoxVersion(){this._firefoxVersion=this.detectVersion(/Firefox\/(\d+\.\d+)/)}detectSafariVersion(){this._safariVersion=this.detectVersion(/Version\/(\d+)/)}detectOperaVersion(){this._operaVersion=this.detectVersion(/OPR\/(\d+\.\d+)/)}detectEdgeVersion(){this._edgeVersion=this.detectVersion(/Edg\/(\d+\.\d+)/)}detectYandexVersion(){this._yandexVersion=this.detectVersion(/YaBrowser\/(\d+\.\d+\.\d+)/)}constructor(){this._isMiuiBrowser=!1}},cs=g(Oe(),1),ps=()=>/Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(navigator.appVersion??navigator.userAgent)||navigator?.userAgentData?.mobile,fs=class{get current(){return this._current}get os(){return this._os}get details(){return this._details}get isIOS(){return"iOS"===this._highEntropyValues.platform||this.os.name.toLowerCase().includes("ios")||(0,cs.default)(["iPhone","iPad","iPod"],this.current)}get isMac(){return"macOS"===this._highEntropyValues.platform||this.os.name.toLowerCase().includes("mac")||"Mac"===this.current}get isApple(){return this.isIOS||this.isMac}get isIphoneOrOldIpad(){if(!this.isApple||!this._displayChecker.isTouch)return!1;let e="iPad"===this.current||this._displayChecker.width>700,t=this._iosVersion;return!e||e&&!!t&&t<16}get isAndroid(){return"Android"===this._highEntropyValues.platform||this.os.name.toLowerCase().includes("android")||"Android"===this.current}get isWindows(){return this.os.name.toLowerCase().includes("windows")}get isLinux(){return this.os.name.toLowerCase().includes("linux")&&!this.isAndroid}get isMobile(){return this._highEntropyValues.mobile||this._isMobile}get iOSVersion(){return this._iosVersion}detect(){let{userAgent:e}=navigator;try{this._isMobile=ps()}catch(e){console.error("DeviceChecker: calling isMobile error - ",e)}this.detectDevice(e),this.detectOS(e),this.detectDeviceDetails(e),this.detectHighEntropyValues(),this.isIOS&&this.detectIOSVersion()}async detectHighEntropyValues(){let{userAgentData:e}=navigator;if(e?.getHighEntropyValues){let t=await e.getHighEntropyValues(["architecture","bitness","brands","mobile","platform","formFactor","model","platformVersion","wow64"]);this._highEntropyValues=t,t.platform&&(this._os.name=this.normalizeOSName(t.platform),t.platformVersion&&(this._os.version=this.normalizeOSVersion(t.platformVersion),this._os.full=`${this._os.name} ${this._os.version}`)),t.model&&(this._details.model=t.model)}}detectDevice(e){try{let t=/android/i.test(e)?"Android":void 0,i=/iphone/i.test(e)?"iPhone":void 0,s=/ipad/i.test(e)?"iPad":void 0,r=/ipod/i.test(e)?"iPod":void 0,a=/mac/i.test(e)?"Mac":void 0,n=/webOS|BlackBerry|IEMobile|Opera Mini/i.test(e)?"RestMobile":void 0;this._current=t||i||s||r||n||a||"Desktop"}catch(e){console.error("DeviceChecker: device detection error - ",e)}}detectOS(e){try{let t=[[/(windows nt) (6\.[23]); arm/i,["Windows RT"]],[/(windows nt) (6\.3); arm/i,["Windows RT 8.1"]],[/(windows (?:phone|mobile|iot))(?: os)?[/ ]?([\d.]+)/i,["Windows Mobile",2]],[/(windows)[/ ](xp|vista|7|8(\.1)?|10|11|2000|me)/i,[1,1]],[/windows nt ?([\d.]+)/i,["Windows",1]],[/(windows)[/ ](95|98|me|2000|xp|vista|7|8|8\.1|10|11)/i,[1,2]],[/(iphone os|cpu iphone os) ([\d_.]+)/i,["iOS",2]],[/(ipad os|cpu os) ([\d_.]+)/i,["iPadOS",2]],[/(ipod os|cpu ipod os) ([\d_.]+)/i,["iOS",2]],[/(?:ios|os) ([\d_.]+) like mac os x/i,["iOS",1]],[/cfnetwork\/.+darwin/i,["iOS"]],[/(mac os x) ?([\d_.]+)/i,["macOS",2]],[/(macintosh|mac os)/i,["macOS"]],[/(android) ([\d.]+)/i,[1,2]],[/(harmonyos)[/ ]?([\d.]*)/i,["HarmonyOS",2]],[/\b(ubuntu|debian|fedora|centos|arch|linux)(?:[-/ ]([\w.]+))?/i,[1,2]],[/(cros)\D*([\d.]+)/i,["Chrome OS",2]],[/(freebsd|openbsd|netbsd|dragonfly)[/ ]?([\w.]*)/i,[1,2]],[/(sunos|solaris)?([\d.]*)/i,["Solaris",2]],[/(aix)?([\d.]*)/i,["AIX",2]]];for(let[i,s]of t){let t=e.match(i);if(t){let i=s.length>0,r=s.length>1,a="Unknown",n="Unknown";if(i){let e=s[0];"number"==typeof e?e<t.length&&void 0!==t[e]&&(a=t[e]):a=e}if(r){let e=s[1];"number"==typeof e?e<t.length&&void 0!==t[e]&&(n=t[e]):void 0!==e&&(n=e)}else void 0!==t[2]?n=t[2]:void 0!==t[1]&&i&&"string"==typeof s[0]&&(n=t[1]);a=this.normalizeOSName(a),n=this.normalizeOSVersion(n,a),"iOS"===a&&/ipad/i.test(e)?a="iPadOS":"iPadOS"===a&&/ip(hone|od)/i.test(e)&&(a="iOS"),this._os={name:a,version:n||"Unknown",full:n&&"Unknown"!==n?`${a} ${n}`:a};break}}}catch(e){console.error("DeviceChecker: OS detection error - ",e)}}normalizeOSName(e){if(!e)return"Unknown";let t=e.toLowerCase();return t.includes("windows")?"Windows":t.includes("mac os")||t.includes("macintosh")?"macOS":t.includes("iphone")||t.includes("ios")?"iOS":t.includes("ipados")?"iPadOS":t.includes("android")?"Android":t.includes("harmonyos")?"HarmonyOS":t.includes("linux")?"Linux":t.includes("cros")?"Chrome OS":t.includes("freebsd")?"FreeBSD":t.includes("openbsd")?"OpenBSD":t.includes("solaris")||t.includes("sunos")?"Solaris":t.includes("aix")?"AIX":e}normalizeOSVersion(e,t){if(!e)return"Unknown";if("Unknown"!==e&&(e=e.replace(/_/g,"."),"Windows"===t)){let t=parseFloat(e);if(!isNaN(t)){if(t>=11)return"11";if(t>=10)return"10";if(6.3===t)return"8.1";if(6.2===t)return"8";if(6.1===t)return"7";if(6===t)return"Vista";if(5.1===t||5.2===t)return"XP";if(5===t)return"2000";if(4===t)return"NT 4.0"}}return e}detectDeviceDetails(e){try{let t=[[/(iphone)/i,["Apple","iPhone"]],[/(ipad)/i,["Apple","iPad"]],[/(ipod)/i,["Apple","iPod"]],[/(macintosh)/i,["Apple","Macintosh"]],[/(windows[\w\-_ ]*phone)/i,["Microsoft",0]],[/(windows nt|win64|win32|wow64)/i,["Microsoft","PC"]],[/\b(sch-i[89]0\d|shw-m380s|sm-[ptxs]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i,["Samsung",1]],[/\b((?:s[cgp]h|gt|sm)-(?![lr])\w+|sc[g-]?\d+a?|galaxy nexus)/i,["Samsung",1]],[/samsung[- ]((?!sm-[lr]|browser)[-\w]+)/i,["Samsung",1]],[/sec-(sgh\w+)/i,["Samsung",1]],[/smart-tv.+(samsung)/i,["Samsung","Smart TV"]],[/(samsung).*tizen/i,["Samsung","Smart TV"]],[/(pixel (?:c|tablet|[0-9a-z ]+))/i,["Google",1]],[/(pixelbook(?: go)?)/i,["Google",1]],[/nexus [0-9]/i,["Google",0]],[/(redmi[-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,["Xiaomi",1]],[/\b(mi[\w\-_ ]+)(?: bui|\))/i,["Xiaomi",1]],[/\b(poco[\w ]+)(?: bui|\))/i,["Xiaomi",1]],[/\b(hm[-_ ]?note?[\w ]*)(?: bui|\))/i,["Xiaomi",1]],[/\b(?:xiao)?mi[\w\-_ ]+pad/i,["Xiaomi",0]],[/(?:huawei|honor) ?([-\w ]+)[;)]/i,["Huawei",1]],[/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][\dc][adnt]?)\b(?!.+d\/s)/i,["Huawei",1]],[/\b((?:ag[rs][2356]?k?|bah[234]?|bg[2o]|bt[kv]|cmr|cpn|db[ry]2?|jdn2|got|kob2?k?|mon|pce|scm|sht?|[tw]gr|vrd)-[ad]?[lw][0125][09]b?)/i,["Huawei",1]],[/(?:one)?(?:plus)? ?([a\d0]\d\d\d?)(?: b|\))/i,["OnePlus",1]],[/droid.+; (cph2[3-6]\d[13579]|((?:gm|hd)19|(?:ac|be|in|kb)20|(?:d[en]|eb|le|mt)21|ne22)[0-2]\d)(?: bui|\))/i,["OnePlus",1]],[/(oneplus)[-_ ]?([-\w]*)/i,["OnePlus",2]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i,["Realme",1]],[/(realme)[-_ ]?([-\w]*)/i,["Realme",2]],[/; (\w+) bui.+ oppo/i,["OPPO",1]],[/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i,["OPPO",1]],[/\b(opd2(\d{3}a?))(?: bui|\))/i,["OPPO",1]],[/(oppo)[-_ ]?([-\w]*)/i,["OPPO",2]],[/; vivo (\w+)(?: bui|\))/i,["Vivo",1]],[/\b(v[12]\d{3}\w?[at])(?: bui|;)/i,["Vivo",1]],[/(vivo)[-_ ]?([-\w]*)/i,["Vivo",2]],[/\bmot(?:orola)?[- ]([\w\s]+)(\)| bui)/i,["Motorola",1]],[/((?:moto(?! 360)[-\w() ]+|xt\d{3,4}[cgkosw+]?[-\d]*|nexus 6)(?= bui|\)))/i,["Motorola",1]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b/i,["Motorola",0]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i,["Motorola",0]],[/droid.+; ([a-z]?\d[0-2]{2}[a-z]{2}|[c-g]\d{4}|so[-gl]\w+|xq-[a-z]{2}\d\d)(?= bui|\))/i,["Sony",1]],[/sony tablet [ps]/i,["Sony","Xperia Tablet"]],[/\b(?:sony)?sgp\w+(?: bui|\))/i,["Sony",0]],[/(sony)[-_ ]?([-\w]*)/i,["Sony",2]],[/\blg[-e;/ ]+(?!.*(?:browser|netcast|android tv|watch|webos))(\w+)/i,["LG",1]],[/\blg-?([\d\w]+) bui/i,["LG",1]],[/(lm(?:-?f100[nv]?|-[\w.]+)(?= bui|\))|nexus [45])/i,["LG",1]],[/((?=lg)?[vl]k-?\d{3}) bui/i,["LG",0]],[/(lg)[-_ ]?([-\w]*)/i,["LG",2]],[/(?:maemo|nokia).*(n900|lumia \d+|rm-\d+)/i,["Nokia",1]],[/nokia[-_ ]?(([-\w. ]*?))(?: bui|\)|;|\/)/i,["Nokia",1]],[/(nokia) (t[12][01])/i,["Nokia",2]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i,["ASUS",1]],[/(?:asus[-_ ])?(zenfone[\w\-_ ]*)/i,["ASUS",1]],[/(rog[\w\-_ ]*)/i,["ASUS",1]],[/(asus)[-_ ]?([-\w]*)/i,["ASUS",2]],[/lenovo[-_ ]?([-\w ]+?)(?: bui|\)|\/)/i,["Lenovo",1]],[/(ideatab[-\w ]+|602lv|d-42a|a101lv|a2109a|a3500-hv|s[56]000|pb-6505[my]|tb-?x?\d{3,4}(?:f[cu]|xu|[av])|yt\d?-[jx]?\d+[lfmx])(?: bui|;|\)|\/)/i,["Lenovo",1]],[/(thinkpad[\w\-_ ]*)/i,["Lenovo",0]],[/(kf[a-z]{2}[a-z]*)(?: bui|\))/i,["Amazon",1]],[/(alexa)webm/i,["Amazon","Echo"]],[/(fire[\w\-_ ]*)/i,["Amazon",0]],[/(amazon)[-_ ]?([-\w]*)/i,["Amazon",2]],[/(?:blackberry|\(bb10;) (\w+)/i,["BlackBerry",1]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,["BlackBerry",1]],[/(playbook);[-\w),; ]+(rim)/i,["BlackBerry",1]],[/(microsoft); (lumia[\w ]+)/i,["Microsoft",2]],[/(surface duo)/i,["Microsoft","Surface Duo"]],[/(surface[\w\-_ ]*)/i,["Microsoft",0]],[/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,["ZTE",2]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,["HTC",2]],[/(alcatel|tcl)[-_ ]?([-\w]*)/i,[1,2]],[/(meizu)[-_ ]?([-\w]*)/i,["Meizu",2]],[/(tecno)[-_ ]?([-\w]*)/i,["Tecno",2]],[/(infinix)[-_ ]?([-\w]*)/i,["Infinix",2]],[/(micromax)[-_ ]?([-\w]*)/i,["Micromax",2]],[/(lava)[-_ ]?([-\w]*)/i,["Lava",2]],[/(panasonic)[-_ ]?([-\w]*)/i,["Panasonic",2]],[/(sharp)\/?([-\w]*)/i,["Sharp",2]],[/(benq)[-_ ]?([-\w]*)/i,["BenQ",2]],[/(palm)[-_ ]?([-\w]*)/i,["Palm",2]],[/(vertu)[-_ ]?([-\w]*)/i,["Vertu",2]],[/(gionee)[-_ ]?([-\w]*)/i,["Gionee",2]],[/(doogee)[-_ ]?([-\w]*)/i,["Doogee",2]],[/(ulefone)[-_ ]?([-\w]*)/i,["Ulefone",2]],[/(blackview)[-_ ]?([-\w]*)/i,["Blackview",2]],[/(cubot)[-_ ]?([-\w]*)/i,["Cubot",2]],[/(umidigi)[-_ ]?([-\w]*)/i,["UMIDIGI",2]],[/(oukitel)[-_ ]?([-\w]*)/i,["Oukitel",2]],[/(fairphone)[-_ ]?([-\w]*)/i,["Fairphone",2]],[/(cat)[-_ ]?([-\w]*)/i,["Cat",2]],[/(energy)[-_ ]?([-\w]*)/i,["Energizer",2]],[/(land rover)[-_ ]?([-\w]*)/i,["Land Rover",2]],[/(shield[\w\-_ ]*)/i,["Nvidia",0]],[/(crkey)/i,["Google","Chromecast"]],[/(roku)[\dx]*/i,["Roku",0]],[/(apple)[-_ ]?tv/i,["Apple","TV"]],[/(amazon)[-_ ]?tv/i,["Amazon","Fire TV"]],[/(google)[-_ ]?tv/i,["Google","TV"]],[/(smart[\w\-_ ]*tv)/i,[0,"Smart TV"]],[/(playstation[\w\-_ ]*)/i,["Sony",0]],[/(nintendo[\w\-_ ]*)/i,["Nintendo",0]],[/(xbox[\w\-_ ]*)/i,["Microsoft",0]],[/(googlebot)/i,["Google","Bot"]],[/(bingbot)/i,["Microsoft","Bing Bot"]],[/(yandexbot)/i,["Yandex","Bot"]],[/(slackbot)/i,["Slack","Bot"]],[/(twitterbot)/i,["Twitter","Bot"]],[/(facebookbot)/i,["Facebook","Bot"]],[/(linkedinbot)/i,["LinkedIn","Bot"]],[/(tesla)[-_ ]?([-\w]*)/i,["Tesla",2]],[/(raspberry[\w\-_ ]*)/i,["Raspberry Pi",0]]];for(let[i,s]of t){let t=e.match(i);if(t){let e=s[0],i=s[1],r="number"==typeof e?void 0!==t[e]?this.normalizeVendorName(t[e]):"Unknown":this.normalizeVendorName(e),a="Unknown";"number"==typeof i?a=void 0!==t[i]?t[i]:"Unknown":void 0!==i?a=i:void 0!==t[1]?a=t[1]:void 0!==t[0]&&(a=t[0]),a=this.normalizeModelName(a,r),this.details.vendor=r,this.details.model=a;break}}}catch(e){console.error("DeviceChecker: device details detection error - ",e)}}normalizeVendorName(e){if(!e)return"Unknown";return{apple:"Apple",samsung:"Samsung",google:"Google",xiaomi:"Xiaomi",huawei:"Huawei",oneplus:"OnePlus",oppo:"OPPO",vivo:"Vivo",realme:"Realme",motorola:"Motorola",sony:"Sony",lg:"LG",nokia:"Nokia",asus:"ASUS",lenovo:"Lenovo",amazon:"Amazon",blackberry:"BlackBerry",microsoft:"Microsoft",zte:"ZTE",htc:"HTC",alcatel:"Alcatel",tcl:"TCL",meizu:"Meizu",tecno:"Tecno",infinix:"Infinix",micromax:"Micromax",lava:"Lava",panasonic:"Panasonic",sharp:"Sharp",benq:"BenQ",palm:"Palm",honor:"Honor",nvidia:"NVIDIA",roku:"Roku"}[e.toLowerCase()]||e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()}normalizeModelName(e,t){if(!e||"Unknown"===e)return e;if("0"===e)return"Unknown";let i=e.replace(/^build\//i,"").replace(/\s+bui$/i,"").replace(/\)$/,"").replace(/[;,)]/g,"").replace(/\s*\(.*?\)\s*/g,"").trim(),s=t.toLowerCase();return s.includes("samsung")?i=i.replace(/^(sm-|gt-|sgh-|sch-)/i,""):s.includes("xiaomi")?i=i.replace(/^(mi[\s\-_]*|redmi[\s\-_]*)/i,""):s.includes("oneplus")?i=i.replace(/^oneplus[\s\-_]*/i,""):s.includes("google")&&(i=i.replace(/^(pixel[\s\-_]*|nexus[\s\-_]*)/i,"")),i=i.replace(/_/g," ").replace(/-/g," ").replace(/\s+/g," ").trim(),i?(i.length>0&&/^[a-z]/.test(i)&&(i=i.charAt(0).toUpperCase()+i.slice(1)),i):"Unknown"}detectIOSVersion(){try{if(this._highEntropyValues.platformVersion){let e=this._highEntropyValues.platformVersion.split(".").slice(0,2).join(".");return void(this._iosVersion=parseFloat(e))}if("Unknown"!==this._os.version){let e=this._os.version.split("."),t=e.length>=2?`${e[0]}.${e[1]}`:e[0];return void(this._iosVersion=parseFloat(t))}let e=navigator.userAgent.match(/OS (\d+(_\d+)?)/i);e?.[1]&&(this._iosVersion=parseFloat(e[1].replace(/_/g,".")))}catch(e){console.error("DeviceChecker: iOS version detection error - ",e)}}constructor(e){this._highEntropyValues={},this._os={name:"Unknown",version:"Unknown",full:"Unknown"},this._details={vendor:"Unknown",model:"Unknown"},this._displayChecker=e}},ms=class{get isTouch(){return"number"==typeof this._maxTouchPoints?this._maxTouchPoints>1:"ontouchstart"in window}get maxTouchPoints(){return this._maxTouchPoints}get height(){return this._height}get width(){return this._width}get screenHeight(){return this._screenHeight}get screenWidth(){return this._screenWidth}get pixelRatio(){return this._pixelRatio}get isHDR(){return this._isHdr}get colorDepth(){return this._colorDepth}detect(){let{maxTouchPoints:e}=navigator;try{this._maxTouchPoints=e??0,this._isHdr=!!matchMedia("(dynamic-range: high)")?.matches,this._colorDepth=screen.colorDepth}catch(e){console.error(e)}try{this._pixelRatio=window.devicePixelRatio||1,this._height=screen.height,this._width=screen.width,this._height=screen.height,this._screenHeight=this._height*this._pixelRatio,this._screenWidth=this._width*this._pixelRatio}catch(e){console.error(e)}}},gs=()=>window.ManagedMediaSource||window.MediaSource,bs=()=>!(!window.ManagedMediaSource||!window.ManagedSourceBuffer?.prototype?.appendBuffer),vs=()=>window.ManagedMediaSource?new ManagedMediaSource:new MediaSource,ys=document.createElement("video"),Ss='video/webm; codecs="vp09.00.10.08"',ws='video/webm; codecs="av01.0.00M.08"';(async()=>{if(!window.navigator.mediaCapabilities)return;let e={type:"media-source",video:{contentType:"video/webm",width:1280,height:720,bitrate:1e6,framerate:30}},[t,i]=await Promise.all([window.navigator.mediaCapabilities.decodingInfo({...e,video:{...e.video,contentType:ws}}),window.navigator.mediaCapabilities.decodingInfo({...e,video:{...e.video,contentType:Ss}})]);os={DASH_WEBM_AV1:t,DASH_WEBM:i}})().catch((e=>{console.log(ys),console.error(e)}));var Ts=class{get protocols(){return this._protocols}get containers(){return this._containers}get codecs(){return this._codecs}get webmDecodingInfo(){return os}get supportedCodecs(){return Object.keys(this._codecs).filter((e=>this._codecs[e]))}get nativeHlsSupported(){return this._nativeHlsSupported}detect(){this._video=document.createElement("video");try{this._protocols={mms:bs(),mse:!(!window.MediaSource||!window.SourceBuffer?.prototype?.appendBuffer),hls:!(!this._video.canPlayType?.("application/x-mpegurl")&&!this._video.canPlayType?.("vnd.apple.mpegURL")),webrtc:!!window.RTCPeerConnection,ws:!!window.WebSocket},this._containers={mp4:!!this._video.canPlayType?.("video/mp4"),webm:!!this._video.canPlayType?.("video/webm"),cmaf:!0};let e=!!gs()?.isTypeSupported?.('video/mp4; codecs="avc1.42000a,mp4a.40.2"'),t=!!gs()?.isTypeSupported?.('video/mp4; codecs="hev1.1.6.L93.B0"'),i=!!gs()?.isTypeSupported?.('audio/mp4; codecs="mp4a.40.2"');this._codecs={h264:e,h265:t,vp9:!!gs()?.isTypeSupported?.(Ss),av1:!!gs()?.isTypeSupported?.(ws),aac:i,opus:!!gs()?.isTypeSupported?.('audio/webm; codecs="opus"'),mpeg:(e||t)&&i},this._nativeHlsSupported=this._protocols.hls&&this._containers.mp4}catch(e){console.error(e)}try{this.destroyVideoElement()}catch(e){console.error("Error destroying video element:",e)}}destroyVideoElement(){if(!this._video)return;if(this._video.pause(),this._video.currentTime=0,this._video.removeAttribute("src"),this._video.src="",this._video.load(),this._video.remove)return this._video.remove(),void(this._video=null);this._video.parentNode&&this._video.parentNode.removeChild(this._video);let e=this._video.cloneNode(!1);this._video.parentNode?.replaceChild(e,this._video),this._video=null}constructor(e,t){this._deviceChecker=e,this._browserChecker=t}},$s="audio/mpeg",xs=class{supportMp3(){return this._codecs.mp3&&this._containers.mpeg}detect(){this._audio=document.createElement("audio");try{this._containers={mpeg:!!this._audio.canPlayType?.($s)},this._codecs={mp3:!!gs()?.isTypeSupported?.($s)}}catch(e){console.error(e)}try{this.destroyAudioElement()}catch(e){console.error("Error destroying audio element:",e)}}destroyAudioElement(){if(!this._audio)return;if(this._audio.pause(),this._audio.currentTime=0,this._audio.removeAttribute("src"),this._audio.src="",this._audio.load(),this._audio.remove)return this._audio.remove(),void(this._audio=null);this._audio.parentNode&&this._audio.parentNode.removeChild(this._audio);let e=this._audio.cloneNode(!1);this._audio.parentNode?.replaceChild(e,this._audio),this._audio=null}},ks=new class{get display(){return this._displayChecker}get device(){return this._deviceChecker}get browser(){return this._browserChecker}get video(){return this._videoChecker}get audio(){return this._audioChecker}async detect(){this._displayChecker.detect(),this._deviceChecker.detect(),this._browserChecker.detect(),this._videoChecker.detect(),this._audioChecker.detect(),this.isInited$.next(!0)}constructor(){this.isInited$=new u.Ot(!1),this._displayChecker=new ms,this._deviceChecker=new fs(this._displayChecker),this._browserChecker=new ls,this._videoChecker=new Ts(this._deviceChecker,this._browserChecker),this._audioChecker=new xs,this.detect()}},Ls=e=>{let{containers:t,protocols:i,codecs:s,nativeHlsSupported:r}=ks.video,a=(s.h264||s.h265)&&s.aac,n=i.mse||i.mms;return e.filter((e=>{switch(e){case"DASH_SEP":case"DASH_LIVE":case"DASH_ONDEMAND":return n&&t.mp4&&a;case"DASH_WEBM":return n&&t.webm&&s.vp9&&s.opus;case"DASH_WEBM_AV1":return n&&t.webm&&s.av1&&s.opus;case"DASH_STREAMS":return n&&(t.mp4&&a||t.webm&&(s.vp9||s.av1)&&(s.opus||s.aac));case"DASH_LIVE_CMAF":return n&&t.mp4&&a&&t.cmaf;case"HLS":case"HLS_ONDEMAND":case"HLS_FMP4":case"HLS_LIVE":case"HLS_LIVE_CMAF":return r;case"MPEG":return t.mp4;case"DASH":case"DASH_LIVE_WEBM":return!1;case"WEB_RTC_LIVE":return i.webrtc&&i.ws&&s.h264&&(t.mp4||t.webm);default:return(0,u.xb)(e)}}))},Rs=e=>{switch(e){case"MPEG":case"DASH":case"DASH_SEP":case"DASH_ONDEMAND":case"DASH_WEBM":case"DASH_WEBM_AV1":case"DASH_STREAMS":case"HLS":case"HLS_FMP4":case"HLS_ONDEMAND":return!1;case"DASH_LIVE":case"DASH_LIVE_CMAF":case"HLS_LIVE":case"HLS_LIVE_CMAF":case"DASH_LIVE_WEBM":case"WEB_RTC_LIVE":return!0;default:return(0,u.xb)(e)}},Es=e=>{let t=Object.keys(e).filter((e=>!Rs(e)));return Ls(t).length>0},Bs=class{subscribe(){let e=e=>{this.params.output.error$.next({category:u.h.WTF,id:"ChromecastPresentationApiProvider",message:e?.message??"Unknown error",thrown:e})};this.subscription.add(this.params.chromecastConnector.message$.pipe((0,u.pb)((e=>!!e))).subscribe((e=>{this.handleMessage(e)}),e)),this.subscription.add(this.sessionId$.pipe((0,u.pb)(u.R),(0,u.jX)(),(0,u.sg)(0)).subscribe((()=>{this.loadMedia()}),e));let t=this.contentId$.pipe((0,u.jX)(),(0,u.Tj)(Boolean));this.subscription.add((0,u.kg)({seekState:this.params.desiredState.seekState.stateChangeEnded$,mediaLoaded:t}).pipe((0,u.pb)((({mediaLoaded:e})=>e))).subscribe((()=>{let e=this.params.desiredState.seekState.getState();"requested"===e.state&&this.seek(e.position/1e3)}),e));let i=(0,u.kg)({playbackState:this.params.desiredState.playbackState.stateChangeStarted$,mediaLoaded:t});this.subscription.add(i.pipe((0,u.pb)((({mediaLoaded:e})=>e)),(0,u.sg)(0)).subscribe((()=>{this.syncPlayback()}),e)),this.subscription.add(i.pipe((0,u.pb)((({mediaLoaded:e,playbackState:{from:t,to:i}})=>!e&&"stopped"===t&&"playing"===i))).subscribe((()=>{this.loadMedia()}),e)),this.subscription.add((0,u.kg)({volumeState:this.params.desiredState.volume.stateChangeStarted$.pipe((0,u.sg)(30)),mediaLoaded:t}).pipe((0,u.pb)((({mediaLoaded:e})=>e))).subscribe((({volumeState:e})=>{let{muted:t,volume:i}=e.to;this.setVolume(i,t)}),e))}handleMessage(e){switch(e.type){case"new_session":case"update_session":{this.sessionId$.next(e.message.sessionId);let t=e.message?.media?.[0];this.syncMediaState(t);let i=e.message?.receiver.volume;this.syncVolumeState(i)}break;case"v2_message":switch(e.message?.type){case"MEDIA_STATUS":{let t=e.message?.status?.[0];this.syncMediaState(t);break}}}}loadMedia(){let e=rs(this.params),t=this.media?.currentTime,i=this.params.desiredState.seekState.getState(),s=t??("none"!==i.state?i.position/1e3:0),r="playing"===this.params.desiredState.playbackState.getState();this.params.chromecastConnector.sendV2Message({type:"LOAD",requestId:0,media:e,autoplay:r,currentTime:s,customData:null,activeTrackIds:null}),this.params.output.willSeekEvent$.next()}stop(){this.params.chromecastConnector.stopMedia()}play(){let e=this.mediaSessionId$.getValue();(0,u.tZ)(e,"play on null mediaSessionId"),this.params.chromecastConnector.sendV2Message({type:"PLAY",mediaSessionId:e,customData:null})}pause(){let e=this.mediaSessionId$.getValue();(0,u.tZ)(e,"pause on null mediaSessionId"),this.params.chromecastConnector.sendV2Message({type:"PAUSE",mediaSessionId:e,customData:null})}seek(e){let t=this.mediaSessionId$.getValue();(0,u.tZ)(t,"seek on null mediaSessionId"),this.params.chromecastConnector.sendV2Message({type:"SEEK",currentTime:e,mediaSessionId:t}),this.params.output.willSeekEvent$.next()}setVolume(e,t){let i=e,s=`[setVolume] volume: ${e}, muted: ${t}`;this.isMobile&&(i=this.mobileVolumeState.volume,s+=`, mobile next volume: ${i}`),this.log({message:s}),this.lastRequestedVolume={volume:i,muted:t},this.params.chromecastConnector.sendV2Message({type:"SET_VOLUME",requestId:0,volume:{level:t?0:i,muted:!!t||null}})}syncPlaybackState({playerState:e,idleReason:t}){let i="BUFFERING"===e;switch(this.params.output.isBuffering$.getValue()!==i&&this.params.output.isBuffering$.next(i),e){case"PAUSED":us(this.params.desiredState.playbackState,"paused");break;case"PLAYING":us(this.params.desiredState.playbackState,"playing");break;case"IDLE":"FINISHED"===t?(this.params.output.endedEvent$.next(),us(this.params.desiredState.playbackState,"stopped"),this.contentId$.next(null)):us(this.params.desiredState.playbackState,"ready")}}syncPlayback(){let e=this.params.desiredState.playbackState.getState();switch(this.log({message:`[syncPlayback] ${e}`}),e){case"ready":break;case"playing":this.play();break;case"paused":this.pause();break;case"stopped":this.stop()}}syncVolumeState(e){if((0,u.wD)(e))return;let{level:t,muted:i}=e,s={muted:i??!1,volume:t??0};this.lastRequestedVolume&&(i&&(s.volume=this.lastRequestedVolume.volume),this.lastRequestedVolume.muted&&!t&&!i&&(s.volume=this.lastRequestedVolume.volume,s.muted=!0),this.lastRequestedVolume=null);let r=`[syncVolumeState] volume: ${s.volume}, muted: ${s.muted}`;this.isMobile&&(this.mobileVolumeState.volume=s.volume,this.mobileVolumeState.muted=s.muted,s.volume=this.params.output.volume$.getValue().volume,r+=`, volume passed to state machine: ${s.volume}`),this.log({message:r}),this.params.output.volume$.next(s)}destroy(){this.progressTicker.destroy(),this.subscription.unsubscribe()}constructor(e){this.subscription=new u.yU,this.sessionId$=new u.Ot(null),this.mediaSessionId$=new u.Ot(null),this.contentId$=new u.Ot(null),this.isMobile=ps(),this.mobileVolumeState={muted:!1,volume:0},this.media=null,this.lastRequestedVolume=null,this.syncMediaState=e=>{if((0,u.wD)(e))return;this.media=e,this.mediaSessionId$.next(e.mediaSessionId??null);let t=e.media?.contentId;t&&this.contentId$.next(t),this.syncPlaybackState(e);let i=e.media?.duration;(0,u.R)(i)&&this.params.output.duration$.next(Math.max(0,i));let s=e.currentTime;if((0,u.R)(s)){"applying"===this.params.desiredState.seekState.getState().state&&this.params.output.seekedEvent$.next(),this.params.output.position$.next(s);let t=this.params.output.isLive$.getValue();"PLAYING"!==e.playerState||t?this.progressTicker.pause():this.progressTicker.start(s)}},this.params=e,this.progressTicker=new hs(e),this.log=this.params.dependencies.logger.createComponentLog("ChromecastPresentationApiProvider"),this.log({message:`constructor, format: ${e.format}`}),this.params.output.isLive$.next(Rs(e.format)),this.subscribe()}},As=class{destroy(){this.log({message:"destroy"}),this.subscription.unsubscribe(),this.subscriptionEvents.unsubscribe(),this.broadcastChannel.close(),this.isDestroyed=!0}disconnect(e=!0){this.log({message:"disconnect"}),e&&this.stopMedia(),this.presentationRequest$.next(null);let t=this.presentationConnection$.getValue();t&&t.close(),this.presentationConnection$.next(null),this.friendlyName$.next(null),this.resetSequenceNumber(),this.resetSubscriptionEvents()}stopMedia(){this.log({message:"stopMedia"}),this.sendV2Message({type:"STOP"})}reinitPresentation(e=!0){let t=this.createCastUrl(),i=new PresentationRequest(t);this.presentationRequest$.next(i),this.log({message:"PresentationRequest created"}),i.getAvailability().then((e=>{let t=()=>{this.log({message:`PresentationRequest presentation availability: ${e.value}`}),this.presentationAvailable$.next(e.value)};this.subscriptionEvents.add((0,u.Rt)(e,"change").subscribe((()=>{t()}))),t()})).catch((()=>{this.presentationAvailable$.next(!0)})),window.navigator.presentation.defaultRequest=i,e&&i.reconnect("auto-join").then((e=>{this.log({message:"PresentationRequest reconnect success"}),this.handleConnection(e)})).catch((()=>{this.log({message:"PresentationRequest reconnect failed"})}))}async connect(){this.log({message:"connect"});try{this.presentationRequest$.getValue()||(this.log({message:"reinitPresentation"}),this.reinitPresentation(!1));let e=this.presentationRequest$.getValue();(0,u.tZ)(e,"connect with null presentationRequest");let t=await e.start();this.handleConnection(t)}catch(e){switch(e?.name){case"AbortError":case"NotAllowedError":break;default:this.errorEvent$.next({category:u.h.WTF,id:"ChromecastPresentationApiConnector",message:e?.message??"connect error",thrown:e})}}}subscribe(){this.subscription.add((0,u.Rt)(this.broadcastChannel,"message").subscribe((e=>{this.log({message:`broadcast connection data: ${e.data}`}),"connection"===e.data&&this.disconnect(!1)}))),this.subscription.add(this.presentationAvailable$.subscribe((e=>{this.log({message:`presentationAvailable$: ${e}`})}))),this.subscription.add(this.presentationConnection$.pipe((0,u.Mi)((e=>{this.log({message:`presentationConnection$: ${!!e}`})})),(0,u.pb)((e=>!!e))).subscribe((e=>{let t=(0,u.Rt)(e,"message").subscribe((e=>{let t=JSON.parse(e.data);t.clientId===this.clientId&&(this.log({message:`[onmessage] ${e.data}`}),this.handleMessage(t),this.message$.next(t))})),i=(0,u.Rt)(e,"connect").subscribe((()=>{this.send("client_connect")})),s=(0,u.Rt)(e,"close").subscribe((e=>{if("error"===e.reason)this.errorEvent$.next({category:u.h.WTF,id:"ChromecastPresentationApiConnector",message:"Session error",thrown:e})}));this.subscriptionEvents.add(t),this.subscriptionEvents.add(i),this.subscriptionEvents.add(s)})))}send(e){switch(e){case"client_connect":{let e={type:"client_connect",message:this.clientId,sequenceNumber:-1,timeoutMillis:0,clientId:this.clientId};this.safeSend(JSON.stringify(e));break}}}sendV2Message(e){let t=this.sessionId$.getValue();if(t){let i={type:"v2_message",sequenceNumber:this.getSequenceNumber(),timeoutMillis:0,clientId:this.clientId,message:{...e,sessionId:t}};this.safeSend(JSON.stringify(i))}}safeSend(e){try{this.log({message:`[send] ${e}`});let t=this.presentationConnection$.getValue();"connected"===t?.state&&t?.send(e)}catch(t){this.errorEvent$.next({category:u.h.WTF,id:"ChromecastPresentationApiConnector",message:"PresentationConnection send error",data:{message:e},thrown:t})}}handleMessage(e){switch(e.type){case"new_session":case"update_session":this.sessionId$.next(e.message.sessionId),this.friendlyName$.next(e.message.receiver.friendlyName||"Chromecast Device");break;case"receiver_action":"stop"===e.message?.action&&this.disconnect()}}createCastUrl(){return`cast:${this.params.appId}?clientId=${this.clientId}&autoJoinPolicy=tab_and_origin_scoped&defaultActionPolicy=create_session&launchTimeout=60000&supportedAppTypes=${this.capabilities}&appParams=%7B%22launchCheckerParams%22%3A%7B%7D%7D`}getSequenceNumber(){let e=this.sequenceNumber;return this.sequenceNumber=(this.sequenceNumber+1)%Number.MAX_SAFE_INTEGER,e}resetSequenceNumber(){this.sequenceNumber=0}getClientId(){let e="__vk_player_chromecast_id";return window[e]=window[e]||String(Date.now())+String(Math.floor(1e5*Math.random()))}resetSubscriptionEvents(){this.subscriptionEvents.unsubscribe(),this.subscriptionEvents=new u.yU}handleConnection(e){this.log({message:"connection available"}),this.isDestroyed?(this.log({message:"connected on already destroyed component"}),e.close()):(this.broadcastChannel.postMessage("connection"),this.presentationConnection$.next(e))}constructor(e){this.capabilities=["WEB"],this.presentationRequest$=new u.Ot(null),this.sessionId$=new u.Ot(null),this.broadcastChannel=new BroadcastChannel("vk_player_chromecast_events"),this.subscription=new u.yU,this.subscriptionEvents=new u.yU,this.isDestroyed=!1,this.sequenceNumber=0,this.presentationAvailable$=new u.Ot(!1),this.presentationConnection$=new u.Ot(null),this.message$=new u.Ot(null),this.friendlyName$=new u.Ot(null),this.errorEvent$=new u.B7,this.clientId=this.getClientId(),this.params=e,this.log=e.logger.createComponentLog("ChromecastPresentationApiConnector"),this.log({message:"constructor"}),this.reinitPresentation(),this.subscribe()}},Ms=class e{static isSupported(){return"chrome"in window&&"presentation"in navigator&&"BroadcastChannel"in window}subscribe(){(0,u.tZ)(this.chromecastConnector,"subscribe with null chromecastConnector"),this.subscription.add(this.chromecastConnector.errorEvent$.subscribe(this.errorEvent$));let e=(0,u.kg)({connection:this.chromecastConnector.presentationConnection$,available:this.chromecastConnector.presentationAvailable$,friendlyName:this.chromecastConnector.friendlyName$.pipe((0,u.jX)())});this.subscription.add(e.pipe((0,u.Tj)((({connection:e,friendlyName:t})=>!(!e||!t))),(0,u.jX)()).subscribe((e=>{let t=this.chromecastConnector?.friendlyName$.getValue()??"";this.connection$.next(e?(e=>({castDevice:{friendlyName:e},remotePlayer:{},remotePlayerController:{},session:{}}))(t):void 0)}))).add(e.subscribe((({available:e,connection:t})=>{e?t?this.castState$.next("CONNECTED"):this.castState$.next("AVAILABLE"):this.castState$.next("NOT_AVAILABLE")})))}connect(){this.log({message:"connect"}),this.chromecastConnector?.connect()}disconnect(){this.log({message:"disconnect"}),this.chromecastConnector?.disconnect()}async stopMedia(){this.log({message:"stopMedia"}),this.chromecastConnector?.stopMedia()}toggleConnection(){let e=!!this.chromecastConnector?.presentationConnection$.getValue();this.log({message:`toggleConnection: isConnected - ${e}`}),e?this.disconnect():this.connect()}setVolume(e){}setMuted(e){}destroy(){this.log({message:"destroy"}),this.chromecastConnector?.destroy(),this.subscription.unsubscribe()}constructor(t){this.subscription=new u.yU,this.connection$=new u.Ot(void 0),this.castState$=new u.Ot("NOT_AVAILABLE"),this.errorEvent$=new u.B7;let i=e.isSupported();this.log=t.dependencies.logger.createComponentLog("ChromecastPresentationApiInitializer"),this.log({message:`[constructor] receiverApplicationId: ${t.receiverApplicationId}, isDisabled: ${t.isDisabled}, isSupported: ${i}`}),i&&!t.isDisabled&&t.receiverApplicationId&&(this.chromecastConnector=new As({appId:t.receiverApplicationId,logger:t.dependencies.logger}),this.subscribe())}},Cs=g(Oe(),1),Is=g(Fe(),1),Ds=g(vt(),1),Os=g(ii(),1),Ps=class{setState(e){let t=this.transition,i=this.state;this.transition=void 0,this.prevState=i,this.state=e,t?t.to===e?this.transitionEnded$.next(t):this.forceChanged$.next({from:t.from,to:e,canceledTransition:t}):this.forceChanged$.next({from:i,to:e,canceledTransition:t})}startTransitionTo(e){let t=this.transition,i=this.state;i===e||(0,u.R)(t)&&t.to===e||(this.prevState=i,this.state=e,t?(this.transition={from:t.from,to:e,canceledTransition:t},this.transitionUpdated$.next(this.transition)):(this.transition={from:i,to:e},this.transitionStarted$.next(this.transition)))}getTransition(){return this.transition}getState(){return this.state}getPrevState(){return this.prevState}constructor(e){this.transitionStarted$=new u.B7,this.transitionEnded$=new u.B7,this.transitionUpdated$=new u.B7,this.forceChanged$=new u.B7,this.stateChangeStarted$=(0,u.h1)(this.transitionStarted$,this.transitionUpdated$),this.stateChangeEnded$=(0,u.h1)(this.transitionEnded$,this.forceChanged$),this.state=e,this.prevState=void 0}},Vs=class{destroy(){this.log({message:"[destroy]"}),this.subscription.unsubscribe()}subscribe(){this.subscription.add(this.loadMediaTimeoutSubscription);let e=new u.yU;this.subscription.add(e),this.subscription.add((0,u.h1)(this.videoState.stateChangeStarted$.pipe((0,u.Tj)((e=>`stateChangeStarted$ ${JSON.stringify(e)}`))),this.videoState.stateChangeEnded$.pipe((0,u.Tj)((e=>`stateChangeEnded$ ${JSON.stringify(e)}`)))).subscribe((e=>this.log({message:`[videoState] ${e}`}))));let t=(e,t)=>this.subscription.add(e.subscribe(t));if(this.params.output.isLive$.getValue())this.params.output.position$.next(0),this.params.output.duration$.next(0);else{let t=new u.B7;e.add(t.pipe((0,u.sg)(500)).subscribe((()=>{this.params.output.seekedEvent$.next()})));let i=NaN;e.add((0,u.Rt)(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.CURRENT_TIME_CHANGED).subscribe((e=>{this.logRemoteEvent(e);let s=e.value;this.params.output.position$.next(s),("applying"===this.params.desiredState.seekState.getState().state||Math.abs(s-i)>5)&&t.next(s),i=s}))),e.add((0,u.Rt)(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.DURATION_CHANGED).subscribe((e=>{this.logRemoteEvent(e),this.params.output.duration$.next(e.value)})))}t((0,u.Rt)(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.IS_MEDIA_LOADED_CHANGED),(t=>{this.logRemoteEvent(t),t.value?this.handleRemoteReady():(this.handleRemoteStop(),e.unsubscribe())})),t((0,u.Rt)(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.IS_PAUSED_CHANGED),(e=>{this.logRemoteEvent(e),e.value?this.handleRemotePause():this.handleRemotePlay()})),t((0,u.Rt)(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.PLAYER_STATE_CHANGED),(e=>{this.logRemoteEvent(e);let{remotePlayer:t}=this.params.connection,i=e.value,s=this.params.output.isBuffering$.getValue(),r=i===chrome.cast.media.PlayerState.BUFFERING;switch(s!==r&&this.params.output.isBuffering$.next(r),i){case chrome.cast.media.PlayerState.IDLE:!this.params.output.isLive$.getValue()&&t.duration-t.currentTime<5&&this.params.output.endedEvent$.next(),this.handleRemoteStop(),us(this.params.desiredState.playbackState,"stopped");break;case chrome.cast.media.PlayerState.PAUSED:this.handleRemotePause();break;case chrome.cast.media.PlayerState.PLAYING:this.handleRemotePlay();break;case chrome.cast.media.PlayerState.BUFFERING:break;default:(0,u.xb)(i)}})),t((0,u.Rt)(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.VOLUME_LEVEL_CHANGED),(e=>{this.logRemoteEvent(e),this.handleRemoteVolumeChange({volume:e.value})})),t((0,u.Rt)(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.IS_MUTED_CHANGED),(e=>{this.logRemoteEvent(e),this.handleRemoteVolumeChange({muted:e.value})})),t((0,u.h1)(this.params.desiredState.playbackState.stateChangeStarted$,this.params.desiredState.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,(0,u.Ss)(["init"])).pipe((0,u.sg)(0)),this.syncPlayback)}restoreSession(e){this.log({message:"restoreSession"});let{remotePlayer:t}=this.params.connection;if(e.playerState!==chrome.cast.media.PlayerState.IDLE){t.isPaused?(this.videoState.setState("paused"),us(this.params.desiredState.playbackState,"paused")):(this.videoState.setState("playing"),us(this.params.desiredState.playbackState,"playing"));let e=this.params.output.isLive$.getValue();this.params.output.duration$.next(e?0:t.duration),this.params.output.position$.next(e?0:t.currentTime),this.params.desiredState.seekState.setState({state:"none"})}}prepare(){let e=this.params.format;this.log({message:`[prepare] format: ${e}`});let t=rs(this.params),i=this.createLoadRequest(t);this.loadMedia(i)}handleRemotePause(){let e=this.videoState.getState();("paused"===this.videoState.getTransition()?.to||"playing"===e)&&(this.videoState.setState("paused"),us(this.params.desiredState.playbackState,"paused"))}handleRemotePlay(){let e=this.videoState.getState();("playing"===this.videoState.getTransition()?.to||"paused"===e)&&(this.videoState.setState("playing"),us(this.params.desiredState.playbackState,"playing"))}handleRemoteReady(){"ready"===this.videoState.getTransition()?.to&&this.videoState.setState("ready"),"ready"===this.params.desiredState.playbackState.getTransition()?.to&&us(this.params.desiredState.playbackState,"ready")}handleRemoteStop(){"stopped"!==this.videoState.getState()&&this.videoState.setState("stopped")}handleRemoteVolumeChange(e){let t=this.params.output.volume$.getValue(),i={volume:e.volume??t.volume,muted:e.muted??t.muted};(i.volume!==t.volume||i.muted!=i.muted)&&this.params.output.volume$.next(i)}seek(e){this.params.output.willSeekEvent$.next();let{remotePlayer:t,remotePlayerController:i}=this.params.connection;t.currentTime=e,i.seek()}stop(){let{remotePlayerController:e}=this.params.connection;e.stop()}createLoadRequest(e){let t=new chrome.cast.media.LoadRequest(e);t.autoplay=!1;let i=this.params.desiredState.seekState.getState();return"applying"===i.state||"requested"===i.state?t.currentTime=this.params.output.isLive$.getValue()?0:i.position/1e3:t.currentTime=0,t}loadMedia(e){let t=this.params.connection.session.loadMedia(e),i=new Promise(((e,t)=>{this.loadMediaTimeoutSubscription.add((0,u.wR)(7e3).subscribe((()=>t("timeout(7000)"))))}));(0,Os.default)(Promise.race([t,i]).then((()=>{this.log({message:`[loadMedia] completed, format: ${this.params.format}`}),"applying"===this.params.desiredState.seekState.getState().state&&this.params.output.seekedEvent$.next(),this.handleRemoteReady()}),(e=>{let t=`[prepare] loadMedia failed, format: ${this.params.format}, reason: ${e}`;this.log({message:t}),this.params.output.error$.next({id:"ChromecastProvider.loadMedia",category:u.h.VIDEO_PIPELINE,message:t,thrown:e})})),(()=>{this.loadMediaTimeoutSubscription.unsubscribe()}))}logRemoteEvent(e){this.log({message:`[remoteEvent] ${JSON.stringify(e)}`})}constructor(e){this.subscription=new u.yU,this.loadMediaTimeoutSubscription=new u.yU,this.videoState=new Ps("stopped"),this.syncPlayback=()=>{let e=this.videoState.getState(),t=this.videoState.getTransition(),i=this.params.desiredState.playbackState.getState(),s=this.params.desiredState.playbackState.getTransition(),r=this.params.desiredState.seekState.getState();if(this.log({message:`[syncPlayback] videoState: ${e}; videoTransition: ${JSON.stringify(t)}; desiredPlaybackState: ${i}; desiredPlaybackStateTransition: ${this.params.desiredState.playbackState.getTransition()}; seekState: ${JSON.stringify(r)};`}),"stopped"!==i){if(!t){if("paused"!==s?.to&&"requested"===r.state&&"stopped"!==e)return void this.seek(r.position/1e3);switch(i){case"ready":switch(e){case"playing":case"paused":case"ready":break;case"stopped":this.videoState.startTransitionTo("ready"),this.prepare();break;default:(0,u.xb)(e)}break;case"playing":switch(e){case"playing":break;case"paused":case"ready":this.videoState.startTransitionTo("playing"),this.params.connection.remotePlayerController.playOrPause();break;case"stopped":this.videoState.startTransitionTo("ready"),this.prepare();break;default:(0,u.xb)(e)}break;case"paused":switch(e){case"playing":this.videoState.startTransitionTo("paused"),this.params.connection.remotePlayerController.playOrPause();break;case"paused":break;case"ready":this.videoState.startTransitionTo("paused"),this.videoState.setState("paused");break;case"stopped":this.videoState.startTransitionTo("ready"),this.prepare();break;default:(0,u.xb)(e)}break;default:(0,u.xb)(i)}}}else"stopped"!==e&&(this.videoState.startTransitionTo("stopped"),this.stop())},this.params=e,this.log=this.params.dependencies.logger.createComponentLog("ChromecastProvider"),this.log({message:`constructor, format: ${e.format}`}),this.params.output.isLive$.next(Rs(e.format)),this.params.output.isAudioAvailable$.next(!0),this.handleRemoteVolumeChange({volume:this.params.connection.remotePlayer.volumeLevel,muted:this.params.connection.remotePlayer.isMuted});let t=this.params.connection.session.getMediaSession();t&&this.restoreSession(t),this.subscribe()}},_s=g(Oe(),1),Fs=window.WeakMap?new WeakMap:new class{get(e){return e.hasAttribute(this.attribute)}set(e,t){e.toggleAttribute(this.attribute,t)}delete(e){e.removeAttribute(this.attribute)}constructor(){this.attribute="data-pool-reused"}},Ns=window.WeakMap?new WeakMap:new Map,Us=(e,{audioVideoSyncRate:t,disableYandexPiP:i})=>{let s=e.querySelector("video"),r=!!s;s?(0,u.To)(s):(s=document.createElement("video"),e.appendChild(s)),Fs.set(s,r);let a=new u.yU;return a.add(((e,t=20)=>{let i=0;return(0,u.Rt)(e,"ratechange").subscribe((s=>{i++,i>=t&&(e.currentTime=e.currentTime,i=0)}))})(s,t)),Ns.set(s,a),s.setAttribute("crossorigin","anonymous"),s.setAttribute("playsinline","playsinline"),i&&s.setAttribute("x-yandex-pip","false"),s.controls=!1,s.setAttribute("poster","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII="),s},js=e=>{Ns.get(e)?.unsubscribe(),Ns.delete(e);let t=Fs.get(e);Fs.delete(e),t?(0,u.To)(e):(e=>{try{e.pause(),e.playbackRate=0,(0,u.To)(e),e.remove()}catch(e){console.error(e)}})(e)},qs=g(Be(),1),zs=(e,t,i,{equal:s=(e,t)=>e===t,changed$:r,onError:a}={})=>{let n=e.getState(),o=t(),h=(0,u.wD)(r),d=new u.yU;return r&&d.add(r.subscribe((t=>{let i=e.getState();s(t,i)&&e.setState(t)}),a)),s(o,n)||(i(n),h&&e.setState(n)),d.add(e.stateChangeStarted$.subscribe((t=>{i(t.to),h&&e.setState(t.to)}),a)),d},Hs=(e,t,i)=>zs(t,(()=>e.loop),(t=>{(0,u.R)(t)&&(e.loop=t)}),{onError:i}),Ws=(e,t,i,s)=>zs(t,(()=>({muted:e.muted,volume:e.volume})),(t=>{(0,u.R)(t)&&(e.muted=t.muted,e.volume=t.volume)}),{equal:(e,t)=>e===t||e?.muted===t?.muted&&e?.volume===t?.volume,changed$:i,onError:s}),Qs=(e,t,i,s)=>zs(t,(()=>e.playbackRate),(t=>{(0,u.R)(t)&&(e.playbackRate=t)}),{changed$:i,onError:s}),Xs=zs,Gs=(e,t)=>{if(e.id===t)return!0;let[i,s,r]=t.split("|");return e.language===s&&e.label===r},Zs=class e{connect(e,t,i){this.video=e,this.cueSettings=t.textTrackCuesSettings,this.subscribe();let s=e=>{this.error$.next({id:"TextTracksManager",category:u.h.WTF,message:"Generic HtmlVideoTextTrackManager error",thrown:e})};this.subscription.add(this.available$.subscribe(i.availableTextTracks$)),this.subscription.add(this.current$.subscribe(i.currentTextTrack$)),this.subscription.add(this.error$.subscribe(i.error$)),this.subscription.add(Xs(t.internalTextTracks,(()=>(0,qs.default)(this.internalTracks)),(e=>{(0,u.R)(e)&&this.setInternal(e)}),{equal:(e,t)=>(0,u.R)(e)&&(0,u.R)(t)&&e.length===t.length&&e.every((({id:e},i)=>e===t[i].id)),changed$:this.available$.pipe((0,u.Tj)((e=>e.filter((({type:e})=>"internal"===e))))),onError:s})),this.subscription.add(Xs(t.externalTextTracks,(()=>(0,qs.default)(this.externalTracks)),(e=>{(0,u.R)(e)&&this.setExternal(e)}),{equal:(e,t)=>(0,u.R)(e)&&(0,u.R)(t)&&e.length===t.length&&e.every((({id:e},i)=>e===t[i].id)),changed$:this.available$.pipe((0,u.Tj)((e=>e.filter((({type:e})=>"external"===e))))),onError:s})),this.subscription.add(Xs(t.currentTextTrack,(()=>{if(this.video)return;let e=this.htmlTextTracksAsArray().find((({mode:e})=>"showing"===e));return e&&this.htmlTextTrackToITextTrack(e).id}),(e=>this.select(e)),{changed$:this.current$,onError:s})),this.subscription.add(Xs(t.textTrackCuesSettings,(()=>({})),(()=>{if(this.video)for(let e of this.htmlTextTracksAsArray())this.applyCueSettings(e.cues),this.applyCueSettings(e.activeCues)})))}subscribe(){(0,u.tZ)(this.video);let{textTracks:e}=this.video;this.subscription.add((0,u.Rt)(e,"addtrack").subscribe((()=>{let e=this.current$.getValue();e&&this.select(e)}))),this.subscription.add((0,u.h1)((0,u.Rt)(e,"addtrack"),(0,u.Rt)(e,"removetrack"),(0,u.Ss)(["init"])).pipe((0,u.Tj)((()=>this.htmlTextTracksAsArray().map((e=>this.htmlTextTrackToITextTrack(e))))),(0,u.jX)(((e,t)=>e.length===t.length&&e.every((({id:e},i)=>e===t[i].id))))).subscribe(this.available$)),this.subscription.add((0,u.h1)((0,u.Rt)(e,"change"),(0,u.Ss)(["init"])).pipe((0,u.Tj)((()=>this.htmlTextTracksAsArray().find((({mode:e})=>"showing"===e)))),(0,u.Tj)((e=>e&&this.htmlTextTrackToITextTrack(e).id)),(0,u.jX)()).subscribe(this.current$));let t=e=>this.applyCueSettings(e.target?.activeCues??null);this.subscription.add((0,u.Rt)(e,"addtrack").subscribe((e=>{e.track?.addEventListener("cuechange",t);let i=e=>{let t=e.target?.cues??null;t&&t.length&&(this.applyCueSettings(e.target?.cues??null),e.target?.removeEventListener("cuechange",i))};e.track?.addEventListener("cuechange",i)}))),this.subscription.add((0,u.Rt)(e,"removetrack").subscribe((e=>{e.track?.removeEventListener("cuechange",t)})))}applyCueSettings(e){if(!e||!e.length)return;let t=this.cueSettings.getState();for(let i of Array.from(e)){let e=i;(0,u.R)(t.align)&&(e.align=t.align),(0,u.R)(t.position)&&(e.position=t.position),(0,u.R)(t.size)&&(e.size=t.size),(0,u.R)(t.line)&&(e.line=t.line)}}htmlTextTracksAsArray(t=!1){(0,u.tZ)(this.video);let i=[...this.video.textTracks];return t?i:i.filter(e.isHealthyTrack)}htmlTextTrackToITextTrack(e){let{language:t,label:i}=e,s=e.id?e.id:(e=>["__",e.language,e.label].join("|"))(e),r=this.externalTracks.has(s),a=(r?this.externalTracks.get(s)?.isAuto:this.internalTracks.get(s)?.isAuto)??s.includes("auto");return r?{id:s,type:"external",isAuto:a,language:t,label:i,url:this.externalTracks.get(s)?.url}:{id:s,type:"internal",isAuto:a,language:t,label:i,url:this.internalTracks.get(s)?.url}}static isHealthyTrack(e){return!("metadata"===e.kind||e.groupId||""===e.id&&""===e.label&&""===e.language)}setExternal(e){this.internalTracks.size>0&&Array.from(this.internalTracks).forEach((([,e])=>this.detach(e))),e.filter((({id:e})=>!this.externalTracks.has(e))).forEach((e=>this.attach(e))),Array.from(this.externalTracks).filter((([t])=>!e.find((e=>e.id===t)))).forEach((([,e])=>this.detach(e)))}setInternal(e){let t=[...this.externalTracks];e.filter((({id:e,language:i,isAuto:s})=>!this.internalTracks.has(e)&&!t.some((([,e])=>e.language===i&&e.isAuto===s)))).forEach((e=>this.attach(e))),Array.from(this.internalTracks).filter((([t])=>!e.find((e=>e.id===t)))).forEach((([,e])=>this.detach(e)))}select(e){(0,u.tZ)(this.video);for(let e of this.htmlTextTracksAsArray(!0))e.mode="showing";for(let t of this.htmlTextTracksAsArray(!0))((0,u.wD)(e)||!Gs(t,e))&&(t.mode="disabled")}destroy(){if(this.subscription.unsubscribe(),this.video)for(let e of Array.from(this.video.getElementsByTagName("track"))){let t=e.getAttribute("id");t&&this.externalTracks.has(t)&&this.video.removeChild(e)}this.externalTracks.clear()}attach(e){(0,u.tZ)(this.video);let t=document.createElement("track");this.baseURL?t.setAttribute("src",new URL(e.url,this.baseURL).toString()):t.setAttribute("src",e.url),t.setAttribute("id",e.id),e.label&&t.setAttribute("label",e.label),e.language&&t.setAttribute("srclang",e.language),"external"===e.type?this.externalTracks.set(e.id,e):"internal"===e.type&&this.internalTracks.set(e.id,e),this.video.appendChild(t)}detach(e){(0,u.tZ)(this.video);let t=Array.prototype.find.call(this.video.getElementsByTagName("track"),(t=>t.getAttribute("id")===e.id));t&&this.video.removeChild(t),"external"===e.type?this.externalTracks.delete(e.id):"internal"===e.type&&this.internalTracks.delete(e.id)}constructor(e){this.available$=new u.B7,this.current$=new u.Ot(void 0),this.error$=new u.B7,this.subscription=new u.yU,this.externalTracks=new Map,this.internalTracks=new Map,this.baseURL=e}},Ys=class{getTotalPausedTime(){return this.pausedTime+this.getCurrentPausedTime()}getCurrentPausedTime(){return this.pauseTimestamp>0?Date.now()-this.pauseTimestamp:0}getStreamOffset(){return this.streamOffset}getTotalOffset(){return this.getTotalPausedTime()+this.streamOffset}pause(){0===this.pauseTimestamp&&(this.pauseTimestamp=Date.now())}resume(){this.pauseTimestamp>0&&(this.pausedTime+=this.getCurrentPausedTime(),this.pauseTimestamp=0)}resetTo(e,t=!1){this.streamOffset=e,this.pauseTimestamp=0,this.pausedTime=0,t&&this.pause()}constructor(){this.pausedTime=0,this.streamOffset=0,this.pauseTimestamp=0}},Js=e=>{let t=e;for(;!(t instanceof Document||t instanceof ShadowRoot||null===t);)t=t?.parentNode;return t??void 0},Ks=e=>{let t=Js(e);return!(!t||!t.fullscreenElement||t.fullscreenElement!==e)},er=e=>{let t,i=t=>(0,u.Rt)(e,t).pipe((0,u.uc)(void 0),(0,u.tl)(1)),s=new u.yU,r=(0,u.h1)((0,u.Rt)(e,"progress"),(0,u.Rt)(e,"timeupdate")).pipe((0,u.Tj)((()=>((e,t,i=3)=>{let s=0,r=0;for(let a=0;a<e.length;a++){let n=e.start(a),o=e.end(a);if(n<=t&&t<=o){if(s=n,r=o,!i)return{from:s,to:r};for(let t=a-1;t>=0;t--)e.end(t)+i>=s&&(s=e.start(t));for(let t=a+1;t<e.length;t++)e.start(t)-i<=r&&(r=e.end(t))}}return{from:s,to:r}})(e.buffered,e.currentTime))),(0,u.tl)(1)),a=ks.browser.isSafari?(0,u.kg)({play:i("play").pipe((0,u.Oo)()),playing:i("playing")}).pipe((0,u.uc)(void 0),(0,u.tl)(1)):i("playing"),n=(0,u.Rt)(e,"volumechange").pipe((0,u.Tj)((()=>({muted:e.muted,volume:e.volume}))),(0,u.tl)(1)),o=(0,u.Rt)(e,"ratechange").pipe((0,u.Tj)((()=>e.playbackRate)),(0,u.tl)(1)),h=(0,u.Rt)(e,"error").pipe((0,u.pb)((()=>!(!e.error&&!e.played.length))),(0,u.Tj)((()=>{let t=e.error;return{id:t?`MediaError#${t.code}`:"HtmlVideoError",category:u.h.VIDEO_PIPELINE,message:t?t.message:"Error event from HTML video element",thrown:e.error??void 0}})),(0,u.tl)(1)),d=(0,u.Rt)(e,"timeupdate").pipe((0,u.Tj)((()=>e.currentTime)),(0,u.tl)(1)),l=new u.B7;s.add((0,u.h1)(...["waiting","seeking","seeked","timeupdate"].map((t=>(0,u.Rt)(e,t)))).subscribe((i=>{let s=e.currentTime;e.loop&&(0,u.R)(t)&&(0,u.R)(s)&&t>=e.duration-.3&&s<=.3&&l.next(t),t=s})));let c=i("pause").pipe((0,u.pb)((()=>!e.error&&t!==e.duration)),(0,u.tl)(1)),p=(0,u.Rt)(e,"enterpictureinpicture").pipe((0,u.tl)(1)),f=(0,u.Rt)(e,"leavepictureinpicture").pipe((0,u.tl)(1)),m=new u.Ot((e=>{let t=Js(e);return!(!t||!t.pictureInPictureElement||t.pictureInPictureElement!==e)})(e));s.add(p.subscribe((()=>m.next(!0)))),s.add(f.subscribe((()=>m.next(!1))));let g=new u.Ot(Ks(e)),b=(0,u.Rt)(e,"fullscreenchange").pipe((0,u.tl)(1));s.add(b.pipe((0,u.Tj)((()=>Ks(e)))).subscribe(g));let v=(0,u.Rt)(e,"timeupdate").pipe((0,u.Tj)((t=>e.duration-e.currentTime<.1)),(0,u.jX)(),(0,u.tl)(1)),y=(0,u.h1)(v.pipe((0,u.pb)((t=>!e.loop&&t))),(0,u.Rt)(e,"ended")).pipe((0,u.nF)(1e3),(0,u.uc)(void 0),(0,u.tl)(1)),S=(0,u.h1)(...["waiting","pause","canplay","play","canplaythrough","playing","seeking","seeked","ended"].map((t=>(0,u.Rt)(e,t))),v.pipe((0,u.Tj)((e=>({type:e?"ended":"unknown"}))))).pipe((0,u.Tj)((t=>ks.browser.isFirefox&&"ended"===t.type?e.readyState<2:e.readyState<3)),(0,u.jX)(),(0,u.tl)(1));return{playing$:a,pause$:c,canplay$:i("canplay"),ended$:y,looped$:l,error$:h,seeked$:i("seeked"),seeking$:i("seeking"),progress$:i("progress"),loadStart$:i("loadstart"),loadedMetadata$:i("loadedmetadata"),loadedData$:i("loadeddata"),timeUpdate$:d,durationChange$:(0,u.Rt)(e,"durationchange").pipe((0,u.Tj)((()=>e.duration)),(0,u.tl)(1)),isBuffering$:S,currentBuffer$:r,volumeState$:n,playbackRateState$:o,inPiP$:m,inFullscreen$:g,enterPip$:p,leavePip$:f,destroy:()=>s.unsubscribe()}},tr=e=>{switch(e){case"mobile":return u.Xb.Q_144P;case"lowest":return u.Xb.Q_240P;case"low":return u.Xb.Q_360P;case"sd":case"medium":return u.Xb.Q_480P;case"hd":case"high":return u.Xb.Q_720P;case"fullhd":case"full":return u.Xb.Q_1080P;case"quadhd":case"quad":return u.Xb.Q_1440P;case"ultrahd":case"ultra":return u.Xb.Q_2160P}},ir=g(ni(),1),sr=g(Oe(),1),rr=g(Fe(),1),ar=!1,nr={},or=e=>{e(nr)},ur=(e,t)=>{ar&&(nr.meta=nr.meta??{},nr.meta[e]=t)},hr=class{next(e){if(!ar)return;nr.series=nr.series??{};let t=nr.series[this.name]??[];t.push([Date.now(),e]),nr.series[this.name]=t}constructor(e){this.name=e}};function dr(e,t,i){return(0,u.wD)(e)||(0,u.R)(e.min)&&(0,u.R)(e.max)&&(0,u.cs)(e.max,e.min)||(0,u.R)(e.min)&&t&&(0,u.kW)(e.min,t)||(0,u.R)(e.max)&&i&&(0,u.cs)(e.max,i)}function lr({limits:e,highestAvailableHeight:t,lowestAvailableHeight:i}){return dr({max:e?.max?(0,u.lx)(e.max):void 0,min:e?.min?(0,u.lx)(e.min):void 0},t?(0,u.lx)(t):void 0,i?(0,u.lx)(i):void 0)}var cr=new hr("best_bitrate"),pr=(e,t,i)=>(t-i)*Math.pow(2,-10*e)+i,fr=e=>(t,i)=>e*(Number(t.bitrate)-Number(i.bitrate)),mr=class{recordSelection(e){this.history[e.id]=(0,u.tB)()}recordSwitch(e){this.last=e}clear(){this.last=void 0,this.history={}}constructor(){this.history={}}},gr='Assertion "ABR Tracks is empty array" failed',br=new WeakMap,vr=new WeakMap,yr=new WeakMap,Sr=(e,t,i,s)=>{let r=[...t].sort(fr(1)),a=[...i].sort(fr(1)),n=a.filter((t=>!(0,u.R)(t.bitrate)||!(0,u.R)(e.bitrate)||e.bitrate/t.bitrate>s)),o=(0,ir.default)(a,Math.round(a.length*r.indexOf(e)/(r.length+1)))??(0,ir.default)(a,-1);return o&&(0,sr.default)(n,o)?o:n.length?(0,ir.default)(n,-1):(0,ir.default)(a,0)},wr=(e,t,i,s)=>{let r=br.get(t);r||(r=[...t].sort(fr(1)),br.set(t,r));let a=br.get(i);a||(a=[...i].sort(fr(1)),br.set(i,a));let n=yr.get(e);n||(n=a.filter((t=>!(0,u.R)(t.bitrate)||!(0,u.R)(e.bitrate)||e.bitrate/t.bitrate>s)),yr.set(e,n));let o=(0,ir.default)(a,Math.round(a.length*r.indexOf(e)/(r.length+1)))??(0,ir.default)(a,-1);return o&&(0,sr.default)(n,o)?o:n.length?(0,ir.default)(n,-1):(0,ir.default)(a,0)},Tr=e=>"quality"in e,$r=(e,t,i,s)=>{let r=(0,u.R)(s?.last?.bitrate)&&(0,u.R)(i?.bitrate)&&s.last.bitrate<i.bitrate?e.trackCooldownIncreaseQuality:e.trackCooldownDecreaseQuality,a=i&&s&&s.history[i.id]&&(0,u.tB)()-s.history[i.id]<=r&&(!s.last||i.id!==s.last.id);if(i?.id&&s&&!a&&s.recordSelection(i),a&&s?.last){let e=s.last;return s?.recordSwitch(e),t({message:`\n    [last ${Tr(e)?"video":"audio"} selected] ${Tr(e)?e.quality:e.bitrate}\n    `}),e}return s?.recordSwitch(i),i},xr=({tuning:e,container:t,limits:i,panelSize:s})=>{let r=e.containerSizeFactor;if(s)return{containerSizeLimit:s,containerSizeFactor:r};if(e.usePixelRatio&&ks.display.pixelRatio){let t=ks.display.pixelRatio;if(e.pixelRatioMultiplier)r*=e.pixelRatioMultiplier*(t-1)+1;else{let i=e.pixelRatioLogBase,[s=0,a=0,n=0]=e.pixelRatioLogCoefficients,o=((e,t)=>Math.log(t)/Math.log(e))(i,s*t+a)+n;Number.isFinite(o)&&(r*=o)}}return(0,u.R)(i?.min)&&(0,u.Xp)(i.min,e.highQualityLimit)&&(r*=2),{containerSizeLimit:e.limitByContainer&&t&&t.width>0&&t.height>0?{width:t.width*r,height:t.height*r}:void 0,containerSizeFactor:r}},kr=new WeakMap,Lr=(e,{container:t,estimatedThroughput:i,tuning:s,limits:r,reserve:a=0,forwardBufferHealth:n,playbackRate:o,current:h,history:d,visible:l,droppedVideoMaxQualityLimit:c,stallsVideoMaxQualityLimit:p,stallsPredictedThroughput:f,abrLogger:m,panelSize:g})=>{(0,u.sS)(e,gr);let{containerSizeFactor:b,containerSizeLimit:v}=xr({container:t,tuning:s,limits:r,panelSize:g}),y=s.considerPlaybackRate&&(0,u.R)(o)?o:1,S=kr.get(e);S||(S=e.filter((e=>!(0,u.C4)(e.quality))).sort(((e,t)=>(0,u.kW)(e.quality,t.quality)?-1:1)),kr.set(e,S));let w=(0,ir.default)(S,-1)?.quality,T=(0,ir.default)(S,0)?.quality,$=dr(r,T,w),x=y*pr(n??.5,s.bitrateFactorAtEmptyBuffer,s.bitrateFactorAtFullBuffer),k={},L=null;for(let e of S){let t=!0;if(v)if(e.size)t=e.size.width<=v.width&&e.size.height<=v.height;else{let i=v&&(0,u.Hf)(v);t=!i||(0,u.X5)(e.quality,i)}if(!t){k[e.quality]="FitsContainer";continue}let o=f||i,d=!((0,u.R)(o)&&isFinite(o)&&(0,u.R)(e.bitrate))||o-a>=e.bitrate*x,m=r?.min===e.quality;if(!d&&!m){k[e.quality]="FitsThroughput";continue}if(s.lazyQualitySwitch&&(0,u.R)(s.minBufferToSwitchUp)&&h&&!(0,u.C4)(h.quality)&&(n??0)<s.minBufferToSwitchUp&&(0,u.kW)(e.quality,h.quality)){k[e.quality]="Buffer";continue}if(c&&(0,u.Xp)(e.quality,c)&&!m){k[e.quality]="DroppedFramesLimit";continue}if(p&&(0,u.Xp)(e.quality,p)&&!m){k[e.quality]="StallsLimit";continue}let g=$||((0,u.wD)(r?.max)||(0,u.X5)(e.quality,r.max))&&((0,u.wD)(r?.min)||(0,u.Xp)(e.quality,r.min)),b=!((0,u.R)(l)&&!l)||(0,u.X5)(e.quality,s.backgroundVideoQualityLimit);g&&b?L||(L=e):k[e.quality]="FitsQualityLimits"}L&&L.bitrate&&cr.next(L.bitrate);let R=L??(0,ir.default)(S,-1)??e[0],E=d?.last,B=$r(s,m,R,d);return(0,u.R)(d)&&B.quality!==E?.quality&&m({message:`\n    [VIDEO TRACKS ABR]\n    [available video tracks]\n\t${e.map((e=>`{ id: ${e.id}, quality: ${e.quality}, bitrate: ${e.bitrate}, size: ${e.size?.width}:${e.size?.height} }`)).join("\n\t")}\n\n    [tuning]\n\t${(0,rr.default)(s??{}).map((([e,t])=>`${e}: ${t}`)).join("\n\t")}\n\n    [limit params]\n    containerSizeFactor: ${b},\n    containerSizeLimit: ${v?.width??0} x ${v?.height??0},\n    estimatedThroughput: ${i},\n    stallsPredictedThroughput: ${f},\n    reserve: ${a},\n    playbackRate: ${o},\n    playbackRateFactor: ${y},\n    forwardBufferHealth: ${n},\n    bitrateFactor: ${x},\n    minBufferToSwitchUp: ${s.minBufferToSwitchUp},\n    droppedVideoMaxQualityLimit: ${c},\n    stallsVideoMaxQualityLimit: ${p},\n    limitsAreInvalid: ${$},\n    maxQualityLimit: ${r?.max},\n    minQualityLimit: ${r?.min},\n\n    [limited video tracks]\n    ${(0,rr.default)(k).map((([e,t])=>`${e}: ${t}`)).join("\n\t")||"All tracks are available"}\n\n    [best video track] ${L?.quality}\n    [selected video track] ${B?.quality}\n    `}),B},Rr=(e,{container:t,estimatedThroughput:i,tuning:s,limits:r,reserve:a=0,forwardBufferHealth:n,playbackRate:o,current:h,history:d,visible:l,droppedVideoMaxQualityLimit:c,stallsVideoMaxQualityLimit:p,stallsPredictedThroughput:f,abrLogger:m,panelSize:g})=>{(0,u.sS)(e,gr);let{containerSizeFactor:b,containerSizeLimit:v}=xr({container:t,tuning:s,limits:r,panelSize:g}),y=s.considerPlaybackRate&&(0,u.R)(o)?o:1,S=e.filter((e=>!(0,u.C4)(e.quality))).sort(((e,t)=>(0,u.kW)(e.quality,t.quality)?-1:1)),w=(0,ir.default)(S,-1)?.quality,T=(0,ir.default)(S,0)?.quality,$=dr(r,T,w),x=y*pr(n??.5,s.bitrateFactorAtEmptyBuffer,s.bitrateFactorAtFullBuffer),k={},L=S.filter((e=>{let t=!0;if(v)if(e.size)t=e.size.width<=v.width&&e.size.height<=v.height;else{let i=v&&(0,u.Hf)(v);t=!i||(0,u.X5)(e.quality,i)}if(!t)return k[e.quality]="FitsContainer",!1;let o=f||i,d=!((0,u.R)(o)&&isFinite(o)&&(0,u.R)(e.bitrate))||o-a>=e.bitrate*x,m=r?.min===e.quality;if(!d&&!m)return k[e.quality]="FitsThroughput",!1;if(s.lazyQualitySwitch&&(0,u.R)(s.minBufferToSwitchUp)&&h&&!(0,u.C4)(h.quality)&&(n??0)<s.minBufferToSwitchUp&&(0,u.kW)(e.quality,h.quality))return k[e.quality]="Buffer",!1;if(c&&(0,u.Xp)(e.quality,c)&&!m)return k[e.quality]="DroppedFramesLimit",!1;if(p&&(0,u.Xp)(e.quality,p)&&!m)return k[e.quality]="StallsLimit",!1;let g=$||((0,u.wD)(r?.max)||(0,u.X5)(e.quality,r.max))&&((0,u.wD)(r?.min)||(0,u.Xp)(e.quality,r.min)),b=!((0,u.R)(l)&&!l)||(0,u.X5)(e.quality,s.backgroundVideoQualityLimit);return!(!g||!b)||(k[e.quality]="FitsQualityLimits",!1)}))[0];L&&L.bitrate&&cr.next(L.bitrate);let R=L??(0,ir.default)(S,-1)??e[0],E=d?.last,B=$r(s,m,R,d);return(0,u.R)(d)&&B.quality!==E?.quality&&m({message:`\n    [VIDEO TRACKS ABR]\n    [available video tracks]\n\t${e.map((e=>`{ id: ${e.id}, quality: ${e.quality}, bitrate: ${e.bitrate}, size: ${e.size?.width}:${e.size?.height} }`)).join("\n\t")}\n\n    [tuning]\n\t${(0,rr.default)(s??{}).map((([e,t])=>`${e}: ${t}`)).join("\n\t")}\n\n    [limit params]\n    containerSizeFactor: ${b},\n    containerSizeLimit: ${v?.width??0} x ${v?.height??0},\n    estimatedThroughput: ${i},\n    stallsPredictedThroughput: ${f},\n    reserve: ${a},\n    playbackRate: ${o},\n    playbackRateFactor: ${y},\n    forwardBufferHealth: ${n},\n    bitrateFactor: ${x},\n    minBufferToSwitchUp: ${s.minBufferToSwitchUp},\n    droppedVideoMaxQualityLimit: ${c},\n    stallsVideoMaxQualityLimit: ${p},\n    limitsAreInvalid: ${$},\n    maxQualityLimit: ${r?.max},\n    minQualityLimit: ${r?.min},\n\n    [limited video tracks]\n    ${(0,rr.default)(k).map((([e,t])=>`${e}: ${t}`)).join("\n\t")||"All tracks are available"}\n\n    [best video track] ${L?.quality}\n    [selected video track] ${B?.quality}\n    `}),B},Er=(e,t,i,{estimatedThroughput:s,tuning:r,playbackRate:a,forwardBufferHealth:n,history:o,abrLogger:h,stallsPredictedThroughput:d})=>{(0,u.sS)(i,gr);let l=r.considerPlaybackRate&&(0,u.R)(a)?a:1,c=[...i].sort(fr(-1)),p=e.bitrate;(0,u.tZ)(p);let f,m=l*pr(n??.5,r.bitrateAudioFactorAtEmptyBuffer,r.bitrateAudioFactorAtFullBuffer),g=Sr(e,t,i,r.minVideoAudioRatio),b=d||s;(0,u.R)(b)&&isFinite(b)&&(f=c.find((e=>!(!(0,u.R)(e.bitrate)||!(0,u.R)(g?.bitrate))&&(b-p>=e.bitrate*m&&e.bitrate>=g.bitrate)))),f||(f=g);let v=o?.last,y=f&&$r(r,h,f,o);return(0,u.R)(o)&&y?.bitrate!==v?.bitrate&&h({message:`\n    [AUDIO TRACKS ABR]\n    [available audio tracks]\n\t${i.map((e=>`{ id: ${e.id}, bitrate: ${e.bitrate} }`)).join("\n\t")}\n\n    [tuning]\n\t${(0,rr.default)(r??{}).map((([e,t])=>`${e}: ${t}`)).join("\n\t")}\n\n    [limit params]\n    estimatedThroughput: ${s},\n    stallsPredictedThroughput: ${d},\n    reserve: ${p},\n    playbackRate: ${a},\n    playbackRateFactor: ${l},\n    forwardBufferHealth: ${n},\n    bitrateFactor: ${m},\n    minBufferToSwitchUp: ${r.minBufferToSwitchUp},\n\n    [selected audio track] ${y?.id}\n    `}),y},Br=(e,t,i,{estimatedThroughput:s,tuning:r,playbackRate:a,forwardBufferHealth:n,history:o,abrLogger:h,stallsPredictedThroughput:d})=>{(0,u.sS)(i,gr);let l=r.considerPlaybackRate&&(0,u.R)(a)?a:1,c=vr.get(i);c||(c=[...i].sort(fr(-1)),vr.set(i,c));let p=e.bitrate;(0,u.tZ)(p);let f,m=l*pr(n??.5,r.bitrateAudioFactorAtEmptyBuffer,r.bitrateAudioFactorAtFullBuffer),g=wr(e,t,i,r.minVideoAudioRatio),b=d||s;(0,u.R)(b)&&isFinite(b)&&(f=c.find((e=>!(!(0,u.R)(e.bitrate)||!(0,u.R)(g?.bitrate))&&(b-p>=e.bitrate*m&&e.bitrate>=g.bitrate)))),f||(f=g);let v=o?.last,y=f&&$r(r,h,f,o);return(0,u.R)(o)&&y?.bitrate!==v?.bitrate&&h({message:`\n    [AUDIO TRACKS ABR]\n    [available audio tracks]\n\t${i.map((e=>`{ id: ${e.id}, bitrate: ${e.bitrate} }`)).join("\n\t")}\n\n    [tuning]\n\t${(0,rr.default)(r??{}).map((([e,t])=>`${e}: ${t}`)).join("\n\t")}\n\n    [limit params]\n    estimatedThroughput: ${s},\n    stallsPredictedThroughput: ${d},\n    reserve: ${p},\n    playbackRate: ${a},\n    playbackRateFactor: ${l},\n    forwardBufferHealth: ${n},\n    bitrateFactor: ${m},\n    minBufferToSwitchUp: ${r.minBufferToSwitchUp},\n\n    [selected audio track] ${y?.id}\n    `}),y},Ar=e=>new URL(e).hostname,Mr=g(ni(),1),Cr=g(Oe(),1),Ir=e=>{if(e instanceof DOMException&&(0,Cr.default)(["Failed to load because no supported source was found.","The element has no supported sources."],e.message))throw e;return!(e instanceof DOMException&&(20===e.code||"AbortError"===e.name))},Dr=async(e,t)=>{let i=e.muted;try{await e.play()}catch(s){if(!Ir(s))return!1;if(t&&t(),i)return console.warn(s),!1;e.muted=!0;try{await e.play()}catch(t){return Ir(t)&&(e.muted=!1,console.warn(t)),!1}}return!0},Or=g(Be(),1);function Pr(){return(0,u.tB)()}function Vr(e){return Pr()-e}function _r(e){let t=e.split("/"),i=t.slice(0,t.length-1).join("/"),s=/^([a-z]+:)?\/\//i;return{resolve:(e,t,r=!1)=>{(e=>s.test(e))(e)||(e.startsWith("/")||(e="/"+e),e=i+e);let a=e.indexOf("?")>-1?"&":"?";return r&&(e+=a+"lowLat=1",a="&"),t&&(e+=a+"_rnd="+Math.floor(999999999*Math.random())),e}}}function Fr(e,t,i,s){let r,a,n,o,h,d=window.XMLHttpRequest,l=!1,c=0,p=!1,f="arraybuffer",m=7e3,g=2e3,b=()=>{if(l)return;(0,u.tZ)(o);let e,t=Vr(o);if(t<g)return e=g-t,void setTimeout(b,e);g*=2,g>m&&(g=m),a&&a.abort(),a=new d,y()},v=()=>{if(!l){if(--c>=0)return b(),void(s&&s());l=!0,h&&h(),i&&i()}},y=()=>{o=Pr(),a=new d,a.open("get",e);let i,s=0,c=0,m=()=>((0,u.tZ)(o),Math.max(o,Math.max(i||0,c||0)));if(r&&a.addEventListener("progress",(e=>{let t=Pr();r.updateChunk&&e.loaded>s&&(r.updateChunk(m(),e.loaded-s),s=e.loaded,i=t)})),n&&(a.timeout=n,a.addEventListener("timeout",(()=>v()))),a.addEventListener("load",(()=>{if(l)return;(0,u.tZ)(a);let e=a.status;if(e>=200&&e<300){let{response:e,responseType:i}=a,n=e?.byteLength;if("number"==typeof n&&r){let e=n-s;e&&r.updateChunk&&r.updateChunk(m(),e)}"json"!==i||e&&(0,Or.default)(e).length?(h&&h(),t(e)):v()}else v()})),a.addEventListener("error",(()=>{v()})),p){let e=()=>{(0,u.tZ)(a),a.readyState===XMLHttpRequest.HEADERS_RECEIVED&&(c=Pr(),a.removeEventListener("readystatechange",e))};a.addEventListener("readystatechange",e)}return a.responseType=f,a.send(),S},S={withBitrateReporting:e=>(r=e,S),withParallel:e=>(p=e,S),withJSONResponse:()=>(f="json",S),withRetryCount:e=>(c=e,S),withRetryInterval:(e,t)=>((0,u.R)(e)&&(g=e),(0,u.R)(t)&&(m=t),S),withTimeout:e=>(n=e,S),withFinally:e=>(h=e,S),send:y,abort:()=>{a&&(a.abort(),a=void 0),l=!0,h&&h()}};return S}var Nr=class{_updateRate(e){let t=.2;this.currentRate&&(e<.1*this.currentRate?t=.8:e<.5*this.currentRate?t=.5:e<.7*this.currentRate&&(t=.3)),e=Math.max(1,Math.min(e,104857600)),this.currentRate=this.currentRate?this.currentRate*(1-t)+e*t:e}_createInterval(e,t,i){return{start:e,end:t,bytes:i}}_doMergeIntervals(e,t){e.start=Math.min(t.start,e.start),e.end=Math.max(t.end,e.end),e.bytes+=t.bytes}_mergeIntervals(e,t){return e.start<=t.end&&t.start<=e.end&&(this._doMergeIntervals(e,t),!0)}_flushIntervals(){if(!this.intervals.length)return!1;let e=this.intervals[0].start,t=this.intervals[this.intervals.length-1].end-500;if(t-e>2e3){let i=0,s=0;for(;this.intervals.length>0;){let e=this.intervals[0];if(e.end<=t)i+=e.end-e.start,s+=e.bytes,this.intervals.splice(0,1);else{if(e.start>=t)break;{let r=t-e.start,a=e.end-e.start;i+=r;let n=e.bytes*r/a;s+=n,e.start=t,e.bytes-=n}}}if(s>0&&i>0){let r=8*s/(i/1e3);return this._updateRate(r),this.logger(`rate updated, new=${Math.round(r/1024)}K; average=${Math.round(this.currentRate/1024)}K bytes/ms=${Math.round(s)}/${Math.round(i)} interval=${Math.round(t-e)}`),!0}}return!1}_joinIntervals(){let e;do{e=!1;for(let t=0;t<this.intervals.length-1;++t)this._mergeIntervals(this.intervals[t],this.intervals[t+1])&&(this.intervals.splice(t+1,1),e=!0)}while(e)}addInterval(e,t,i){return this.intervals.push(this._createInterval(e,t,i)),this._joinIntervals(),this.intervals.length>100&&(this.logger(`too many intervals (${this.intervals.length}); will merge`,{type:"warn"}),this._doMergeIntervals(this.intervals[1],this.intervals[0]),this.intervals.splice(0,1)),this._flushIntervals()}getBitRate(){return this.currentRate}constructor(e){this.intervals=[],this.currentRate=0,this.logger=e}},Ur=g(Be(),1),jr=class{limitCompleteCount(){let e;for(;(e=Object.keys(this.completeRequests)).length>this._getParallelRequestCount()+2;){let t=e[Math.floor(Math.random()*e.length)];this.logger(`Dropping completed request for url ${t}`,{type:"warn"}),delete this.completeRequests[t]}}_sendRequest(e,t){let i=Pr(),s=i=>{delete this.activeRequests[t],this.limitCompleteCount(),this.completeRequests[t]=e,this._sendPending(),e._error=1,e._errorMsg=i,e._errorCB?e._errorCB(i):(this.limitCompleteCount(),this.completeRequests[t]=e)};e._request=Fr(t,(s=>{e._complete=1,e._responseData=s,e._downloadTime=Pr()-i,delete this.activeRequests[t],this._sendPending(),e._cb?e._cb(s,e._downloadTime):(this.limitCompleteCount(),this.completeRequests[t]=e)}),(()=>s("error")),(()=>{e._retry=1,e._retryCB&&e._retryCB()})),e._request.withRetryCount(this.RETRY_COUNT).withTimeout(this.TIMEOUT).withBitrateReporting(this.BITRATE_ESTIMATOR).withParallel(this._getParallelRequestCount()>1).withFinally((()=>{e._finallyCB&&e._finallyCB()})),this.activeRequests[t]=e,e._request.send(),this.lastPrefetchStart=Pr()}_getParallelRequestCount(){return Math.min(this.MAX_PARALLEL_REQUESTS,this.averageSegmentDuration<3e3?3:2)}_getPrefetchDelay(){return Math.max(100,Math.min(5e3,this.averageSegmentDuration/3))}_canSendPending(){let e=this._getParallelRequestCount(),t=Pr();if(Object.keys(this.activeRequests).length>=e)return!1;let i=this._getPrefetchDelay()-(t-this.lastPrefetchStart);return this.throttleTimeout&&clearTimeout(this.throttleTimeout),!(i>0)||(this.throttleTimeout=window.setTimeout((()=>this._sendPending()),i),!1)}_sendPending(){for(;this._canSendPending();){let e=this.pendingQueue.pop();if(!e)return;this.activeRequests[e]||this.completeRequests[e]||(this.logger(`Submitting pending request url=${e}`),this._sendRequest({},e))}}_removeFromActive(e){delete this.completeRequests[e],delete this.activeRequests[e]}abortAll(){(0,Ur.default)(this.activeRequests).forEach((e=>{e&&e._request&&e._request.abort()})),this.activeRequests={},this.pendingQueue=[],this.completeRequests={}}requestData(e,t,i,s){let r={};return r.send=()=>{let a=this.activeRequests[e]||this.completeRequests[e];if(a)a._cb=t,a._errorCB=i,a._retryCB=s,a._finallyCB=r._finallyCB,a._error||a._complete?(this._removeFromActive(e),setTimeout((()=>{a._complete?(this.logger(`Requested url already prefetched, url=${e}`),t(a._responseData,a._downloadTime)):(this.logger(`Requested url already prefetched with error, url=${e}`),i(a._errorMsg)),r._finallyCB&&r._finallyCB()}),0)):this.logger(`Attached to active request, url=${e}`);else{let t=this.pendingQueue.indexOf(e);-1!==t&&this.pendingQueue.splice(t,1),this.logger(`Request not prefetched, starting new request, url=${e}${-1===t?"":"; removed pending"}`),this._sendRequest(r,e)}},r._cb=t,r._errorCB=i,r._retryCB=s,r.abort=function(){r.request&&r.request.abort()},r.withFinally=e=>(r._finallyCB=e,r),r}prefetch(e){this.activeRequests[e]||this.completeRequests[e]?this.logger(`Request already active for url=${e}`):(this.logger(`Added to pending queue; url=${e}`),this.pendingQueue.unshift(e),this._sendPending())}optimizeForSegDuration(e){this.averageSegmentDuration=e}constructor(e,t,i,s,r){this.pendingQueue=[],this.activeRequests={},this.completeRequests={},this.averageSegmentDuration=2e3,this.lastPrefetchStart=0,this.throttleTimeout=null,this.RETRY_COUNT=e,this.TIMEOUT=t,this.BITRATE_ESTIMATOR=i,this.MAX_PARALLEL_REQUESTS=s,this.logger=r}},qr=(e,t)=>(0,u.R)(e)&&(0,u.R)(t)&&"open"===e.readyState&&function(e,t){for(let i=0;i<e.activeSourceBuffers.length;++i)if(e.activeSourceBuffers[i]===t)return!0;return!1}(e,t);var zr,Hr=g(Fe(),1),Wr=class{toString(){return`${this.tag}: ${this.time}: ${JSON.stringify(this.data)}${this.stack?`, stack: ${this.stack}`:""}`}toDevNullEntry(){let e=(0,Hr.default)(this.data).map((([e,t])=>`${e}:${t}`)).join(",");return{key:this.tag,strings:[e,this.stack??""],numbers:[this.time]}}constructor(e,t,i,s){this.tag=e,this.time=t,this.data=i,this.stack=s}},Qr=((e,t="warn")=>{let i=[];function s(s,r=!1){let a=window.performance?.timing?.navigationStart??0,n=new Wr(e,Math.round((Date.now()-a)/1e3),s,r?(new Error).stack:void 0);i.push(n),t&&window.console[t](n.toString())}return s.reset=()=>{i=[]},s.drain=()=>{let e=i;return i=[],e},s})("vp_dash_live_debug",!1),Xr=1e4,Gr=class{attachSource(e){this.manifestUrl=e,this.urlResolver=_r(e),this.bitrateSwitcher=this._initBitrateSwitcher(),this._initManifest()}setAutoQualityEnabled(e){this.autoQuality=e}setAutoQualityLimits(e){this.autoQualityLimits=e}switchByName(e){let t;for(let i=0;i<this.manifest.length;++i)if(t=this.manifest[i],t.name===e)return void this._switchToQuality(t)}catchUp(){if(this.rep&&(Qr({m:"ldp.catchUp.1"}),this.rep.stop()),this.currentManifestEntry){let e=this.params.playbackState.getState();this.paused="paused"===e,Qr({m:"ldp.catchUp.2"}),this._initPlayerWith(this.currentManifestEntry),this._notifyBuffering(!0)}}stop(){this.params.videoElement.pause(),this.rep&&(this.rep.stop(),this.rep=null)}pause(){this.paused=!0,this.params.videoElement.pause(),this.videoPlayStarted=!1,this._notifyBuffering(!1)}play(){this.paused=!1;let e=this.lowLatency&&this._getBufferSizeSec()>this.sourceJitter+5;this.rep&&!e?(this.bufferStates=[],this.videoPlayStarted=!1,this.shouldPlay()?(Qr({m:"ldp.play.1"}),this._playVideoElement()):(Qr({m:"ldp.play.2"}),this._notifyBuffering(!0))):(Qr({m:"ldp.play.3"}),this.catchUp())}startPlay(e,t){this.autoQuality=t,Qr({m:"startPlay",url:e.jidxUrl}),this._initPlayerWith(e)}destroy(){this.destroyed=!0,this.rep&&(this.rep.stop(),this.rep=null),this.manifestRequest&&this.manifestRequest.abort(),this.manifestRefetchTimer&&(clearTimeout(this.manifestRefetchTimer),this.manifestRefetchTimer=void 0)}reinit(e){this.manifestUrl=e,this.urlResolver=_r(e),Qr({m:"ldp.reinit",url:e}),this.catchUp()}_handleNetworkError(){this.params.logger("Fatal network error"),this.params.playerCallback({name:"error",type:"network"})}_retryCallback(){this.params.playerCallback({name:"retry"})}_getBufferSizeSec(){let e=this.params.videoElement,t=0,i=e.buffered.length;return 0!==i&&(t=e.buffered.end(i-1)-Math.max(e.currentTime,e.buffered.start(0))),t}_notifyBuffering(e){this.destroyed||(this.params.logger(`buffering: ${e}`),this.params.playerCallback({name:"buffering",isBuffering:e}),this.buffering=e)}_initVideo(){let{videoElement:e,logger:t}=this.params;Qr({m:"iv"}),e.addEventListener("error",(()=>{e.error&&!this.destroyed&&(Qr({m:"iv.err",e:e.error?.code+":"+e.error?.message}),t(`Video element error: ${e.error?.code}, details: ${e.error?.message}`),this.params.playerCallback({name:"error",type:"media"}))})),e.addEventListener("timeupdate",(()=>{let e=this._getBufferSizeSec();!this.paused&&e<.3?this.buffering||(this.buffering=!0,window.setTimeout((()=>{!this.paused&&this.buffering&&this._notifyBuffering(!0)}),1e3*(e+.1))):this.buffering&&this.videoPlayStarted&&this._notifyBuffering(!1)})),e.addEventListener("playing",(()=>{t("playing")})),e.addEventListener("stalled",(()=>this._fixupStall())),e.addEventListener("waiting",(()=>this._fixupStall()))}_fixupStall(){let e,{logger:t,videoElement:i}=this.params,s=i.buffered.length;0!==s&&!this.waitingForFirstBufferAfterSrcChange&&(e=i.buffered.start(s-1),i.currentTime<e&&(t("Fixup stall"),Qr({m:"ldp.fs",t:e}),i.currentTime=e))}_selectQuality(e){let t,i,s,{videoElement:r}=this.params,a=r&&1.62*(ks.display.pixelRatio||1)*r.offsetHeight||520;for(let r=0;r<this.manifest.length;++r){s=this.manifest[r];let{max:n,min:o}=this.autoQualityLimits||{};!lr({limits:this.autoQualityLimits,highestAvailableHeight:this.manifest[0].video.height,lowestAvailableHeight:(0,Mr.default)(this.manifest,-1).video.height})&&(n&&s.video.height>n||o&&s.video.height<o)||(s.bitrate<e&&a>Math.min(s.video.height,s.video.width)?(!i||s.bitrate>i.bitrate)&&(i=s):(!t||t.bitrate>s.bitrate)&&(t=s))}return i||t}shouldPlay(){if(this.paused)return!1;let e=this._getBufferSizeSec()-Math.max(1,this.sourceJitter);return e>3||(0,u.R)(this.downloadRate)&&(this.downloadRate>1.5&&e>2||this.downloadRate>2&&e>1)}_setVideoSrc(e,t){let{logger:i,videoElement:s,playerCallback:r}=this.params;this.mediaSource=new window.MediaSource,i("setting video src"),s.src=URL.createObjectURL(this.mediaSource),this.mediaSource.addEventListener("sourceopen",(()=>{this.mediaSource&&(Qr({m:"sourceopen",c:e.codecs}),this.sourceBuffer=this.mediaSource.addSourceBuffer(e.codecs),this.bufferStates=[],t())})),this.mediaSource?.addEventListener("sourceclose",(e=>{Qr({m:"sourceclose"})})),this.videoPlayStarted=!1,s.addEventListener("canplay",(()=>{Qr({m:"canplay"}),this.shouldPlay()&&(this.videoPlayStarted=!0,this._playVideoElement())}));let a=()=>{!function(e,t,i){let s=(...r)=>{i.apply(null,r),e.removeEventListener(t,s)};e.addEventListener(t,s)}(s,"progress",(()=>{s.buffered.length?(s.currentTime=s.buffered.start(0),this.waitingForFirstBufferAfterSrcChange=!1,r({name:"playing"})):a()}))};this.waitingForFirstBufferAfterSrcChange=!0,a()}_initPlayerWith(e){this.bitrate=0,this.rep=0,this.sourceBuffer=0,this.bufferStates=[],this.filesFetcher&&this.filesFetcher.abortAll(),this.filesFetcher=new jr(3,Xr,this.bitrateSwitcher,this.params.config.maxParallelRequests,this.params.logger),this._setVideoSrc(e,(()=>this._switchToQuality(e)))}_representation(e){let{logger:t,videoElement:i,playerCallback:s}=this.params,r=!1,a=null,n=null,o=null,h=null,d=!1,l=()=>{let e=r&&(!d||d===this.rep);return e||t("Not running!"),e},c=(e,t,i)=>{o&&o.abort(),o=Fr(this.urlResolver.resolve(e,!1),t,i,(()=>this._retryCallback())).withTimeout(Xr).withBitrateReporting(this.bitrateSwitcher).withRetryCount(3).withFinally((()=>{o=null})).send()},p=(e,t,i)=>{(0,u.tZ)(this.filesFetcher),n?.abort(),n=this.filesFetcher.requestData(this.urlResolver.resolve(e,!1),t,i,(()=>this._retryCallback())).withFinally((()=>{n=null})).send()},f=e=>{let s=i.playbackRate;i.playbackRate!==e&&(t(`Playback rate switch: ${s}=>${e}`),i.playbackRate=e)},m=e=>{this.lowLatency=e,t(`lowLatency changed to ${e}`),g()},g=()=>{if(this.lowLatency||this.params.config.isLiveCatchUpMode){let e=this._getBufferSizeSec();if(this.bufferStates.length<5)return void f(1);let i=Pr()-1e4,s=0;for(let t=0;t<this.bufferStates.length;t++){let r=this.bufferStates[t];e=Math.min(e,r.buf),r.ts<i&&s++}this.bufferStates.splice(0,s),t(`update playback rate;  minBuffer=${e} drop=${s} jitter=${this.sourceJitter}`);let r=e-1;this.sourceJitter>=0?r-=this.sourceJitter/2:this.sourceJitter-=1,f(r>3?1.15:r>1?1.1:r>.3?1.05:1)}else f(1)},b=e=>{let i,r=()=>i&&i.start?i.start.length:0,a=e=>i.start[e]/1e3,n=e=>i.dur[e]/1e3,o=e=>i.fragIndex+e,d=(e,t)=>({chunkIdx:o(e),startTS:a(e),dur:n(e),discontinuity:t}),c=()=>{let e=0;if(i&&i.dur){let t=this.lowLatency?this.params.config.lowLatencyMinBuffer:this.params.config.minBuffer,s=this.lowLatency?this.params.config.lowLatencyMinBufferSegments:this.params.config.minBufferSegments,r=t;this.sourceJitter>1&&(r+=this.sourceJitter-1);let a=i.dur.length-1;for(;a>=0&&(r-=i.dur[a],!(r<=0));--a);e=Math.min(a,i.dur.length-1-s),e=Math.max(e,0)}return d(e,!0)},p=(e,t,i)=>{h&&h.abort(),h=Fr(this.urlResolver.resolve(e,!0,this.lowLatency),t,i,(()=>this._retryCallback())).withTimeout(Xr).withRetryCount(3).withFinally((()=>{h=null})).withJSONResponse().send()};return{seek:(t,n)=>{p(e,(e=>{if(!l())return;i=e;let o=!!i.lowLatency;o!==this.lowLatency&&m(o);let h=0;for(let e=0;e<i.dur.length;++e)h+=i.dur[e];h>0&&((0,u.tZ)(this.filesFetcher),this.filesFetcher.optimizeForSegDuration(h/i.dur.length)),s({name:"index",zeroTime:i.zeroTime,shiftDuration:i.shiftDuration}),this.sourceJitter=i.hasOwnProperty("jitter")?Math.min(10,Math.max(.01,i.jitter/1e3)):1,t((e=>{let t=r();if(!(t<=0)){if((0,u.R)(e))for(let i=0;i<t;i++)if(a(i)>e)return d(i);return c()}})(n))}),(()=>this._handleNetworkError()))},nextChunk:e=>{let s=r(),a=e?e.chunkIdx+1:0,n=a-i.fragIndex;if(!(s<=0)){if(!e||n<0||n-s>10)return t(`Resync: offset=${n} bChunks=${s} chunk=`+JSON.stringify(e)),c();if(!(n>=s))return d(a-i.fragIndex,!1)}}}},v=()=>{r=!1,n&&n.abort(),o&&o.abort(),h&&h.abort(),(0,u.tZ)(this.filesFetcher),this.filesFetcher.abortAll()};return d={start:t=>{let i,s,n,o,d,f,m,{videoElement:y,logger:S}=this.params,w=b(e.jidxUrl),T=0,$=()=>{d&&(clearTimeout(d),d=void 0);let e=Math.max(500,1e3*(this._getBufferSizeSec()-this.sourceJitter-5)),t=T+e,i=Pr(),s=Math.min(1e4,t-i);T=i;let r=()=>{h||l()&&w.seek((()=>{l()&&(T=Pr(),x(),$())}))};s>0?d=window.setTimeout((()=>{this.paused?$():r()}),s):r()},x=()=>{let t;for(;t=w.nextChunk(o);)o=t,B(t);let i=w.nextChunk(n);if(i){if(n&&i.discontinuity)return S("Detected discontinuity; restarting playback"),void(this.paused?$():(v(),Qr({m:"ldp.fetchChunkIdx.0"}),this._initPlayerWith(e)));E(i)}else $()},k=(e,t)=>{if(!l()||!this.sourceBuffer)return void Qr({m:"ab.0",c:[!l(),!this.sourceBuffer]});let i,s,r,a=i=>{Qr({m:"ldp.postpone",t:i}),window.setTimeout((()=>{l()&&k(e,t)}),i)};if(this.sourceBuffer.updating)S("Source buffer is updating; delaying appendBuffer"),Qr({m:"ldp.ab.1"}),a(100);else{let n=Pr(),o=y.currentTime;!this.paused&&y.buffered.length>1&&f===o&&n-m>500&&(S("Stall suspected; trying to fix"),this._fixupStall()),f!==o&&(f=o,m=n);let u=this._getBufferSizeSec();if(u>30)Qr({m:"ldp.ab.3"}),S(`Buffered ${u} seconds; delaying appendBuffer`),a(2e3);else try{if(this.params.config.useInvalidBufferFix&&qr(this.mediaSource,this.sourceBuffer))return;this.sourceBuffer.appendBuffer(e),this.videoPlayStarted?(Qr({m:"ldp.ab.5"}),this.bufferStates.push({ts:n,buf:u}),g(),this.bufferStates.length>200&&this.bufferStates.shift()):this.shouldPlay()&&(Qr({m:"ldp.ab.4"}),this.videoPlayStarted=!0,this._playVideoElement()),t&&t()}catch(e){if(Qr({m:"ldp.ab.err",e:e.name}),"QuotaExceededError"!==e.name)throw e;S("QuotaExceededError; delaying appendBuffer"),r=this.sourceBuffer.buffered.length,0!==r&&(i=this.sourceBuffer.buffered.start(0),s=o,s-i>4&&this.sourceBuffer.remove(i,s-3)),a(1e3)}}},L=()=>{s&&i&&(S([`Appending chunk, sz=${s.byteLength}:`,JSON.stringify(n)]),k(s,(function(){s=null,x()})))},R=t=>e.fragUrlTemplate.replace("%%id%%",t.chunkIdx),E=e=>{l()&&p(R(e),((t,i)=>{if(l()){if(i/=1e3,s=t,n=e,a=e.startTS,i){let t=Math.min(10,e.dur/i);this.downloadRate=this.downloadRate?.7*this.downloadRate+.3*t:t}L()}}),(()=>this._handleNetworkError()))},B=e=>{l()&&((0,u.tZ)(this.filesFetcher),this.filesFetcher.prefetch(this.urlResolver.resolve(R(e),!1)))},A=t=>{l()&&(e.cachedHeader=t,k(t,(()=>{i=!0,L()})))};r=!0,w.seek((e=>{if(l()){if(T=Pr(),!e)return void $();o=e,!(0,u.wD)(t)||e.startTS>t?E(e):(n=e,x())}}),t),e.cachedHeader?A(e.cachedHeader):c(e.headerUrl,A,(()=>this._handleNetworkError()))},stop:v,getTimestampSec:()=>a},d}_switchToQuality(e){let t,{logger:i,playerCallback:s}=this.params;e.bitrate!==this.bitrate&&(this.rep&&(t=this.rep.getTimestampSec(),(0,u.R)(t)&&(t+=.1),this.rep.stop()),this.currentManifestEntry=e,this.rep=this._representation(e),i(`switch to quality: codecs=${e.codecs}; headerUrl=${e.headerUrl}; bitrate=${e.bitrate}`),this.bitrate=e.bitrate,(0,u.tZ)(this.bitrateSwitcher),this.bitrateSwitcher.notifySwitch(this.bitrate),this.rep.start(t),s({name:"qualitySwitch",quality:e}))}_qualityAvailable(e){return(0,u.R)(this.manifest.find((t=>t.name===e)))}_initBitrateSwitcher(){let e,{logger:t,playerCallback:i}=this.params,s=e=>{if(!this.autoQuality)return;let i,s,r;this.currentManifestEntry&&this._qualityAvailable(this.currentManifestEntry.name)&&e<this.bitrate&&(s=this._getBufferSizeSec(),r=e/this.bitrate,s>10&&r>.8||s>15&&r>.5||s>20&&r>.3)?t(`Not switching: buffer=${Math.floor(s)}; bitrate=${this.bitrate}; newRate=${Math.floor(e)}`):(i=this._selectQuality(e),i?this._switchToQuality(i):t(`Could not find quality by bitrate ${e}`))},r=(e,t)=>{let s=Pr();if(this.chunkRateEstimator.addInterval(e,s,t)){let r=this.chunkRateEstimator.getBitRate();return i({name:"bandwidth",size:t,duration:s-e,speed:r}),!0}},a=()=>{let e=this.chunkRateEstimator.getBitRate();return e?.85*e:0},n=-1/0,o=!0,u=()=>{let t=a();if(t&&e&&this.autoQuality){if(o&&t>e&&Vr(n)<3e4)return;s(t)}o=this.autoQuality};return{updateChunk:(e,t)=>{let i=r(e,t);return i&&u(),i},notifySwitch:t=>{let i=Pr();t<e&&(n=i),e=t}}}_fetchManifest(e,t,i){this.manifestRequest=Fr(this.urlResolver.resolve(e,!0),t,i,(()=>this._retryCallback())).withJSONResponse().withTimeout(Xr).withRetryCount(this.params.config.manifestRetryMaxCount).withRetryInterval(this.params.config.manifestRetryInterval,this.params.config.manifestRetryMaxInterval).send().withFinally((()=>{this.manifestRequest=void 0}))}_playVideoElement(){let{videoElement:e}=this.params;Dr(e,(()=>{this.soundProhibitedEvent$.next()})).then((e=>{Qr({m:"ldp.pve.1"}),e||(Qr({m:"ldp.pve.2"}),this.params.liveOffset.pause(),this.params.videoState.setState("paused"))}))}_handleManifestUpdate(e){let{logger:t,playerCallback:i,videoElement:s}=this.params;this.manifest=(e=>{let t=[];return e?.length?(e.forEach(((e,i)=>{e.video&&s.canPlayType(e.codecs).replace(/no/,"")&&window.MediaSource?.isTypeSupported?.(e.codecs)&&(e.index=i,t.push(e))})),t.sort((function(e,t){return e.video&&t.video?t.video.height-e.video.height:t.bitrate-e.bitrate})),t):(i({name:"error",type:"empty_manifest"}),[])})(e),t(`Valid manifest entries: ${this.manifest.length}/${e.length}`),i({name:"manifest",manifest:this.manifest})}_refetchManifest(e){this.destroyed||(this.manifestRefetchTimer&&clearTimeout(this.manifestRefetchTimer),this.manifestRefetchTimer=window.setTimeout((()=>{this._fetchManifest(e,(t=>{this.destroyed||(this._handleManifestUpdate(t),this._refetchManifest(e))}),(()=>this._refetchManifest(e)))}),6e4))}_initManifest(){this._fetchManifest(this.manifestUrl,(e=>{this.destroyed||(this._handleManifestUpdate(e),this._refetchManifest(this.manifestUrl))}),(()=>this._handleNetworkError()))}constructor(e){this.paused=!1,this.autoQuality=!0,this.autoQualityLimits=void 0,this.buffering=!0,this.destroyed=!1,this.videoPlayStarted=!1,this.lowLatency=!1,this.bitrate=0,this.manifest=[],this.sourceBuffer=0,this.bufferStates=[],this.sourceJitter=-1,this.waitingForFirstBufferAfterSrcChange=!1,this.params=e,this.soundProhibitedEvent$=new u.B7,this.chunkRateEstimator=new Nr(this.params.logger),this._initVideo()}},Zr=g(Fe(),1),Yr=class{connect(e){this.log=e.logger.createComponentLog("DroppedFramesManager"),this.video=e.video,this.isAuto=e.isAuto,this.tracks=e.tracks,this.droppedFramesChecker=e.droppedFramesChecker,this.subscription.add(e.playing$.subscribe((()=>this.playing=!0))),this.subscription.add(e.pause$.subscribe((()=>this.playing=!1))),this.isEnabled&&this.subscribe()}destroy(){this.currentTimer&&window.clearTimeout(this.currentTimer),this.subscription.unsubscribe()}get droppedVideoMaxQualityLimit(){return this.maxQualityLimit}subscribe(){this.subscription.add((0,u.Rt)(this.video,"resize").subscribe(this.handleChangeVideoQuality));let e=(0,u.YP)(this.droppedFramesChecker.checkTime).pipe((0,u.pb)((()=>this.playing)),(0,u.pb)((()=>{let e=!!this.isForceCheckCounter;return e&&(this.isForceCheckCounter-=1),!e}))),t=this.forceChecker$.pipe((0,u.sg)(this.droppedFramesChecker.checkTime)),i=(0,u.h1)(e,t);this.subscription.add(i.subscribe(this.checkDroppedFrames))}onChangeQuality(e){this.currentQuality=e;let{totalVideoFrames:t,droppedVideoFrames:i}=this.video.getVideoPlaybackQuality();this.savePrevFrameCounts(t,i),this.isForceCheckCounter=this.droppedFramesChecker.tickCountAfterQualityChange,this.forceChecker$.next()}onDroopedVideoFramesLimitTrigger(){this.isAuto.getState()&&(this.log({message:`[onDroopedVideoFramesLimit]. maxQualityLimit: ${this.maxQualityLimit}`}),this.onDroopedVideoFramesLimit$.next())}getMaxQualityLimit(e){let t=(0,Zr.default)(this.limitCounts).filter((([,e])=>e>=this.droppedFramesChecker.countLimit)).sort((([e],[t])=>(0,u.cs)(e,t)?-1:1))?.[0]?.[0];return e??t}get isEnabled(){return this.droppedFramesChecker.enabled&&this.isDroppedFramesCheckerSupport}get isDroppedFramesCheckerSupport(){return!!this.video&&"function"==typeof this.video.getVideoPlaybackQuality}savePrevFrameCounts(e,t){this.prevTotalVideoFrames=e,this.prevDroppedVideoFrames=t}constructor(){this.onDroopedVideoFramesLimit$=new u.B7,this.subscription=new u.yU,this.playing=!1,this.tracks=[],this.forceChecker$=new u.B7,this.isForceCheckCounter=0,this.prevTotalVideoFrames=0,this.prevDroppedVideoFrames=0,this.limitCounts={},this.handleChangeVideoQuality=()=>{let e=this.tracks.find((({size:e})=>e?.height===this.video.videoHeight&&e?.width===this.video.videoWidth));e&&!(0,u.C4)(e.quality)&&this.onChangeQuality(e.quality)},this.checkDroppedFrames=()=>{let{totalVideoFrames:e,droppedVideoFrames:t}=this.video.getVideoPlaybackQuality(),i=e-this.prevTotalVideoFrames,s=1-(i-(t-this.prevDroppedVideoFrames))/i;!isNaN(s)&&s>0&&this.log({message:`[dropped]. current dropped percent: ${s}, limit: ${this.droppedFramesChecker.percentLimit}`}),!isNaN(s)&&s>=this.droppedFramesChecker.percentLimit&&(0,u.kW)(this.currentQuality,this.droppedFramesChecker.minQualityBanLimit)&&(this.limitCounts[this.currentQuality]=(this.limitCounts[this.currentQuality]??0)+1,this.maxQualityLimit=this.getMaxQualityLimit(this.currentQuality),this.currentTimer&&window.clearTimeout(this.currentTimer),this.currentTimer=window.setTimeout((()=>this.maxQualityLimit=this.getMaxQualityLimit()),this.droppedFramesChecker.qualityUpWaitingTime),this.onDroopedVideoFramesLimitTrigger()),this.savePrevFrameCounts(e,t)}}},Jr=()=>!!window.documentPictureInPicture?.window||!!document.pictureInPictureElement,Kr=(e,t)=>new u.cP((i=>{if(!window.IntersectionObserver)return;let s=new IntersectionObserver(((e,t)=>{e.forEach((e=>i.next(e.isIntersecting||Jr())))}),{root:null,...t});s.observe(e);let r=(0,u.Rt)(document,"visibilitychange").pipe((0,u.Tj)((e=>!document.hidden||Jr()))).subscribe((e=>i.next(e)));return()=>{s.unobserve(e),r.unsubscribe()}})),ea=["paused","playing","ready"],ta=["paused","playing","ready"],ia=class{destroy(){Qr({m:"dlp.destroy"}),this.subscription.unsubscribe(),this.textTracksManager.destroy(),this.droppedFramesManager.destroy(),this.dash.destroy(),this.params.output.element$.next(void 0),js(this.video)}createLiveDashPlayer(){let e=new Gr({videoElement:this.video,videoState:this.videoState,playbackState:this.params.desiredState.playbackState,liveOffset:this.liveOffset,config:{maxParallelRequests:this.params.config.maxParallelRequests,minBuffer:this.params.tuning.live.minBuffer,minBufferSegments:this.params.tuning.live.minBufferSegments,lowLatencyMinBuffer:this.params.tuning.live.lowLatencyMinBuffer,lowLatencyMinBufferSegments:this.params.tuning.live.lowLatencyMinBufferSegments,isLiveCatchUpMode:this.params.tuning.live.isLiveCatchUpMode,manifestRetryInterval:this.params.tuning.manifestRetryInterval,manifestRetryMaxInterval:this.params.tuning.manifestRetryMaxInterval,manifestRetryMaxCount:this.params.tuning.manifestRetryMaxCount,useInvalidBufferFix:this.params.tuning.useInvalidBufferFix||!1},playerCallback:this._dashCb,logger:e=>{this.params.dependencies.logger.log({message:String(e),component:"LiveDashPlayer"})}});return e.pause(),e}prepare(){let e=this.representations$.getValue(),t=this.params.desiredState.videoTrack.getTransition()?.to??this.params.desiredState.videoTrack.getState(),i=this.params.desiredState.autoVideoTrackSwitching.getTransition()?.to??this.params.desiredState.autoVideoTrackSwitching.getState(),s=!i&&(0,u.R)(t)?t:Lr(e.map((({track:e})=>e)),{container:this.video.getBoundingClientRect(),panelSize:this.params.panelSize,estimatedThroughput:this.params.dependencies.throughputEstimator.throughput$.getValue(),tuning:this.params.tuning.autoTrackSelection,limits:this.params.desiredState.autoVideoTrackLimits.getState(),droppedVideoMaxQualityLimit:this.droppedFramesManager.droppedVideoMaxQualityLimit,abrLogger:this.params.dependencies.abrLogger}),r=s?.id,a=this.params.desiredState.videoTrack.getTransition(),n=this.params.desiredState.videoTrack.getState()?.id,o=this.params.desiredState.autoVideoTrackSwitching.getTransition();if(s&&(a||r!==n)&&this.setVideoTrack(s),o&&this.setAutoQuality(i),a||o||r!==n){let t=e.find((({track:e})=>e.id===r))?.representation;(0,u.tZ)(t,"Representations missing"),this.dash.startPlay(t,i)}}setVideoTrack(e){let t=this.representations$.getValue().find((({track:t})=>t.id===e.id))?.representation;(0,u.tZ)(t,`No such representation ${e.id}`),this.dash.switchByName(t.name),this.params.desiredState.videoTrack.setState(e)}setAutoQuality(e){this.dash.setAutoQualityEnabled(e),this.params.desiredState.autoVideoTrackSwitching.setState(e)}seek(e){this.log({message:`[seek] position: ${e}`}),this.params.output.willSeekEvent$.next();let t=this.params.desiredState.playbackState.getState(),i=this.videoState.getState(),s="paused"===t&&"paused"===i,r=-e,a=r<=this.maxSeekBackTime$.getValue()?r:0;this.params.output.position$.next(e/1e3),Qr({m:"dlp.seek",p:e,no:a,url:this.params.source.url}),this.dash.reinit(is(this.params.source.url,a)),s&&this.dash.pause(),this.liveOffset.resetTo(a,s)}constructor(e){this.subscription=new u.yU,this.videoState=new Ps("stopped"),this.representations$=new u.Ot([]),this.droppedFramesManager=new Yr,this.maxSeekBackTime$=new u.Ot(1/0),this.zeroTime$=new u.Ot(void 0),this.liveOffset=new Ys,this._dashCb=e=>{switch(e.name){case"buffering":{let t=e.isBuffering;this.params.output.isBuffering$.next(t);break}case"error":this.params.output.error$.next({id:`DashLiveProviderInternal:${e.type}`,category:u.h.WTF,message:"LiveDashPlayer reported error"});break;case"manifest":{let t=e.manifest,i=[];for(let e of t){let t=e.name??e.index.toString(10),s=tr(e.name)??(0,u.Hf)(e.video),r=e.bitrate/1e3,a={...e.video};if(!s)continue;let n={id:t,quality:s,bitrate:r,size:a};i.push({track:n,representation:e})}this.representations$.next(i),this.params.output.availableVideoTracks$.next(i.map((({track:e})=>e))),"manifest_ready"===this.videoState.getTransition()?.to&&this.videoState.setState("manifest_ready");break}case"qualitySwitch":{let t=e.quality,i=this.representations$.getValue().find((({representation:e})=>e===t))?.track;this.params.output.hostname$.next(new URL(t.headerUrl,this.params.source.url).hostname),(0,u.R)(i)&&this.params.output.currentVideoTrack$.next(i);break}case"bandwidth":{let{size:t,duration:i}=e;this.params.dependencies.throughputEstimator.addRawSpeed(t,i);break}case"index":this.maxSeekBackTime$.next(e.shiftDuration||0),this.zeroTime$.next(e.zeroTime)}},this.syncPlayback=()=>{let e=this.videoState.getState(),t=this.videoState.getTransition(),i=this.params.desiredState.playbackState.getState(),s=this.params.desiredState.playbackState.getTransition(),r=this.params.desiredState.seekState.getState();if(this.log({message:`[syncPlayback] videoState: ${e}; videoTransition: ${JSON.stringify(t)}; desiredPlaybackState: ${i}; seekState: ${JSON.stringify(r)};`}),"stopped"===i)return void("stopped"!==e&&(this.videoState.startTransitionTo("stopped"),this.dash.destroy(),this.video.removeAttribute("src"),this.video.load(),this.videoState.setState("stopped")));if(t)return;let a=this.params.desiredState.videoTrack.getTransition(),n=this.params.desiredState.autoVideoTrackSwitching.getTransition();if((0,_s.default)(ta,e)&&(a||n))this.prepare();else if("paused"!==s?.to&&"requested"===r.state&&(0,_s.default)(ea,e))this.seek(r.position-this.liveOffset.getTotalPausedTime());else switch(e){case"stopped":return this.videoState.startTransitionTo("manifest_ready"),void this.dash.attachSource(is(this.params.source.url));case"manifest_ready":this.videoState.startTransitionTo("ready"),this.prepare();break;case"ready":if("paused"===i)this.videoState.setState("paused");else if("playing"===i){Qr({m:"dlp.sync.1"}),this.videoState.startTransitionTo("playing");let e=s?.from;e&&"ready"===e&&(Qr({m:"dlp.sync.2"}),this.dash.catchUp()),Qr({m:"dlp.sync.3"}),this.dash.play()}return;case"playing":return void("paused"===i&&(this.videoState.startTransitionTo("paused"),this.liveOffset.pause(),this.dash.pause()));case"paused":if("playing"===i)if(this.videoState.startTransitionTo("playing"),this.liveOffset.getTotalPausedTime()<this.params.config.maxPausedTime&&this.liveOffset.getTotalOffset()<this.maxSeekBackTime$.getValue())this.liveOffset.resume(),this.dash.play(),this.params.output.position$.next(-this.liveOffset.getTotalOffset()/1e3);else{let e=this.liveOffset.getTotalOffset();e>=this.maxSeekBackTime$.getValue()&&(e=0,this.liveOffset.resetTo(e)),this.liveOffset.resume(),this.params.output.position$.next(-e/1e3),this.dash.reinit(is(this.params.source.url,e))}return;default:return(0,u.xb)(e)}},this.textTracksManager=new Zs(e.source.url),this.params=e,this.log=this.params.dependencies.logger.createComponentLog("DashLiveProvider");let t=t=>{e.output.error$.next({id:"DashLiveProvider",category:u.h.WTF,message:"DashLiveProvider internal logic error",thrown:t})};this.subscription.add((0,u.h1)(this.videoState.stateChangeStarted$.pipe((0,u.Tj)((e=>({transition:e,type:"start"})))),this.videoState.stateChangeEnded$.pipe((0,u.Tj)((e=>({transition:e,type:"end"}))))).subscribe((({transition:e,type:t})=>{Qr({m:"dlp.s.1",t:t+`:${e.from}-${e.to}`}),this.log({message:`[videoState change] ${t}: ${JSON.stringify(e)}`})}))),this.video=Us(e.container,e.tuning),this.params.output.element$.next(this.video),this.dash=this.createLiveDashPlayer(),this.subscription.add(this.dash.soundProhibitedEvent$.subscribe(this.params.output.soundProhibitedEvent$)),this.params.output.duration$.next(1/0),this.params.output.position$.next(0),this.params.output.isLive$.next(!0),this.params.output.canChangePlaybackSpeed$.next(!1),this.params.output.hostname$.next(Ar(this.params.source.url)),this.params.output.autoVideoTrackLimitingAvailable$.next(!0),this.params.output.availableVideoTracks$.next([]),this.params.output.availableAudioTracks$.next([]),this.params.output.isAudioAvailable$.next(!0),this.params.output.availableTextTracks$.next([]),this.params.desiredState.internalTextTracks.setState([]),this.textTracksManager.connect(this.video,this.params.desiredState,this.params.output);let i=er(this.video);this.subscription.add((()=>i.destroy())),this.subscription.add(this.representations$.pipe((0,u.Tj)((e=>e.map((({track:e})=>e)))),(0,u.pb)((e=>!!e.length)),(0,u.Oo)()).subscribe((e=>this.droppedFramesManager.connect({logger:this.params.dependencies.logger,video:this.video,droppedFramesChecker:this.params.tuning.droppedFramesChecker,isAuto:this.params.desiredState.autoVideoTrackSwitching,playing$:i.playing$,pause$:i.pause$,tracks:e})))),this.subscription.add(i.canplay$.subscribe((()=>{"ready"===this.videoState.getTransition()?.to&&this.videoState.setState("ready")}),t)).add(i.pause$.subscribe((()=>{this.videoState.setState("paused")}),t)).add(i.playing$.subscribe((()=>{"applying"===this.params.desiredState.seekState.getState().state&&this.params.output.seekedEvent$.next(),this.videoState.setState("playing")}),t)).add(i.error$.subscribe(this.params.output.error$)).add(this.maxSeekBackTime$.pipe((0,u.jX)(),(0,u.Tj)((e=>-e/1e3))).subscribe(this.params.output.duration$)).add((0,u.kg)({zeroTime:this.zeroTime$.pipe((0,u.pb)(u.R)),position:i.timeUpdate$}).subscribe((({zeroTime:e,position:t})=>this.params.output.liveTime$.next(e+1e3*t)),t)).add(Hs(this.video,this.params.desiredState.isLooped,t)).add(Ws(this.video,this.params.desiredState.volume,i.volumeState$,t)).add(i.volumeState$.subscribe(this.params.output.volume$,t)).add(Qs(this.video,this.params.desiredState.playbackRate,i.playbackRateState$,t)).add(i.loadStart$.subscribe(this.params.output.firstBytesEvent$)).add(i.loadedMetadata$.subscribe(this.params.output.loadedMetadataEvent$)).add(i.playing$.subscribe(this.params.output.firstFrameEvent$)).add(i.canplay$.subscribe(this.params.output.canplay$)).add(i.inPiP$.subscribe(this.params.output.inPiP$)).add(i.inFullscreen$.subscribe(this.params.output.inFullscreen$)).add(Kr(this.video).subscribe(this.params.output.elementVisible$)).add(this.params.desiredState.autoVideoTrackLimits.stateChangeStarted$.subscribe((({to:{max:e,min:t}})=>{this.dash.setAutoQualityLimits({max:e&&(0,u.HQ)(e),min:t&&(0,u.HQ)(t)}),this.params.output.autoVideoTrackLimits$.next({max:e,min:t})}))).add(this.videoState.stateChangeEnded$.subscribe((e=>{switch(e.to){case"stopped":this.params.output.position$.next(0),this.params.output.duration$.next(1/0),Qr({m:"dlp.vse.s"}),this.params.desiredState.playbackState.setState("stopped");break;case"manifest_ready":case"ready":"ready"===this.params.desiredState.playbackState.getTransition()?.to&&(Qr({m:"dlp.vse.r"}),this.params.desiredState.playbackState.setState("ready"));break;case"paused":Qr({m:"dlp.vse.pa"}),this.params.desiredState.playbackState.setState("paused");break;case"playing":Qr({m:"dlp.vse.pl"}),this.params.desiredState.playbackState.setState("playing");break;default:return(0,u.xb)(e.to)}}),t)).add((0,u.h1)(e.desiredState.playbackState.stateChangeStarted$,e.desiredState.seekState.stateChangeEnded$,e.desiredState.videoTrack.stateChangeStarted$,e.desiredState.autoVideoTrackSwitching.stateChangeStarted$,this.videoState.stateChangeEnded$,this.droppedFramesManager.onDroopedVideoFramesLimit$,(0,u.Ss)(["init"])).pipe((0,u.sg)(0)).subscribe(this.syncPlayback,t))}},sa=g(ni(),1),ra=({id:e,width:t,height:i,bitrate:s,fps:r,quality:a,streamId:n})=>{let o=(a?tr(a):void 0)??(0,u.Hf)({width:t,height:i});return o&&{id:e,quality:o,bitrate:s,size:{width:t,height:i},fps:r,streamId:n}},aa=({id:e,bitrate:t})=>({id:e,bitrate:t}),na=({language:e,label:t},{id:i,url:s,isAuto:r})=>({id:i,url:s,isAuto:r,type:"internal",language:e,label:t}),oa=({id:e,language:t,label:i,codecs:s,isDefault:r})=>({id:e,language:t,label:i,codec:(0,sa.default)(s.split("."),0),isDefault:r}),ua=({id:e,language:t,label:i,hdr:s,codecs:r})=>({id:e,language:t,hdr:s,label:i,codec:(0,sa.default)(r.split("."),0)}),ha=e=>"template"===e.type,da=class{constructor(e,t){this.fov=e,this.orientation=t}},la=class{turnCamera(e=0,t=0,i=0){this.pointCameraTo(this.camera.orientation.x+e,this.camera.orientation.y+t,this.camera.orientation.z+i)}pointCameraTo(e=0,t=0,i=0){t=this.limitCameraRotationY(t);let s=e-this.camera.orientation.x,r=t-this.camera.orientation.y,a=i-this.camera.orientation.z;this.camera.orientation.x=e,this.camera.orientation.y=t,this.camera.orientation.z=i,this.lastCameraTurn={x:s,y:r,z:a},this.lastCameraTurnTS=Date.now()}setRotationSpeed(e,t,i){this.rotationSpeed.x=e??this.rotationSpeed.x,this.rotationSpeed.y=t??this.rotationSpeed.y,this.rotationSpeed.z=i??this.rotationSpeed.z}startRotation(){this.rotating=!0}stopRotation(e=!1){e?(this.setRotationSpeed(0,0,0),this.fadeStartSpeed=null):this.startFading(this.rotationSpeed.x,this.rotationSpeed.y,this.rotationSpeed.z),this.rotating=!1}onCameraRelease(){if(this.lastCameraTurn&&this.lastCameraTurnTS){let e=Date.now()-this.lastCameraTurnTS;if(e<this.options.speedFadeThreshold){let t=(1-e/this.options.speedFadeThreshold)*this.options.rotationSpeedCorrection;this.startFading(this.lastCameraTurn.x*t,this.lastCameraTurn.y*t,this.lastCameraTurn.z*t)}}}startFading(e,t,i){this.setRotationSpeed(e,t,i),this.fadeStartSpeed={...this.rotationSpeed},this.fading=!0}stopFading(){this.fadeStartSpeed=null,this.fading=!0,this.fadeTime=0}limitCameraRotationY(e){return Math.max(-this.options.maxYawAngle,Math.min(e,this.options.maxYawAngle))}tick(e){if(!this.lastTickTS)return this.lastTickTS=e,void(this.lastCameraTurnTS=Date.now());let t=e-this.lastTickTS,i=t/1e3;if(this.rotating)this.turnCamera(this.rotationSpeed.x*this.options.rotationSpeedCorrection*i,this.rotationSpeed.y*this.options.rotationSpeedCorrection*i,this.rotationSpeed.z*this.options.rotationSpeedCorrection*i);else if(this.fading&&this.fadeStartSpeed){let e=-this.fadeCorrection*(this.fadeTime/1e3)**2+1;this.setRotationSpeed(this.fadeStartSpeed.x*e,this.fadeStartSpeed.y*e,this.fadeStartSpeed.z*e),e>0?this.turnCamera(this.rotationSpeed.x*this.options.rotationSpeedCorrection*i,this.rotationSpeed.y*this.options.rotationSpeedCorrection*i,this.rotationSpeed.z*this.options.rotationSpeedCorrection*i):(this.stopRotation(!0),this.stopFading()),this.fadeTime=Math.min(this.fadeTime+t,this.options.speedFadeTime)}this.lastTickTS=e}constructor(e,t){this.rotating=!1,this.fading=!1,this.lastTickTS=0,this.lastCameraTurnTS=0,this.fadeStartSpeed=null,this.fadeTime=0,this.camera=e,this.options=t,this.rotationSpeed={x:0,y:0,z:0},this.fadeCorrection=1/(this.options.speedFadeTime/1e3)**2}},ca=class{play(){this.active||(this.videoInitialized?this.doPlay():this.sourceVideoElement.readyState>=2?(this.videoInitialized=!0,this.doPlay()):this.sourceVideoElement.addEventListener("loadeddata",this.videoElementDataLoadedFn))}stop(){this.active=!1}startCameraManualRotation(e,t){this.cameraRotationManager.setRotationSpeed(e*this.params.rotationSpeed,t*this.params.rotationSpeed,0),this.cameraRotationManager.startRotation()}stopCameraManualRotation(e=!1){this.cameraRotationManager.stopRotation(e)}turnCamera(e,t){this.cameraRotationManager.turnCamera(e,t)}pointCameraTo(e,t){this.cameraRotationManager.pointCameraTo(e,t)}pixelToDegree(e){return{x:this.params.degreeToPixelCorrection*this.params.fov.x*-e.x/this.viewportWidth,y:this.params.degreeToPixelCorrection*this.params.fov.y*e.y/this.viewportHeight}}getCameraRotation(){return this.camera.orientation}holdCamera(){this.cameraRotationManager.stopRotation(!0)}releaseCamera(){this.cameraRotationManager.onCameraRelease()}destroy(){this.sourceVideoElement.removeEventListener("loadeddata",this.videoElementDataLoadedFn),this.stop(),this.canvas.remove()}setViewportSize(e,t){this.viewportWidth=e,this.viewportHeight=t,this.canvas.width=this.viewportWidth,this.canvas.height=this.viewportHeight,this.gl.viewport(0,0,this.canvas.width,this.canvas.height)}onDataLoadedHandler(){this.videoInitialized=!0,this.doPlay()}doPlay(){this.updateFrameSize(),this.vertexBuffer=this.createVertexBuffer(),this.active=!0,this.sourceVideoElement.removeEventListener("loadeddata",this.videoElementDataLoadedFn),requestAnimationFrame(this.renderFn)}render(e){this.cameraRotationManager.tick(e),this.updateTexture(),this.updateTextureMappingBuffer();let t=this.gl.getAttribLocation(this.program,"a_vertex"),i=this.gl.getAttribLocation(this.program,"a_texel"),s=this.gl.getUniformLocation(this.program,"u_texture"),r=this.gl.getUniformLocation(this.program,"u_focus");this.gl.enableVertexAttribArray(t),this.gl.enableVertexAttribArray(i),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer),this.gl.vertexAttribPointer(t,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureMappingBuffer),this.gl.vertexAttribPointer(i,2,this.gl.FLOAT,!1,0,0),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.videoTexture),this.gl.uniform1i(s,0),this.gl.uniform2f(r,-this.camera.orientation.x,-this.camera.orientation.y),this.gl.drawArrays(this.gl.TRIANGLE_FAN,0,4),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),this.gl.disableVertexAttribArray(t),this.gl.disableVertexAttribArray(i),this.active&&requestAnimationFrame(this.renderFn)}createShader(e,t){let i=this.gl.createShader(t);if(!i)throw this.destroy(),new Error(`Could not create shader (${t})`);if(this.gl.shaderSource(i,e),this.gl.compileShader(i),!this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS))throw this.destroy(),new Error("An error occurred while compiling the shader: "+this.gl.getShaderInfoLog(i));return i}createProgram(){let e=this.gl.createProgram();if(!e)throw this.destroy(),new Error("Could not create shader program");let t=this.createShader("attribute vec2 a_vertex;\nattribute vec2 a_texel;\n\nvarying vec2 v_texel;\n\nvoid main(void) {\n    // direct vertex drawing\n    gl_Position = vec4(a_vertex, 0.0, 1.0);\n    // save texel vector to pass to fragment shader\n    v_texel = a_texel;\n}\n",this.gl.VERTEX_SHADER),i=this.createShader("#ifdef GL_ES\n    precision highp float;\n    precision highp int;\n#else\n    precision highp float;\n#endif\n\n#define PI 3.14159265358979323846264\n\nvarying vec2 v_texel; // [0..1, 0..1]\n\nuniform sampler2D u_texture;\nuniform vec2 u_focus; // current central point [-180..180, -90..90] (degrees)\n\nvoid main(void) {\n    // center point of output projection\n    float lambda0 = u_focus.x / 360.0;\n    float phi0 = u_focus.y / 180.0;\n\n    float lambda = PI * 2.0 * (v_texel.x - 0.5 - lambda0); // [-pi..+pi] (rad)\n    float phi = PI * (v_texel.y - 0.5 - phi0); // [-pi/2..+pi/2] (rad)\n\n    float p = sqrt(lambda * lambda + phi * phi); // rou\n    float c = atan(p);\n    float cos_c = cos(c);\n    float sin_c = sin(c);\n\n    // geo coordinates of projection\n    float x = lambda0 + atan(\n        lambda * sin_c,\n        p * cos(phi0) * cos_c - phi * sin(phi0) * sin_c\n    );\n    float y = asin(cos_c * sin(phi0) + (phi * sin_c * cos(phi0)) / p);\n\n    // reprojected texture coordinates\n    vec2 tc = vec2(\n        mod(x / (PI * 2.0) - 0.5, 1.0), // [0..1]\n        mod(y / PI - 0.5, 1.0) // [0..1]\n    );\n\n    // sample using new coordinates\n    gl_FragColor = texture2D(u_texture, tc);\n}\n",this.gl.FRAGMENT_SHADER);if(this.gl.attachShader(e,t),this.gl.attachShader(e,i),this.gl.linkProgram(e),!this.gl.getProgramParameter(e,this.gl.LINK_STATUS))throw this.destroy(),new Error("Could not link shader program.");return e}createTexture(){let e=this.gl.createTexture();if(!e)throw this.destroy(),new Error("Could not create texture");return this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.bindTexture(this.gl.TEXTURE_2D,null),e}updateTexture(){this.gl.bindTexture(this.gl.TEXTURE_2D,this.videoTexture),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!0),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.sourceVideoElement),this.gl.bindTexture(this.gl.TEXTURE_2D,null)}createVertexBuffer(){let e=this.gl.createBuffer();if(!e)throw this.destroy(),new Error("Could not create vertex buffer");let t=1,i=1,s=this.frameHeight/(this.frameWidth/this.viewportWidth);return s>this.viewportHeight?t=this.viewportHeight/s:i=s/this.viewportHeight,this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([-t,-i,t,-i,t,i,-t,i]),this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),e}createTextureMappingBuffer(){let e=this.gl.createBuffer();if(!e)throw this.destroy(),new Error("Could not create texture mapping buffer");return e}calculateTexturePosition(){let e=.5-this.camera.orientation.x/360,t=.5-this.camera.orientation.y/180,i=this.camera.fov.x/360/2,s=this.camera.fov.y/180/2;return[e-i,t-s,e+i,t-s,e+i,t+s,e-i,t+s]}updateTextureMappingBuffer(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureMappingBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([...this.calculateTexturePosition()]),this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}updateFrameSize(){this.frameWidth=this.sourceVideoElement.videoWidth,this.frameHeight=this.sourceVideoElement.videoHeight}createCanvas(){let e=document.createElement("canvas");return e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="100%",e.style.height="100%",e}constructor(e,t,i){this.videoInitialized=!1,this.active=!1,this.container=e,this.sourceVideoElement=t,this.params=i,this.canvas=this.createCanvas();let s=this.canvas.getContext("webgl");if(!s)throw new Error("Could not initialize WebGL context");this.gl=s,this.container.appendChild(this.canvas),this.camera=new da(this.params.fov,this.params.orientation),this.cameraRotationManager=new la(this.camera,{rotationSpeed:this.params.rotationSpeed,maxYawAngle:this.params.maxYawAngle,rotationSpeedCorrection:this.params.rotationSpeedCorrection,degreeToPixelCorrection:this.params.degreeToPixelCorrection,speedFadeTime:this.params.speedFadeTime,speedFadeThreshold:this.params.speedFadeThreshold}),this.updateFrameSize(),this.vertexBuffer=this.createVertexBuffer(),this.textureMappingBuffer=this.createTextureMappingBuffer(),this.updateTextureMappingBuffer(),this.program=this.createProgram(),this.videoTexture=this.createTexture(),this.gl.useProgram(this.program),this.videoElementDataLoadedFn=this.onDataLoadedHandler.bind(this),this.renderFn=this.render.bind(this)}},pa=(e,t,i)=>i*t+(1-i)*e,fa=(e,t)=>e.reduce(((e,t)=>e+t),0)/t,ma="stalls_manager_metrics",ga="stalls_manager_abr_params",ba="stalls_manager_default_tuning_abr_params",va=class{init(e){this.currentStallDuration$=e.currentStallDuration$,this.videoLastDataObtainedTimestamp$=e.videoLastDataObtainedTimestamp$,this.throughput$=e.throughput$,this.rtt$=e.rtt$,this.tuning=e.tuning,this.abrParams=e.abrParams,this.duration=e.duration,this.resetStoredAbrParamsIfNeeded(),this.subscribe(e)}get videoMaxQualityLimit(){return this.maxQualityLimit}get predictedThroughput(){return this.predictedThroughputWithoutData}get abrTuningParams(){let e=(this.tuning.ignoreDynamicAbrForShortVideo?this.tuning.enabled&&this.duration>this.tuning.minTvtToBeCounted:this.tuning.enabled)?this.getStoredData(ga):{};return{...this.abrParams,...e}}set lastVideoTrackSelected(e){this.lastUniqueVideoTrackSelected?.id!==e.id&&(this.lastUniqueVideoTrackSelected=e,this.lastUniqueVideoTrackSelectedTimestamp=(0,u.tB)(),this.currentStallsCount=0)}destroy(){window.clearTimeout(this.qualityRestrictionTimer),this.subscription.unsubscribe(),0!==this.currentStallDuration$.getValue()&&this.updateStallData();let e=((0,u.tB)()-this.providerStartWatchingTimestamp-this.sumStallsDuration)/1e3,t=this.sumStallsDuration;this.addStallInfoToHistory(e,t),this.updateStoredAbrParams()}resetStoredAbrParamsIfNeeded(){let{bitrateFactorAtEmptyBuffer:e,bitrateFactorAtFullBuffer:t,containerSizeFactor:i}={...this.getStoredData(ba)},{bitrateFactorAtEmptyBuffer:s,bitrateFactorAtFullBuffer:r,containerSizeFactor:a}={...this.abrParams};this.tuning.enabled&&e===s&&t===r&&i===a||(this.removeStoredData(ga),this.setStoredData(ba,{bitrateFactorAtEmptyBuffer:s,bitrateFactorAtFullBuffer:r,containerSizeFactor:a}))}updateStoredAbrParams(){let e=[],t=this.getStoredData(ma,"[]");if(!this.tuning.enabled||t.length<this.tuning.stallsMetricsHistoryLength)return;let i=t.reduce(((e,t)=>e+t.tvt),0);if(this.tuning.useTotalStallsDurationPerTvt){let s=t.reduce(((e,t)=>e+t.stallsDuration),0)/i;e.push(this.calculateOptimalAbrParams(s,i))}if(this.tuning.useAverageStallsDurationPerTvt){let s=t.reduce(((e,t)=>e+t.stallsDurationPerTvt),0)/t.length;e.push(this.calculateOptimalAbrParams(s,i))}this.tuning.useEmaStallsDurationPerTvt&&e.push(this.calculateOptimalAbrParams(t[t.length-1].stallsDurationPerTvtSmoothed,i));let s={bitrateFactorAtEmptyBuffer:Math.max(...e.map((e=>e.bitrateFactorAtEmptyBuffer))),bitrateFactorAtFullBuffer:Math.max(...e.map((e=>e.bitrateFactorAtFullBuffer))),containerSizeFactor:Math.min(...e.map((e=>e.containerSizeFactor)))};this.setStoredData(ma,[]),this.setStoredData(ga,s)}calculateOptimalAbrParams(e,t){let{targetStallsDurationPerTvt:i,deviationStallsDurationPerTvt:s,criticalStallsDurationPerTvt:r,abrAdjustingSpeed:a,significantTvt:n}=this.tuning,o=a*Math.min(t/n,1),u=this.abrTuningParams;return e<i-s?u={bitrateFactorAtEmptyBuffer:Math.max(u.bitrateFactorAtEmptyBuffer-o,this.abrParams.minBitrateFactorAtEmptyBuffer),bitrateFactorAtFullBuffer:Math.max(u.bitrateFactorAtFullBuffer-o,this.abrParams.minBitrateFactorAtFullBuffer),containerSizeFactor:Math.min(u.containerSizeFactor+o,this.abrParams.maxContainerSizeFactor)}:e>i+s&&(u={bitrateFactorAtEmptyBuffer:Math.min(u.bitrateFactorAtEmptyBuffer+o,this.abrParams.maxBitrateFactorAtEmptyBuffer),bitrateFactorAtFullBuffer:Math.min(u.bitrateFactorAtFullBuffer+o,this.abrParams.maxBitrateFactorAtFullBuffer),containerSizeFactor:Math.max(u.containerSizeFactor-o,this.abrParams.minContainerSizeFactor)}),e>r&&(u={bitrateFactorAtEmptyBuffer:Math.max(u.bitrateFactorAtEmptyBuffer,this.abrParams.bitrateFactorAtEmptyBuffer),bitrateFactorAtFullBuffer:Math.max(u.bitrateFactorAtFullBuffer,this.abrParams.bitrateFactorAtFullBuffer),containerSizeFactor:Math.min(u.containerSizeFactor,this.abrParams.containerSizeFactor)}),u}getStoredData(e,t="{}"){return JSON.parse(u.RW.get(e)??t)}setStoredData(e,t){u.RW.set(e,JSON.stringify(t))}removeStoredData(e){u.RW.remove(e)}addStallInfoToHistory(e,t){if(e<this.tuning.minTvtToBeCounted||e>this.tuning.maxTvtToBeCounted||1e3*e<t)return;let i=this.getStoredData(ma,"[]"),s=t/e,r={tvt:e,stallsDuration:t,stallsDurationPerTvt:s,stallsDurationPerTvtSmoothed:i.length?pa(i[i.length-1].stallsDurationPerTvtSmoothed,t/e,this.tuning.emaAlpha):s};i.push(r),i.length>this.tuning.stallsMetricsHistoryLength&&i.shift(),this.setStoredData(ma,i)}updateStallData(){this.providerStartWatchingTimestamp&&!this.isSeeked$.getValue()&&(this.sumStallsDuration+=Math.min(this.lastStallDuration,this.tuning.maxPossibleStallDuration),this.currentStallsCount++)}subscribe(e){this.subscription.add(e.isSeeked$.subscribe(this.isSeeked$)),this.subscription.add(e.isBuffering$.subscribe(this.isBuffering$)),this.subscription.add(e.looped$.subscribe((e=>this.currentStallsCount=0))),this.subscription.add(e.playing$.pipe((0,u.Oo)()).subscribe((e=>this.providerStartWatchingTimestamp=(0,u.tB)()))),this.subscription.add(this.currentStallDuration$.pipe((0,u.jX)()).subscribe((e=>{let{stallDurationNoDataBeforeQualityDecrease:t,stallCountBeforeQualityDecrease:i,resetQualityRestrictionTimeout:s,ignoreStallsOnSeek:r}=this.tuning;if((0,u.wD)(this.lastUniqueVideoTrackSelected)||r&&this.isSeeked$.getValue())return;let a=this.rtt$.getValue(),n=this.throughput$.getValue(),o=this.videoLastDataObtainedTimestamp$.getValue(),h=(0,u.tB)(),d=i&&this.currentStallsCount>=i,l=t&&h-this.lastUniqueVideoTrackSelectedTimestamp>=t+a&&h-o>=t+a&&e>=t;(d||l)&&(this.severeStallOccurred$.next(!0),window.clearTimeout(this.qualityRestrictionTimer),this.maxQualityLimit=this.lastUniqueVideoTrackSelected.quality,(0,u.R)(this.lastUniqueVideoTrackSelected.bitrate)&&n>this.lastUniqueVideoTrackSelected.bitrate&&(this.predictedThroughputWithoutData=this.lastUniqueVideoTrackSelected.bitrate)),!e&&(0,u.tB)()-this.providerStartWatchingTimestamp>this.lastStallDuration&&(this.updateStallData(),this.severeStallOccurred$.next(!1),window.clearTimeout(this.qualityRestrictionTimer),this.qualityRestrictionTimer=window.setTimeout((()=>{this.maxQualityLimit=void 0,this.predictedThroughputWithoutData=0}),s)),this.lastStallDuration=e})))}constructor(){this.isSeeked$=new u.Ot(!1),this.isBuffering$=new u.Ot(!1),this.maxQualityLimit=void 0,this.currentStallsCount=0,this.sumStallsDuration=0,this.lastStallDuration=0,this.providerStartWatchingTimestamp=0,this.lastUniqueVideoTrackSelectedTimestamp=0,this.predictedThroughputWithoutData=0,this.subscription=new u.yU,this.severeStallOccurred$=new u.Ot(!1)}},ya=class{connect({observableVideo:e,video:t}){let i=e=>{let t=e.target;this.pipSize$.next({width:t.width,height:t.height})};this.subscription.add((0,u.qi)(t).subscribe(this.videoSize$)).add(e.enterPip$.subscribe((({pictureInPictureWindow:e})=>{this.pipSize$.next({width:e.width,height:e.height}),e.addEventListener("resize",i),this.pictureInPictureWindowRemoveEventListener=()=>{e.removeEventListener("resize",i)}}))).add(e.leavePip$.subscribe((()=>{this.pictureInPictureWindowRemoveEventListener()}))).add((0,u.kg)({videoSize:this.videoSize$,pipSize:this.pipSize$,inPip:e.inPiP$}).pipe((0,u.Tj)((({videoSize:e,inPip:t,pipSize:i})=>t?i:e))).subscribe(this.elementSize$))}getValue(){return this.elementSize$.getValue()}subscribe(e,t){return this.elementSize$.subscribe(e,t)}getObservable(){return this.elementSize$}destroy(){this.pictureInPictureWindowRemoveEventListener(),this.subscription.unsubscribe()}constructor(){this.subscription=new u.yU,this.pipSize$=new u.Ot(void 0),this.videoSize$=new u.Ot(void 0),this.elementSize$=new u.Ot(void 0),this.pictureInPictureWindowRemoveEventListener=u.lQ}},Sa=({subscription:e,desiredState:t,videoElement$:i,observableVideo:s})=>{if(!ks.browser.isSafari)return;let r=0,a=!1;e.add(t.volume.stateChangeStarted$.pipe((0,u.Tj)((()=>{let e=t.volume.getTransition(),s=i.getValue();return!(!s||!e)&&(!e.to.muted&&s.muted)})),(0,u.pb)((e=>!!e)),(0,u.Oo)()).subscribe((()=>{r=performance.now(),a=!0}))),e.add(s.playbackRateState$.pipe((0,u.pb)((()=>a)),(0,u.Oo)()).subscribe((()=>{let e=i.getValue(),s=t.playbackRate.getState();e&&s!==e.playbackRate&&performance.now()-r<1e3&&(e.playbackRate=s)})))},wa=class{getProviderSubscriptionInfo(){let{output:e,desiredState:t}=this.params;(0,u.wD)(this.observableVideo)&&(this.observableVideo=er(this.video),this.subscription.add((()=>this.observableVideo?.destroy())));let i=this.constructor.name,s=t=>{e.error$.next({id:i,category:u.h.WTF,message:`${i} internal logic error`,thrown:t})};return{output:e,desiredState:t,observableVideo:this.observableVideo,genericErrorListener:s,connect:(e,t)=>this.subscription.add(e.subscribe(t,s))}}subscribe(){let{output:e,desiredState:t,observableVideo:i,genericErrorListener:s,connect:r}=this.getProviderSubscriptionInfo();this.subscription.add(this.params.output.availableVideoTracks$.pipe((0,u.pb)((e=>!!e.length)),(0,u.Oo)()).subscribe((e=>{this.droppedFramesManager.connect({logger:this.params.dependencies.logger,video:this.video,droppedFramesChecker:this.params.tuning.droppedFramesChecker,isAuto:this.params.desiredState.autoVideoTrackSwitching,playing$:i.playing$,pause$:i.pause$,tracks:e})})));let a=this.params.desiredState.seekState.stateChangeEnded$.pipe((0,u.Tj)((e=>"none"!==e.to.state)),(0,u.jX)());this.stallsManager.init({isSeeked$:a,currentStallDuration$:this.player.currentStallDuration$,videoLastDataObtainedTimestamp$:this.player.videoLastDataObtainedTimestamp$,throughput$:this.params.dependencies.throughputEstimator.throughput$,rtt$:this.params.dependencies.throughputEstimator.rtt$,tuning:this.params.tuning.stallsManager,abrParams:this.params.tuning.autoTrackSelection,isBuffering$:i.isBuffering$,looped$:i.looped$,playing$:i.playing$,duration:this.video.duration}),r(i.ended$,e.endedEvent$),r(i.looped$,e.loopedEvent$),r(i.error$,e.error$),r(i.isBuffering$,e.isBuffering$),r(i.currentBuffer$,e.currentNativeBuffer$),r(i.playing$,e.firstFrameEvent$),r(i.canplay$,e.canplay$),r(i.inPiP$,e.inPiP$),r(i.inFullscreen$,e.inFullscreen$),r(i.loadedMetadata$,e.loadedMetadataEvent$),r(this.player.error$,e.error$),r(this.player.fetcherRecoverableError$,e.fetcherRecoverableError$),r(this.player.fetcherError$,e.fetcherError$),r(this.player.lastConnectionType$,e.httpConnectionType$),r(this.player.lastConnectionReused$,e.httpConnectionReused$),r(this.player.isLive$,e.isLive$),r(this.player.currentBuffer$,e.currentBuffer$),r(this.player.lastRequestFirstBytes$.pipe((0,u.pb)(u.R),(0,u.Oo)()),e.firstBytesEvent$),r(this.stallsManager.severeStallOccurred$,e.severeStallOccurred$),r(this.videoState.stateChangeEnded$.pipe((0,u.Tj)((e=>e.to))),this.params.output.playbackState$),this.subscription.add(i.looped$.subscribe((()=>this.player.warmUpMediaSourceIfNeeded()),s)),this.subscription.add(i.seeked$.subscribe(e.seekedEvent$,s)),this.subscription.add(Hs(this.video,t.isLooped,s)),this.subscription.add(i.volumeState$.subscribe(this.params.output.volume$,s)),Sa({subscription:this.subscription,desiredState:t,videoElement$:this.params.output.element$,observableVideo:i}),this.subscription.add(Ws(this.video,t.volume,i.volumeState$,s)),this.subscription.add(Qs(this.video,t.playbackRate,i.playbackRateState$,s)),this.elementSizeManager.connect({video:this.video,observableVideo:i}),r(Kr(this.video,{threshold:this.params.tuning.autoTrackSelection.activeVideoAreaThreshold}),e.elementVisible$),this.subscription.add(i.playing$.subscribe((()=>{this.videoState.setState("playing"),us(t.playbackState,"playing"),this.scene3D&&this.scene3D.play()}),s)).add(i.pause$.subscribe((()=>{this.videoState.setState("paused"),us(t.playbackState,"paused")}),s)).add(i.canplay$.subscribe((()=>{"playing"===this.videoState.getState()&&this.playIfAllowed()}),s)),this.params.tuning.changePlaybackStateToPausedWhenEnded&&this.subscription.add(i.ended$.subscribe((()=>{this.videoState.setState("paused"),us(t.playbackState,"paused")}))),this.subscription.add(this.player.manifestRequested.subscribe(this.params.output.manifestRequested$)).add(this.player.manifestReceived.subscribe(this.params.output.manifestReceived$)).add(this.player.firstBytesRequested.subscribe(this.params.output.firstBytesRequested$)).add(this.player.firstBytesReceived.subscribe(this.params.output.firstBytesReceived$)),this.subscription.add(this.player.state$.stateChangeEnded$.subscribe((({to:e})=>{if("manifest_ready"===e){this.videoTracksMap=new Map,this.audioTracksMap=new Map,this.textTracksMap=new Map;let e=this.player.getStreams(),t=this.player.getCodecs();if((0,u.tZ)(e,"Manifest not loaded or empty"),!this.params.tuning.isAudioDisabled){let t=[];for(let i of e.audio){t.push(oa(i));let e=[];for(let t of i.representations){let s=aa(t);e.push(s),this.audioTracksMap.set(s,{stream:i,representation:t})}this.audioStreamsMap.set(i,e)}this.params.output.availableAudioStreams$.next(t)}let i=[];for(let t of e.video){i.push(ua(t));let e=[];for(let i of t.representations){let s=ra({...i,streamId:t.id});s&&(e.push(s),this.videoTracksMap.set(s,{stream:t,representation:i}))}this.videoStreamsMap.set(t,e)}this.params.output.availableVideoStreams$.next(i);for(let t of e.text)for(let e of t.representations){let i=na(t,e);this.textTracksMap.set(i,{stream:t,representation:e})}this.params.output.availableVideoTracks$.next(Array.from(this.videoTracksMap.keys())),this.params.output.availableAudioTracks$.next(Array.from(this.audioTracksMap.keys())),this.params.output.isAudioAvailable$.next(!!this.audioTracksMap.size),t?.video&&this.params.output.availableVideoCodecs$.next(t.video),t?.audio&&this.params.output.availableAudioCodecs$.next(t.audio),this.audioTracksMap.size&&this.textTracksMap.size&&this.params.desiredState.internalTextTracks.startTransitionTo(Array.from(this.textTracksMap.keys()))}else"representations_ready"===e&&(this.videoState.setState("ready"),this.player.initBuffer())}),s));let n=(0,u.h1)(this.player.currentStallDuration$,this.player.state$.stateChangeEnded$,t.videoTrack.stateChangeStarted$,t.autoVideoTrackSwitching.transitionStarted$,this.params.dependencies.throughputEstimator.rttAdjustedThroughput$,t.autoVideoTrackLimits.stateChangeStarted$,this.elementSizeManager.getObservable(),this.params.output.elementVisible$,this.droppedFramesManager.onDroopedVideoFramesLimit$,(0,u.Rt)(this.video,"progress")).pipe((0,u.pb)((()=>this.videoTracksMap.size>0))),{abrThrottle:o}=this.params.tuning.dash;o&&(n=n.pipe((0,u.nF)(o))),this.subscription.add(n.subscribe((async()=>{let e=this.player.state$.getState(),i=this.player.state$.getTransition(),s=t.autoVideoTrackSwitching.getState();if("manifest_ready"!==e&&"running"!==e||i)return;t.autoVideoTrackSwitching.getTransition()&&t.autoVideoTrackSwitching.setState(t.autoVideoTrackSwitching.getState());let r=this.selectVideoAudioRepresentations();if(!r)return;let[a,n]=r,o=[...this.videoTracksMap.keys()].find((e=>this.videoTracksMap.get(e)?.representation.id===a.id));(0,u.R)(o)&&(this.stallsManager.lastVideoTrackSelected=o);let h=this.params.desiredState.autoVideoTrackLimits.getTransition();h&&this.params.output.autoVideoTrackLimits$.next(h.to),"manifest_ready"===e?await this.player.initRepresentations(a.id,n?.id,this.params.sourceHls):(await this.player.switchRepresentation("video",a.id,s),n&&await this.player.switchRepresentation("audio",n.id,s))}),s)),this.subscription.add(t.cameraOrientation.stateChangeEnded$.subscribe((({to:e})=>{this.scene3D&&e&&this.scene3D.pointCameraTo(e.x,e.y)}))),this.subscription.add(this.elementSizeManager.subscribe((e=>{this.scene3D&&e&&this.scene3D.setViewportSize(e.width,e.height)}))),this.subscription.add(this.player.currentAudioRepresentation$.pipe((0,u.jX)()).subscribe((t=>{let i=[...this.audioTracksMap.entries()].find((([,{representation:e}])=>e.id===t));if(!i)return void e.currentAudioStream$.next(void 0);let[s,{stream:r}]=i,a=this.params.desiredState.audioStream.getTransition();a&&a.to&&a.to.id===r.id&&this.params.desiredState.audioStream.setState(a.to),e.currentAudioStream$.next(oa(r))}),s)),this.subscription.add(this.player.currentVideoRepresentationInit$.subscribe((t=>{if(t?.is3dVideo&&this.params.tuning.spherical?.enabled)try{this.init3DScene(t),e.is3DVideo$.next(!0)}catch(t){e.warning$.next({id:"DashProvider",message:`DashProvider could not initialize 3D-scene: ${t}`})}else this.destroy3DScene(),this.params.tuning.spherical?.enabled&&e.is3DVideo$.next(!1)}),s)),this.subscription.add(this.player.currentVideoSegmentLength$.subscribe(e.currentVideoSegmentLength$,s)),this.subscription.add(this.player.currentAudioSegmentLength$.subscribe(e.currentAudioSegmentLength$,s)),this.textTracksManager.connect(this.video,t,e);let h=t.playbackState.stateChangeStarted$.pipe((0,u.Tj)((({to:e})=>"ready"===e)),(0,u.jX)());this.subscription.add((0,u.h1)(h,t.autoVideoTrackSwitching.stateChangeStarted$,this.player.state$.stateChangeEnded$,(0,u.Ss)(["init"])).subscribe((()=>{let e=t.autoVideoTrackSwitching.getState(),i="ready"===t.playbackState.getState()?this.params.tuning.dash.forwardBufferTargetPreload:e?this.params.tuning.dash.forwardBufferTargetAuto:this.params.tuning.dash.forwardBufferTargetManual;this.player.setBufferTarget(i)}))),this.subscription.add((0,u.h1)(h,this.player.state$.stateChangeEnded$,(0,u.Ss)(["init"])).subscribe((()=>this.player.setPreloadOnly("ready"===t.playbackState.getState()))));let d=(0,u.h1)(t.playbackState.stateChangeStarted$,t.videoTrack.stateChangeStarted$,t.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,(0,u.Ss)(["init"])).pipe((0,u.sg)(0));this.subscription.add(d.subscribe(this.syncPlayback,s))}selectVideoAudioRepresentations(){if(this.player.isStreamEnded)return;let e=this.params.tuning.useNewAutoSelectVideoTrack?wr:Sr,t=this.params.tuning.useNewAutoSelectVideoTrack?Br:Er,i=this.params.tuning.useNewAutoSelectVideoTrack?Lr:Rr,{desiredState:s,output:r}=this.params,a=s.autoVideoTrackSwitching.getState(),n=s.videoTrack.getState()?.id,o=[...this.videoTracksMap.keys()].find((({id:e})=>e===n)),u=r.currentVideoTrack$.getValue(),h=s.videoStream.getState()??(o&&this.videoTracksMap.get(o)?.stream)??1===this.videoStreamsMap.size?this.videoStreamsMap.keys().next().value:void 0;if(!h)return;let d=[...this.videoStreamsMap.keys()].find((({id:e})=>e===h.id)),l=d&&this.videoStreamsMap.get(d);if(!l)return;let c,p=this.player.bufferLength$.getValue();c=this.player.isActiveLive$.getValue()?this.player.isLowLatency$.getValue()?this.params.tuning.dashCmafLive.lowLatency.maxTargetOffset:this.params.tuning.dashCmafLive.normalizedLiveMinBufferSize:this.player.isLive$.getValue()?this.params.tuning.dashCmafLive.normalizedTargetMinBufferSize:a?this.params.tuning.dash.forwardBufferTargetAuto:this.params.tuning.dash.forwardBufferTargetManual;let f=(1e3*this.video.duration||1/0)-1e3*this.video.currentTime,m=Math.min(p/Math.min(c,f||1/0),1),g=s.audioStream.getState()??(1===this.audioStreamsMap.size?this.audioStreamsMap.keys().next().value:void 0),b=[...this.audioStreamsMap.keys()].find((({id:e})=>e===g?.id))??this.audioStreamsMap.keys().next().value,v=0;if(b){if(o&&!a){let t=e(o,l,this.audioStreamsMap.get(b)??[],this.params.tuning.autoTrackSelection.minVideoAudioRatio);v=Math.max(v,t?.bitrate??-1/0)}if(u){let t=e(u,l,this.audioStreamsMap.get(b)??[],this.params.tuning.autoTrackSelection.minVideoAudioRatio);v=Math.max(v,t?.bitrate??-1/0)}}let y=o;(a||!y)&&(y=i(l,{container:this.elementSizeManager.getValue(),panelSize:this.params.panelSize,estimatedThroughput:this.params.dependencies.throughputEstimator.rttAdjustedThroughput$.getValue(),tuning:this.stallsManager.abrTuningParams,limits:this.params.desiredState.autoVideoTrackLimits.getState(),reserve:v,forwardBufferHealth:m,current:u,visible:this.params.output.elementVisible$.getValue(),history:this.videoTrackSwitchHistory,playbackRate:this.video.playbackRate,droppedVideoMaxQualityLimit:this.droppedFramesManager.droppedVideoMaxQualityLimit,stallsVideoMaxQualityLimit:this.stallsManager.videoMaxQualityLimit,stallsPredictedThroughput:this.stallsManager.predictedThroughput,abrLogger:this.params.dependencies.abrLogger}));let S=b&&t(y,l,this.audioStreamsMap.get(b)??[],{estimatedThroughput:this.params.dependencies.throughputEstimator.rttAdjustedThroughput$.getValue(),stallsPredictedThroughput:this.stallsManager.predictedThroughput,tuning:this.stallsManager.abrTuningParams,forwardBufferHealth:m,history:this.audioTrackSwitchHistory,playbackRate:this.video.playbackRate,abrLogger:this.params.dependencies.abrLogger}),w=this.videoTracksMap.get(y)?.representation,T=S&&this.audioTracksMap.get(S)?.representation;return w&&T?[w,T]:w&&!T&&0===this.audioTracksMap.size?[w,void 0]:void 0}prepare(e=0){this.player.initManifest(this.video,this.params.source.url,e)}playIfAllowed(){Dr(this.video,(()=>{this.params.output.soundProhibitedEvent$.next()})).then((e=>{e||(this.videoState.setState("paused"),us(this.params.desiredState.playbackState,"paused",!0))}),(e=>this.params.output.error$.next({id:"ForcePlay",message:"play() failed even with workarounds",category:u.h.DOM,thrown:e})))}destroy(){this.subscription.unsubscribe(),this.droppedFramesManager.destroy(),this.stallsManager.destroy(),this.elementSizeManager.destroy(),this.destroy3DScene(),this.textTracksManager.destroy(),this.player.destroy(),this.params.output.element$.next(void 0),this.params.output.currentVideoStream$.next(void 0),js(this.video),this.tracer.end()}constructor(e){this.subscription=new u.yU,this.videoState=new Ps("stopped"),this.observableVideo=null,this.droppedFramesManager=new Yr,this.stallsManager=new va,this.elementSizeManager=new ya,this.videoTracksMap=new Map,this.audioTracksMap=new Map,this.textTracksMap=new Map,this.videoStreamsMap=new Map,this.audioStreamsMap=new Map,this.videoTrackSwitchHistory=new mr,this.audioTrackSwitchHistory=new mr,this.syncPlayback=()=>{let e=this.videoState.getState(),t=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition(),s=this.params.desiredState.seekState.getState();if(!this.videoState.getTransition()){if("requested"===s.state&&"paused"!==i?.to&&"stopped"!==e&&"stopped"!==t&&this.seek(s.position,s.forcePrecise),"stopped"===t)return void("stopped"!==e&&(this.videoState.startTransitionTo("stopped"),this.player.stop(),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.currentNativeBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState("stopped"),us(this.params.desiredState.playbackState,"stopped",!0)));switch(e){case"stopped":return this.videoState.startTransitionTo("ready"),void this.prepare();case"ready":return void("paused"===t?(this.videoState.setState("paused"),us(this.params.desiredState.playbackState,"paused")):"playing"===t?(this.videoState.startTransitionTo("playing"),this.playIfAllowed()):"ready"===i?.to&&us(this.params.desiredState.playbackState,"ready"));case"playing":return void("paused"===t?(this.videoState.startTransitionTo("paused"),this.video.paused?this.videoState.setState("paused"):this.video.pause()):"playing"===t&&this.video.paused?this.playIfAllowed():"playing"===i?.to&&us(this.params.desiredState.playbackState,"playing"));case"paused":return void("playing"===t?(this.videoState.startTransitionTo("playing"),this.playIfAllowed()):"paused"===i?.to&&us(this.params.desiredState.playbackState,"paused"));default:return(0,u.xb)(e)}}},this.init3DScene=e=>{if(this.scene3D)return;this.scene3D=new ca(this.params.container,this.video,{fov:this.params.tuning.spherical.fov,orientation:this.params.tuning.spherical.orientation||{x:e.projectionData?.pose.yaw||0,y:e.projectionData?.pose.pitch||0,z:e.projectionData?.pose.roll||0},rotationSpeed:this.params.tuning.spherical.rotationSpeed,maxYawAngle:this.params.tuning.spherical.maxYawAngle,rotationSpeedCorrection:this.params.tuning.spherical.rotationSpeedCorrection,degreeToPixelCorrection:this.params.tuning.spherical.degreeToPixelCorrection,speedFadeTime:this.params.tuning.spherical.speedFadeTime,speedFadeThreshold:this.params.tuning.spherical.speedFadeThreshold});let t=this.elementSizeManager.getValue();t&&this.scene3D.setViewportSize(t.width,t.height)},this.destroy3DScene=()=>{this.scene3D&&(this.scene3D.destroy(),this.scene3D=void 0)},this.textTracksManager=new Zs(e.source.url),this.params=e,this.video=Us(e.container,e.tuning),this.tracer=e.dependencies.tracer.createComponentTracer(this.constructor.name),this.params.output.element$.next(this.video),this.params.output.availableVideoTracks$.next([]),this.params.output.availableAudioTracks$.next([]),this.params.output.isAudioAvailable$.next(!0),this.params.output.hostname$.next(Ar(this.params.source.url)),this.params.output.isLive$.next(!1),this.params.output.autoVideoTrackLimitingAvailable$.next(!0),this.params.output.availableTextTracks$.next([]),this.params.desiredState.internalTextTracks.setState([]),this.player=this.getPlayer(),this.subscribe()}},Ta=g(gi(),1),{NativeAbortSignal:$a,NativeAbortController:xa}={NativeAbortSignal:(zr=typeof self<"u"?self:global).AbortSignal,NativeAbortController:zr.AbortController};var ka=class{addEventListener(e,t,i){e in this.listeners||(this.listeners[e]=[]),this.listeners[e].push({callback:t,options:i})}removeEventListener(e,t){if(!(e in this.listeners))return;let i=this.listeners[e];for(let e=0,s=i.length;e<s;e++)if(i[e].callback===t)return void i.splice(e,1)}dispatchEvent(e){if(!(e.type in this.listeners))return;let t=this.listeners[e.type].slice();for(let i=0,s=t.length;i<s;i++){let s=t[i];try{s.callback.call(this,e)}catch(e){Promise.resolve().then((()=>{throw e}))}s.options&&s.options.once&&this.removeEventListener(e.type,s.callback)}return!e.defaultPrevented}constructor(){Object.defineProperty(this,"listeners",{value:{},writable:!0,configurable:!0})}},La=class extends ka{toString(){return"[object AbortSignal]"}dispatchEvent(e){"abort"===e.type&&(this.aborted=!0,"function"==typeof this.onabort&&this.onabort.call(this,e)),super.dispatchEvent(e)}throwIfAborted(){let{aborted:e,reason:t="Aborted"}=this;if(e)throw t}static timeout(e){let t=new Ra;return setTimeout((()=>t.abort(new DOMException(`This signal is timeout in ${e}ms`,"TimeoutError"))),e),t.signal}static any(e){let t=new Ra;function i(){t.abort(this.reason),function(){for(let t of e)t.removeEventListener("abort",i)}()}for(let s of e){if(s.aborted){t.abort(s.reason);break}s.addEventListener("abort",i)}return t.signal}constructor(){super(),this.listeners||ka.call(this),Object.defineProperty(this,"aborted",{value:!1,writable:!0,configurable:!0}),Object.defineProperty(this,"onabort",{value:null,writable:!0,configurable:!0}),Object.defineProperty(this,"reason",{value:void 0,writable:!0,configurable:!0})}},Ra=class{abort(e){let t=function(e){if(void 0===e)if(typeof document>"u")(e=new Error("This operation was aborted")).name="AbortError";else try{e=new DOMException("signal is aborted without reason"),Object.defineProperty(e,"name",{value:"AbortError"})}catch{(e=new Error("This operation was aborted")).name="AbortError"}return e}(e),i=function(e){let t;try{t=new Event("abort")}catch{typeof document<"u"?document.createEvent?(t=document.createEvent("Event"),t.initEvent("abort",!1,!1)):(t=document.createEventObject(),t.type="abort"):t={type:"abort",bubbles:!1,cancelable:!1}}return t.reason=e,t}(t);this.signal.reason=t,this.signal.dispatchEvent(i)}toString(){return"[object AbortController]"}constructor(){Object.defineProperty(this,"signal",{value:new La,writable:!0,configurable:!0})}};function Ea(e){return e.__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL?(console.log("__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL=true is set, will force install polyfill"),!0):"function"==typeof e.Request&&!e.Request.prototype.hasOwnProperty("signal")||!e.AbortController}typeof Symbol<"u"&&Symbol.toStringTag&&(Ra.prototype[Symbol.toStringTag]="AbortController",La.prototype[Symbol.toStringTag]="AbortSignal");var Ba="fetch"in window&&Ea({fetch:window.fetch,Request:window.Request,AbortController:window.AbortController}),Aa=Ba?function(e){"function"==typeof e&&(e={fetch:e});let{fetch:t,Request:i=t.Request,AbortController:s,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:r=!1}=e;if(!Ea({fetch:t,Request:i,AbortController:s,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:r}))return{fetch:t,Request:a};let a=i;(a&&!a.prototype.hasOwnProperty("signal")||r)&&(a=function(e,t){let s;t&&t.signal&&(s=t.signal,delete t.signal);let r=new i(e,t);return s&&Object.defineProperty(r,"signal",{writable:!1,enumerable:!1,configurable:!0,value:s}),r},a.prototype=i.prototype);let n=t;return{fetch:(e,t)=>{let i=a&&a.prototype.isPrototypeOf(e)?e.signal:t?t.signal:void 0;if(i){let s;try{s=new DOMException("Aborted","AbortError")}catch{s=new Error("Aborted"),s.name="AbortError"}if(i.aborted)return Promise.reject(s);let r=new Promise(((e,t)=>{i.addEventListener("abort",(()=>t(s)),{once:!0})}));return t&&t.signal&&delete t.signal,Promise.race([r,n(e,t)])}return n(e,t)},Request:a}}({fetch:window.fetch,Request:window.Request,AbortController:window.AbortController}):void 0,Ma=Ba?Aa.fetch:window.fetch,Ca=(Ba?Aa.Request:window.Request,Ba?Ra:window.AbortController),Ia=(Ba||window.AbortSignal,g(Oe(),1)),Da=g(Li(),1),Oa=e=>{if(!e)return{id:"EmptyResponse",category:u.h.PARSER,message:"Empty response"};if(e.length<=2&&e.match(/^\d+$/))return{id:`UVError#${e}`,category:u.h.NETWORK,message:`UV Error ${e}`};let t=(0,Da.default)(e).substring(0,100).toLowerCase();return t.startsWith("<!doctype")||t.startsWith("<html>")||t.startsWith("<body>")||t.startsWith("<head>")?{id:"UnexpectedHTML",category:u.h.NETWORK,message:"Received unexpected HTML, possibly a ISP block"}:t.startsWith("<?xml")?(new DOMParser).parseFromString(e,"text/xml").querySelector("parsererror")?{id:"InvalidXML",category:u.h.PARSER,message:"XML parsing error"}:{id:"XMLParserLogicError",category:u.h.PARSER,message:"Response is valid XML, but parser failed"}:void 0},Pa=e=>{let t=new URL(e);return t.searchParams.set("quic","1"),t.toString()},Va=e=>{let t=e.get("X-Delivery-Type"),i=e.get("X-Reused");return{type:null===t?"http1":t??void 0,reused:null===i?void 0:{1:!0,0:!1}[i]??void 0}},_a=e=>e instanceof DOMException&&("AbortError"===e.name||20===e.code),Fa=e=>{let t=new URL(e);return t.searchParams.set("enable-subtitles","yes"),t.toString()},Na=class{onHeadersReceived(e){let{type:t,reused:i}=Va(e);this.lastConnectionType$.next(t),this.lastConnectionReused$.next(i)}async fetchRepresentation(e,t,i="auto"){let{type:s}=e;switch(s){case"byteRange":return this.fetchByteRangeRepresentation(e,t,i)??null;case"template":return this.fetchTemplateRepresentation(e,i)??null;default:(0,u.xb)(s)}}destroy(){this.abortAllController.abort(),this.subscription.unsubscribe(),this.tracer.end()}async doFetch(e,t){let i=await Ma(e,t);if(i.ok)return i;let s=await i.text(),r=parseInt(s);if(!isNaN(r))switch(r){case 1:this.recoverableError$.next({id:"VideoDataLinkExpiredError",message:"Video data links have expired",category:u.h.FATAL});break;case 8:this.recoverableError$.next({id:"VideoDataLinkBlockedForFloodError",message:"Url blocked for flood",category:u.h.FATAL});break;case 18:this.recoverableError$.next({id:"VideoDataLinkIllegalIpChangeError",message:"Client IP has changed",category:u.h.FATAL});break;case 21:this.recoverableError$.next({id:"VideoDataLinkIllegalHostChangeError",message:"Request HOST has changed",category:u.h.FATAL});break;default:this.error$.next({id:"GeneralVideoDataFetchError",message:`Generic video data fetch error (${r})`,category:u.h.FATAL})}}constructor({throughputEstimator:e,requestQuic:t,tracer:i,compatibilityMode:s=!1,useEnableSubtitlesParam:r=!1}){this.manifestRequested=new u.B7,this.manifestReceived=new u.B7,this.firstBytesRequested=new u.B7,this.firstBytesReceived=new u.B7,this.lastConnectionType$=new u.Ot(void 0),this.lastConnectionReused$=new u.Ot(void 0),this.lastRequestFirstBytes$=new u.Ot(void 0),this.recoverableError$=new u.B7,this.error$=new u.B7,this.abortAllController=new Ca,this.subscription=new u.yU,this.fetchManifest=(0,u.ZC)(this.abortAllController.signal,async function*(e){let t=this.tracer.createComponentTracer("FetchManifest"),i=e;this.requestQuic&&(i=Pa(i)),!this.compatibilityMode&&this.useEnableSubtitlesParam&&(i=Fa(i)),this.manifestRequested.next();let s=yield this.doFetch(i,{signal:this.abortAllController.signal}).catch(Ua);return s?(t.log("success",(0,u.YO)({url:i,message:"Request successfully executed"})),t.end(),this.manifestReceived.next(),this.onHeadersReceived(s.headers),s.text()):(t.error("error",(0,u.YO)({url:i,message:"No data in request manifest"})),t.end(),null)}.bind(this)),this.fetch=(0,u.ZC)(this.abortAllController.signal,async function*(e,{rangeMethod:t=(this.compatibilityMode?0:1),range:i,onProgress:s,priority:r="auto",signal:a,measureThroughput:n=!0,isLowLatency:o=!1,bufferOptimisation:h=!1}={}){let d=e,l=new Headers,c=this.tracer.createComponentTracer("Fetch");if(i)switch(t){case 0:l.append("Range",`bytes=${i.from}-${i.to}`);break;case 1:{let e=new URL(d,location.href);e.searchParams.append("bytes",`${i.from}-${i.to}`),d=e.toString();break}default:(0,u.xb)(t)}this.requestQuic&&(d=Pa(d));let p,f=this.abortAllController.signal;if(a){let e=new Ca;if(p=(0,u.h1)((0,u.Rt)(this.abortAllController.signal,"abort"),(0,u.Rt)(a,"abort")).subscribe((()=>{try{e.abort()}catch(e){Ua(e)}})),this.subscription.add(p),this.abortAllController.signal.aborted||a.aborted)try{e.abort()}catch(e){Ua(e)}f=e.signal}let m=0,g=(0,u.tB)();c.log("startRequest",(0,u.YO)({url:d,priority:r,rangeMethod:t,range:i,isLowLatency:o,requestStartedAt:g})),this.firstBytesRequested.next();let b=yield this.doFetch(d,{priority:r,headers:l,signal:f}),v=(0,u.tB)();if(!b)return c.error("error",{message:"No response in request"}),c.end(),p?.unsubscribe(),null;if(this.throughputEstimator?.addRawRtt(v-g),!b.ok||!b.body){p?.unsubscribe();let e=`Fetch error ${b.status}: ${b.statusText}`;return c.error("error",{message:e}),c.end(),Promise.reject(new Error(`Fetch error ${b.status}: ${b.statusText}`))}if(this.onHeadersReceived(b.headers),!s&&!n){p?.unsubscribe();let e=(0,u.tB)(),t={requestStartedAt:g,requestEndedAt:e,duration:e-g};return c.log("endRequest",(0,u.YO)(t)),c.end(),b.arrayBuffer()}let y=b.body;if(n){let e;[y,e]=b.body.tee(),this.throughputEstimator?.trackStream(e,o)}let S,w=y.getReader(),T=parseInt(b.headers.get("content-length")??"",10);Number.isFinite(T)&&(S=T),!S&&i&&(S=i.to-i.from+1);let $=S?new Uint8Array(S):new Uint8Array(0),x=!1,k=e=>{p?.unsubscribe(),x=!0,Ua(e)},L=(0,u.ZC)(f,async function*({done:e,value:t}){if(0===m&&(this.lastRequestFirstBytes$.next((0,u.tB)()-g),this.firstBytesReceived.next()),f.aborted)p?.unsubscribe();else if(!e&&t){if(h&&S)$.set(t,m),m+=t.byteLength;else{let e=new Uint8Array($.length+t.length);e.set($),e.set(t,$.length),$=e,m+=t.byteLength}s?.(new DataView($.buffer),m),yield w?.read().then(L,k)}}.bind(this));yield w?.read().then(L,k),p?.unsubscribe();let R=(0,u.tB)(),E={failed:x,requestStartedAt:g,requestEndedAt:R,duration:R-g};return x?(c.error("endRequest",(0,u.YO)(E)),c.end(),null):(c.log("endRequest",(0,u.YO)(E)),c.end(),$.buffer)}.bind(this)),this.fetchByteRangeRepresentation=(0,u.ZC)(this.abortAllController.signal,async function*(e,t,i){if("byteRange"!==e.type)return null;let s,r,{from:a,to:n}=e.initRange,o=a,u=n,h=!1;e.indexRange&&(s=e.indexRange.from,r=e.indexRange.to,h=n+1===s,h&&(o=Math.min(s,a),u=Math.max(r,n))),o=Math.min(o,0);let d=yield this.fetch(e.url,{range:{from:o,to:u},priority:i,measureThroughput:!1});if(!d)return null;let l=new DataView(d,a-o,n-o+1);if(!t.validateData(l))throw new Error("Invalid media file");let c,p=t.parseInit(l),f=e.indexRange??t.getIndexRange(p);if(!f)throw new ReferenceError("No way to load representation index");if(h)c=new DataView(d,f.from-o,f.to-f.from+1);else{let t=yield this.fetch(e.url,{range:f,priority:i,measureThroughput:!1});if(!t)return null;c=new DataView(t)}let m=t.parseSegments(c,p,f).map((e=>({networkStatus:"none",bufferStatus:"none",status:"none",time:e.time,byte:e.byte})));return{initMetadata:p,initDataView:new DataView(d),segments:m}}.bind(this)),this.fetchTemplateRepresentation=(0,u.ZC)(this.abortAllController.signal,async function*(e,t){if("template"!==e.type)return null;let i=new URL(e.initUrl,e.baseUrl).toString(),s=yield this.fetch(i,{priority:t,measureThroughput:!1});if(!s)return null;let r=e.segments.map((e=>({...e,networkStatus:"none",bufferStatus:"none",status:"none",size:void 0})));return{initMetadata:null,initDataView:new DataView(s),segments:r}}.bind(this)),this.throughputEstimator=e,this.requestQuic=t,this.compatibilityMode=s,this.tracer=i.createComponentTracer("Fetcher"),this.useEnableSubtitlesParam=r}},Ua=e=>{if(!_a(e))throw e},ja=g(Vi(),1),qa=g(Fe(),1),za=g(zi(),1),Ha=g(ni(),1),Wa=g(Be(),1),Qa=g(Oe(),1),Xa=e=>{let t=e.split("."),[i,...s]=t;if(!i)return!1;switch(i){case"av01":{let[e,t,i]=s;return!!(i&&parseInt(i,10)>8)}case"vp09":{let[e,t,i]=s;return!!(e&&parseInt(e,10)>=2&&i&&parseInt(i,10)>8)}case"avc1":{let e=s[0];if(!e||6!==e.length)return!1;let[t,i]=e.toUpperCase(),r=t+i;return(0,Qa.default)(["6E","7A","F4"],r)}}return!1},Ga=e=>{if(e.includes("/")){let t=e.split("/");return parseInt(t[0])/parseInt(t[1])}return parseFloat(e)},Za=e=>{try{let t=function(){let e="(?<extlang>(?:[a-z]{3}(?:-[a-z]{3}){0,2}))",t="x(?:-[a-z0-9]{1,8})+",i=`^(?:(?<langtag>\n    (?<language>(?:[a-z]{2,3}(?:-${e})?|[a-z]{4}|[a-z]{5,8}))\n    (-(?<script>[a-z]{4}))?\n    (-(?<region>(?:[a-z]{2}|[0-9]{3})))?\n    (?<variants>(?:-(?:[a-z0-9]{5,8}|[0-9][a-z0-9]{3}))*)\n    (?<extensions>(?:-[0-9a-wy-z](?:-[a-z0-9]{2,8})+)*)\n    (?:-(?<privateuse>(?:${t})))?\n  )|(?<privateuse2>${t}))$`.replace(/[\s\t\n]/g,"");return new RegExp(i,"i")}(),i=e.match(t),{groups:s}=i??{};if(s){let e={};if(s.extensions){let t=s.extensions.toLowerCase().match(/(?:[0-9a-wy-z](?:-[a-z0-9]{2,8})+)/g);Array.from(t||[]).forEach((t=>{e[t[0]]=t.slice(2)}))}let t=s.variants?.split(/-/).filter((e=>""!==e)),i={extlang:s.extlang,langtag:s.langtag,language:s.language,privateuse:s.privateuse||s.privateuse2,region:s.region,script:s.script,extensions:e,variants:t};return Object.keys(i).forEach((e=>{let t=i[e];(typeof t>"u"||""===t)&&delete i[e]})),i}return null}catch{return null}};var Ya=e=>{if(!e?.startsWith("P"))return;let t=(e,t)=>{let i=e?parseFloat(e.replace(",",".")):NaN;return(isNaN(i)?0:i)*t},i=/^(-|\+)?P(?:([-+]?[0-9,.]*)Y)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)W)?(?:([-+]?[0-9,.]*)D)?(?:T(?:([-+]?[0-9,.]*)H)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)S)?)?$/.exec(e),s="-"===i?.[1]?-1:1;return 24*t(i?.[5],s)*60*60*1e3+60*t(i?.[6],s)*60*1e3+60*t(i?.[7],s)*1e3+1e3*t(i?.[8],s)},Ja=(e,t)=>{let i=e;i=(0,ja.default)(i,"$$","$");let s={RepresentationID:t.representationId,Number:t.segmentNumber,Bandwidth:t.bandwidth,Time:t.segmentTime};for(let[e,t]of(0,qa.default)(s)){let s=new RegExp(`\\$${e}(?:%0(\\d+)d)?\\$`,"g");i=(0,ja.default)(i,s,((e,i)=>(0,u.wD)(t)?e:(0,u.wD)(i)?t:(0,za.default)(t,parseInt(i,10),"0")))}return i},Ka=(e,t)=>{let i,s={video:[],audio:[],text:[]},r=(new DOMParser).parseFromString(e,"application/xml").children[0],a=Array.from(r.querySelectorAll("MPD > BaseURL").values()).map((e=>e.textContent?.trim()??"")),n=(0,Ha.default)(a,0)??"",o="dynamic"===r.getAttribute("type"),h=r.getAttribute("availabilityStartTime"),d=r.getAttribute("publishTime"),l=r.getElementsByTagName("vk:Attrs")[0],c=l?.getElementsByTagName("vk:XLatestSegmentPublishTime")[0].textContent,p=l?.getElementsByTagName("vk:XStreamIsLive")[0].textContent,f=l?.getElementsByTagName("vk:XStreamIsUnpublished")[0].textContent,m=l?.getElementsByTagName("vk:XPlaybackDuration")[0].textContent;o&&(i={availabilityStartTime:h?new Date(h).getTime():0,publishTime:d?new Date(d).getTime():0,latestSegmentPublishTime:c?new Date(c).getTime():0,streamIsAlive:"yes"===p,streamIsUnpublished:"yes"===f});let g,b=r.getAttribute("mediaPresentationDuration"),v=[...r.getElementsByTagName("Period")],y=v.reduce(((e,t)=>({...e,[t.id]:t.children})),{}),S=v.reduce(((e,t)=>({...e,[t.id]:t.getAttribute("duration")})),{});b?g=Ya(b):(0,Wa.default)(S).filter((e=>e)).length&&!o?g=(0,Wa.default)(S).reduce(((e,t)=>e+(Ya(t)??0)),0):m&&(g=parseInt(m,10));let w=0,T=r.getAttribute("profiles")?.split(",")??[];for(let e of v.map((e=>e.id)))for(let i of y[e]){let e=i.getAttribute("id")??"id"+(w++).toString(10),r=i.getAttribute("mimeType")??"",a=i.getAttribute("codecs")??"",o=i.getAttribute("contentType")??r?.split("/")[0],h=i.getAttribute("profiles")?.split(",")??[],d=Za(i.getAttribute("lang")??"")??{},l=i.querySelector("Label")?.textContent?.trim()??void 0,c=i.querySelectorAll("Representation"),p=i.querySelector("SegmentTemplate"),f=i.querySelector("Role")?.getAttribute("value")??void 0,m=o,b={id:e,language:d.language,isDefault:"main"===f,label:l,codecs:a,hdr:"video"===m&&Xa(a),mime:r,representations:[]};for(let e of c){var $,x,k,L,R;let s,c=e.getAttribute("lang")??void 0,f=l??i.getAttribute("label")??e.getAttribute("label")??void 0,v=e.querySelector("BaseURL")?.textContent?.trim()??"",y=new URL(v||n,t).toString(),S=e.getAttribute("mimeType")??r,E=e.getAttribute("codecs")??a??"";if("text"===o){let t=e.getAttribute("id")||"",i=d.privateuse?.includes("x-auto")||t.includes("_auto"),r=e.querySelector("SegmentTemplate");if(r){let a={representationId:e.getAttribute("id")??void 0,bandwidth:e.getAttribute("bandwidth")??void 0},n=parseInt(e.getAttribute("bandwidth")??"",10)/1e3,o=parseInt(r.getAttribute("startNumber")??"",10)??1,u=parseInt(r.getAttribute("timescale")??"",10),h=r.querySelectorAll("SegmentTimeline S")??[],d=r.getAttribute("media");if(!d)continue;let l=[],c=0,p="",f=0,m=o,b=0;for(let e of h){let t=parseInt(e.getAttribute("d")??"",10),i=parseInt(e.getAttribute("r")??"",10)||0,s=parseInt(e.getAttribute("t")??"",10);b=Number.isFinite(s)?s:b;let r=t/u*1e3,n=b/u*1e3;for(let e=0;e<i+1;e++){let i=Ja(d,{...a,segmentNumber:m.toString(10),segmentTime:(b+e*t).toString(10)}),s=(n??0)+e*r,o=s+r;m++,l.push({time:{from:s,to:o},url:i})}b+=(i+1)*t,c+=(i+1)*r}f=b/u*1e3,p=Ja(d,{...a,segmentNumber:m.toString(10),segmentTime:b.toString(10)}),s={id:t,kind:"text",segmentReference:{type:"template",baseUrl:y,segmentTemplateUrl:d,initUrl:"",totalSegmentsDurationMs:c,segments:l,nextSegmentBeyondManifest:{time:{from:f,to:1/0},url:p},timescale:u},profiles:[],duration:g,bitrate:n,mime:"",codecs:"",width:0,height:0,isAuto:i}}else s={id:t,isAuto:i,kind:"text",url:y}}else{let t,r=e.getAttribute("contentType")??S?.split("/")[0]??o,a=i.getAttribute("profiles")?.split(",")??[],n=parseInt(e.getAttribute("width")??"",10),d=parseInt(e.getAttribute("height")??"",10),l=parseInt(e.getAttribute("bandwidth")??"",10)/1e3,c=e.getAttribute("frameRate")??"",f=e.getAttribute("quality")??void 0,b=c?Ga(c):void 0,v=`${e.getAttribute("id")??"id"+(w++).toString(10)}@${"video"===r?`${d}p`:"audio"===r?`${l}Kbps`:E}`,$=[...T,...h,...a],x=e.querySelector("SegmentBase"),k=e.querySelector("SegmentTemplate")??p;if(x){let i=e.querySelector("SegmentBase Initialization")?.getAttribute("range")??"",[s,r]=i.split("-").map((e=>parseInt(e,10))),a={from:s,to:r},n=e.querySelector("SegmentBase")?.getAttribute("indexRange"),[o,u]=n?n.split("-").map((e=>parseInt(e,10))):[];t={type:"byteRange",url:y,initRange:a,indexRange:n?{from:o,to:u}:void 0}}else{if(!k)throw new ReferenceError("Unknown MPD segment referencing type");{let i={representationId:e.getAttribute("id")??void 0,bandwidth:e.getAttribute("bandwidth")??void 0},s=parseInt(k.getAttribute("timescale")??"",10),r=k.getAttribute("initialization")??"",a=k.getAttribute("media"),n=parseInt(k.getAttribute("startNumber")??"",10)??1,o=Ja(r,i);if(!a)throw new ReferenceError("No media attribute in SegmentTemplate");let h=k.querySelectorAll("SegmentTimeline S")??[],d=[],l=0,c="",p=0;if(h.length){let e=n,t=0;for(let r of h){let n=parseInt(r.getAttribute("d")??"",10),o=parseInt(r.getAttribute("r")??"",10)||0,u=parseInt(r.getAttribute("t")??"",10);t=Number.isFinite(u)?u:t;let h=n/s*1e3,c=t/s*1e3;for(let s=0;s<o+1;s++){let r=Ja(a,{...i,segmentNumber:e.toString(10),segmentTime:(t+s*n).toString(10)}),o=(c??0)+s*h,u=o+h;e++,d.push({time:{from:o,to:u},url:r})}t+=(o+1)*n,l+=(o+1)*h}p=t/s*1e3,c=Ja(a,{...i,segmentNumber:e.toString(10),segmentTime:t.toString(10)})}else if((0,u.R)(g)){let e=parseInt(k.getAttribute("duration")??"",10)/s*1e3,t=Math.ceil(g/e),r=0;for(let s=1;s<t;s++){let t=Ja(a,{...i,segmentNumber:s.toString(10),segmentTime:r.toString(10)});d.push({time:{from:r,to:r+e},url:t}),r+=e}p=r,c=Ja(a,{...i,segmentNumber:t.toString(10),segmentTime:r.toString(10)})}t={type:"template",baseUrl:y,segmentTemplateUrl:a,initUrl:o,totalSegmentsDurationMs:l,segments:d,nextSegmentBeyondManifest:{time:{from:p,to:1/0},url:c},timescale:s}}}if(!r||!S)continue;let L={video:"video",audio:"audio",text:"text"}[r];if(!L)continue;m||(m=L),s={id:v,kind:L,segmentReference:t,profiles:$,duration:g,bitrate:l,mime:S,codecs:E,width:n,height:d,fps:b,quality:f}}($=b).language||($.language=c),(x=b).label||(x.label=f),(k=b).mime||(k.mime=S),(L=b).codecs||(L.codecs=E),(R=b).hdr||(R.hdr="video"===m&&Xa(E)),b.representations.push(s)}if(m){let e=s[m].find((e=>e.id===b.id));if(e&&b.representations.every((e=>"template"===e.segmentReference.type)))for(let t of e.representations){let e=b.representations.find((e=>e.id===t.id));if(!e)continue;let i=e.segmentReference,s=t.segmentReference;s.segments.push(...i.segments),s.nextSegmentBeyondManifest=i.nextSegmentBeyondManifest}else s[m].push(b)}}return{duration:g,streams:s,baseUrls:a,live:i}},en=g(ni(),1),tn=g(Oe(),1),sn=e=>{let{webmDecodingInfo:t}=ks.video,i="DASH_WEBM",s="DASH_WEBM_AV1";switch(e){case"vp9":return[i,s];case"av1":return[s,i];case"none":return[];case"smooth":return t?t[s].smooth?[s,i]:t[i].smooth?[i,s]:[s,i]:[i,s];case"power_efficient":return t?t[s].powerEfficient?[s,i]:t[i].powerEfficient?[i,s]:[s,i]:[i,s];default:(0,u.xb)(e)}},rn=({webmCodec:e,androidPreferredFormat:t,iosPreferredFormat:i,preferMultiStream:s})=>{let r=[...s?["DASH_STREAMS"]:[],...sn(e),"DASH_SEP","DASH_ONDEMAND",...s?[]:["DASH_STREAMS"]],a=[...s?["DASH_STREAMS"]:[],"DASH_SEP","DASH_ONDEMAND",...s?[]:["DASH_STREAMS"]];if(ks.device.isAndroid)switch(t){case"mpeg":return["MPEG",...r,"HLS","HLS_ONDEMAND"];case"hls":return["HLS","HLS_ONDEMAND",...r,"MPEG"];case"dash":return[...r,"HLS","HLS_ONDEMAND","MPEG"];case"dash_any_mpeg":return[...a,"MPEG",...sn(e),"HLS","HLS_ONDEMAND"];case"dash_any_webm":return[...sn(e),"MPEG",...a,"HLS","HLS_ONDEMAND"];case"dash_sep":return["DASH_SEP","MPEG",...sn(e),...a,"HLS","HLS_ONDEMAND"];default:(0,u.xb)(t)}if(ks.video.nativeHlsSupported)switch(i){case"hls":return[...r,"HLS","HLS_FMP4","HLS_ONDEMAND","MPEG"];case"hls_fmp4":return[...r,"HLS_FMP4","HLS","HLS_ONDEMAND","MPEG"];default:(0,u.xb)(i)}return[...r,"HLS","HLS_ONDEMAND","MPEG"]},an=({androidPreferredFormat:e,preferCMAF:t,preferWebRTC:i})=>{let s,r=t?["DASH_LIVE_CMAF","DASH_LIVE"]:["DASH_LIVE","DASH_LIVE_CMAF"],a=t?["HLS_LIVE_CMAF","HLS_LIVE"]:["HLS_LIVE","HLS_LIVE_CMAF"],n=[...r,...a],o=[...a,...r],h=ks.device.isMac&&ks.browser.isSafari;if(ks.device.isAndroid)switch(e){case"dash":case"dash_any_mpeg":case"dash_any_webm":case"dash_sep":s=n;break;case"hls":case"mpeg":s=o;break;default:(0,u.xb)(e)}else s=!ks.video.nativeHlsSupported||h||ks.browser.isChromiumBased?h?t?["DASH_LIVE_CMAF","HLS_LIVE_CMAF","HLS_LIVE","DASH_LIVE"]:["HLS_LIVE","DASH_LIVE","DASH_LIVE_CMAF","HLS_LIVE_CMAF"]:n:o;return i?["WEB_RTC_LIVE",...s]:[...s,"WEB_RTC_LIVE"]},nn=e=>e?["HLS_LIVE","HLS_LIVE_CMAF","DASH_LIVE_CMAF"]:["DASH_WEBM","DASH_WEBM_AV1","DASH_SEP","DASH_ONDEMAND","HLS","HLS_ONDEMAND","MPEG"],on=e=>{if(0===e.size)return;if(1===e.size){let t=e.values().next();return(0,en.default)(t.value.split("."),0)}for(let t of e){let e=(0,en.default)(t.split("."),0);if("opus"===e||"vp09"===e||"av01"===e)return e}let t=e.values().next();return(0,en.default)(t.value.split("."),0)},un=e=>{let t=e.map((e=>dn(e))),{codecs:i}=ks.video;return ln().filter((e=>{if(!(0,tn.default)(t,e))return!1;switch(e){case"av1":return i.av1;case"vp9":return i.vp9;case"avc1":return i.h264;case"hev1":return i.h265;default:return!1}}))},hn=e=>{let t=e.map((e=>dn(e))),{codecs:i}=ks.video;return cn().filter((e=>{if(!(0,tn.default)(t,e))return!1;switch(e){case"opus":return i.opus;case"mp4a":return i.aac;default:return!1}}))},dn=e=>e.split(".")[0].replace("0",""),ln=()=>["av1","vp9","hev1","avc1"],cn=()=>["opus","mp4a"],pn=g(ni(),1),fn=e=>"function"==typeof e&&e?.toString().endsWith("{ [native code] }"),mn=!fn(window.requestIdleCallback)||!fn(window.cancelIdleCallback),gn=mn?(e,t={})=>{let i=t.timeout||1,s=performance.now();return window.setTimeout((()=>{e({get didTimeout(){return!t.timeout&&performance.now()-s-1>i},timeRemaining:()=>Math.max(0,performance.now()-s+1)})}),1)}:window.requestIdleCallback,bn=mn?e=>window.clearTimeout(e):window.cancelIdleCallback,vn=g(ni(),1),yn=e=>e.valid,Sn=class{get id(){return this.type}scanForBoxes(e){return this.boxParser.parse(e)}readString(e,t="ascii"){let i=new TextDecoder(t).decode(new DataView(this.source.buffer,this.source.byteOffset+this.cursor,e));return this.cursor+=e,i}readUint8(){let e=this.source.getUint8(this.cursor);return this.cursor+=1,e}readUint16(){let e=this.source.getUint16(this.cursor);return this.cursor+=2,e}readUint32(){let e=this.source.getUint32(this.cursor);return this.cursor+=4,e}readUint64(){let e=this.source.getBigInt64(this.cursor);return this.cursor+=8,e}constructor(e,t){this.cursor=0,this.source=e,this.boxParser=t,this.children=[];let i=this.readUint32();this.type=this.readString(4),1===i&&(this.cursor+=8);let s,r=e.byteOffset+this.cursor;0===i||1===i?(this.size=void 0,this.valid=!1,s=void 0):i>e.byteLength?(this.size=i,this.valid=!1,s=Math.min(i-this.cursor,e.byteLength-this.cursor)):(this.size=i,this.valid=!0,s=i-this.cursor),this.content=new DataView(e.buffer,r,s)}},wn=class extends Sn{},Tn=class extends Sn{constructor(e,t){if(super(e,t),!this.valid)return;let i=this.readUint32();this.version=i>>>24,this.flags=16777215&i,this.content=new DataView(this.content.buffer,this.content.byteOffset+4,this.content.byteLength-4)}},$n=class extends Tn{get earliestPresentationTime(){return this.earliestPresentationTime32}get firstOffset(){return this.firstOffset32}constructor(e,t){if(super(e,t),this.valid){this.segments=[],this.referenceId=this.readUint32(),this.timescale=this.readUint32(),this.earliestPresentationTime32=this.readUint32(),this.firstOffset32=this.readUint32(),this.earliestPresentationTime64=0,this.firstOffset64=0,this.referenceCount=65535&this.readUint32();for(let e=0;e<this.referenceCount;e++){let e=this.readUint32(),t=e>>>31,i=e<<1>>>1,s=this.readUint32();e=this.readUint32();let r=e>>>28,a=e<<3>>>3;this.segments.push({referenceType:t,referencedSize:i,subsegmentDuration:s,SAPType:r,SAPDeltaTime:a})}}}},xn={ftyp:class extends Sn{constructor(e,t){if(super(e,t),!this.valid)return;this.compatibleBrands=[],this.majorBrand=this.readString(4),this.minorVersion=this.readUint32();let i=new DataView(this.content.buffer,this.content.byteOffset+8,this.content.byteLength-8);for(let e=0;e<i.byteLength;e+=4){let e=this.readString(4);this.compatibleBrands.push(e)}}},moov:class extends Sn{constructor(e,t){super(e,t),this.children=this.scanForBoxes(this.content)}},mvhd:class extends Tn{constructor(e,t){super(e,t),this.valid&&(this.creationTime=this.readUint32(),this.modificationTime=this.readUint32(),this.timescale=this.readUint32(),this.duration=this.readUint32(),this.rate=this.readUint32(),this.volume=this.readUint16())}},moof:class extends Sn{constructor(e,t){super(e,t),this.children=this.scanForBoxes(this.content)}},mdat:class extends Sn{constructor(e,t){super(e,t),this.data=this.content}},sidx:$n,trak:class extends Sn{constructor(e,t){super(e,t),this.children=this.scanForBoxes(this.content)}},mdia:class extends Sn{constructor(e,t){super(e,t),this.children=this.scanForBoxes(this.content)}},mfhd:class extends Tn{constructor(e,t){super(e,t),this.valid&&(this.sequenceNumber=this.readUint32())}},tkhd:class extends Tn{constructor(e,t){super(e,t),this.creationTime=this.readUint32(),this.modificationTime=this.readUint32(),this.trackId=this.readUint32(),this.cursor+=4,this.duration=this.readUint32(),this.cursor+=8,this.layer=this.readUint16(),this.alternateGroup=this.readUint16(),this.cursor+=2,this.cursor+=2,this.matrix=[[this.readUint32(),this.readUint32(),this.readUint32()],[this.readUint32(),this.readUint32(),this.readUint32()],[this.readUint32(),this.readUint32(),this.readUint32()]],this.width=this.readUint32(),this.height=this.readUint32()}},traf:class extends Sn{constructor(e,t){super(e,t),this.children=this.scanForBoxes(this.content)}},tfhd:class extends Tn{constructor(e,t){super(e,t),this.trackId=this.readUint32(),1&this.flags&&(this.baseDataOffset=this.readUint64()),2&this.flags&&(this.sampleDescriptionIndex=this.readUint32()),8&this.flags&&(this.defaultSampleDuration=this.readUint32()),16&this.flags&&(this.defaultSampleSize=this.readUint32()),32&this.flags&&(this.defaultSampleFlags=this.readUint32())}},tfdt:class extends Tn{get baseMediaDecodeTime(){return 1===this.version?this.baseMediaDecodeTime64:this.baseMediaDecodeTime32}constructor(e,t){super(e,t),this.baseMediaDecodeTime32=0,this.baseMediaDecodeTime64=BigInt(0),1===this.version?this.baseMediaDecodeTime64=this.readUint64():this.baseMediaDecodeTime32=this.readUint32()}},trun:class extends Tn{constructor(e,t){super(e,t),this.sampleDuration=[],this.sampleSize=[],this.sampleFlags=[],this.sampleCompositionTimeOffset=[],this.optionalFields=0,this.sampleCount=this.readUint32(),1&this.flags&&(this.dataOffset=this.readUint32()),4&this.flags&&(this.firstSampleFlags=this.readUint32());for(let e=0;e<this.sampleCount;e++)256&this.flags&&this.sampleDuration.push(this.readUint32()),512&this.flags&&this.sampleSize.push(this.readUint32()),1024&this.flags&&this.sampleFlags.push(this.readUint32()),2048&this.flags&&this.sampleCompositionTimeOffset.push(this.readUint32())}},minf:class extends Sn{constructor(e,t){super(e,t),this.children=this.scanForBoxes(this.content)}},sv3d:class extends Sn{constructor(e,t){super(e,t),this.children=this.scanForBoxes(this.content)}},st3d:class extends Tn{constructor(e,t){if(super(e,t),this.valid){switch(this.readUint8()){case 0:this.stereoMode=0;break;case 1:this.stereoMode=1;break;case 2:this.stereoMode=2;break;case 3:this.stereoMode=3;break;case 4:this.stereoMode=4}this.cursor+=1}}},prhd:class extends Tn{constructor(e,t){super(e,t),this.valid&&(this.poseYawDegrees=this.readUint32(),this.posePitchDegrees=this.readUint32(),this.poseRollDegrees=this.readUint32())}},proj:class extends Sn{constructor(e,t){super(e,t),this.children=this.scanForBoxes(this.content)}},equi:class extends Tn{constructor(e,t){super(e,t),this.valid&&(this.projectionBoundsTop=this.readUint32(),this.projectionBoundsBottom=this.readUint32(),this.projectionBoundsLeft=this.readUint32(),this.projectionBoundsRight=this.readUint32())}},uuid:class extends Sn{parseData(e,t){if("ondemandlivejson"===e){let e=new TextDecoder("ascii").decode(t),i=JSON.parse(e);return{received:i["t-in"],prepared:i["t-out"]}}(0,u.xb)(e)}constructor(e,t){if(super(e,t),!this.valid)return;let i=this.readString(16),s=new DataView(this.content.buffer,this.content.byteOffset+16,this.content.byteLength-16);this.userData=this.parseData(i,s)}},stbl:class extends Sn{constructor(e,t){super(e,t),this.children=this.scanForBoxes(this.content)}},stsd:class extends Tn{constructor(e,t){super(e,t),this.valid&&(this.entryCount=this.readUint32(),this.children=this.scanForBoxes(new DataView(this.content.buffer,this.content.byteOffset+4,this.content.byteLength-4)))}},avc1:class extends Sn{constructor(e,t){super(e,t),this.valid&&(this.children=this.scanForBoxes(new DataView(this.content.buffer,this.content.byteOffset+78,this.content.byteLength-78)))}},unknown:wn},kn=class e{parse(e){let t=[],i=this.options.offset;for(;i<e.byteLength;){let s,r=new TextDecoder("ascii").decode(new DataView(e.buffer,e.byteOffset+i+4,4));try{s=this.createBox(r,new DataView(e.buffer,e.byteOffset+i,e.byteLength-i))}catch(e){if(!(e instanceof RangeError))throw e}if(!s||!yn(s))break;t.push(s),i+=s.size}return t}createBox(t,i){let s=xn[t];return s?new s(i,new e):new wn(i,new e)}constructor(e={}){this.options={offset:0,...e}}},Ln=class{indexBoxLevel(e){e.forEach((e=>{var t,i;yn(e)&&((t=this.index)[i=e.type]??(t[i]=[]),this.index[e.type].push(e),e.children.length>0&&this.indexBoxLevel(e.children))}))}find(e){return this.index[e]&&this.index[e][0]?this.index[e][0]:null}findAll(e){return this.index[e]||[]}constructor(e){this.index={},this.indexBoxLevel(e)}},Rn=new TextDecoder("ascii"),En={validateData:e=>"ftyp"===Rn.decode(new DataView(e.buffer,e.byteOffset+4,4)),parseInit:e=>{let t={is3dVideo:!1,stereoMode:0,projectionType:1,projectionData:{pose:{yaw:0,pitch:0,roll:0},bounds:{top:0,bottom:0,left:0,right:0}}},i=(new kn).parse(e),s=new Ln(i);if(s.find("sv3d")){t.is3dVideo=!0;let e=s.find("st3d");e&&(t.stereoMode=e.stereoMode);let i=s.find("prhd");i&&(t.projectionData.pose.yaw=i.poseYawDegrees,t.projectionData.pose.pitch=i.posePitchDegrees,t.projectionData.pose.roll=i.poseRollDegrees);let r=s.find("equi");r&&(t.projectionData.bounds.top=r.projectionBoundsTop,t.projectionData.bounds.right=r.projectionBoundsRight,t.projectionData.bounds.bottom=r.projectionBoundsBottom,t.projectionData.bounds.left=r.projectionBoundsLeft)}return t},getIndexRange:()=>{},parseSegments:e=>{let t=new $n(e,new kn),i=t.earliestPresentationTime/t.timescale*1e3,s=e.byteOffset+e.byteLength+t.firstOffset;return t.segments.map((e=>{if(0!==e.referenceType)throw new Error("Unsupported multilevel sidx");let r=e.subsegmentDuration/t.timescale*1e3,a={status:"none",time:{from:i,to:i+r},byte:{from:s,to:s+e.referencedSize-1}};return i+=r,s+=e.referencedSize,a}))},parseFeedableSegmentChunk:(e,t)=>{let i=(new kn).parse(e),s=new Ln(i),r=s.findAll("moof"),a=t?s.findAll("uuid"):s.findAll("mdat");if(!a.length||!r.length)return null;let n=r[0],o=a[a.length-1],u=n.source.byteOffset,h=o.source.byteOffset-n.source.byteOffset+o.size;return new DataView(e.buffer,u,h)},getChunkEndTime:(e,t)=>{let i=(new kn).parse(e),s=new Ln(i).findAll("traf"),r=s[s.length-1].children.find((e=>"tfhd"===e.type)),a=s[s.length-1].children.find((e=>"tfdt"===e.type)),n=s[s.length-1].children.find((e=>"trun"===e.type)),o=0;return o=n.sampleDuration.length?n.sampleDuration.reduce(((e,t)=>e+t),0):r.defaultSampleDuration*n.sampleCount,(Number(a.baseMediaDecodeTime)+o)/t*1e3},getServerLatencyTimestamps:e=>{let t=(new kn).parse(e),i=new Ln(t).findAll("uuid"),s=(0,vn.default)(i,-1);return s?{serverDataReceivedTimestamp:s.userData.received,serverDataPreparedTime:s.userData.received}:{}},getTimescaleFromIndex:e=>{let t=(new kn).parse(e);return new Ln(t).find("sidx")?.timescale}},Bn=g(Oe(),1),An={440786851:{type:"master"},17030:{type:"uint"},17143:{type:"uint"},17138:{type:"uint"},17139:{type:"uint"},17026:{type:"string"},17031:{type:"uint"},17029:{type:"uint"},236:{type:"binary"},408125543:{type:"master"},290298740:{type:"master"},19899:{type:"master"},21419:{type:"binary"},21420:{type:"uint"},357149030:{type:"master"},2807729:{type:"uint"},17545:{type:"float"},374648427:{type:"master"},174:{type:"master"},224:{type:"master"},30320:{type:"master"},30321:{type:"uint"},30322:{type:"master"},272869232:{type:"master"},524531317:{type:"master"},231:{type:"uint"},22612:{type:"master"},22743:{type:"uint"},167:{type:"uint"},171:{type:"uint"},163:{type:"binary"},160:{type:"master"},175:{type:"binary"},423732329:{type:"master"},307544935:{type:"master"},475249515:{type:"master"},187:{type:"master"},179:{type:"uint"},183:{type:"master"},247:{type:"uint"},241:{type:"uint"},240:{type:"uint"},178:{type:"uint"},21368:{type:"uint"},234:{type:"uint"},219:{type:"master"},150:{type:"uint"}},Mn=e=>{let t=e.getUint8(0),i=0;128&t?i=1:64&t?i=2:32&t?i=3:16&t&&(i=4);let s=Cn(e,i),r=s in An,a=r?An[s].type:"binary",n=e.getUint8(i),o=0;128&n?o=1:64&n?o=2:32&n?o=3:16&n?o=4:8&n?o=5:4&n?o=6:2&n?o=7:1&n&&(o=8);let u,h=new DataView(e.buffer,e.byteOffset+i+1,o-1),d=(n&255>>o)*2**(8*(o-1))+Cn(h),l=i+o;return u=l+d>e.byteLength?new DataView(e.buffer,e.byteOffset+l):new DataView(e.buffer,e.byteOffset+l,d),{tag:r?s:"0x"+s.toString(16).toUpperCase(),type:a,tagHeaderSize:l,tagSize:l+d,value:u,valueSize:d}},Cn=(e,t=e.byteLength)=>{switch(t){case 1:return e.getUint8(0);case 2:return e.getUint16(0);case 3:return 65536*e.getUint8(0)+e.getUint16(1);case 4:return e.getUint32(0);case 5:return e.getUint8(0)*2**32+e.getUint32(1);case 6:return e.getUint16(0)*2**32+e.getUint32(2);case 7:{let t=281474976710656*e.getUint8(0)+4294967296*e.getUint16(1)+e.getUint32(3);if(Number.isSafeInteger(t))return t}case 8:throw new ReferenceError("Int64 is not supported")}return 0},In=(e,t)=>{switch(t){case"int":return e.getInt8(0);case"uint":return Cn(e);case"float":return 4===e.byteLength?e.getFloat32(0):e.getFloat64(0);case"string":return new TextDecoder("ascii").decode(e);case"utf8":return new TextDecoder("utf-8").decode(e);case"date":return new Date(Date.UTC(2001,0)+e.getInt8(0)).getTime();case"master":case"binary":return e;default:(0,u.xb)(t)}},Dn=(e,t)=>{let i=0;for(;i<e.byteLength;){let s=new DataView(e.buffer,e.byteOffset+i),r=Mn(s);if(!t(r))return;"master"===r.type&&Dn(r.value,t),i=r.value.byteOffset-e.byteOffset+r.valueSize}},On=[357149030,290298740,374648427,174,224,30320,30321,30322,272869232,524531317,475249515,423732329,307544935],Pn=[231,22612,22743,167,171,163,160,175],Vn={validateData:e=>{if(440786851!==e.getUint32(0))return!1;let t,i,s,r=Mn(e);return Dn(r.value,(({tag:e,type:r,value:a})=>(17143===e?t=In(a,r):17026===e?i=In(a,r):17029===e&&(s=In(a,r)),!0))),(void 0===t||t<=1)&&void 0!==i&&"webm"===i&&(void 0===s||s<=2)},parseInit:e=>{let t,i,s,r,a,n,o=!1,h=!1,d=!1,l=!1;return Dn(e,(({tag:e,type:u,value:c,valueSize:p})=>{if(21419===e){let e=In(c,u);n=Cn(e)}else 21420!==e&&(n=void 0);return 408125543===e?(t=c.byteOffset,i=c.byteOffset+p):357149030===e?o=!0:290298740===e?h=!0:2807729===e?s=In(c,u):17545===e?r=In(c,u):21420===e&&475249515===n?a=In(c,u):374648427===e?Dn(c,(({tag:e,type:t,value:i})=>30321!==e||(l=1===In(i,t),!1))):o&&h&&(0,Bn.default)(On,e)&&(d=!0),!d})),(0,u.tZ)(t,"Failed to parse webm Segment start"),(0,u.tZ)(i,"Failed to parse webm Segment end"),(0,u.tZ)(r,"Failed to parse webm Segment duration"),s=s??1e6,{segmentStart:Math.round(t/1e9*s*1e3),segmentEnd:Math.round(i/1e9*s*1e3),timeScale:s,segmentDuration:Math.round(r/1e9*s*1e3),cuesSeekPosition:a,is3dVideo:l,stereoMode:0,projectionType:1,projectionData:{pose:{yaw:0,pitch:0,roll:0},bounds:{top:0,bottom:0,left:0,right:0}}}},getIndexRange:e=>{if((0,u.wD)(e.cuesSeekPosition))return;let t=e.segmentStart+e.cuesSeekPosition;return{from:t,to:t+1048576}},parseSegments:(e,t)=>{let i,s=!1,r=!1,a=e=>(0,u.R)(e.time)&&(0,u.R)(e.position),n=[];return Dn(e,(({tag:e,type:t,value:o})=>{switch(e){case 475249515:s=!0;break;case 187:i&&a(i)&&n.push(i),i={};break;case 179:i&&(i.time=In(o,t));break;case 183:break;case 241:i&&(i.position=In(o,t));break;default:s&&(0,Bn.default)(On,e)&&(r=!0)}return!(s&&r)})),i&&a(i)&&n.push(i),n.map(((e,i)=>{let{time:s,position:r}=e,a=n[i+1];return{status:"none",time:{from:s,to:a?a.time:t.segmentDuration},byte:{from:t.segmentStart+r,to:a?t.segmentStart+a.position-1:t.segmentEnd-1}}}))},parseFeedableSegmentChunk:e=>{let t=0,i=!1;try{Dn(e,(s=>524531317===s.tag?s.tagSize<=e.byteLength?(t=s.tagSize,!1):(t+=s.tagHeaderSize,!0):!!(0,Bn.default)(Pn,s.tag)&&(t+s.tagSize<=e.byteLength&&(t+=s.tagSize,i||(i=(0,Bn.default)([163,160,175],s.tag))),!0)))}catch{}return t>0&&t<=e.byteLength&&i?new DataView(e.buffer,e.byteOffset,t):null}},_n=e=>{let t=/^(.+)\/([^;]+)(?:;.*)?$/.exec(e);if(t){let[,e,i]=t;if("audio"===e||"video"===e)switch(i){case"webm":return Vn;case"mp4":return En}}throw new ReferenceError(`Unsupported mime type ${e}`)},Fn=g(ni(),1),Nn=({id:e,width:t,height:i,bitrate:s,fps:r,quality:a,streamId:n})=>{let o=(a?tr(a):void 0)??(0,u.Hf)({width:t,height:i});return o&&{id:e,quality:o,bitrate:s,size:{width:t,height:i},fps:r,streamId:n}},Un=({id:e,bitrate:t})=>({id:e,bitrate:t}),jn=({language:e,label:t},{id:i,url:s,isAuto:r})=>({id:i,url:s,isAuto:r,type:"internal",language:e,label:t}),qn=({id:e,language:t,label:i,codecs:s,isDefault:r})=>({id:e,language:t,label:i,codec:(0,Fn.default)(s.split("."),0),isDefault:r}),zn=({id:e,language:t,label:i,hdr:s,codecs:r})=>({id:e,language:t,hdr:s,label:i,codec:(0,Fn.default)(r.split("."),0)}),Hn=e=>"url"in e,Wn=e=>"template"===e.type,Qn=class{async seek(e){await this.abort(),await this.clearBuffer(),await this.maintain(e)}async maintain(e=this.getCurrentPosition()){(0,u.wD)(e)||(await this.maintainPlaybackBuffer(e),await this.maintainNativeBuffer(),this.actualizeLastSegmentInfo(e))}getForwardPlaybackBufferDuration(e=this.getCurrentPosition()){let t=this.getPlaybackBufferState();return(0,u.R)(t)&&(0,u.R)(e)?t.to-e:0}getPlaybackBufferState(){if(!this.bufferPlaybackQueue.length)return null;return{from:this.bufferPlaybackQueue[0].segment.time.from,to:this.bufferPlaybackQueue[this.bufferPlaybackQueue.length-1].segment.time.to}}async abort(){this.abortDownload(),await this.abortNativeBuffer()}findSegmentStartTime(e){let t=this.downloadingRepresentationId??this.playingRepresentationId??"";return this.segments.get(t)?.find((t=>t.time.from<=e&&t.time.to>=e))?.time.from}getRepresentationInitialTime(){return(0,u.wD)(this.playingRepresentationId)?0:(this.segments.get(this.playingRepresentationId)?.[0].time.from??0)/1e3}calculateDurationFromSegments(){if((0,u.wD)(this.playingRepresentationId))return 0;let e=this.segments.get(this.playingRepresentationId);return(e?(0,pn.default)(e,-1)?.time.to:0)||0}get lastDataObtainedTimestamp(){return this.lastDataObtainedTimestampMs}setTarget(e){this.forwardBufferTarget=e}setPreloadOnly(e){this.preloadOnly=e}destroy(){if(this.initData.clear(),this.initDataPromises.clear(),this.segments.clear(),this.parsedInitData.clear(),this.representations.clear(),this.downloadAbortController.abort(),this.destroyAbortController.abort(),this.subscription.unsubscribe(),bn)for(let e of this.idleCallbacks.values())bn(e);this.idleCallbacks.clear(),window.clearTimeout(this.loadByteRangeSegmentsTimeoutId)}forceSwitchCondition(e,t){let i=!0;if("video"===this.kind){let s=Nn(e),r=Nn(t);i=(0,u.R)(s)&&(0,u.R)(r)&&(0,u.kW)(r.quality,s.quality)}else if("audio"===this.kind){let s=Un(e),r=Un(t);i=(0,u.R)(s?.bitrate)&&(0,u.R)(r?.bitrate)&&r.bitrate>s.bitrate}return i}async clearBuffer(){this.bufferClearingMutex=!0,await this.nativeBufferManager.clear(this.destroyAbortController.signal),this.bufferPlaybackQueue.forEach((e=>e.segment.bufferStatus="none")),this.bufferPlaybackQueue=[],this.bufferClearingMutex=!1}abortDownload(){this.downloadAbortController.abort(),this.downloadAbortController=new Ca,this.abortDownloadingItems(),this.maintainPlaybackBufferMutex=!1}abortDownloadingItems(){for(let e of this.downloadingBufferItems)"downloading"===e.segment.networkStatus&&(e.segment.networkStatus="none",e.segment.size=0,e.segment.loadedBytes=0,e.segment.feedingBytes=0,e.segment.fedBytes=0,e.segment.data=null);this.downloadingBufferItems=[]}async abortNativeBuffer(){this.abortNativeBufferMutex=!0;let e=this.playingRepresentationId&&this.initData.get(this.playingRepresentationId),t=e instanceof ArrayBuffer?e:void 0,i=await this.nativeBufferManager.abortBuffer(t);return this.abortNativeBufferMutex=!1,this.maintainNativeBufferMutex=!1,i}async loadInits(e){await this.loadInit(e,"high",!0);for(let[e,t]of this.representations)this.idleCallbacks.set(t.id,gn((async e=>await this.loadInitIfNeeded(t,"low",!1))))}async loadInitIfNeeded(e,t="auto",i=!1){let s,r=this.initDataPromises.get(e.id);s=this.initData.has(e.id)&&this.segments.has(e.id)?Promise.resolve():(0,u.R)(r)?r:this.loadInit(e,t,i),await s}async loadInit(e,t="auto",i=!1){try{let i=this.tuning.dash.useFetchPriorityHints?t:"auto",s=this.fetcher.fetchRepresentation(e.segmentReference,this.containerParser,i);this.initDataPromises.set(e.id,s);let{initMetadata:r,initDataView:a,segments:n}=await s??{};if(this.initDataPromises.delete(e.id),(0,u.wD)(a)||(0,u.wD)(n))return;r&&this.parsedInitData.set(e.id,r);let o=a.buffer.slice(a.byteOffset,a.byteOffset+a.byteLength);this.initData.set(e.id,o),this.segments.set(e.id,n),this.failedDownloads=0}catch(e){i&&this.error$.next({id:"LoadInits",category:u.h.WTF,message:"loadInit threw",thrown:e})}}async maintainNativeBuffer(){let e=this.getCurrentPosition();if((0,u.wD)(e)||this.maintainNativeBufferMutex||this.abortNativeBufferMutex||this.bufferClearingMutex||this.switchMutex||this.preloadOnly)return;this.maintainNativeBufferMutex=!0;let t=this.bufferPlaybackQueue.find((t=>this.withinInterval(e,t.segment.time))),i=this.bufferPlaybackQueue.find((e=>"fed"!==e.segment.bufferStatus)),s=this.initData.get(i?.representationId??""),r=this.bufferPlaybackQueue[0],a=this.downloadAbortController.signal;(0,u.R)(s)&&(0,u.R)(i)&&(0,u.R)(t)&&this.playingRepresentationId!==i.representationId&&this.withinAppendInterval(e,i.segment.time)&&(i===t||"fed"===t.segment.bufferStatus)&&(await this.abortNativeBuffer(),await this.nativeBufferManager.addInitSegment(s,this.downloadAbortController.signal),this.playingRepresentationId=i.representationId,this.playingRepresentation$.next(this.playingRepresentationId)),(0,u.R)(i)&&this.withinAppendInterval(e,i.segment.time)&&(i.segment.loadedBytes===i.segment.size&&"none"===i.segment.bufferStatus?await this.appendSegmentFully(i,a):await this.appendSegmentPartially(i,a)),(0,u.R)(r)&&this.withinRemoveInterval(e,r.segment.time)&&await this.removeSegment(r,a),this.pruneVirtualBuffer(e),this.maintainNativeBufferMutex=!1}async maintainPlaybackBuffer(e){(0,u.tZ)(this.downloadingRepresentationId);let t=this.segments.get(this.downloadingRepresentationId),i=this.representations.get(this.downloadingRepresentationId);if((0,u.wD)(t)||(0,u.wD)(i)||this.maintainPlaybackBufferMutex||this.abortNativeBufferMutex||this.bufferClearingMutex||this.switchMutex)return;this.maintainPlaybackBufferMutex=!0;let s=t.find((t=>e>=t.time.from&&e<t.time.to));(0,u.R)(s)&&isFinite(s.time.from)&&isFinite(s.time.to)&&this.currentSegmentLength$.next(s?.time.to-s.time.from),this.downloadingBufferItems.length||(this.downloadingBufferItems=this.selectDownloadingItems(e,t)),await this.processCachedItems();let r=this.selectItemsToLoad();await this.loadItems(r,i),this.maintainPlaybackBufferMutex=!1}actualizeLastSegmentInfo(e){let t=this.segments.get(this.downloadingRepresentationId??"");if((0,u.wD)(t)||0===t.length)return;let i=t[t?.length-1];(0,u.wD)(i)||(this.fullyBuffered$.next(i.time.to-e-this.getForwardPlaybackBufferDuration(e)<this.tuning.dash.bufferTolerance),this.onLastSegment$.next(e-i.time.from>0))}selectDownloadingItems(e,t){(0,u.tZ)(this.downloadingRepresentationId);let i,s,r=this.getPlaybackBufferState();(0,u.R)(r)&&this.withinInterval(e,r)?(s=this.forwardBufferTarget-this.getForwardPlaybackBufferDuration(e),i=this.bufferPlaybackQueue[this.bufferPlaybackQueue.length-1].segmentIndex+1):(s=this.forwardBufferTarget,i=t.findIndex((t=>this.withinInterval(e,t.time)))),i=-1===i?0:i;let a=[];for(;i<t.length&&s>0;){a.push({representationId:this.downloadingRepresentationId,segmentIndex:i,segment:t[i]});let{from:e,to:r}=t[i].time;s-=r-e,i++}return a}async processCachedItems(){let e=[...this.downloadingBufferItems];for(;e.length&&"downloaded"===e[0].segment.networkStatus;)await this.onDownloadItem(e[0]),e.shift()}withinInterval(e,{from:t,to:i},s=this.tuning.dash.bufferTolerance){return!!(0,u.R)(e)&&(e+s>=t&&e<i)}withinAppendInterval(e,{from:t,to:i}){let{actionTimeShiftFromSegment:s}=this.tuning.dash;return!!(0,u.R)(e)&&(e+s>=t&&e+s<i||this.withinInterval(e,{from:t,to:i}))}withinRemoveInterval(e,{to:t}){let{actionTimeShiftFromSegment:i}=this.tuning.dash;return!!(0,u.R)(e)&&e-i>t}async appendSegmentFully(e,t){(0,u.wD)(e.segment.data)||(e.segment.feedingBytes=e.segment.size,await this.nativeBufferManager.append(e.segment.data,t)&&(e.segment.fedBytes=e.segment.size,this.onItemFullyAppended(e)))}async appendSegmentPartially(e,t){if((0,u.wD)(e.segment.data)||(0,u.wD)(e.segment.loadedBytes)||(0,u.wD)(e.segment.feedingBytes)||(0,u.wD)(e.segment.fedBytes)||(0,u.wD)(e.segment.size))return;let i=e.segment.data,s=new DataView(i.buffer,i.byteOffset+e.segment.feedingBytes,i.byteLength-e.segment.feedingBytes),r=e.segment.loadedBytes!==e.segment.size?this.parseFeedableSegmentChunk(s):s;r?.byteLength&&(e.segment.bufferStatus="partially_fed",e.segment.feedingBytes+=r.byteLength,await this.nativeBufferManager.append(r,t)&&(e.segment.fedBytes+=r.byteLength,e.segment.fedBytes===e.segment.size&&this.onItemFullyAppended(e)))}parseFeedableSegmentChunk(e){return this.containerParser.parseFeedableSegmentChunk(e,!1)}onItemFullyDownloaded(e){e.segment.networkStatus="downloaded"}onItemFullyAppended(e){e.segment.bufferStatus="fed"}async removeSegment(e,t){let{from:i,to:s}=e.segment.time,r=(s-i)/4;await this.nativeBufferManager.remove(0,s-r,t)&&(e.segment.fedBytes=0,e.segment.feedingBytes=0,e.segment.bufferStatus="none",this.bufferPlaybackQueue.shift())}async onDownloadItem(e){if(!this.downloadingBufferItems.find((t=>t===e)))return;let t=this.getCurrentPosition();return this.downloadingBufferItems=this.downloadingBufferItems.filter((t=>t!==e||"downloaded"!==t.segment.networkStatus)),(this.preloadOnly||(0,u.R)(t)&&!this.withinRemoveInterval(t,e.segment.time))&&!this.bufferPlaybackQueue.find((t=>t===e))&&this.bufferPlaybackQueue.push(e),this.maintainNativeBuffer()}pruneVirtualBuffer(e){let{maxVirtualBufferSize:t,virtualBufferPruneSize:i,bufferPruningSafeZone:s}=this.tuning.dash;if(this.currentVirtualBufferSize<t)return;let r=this.currentVirtualBufferSize-t+i;for(let t of this.segments.values())for(let i of t)(0,u.R)(i.size)&&r>0&&i.time.to<=e-s&&"none"===i.bufferStatus&&"downloaded"===i.networkStatus&&(i.data=null,i.networkStatus="none",this.currentVirtualBufferSize-=i.size,r-=i.size);for(let t of this.segments.values())for(let i of[...t].reverse())(0,u.R)(i.size)&&r>0&&i.time.from>=e+s&&"none"===i.bufferStatus&&"downloaded"===i.networkStatus&&!this.bufferPlaybackQueue.find((e=>e.segment===i))&&!this.downloadingBufferItems.find((e=>e.segment===i))&&(i.data=null,i.networkStatus="none",this.currentVirtualBufferSize-=i.size,r-=i.size)}updateRepresentationsBaseUrlIfNeeded(){if(!this.tuning.dash.enableBaseUrlSupport||!this.baseUrls.length||this.failedDownloads<=this.tuning.dash.maxSegmentRetryCount)return;this.baseUrlsIndex=(this.baseUrlsIndex+1)%this.baseUrls.length;let e=this.baseUrls[this.baseUrlsIndex];for(let t of this.representations.values())this.updateRepresentationBaseUrl(t,e)}constructor(e,t,i,{fetcher:s,tuning:r,getCurrentPosition:a,manifest:n}){this.error$=new u.B7,this.playingRepresentation$=new u.Ot(void 0),this.playingRepresentationInit$=new u.Ot(void 0),this.currentSegmentLength$=new u.Ot(0),this.onLastSegment$=new u.Ot(!1),this.fullyBuffered$=new u.Ot(!1),this.initData=new Map,this.initDataPromises=new Map,this.idleCallbacks=new Map,this.parsedInitData=new Map,this.segments=new Map,this.bufferPlaybackQueue=[],this.downloadingBufferItems=[],this.preloadOnly=!1,this.failedDownloads=0,this.lastDataObtainedTimestampMs=0,this.loadByteRangeSegmentsTimeoutId=0,this.currentVirtualBufferSize=0,this.baseUrls=[],this.baseUrlsIndex=0,this.maintainPlaybackBufferMutex=!1,this.maintainNativeBufferMutex=!1,this.bufferClearingMutex=!1,this.abortNativeBufferMutex=!1,this.switchMutex=!1,this.destroyAbortController=new Ca,this.downloadAbortController=new Ca,this.subscription=new u.yU,this.startWith=(0,u.ZC)(this.destroyAbortController.signal,async function*(e){let t=this.representations.get(e);(0,u.tZ)(t,`Cannot find representation ${e}`),this.playingRepresentationId=e,this.downloadingRepresentationId=e,this.containerParser=_n(t.mime),this.nativeBufferManager.init(t.mime,t.codecs,this.tuning.dash.useAbortMSEFix),yield this.loadInits(t);let i=this.initData.get(t.id),s=this.segments.get(t.id),r=this.parsedInitData.get(t.id);(0,u.tZ)(i,"No init buffer for starting representation"),(0,u.tZ)(s,"No segments for starting representation"),await this.nativeBufferManager.addInitSegment(i),this.playingRepresentation$.next(this.playingRepresentationId),this.playingRepresentationInit$.next(r)}.bind(this)),this.switchTo=(0,u.ZC)(this.destroyAbortController.signal,async function*(e,t=!0){if((0,u.wD)(this.downloadingRepresentationId)||e===this.downloadingRepresentationId||e===this.switchingRepresentationId)return;this.switchMutex=!0,this.switchingRepresentationId=e;let i=this.representations.get(this.downloadingRepresentationId),s=this.representations.get(e);(0,u.tZ)(s,`No such representation ${e}`),(0,u.tZ)(i,`No such representation ${this.downloadingRepresentationId}`),yield this.loadInitIfNeeded(s,"high");let r=this.initData.get(s.id),a=this.segments.get(s.id);(0,u.tZ)(r,"No init buffer for switching representation"),(0,u.tZ)(a,"No segments for switching representation");let n=this.getCurrentPosition()??0,o=e=>"downloaded"!==e.segment.networkStatus||e.segment.time.to-n>this.tuning.dash.maxSegmentDurationLeftToSelectNextSegment,h=e=>{let t=this.representations.get(e.representationId);return(0,u.tZ)(t,"No itemRepresentation for previous track before switch"),"downloaded"!==e.segment.networkStatus||this.forceSwitchCondition(t,s)},d=e=>t?o(e)&&h(e):o(e);this.bufferPlaybackQueue.filter(d).forEach((e=>e.segment.bufferStatus="none")),this.bufferPlaybackQueue=this.bufferPlaybackQueue.filter((e=>!d(e))),this.downloadingRepresentationId=e,this.switchingRepresentationId=null,this.bufferPlaybackQueue.length?(this.abortDownload(),yield this.maintain()):yield this.seek(n),this.switchMutex=!1}.bind(this)),this.waitExponentialDownloadDelay=(0,u.ZC)(this.downloadAbortController.signal,async function*(){let e=(0,u.rX)(this.failedDownloads,this.tuning.downloadBackoff);yield new Promise((t=>{this.loadByteRangeSegmentsTimeoutId=window.setTimeout(t,e),this.subscription.add((0,u.Rt)(window,"online").pipe((0,u.Oo)()).subscribe((()=>{t(),window.clearTimeout(this.loadByteRangeSegmentsTimeoutId)})))}))}.bind(this)),this.kind=e,this.nativeBufferManager=t,this.fetcher=s,this.tuning=r,this.getCurrentPosition=a,this.forwardBufferTarget=r.dash.forwardBufferTargetAuto,this.baseUrls=n?.baseUrls??[],this.representations=new Map(i.map((e=>[e.id,e])))}},Xn=class extends Qn{async loadItems(e,t,i="auto"){let{signal:s}=this.downloadAbortController;if(s.aborted||!e.length)return;let{url:r,...a}=this.prepareFetchParams(e,t);if(this.failedDownloads&&await this.waitExponentialDownloadDelay(),!s.aborted)try{await this.fetcher.fetch(r,{...a,priority:i}),this.lastDataObtainedTimestampMs=(0,u.tB)(),this.failedDownloads=0}catch(e){this.abortDownloadingItems(),_a(e)||(this.failedDownloads++,this.updateRepresentationsBaseUrlIfNeeded())}}selectItemsToLoad(){let e=0,t=0,i=[],s=this.preloadOnly?0:this.tuning.dash.segmentRequestSize,r=this.preloadOnly?this.forwardBufferTarget:0,a=0;for(;a<this.downloadingBufferItems.length&&"none"===this.downloadingBufferItems[a].segment.networkStatus&&(e<=s||t<=r);){let s=this.downloadingBufferItems[a].segment;s.networkStatus="downloading",s.size=1/0,s.loadedBytes=0,s.feedingBytes=0,s.fedBytes=0,i.push(this.downloadingBufferItems[a]),e+=s.byte.to+1-s.byte.from,t+=s.time.to+1-s.time.from,a++}return i}prepareFetchParams(e,t){if(ha(t.segmentReference))throw new Error("Representation is not byte range type");let{signal:i}=this.downloadAbortController,s=t.segmentReference.url,r={from:e[0].segment.byte.from,to:e[e.length-1].segment.byte.to};return{url:s,range:r,onProgress:async(s,a)=>{if(!i.aborted)try{this.lastDataObtainedTimestampMs=(0,u.tB)(),await this.onSomeDataLoaded({downloadingItems:e,dataView:s,loaded:a,signal:i,globalFrom:r?r.from:0,representationId:t.id})}catch(e){this.error$.next({id:"SegmentFeeding",category:u.h.VIDEO_PIPELINE,message:"Error when feeding segments",thrown:e})}},signal:i,bufferOptimisation:this.tuning.dash.fetcherBufferOptimisation}}async onSomeDataLoaded({downloadingItems:e,dataView:t,representationId:i,globalFrom:s,loaded:r,signal:a}){let n=this.representations.get(i);if(this.downloadingBufferItems.length&&!(0,u.wD)(n)&&!(0,u.wD)(s)&&!a.aborted)for(let i of e){let{segment:e}=i,a=e.byte.from-s,n=e.byte.to-s,o=n-a+1,h=a<r,d=n<=r;e.size=o,h&&("downloading"===e.networkStatus&&"none"===e.bufferStatus&&d?(e.data=new DataView(t.buffer,t.byteOffset+a,o),this.currentVirtualBufferSize+=e.size,this.onItemFullyDownloaded(i),e.loadedBytes=Math.min(o,r-a),await this.onDownloadItem(i)):(0,u.R)(e.feedingBytes)&&this.tuning.dash.enableSubSegmentBufferFeeding&&"downloading"===e.networkStatus&&(e.loadedBytes=Math.min(o,r-a),d&&(this.currentVirtualBufferSize+=e.size,this.onItemFullyDownloaded(i)),e.loadedBytes>e.feedingBytes&&(e.data=new DataView(t.buffer,t.byteOffset+a,e.loadedBytes),await this.onDownloadItem(i))))}}updateRepresentationBaseUrl(e,t){if(ha(e.segmentReference))throw new Error("Representation is not byte range type");e.segmentReference.url=t}constructor(e,t,i,s){super(e,t,i,s)}},Gn=class extends Qn{async loadItems(e,t,i="auto"){let{signal:s}=this.downloadAbortController;if(s.aborted||!e.length)return;let{url:r,...a}=this.prepareFetchParams(e,t);if(this.failedDownloads&&await this.waitExponentialDownloadDelay(),!s.aborted)try{let t=await this.fetcher.fetch(r,{...a,priority:i});if(this.lastDataObtainedTimestampMs=(0,u.tB)(),(0,u.wD)(t))return;let s=e[0],n=new DataView(t);s.segment.size=n.byteLength,s.segment.loadedBytes=n.byteLength,s.segment.data=n,this.onItemFullyDownloaded(s),await this.onDownloadItem(s),this.failedDownloads=0}catch(e){this.abortDownloadingItems(),_a(e)||(this.failedDownloads++,this.updateRepresentationsBaseUrlIfNeeded())}}selectItemsToLoad(){let e=[];for(let t of this.downloadingBufferItems){let i=t.segment;i.networkStatus="downloading",i.size=1/0,i.loadedBytes=0,i.feedingBytes=0,i.fedBytes=0,e.push(t)}return e}prepareFetchParams(e,t){let i=this.getFetchUrl(e,t).toString(),{signal:s}=this.downloadAbortController;return{url:i,onProgress:async(i,r)=>{if(!s.aborted)try{this.lastDataObtainedTimestampMs=(0,u.tB)(),await this.onSomeDataLoaded({downloadingItems:e,dataView:i,loaded:r,signal:s,representationId:t.id})}catch(e){this.error$.next({id:"SegmentFeeding",category:u.h.VIDEO_PIPELINE,message:"Error when feeding segments",thrown:e})}},signal:s,bufferOptimisation:this.tuning.dash.fetcherBufferOptimisation}}getFetchUrl(e,t){if(!ha(t.segmentReference))throw new Error("Representation is not template type");return new URL(e[0].segment.url,t.segmentReference.baseUrl)}async onSomeDataLoaded({downloadingItems:e,dataView:t,representationId:i,loaded:s,signal:r}){let a=e[0],{segment:n}=a,o=this.representations.get(i);!this.downloadingBufferItems.length||(0,u.wD)(o)||(0,u.wD)(n.feedingBytes)||"downloading"!==n.networkStatus||r.aborted||(n.loadedBytes=s,n.loadedBytes>n.feedingBytes&&this.tuning.dash.enableSubSegmentBufferFeeding&&(n.data=new DataView(t.buffer,t.byteOffset,n.loadedBytes),await this.onDownloadItem(a)))}updateRepresentationBaseUrl(e,t){if(!ha(e.segmentReference))throw new Error("Representation is not template type");e.segmentReference.baseUrl=t}constructor(e,t,i,s){super(e,t,i,s)}},Zn=g(gi(),1),Yn=g(ni(),1),Jn=class extends Gn{updateManifest(e){if(!e||[...this.segments.values()].every((e=>!e.length)))return;let t=(0,Zn.default)(e.streams[this.kind],(e=>e.representations));for(let e of t){if((0,u.wD)(e)||!ha(e.segmentReference))return;let t=e.segmentReference.segments.map((e=>({...e,networkStatus:"none",bufferStatus:"none",size:void 0}))),i=100,s=this.segments.get(e.id)??[],r=(0,Yn.default)(s,-1)?.time.to??0,a=t?.findIndex((e=>r>=e.time.from+i&&r<=e.time.to+i));if(-1===a){let t=this.getActualLiveStartingSegments(e.segmentReference);this.segments.set(e.id,t)}else{let i=t.slice(a+1);this.segments.set(e.id,[...s,...i])}this.representations.set(e.id,e)}}proceedLowLatencyLive(){let e=this.downloadingRepresentationId;(0,u.tZ)(e);let t=this.segments.get(e);if(t?.length){let i={representationId:e,segmentIndex:t.length-1,segment:t[t.length-1]};this.updateLowLatencyLive(i)}}getLiveSegmentsToLoadState(e){let t=e?.streams[this.kind],i=(0,Zn.default)(t,(e=>e.representations)).find((e=>e.id===this.downloadingRepresentationId));if((0,u.wD)(i))return;let s=this.segments.get(i.id);return s?.length?{from:s[0].time.from,to:s[s.length-1].time.to}:void 0}getRepresentationInitialTime(){if((0,u.wD)(this.playingRepresentationId))return 0;let e=this.representations.get(this.playingRepresentationId)?.segmentReference;return(0,u.wD)(e)||!ha(e)?0:this.getActualLiveStartingSegments(e)[0].time.from+this.tuning.dash.bufferTolerance}prepareFetchParams(e,t){return{...super.prepareFetchParams(e,t),isLowLatency:this.isActiveLowLatency()}}async onSomeDataLoaded({downloadingItems:e,...t}){await super.onSomeDataLoaded({downloadingItems:e,...t}),this.isActiveLowLatency()&&this.updateLowLatencyItemTime(e[0])}onItemFullyDownloaded(e){if(super.onItemFullyDownloaded(e),(0,u.wD)(e.segment.data)||!this.isActiveLowLatency())return;let t=e.segment.data,i=this.containerParser,{serverDataReceivedTimestamp:s,serverDataPreparedTime:r}=i.getServerLatencyTimestamps(t);s&&r&&this.currentLiveSegmentServerLatency$.next(r-s),this.updateLowLatencyItemTime(e),this.updateLowLatencyLive(e)}updateLowLatencyItemTime(e){let t=e.segment.data,i=this.representations.get(e.representationId)?.segmentReference;if((0,u.wD)(e.segment.data)||(0,u.wD)(i)||!ha(i))return;let s=this.containerParser;if(e.segment.isCurrentLowLatency){let{timescale:r}=i;e.segment.time.to=s.getChunkEndTime(t,r)}}updateLowLatencyLive(e){let t=0;for(let i of this.representations.values()){let s=i.segmentReference;if(!ha(s))return;let r=this.segments.get(i.id)??[],a=r.find((t=>Math.floor(t.time.from)===Math.floor(e.segment.time.from)));if(a?.isCurrentLowLatency&&(a.time.to=e.segment.time.to,t=a.time.to-a.time.from,a.isCurrentLowLatency=!1),!r.find((t=>Math.floor(t.time.from)===Math.floor(e.segment.time.to)))&&this.isActiveLowLatency()){let t=Math.round(e.segment.time.to*s.timescale/1e3).toString(10),i=Ja(s.segmentTemplateUrl,{segmentTime:t});r.push({networkStatus:"none",bufferStatus:"none",time:{from:e.segment.time.to,to:e.segment.time.to+this.tuning.dash.bufferTolerance},url:i,isCurrentLowLatency:!0})}}this.currentLowLatencySegmentLength$.next(t)}parseFeedableSegmentChunk(e){return this.containerParser.parseFeedableSegmentChunk(e,!0)}getFetchUrl(e,t){let i=super.getFetchUrl(e,t);return this.isActiveLowLatency()&&i.searchParams.set("low-latency","yes"),i}async loadInit(e,t="auto",i=!1){try{let i=this.tuning.dash.useFetchPriorityHints?t:"auto",s=this.fetcher.fetchRepresentation(e.segmentReference,this.containerParser,i);this.initDataPromises.set(e.id,s);let{initMetadata:r,initDataView:a,segments:n}=await s??{};if(this.initDataPromises.delete(e.id),(0,u.wD)(a)||(0,u.wD)(n))return;r&&this.parsedInitData.set(e.id,r);let o=this.getActualLiveStartingSegments(e.segmentReference);this.segments.has(e.id)||this.segments.set(e.id,o);let h=a.buffer.slice(a.byteOffset,a.byteOffset+a.byteLength);this.initData.set(e.id,h),this.failedDownloads=0}catch(e){i&&this.error$.next({id:"LoadInits",category:u.h.WTF,message:"loadInit threw",thrown:e})}}getActualLiveStartingSegments(e){let t=e.segments,i=this.isActiveLowLatency()?this.tuning.dashCmafLive.lowLatency.maxTargetOffset:this.tuning.dashCmafLive.maxActiveLiveOffset,s=[],r=0,a=t.length-1;do{s.unshift(t[a]),r+=t[a].time.to-t[a].time.from,a--}while(r<i&&a>=0);return this.liveInitialAdditionalOffset=r-i,this.isActiveLowLatency()?[s[0]]:s}constructor(e,t,i,s){super(e,t,i,s),this.currentLiveSegmentServerLatency$=new u.Ot(0),this.currentLowLatencySegmentLength$=new u.Ot(0),this.liveInitialAdditionalOffset=0,this.isSeekingLive=!1,this.isActiveLowLatency=s.isActiveLowLatency}},Kn=class{static getBufferManager(e,t,i,s){return s.manifest?.live?new Jn(e,t,i,s):ha(i[0].segmentReference)?new Gn(e,t,i,s):new Xn(e,t,i,s)}},eo=!1;try{eo=ks.browser.isSafari&&!!ks.browser.safariVersion&&ks.browser.safariVersion<=18}catch(zr){console.error(zr)}var to=class{async append(e,t){return(!t||!t.aborted)&&new Promise((i=>{let s={operation:"append",data:e,signal:t,callback:i};this.queue.push(s),this.pull()}))}async remove(e,t,i){return(!i||!i.aborted)&&new Promise((s=>{let r={operation:"remove",from:e,to:t,signal:i,callback:s};this.queue.unshift(r),this.pull()}))}async abort(e){return new Promise((t=>{let i,s=e=>{this.abortRequested=!1,t(e)};i=eo&&e?{operation:"safariAbort",init:e,callback:s}:{operation:"abort",callback:s};for(let{callback:e}of this.queue)e(!1);this.abortRequested=!0,i&&(this.queue=[i]),this.pull()}))}destroy(){this.destroyed=!0,this.buffer.removeEventListener("updateend",this.completeTask),this.queue=[],this.currentTask=null;try{this.buffer.abort()}catch(e){if(!(e instanceof DOMException&&"InvalidStateError"===e.name))throw e}}pull(){if((this.buffer.updating||this.currentTask||this.destroyed)&&!this.abortRequested)return;let e=this.isAbortFixEnabled?this.queue[0]:this.queue.shift();if(!e)return;if(e.signal?.aborted)return e.callback(!1),void this.pull();this.currentTask=e;let{operation:t}=this.currentTask;try{this.execute(this.currentTask)}catch(e){e instanceof DOMException&&"QuotaExceededError"===e.name&&"append"===t?this.bufferFull$.next(this.currentTask.data.byteLength):e instanceof DOMException&&"InvalidStateError"===e.name||this.error$.next({id:`BufferTaskQueue:${t}`,category:u.h.VIDEO_PIPELINE,message:"Buffer operation failed",thrown:e}),this.currentTask.callback(!1),this.currentTask=null}this.currentTask&&"abort"===this.currentTask.operation&&this.completeTask()}execute(e){let{operation:t}=e;switch(t){case"append":this.buffer.appendBuffer(e.data);break;case"remove":this.buffer.remove(e.from/1e3,e.to/1e3);break;case"abort":this.buffer.abort();break;case"safariAbort":this.buffer.abort(),this.buffer.appendBuffer(e.init);break;default:(0,u.xb)(t)}}constructor(e,t=!1){this.bufferFull$=new u.B7,this.error$=new u.B7,this.queue=[],this.currentTask=null,this.destroyed=!1,this.abortRequested=!1,this.isAbortFixEnabled=!1,this.completeTask=()=>{try{if(this.currentTask){let e=this.currentTask.signal?.aborted;this.currentTask.callback(!e),this.currentTask=null,this.isAbortFixEnabled&&this.queue.shift()}this.queue.length&&this.pull()}catch(e){this.error$.next({id:"BufferTaskQueueUnknown",category:u.h.VIDEO_PIPELINE,message:"Buffer appending or removal failed",thrown:e})}},this.buffer=e,this.isAbortFixEnabled=t,this.buffer.addEventListener("updateend",this.completeTask)}},io=(e,t)=>{let i=0;for(let s=0;s<e.length;s++){let r=1e3*e.start(s),a=1e3*e.end(s);r<=t&&t<=a&&(i=a)}return Math.max(i-t,0)},so=class{init(e,t,i=!1){this.sourceBuffer=this.mediaSource.addSourceBuffer(`${e}; codecs="${t}"`),this.sourceBufferTaskQueue=new to(this.sourceBuffer,i),this.subscription.add(this.sourceBufferTaskQueue.error$.subscribe((e=>this.error$.next(e)))),this.subscription.add((0,u.Rt)(this.sourceBuffer,"error").subscribe((()=>this.error$.next({id:"SourceBuffer",category:u.h.VIDEO_PIPELINE,message:"SourceBuffer Error event fired"}))))}addInitSegment(e,t){return this.sourceBufferTaskQueue.append(e,t)}append(e,t){return this.sourceBufferTaskQueue.append(e,t)}remove(e,t,i){return this.sourceBufferTaskQueue.remove(e,t,i)}async clear(e){let t=this.getBufferState();if((0,u.wD)(t))return Promise.resolve(!1);let i=!0;await this.sourceBufferTaskQueue.abort();for(let s of t)i&&(i=await this.sourceBufferTaskQueue.remove(s.from,s.to,e));return i}warmUpMediaSource(){!(0,u.wD)(this.sourceBuffer)&&!this.sourceBuffer.updating&&(this.sourceBuffer.mode="segments")}getBufferState(){if((0,u.wD)(this.sourceBuffer)||!qr(this.mediaSource,this.sourceBuffer)||!this.sourceBuffer.buffered.length)return null;let e=[];for(let t=0;t<this.sourceBuffer.buffered.length;t++)e.push({from:1e3*this.sourceBuffer.buffered.start(t),to:1e3*this.sourceBuffer.buffered.end(t)});return e}getForwardBufferDuration(e){return(0,u.wD)(this.sourceBuffer)||!qr(this.mediaSource,this.sourceBuffer)||!this.sourceBuffer.buffered.length||(0,u.wD)(e)?0:io(this.sourceBuffer.buffered,e)}async abortBuffer(e){return!(0,u.wD)(this.sourceBuffer)&&this.sourceBufferTaskQueue.abort(e)}destroy(){if(this.subscription.unsubscribe(),this.sourceBufferTaskQueue?.destroy(),this.sourceBuffer)try{this.mediaSource.removeSourceBuffer(this.sourceBuffer)}catch(e){if(!(e instanceof DOMException&&"NotFoundError"===e.name))throw e}this.sourceBuffer=null}constructor(e){this.error$=new u.B7,this.subscription=new u.yU,this.mediaSource=e}},ro=["timeupdate","progress","play","seeked","stalled","waiting"],ao=["timeupdate","progress","loadeddata","playing","seeked"],no=class{async initManifest(e,t,i){this.tracer.log("initManifest"),this.state$.startTransitionTo("manifest_ready"),this.element=e,this.manifestUrlString=this.prepareManifestUrlString(t,i),this.manifest=await this.updateManifest(),this.manifest?.streams.video.length?this.state$.setState("manifest_ready"):this.error$.next({id:"NoRepresentations",category:u.h.PARSER,message:"No playable video representations"})}initBuffer(){(0,u.tZ)(this.element),this.state$.setState("running"),this.subscription.add((0,u.h1)(...ro.map((e=>(0,u.Rt)(this.element,e))),(0,u.Rt)(window,"online")).subscribe((()=>this.tick()),(e=>this.error$.next({id:"DashVKPlayer",category:u.h.WTF,message:"Internal logic error",thrown:e}))));let e=[...this.source?.activeSourceBuffers??[]];this.subscription.add((0,u.h1)(...e.map((e=>(0,u.Rt)(e,"updateend")))).subscribe((e=>this.reinitDecoderIfNeeded()))),this.subscription.add((0,u.Rt)(this.element,"waiting").subscribe((e=>{this.stallWatchdogSubscription&&(this.stallWatchdogSubscription.unsubscribe(),this.subscriptionRemovable.remove(this.stallWatchdogSubscription)),this.stallWatchdogSubscription=(0,u.YP)(this.tuning.dash.stallWatchdogInterval).subscribe((()=>this.stallWatchdogIntervalCallback()),(e=>this.error$.next({id:"StallWatchdogCallback",category:u.h.NETWORK,message:"Can't restore DASH after stall.",thrown:e}))),this.subscriptionRemovable.add(this.stallWatchdogSubscription)})))}async switchRepresentation(e,t,i=!1){return{video:this.videoBufferManager,audio:this.audioBufferManager,text:null}[e]?.switchTo(t,i)}async seek(e,t=!1){let i;(0,u.tZ)(this.element),(0,u.tZ)(this.videoBufferManager),i=t||1e3*this.element.duration<=this.tuning.dashSeekInSegmentDurationThreshold||Math.abs(1e3*this.element.currentTime-e)<=this.tuning.dashSeekInSegmentAlwaysSeekDelta?e:Math.max(this.videoBufferManager.findSegmentStartTime(e)??e,this.audioBufferManager?.findSegmentStartTime(e)??e),this.warmUpMediaSourceIfNeeded(i),this.element.currentTime=i/1e3,await this.videoBufferManager.seek(i),await(this.audioBufferManager?.seek(i)),this.tracer.log("seek",(0,u.YO)({requestedPosition:e,forcePrecise:t,position:i}))}warmUpMediaSourceIfNeeded(e=this.element?.currentTime){(0,u.R)(this.element)&&(0,u.R)(this.source)&&(0,u.R)(e)&&this.isStreamEnded&&1e3*this.element.duration-e>this.tuning.dash.seekBiasInTheEnd&&this.nativeBufferManagers.forEach((e=>e.warmUpMediaSource()))}calculateDurationFromSegments(){return Math.max(this.videoBufferManager?.calculateDurationFromSegments()||0,this.audioBufferManager?.calculateDurationFromSegments()||0)}get isStreamEnded(){return"ended"===this.source?.readyState}getStreams(){return this.manifest?.streams}getCodecs(){return this.manifest?.codecs}setBufferTarget(e){this.bufferManagers.forEach((t=>t.setTarget(e)))}setPreloadOnly(e){this.bufferManagers.forEach((t=>t.setPreloadOnly(e)))}stop(){this.tracer.log("stop"),this.element?.querySelectorAll("source").forEach((e=>{URL.revokeObjectURL(e.src),e.remove()})),this.element=null,this.source=null,this.manifest=null,this.currentVideoRepresentation$.next(void 0),this.nativeBufferManagers.forEach((e=>e.destroy())),this.videoBufferManager?.destroy(),this.videoBufferManager=null,this.audioBufferManager?.destroy(),this.audioBufferManager=null,this.bufferManagers=[],this.state$.setState("none")}destroy(){this.subscription.unsubscribe(),this.subscriptionRemovable.unsubscribe(),this.representationSubscription.unsubscribe(),this.timeoutSourceOpenId&&clearTimeout(this.timeoutSourceOpenId),this.destroyController.abort(),this.fetcher.destroy(),this.stop(),(0,u.R)(this.source)&&this.isStreamNotOpen&&Array.from(this.source.sourceBuffers).every((e=>!e.updating))&&this.source.endOfStream(),this.source=null,this.tracer.end()}get isStreamNotOpen(){return"open"!==this.source?.readyState}async reinitDecoderIfNeeded(e=!1){let t=this.videoNativeBufferManager?.getBufferState()??[];if((0,u.wD)(this.element)||!t.length)return;let i=1e3*this.element.currentTime;this.element.readyState<3&&t.some((e=>i>=e.from&&i<=e.to))&&(e?await this.seek(i):this.element.currentTime=this.element.currentTime)}async stallWatchdogIntervalCallback(){(0,u.tZ)(this.element),(0,u.tZ)(this.source);let{stallWatchdogInterval:e}=this.tuning.dash;if(this.isStreamNotOpen)return;let t=this.currentStallDuration$.getValue()+e;this.currentStallDuration$.next(t);let i={timeInWaiting:t};if(await this.reinitDecoderIfNeeded(t%1e3==0),this.isStallExceeded(t))throw new Error(`Stall timeout exceeded: ${t} ms`);await this.restoreAfterDeepStall(i),this.tracer.log("stallIntervalCallback",(0,u.YO)(i))}isStallExceeded(e){let{crashOnStallTimeout:t,crashOnStallTWithoutDataTimeout:i}=this.tuning.dash,s=(0,u.tB)(),r=this.videoBufferManager?.lastDataObtainedTimestamp??0;this.videoLastDataObtainedTimestamp$.next(r);let a=this.audioBufferManager?.lastDataObtainedTimestamp??0,n=this.videoBufferManager?.getForwardPlaybackBufferDuration()??0,o=this.audioBufferManager?.getForwardPlaybackBufferDuration()??0,h=(0,u.R)(this.videoBufferManager)&&n<100&&s-r>i,d=(0,u.R)(this.audioBufferManager)&&o<100&&s-a>i;return(h||d)&&e>i||e>=t}async updateManifest(){this.tracer.log("updateManifestStart",{manifestUrl:this.manifestUrlString});let e=await this.fetchManifest();if((0,u.wD)(e))return null;let t=this.parseManifest(e);if(!t)return null;let i=this.getResultManifest(t);return this.tracer.log("updateManifestEnd",(0,u.YO)(i)),i}parseManifest(e){try{return Ka(e??"",this.manifestUrlString)}catch(t){let i=Oa(e)??{id:"ManifestParsing",category:u.h.PARSER,message:"Failed to parse MPD manifest",thrown:t};this.error$.next(i)}}getResultManifest(e){let t,i,s={text:e.streams.text,video:[],audio:[]},r=(e,t,i)=>!!(this.element?.canPlayType?.(t)&&gs()?.isTypeSupported?.(`${t}; codecs="${i}"`)||"text"===e);for(let a of["video","audio"]){let n,o=e.streams[a].filter((({mime:e,codecs:t})=>r(a,e,t)));if(s[a]=o,this.tuning.dash.codecsPrioritizeEnabled){let e=o.map((({codecs:e})=>e));"audio"===a&&(i=hn(e),n=i[0]),"video"===a&&(t=un(e),n=this.forceVideoCodec&&(0,Ia.default)(t,this.forceVideoCodec)?this.forceVideoCodec:t[0]),n&&(s[a]=o.filter((({codecs:e})=>dn(e)===n)))}else{let e=new Set(o.map((({codecs:e})=>e)));n=on(e),n&&(s[a]=o.filter((({codecs:e})=>e.startsWith(n))))}if("video"===a){let e=this.tuning.preferHDR,t=s.video.some((e=>e.hdr)),i=s.video.some((e=>!e.hdr));ks.display.isHDR&&e&&t?s.video=s.video.filter((e=>e.hdr)):i&&(s.video=s.video.filter((e=>!e.hdr)))}}let a={...e,streams:s};return this.tuning.dash.codecsPrioritizeEnabled&&(a.codecs={video:t,audio:i}),a}stopStallWatchdogSubscription(){this.stallWatchdogSubscription?.unsubscribe(),this.currentStallDuration$.next(0)}createBuffers(e,t,i,s){(0,u.tZ)(this.manifest),(0,u.tZ)(this.element);let r=e=>{this.representationSubscription.add((0,u.Rt)(e,"error").pipe((0,u.pb)((e=>!!this.element?.played.length))).subscribe((e=>{this.error$.next({id:"VideoSource",category:u.h.VIDEO_PIPELINE,message:"Unexpected video source error",thrown:e})})))};this.source=vs();let a=document.createElement("source");if(r(a),a.src=URL.createObjectURL(this.source),this.element.appendChild(a),bs())if(s){let e=document.createElement("source");r(e),e.type="application/x-mpegurl",e.src=s.url,this.element.appendChild(e)}else this.element.disableRemotePlayback=!0;let n=this.manifest.streams.video.reduce(((e,t)=>[...e,...t.representations]),[]);if(this.videoNativeBufferManager=new so(this.source),this.videoBufferManager=Kn.getBufferManager("video",this.videoNativeBufferManager,n,e),this.bufferManagers=[this.videoBufferManager],this.nativeBufferManagers=[this.videoNativeBufferManager],(0,u.R)(i)){this.audioNativeBufferManager=new so(this.source);let t=this.manifest.streams.audio.reduce(((e,t)=>[...e,...t.representations]),[]);this.audioBufferManager=Kn.getBufferManager("audio",this.audioNativeBufferManager,t,e),this.bufferManagers.push(this.audioBufferManager),this.nativeBufferManagers.push(this.audioNativeBufferManager)}}async waitStreamToOpen(){if(this.isStreamNotOpen){let e=this.tuning.dash.sourceOpenTimeout>=0;await new Promise((t=>{e&&(this.timeoutSourceOpenId=setTimeout((()=>{this.isStreamNotOpen?t():this.error$.next({id:"OpenOfStream",category:u.h.VIDEO_PIPELINE,message:"Failed to open MediaSource",thrown:new Error("Timeout reject when wait sourceopen event"),traceAsLog:!0})}),this.tuning.dash.sourceOpenTimeout)),this.source?.addEventListener("sourceopen",(()=>{this.timeoutSourceOpenId&&clearTimeout(this.timeoutSourceOpenId),t()}),{once:!0})}))}}initRepresentationSubscriptions(){this.representationSubscription.add(this.fetcher.manifestRequested.subscribe(this.manifestRequested)),this.representationSubscription.add(this.fetcher.manifestReceived.subscribe(this.manifestReceived)),this.representationSubscription.add(this.fetcher.firstBytesRequested.subscribe(this.firstBytesRequested)),this.representationSubscription.add(this.fetcher.firstBytesReceived.subscribe(this.firstBytesReceived)),this.representationSubscription.add(this.fetcher.lastConnectionType$.subscribe(this.lastConnectionType$)),this.representationSubscription.add(this.fetcher.lastConnectionReused$.subscribe(this.lastConnectionReused$)),this.representationSubscription.add(this.fetcher.lastRequestFirstBytes$.subscribe(this.lastRequestFirstBytes$)),this.representationSubscription.add((0,u.h1)(...this.bufferManagers.map((e=>e.error$))).subscribe(this.error$)),(0,u.tZ)(this.videoBufferManager),this.representationSubscription.add(this.videoBufferManager.playingRepresentation$.subscribe(this.currentVideoRepresentation$)),this.representationSubscription.add(this.videoBufferManager.playingRepresentationInit$.subscribe(this.currentVideoRepresentationInit$)),this.representationSubscription.add(this.videoBufferManager.currentSegmentLength$.subscribe(this.currentVideoSegmentLength$)),this.audioBufferManager&&(this.representationSubscription.add(this.audioBufferManager.playingRepresentation$.subscribe(this.currentAudioRepresentation$)),this.representationSubscription.add(this.audioBufferManager.currentSegmentLength$.subscribe(this.currentAudioSegmentLength$))),this.initBufferLengthSubscription()}initBufferLengthSubscription(){this.representationSubscription.add((0,u.h1)(...ao.map((e=>(0,u.Rt)(this.element,e)))).pipe((0,u.Tj)((e=>this.videoBufferManager?.getPlaybackBufferState())),(0,u.pb)(u.R),(0,u.Tj)((({from:e,to:t})=>({from:e/1e3,to:t/1e3})))).subscribe(this.currentBuffer$)),this.representationSubscription.add((0,u.h1)(...ao.map((e=>(0,u.Rt)(this.element,e)))).pipe((0,u.Tj)((e=>Math.max(this.videoBufferManager?.getForwardPlaybackBufferDuration()??0,this.audioBufferManager?.getForwardPlaybackBufferDuration()??0))),(0,u.jX)()).subscribe(this.bufferLength$)),this.representationSubscription.add(this.nativeBufferLength$.pipe((0,u.pb)((e=>e>this.tuning.dash.bufferEmptinessTolerance))).subscribe((e=>this.stopStallWatchdogSubscription())))}initTracerSubscription(){let e=(0,u.kD)(this.tracer.error.bind(this.tracer));this.subscription.add(this.error$.subscribe(e("error")))}async tick(){if((0,u.wD)(this.element)||(0,u.wD)(this.videoBufferManager)||this.isStreamNotOpen)return;let e=1e3*this.element.currentTime,t=(this.videoNativeBufferManager?.getBufferState()??[]).find((t=>e>=t.from&&e<=t.to));this.nativeBufferLength$.next(t?t.to-e:0),await this.videoBufferManager.maintain(e),await(this.audioBufferManager?.maintain(e))}constructor(e){this.element=null,this.manifestUrlString="",this.source=null,this.manifest=null,this.bufferManagers=[],this.nativeBufferManagers=[],this.subscription=new u.yU,this.subscriptionRemovable=new u.V6,this.representationSubscription=new u.yU,this.forceEnded$=new u.B7,this.destroyController=new Ca,this.state$=new Ps("none"),this.currentVideoRepresentation$=new u.Ot(void 0),this.currentVideoRepresentationInit$=new u.Ot(void 0),this.currentAudioRepresentation$=new u.Ot(void 0),this.currentVideoSegmentLength$=new u.Ot(0),this.currentAudioSegmentLength$=new u.Ot(0),this.error$=new u.B7,this.manifestRequested=new u.B7,this.manifestReceived=new u.B7,this.firstBytesRequested=new u.B7,this.firstBytesReceived=new u.B7,this.lastConnectionType$=new u.Ot(void 0),this.lastConnectionReused$=new u.Ot(void 0),this.lastRequestFirstBytes$=new u.Ot(void 0),this.currentLiveTextRepresentation$=new u.Ot(null),this.isLive$=new u.Ot(!1),this.isActiveLive$=new u.Ot(!1),this.isLowLatency$=new u.Ot(!1),this.liveDuration$=new u.Ot(0),this.liveSeekableDuration$=new u.Ot(0),this.liveAvailabilityStartTime$=new u.Ot(0),this.liveStreamStatus$=new u.Ot(void 0),this.currentBuffer$=new u.Ot({from:0,to:0}),this.bufferLength$=new u.Ot(0),this.nativeBufferLength$=new u.Ot(0),this.liveLatency$=new u.Ot(void 0),this.liveLoadBufferLength$=new u.Ot(0),this.livePositionFromPlayer$=new u.Ot(0),this.currentStallDuration$=new u.Ot(0),this.videoLastDataObtainedTimestamp$=new u.Ot(0),this.fetcherRecoverableError$=new u.B7,this.fetcherError$=new u.B7,this.initRepresentations=(0,u.ZC)(this.destroyController.signal,async function*(e,t,i){this.tracer.log("initRepresentationsStart",(0,u.YO)({initialVideo:e,initialAudio:t,sourceHls:i})),this.representationSubscription.unsubscribe(),this.state$.startTransitionTo("representations_ready");let s={fetcher:this.fetcher,tuning:this.tuning,getCurrentPosition:()=>this.element?1e3*this.element.currentTime:void 0,isActiveLowLatency:()=>this.isActiveLive$.getValue()&&this.isLowLatency$.getValue(),manifest:this.manifest};this.createBuffers(s,e,t,i),this.initRepresentationSubscriptions(),yield this.waitStreamToOpen(),this.setSourceDuration(),(0,u.tZ)(this.videoBufferManager),yield Promise.all([this.videoBufferManager.startWith(e),t?this.audioBufferManager?.startWith(t):Promise.resolve()]),this.state$.setState("representations_ready"),this.tracer.log("initRepresentationsEnd")}.bind(this)),this.fetchManifest=(0,u.ZC)(this.destroyController.signal,async function*(){try{return yield this.fetcher.fetchManifest(this.manifestUrlString)}catch(e){(0,u.wD)(this.manifest)&&!this.bufferLength$.getValue()&&this.error$.next({id:"LoadManifest",category:u.h.NETWORK,message:"Failed to load manifest",thrown:e})}}.bind(this)),this.throughputEstimator=e.throughputEstimator,this.tuning=e.tuning,this.tracer=e.tracer.createComponentTracer(this.constructor.name),this.forceVideoCodec=e.forceVideoCodec,this.fetcher=new Na({throughputEstimator:this.throughputEstimator,requestQuic:this.tuning.requestQuick,compatibilityMode:e.compatibilityMode,tracer:this.tracer,useEnableSubtitlesParam:e.tuning.useEnableSubtitlesParam}),this.subscription.add(this.fetcher.recoverableError$.subscribe(this.fetcherRecoverableError$)),this.subscription.add(this.fetcher.error$.subscribe(this.fetcherError$)),this.initTracerSubscription()}},oo=class extends no{prepareManifestUrlString(e,t){return e}initRepresentationSubscriptions(){super.initRepresentationSubscriptions(),this.initDisableStallWatchdogSubscription(),this.initEndOfVideoSubscription()}setSourceDuration(){(0,u.tZ)(this.manifest),(0,u.tZ)(this.source);let e=[this.manifest.duration??0,...(0,Ta.default)((0,Ta.default)([...this.manifest.streams.audio,...this.manifest.streams.video],(e=>e.representations)),(e=>{let t=[];return e.duration&&t.push(e.duration),ha(e.segmentReference)&&e.segmentReference.totalSegmentsDurationMs&&t.push(e.segmentReference.totalSegmentsDurationMs),t}))];this.source.duration=Math.max(...e)/1e3}async restoreAfterDeepStall(e){(0,u.tZ)(this.element);let t=1e3*this.element.currentTime;await Promise.all([this.videoBufferManager?.maintain(t),this.audioBufferManager?.maintain(t)]),e.position=t}initDisableStallWatchdogSubscription(){(0,u.tZ)(this.element);let e=(0,u.h1)((0,u.Rt)(this.element,"ended"),this.forceEnded$),t=this.nativeBufferLength$.pipe((0,u.pb)((e=>e>this.tuning.dash.bufferEmptinessTolerance)));this.representationSubscription.add((0,u.h1)(e,t).subscribe((e=>this.stopStallWatchdogSubscription())))}initEndOfVideoSubscription(){let e=(0,u.h1)(...this.bufferManagers.map((e=>e.fullyBuffered$))).pipe((0,u.Tj)((()=>this.bufferManagers.every((e=>e.fullyBuffered$.getValue()))))),t=(0,u.h1)(...this.bufferManagers.map((e=>e.onLastSegment$))).pipe((0,u.Tj)((()=>this.bufferManagers.some((e=>e.onLastSegment$.getValue()))))),i=(0,u.kg)({allBuffersFull:e,someBufferEnded:t}).pipe((0,u.jX)(),(0,u.Tj)((({allBuffersFull:e,someBufferEnded:t})=>e&&t)),(0,u.pb)((e=>e)));this.representationSubscription.add((0,u.h1)(this.forceEnded$,i).pipe((0,u.pb)((e=>(0,u.R)(this.source)&&"open"===this.source.readyState&&Array.from(this.source.sourceBuffers).every((e=>!e.updating))))).subscribe((()=>{try{this.source?.endOfStream()}catch(e){this.error$.next({id:"EndOfStream",category:u.h.VIDEO_PIPELINE,message:"Failed to end MediaSource stream",thrown:e})}})))}constructor(e){super(e)}},uo=class extends wa{subscribe(){super.subscribe();let{output:e,observableVideo:t,connect:i,genericErrorListener:s}=this.getProviderSubscriptionInfo();i(t.timeUpdate$,e.position$),i(t.durationChange$,e.duration$),this.subscription.add(this.player.currentVideoRepresentation$.pipe((0,u.jX)()).subscribe((t=>{let i=[...this.videoTracksMap.entries()].find((([,{representation:e}])=>e.id===t));if(!i)return e.currentVideoTrack$.next(void 0),void e.currentVideoStream$.next(void 0);let[s,{stream:r}]=i,a=this.params.desiredState.videoStream.getTransition();a&&a.to&&a.to.id===r.id&&this.params.desiredState.videoStream.setState(a.to),e.currentVideoTrack$.next(s),e.currentVideoStream$.next(ua(r));let n=this.player.calculateDurationFromSegments();n&&this.params.output.duration$.next(n/1e3)}),s))}getPlayer(){return new oo({throughputEstimator:this.params.dependencies.throughputEstimator,tuning:this.params.tuning,compatibilityMode:this.params.source.compatibilityMode,tracer:this.tracer,forceVideoCodec:this.params.forceVideoCodec})}seek(e,t){this.params.output.willSeekEvent$.next(),this.player.seek(e,t)}},ho=g(Oe(),1),lo=g(gi(),1),co=(e,t,i=0)=>{for(let s=0;s<e.length;s++)if(1e3*e.start(s)-i<=t&&1e3*e.end(s)+i>t)return!0;return!1},po=g(Oe(),1),fo=g(ni(),1),mo=g(gi(),1),go=g(ii(),1),bo=!1;try{bo=ks.browser.isSafari&&!!ks.browser.safariVersion&&ks.browser.safariVersion<=18}catch(zr){console.error(zr)}var vo=class{async append(e,t){return(!t||!t.aborted)&&new Promise((i=>{let s={operation:"append",data:e,signal:t,callback:i};this.queue.push(s),this.pull()}))}async remove(e,t,i){return(!i||!i.aborted)&&new Promise((s=>{let r={operation:"remove",from:e,to:t,signal:i,callback:s};this.queue.unshift(r),this.pull()}))}async abort(e){return new Promise((t=>{let i,s=e=>{this.abortRequested=!1,t(e)};i=bo&&e?{operation:"safariAbort",init:e,callback:s}:{operation:"abort",callback:s};for(let{callback:e}of this.queue)e(!1);this.abortRequested=!0,i&&(this.queue=[i]),this.pull()}))}destroy(){this.destroyed=!0,this.buffer.removeEventListener("updateend",this.completeTask),this.queue=[],this.currentTask=null;try{this.buffer.abort()}catch(e){if(!(e instanceof DOMException&&"InvalidStateError"===e.name))throw e}}pull(){if((this.buffer.updating||this.currentTask||this.destroyed)&&!this.abortRequested)return;let e=this.isAbortFixEnabled?this.queue[0]:this.queue.shift();if(!e)return;if(e.signal?.aborted)return e.callback(!1),void this.pull();this.currentTask=e;let{operation:t}=this.currentTask;try{this.execute(this.currentTask)}catch(e){e instanceof DOMException&&"QuotaExceededError"===e.name&&"append"===t?this.bufferFull$.next(this.currentTask.data.byteLength):e instanceof DOMException&&"InvalidStateError"===e.name||this.error$.next({id:`BufferTaskQueue:${t}`,category:u.h.VIDEO_PIPELINE,message:"Buffer operation failed",thrown:e}),this.currentTask.callback(!1),this.currentTask=null}this.currentTask&&"abort"===this.currentTask.operation&&this.completeTask()}execute(e){let{operation:t}=e;switch(t){case"append":this.buffer.appendBuffer(e.data);break;case"remove":this.buffer.remove(e.from/1e3,e.to/1e3);break;case"abort":this.buffer.abort();break;case"safariAbort":this.buffer.abort(),this.buffer.appendBuffer(e.init);break;default:(0,u.xb)(t)}}constructor(e,t=!1){this.bufferFull$=new u.B7,this.error$=new u.B7,this.queue=[],this.currentTask=null,this.destroyed=!1,this.abortRequested=!1,this.isAbortFixEnabled=!1,this.completeTask=()=>{try{if(this.currentTask){let e=this.currentTask.signal?.aborted;this.currentTask.callback(!e),this.currentTask=null,this.isAbortFixEnabled&&this.queue.shift()}this.queue.length&&this.pull()}catch(e){this.error$.next({id:"BufferTaskQueueUnknown",category:u.h.VIDEO_PIPELINE,message:"Buffer appending or removal failed",thrown:e})}},this.buffer=e,this.isAbortFixEnabled=t,this.buffer.addEventListener("updateend",this.completeTask)}},yo=e=>{let t=0;for(let i=0;i<e.length;i++)t+=e.end(i)-e.start(i);return 1e3*t},So=class{switchToWithPreviousAbort(e,t=!1){!qr(this.mediaSource,this.sourceBuffer)||e===this.downloadingRepresentationId||e===this.switchingToRepresentationId||(this.switchAbortController.abort(),this.switchAbortController=new Ca,(0,u.ZC)(this.switchAbortController.signal,async function*(e,t=!1){this.switchingToRepresentationId=e;let i=this.representations.get(e);(0,u.tZ)(i,`No such representation ${e}`);let s=this.segments.get(e),r=this.initData.get(e);if((0,u.wD)(r)||(0,u.wD)(s)?yield this.loadInit(i,"high",!1):r instanceof Promise&&(yield r),s=this.segments.get(e),(0,u.tZ)(s,"No segments for starting representation"),r=this.initData.get(e),r instanceof ArrayBuffer&&this.sourceBuffer&&qr(this.mediaSource,this.sourceBuffer)){if(yield this.abort(),yield this.sourceBufferTaskQueue.append(r,this.downloadAbortController.signal),t)this.switchingToRepresentationId=void 0,this.downloadingRepresentationId=e,yield this.dropBuffer();else{let t=this.getCurrentPosition();(0,u.R)(t)&&!this.isLive&&(this.bufferLimit=this.forwardBufferTarget,yield this.pruneBuffer(t,1/0,!0)),this.downloadingRepresentationId=e,this.switchingToRepresentationId=void 0}this.maintain()}}.bind(this))(e,t))}warmUpMediaSource(){!(0,u.wD)(this.sourceBuffer)&&!this.sourceBuffer.updating&&(this.sourceBuffer.mode="segments")}async abort(){for(let e of this.activeSegments)this.abortSegment(e.segment);return this.activeSegments.clear(),this.downloadAbortController.abort(),this.downloadAbortController=new Ca,this.abortBuffer()}maintain(e=this.getCurrentPosition()){if((0,u.wD)(e)||(0,u.wD)(this.downloadingRepresentationId)||(0,u.wD)(this.playingRepresentationId)||(0,u.wD)(this.sourceBuffer)||!qr(this.mediaSource,this.sourceBuffer)||(0,u.R)(this.switchingToRepresentationId)||this.isSeekingLive)return;let t=this.representations.get(this.downloadingRepresentationId),i=this.representations.get(this.playingRepresentationId),s=this.segments.get(this.downloadingRepresentationId),r=this.segments.get(this.playingRepresentationId);if((0,u.tZ)(t,`No such representation ${this.downloadingRepresentationId}`),(0,u.tZ)(i,`No such representation ${this.playingRepresentationId}`),(0,u.wD)(s)||(0,u.wD)(r))return;let a=s.find((t=>e>=t.time.from&&e<t.time.to));(0,u.R)(a)&&isFinite(a.time.from)&&isFinite(a.time.to)&&this.currentSegmentLength$.next(a?.time.to-a.time.from);let n=e;if(this.playingRepresentationId!==this.downloadingRepresentationId){let s=this.getForwardBufferDuration(e),r=Nn(i),o=Nn(t),h=this.useSmartRepresentationSwitch&&this.tuning.dash.useNewRepresentationSwitch&&this.tuning.dash.useSmartRepresentationSwitch&&(0,u.R)(r)&&(0,u.R)(o)&&(0,u.kW)(r.quality,o.quality),d=this.useSmartRepresentationSwitch&&this.tuning.dash.useNewRepresentationSwitch&&this.tuning.dash.useDelayedRepresentationSwitch;if(h||d?n+=Math.min(s,this.tuning.dash.representationSwitchForwardBufferGap):a&&a.time.to-e<this.tuning.dash.maxSegmentDurationLeftToSelectNextSegment&&s>=a.time.to-e+100&&(n=a?a.time.to+100:-1/0),this.tuning.dash.useNewRepresentationSwitch){let t=[...this.segments.entries()].map((([t,i])=>{let s=i.find((t=>e>=t.time.from&&e<t.time.to));return{representationId:t,status:s?.status}})).find((e=>"fed"===e.status))?.representationId;t&&(this.playingRepresentationId=t,this.playingRepresentation$.next(this.playingRepresentationId),this.playingRepresentationInit$.next(this.parsedInitData.get(this.playingRepresentationId)))}}if(isFinite(this.bufferLimit)&&yo(this.sourceBuffer.buffered)>=this.bufferLimit){let t=this.getForwardBufferDuration(e),i=Math.min(this.forwardBufferTarget,this.bufferLimit)*this.tuning.dash.minSafeBufferThreshold;return void this.pruneBuffer(e,1/0,t<i).catch((e=>{this.handleAsyncError(e,"pruneBuffer")}))}let o=[];if(!this.activeSegments.size&&(o=this.selectForwardBufferSegments(s,t.segmentReference.type,n),o.length)){let e="auto";if(this.tuning.dash.useFetchPriorityHints&&a)if((0,po.default)(o,a))e="high";else{let t=(0,fo.default)(o,0);t&&t.time.from-a.time.to>=this.forwardBufferTarget/2&&(e="low")}this.loadSegments(o,t,e).catch((e=>{this.handleAsyncError(e,"loadSegments")}))}(!this.preloadOnly&&!this.allInitsLoaded&&a&&"fed"===a.status&&!o.length&&this.getForwardBufferDuration(e)>3e3||this.isActiveLowLatency())&&this.loadNextInit();let h=(0,fo.default)(s,-1);!this.isLive&&h&&(this.fullyBuffered$.next(h.time.to-e-this.getForwardBufferDuration(e)<100),this.onLastSegment$.next(e-h.time.from>0))}get lastDataObtainedTimestamp(){return this.lastDataObtainedTimestampMs}searchGaps(e,t){this.gaps=[];let i=0,s=this.isLive?this.liveInitialAdditionalOffset:0;for(let r of e)Math.trunc(r.time.from-i)>0&&this.gaps.push({representation:t.id,from:i,to:r.time.from+s,persistent:!0}),i=r.time.to;(0,u.R)(t.duration)&&t.duration-i>0&&!this.isLive&&this.gaps.push({representation:t.id,from:i,to:t.duration,persistent:!0})}getActualLiveStartingSegments(e){let t=e.segments,i=this.isActiveLowLatency()?this.tuning.dashCmafLive.lowLatency.maxTargetOffset:this.tuning.dashCmafLive.maxActiveLiveOffset,s=[],r=0,a=t.length-1;do{s.unshift(t[a]),r+=t[a].time.to-t[a].time.from,a--}while(r<i&&a>=0);return this.liveInitialAdditionalOffset=r-i,this.isActiveLowLatency()?[s[0]]:s}getLiveSegmentsToLoadState(e){let t=e?.streams[this.kind];if(!t)return;let i=(0,mo.default)(t,(e=>e.representations)).find((e=>e.id===this.downloadingRepresentationId));if(!i)return;let s=this.segments.get(i.id);return s?.length?{from:s[0].time.from,to:s[s.length-1].time.to}:void 0}updateLive(e){if(!e||[...this.segments.values()].every((e=>!e.length)))return;let t=(0,mo.default)(e.streams[this.kind],(e=>e.representations));for(let e of t){if(!e||!Wn(e.segmentReference))return;let t=e.segmentReference.segments.map((e=>({...e,status:"none",size:void 0}))),i=100,s=this.segments.get(e.id)??[],r=(0,fo.default)(s,-1)?.time.to??0,a=t?.findIndex((e=>r>=e.time.from+i&&r<=e.time.to+i));if(-1===a){this.liveUpdateSegmentIndex=0;let t=this.getActualLiveStartingSegments(e.segmentReference);this.segments.set(e.id,t)}else{let i=t.slice(a+1);this.segments.set(e.id,[...s,...i])}}}proceedLowLatencyLive(){let e=this.downloadingRepresentationId;(0,u.tZ)(e);let t=this.segments.get(e);if(t?.length){let e=t[t.length-1];this.updateLowLatencyLiveIfNeeded(e)}}calculateDurationFromSegments(){if(!this.playingRepresentationId)return 0;let e=this.segments.get(this.playingRepresentationId);return(e?(0,fo.default)(e,-1)?.time.to:0)||0}setSmartRepresentationSwitch(e){this.useSmartRepresentationSwitch=e}updateLowLatencyLiveIfNeeded(e){let t=0;for(let i of this.representations.values()){let s=i.segmentReference;if(!Wn(s))return;let r=this.segments.get(i.id)??[],a=r.find((t=>Math.floor(t.time.from)===Math.floor(e.time.from)));if(a&&!isFinite(a.time.to)&&(a.time.to=e.time.to,t=a.time.to-a.time.from),!r.find((t=>Math.floor(t.time.from)===Math.floor(e.time.to)))&&this.isActiveLowLatency()){let t=Math.round(e.time.to*s.timescale/1e3).toString(10),i=Ja(s.segmentTemplateUrl,{segmentTime:t});r.push({status:"none",time:{from:e.time.to,to:1/0},url:i})}}this.currentLowLatencySegmentLength$.next(t)}findSegmentStartTime(e){let t=this.switchingToRepresentationId??this.downloadingRepresentationId??this.playingRepresentationId;if(!t)return;let i=this.segments.get(t);return i?i.find((t=>t.time.from<=e&&t.time.to>=e))?.time.from??void 0:void 0}setTarget(e){this.forwardBufferTarget=e}setPreloadOnly(e){this.preloadOnly=e}destroy(){if(this.initData.clear(),this.segments.clear(),this.parsedInitData.clear(),this.representations.clear(),this.sourceBufferTaskQueue?.destroy(),this.gapDetectionIdleCallback&&bn&&bn(this.gapDetectionIdleCallback),this.initLoadIdleCallback&&bn&&bn(this.initLoadIdleCallback),this.subscription.unsubscribe(),this.sourceBuffer)try{this.mediaSource.removeSourceBuffer(this.sourceBuffer)}catch(e){if(!(e instanceof DOMException&&"NotFoundError"===e.name))throw e}this.sourceBuffer=null,this.downloadAbortController.abort(),this.switchAbortController.abort(),this.destroyAbortController.abort(),window.clearTimeout(this.loadByteRangeSegmentsTimeoutId)}selectForwardBufferSegments(e,t,i){return this.isLive?this.selectForwardBufferSegmentsLive(e,i):this.selectForwardBufferSegmentsRecord(e,t,i)}selectForwardBufferSegmentsLive(e,t){let i=e.findIndex((e=>t>=e.time.from&&t<e.time.to));return this.playingRepresentationId!==this.downloadingRepresentationId&&(this.liveUpdateSegmentIndex=i),this.liveUpdateSegmentIndex<e.length?e.slice(this.liveUpdateSegmentIndex++):[]}selectForwardBufferSegmentsRecord(e,t,i){let s=this.getForwardBufferDuration(i),r=e.findIndex((({status:e,time:{from:t,to:r}},a)=>{let n=t>i||t<=i&&r>=i||0===a&&0===i,o=Math.min(this.forwardBufferTarget,this.bufferLimit),u=this.preloadOnly&&t<=i+o||s<o&&r-t>=o||r<=i+o;return("none"===e||"partially_ejected"===e&&n&&u&&this.sourceBuffer&&qr(this.mediaSource,this.sourceBuffer)&&!(co(this.sourceBuffer.buffered,t)&&co(this.sourceBuffer.buffered,r)))&&n&&u}));if(-1===r)return[];if("byteRange"!==t)return e.slice(r,r+1);let a=e,n=0,o=0,u=[],h=this.preloadOnly?0:this.tuning.dash.segmentRequestSize,d=this.preloadOnly?this.forwardBufferTarget:0;for(let e=r;e<a.length&&(n<=h||o<=d);e++){let t=a[e];if(n+=t.byte.to+1-t.byte.from,o+=t.time.to+1-t.time.from,"none"!==t.status&&"partially_ejected"!==t.status)break;u.push(t)}return u}async loadSegments(e,t,i="auto"){Wn(t.segmentReference)?await this.loadTemplateSegment(e[0],t,i):await this.loadByteRangeSegments(e,t,i)}async loadTemplateSegment(e,t,i="auto"){e.status="downloading";let s={segment:e,loadedBytes:0,feedingBytes:0,fedBytes:0,representationId:t.id};this.activeSegments.add(s);let{range:r,url:a,signal:n,onProgress:o,onProgressTasks:h}=this.prepareTemplateFetchSegmentParams(e,t);this.failedDownloads&&n&&(await(0,u.ZC)(n,async function*(){let e=(0,u.rX)(this.failedDownloads,this.tuning.downloadBackoff);yield new Promise((t=>setTimeout(t,e)))}.bind(this))(),n.aborted&&this.abortActiveSegments([e]));try{let e=await this.fetcher.fetch(a,{range:r,signal:n,onProgress:o,priority:i,isLowLatency:this.isActiveLowLatency(),bufferOptimisation:this.tuning.dash.fetcherBufferOptimisation});if(this.lastDataObtainedTimestampMs=(0,u.tB)(),!e)return;let d=new DataView(e),l=_n(t.mime);if(!isFinite(s.segment.time.to)){let e=t.segmentReference.timescale;s.segment.time.to=l.getChunkEndTime(d,e)}o&&s.feedingBytes&&h?await Promise.all(h):await this.sourceBufferTaskQueue.append(d,n);let{serverDataReceivedTimestamp:c,serverDataPreparedTime:p}=l.getServerLatencyTimestamps(d);c&&p&&this.currentLiveSegmentServerLatency$.next(p-c),s.segment.status="downloaded",this.onSegmentFullyAppended(s,t.id),this.failedDownloads=0}catch(t){this.abortActiveSegments([e]),_a(t)||(this.failedDownloads++,this.updateRepresentationsBaseUrlIfNeeded())}}updateRepresentationsBaseUrlIfNeeded(){if(!this.tuning.dash.enableBaseUrlSupport||!this.baseUrls.length||this.failedDownloads<=this.tuning.dash.maxSegmentRetryCount)return;this.baseUrlsIndex=(this.baseUrlsIndex+1)%this.baseUrls.length;let e=this.baseUrls[this.baseUrlsIndex];for(let t of this.representations.values())Wn(t.segmentReference)?t.segmentReference.baseUrl=e:t.segmentReference.url=e}async loadByteRangeSegments(e,t,i="auto"){if(!e.length)return;for(let i of e)i.status="downloading",this.activeSegments.add({segment:i,loadedBytes:0,feedingBytes:0,fedBytes:0,representationId:t.id});let{range:s,url:r,signal:a,onProgress:n}=this.prepareByteRangeFetchSegmentParams(e,t);this.failedDownloads&&a&&(await(0,u.ZC)(a,async function*(){let e=(0,u.rX)(this.failedDownloads,this.tuning.downloadBackoff);yield new Promise((t=>{this.loadByteRangeSegmentsTimeoutId=window.setTimeout(t,e),(0,u.Rt)(window,"online").pipe((0,u.Oo)()).subscribe((()=>{t(),window.clearTimeout(this.loadByteRangeSegmentsTimeoutId)}))}))}.bind(this))(),a.aborted&&this.abortActiveSegments(e));try{await this.fetcher.fetch(r,{range:s,onProgress:n,signal:a,priority:i,bufferOptimisation:this.tuning.dash.fetcherBufferOptimisation}),this.lastDataObtainedTimestampMs=(0,u.tB)(),this.failedDownloads=0}catch(t){this.abortActiveSegments(e),_a(t)||(this.failedDownloads++,this.updateRepresentationsBaseUrlIfNeeded())}}prepareByteRangeFetchSegmentParams(e,t){if(Wn(t.segmentReference))throw new Error("Representation is not byte range type");let i=t.segmentReference.url,s={from:(0,fo.default)(e,0).byte.from,to:(0,fo.default)(e,-1).byte.to},{signal:r}=this.downloadAbortController;return{url:i,range:s,signal:r,onProgress:async(e,i)=>{if(!r.aborted)try{this.lastDataObtainedTimestampMs=(0,u.tB)(),await this.onSomeByteRangesDataLoaded({dataView:e,loaded:i,signal:r,onSegmentAppendFailed:()=>this.abort(),globalFrom:s?s.from:0,representationId:t.id})}catch(e){this.error$.next({id:"SegmentFeeding",category:u.h.VIDEO_PIPELINE,message:"Error when feeding segments",thrown:e})}}}}prepareTemplateFetchSegmentParams(e,t){if(!Wn(t.segmentReference))throw new Error("Representation is not template type");let i=new URL(e.url,t.segmentReference.baseUrl);this.isActiveLowLatency()&&i.searchParams.set("low-latency","yes");let s=i.toString(),{signal:r}=this.downloadAbortController,a=[],n=this.isActiveLowLatency()||this.tuning.dash.enableSubSegmentBufferFeeding&&this.liveUpdateSegmentIndex<3?(e,i)=>{if(!r.aborted)try{this.lastDataObtainedTimestampMs=(0,u.tB)();let s=this.onSomeTemplateDataLoaded({dataView:e,loaded:i,signal:r,onSegmentAppendFailed:()=>this.abort(),representationId:t.id});a.push(s)}catch(e){this.error$.next({id:"SegmentFeeding",category:u.h.VIDEO_PIPELINE,message:"Error when feeding segments",thrown:e})}}:void 0;return{url:s,signal:r,onProgress:n,onProgressTasks:a}}abortActiveSegments(e){for(let t of this.activeSegments)(0,po.default)(e,t.segment)&&this.abortSegment(t.segment)}async onSomeTemplateDataLoaded({dataView:e,representationId:t,loaded:i,onSegmentAppendFailed:s,signal:r}){if(!this.activeSegments.size||!qr(this.mediaSource,this.sourceBuffer))return;let a=this.representations.get(t);if(a)for(let n of this.activeSegments){let{segment:o}=n;if(n.representationId===t){if(r.aborted){s();continue}if(n.loadedBytes=i,n.loadedBytes>n.feedingBytes){let t=new DataView(e.buffer,e.byteOffset+n.feedingBytes,n.loadedBytes-n.feedingBytes),i=_n(a.mime).parseFeedableSegmentChunk(t,this.isLive);i?.byteLength&&(o.status="partially_fed",n.feedingBytes+=i.byteLength,await this.sourceBufferTaskQueue.append(i),n.fedBytes+=i.byteLength)}}}}async onSomeByteRangesDataLoaded({dataView:e,representationId:t,globalFrom:i,loaded:s,signal:r,onSegmentAppendFailed:a}){if(!this.activeSegments.size||!qr(this.mediaSource,this.sourceBuffer))return;let n=this.representations.get(t);if(n)for(let o of this.activeSegments){let{segment:u}=o;if(o.representationId!==t)continue;if(r.aborted){await a();continue}let h=u.byte.from-i,d=u.byte.to-i,l=d-h+1,c=d<=s;if(!(h<s))continue;let p=_n(n.mime);if("downloading"===u.status&&c){u.status="downloaded";let i=new DataView(e.buffer,e.byteOffset+h,l);await this.sourceBufferTaskQueue.append(i,r)&&!r.aborted?this.onSegmentFullyAppended(o,t):await a()}else if(this.tuning.dash.enableSubSegmentBufferFeeding&&("downloading"===u.status||"partially_fed"===u.status)&&(o.loadedBytes=Math.min(l,s-h),o.loadedBytes>o.feedingBytes)){let i=new DataView(e.buffer,e.byteOffset+h+o.feedingBytes,o.loadedBytes-o.feedingBytes),s=o.loadedBytes===l?i:p.parseFeedableSegmentChunk(i);s?.byteLength&&(u.status="partially_fed",o.feedingBytes+=s.byteLength,await this.sourceBufferTaskQueue.append(s,r)&&!r.aborted?(o.fedBytes+=s.byteLength,o.fedBytes===l&&this.onSegmentFullyAppended(o,t)):await a())}}}onSegmentFullyAppended(e,t){if(!(0,u.wD)(this.sourceBuffer)&&qr(this.mediaSource,this.sourceBuffer)){!this.isLive&&ks.browser.isSafari&&this.tuning.useSafariEndlessRequestBugfix&&(co(this.sourceBuffer.buffered,e.segment.time.from,100)&&co(this.sourceBuffer.buffered,e.segment.time.to,100)||this.error$.next({id:"EmptyAppendBuffer",category:u.h.VIDEO_PIPELINE,message:"Browser stuck on empty result of adding segment to source buffer"})),this.tuning.dash.useNewRepresentationSwitch||(this.playingRepresentationId=t,this.playingRepresentation$.next(this.playingRepresentationId),this.playingRepresentationInit$.next(this.parsedInitData.get(this.playingRepresentationId))),e.segment.status="fed",Hn(e.segment)&&(e.segment.size=e.fedBytes);for(let i of this.representations.values())if(i.id!==t)for(let t of this.segments.get(i.id)??[])"fed"===t.status&&Math.round(t.time.from)===Math.round(e.segment.time.from)&&Math.round(t.time.to)===Math.round(e.segment.time.to)&&(t.status="none");this.updateLowLatencyLiveIfNeeded(e.segment),this.activeSegments.delete(e),this.detectGapsWhenIdle(t,[e.segment])}}abortSegment(e){"partially_fed"===e.status?e.status="partially_ejected":"partially_ejected"!==e.status&&(e.status="none");for(let t of this.activeSegments.values())if(t.segment===e){this.activeSegments.delete(t);break}}loadNextInit(){if(this.allInitsLoaded||this.initLoadIdleCallback)return;let e=null,t=!1;for(let[i,s]of this.initData.entries()){t||(t=s instanceof Promise),null===s&&(e=i)}if(!e)return void(this.allInitsLoaded=!0);if(t)return;let i=this.representations.get(e);i&&(this.initLoadIdleCallback=gn((()=>(0,go.default)(this.loadInit(i,"low",!1),(()=>this.initLoadIdleCallback=null)))))}async loadInit(e,t="auto",i=!1){let s=this.tuning.dash.useFetchPriorityHints?t:"auto",r=!i&&this.tuning.dash.ignoreNetworkErrorsOnLoadInit,a=(!i&&this.failedDownloads>0?(0,u.ZC)(this.destroyAbortController.signal,async function*(){let e=(0,u.rX)(this.failedDownloads,this.tuning.downloadBackoff);yield new Promise((t=>setTimeout(t,e)))}.bind(this))():Promise.resolve()).then((()=>this.fetcher.fetchRepresentation(e.segmentReference,_n(e.mime),{priority:s,ignoreNetworkErrors:r}))).then((async t=>{if(!t)return;let{init:i,dataView:s,segments:r}=t,a=s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength);this.initData.set(e.id,a);let n=r;this.isLive&&Wn(e.segmentReference)&&(n=this.getActualLiveStartingSegments(e.segmentReference)),(!this.isLive||!this.segments.has(e.id))&&this.segments.set(e.id,n),i&&this.parsedInitData.set(e.id,i)})).then((()=>this.failedDownloads=0),(t=>{r||this.initData.set(e.id,null),i&&this.error$.next({id:"LoadInits",category:u.h.WTF,message:"loadInit threw",thrown:t})}));return this.initData.set(e.id,a),a}async dropBuffer(){for(let e of this.segments.values())for(let t of e)t.status="none";await this.pruneBuffer(0,1/0,!0)}async pruneBuffer(e,t,i=!1){if(!this.sourceBuffer||!qr(this.mediaSource,this.sourceBuffer)||!this.playingRepresentationId||(0,u.wD)(e))return!1;let s=[],r=0,a=e=>{if(r>=t)return s;s.push({...e.time}),s=(e=>{e.sort(((e,t)=>e.from-t.from));let t=[e[0]];for(let i=1;i<e.length;i++){let{from:s,to:r}=e[i],a=t[t.length-1];a.to>=s?a.to=Math.max(a.to,r):t.push(e[i])}return t})(s);let i=Hn(e)?e.size??0:e.byte.to-e.byte.from;r+=i};for(let t of this.segments.values())for(let i of t){let t=i.time.to<=e-this.tuning.dash.bufferPruningSafeZone,s=i.time.from>=e+Math.min(this.forwardBufferTarget,this.bufferLimit);(t||s)&&"fed"===i.status&&a(i)}for(let e=0;e<this.sourceBuffer.buffered.length;e++){let t=1e3*this.sourceBuffer.buffered.start(e),i=1e3*this.sourceBuffer.buffered.end(e),s=0;for(let e of this.segments.values())for(let r of e)(0,po.default)(["none","partially_ejected"],r.status)&&Math.round(r.time.from)<=Math.round(t)&&Math.round(r.time.to)>=Math.round(i)&&s++;if(s===this.segments.size){a({time:{from:t,to:i},url:"",status:"none"})}}if(s.length&&i){let t=Math.min(this.forwardBufferTarget,this.bufferLimit)*this.tuning.dash.minSafeBufferThreshold;for(let i of this.segments.values())for(let s of i)s.time.from>=e+t&&"fed"===s.status&&a(s)}return!!s.length&&(await Promise.all(s.map((e=>this.sourceBufferTaskQueue.remove(e.from,e.to))))).reduce(((e,t)=>e||t),!1)}async abortBuffer(){if(!this.sourceBuffer||!qr(this.mediaSource,this.sourceBuffer))return!1;let e=this.playingRepresentationId&&this.initData.get(this.playingRepresentationId),t=e instanceof ArrayBuffer?e:void 0;return this.sourceBufferTaskQueue.abort(t)}getDebugBufferState(){if(this.sourceBuffer&&qr(this.mediaSource,this.sourceBuffer)&&this.sourceBuffer.buffered.length)return{from:this.sourceBuffer.buffered.start(0),to:this.sourceBuffer.buffered.end(this.sourceBuffer.buffered.length-1)}}getForwardBufferDuration(e=this.getCurrentPosition()){return this.sourceBuffer&&qr(this.mediaSource,this.sourceBuffer)&&this.sourceBuffer.buffered.length&&!(0,u.wD)(e)?io(this.sourceBuffer.buffered,e):0}detectGaps(e,t){if(this.sourceBuffer&&qr(this.mediaSource,this.sourceBuffer))for(let i of t){let t={representation:e,from:i.time.from,to:i.time.to,persistent:!1},{buffered:s}=this.sourceBuffer;for(let e=0;e<s.length;e++){let r=1e3*s.start(e),a=1e3*s.end(e);if(!(a<=i.time.from||r>=i.time.to)){if(r<=i.time.from&&a>=i.time.to){t=void 0;break}a>i.time.from&&a<i.time.to&&(t.from=a),r<i.time.to&&r>i.time.from&&(t.to=r)}}t&&t.to-t.from>1&&!this.gaps.some((e=>t&&e.from===t.from&&e.to===t.to))&&this.gaps.push(t)}}detectGapsWhenIdle(e,t){if(this.gapDetectionIdleCallback||!this.sourceBuffer||!qr(this.mediaSource,this.sourceBuffer))return;let{buffered:i}=this.sourceBuffer,{usePersistentGaps:s}=this.tuning.dash;this.gaps=this.gaps.filter((e=>{if(s&&e.persistent)return!0;let t=Math.round(e.from),r=Math.round(e.to);for(let e=0;e<i.length;e++)if(t>=Math.round(1e3*i.start(e))&&r<=Math.round(1e3*i.end(e)))return!1;return!0})),this.gapDetectionIdleCallback=gn((()=>{try{this.detectGaps(e,t)}catch(e){this.error$.next({id:"GapDetection",category:u.h.WTF,message:"detectGaps threw",thrown:e})}finally{this.gapDetectionIdleCallback=null}}))}checkEjectedSegments(){if((0,u.wD)(this.sourceBuffer)||!qr(this.mediaSource,this.sourceBuffer)||(0,u.wD)(this.playingRepresentationId))return;let e=[];for(let t=0;t<this.sourceBuffer.buffered.length;t++){let i=Math.floor(1e3*this.sourceBuffer.buffered.start(t)),s=Math.ceil(1e3*this.sourceBuffer.buffered.end(t));e.push({from:i,to:s})}let t=100;for(let i of this.segments.values())for(let s of i){let{status:i}=s;if("fed"!==i&&"partially_ejected"!==i)continue;let r=Math.floor(s.time.from),a=Math.ceil(s.time.to),n=e.some((e=>e.from-t<=r&&e.to+t>=a)),o=e.filter((e=>r>=e.from&&r<e.to-t||a>e.from+t&&a<=e.to));n||(1===o.length||this.gaps.some((e=>e.from===s.time.from||e.to===s.time.to))?s.status="partially_ejected":s.status="none")}}handleAsyncError(e,t){this.error$.next({id:t,category:u.h.VIDEO_PIPELINE,thrown:e,message:"Something went wrong"})}constructor(e,t,i,{fetcher:s,tuning:r,getCurrentPosition:a,isActiveLowLatency:n,compatibilityMode:o=!1,manifest:h}){this.currentLiveSegmentServerLatency$=new u.Ot(0),this.currentLowLatencySegmentLength$=new u.Ot(0),this.currentSegmentLength$=new u.Ot(0),this.onLastSegment$=new u.Ot(!1),this.fullyBuffered$=new u.Ot(!1),this.playingRepresentation$=new u.Ot(void 0),this.playingRepresentationInit$=new u.Ot(void 0),this.error$=new u.B7,this.gaps=[],this.subscription=new u.yU,this.allInitsLoaded=!1,this.activeSegments=new Set,this.downloadAbortController=new Ca,this.switchAbortController=new Ca,this.destroyAbortController=new Ca,this.useSmartRepresentationSwitch=!1,this.bufferLimit=1/0,this.failedDownloads=0,this.baseUrls=[],this.baseUrlsIndex=0,this.isLive=!1,this.liveUpdateSegmentIndex=0,this.liveInitialAdditionalOffset=0,this.isSeekingLive=!1,this.index=0,this.lastDataObtainedTimestampMs=0,this.loadByteRangeSegmentsTimeoutId=0,this.startWith=(0,u.ZC)(this.destroyAbortController.signal,async function*(e){let t=this.representations.get(e);(0,u.tZ)(t,`Cannot find representation ${e}`),this.playingRepresentationId=e,this.downloadingRepresentationId=e,this.sourceBuffer=this.mediaSource.addSourceBuffer(`${t.mime}; codecs="${t.codecs}"`),this.sourceBufferTaskQueue=new vo(this.sourceBuffer,this.tuning.dash.useAbortMSEFix),this.subscription.add((0,u.Rt)(this.sourceBuffer,"updateend").subscribe((()=>{this.checkEjectedSegments(),this.maintain()}),(e=>{let t,i=this.mediaSource.readyState;"open"!==i&&(t={id:`SegmentEjection_source_${i}`,category:u.h.VIDEO_PIPELINE,message:"Error when trying to clear segments ejected by browser",thrown:e}),t??(t={id:"SegmentEjection",category:u.h.VIDEO_PIPELINE,message:"Error when trying to clear segments ejected by browser",thrown:e}),this.error$.next(t)}))),this.subscription.add((0,u.Rt)(this.sourceBuffer,"error").subscribe((()=>this.error$.next({id:"SourceBuffer",category:u.h.VIDEO_PIPELINE,message:"SourceBuffer Error event fired"})))),this.subscription.add(this.sourceBufferTaskQueue.bufferFull$.subscribe((e=>{let t=this.getCurrentPosition();if(!this.sourceBuffer||!t||!qr(this.mediaSource,this.sourceBuffer))return;let i=Math.min(this.bufferLimit,.8*yo(this.sourceBuffer.buffered));this.bufferLimit=i;let s=this.getForwardBufferDuration(t),r=Math.min(this.forwardBufferTarget,this.bufferLimit)*this.tuning.dash.minSafeBufferThreshold;this.pruneBuffer(t,2*e,s<r).catch((e=>{this.handleAsyncError(e,"pruneBuffer")}))}))),this.subscription.add(this.sourceBufferTaskQueue.error$.subscribe((e=>this.error$.next(e)))),yield this.loadInit(t,"high",!0);let i=this.initData.get(t.id),s=this.segments.get(t.id),r=this.parsedInitData.get(t.id);(0,u.tZ)(i,"No init buffer for starting representation"),(0,u.tZ)(s,"No segments for starting representation"),i instanceof ArrayBuffer&&(this.searchGaps(s,t),yield this.sourceBufferTaskQueue.append(i,this.destroyAbortController.signal),this.playingRepresentation$.next(this.playingRepresentationId),this.playingRepresentationInit$.next(r))}.bind(this)),this.switchTo=(0,u.ZC)(this.destroyAbortController.signal,async function*(e,t=!1){if(!qr(this.mediaSource,this.sourceBuffer)||e===this.downloadingRepresentationId||e===this.switchingToRepresentationId)return;this.switchingToRepresentationId=e;let i=this.representations.get(e);(0,u.tZ)(i,`No such representation ${e}`);let s=this.segments.get(e),r=this.initData.get(e);if((0,u.wD)(r)||(0,u.wD)(s)?yield this.loadInit(i,"high",!1):r instanceof Promise&&(yield r),s=this.segments.get(e),(0,u.tZ)(s,"No segments for starting representation"),r=this.initData.get(e),r&&r instanceof ArrayBuffer&&this.sourceBuffer&&qr(this.mediaSource,this.sourceBuffer)){if(yield this.abort(),yield this.sourceBufferTaskQueue.append(r,this.downloadAbortController.signal),t)this.switchingToRepresentationId=void 0,this.downloadingRepresentationId=e,yield this.dropBuffer();else{let t=this.getCurrentPosition();(0,u.R)(t)&&!this.isLive&&(this.bufferLimit=1/0,await this.pruneBuffer(t,1/0,!0)),this.switchingToRepresentationId=void 0,this.downloadingRepresentationId=e}this.maintain()}}.bind(this)),this.switchToOld=(0,u.ZC)(this.destroyAbortController.signal,async function*(e,t=!1){if(!qr(this.mediaSource,this.sourceBuffer)||e===this.downloadingRepresentationId||e===this.switchingToRepresentationId)return;this.switchingToRepresentationId=e;let i=this.representations.get(e);(0,u.tZ)(i,`No such representation ${e}`);let s=this.segments.get(e),r=this.initData.get(e);if((0,u.wD)(r)||(0,u.wD)(s)?yield this.loadInit(i,"high",!1):r instanceof Promise&&(yield r),s=this.segments.get(e),(0,u.tZ)(s,"No segments for starting representation"),r=this.initData.get(e),r&&r instanceof ArrayBuffer&&this.sourceBuffer&&qr(this.mediaSource,this.sourceBuffer))if(yield this.abort(),yield this.sourceBufferTaskQueue.append(r,this.downloadAbortController.signal),t)this.switchingToRepresentationId=void 0,this.downloadingRepresentationId=e,yield this.dropBuffer(),this.maintain();else{let t=this.getCurrentPosition();(0,u.R)(t)&&(this.isLive||(this.bufferLimit=1/0,await this.pruneBuffer(t,1/0,!0)),this.maintain(t)),this.switchingToRepresentationId=void 0,this.downloadingRepresentationId=e}}.bind(this)),this.seekLive=(0,u.ZC)(this.destroyAbortController.signal,async function*(e){let t=(0,mo.default)(e,(e=>e.representations));if(!this.downloadingRepresentationId||!t.length)return;this.isSeekingLive=!0;for(let e of this.representations.keys()){let i=t.find((t=>t.id===e));i&&this.representations.set(e,i);let s=this.representations.get(e);if(!s||!Wn(s.segmentReference))return void(this.isSeekingLive=!1);let r=this.getActualLiveStartingSegments(s.segmentReference);this.segments.set(s.id,r)}let i=this.switchingToRepresentationId??this.downloadingRepresentationId,s=this.representations.get(i);(0,u.tZ)(s,`Representation not found by id ${i}`);let r=this.segments.get(i);(0,u.tZ)(r,"No segments for starting representation");let a=this.initData.get(i);if((0,u.tZ)(a,"No init buffer for starting representation"),!(a instanceof ArrayBuffer))return void(this.isSeekingLive=!1);let n=this.getDebugBufferState();this.liveUpdateSegmentIndex=0,yield this.abort(),n&&(yield this.sourceBufferTaskQueue.remove(1e3*n.from,1e3*n.to,this.destroyAbortController.signal)),this.searchGaps(r,s),yield this.sourceBufferTaskQueue.append(a,this.destroyAbortController.signal),this.isSeekingLive=!1}.bind(this)),this.fetcher=s,this.tuning=r,this.compatibilityMode=o,this.forwardBufferTarget=r.dash.forwardBufferTargetAuto,this.getCurrentPosition=a,this.isActiveLowLatency=n,this.isLive=!!h?.live,this.baseUrls=h?.baseUrls??[],this.initData=new Map(i.map((e=>[e.id,null]))),this.segments=new Map,this.parsedInitData=new Map,this.representations=new Map(i.map((e=>[e.id,e]))),this.kind=e,this.mediaSource=t,this.sourceBuffer=null}},wo=class{onHeadersReceived(e){let{type:t,reused:i}=Va(e);this.lastConnectionType$.next(t),this.lastConnectionReused$.next(i)}async fetchRepresentation(e,t,i){let{type:s}=e;switch(s){case"byteRange":return await this.fetchByteRangeRepresentation(e,t,i)??null;case"template":return await this.fetchTemplateRepresentation(e,i)??null;default:(0,u.xb)(s)}}destroy(){this.abortAllController.abort(),this.subscription.unsubscribe(),this.tracer.end()}async doFetch(e,t,i){let s=await Ma(e,t);if(s.ok)return s;if(i?.ignoreNetworkErrors)return;let r=await s.text(),a=parseInt(r);if(!isNaN(a))switch(a){case 1:this.recoverableError$.next({id:"VideoDataLinkExpiredError",message:"Video data links have expired",category:u.h.FATAL});break;case 8:this.recoverableError$.next({id:"VideoDataLinkBlockedForFloodError",message:"Url blocked for flood",category:u.h.FATAL});break;case 18:this.recoverableError$.next({id:"VideoDataLinkIllegalIpChangeError",message:"Client IP has changed",category:u.h.FATAL});break;case 21:this.recoverableError$.next({id:"VideoDataLinkIllegalHostChangeError",message:"Request HOST has changed",category:u.h.FATAL});break;default:this.error$.next({id:"GeneralVideoDataFetchError",message:`Generic video data fetch error (${a})`,category:u.h.FATAL})}}unsubscribeAbortSubscription(e){e&&(e.unsubscribe(),this.subscription.remove(e))}constructor({throughputEstimator:e,requestQuic:t,tracer:i,compatibilityMode:s=!1,useEnableSubtitlesParam:r=!1}){this.manifestRequested$=new u.B7,this.firstBytesManifest$=new u.B7,this.firstBytesRequested$=new u.B7,this.firstBytesReceived$=new u.B7,this.lastConnectionType$=new u.Ot(void 0),this.lastConnectionReused$=new u.Ot(void 0),this.lastRequestFirstBytes$=new u.Ot(void 0),this.recoverableError$=new u.B7,this.error$=new u.B7,this.abortAllController=new Ca,this.subscription=new u.V6,this.fetchManifest=(0,u.ZC)(this.abortAllController.signal,async function*(e){let t=this.tracer.createComponentTracer("FetchManifest"),i=e;this.requestQuic&&(i=Pa(i)),!this.compatibilityMode&&this.useEnableSubtitlesParam&&(i=Fa(i)),this.manifestRequested$.next();let s=yield this.doFetch(i,{signal:this.abortAllController.signal}).catch(To);return s?(t.log("success",(0,u.YO)({url:i,message:"Request successfully executed"})),t.end(),this.onHeadersReceived(s.headers),this.firstBytesManifest$.next(),s.text()):(t.error("error",(0,u.YO)({url:i,message:"No data in request manifest"})),t.end(),null)}.bind(this)),this.fetch=(0,u.ZC)(this.abortAllController.signal,async function*(e,{rangeMethod:t=(this.compatibilityMode?0:1),range:i,onProgress:s,priority:r="auto",signal:a,measureThroughput:n=!0,isLowLatency:o=!1,bufferOptimisation:h=!1,ignoreNetworkErrors:d=!1}={}){let l=e,c=new Headers,p=this.tracer.createComponentTracer("Fetch");if(i)switch(t){case 0:c.append("Range",`bytes=${i.from}-${i.to}`);break;case 1:{let e=new URL(l,location.href);e.searchParams.append("bytes",`${i.from}-${i.to}`),l=e.toString();break}default:(0,u.xb)(t)}this.requestQuic&&(l=Pa(l));let f,m=this.abortAllController.signal;if(a){let e=new Ca;if(f=(0,u.h1)((0,u.Rt)(this.abortAllController.signal,"abort"),(0,u.Rt)(a,"abort")).subscribe((()=>{try{e.abort()}catch(e){To(e)}})),this.subscription.add(f),this.abortAllController.signal.aborted||a.aborted)try{e.abort()}catch(e){To(e)}m=e.signal}let g=0,b=(0,u.tB)();p.log("startRequest",(0,u.YO)({url:l,priority:r,rangeMethod:t,range:i,isLowLatency:o,requestStartedAt:b})),this.firstBytesRequested$.next();let v=yield this.doFetch(l,{priority:r,headers:c,signal:m},{ignoreNetworkErrors:d}),y=(0,u.tB)();if(!v)return p.error("error",{message:"No response in request"}),p.end(),this.unsubscribeAbortSubscription(f),null;if(this.throughputEstimator?.addRawRtt(y-b),!v.ok||!v.body){this.unsubscribeAbortSubscription(f);let e=`Fetch error ${v.status}: ${v.statusText}`;return p.error("error",{message:e}),p.end(),Promise.reject(new Error(`Fetch error ${v.status}: ${v.statusText}`))}if(this.onHeadersReceived(v.headers),!s&&!n){this.unsubscribeAbortSubscription(f);let e=(0,u.tB)(),t={requestStartedAt:b,requestEndedAt:e,duration:e-b};return p.log("endRequest",(0,u.YO)(t)),p.end(),v.arrayBuffer()}let S=v.body;if(n){let e;[S,e]=v.body.tee(),this.throughputEstimator?.trackStream(e,o)}let w,T=S.getReader(),$=parseInt(v.headers.get("content-length")??"",10);Number.isFinite($)&&(w=$),!w&&i&&(w=i.to-i.from+1);let x=w?new Uint8Array(w):new Uint8Array(0),k=!1,L=e=>{this.unsubscribeAbortSubscription(f),k=!0,To(e)},R=(0,u.ZC)(m,async function*({done:e,value:t}){if(0===g&&(this.lastRequestFirstBytes$.next((0,u.tB)()-b),this.firstBytesReceived$.next()),m.aborted)this.unsubscribeAbortSubscription(f);else if(!e&&t){if(h&&w)x.set(t,g),g+=t.byteLength;else{let e=new Uint8Array(x.length+t.length);e.set(x),e.set(t,x.length),x=e,g+=t.byteLength}s?.(new DataView(x.buffer),g),yield T?.read().then(R,L)}}.bind(this));yield T?.read().then(R,L),this.unsubscribeAbortSubscription(f);let E=(0,u.tB)(),B={failed:k,requestStartedAt:b,requestEndedAt:E,duration:E-b};return k?(p.error("endRequest",(0,u.YO)(B)),p.end(),null):(p.log("endRequest",(0,u.YO)(B)),p.end(),x.buffer)}.bind(this)),this.fetchByteRangeRepresentation=(0,u.ZC)(this.abortAllController.signal,async function*(e,t,i){if("byteRange"!==e.type)return null;let s,r,{from:a,to:n}=e.initRange,o=a,u=n,h=!1;e.indexRange&&(s=e.indexRange.from,r=e.indexRange.to,h=n+1===s,h&&(o=Math.min(s,a),u=Math.max(r,n))),o=Math.min(o,0);let d=yield this.fetch(e.url,{range:{from:o,to:u},measureThroughput:!1,...i});if(!d)return null;let l=new DataView(d,a-o,n-o+1);if(!t.validateData(l))throw new Error("Invalid media file");let c,p=t.parseInit(l),f=e.indexRange??t.getIndexRange(p);if(!f)throw new ReferenceError("No way to load representation index");if(h)c=new DataView(d,f.from-o,f.to-f.from+1);else{let t=yield this.fetch(e.url,{range:f,measureThroughput:!1});if(!t)return null;c=new DataView(t)}let m=t.parseSegments(c,p,f);return{init:p,dataView:new DataView(d),segments:m}}.bind(this)),this.fetchTemplateRepresentation=(0,u.ZC)(this.abortAllController.signal,async function*(e,t){if("template"!==e.type)return null;let i=new URL(e.initUrl,e.baseUrl).toString(),s=yield this.fetch(i,{measureThroughput:!1,...t});return s?{init:null,segments:e.segments.map((e=>({...e,status:"none",size:void 0}))),dataView:new DataView(s)}:null}.bind(this)),this.throughputEstimator=e,this.requestQuic=t,this.compatibilityMode=s,this.tracer=i.createComponentTracer("Fetcher"),this.useEnableSubtitlesParam=r}},To=e=>{if(!_a(e))throw e},$o=class{next(e){let t=0,i=0;for(let e=0;e<this.pastMeasures.length;e++)void 0!==this.pastMeasures[e]&&(t+=(this.pastMeasures[e]-this.smoothed)**2,i++);this.takenMeasures=i,t/=i;let s=Math.sqrt(t),r=this.smoothed+this.params.deviationFactor*s,a=this.smoothed-this.params.deviationFactor*s;this.pastMeasures[this.measuresCursor]=e,this.measuresCursor=(this.measuresCursor+1)%this.pastMeasures.length,this.rawSeries$.next(e),this.updateSmoothedValue(e),this.smoothed$.next(this.smoothed),this.smoothedSeries$.next(this.smoothed),!(this.smoothed>r||this.smoothed<a)&&((0,u.wD)(this.prevReported)||Math.abs(this.smoothed-this.prevReported)/this.prevReported>=this.params.changeThreshold)&&(this.prevReported=this.smoothed,this.debounced$.next(this.smoothed),this.reportedSeries$.next(this.smoothed))}constructor(e){this.prevReported=void 0,this.pastMeasures=[],this.takenMeasures=0,this.measuresCursor=0,this.params=e,this.pastMeasures=Array(e.deviationDepth),this.smoothed=this.prevReported=e.initial,this.smoothed$=new u.Ot(e.initial),this.debounced$=new u.Ot(e.initial);let t=e.label??"value"+Math.random().toString(16).substring(2,6);this.rawSeries$=new hr(`raw_${t}`),this.smoothedSeries$=new hr(`smoothed_${t}`),this.reportedSeries$=new hr(`reported_${t}`),this.rawSeries$.next(e.initial),this.smoothedSeries$.next(e.initial),this.reportedSeries$.next(e.initial)}},xo=class extends $o{updateSmoothedValue(e){this.slow=pa(this.slow,e,this.params.emaAlphaSlow),this.fast=pa(this.fast,e,this.params.emaAlphaFast);let t=this.params.fastDirection>0?Math.max:Math.min;this.smoothed=t(this.slow,this.fast)}constructor(e){super(e),this.slow=this.fast=e.initial}},ko=class extends $o{updateSmoothedValue(e){let t=fa(this.pastMeasures,this.takenMeasures);this.emaSmoothed=pa(this.emaSmoothed,e,this.params.emaAlpha);let i=((e,t,i,s)=>{let r=0,a=i,n=fa(e,t),o=t<s?t:s;for(let t=0;t<o;t++)e[a]>n?r++:r--,a=(e.length+a-1)%e.length;return Math.abs(r)===o})(this.pastMeasures,this.takenMeasures,this.measuresCursor-1,this.params.basisTrendChangeCount);this.smoothed=i?this.emaSmoothed:t}constructor(e){super(e),this.emaSmoothed=e.initial}},Lo=class extends $o{next(e){this.currentTopExtremumValue<=e?(this.currentTopExtremumValue=e,this.furtherValues=[]):this.furtherValues.length===this.extremumInterval?(super.next(this.currentTopExtremumValue),this.currentTopExtremumValue=e,this.furtherValues=[]):this.furtherValues.push(e)}updateSmoothedValue(e){this.smoothed=this.smoothed?pa(this.smoothed,e,this.params.emaAlpha):e}constructor(e){super(e),this.furtherValues=[],this.currentTopExtremumValue=0,this.extremumInterval=e.extremumInterval}},Ro=class{static getSmoothedValue(e,t,i){return"TwoEma"===i.type?new xo({initial:e,emaAlphaSlow:i.emaAlphaSlow,emaAlphaFast:i.emaAlphaFast,changeThreshold:i.changeThreshold,fastDirection:t,deviationDepth:i.deviationDepth,deviationFactor:i.deviationFactor,label:"throughput"}):new ko({initial:e,emaAlpha:i.emaAlpha,basisTrendChangeCount:i.basisTrendChangeCount,changeThreshold:i.changeThreshold,deviationDepth:i.deviationDepth,deviationFactor:i.deviationFactor,label:"throughput"})}static getLiveBufferSmoothedValue(e,t){return new Lo({initial:e,label:"liveEdgeDelay",...t})}},Eo=(e,t)=>{e&&e.playbackRate!==t&&(e.playbackRate=t)},Bo=class e{updateLive(e){this.processStreams(e?.streams.text)}seekLive(e){this.processStreams(e)}maintain(e=this.getCurrentPosition()){if(!(0,u.wD)(e))for(let t of this.representations)for(let i of t){let t=i.segmentReference,s=t.segments.length,r=t.segments[0].time.from,a=t.segments[s-1].time.to;if(e<r||e>a)continue;let n=t.segments.find((t=>t.time.from<=e&&t.time.to>=e));!n||this.currentSegment?.time.from===n.time.from&&this.currentSegment.time.to===n.time.to||(this.currentSegment=n,this.currentRepresentation$.next({...i,label:"Live Text",language:"ru",isAuto:!0,url:new URL(n.url,t.baseUrl).toString()}))}}destroy(){this.currentRepresentation$.next(null),this.currentSegment=null,this.representations=[]}processStreams(t){for(let i of t??[]){let t=e.filterRepresentations(i.representations);if(t){this.representations[this.representationsCursor]=t,this.representationsCursor=(this.representationsCursor+1)%this.maxRepresentations;break}}}static isSupported(t){return!!t?.some((t=>e.filterRepresentations(t.representations)))}static filterRepresentations(e){return e?.filter((e=>"text"===e.kind&&"segmentReference"in e&&Wn(e.segmentReference)))}constructor(e,t){this.currentRepresentation$=new u.Ot(null),this.maxRepresentations=4,this.representationsCursor=0,this.representations=[],this.currentSegment=null,this.getCurrentPosition=t.getCurrentPosition,this.processStreams(e)}},Ao=["timeupdate","progress","play","seeked","stalled","waiting"],Mo=["timeupdate","progress","loadeddata","playing","seeked"],Co=class{setSmartRepresentationSwitch(e){this.bufferManagers.forEach((t=>t.setSmartRepresentationSwitch(e)))}async seekLive(e){(0,u.tZ)(this.element),this.updateManifestUrlWithTimeOffset(e),this.manifest=await this.updateManifest(),this.manifest&&(this.isJumpGapAfterSeekLive=!0,await this.updateLiveBuffersFromManifest(this.manifest))}updateManifestUrlWithTimeOffset(e){let t="active"!==this.liveStreamStatus$.getValue()?(0,u.tB)()-this.liveStreamEndTimestamp:0,i=this.normalizeLiveOffset(e+t);this.isActiveLive$.next(0===i),this.manifestUrlString=is(this.manifestUrlString,i,2)}async updateLiveBuffersFromManifest(e){await(this.videoBufferManager?.seekLive(e.streams.video)),await(this.audioBufferManager?.seekLive(e.streams.audio)),this.liveTextManager?.seekLive(e.streams.text)}stopStallWatchdogSubscription(){this.stallWatchdogSubscription?.unsubscribe(),this.currentStallDuration$.next(0)}initBuffer(){(0,u.tZ)(this.element),this.state$.setState("running"),this.subscription.add((0,u.h1)(...Ao.map((e=>(0,u.Rt)(this.element,e))),(0,u.Rt)(window,"online")).subscribe((()=>this.tick()),(e=>{this.error$.next({id:"DashVKPlayer",category:u.h.WTF,message:"Internal logic error",thrown:e})}))),this.subscription.add((0,u.Rt)(this.element,"progress").subscribe((()=>{this.element&&2===this.element.readyState&&!this.element.seeking&&(this.element.currentTime=this.element.currentTime)}))),this.subscription.add((0,u.Rt)(this.element,"waiting").subscribe((()=>{this.tuning.dash.useVideoElementWaitingCurrentTimeReassign&&this.element&&2===this.element.readyState&&!this.element.seeking&&co(this.element.buffered,1e3*this.element.currentTime)&&(this.element.currentTime=this.element.currentTime);this.stallWatchdogSubscription&&(this.stallWatchdogSubscription.unsubscribe(),this.subscriptionRemovable.remove(this.stallWatchdogSubscription)),this.stallWatchdogSubscription=(0,u.YP)(this.tuning.dash.stallWatchdogInterval).subscribe((()=>{let{keepSilentStallWatchdogWhenNotActive:e}=this.tuning.dashCmafLive,{crashOnStallTimeout:t,crashOnStallTWithoutDataTimeout:i,liveStallReinitInterval:s,stallWatchdogInterval:r}=this.tuning.dash,a=this.isLive$.getValue(),n="active"===this.liveStreamStatus$.getValue();if(!this.element||"open"!==this.source?.readyState)return;let o=this.currentStallDuration$.getValue();o+=r,this.currentStallDuration$.next(o);let h={timeInWaiting:o},d=(0,u.tB)(),l=this.videoBufferManager?.lastDataObtainedTimestamp??0;this.videoLastDataObtainedTimestamp$.next(l);let c=this.audioBufferManager?.lastDataObtainedTimestamp??0,p=this.videoBufferManager?.getForwardBufferDuration()??0,f=this.audioBufferManager?.getForwardBufferDuration()??0,m=p<100&&d-l>i,g=this.audioBufferManager&&f<100&&d-c>i;if((!e||n)&&((m||g)&&o>i||o>=t))throw new Error(`Stall timeout exceeded: ${o} ms`);if(a&&o%s==0){let t=this.normalizeLiveOffset(-1*this.livePositionFromPlayer$.getValue()*1e3);!n&&e?(this.liveWasInterrupted=!0,this.updateManifestUrlWithTimeOffset(t),this.updateManifest()):this.seekLive(t).catch((e=>{this.error$.next({id:"stallIntervalCallback",category:u.h.VIDEO_PIPELINE,message:"stallIntervalCallback failed",thrown:e})})),h.liveLastOffset=t}else{let e=1e3*this.element.currentTime;this.videoBufferManager?.maintain(e),this.audioBufferManager?.maintain(e),h.position=e}this.tracer.log("stallIntervalCallback",(0,u.YO)(h))}),(e=>{this.error$.next({id:"StallWatchdogCallback",category:u.h.NETWORK,message:"Can't restore DASH after stall.",thrown:e})})),this.subscriptionRemovable.add(this.stallWatchdogSubscription)}))),this.tick()}async switchRepresentation(e,t,i=!1){let s={video:this.videoBufferManager,audio:this.audioBufferManager,text:null}[e];return this.tuning.useNewSwitchTo?this.currentStallDuration$.getValue()>0?s?.switchToWithPreviousAbort(t,i):s?.switchTo(t,i):s?.switchToOld(t,i)}async seek(e,t){let i;(0,u.tZ)(this.element),(0,u.tZ)(this.videoBufferManager),i=t||1e3*this.element.duration<=this.tuning.dashSeekInSegmentDurationThreshold||Math.abs(1e3*this.element.currentTime-e)<=this.tuning.dashSeekInSegmentAlwaysSeekDelta?e:Math.max(this.videoBufferManager.findSegmentStartTime(e)??e,this.audioBufferManager?.findSegmentStartTime(e)??e),this.warmUpMediaSourceIfNeeded(i),co(this.element.buffered,i)||await Promise.all([this.videoBufferManager.abort(),this.audioBufferManager?.abort()]),!(0,u.wD)(this.element)&&!(0,u.wD)(this.videoBufferManager)&&(this.videoBufferManager.maintain(i),this.audioBufferManager?.maintain(i),this.element.currentTime=i/1e3,this.tracer.log("seek",(0,u.YO)({requestedPosition:e,forcePrecise:t,position:i})))}warmUpMediaSourceIfNeeded(e=this.element?.currentTime){(0,u.R)(this.element)&&(0,u.R)(this.source)&&(0,u.R)(e)&&"ended"===this.source?.readyState&&1e3*this.element.duration-e>this.tuning.dash.seekBiasInTheEnd&&this.bufferManagers.forEach((e=>e.warmUpMediaSource()))}get isStreamEnded(){return"ended"===this.source?.readyState}stop(){this.tracer.log("stop"),this.element?.querySelectorAll("source").forEach((e=>{URL.revokeObjectURL(e.src),e.remove()})),this.element=null,this.source=null,this.manifest=null,this.currentVideoRepresentation$.next(void 0),this.videoBufferManager?.destroy(),this.videoBufferManager=null,this.audioBufferManager?.destroy(),this.audioBufferManager=null,this.bufferManagers=[],this.state$.setState("none")}setBufferTarget(e){for(let t of this.bufferManagers)t.setTarget(e)}getStreams(){return this.manifest?.streams}getCodecs(){return this.manifest?.codecs}setPreloadOnly(e){for(let t of this.bufferManagers)t.setPreloadOnly(e)}destroy(){this.subscription.unsubscribe(),this.subscriptionRemovable.unsubscribe(),this.representationSubscription.unsubscribe(),this.timeoutSourceOpenId&&clearTimeout(this.timeoutSourceOpenId),this.destroyController.abort(),this.fetcher.destroy(),this.stop(),"open"===this.source?.readyState&&Array.from(this.source.sourceBuffers).every((e=>!e.updating))&&this.source.endOfStream(),this.source=null,this.tracer.end()}initTracerSubscription(){let e=(0,u.kD)(this.tracer.error.bind(this.tracer));this.subscription.add(this.error$.subscribe(e("error")))}isManualDecreasePlaybackInLive(){if(!this.element||!this.isLive$.getValue())return!1;let e=1-this.element.playbackRate;return Number(e.toFixed(2))>Number(this.tuning.dashCmafLive.lowLatency.playbackCatchupSpeedup.toFixed(2))}normalizeLiveOffset(e){return 1e3*Math.trunc(e/1e3)}async updateLive(){this.isUpdatingLive=!0,this.manifest=await this.updateManifest(),this.manifest&&(this.bufferManagers.forEach((e=>e.updateLive(this.manifest))),this.liveTextManager?.updateLive(this.manifest)),this.isUpdatingLive=!1}jumpGap(){if(!this.element||!this.videoBufferManager)return;let e=this.videoBufferManager.getDebugBufferState();if(!e)return;let t=this.isActiveLive$.getValue()&&this.isLowLatency$.getValue(),i={isJumpGapAfterSeekLive:this.isJumpGapAfterSeekLive,isActiveLowLatency:t,initialCurrentTime:this.element.currentTime},{usePersistentGaps:s}=this.tuning.dash;this.isJumpGapAfterSeekLive&&!t&&this.element.currentTime>e.to&&(this.isJumpGapAfterSeekLive=!1,this.element.currentTime=0);let r=1e3*this.element.currentTime,a=[],n=1===this.element.readyState?this.tuning.endGapTolerance:0;for(let e of this.bufferManagers)for(let t of e.gaps)(s&&t.persistent||e.playingRepresentation$.getValue()===t.representation)&&t.from-n<=r&&t.to+n>r&&(1e3*this.element.duration-t.to<this.tuning.endGapTolerance?a.push(1/0):a.push(t.to));if(a.length){let e=Math.max(...a)+10;this.gapWatchdogSubscription.unsubscribe(),this.gapWatchdogActive=!1,e===1/0?this.forceEnded$.next():(this.element.currentTime=e/1e3,i={...i,gapEnds:a,jumpTo:e,resultCurrentTime:this.element.currentTime},this.tracer.log("jumpGap",(0,u.YO)(i)))}}calculateDurationFromSegments(){return Math.max(this.videoBufferManager?.calculateDurationFromSegments()||0,this.audioBufferManager?.calculateDurationFromSegments()||0)}constructor(e){this.element=null,this.manifestUrlString="",this.source=null,this.manifest=null,this.bufferManagers=[],this.subscription=new u.yU,this.subscriptionRemovable=new u.V6,this.representationSubscription=new u.yU,this.state$=new Ps("none"),this.currentVideoRepresentation$=new u.Ot(void 0),this.currentVideoRepresentationInit$=new u.Ot(void 0),this.currentAudioRepresentation$=new u.Ot(void 0),this.currentVideoSegmentLength$=new u.Ot(0),this.currentAudioSegmentLength$=new u.Ot(0),this.error$=new u.B7,this.manifestRequested$=new u.B7,this.firstBytesManifest$=new u.B7,this.manifestReceived$=new u.B7,this.firstBytesRequested$=new u.B7,this.firstBytesReceived$=new u.B7,this.lastConnectionType$=new u.Ot(void 0),this.lastConnectionReused$=new u.Ot(void 0),this.lastRequestFirstBytes$=new u.Ot(void 0),this.currentLiveTextRepresentation$=new u.Ot(null),this.isLive$=new u.Ot(!1),this.isActiveLive$=new u.Ot(!1),this.isLowLatency$=new u.Ot(!1),this.liveDuration$=new u.Ot(0),this.liveSeekableDuration$=new u.Ot(0),this.liveAvailabilityStartTime$=new u.Ot(0),this.liveStreamStatus$=new u.Ot(void 0),this.bufferLength$=new u.Ot(0),this.liveLatency$=new u.Ot(void 0),this.liveLoadBufferLength$=new u.Ot(0),this.livePositionFromPlayer$=new u.Ot(0),this.currentStallDuration$=new u.Ot(0),this.videoLastDataObtainedTimestamp$=new u.Ot(0),this.fetcherRecoverableError$=new u.B7,this.fetcherError$=new u.B7,this.liveStreamEndTimestamp=0,this.isUpdatingLive=!1,this.isJumpGapAfterSeekLive=!1,this.forceEnded$=new u.B7,this.gapWatchdogActive=!1,this.liveWasInterrupted=!1,this.destroyController=new Ca,this.initManifest=(0,u.ZC)(this.destroyController.signal,async function*(e,t,i){this.tracer.log("initManifest"),this.element=e,this.manifestUrlString=is(t,i,2),this.state$.startTransitionTo("manifest_ready"),this.manifest=yield this.updateManifest(),this.manifest?.streams.video.length?this.state$.setState("manifest_ready"):this.error$.next({id:"NoRepresentations",category:u.h.PARSER,message:"No playable video representations"})}.bind(this)),this.updateManifest=(0,u.ZC)(this.destroyController.signal,async function*(){this.tracer.log("updateManifestStart",{manifestUrl:this.manifestUrlString});let e=yield this.fetcher.fetchManifest(this.manifestUrlString).catch((e=>{!this.manifest&&!this.bufferLength$.getValue()&&this.error$.next({id:"LoadManifest",category:u.h.NETWORK,message:"Failed to load manifest",thrown:e})}));if(!e)return null;let t=null;try{t=Ka(e??"",this.manifestUrlString),this.manifestReceived$.next()}catch(t){let i=Oa(e)??{id:"ManifestParsing",category:u.h.PARSER,message:"Failed to parse MPD manifest",thrown:t};this.error$.next(i)}if(!t)return null;let i=(e,t,i)=>!!(this.element?.canPlayType?.(t)&&gs()?.isTypeSupported?.(`${t}; codecs="${i}"`)||"text"===e);if(t.live){this.isLive$.next(!0);let{availabilityStartTime:e,latestSegmentPublishTime:i,streamIsUnpublished:s,streamIsAlive:r}=t.live,a=(t.duration??0)/1e3;this.liveSeekableDuration$.next(-1*a),this.liveDuration$.next((i-e)/1e3),this.liveAvailabilityStartTime$.next(t.live.availabilityStartTime);let n="active";if(r||(n=s?"unpublished":"unexpectedly_down"),this.liveStreamStatus$.next(n),r&&this.liveWasInterrupted){this.liveWasInterrupted=!1,this.stopStallWatchdogSubscription();let e=this.normalizeLiveOffset(-1*this.livePositionFromPlayer$.getValue()*1e3);this.seekLive(e).catch((e=>{this.error$.next({id:"updateManifest",category:u.h.VIDEO_PIPELINE,message:"seekLive after stream restore failed",thrown:e})}))}}let s,r,a={text:t.streams.text,video:[],audio:[]};for(let e of["video","audio"]){let n,o=t.streams[e].filter((({mime:t,codecs:s})=>i(e,t,s)));if(a[e]=o,this.tuning.dash.codecsPrioritizeEnabled){let t=o.map((({codecs:e})=>e));"audio"===e&&(r=hn(t),n=r[0]),"video"===e&&(s=un(t),n=this.forceVideoCodec&&(0,ho.default)(s,this.forceVideoCodec)?this.forceVideoCodec:s[0]),n&&(a[e]=o.filter((({codecs:e})=>dn(e)===n)))}else{let t=new Set(o.map((({codecs:e})=>e)));n=on(t),n&&(a[e]=o.filter((({codecs:e})=>e.startsWith(n))))}if("video"===e){let e=this.tuning.preferHDR,t=a.video.some((e=>e.hdr)),i=a.video.some((e=>!e.hdr));ks.display.isHDR&&e&&t?a.video=a.video.filter((e=>e.hdr)):i&&(a.video=a.video.filter((e=>!e.hdr)))}}let n={...t,streams:a};return this.tuning.dash.codecsPrioritizeEnabled&&(n.codecs={video:s,audio:r}),this.tracer.log("updateManifestEnd",(0,u.YO)(n)),n}.bind(this)),this.initRepresentations=(0,u.ZC)(this.destroyController.signal,async function*(e,t,i){this.tracer.log("initRepresentationsStart",(0,u.YO)({initialVideo:e,initialAudio:t,sourceHls:i})),(0,u.tZ)(this.manifest),(0,u.tZ)(this.element),this.representationSubscription.unsubscribe(),this.state$.startTransitionTo("representations_ready");let s=e=>{this.representationSubscription.add((0,u.Rt)(e,"error").pipe((0,u.pb)((e=>!!this.element?.played.length))).subscribe((e=>{this.error$.next({id:"VideoSource",category:u.h.VIDEO_PIPELINE,message:"Unexpected video source error",thrown:e})})))};this.source=vs();let r=document.createElement("source");if(s(r),r.src=URL.createObjectURL(this.source),this.element.appendChild(r),bs())if(i){let e=document.createElement("source");s(e),e.type="application/x-mpegurl",e.src=i.url,this.element.appendChild(e)}else this.element.disableRemotePlayback=!0;this.isActiveLive$.next(this.isLive$.getValue());let a={fetcher:this.fetcher,tuning:this.tuning,getCurrentPosition:()=>this.element?1e3*this.element.currentTime:void 0,isActiveLowLatency:()=>this.isActiveLive$.getValue()&&this.isLowLatency$.getValue(),manifest:this.manifest},n=this.manifest.streams.video.reduce(((e,t)=>[...e,...t.representations]),[]);if(this.videoBufferManager=new So("video",this.source,n,a),this.bufferManagers=[this.videoBufferManager],(0,u.R)(t)){let e=this.manifest.streams.audio.reduce(((e,t)=>[...e,...t.representations]),[]);this.audioBufferManager=new So("audio",this.source,e,a),this.bufferManagers.push(this.audioBufferManager)}if(Bo.isSupported(this.manifest.streams.text)&&!this.isLowLatency$.getValue()&&(this.liveTextManager=new Bo(this.manifest.streams.text,a)),this.representationSubscription.add(this.fetcher.lastRequestFirstBytes$.subscribe(this.lastRequestFirstBytes$)),this.representationSubscription.add((0,u.h1)(...Mo.map((e=>(0,u.Rt)(this.element,e)))).pipe((0,u.Tj)((e=>this.element?io(this.element.buffered,1e3*this.element.currentTime):0)),(0,u.jX)(),(0,u.Mi)((e=>{e>this.tuning.dash.bufferEmptinessTolerance&&this.stopStallWatchdogSubscription()}))).subscribe(this.bufferLength$)),this.representationSubscription.add((0,u.h1)((0,u.Rt)(this.element,"ended"),this.forceEnded$).subscribe((()=>{this.stopStallWatchdogSubscription()}))),this.isLive$.getValue()){this.subscription.add(this.liveDuration$.pipe((0,u.jX)()).subscribe((e=>this.liveStreamEndTimestamp=(0,u.tB)()))),this.subscription.add((0,u.Rt)(this.element,"pause").subscribe((()=>{let{liveUpdateInterval:e}=this.tuning.dash;this.livePauseWatchdogSubscription=(0,u.YP)(e).subscribe((t=>{let i=ss(this.manifestUrlString,2);this.manifestUrlString=is(this.manifestUrlString,i+e,2),"active"===this.liveStreamStatus$.getValue()&&this.updateManifest()})),this.subscription.add(this.livePauseWatchdogSubscription)}))).add((0,u.Rt)(this.element,"play").subscribe((e=>this.livePauseWatchdogSubscription?.unsubscribe()))),this.representationSubscription.add((0,u.kg)({isActiveLive:this.isActiveLive$,isLowLatency:this.isLowLatency$}).pipe((0,u.Tj)((({isActiveLive:e,isLowLatency:t})=>e&&t)),(0,u.jX)()).subscribe((e=>{this.isManualDecreasePlaybackInLive()||Eo(this.element,1)}))),this.representationSubscription.add((0,u.kg)({bufferLength:this.bufferLength$,isActiveLive:this.isActiveLive$,isLowLatency:this.isLowLatency$}).pipe((0,u.pb)((({bufferLength:e,isActiveLive:t,isLowLatency:i})=>t&&i&&!!e))).subscribe((({bufferLength:e})=>this.liveBuffer.next(e)))),this.representationSubscription.add(this.videoBufferManager.currentLowLatencySegmentLength$.subscribe((e=>{if(!this.isActiveLive$.getValue()&&!this.isLowLatency$.getValue()&&!e)return;let t=this.liveSeekableDuration$.getValue()-e/1e3;this.liveSeekableDuration$.next(Math.max(t,-1*this.tuning.dashCmafLive.maxLiveDuration)),this.liveDuration$.next(this.liveDuration$.getValue()+e/1e3)}))),this.representationSubscription.add((0,u.kg)({isLive:this.isLive$,rtt:this.throughputEstimator.rtt$,bufferLength:this.bufferLength$,segmentServerLatency:this.videoBufferManager.currentLiveSegmentServerLatency$}).pipe((0,u.pb)((({isLive:e})=>e)),(0,u.jX)(((e,t)=>t.bufferLength<e.bufferLength)),(0,u.Tj)((({rtt:e,bufferLength:t,segmentServerLatency:i})=>(e/2+t+i+ss(this.manifestUrlString,2))/1e3))).subscribe(this.liveLatency$)),this.representationSubscription.add((0,u.kg)({liveBuffer:this.liveBuffer.smoothed$,isActiveLive:this.isActiveLive$,isLowLatency:this.isLowLatency$}).subscribe((({liveBuffer:e,isActiveLive:t,isLowLatency:i})=>{if(!i||!t)return;let s=this.tuning.dashCmafLive.lowLatency.maxTargetOffset,r=this.tuning.dashCmafLive.lowLatency.maxTargetOffsetDeviation,a=this.tuning.dashCmafLive.lowLatency.playbackCatchupSpeedup,n=e-s;if(this.isManualDecreasePlaybackInLive())return;let o=1;Math.abs(n)>r&&(o=1+Math.sign(n)*a),Eo(this.element,o)}))),this.representationSubscription.add(this.bufferLength$.subscribe((e=>{let t=0;if(e){let e=1e3*(this.element?.currentTime??0);t=Math.min(...this.bufferManagers.map((t=>t.getLiveSegmentsToLoadState(this.manifest)?.to??e)))-e}this.liveLoadBufferLength$.getValue()!==t&&this.liveLoadBufferLength$.next(t)})));let e=0;this.representationSubscription.add((0,u.kg)({liveLoadBufferLength:this.liveLoadBufferLength$,bufferLength:this.bufferLength$}).pipe((0,u.nF)(this.tuning.dash.liveUpdateInterval)).subscribe((async({liveLoadBufferLength:t,bufferLength:i})=>{if(!this.element||this.isUpdatingLive)return;let s=this.element.playbackRate,r=ss(this.manifestUrlString,2),a=1e3*Math.abs(this.livePositionFromPlayer$.getValue()),n=Math.min(a,this.tuning.dashCmafLive.normalizedTargetMinBufferSize*s),o=this.tuning.dashCmafLive.normalizedActualBufferOffset*s,u=this.tuning.dashCmafLive.normalizedLiveMinBufferSize*s,h=isFinite(t)?t:i,d=this.isActiveLive$.getValue()&&this.isLowLatency$.getValue(),l=a<=this.tuning.live.activeLiveDelay;this.isActiveLive$.next(l);let c="none";if(d?c="active_low_latency":this.isLowLatency$.getValue()&&l?(this.bufferManagers.forEach((e=>e.proceedLowLatencyLive())),c="active_low_latency"):0!==r&&h<n?c="live_forward_buffering":h<n+u&&(c="live_with_target_offset"),isFinite(t)&&(e=t>e?t:e),"live_forward_buffering"===c||"live_with_target_offset"===c){let i=e-(n+o),a=this.normalizeLiveOffset(Math.trunc(r+i/s)),u=Math.abs(a-r),h=0;!t||u<=this.tuning.dashCmafLive.offsetCalculationError?h=r:a>0&&u>this.tuning.dashCmafLive.offsetCalculationError&&(h=a),this.manifestUrlString=is(this.manifestUrlString,h,2)}("live_with_target_offset"===c||"live_forward_buffering"===c)&&(e=0,await this.updateLive())}),(e=>{this.error$.next({id:"updateLive",category:u.h.VIDEO_PIPELINE,thrown:e,message:"Failed to update live with subscription"})})))}let o=(0,u.h1)(...this.bufferManagers.map((e=>e.fullyBuffered$))).pipe((0,u.Tj)((()=>this.bufferManagers.every((e=>e.fullyBuffered$.getValue()))))),h=(0,u.h1)(...this.bufferManagers.map((e=>e.onLastSegment$))).pipe((0,u.Tj)((()=>this.bufferManagers.some((e=>e.onLastSegment$.getValue()))))),d=(0,u.kg)({allBuffersFull:o,someBufferEnded:h}).pipe((0,u.jX)(),(0,u.Tj)((({allBuffersFull:e,someBufferEnded:t})=>e&&t)),(0,u.pb)((e=>e)));if(this.representationSubscription.add((0,u.h1)(this.forceEnded$,d).subscribe((()=>{if(this.source&&"open"===this.source.readyState&&Array.from(this.source.sourceBuffers).every((e=>!e.updating)))try{this.source?.endOfStream()}catch(e){this.error$.next({id:"EndOfStream",category:u.h.VIDEO_PIPELINE,message:"Failed to end MediaSource stream",thrown:e})}}))),this.representationSubscription.add((0,u.h1)(...this.bufferManagers.map((e=>e.error$))).subscribe(this.error$)),this.representationSubscription.add(this.videoBufferManager.playingRepresentation$.subscribe(this.currentVideoRepresentation$)),this.representationSubscription.add(this.videoBufferManager.playingRepresentationInit$.subscribe(this.currentVideoRepresentationInit$)),this.representationSubscription.add(this.videoBufferManager.currentSegmentLength$.subscribe(this.currentVideoSegmentLength$)),this.audioBufferManager&&(this.representationSubscription.add(this.audioBufferManager.playingRepresentation$.subscribe(this.currentAudioRepresentation$)),this.representationSubscription.add(this.audioBufferManager.currentSegmentLength$.subscribe(this.currentAudioSegmentLength$))),this.liveTextManager&&this.representationSubscription.add(this.liveTextManager.currentRepresentation$.subscribe(this.currentLiveTextRepresentation$)),"open"!==this.source.readyState){let e=this.tuning.dash.sourceOpenTimeout>=0;yield new Promise((t=>{e&&(this.timeoutSourceOpenId=setTimeout((()=>{"open"!==this.source?.readyState?this.error$.next({id:"OpenOfStream",category:u.h.VIDEO_PIPELINE,message:"Failed to open MediaSource",thrown:new Error("Timeout reject when wait sourceopen event"),traceAsLog:!0}):t()}),this.tuning.dash.sourceOpenTimeout)),this.source?.addEventListener("sourceopen",(()=>{this.timeoutSourceOpenId&&clearTimeout(this.timeoutSourceOpenId),t()}),{once:!0})}))}if(!this.isLive$.getValue()){let e=[this.manifest.duration??0,...(0,lo.default)((0,lo.default)([...this.manifest.streams.audio,...this.manifest.streams.video],(e=>e.representations)),(e=>{let t=[];return e.duration&&t.push(e.duration),Wn(e.segmentReference)&&e.segmentReference.totalSegmentsDurationMs&&t.push(e.segmentReference.totalSegmentsDurationMs),t}))];this.source.duration=Math.max(...e)/1e3}this.audioBufferManager&&(0,u.R)(t)?yield Promise.all([this.videoBufferManager.startWith(e),this.audioBufferManager.startWith(t)]):yield this.videoBufferManager.startWith(e),this.state$.setState("representations_ready"),this.tracer.log("initRepresentationsEnd")}.bind(this)),this.tick=()=>{if(!this.element||!this.videoBufferManager||"open"!==this.source?.readyState)return;let e=1e3*this.element.currentTime;this.videoBufferManager.maintain(e),this.audioBufferManager?.maintain(e),this.liveTextManager?.maintain(e),(this.videoBufferManager.gaps.length||this.audioBufferManager?.gaps.length)&&!this.gapWatchdogActive&&(this.gapWatchdogActive=!0,this.gapWatchdogSubscription=(0,u.YP)(this.tuning.gapWatchdogInterval).subscribe((()=>this.jumpGap()),(e=>{this.error$.next({id:"GapWatchdog",category:u.h.WTF,message:"Error handling gaps",thrown:e})})),this.subscription.add(this.gapWatchdogSubscription))},this.throughputEstimator=e.throughputEstimator,this.tuning=e.tuning,this.tracer=e.tracer.createComponentTracer(this.constructor.name),this.forceVideoCodec=e.forceVideoCodec,this.fetcher=new wo({throughputEstimator:this.throughputEstimator,requestQuic:this.tuning.requestQuick,compatibilityMode:e.compatibilityMode,tracer:this.tracer,useEnableSubtitlesParam:e.tuning.useEnableSubtitlesParam}),this.subscription.add(this.fetcher.recoverableError$.subscribe(this.fetcherRecoverableError$)),this.subscription.add(this.fetcher.error$.subscribe(this.fetcherError$)),this.subscription.add(this.fetcher.manifestRequested$.subscribe(this.manifestRequested$)),this.subscription.add(this.fetcher.firstBytesManifest$.subscribe(this.firstBytesManifest$)),this.subscription.add(this.fetcher.firstBytesRequested$.subscribe(this.firstBytesRequested$)),this.subscription.add(this.fetcher.firstBytesReceived$.subscribe(this.firstBytesReceived$)),this.subscription.add(this.fetcher.lastConnectionType$.subscribe(this.lastConnectionType$)),this.subscription.add(this.fetcher.lastConnectionReused$.subscribe(this.lastConnectionReused$)),this.liveBuffer=Ro.getLiveBufferSmoothedValue(this.tuning.dashCmafLive.lowLatency.maxTargetOffset,{...e.tuning.dashCmafLive.lowLatency.bufferEstimator}),this.initTracerSubscription()}},Io=class{connect({observableVideo:e,video:t}){let i=e=>{let t=e.target;this.pipSize$.next({width:t.width,height:t.height})};this.subscription.add((0,u.qi)(t).subscribe(this.videoSize$)).add(e.enterPip$.subscribe((({pictureInPictureWindow:e})=>{this.pipSize$.next({width:e.width,height:e.height}),e.addEventListener("resize",i),this.pictureInPictureWindowRemoveEventListener=()=>{e.removeEventListener("resize",i)}}))).add(e.leavePip$.subscribe((()=>{this.pictureInPictureWindowRemoveEventListener()}))).add((0,u.kg)({videoSize:this.videoSize$,pipSize:this.pipSize$,inPip:e.inPiP$}).pipe((0,u.Tj)((({videoSize:e,inPip:t,pipSize:i})=>t?i:e))).subscribe(this.elementSize$))}getValue(){return this.elementSize$.getValue()}subscribe(e,t){return this.elementSize$.subscribe(e,t)}getObservable(){return this.elementSize$}destroy(){this.pictureInPictureWindowRemoveEventListener(),this.subscription.unsubscribe()}constructor(){this.subscription=new u.yU,this.pipSize$=new u.Ot(void 0),this.videoSize$=new u.Ot(void 0),this.elementSize$=new u.Ot(void 0),this.pictureInPictureWindowRemoveEventListener=u.lQ}},Do=class{getProviderSubscriptionInfo(){let{output:e,desiredState:t}=this.params;(0,u.wD)(this.observableVideo)&&(this.observableVideo=er(this.video),this.subscription.add((()=>this.observableVideo?.destroy())));let i=this.constructor.name,s=t=>{e.error$.next({id:i,category:u.h.WTF,message:`${i} internal logic error`,thrown:t})};return{output:e,desiredState:t,observableVideo:this.observableVideo,genericErrorListener:s,connect:(e,t)=>this.subscription.add(e.subscribe(t,s))}}subscribe(){let{output:e,desiredState:t,observableVideo:i,genericErrorListener:s,connect:r}=this.getProviderSubscriptionInfo();this.subscription.add(this.params.output.availableVideoTracks$.pipe((0,u.pb)((e=>!!e.length)),(0,u.Oo)()).subscribe((e=>{this.droppedFramesManager.connect({logger:this.params.dependencies.logger,video:this.video,droppedFramesChecker:this.params.tuning.droppedFramesChecker,isAuto:this.params.desiredState.autoVideoTrackSwitching,playing$:i.playing$,pause$:i.pause$,tracks:e})})));let a=this.params.desiredState.seekState.stateChangeEnded$.pipe((0,u.Tj)((e=>"none"!==e.to.state)),(0,u.jX)());this.stallsManager.init({isSeeked$:a,currentStallDuration$:this.player.currentStallDuration$,videoLastDataObtainedTimestamp$:this.player.videoLastDataObtainedTimestamp$,throughput$:this.params.dependencies.throughputEstimator.throughput$,rtt$:this.params.dependencies.throughputEstimator.rtt$,tuning:this.params.tuning.stallsManager,abrParams:this.params.tuning.autoTrackSelection,isBuffering$:i.isBuffering$,looped$:i.looped$,playing$:i.playing$,duration:this.video.duration}),r(i.ended$,e.endedEvent$),r(i.looped$,e.loopedEvent$),r(i.error$,e.error$),r(i.isBuffering$,e.isBuffering$),r(i.currentBuffer$,e.currentBuffer$),r(i.currentBuffer$,e.currentNativeBuffer$),r(i.playing$,e.firstFrameEvent$),r(i.canplay$,e.canplay$),r(i.inPiP$,e.inPiP$),r(i.inFullscreen$,e.inFullscreen$),r(i.loadedMetadata$,e.loadedMetadataEvent$),r(this.player.error$,e.error$),r(this.player.fetcherRecoverableError$,e.fetcherRecoverableError$),r(this.player.fetcherError$,e.fetcherError$),r(this.player.manifestRequested$,e.manifestRequested$),r(this.player.firstBytesManifest$,e.firstBytesManifest$),r(this.player.manifestReceived$,e.manifestReceived$),r(this.player.firstBytesRequested$,e.firstBytesRequested$),r(this.player.firstBytesReceived$,e.firstBytesReceived$),r(this.player.lastConnectionType$,e.httpConnectionType$),r(this.player.lastConnectionReused$,e.httpConnectionReused$),r(this.player.isLive$,e.isLive$),r(this.player.lastRequestFirstBytes$.pipe((0,u.pb)(u.R),(0,u.Oo)()),e.firstBytesEvent$),r(this.stallsManager.severeStallOccurred$,e.severeStallOccurred$),r(this.videoState.stateChangeEnded$.pipe((0,u.Tj)((e=>e.to))),this.params.output.playbackState$),this.subscription.add(i.looped$.subscribe((()=>this.player.warmUpMediaSourceIfNeeded()),s)),this.subscription.add(i.seeked$.subscribe(e.seekedEvent$,s)),this.subscription.add(Hs(this.video,t.isLooped,s)),this.subscription.add(i.volumeState$.subscribe(this.params.output.volume$,s)),Sa({subscription:this.subscription,desiredState:t,videoElement$:this.params.output.element$,observableVideo:i}),this.subscription.add(Ws(this.video,t.volume,i.volumeState$,s)),this.subscription.add(Qs(this.video,t.playbackRate,i.playbackRateState$,s)),this.elementSizeManager.connect({video:this.video,observableVideo:i}),r(Kr(this.video,{threshold:this.params.tuning.autoTrackSelection.activeVideoAreaThreshold}),e.elementVisible$),this.subscription.add(i.playing$.subscribe((()=>{this.videoState.setState("playing"),us(t.playbackState,"playing"),this.scene3D&&this.scene3D.play()}),s)).add(i.pause$.subscribe((()=>{this.videoState.setState("paused"),us(t.playbackState,"paused")}),s)).add(i.canplay$.subscribe((()=>{"playing"===this.videoState.getState()&&this.playIfAllowed()}),s)),this.params.tuning.changePlaybackStateToPausedWhenEnded&&this.subscription.add(i.ended$.subscribe((()=>{this.videoState.setState("paused"),us(t.playbackState,"paused")}))),this.subscription.add(this.player.state$.stateChangeEnded$.subscribe((({to:e})=>{if("manifest_ready"===e){this.videoTracksMap=new Map,this.audioTracksMap=new Map,this.textTracksMap=new Map;let e=this.player.getStreams(),t=this.player.getCodecs();if((0,u.tZ)(e,"Manifest not loaded or empty"),!this.params.tuning.isAudioDisabled){let t=[];for(let i of e.audio){t.push(qn(i));let e=[];for(let t of i.representations){let s=Un(t);e.push(s),this.audioTracksMap.set(s,{stream:i,representation:t})}this.audioStreamsMap.set(i,e)}this.params.output.availableAudioStreams$.next(t)}let i=[];for(let t of e.video){i.push(zn(t));let e=[];for(let i of t.representations){let s=Nn({...i,streamId:t.id});s&&(e.push(s),this.videoTracksMap.set(s,{stream:t,representation:i}))}this.videoStreamsMap.set(t,e)}this.params.output.availableVideoStreams$.next(i);for(let t of e.text)for(let e of t.representations){let i=jn(t,e);this.textTracksMap.set(i,{stream:t,representation:e})}this.params.output.availableVideoTracks$.next(Array.from(this.videoTracksMap.keys())),this.params.output.availableAudioTracks$.next(Array.from(this.audioTracksMap.keys())),this.params.output.isAudioAvailable$.next(!!this.audioTracksMap.size),t?.video&&this.params.output.availableVideoCodecs$.next(t.video),t?.audio&&this.params.output.availableAudioCodecs$.next(t.audio),this.audioTracksMap.size&&this.textTracksMap.size&&this.params.desiredState.internalTextTracks.startTransitionTo(Array.from(this.textTracksMap.keys()))}else"representations_ready"===e&&(this.videoState.setState("ready"),this.player.initBuffer())}),s));let n=(0,u.h1)(this.player.currentStallDuration$,this.player.state$.stateChangeEnded$,t.videoTrack.stateChangeStarted$,t.autoVideoTrackSwitching.transitionStarted$,this.params.dependencies.throughputEstimator.rttAdjustedThroughput$,t.autoVideoTrackLimits.stateChangeStarted$,this.elementSizeManager.getObservable(),this.params.output.elementVisible$,this.droppedFramesManager.onDroopedVideoFramesLimit$,(0,u.Rt)(this.video,"progress")).pipe((0,u.pb)((()=>this.videoTracksMap.size>0))),{abrThrottle:o}=this.params.tuning.dash;o&&(n=n.pipe((0,u.nF)(o))),this.subscription.add(n.subscribe((async()=>{let e=this.player.state$.getState(),i=this.player.state$.getTransition();if("manifest_ready"!==e&&"running"!==e||i)return;t.autoVideoTrackSwitching.getTransition()&&t.autoVideoTrackSwitching.setState(t.autoVideoTrackSwitching.getState());let s=this.selectVideoAudioRepresentations();if(!s)return;let[r,a]=s,n=[...this.videoTracksMap.keys()].find((e=>this.videoTracksMap.get(e)?.representation.id===r.id));(0,u.R)(n)&&(this.stallsManager.lastVideoTrackSelected=n);let o=this.params.desiredState.autoVideoTrackLimits.getTransition();if(o&&this.params.output.autoVideoTrackLimits$.next(o.to),"manifest_ready"===e)await this.player.initRepresentations(r.id,a?.id,this.params.sourceHls);else if(await this.player.switchRepresentation("video",r.id),a){let e=!!t.audioStream.getTransition();await this.player.switchRepresentation("audio",a.id,e)}}),s)),this.subscription.add((0,u.kg)({videoState:this.videoState.stateChangeEnded$,autoVideoTrackState:(0,u.h1)((0,u.Ss)([t.autoVideoTrackSwitching.getState()]),t.autoVideoTrackSwitching.stateChangeEnded$.pipe((0,u.Tj)((e=>e.to))))}).pipe((0,u.Tj)((({videoState:e,autoVideoTrackState:t})=>"stopped"!==e.to&&t)),(0,u.jX)()).subscribe((e=>this.player.setSmartRepresentationSwitch(e)))),this.subscription.add(t.cameraOrientation.stateChangeEnded$.subscribe((({to:e})=>{this.scene3D&&e&&this.scene3D.pointCameraTo(e.x,e.y)}))),this.subscription.add(this.elementSizeManager.subscribe((e=>{this.scene3D&&e&&this.scene3D.setViewportSize(e.width,e.height)}))),this.subscription.add(this.player.currentVideoRepresentation$.pipe((0,u.jX)()).subscribe((t=>{let i=[...this.videoTracksMap.entries()].find((([,{representation:e}])=>e.id===t));if(!i)return e.currentVideoTrack$.next(void 0),void e.currentVideoStream$.next(void 0);let[s,{stream:r}]=i,a=this.params.desiredState.videoStream.getTransition();a&&a.to&&a.to.id===r.id&&this.params.desiredState.videoStream.setState(a.to),e.currentVideoTrack$.next(s),e.currentVideoStream$.next(zn(r));let n=this.player.calculateDurationFromSegments();n&&this.params.output.duration$.next(n/1e3)}),s)),this.subscription.add(this.player.currentAudioRepresentation$.pipe((0,u.jX)()).subscribe((t=>{let i=[...this.audioTracksMap.entries()].find((([,{representation:e}])=>e.id===t));if(!i)return void e.currentAudioStream$.next(void 0);let[s,{stream:r}]=i,a=this.params.desiredState.audioStream.getTransition();a&&a.to&&a.to.id===r.id&&this.params.desiredState.audioStream.setState(a.to),e.currentAudioStream$.next(qn(r))}),s)),this.subscription.add(this.player.currentVideoRepresentationInit$.subscribe((t=>{if(t?.is3dVideo&&this.params.tuning.spherical?.enabled)try{this.init3DScene(t),e.is3DVideo$.next(!0)}catch(t){e.warning$.next({id:"DashProvider",message:`DashProvider could not initialize 3D-scene: ${t}`})}else this.destroy3DScene(),this.params.tuning.spherical?.enabled&&e.is3DVideo$.next(!1)}),s)),this.subscription.add(this.player.currentVideoSegmentLength$.subscribe(e.currentVideoSegmentLength$,s)),this.subscription.add(this.player.currentAudioSegmentLength$.subscribe(e.currentAudioSegmentLength$,s)),this.textTracksManager.connect(this.video,t,e);let h=t.playbackState.stateChangeStarted$.pipe((0,u.Tj)((({to:e})=>"ready"===e)),(0,u.jX)());this.subscription.add((0,u.h1)(h,t.autoVideoTrackSwitching.stateChangeStarted$,this.player.state$.stateChangeEnded$,(0,u.Ss)(["init"])).subscribe((()=>{let e=t.autoVideoTrackSwitching.getState(),i="ready"===t.playbackState.getState()?this.params.tuning.dash.forwardBufferTargetPreload:e?this.params.tuning.dash.forwardBufferTargetAuto:this.params.tuning.dash.forwardBufferTargetManual;this.player.setBufferTarget(i)}))),this.subscription.add((0,u.h1)(h,this.player.state$.stateChangeEnded$,(0,u.Ss)(["init"])).subscribe((()=>this.player.setPreloadOnly("ready"===t.playbackState.getState()))));let d=(0,u.h1)(t.playbackState.stateChangeStarted$,t.videoTrack.stateChangeStarted$,t.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,(0,u.Ss)(["init"])).pipe((0,u.sg)(0));this.subscription.add(d.subscribe(this.syncPlayback,s))}selectVideoAudioRepresentations(){if(this.player.isStreamEnded)return;let e=this.params.tuning.useNewAutoSelectVideoTrack?wr:Sr,t=this.params.tuning.useNewAutoSelectVideoTrack?Br:Er,i=this.params.tuning.useNewAutoSelectVideoTrack?Lr:Rr,{desiredState:s,output:r}=this.params,a=s.autoVideoTrackSwitching.getState(),n=s.videoTrack.getState()?.id,o=[...this.videoTracksMap.keys()].find((({id:e})=>e===n)),u=r.currentVideoTrack$.getValue(),h=s.videoStream.getState()??(o&&this.videoTracksMap.get(o)?.stream)??1===this.videoStreamsMap.size?this.videoStreamsMap.keys().next().value:void 0;if(!h)return;let d=[...this.videoStreamsMap.keys()].find((({id:e})=>e===h.id)),l=d&&this.videoStreamsMap.get(d);if(!l)return;let c,p=io(this.video.buffered,1e3*this.video.currentTime);c=this.player.isActiveLive$.getValue()?this.player.isLowLatency$.getValue()?this.params.tuning.dashCmafLive.lowLatency.maxTargetOffset:this.params.tuning.dashCmafLive.normalizedLiveMinBufferSize:this.player.isLive$.getValue()?this.params.tuning.dashCmafLive.normalizedTargetMinBufferSize:a?this.params.tuning.dash.forwardBufferTargetAuto:this.params.tuning.dash.forwardBufferTargetManual;let f=(1e3*this.video.duration||1/0)-1e3*this.video.currentTime,m=Math.min(p/Math.min(c,f||1/0),1),g=s.audioStream.getState()??(1===this.audioStreamsMap.size?this.audioStreamsMap.keys().next().value:void 0),b=[...this.audioStreamsMap.keys()].find((({id:e})=>e===g?.id))??this.audioStreamsMap.keys().next().value,v=0;if(b){if(o&&!a){let t=e(o,l,this.audioStreamsMap.get(b)??[],this.params.tuning.autoTrackSelection.minVideoAudioRatio);v=Math.max(v,t?.bitrate??-1/0)}if(u){let t=e(u,l,this.audioStreamsMap.get(b)??[],this.params.tuning.autoTrackSelection.minVideoAudioRatio);v=Math.max(v,t?.bitrate??-1/0)}}let y=o;(a||!y)&&(y=i(l,{container:this.elementSizeManager.getValue(),panelSize:this.params.panelSize,estimatedThroughput:this.params.dependencies.throughputEstimator.rttAdjustedThroughput$.getValue(),tuning:this.stallsManager.abrTuningParams,limits:this.params.desiredState.autoVideoTrackLimits.getState(),reserve:v,forwardBufferHealth:m,current:u,visible:this.params.output.elementVisible$.getValue(),history:this.videoTrackSwitchHistory,playbackRate:this.video.playbackRate,droppedVideoMaxQualityLimit:this.droppedFramesManager.droppedVideoMaxQualityLimit,stallsVideoMaxQualityLimit:this.stallsManager.videoMaxQualityLimit,stallsPredictedThroughput:this.stallsManager.predictedThroughput,abrLogger:this.params.dependencies.abrLogger}));let S=b&&t(y,l,this.audioStreamsMap.get(b)??[],{estimatedThroughput:this.params.dependencies.throughputEstimator.rttAdjustedThroughput$.getValue(),stallsPredictedThroughput:this.stallsManager.predictedThroughput,tuning:this.stallsManager.abrTuningParams,forwardBufferHealth:m,history:this.audioTrackSwitchHistory,playbackRate:this.video.playbackRate,abrLogger:this.params.dependencies.abrLogger}),w=this.videoTracksMap.get(y)?.representation,T=S&&this.audioTracksMap.get(S)?.representation;return w&&T?[w,T]:w&&!T&&0===this.audioTracksMap.size?[w,void 0]:void 0}prepare(e=0){this.player.initManifest(this.video,this.params.source.url,e)}playIfAllowed(){Dr(this.video,(()=>{this.params.output.soundProhibitedEvent$.next()})).then((e=>{e||(this.videoState.setState("paused"),us(this.params.desiredState.playbackState,"paused",!0))}),(e=>this.params.output.error$.next({id:"ForcePlay",message:"play() failed even with workarounds",category:u.h.DOM,thrown:e})))}destroy(){this.subscription.unsubscribe(),this.droppedFramesManager.destroy(),this.stallsManager.destroy(),this.elementSizeManager.destroy(),this.destroy3DScene(),this.textTracksManager.destroy(),this.player.destroy(),this.params.output.element$.next(void 0),this.params.output.currentVideoStream$.next(void 0),js(this.video),this.tracer.end()}constructor(e){this.subscription=new u.yU,this.videoState=new Ps("stopped"),this.observableVideo=null,this.droppedFramesManager=new Yr,this.stallsManager=new va,this.elementSizeManager=new Io,this.videoTracksMap=new Map,this.audioTracksMap=new Map,this.textTracksMap=new Map,this.videoStreamsMap=new Map,this.audioStreamsMap=new Map,this.videoTrackSwitchHistory=new mr,this.audioTrackSwitchHistory=new mr,this.syncPlayback=()=>{let e=this.videoState.getState(),t=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition(),s=this.params.desiredState.seekState.getState();if(!this.videoState.getTransition()){if("requested"===s.state&&"paused"!==i?.to&&"stopped"!==e&&"stopped"!==t&&this.seek(s.position,s.forcePrecise),"stopped"===t)return void("stopped"!==e&&(this.videoState.startTransitionTo("stopped"),this.player.stop(),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.currentNativeBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState("stopped"),us(this.params.desiredState.playbackState,"stopped",!0)));switch(e){case"stopped":return this.videoState.startTransitionTo("ready"),void this.prepare();case"ready":return void("paused"===t?(this.videoState.setState("paused"),us(this.params.desiredState.playbackState,"paused")):"playing"===t?(this.videoState.startTransitionTo("playing"),this.playIfAllowed()):"ready"===i?.to&&us(this.params.desiredState.playbackState,"ready"));case"playing":return void("paused"===t?(this.videoState.startTransitionTo("paused"),this.video.paused?this.videoState.setState("paused"):this.video.pause()):"playing"===t&&this.video.paused?this.playIfAllowed():"playing"===i?.to&&us(this.params.desiredState.playbackState,"playing"));case"paused":return void("playing"===t?(this.videoState.startTransitionTo("playing"),this.playIfAllowed()):"paused"===i?.to&&us(this.params.desiredState.playbackState,"paused"));default:return(0,u.xb)(e)}}},this.init3DScene=e=>{if(this.scene3D)return;this.scene3D=new ca(this.params.container,this.video,{fov:this.params.tuning.spherical.fov,orientation:this.params.tuning.spherical.orientation||{x:e.projectionData?.pose.yaw||0,y:e.projectionData?.pose.pitch||0,z:e.projectionData?.pose.roll||0},rotationSpeed:this.params.tuning.spherical.rotationSpeed,maxYawAngle:this.params.tuning.spherical.maxYawAngle,rotationSpeedCorrection:this.params.tuning.spherical.rotationSpeedCorrection,degreeToPixelCorrection:this.params.tuning.spherical.degreeToPixelCorrection,speedFadeTime:this.params.tuning.spherical.speedFadeTime,speedFadeThreshold:this.params.tuning.spherical.speedFadeThreshold});let t=this.elementSizeManager.getValue();t&&this.scene3D.setViewportSize(t.width,t.height)},this.destroy3DScene=()=>{this.scene3D&&(this.scene3D.destroy(),this.scene3D=void 0)},this.textTracksManager=new Zs(e.source.url),this.params=e,this.video=Us(e.container,e.tuning),this.tracer=e.dependencies.tracer.createComponentTracer(this.constructor.name),this.params.output.element$.next(this.video),this.params.output.availableVideoTracks$.next([]),this.params.output.availableAudioTracks$.next([]),this.params.output.isAudioAvailable$.next(!0),this.params.output.hostname$.next(Ar(this.params.source.url)),this.params.output.isLive$.next(!1),this.params.output.autoVideoTrackLimitingAvailable$.next(!0),this.params.output.availableTextTracks$.next([]),this.params.desiredState.internalTextTracks.setState([]),this.player=new Co({throughputEstimator:this.params.dependencies.throughputEstimator,tuning:this.params.tuning,compatibilityMode:this.params.source.compatibilityMode,tracer:this.tracer,forceVideoCodec:this.params.forceVideoCodec}),this.subscribe()}},Oo=class extends Do{subscribe(){super.subscribe();let{output:e,observableVideo:t,connect:i}=this.getProviderSubscriptionInfo();i(t.timeUpdate$,e.position$),i(t.durationChange$,e.duration$)}seek(e,t){this.params.output.willSeekEvent$.next(),this.player.seek(e,t)}},Po=class extends Do{subscribe(){super.subscribe();let e=!1,t=-1,{output:i,observableVideo:s,desiredState:r,connect:a}=this.getProviderSubscriptionInfo();this.params.output.position$.next(0),this.params.output.isLive$.next(!0),this.params.output.canPlayLiveTailBuffer$.next(!0),a(s.timeUpdate$,i.liveBufferTime$),a(this.player.liveSeekableDuration$,i.duration$),a(this.player.liveLatency$,i.liveLatency$);let n=new u.Ot(1);a(s.playbackRateState$,n),this.params.tuning.dashCmafLive.catchupLiveForMutedInactiveTab&&this.subscription.add(i.elementVisible$.pipe((0,u.jX)()).subscribe((t=>{let s=i.position$.getValue(),r=i.volume$.getValue(),a=!r.volume||r.muted;t||s||!a?t&&e&&(this.seek(0),e=!1):e=!0}))),this.subscription.add(this.params.output.position$.subscribe(this.player.livePositionFromPlayer$)).add(r.isLowLatency.stateChangeEnded$.pipe((0,u.Tj)((e=>e.to))).subscribe(this.player.isLowLatency$)).add((0,u.kg)({liveBufferTime:i.liveBufferTime$,liveAvailabilityStartTime:this.player.liveAvailabilityStartTime$}).pipe((0,u.Tj)((({liveBufferTime:e,liveAvailabilityStartTime:i})=>e&&i?1e3*e+i+t:void 0))).subscribe(i.liveTime$)).add((0,u.kg)({liveDuration:this.player.liveDuration$,liveStreamStatus:this.player.liveStreamStatus$,playbackRate:(0,u.h1)(s.playbackRateState$,new u.Ot(1))}).pipe((0,u.pb)((({liveStreamStatus:e,liveDuration:t})=>"active"===e&&!!t))).subscribe((({liveDuration:e,playbackRate:s})=>{let r=i.liveBufferTime$.getValue(),a=i.position$.getValue(),{playbackCatchupSpeedup:n}=this.params.tuning.dashCmafLive.lowLatency;a||s<1-n||this.video.paused||(0,u.wD)(r)||(t=e-r)}))).add((0,u.kg)({time:i.liveBufferTime$,liveDuration:this.player.liveDuration$,playbackRate:(0,u.h1)(s.playbackRateState$,new u.Ot(1))}).pipe((0,u.jX)(((e,t)=>"active"===this.player.liveStreamStatus$.getValue()?e.liveDuration===t.liveDuration:e.time===t.time))).subscribe((({time:e,liveDuration:s,playbackRate:r})=>{let a=i.position$.getValue(),{playbackCatchupSpeedup:n}=this.params.tuning.dashCmafLive.lowLatency;if(!a&&!this.video.paused&&r>=1-n||(0,u.wD)(e)||(0,u.wD)(s))return;let o=-1*(s-e-t);i.position$.next(Math.min(o,0))}))).add(this.player.currentLiveTextRepresentation$.subscribe((e=>{if(e){let t=(({language:e,label:t,id:i,url:s,isAuto:r})=>({id:i,url:s,isAuto:r,type:"internal",language:e,label:t}))(e);this.params.output.availableTextTracks$.next([t])}}))),this.params.tuning.dashCmafLive.externalStopControl||this.subscription.add(this.player.liveStreamStatus$.pipe((0,u.pb)((e=>(0,u.R)(e)))).subscribe((e=>i.isLiveEnded$.next("unpublished"===e&&0===i.position$.getValue()))))}seek(e){this.params.output.willSeekEvent$.next();let t=-e,i=Math.trunc(t/1e3<=Math.abs(this.params.output.duration$.getValue())?t:0);this.player.seekLive(i).then((()=>{this.params.output.position$.next(e/1e3)}))}constructor(e){super(e),this.textTracksManager.destroy()}},Vo=g(Oe(),1),_o=g(gi(),1),Fo=g(Oe(),1),No=g(ni(),1),Uo=g(gi(),1),jo=g(ii(),1),qo=!1;try{qo=ks.browser.isSafari&&!!ks.browser.safariVersion&&ks.browser.safariVersion<=18}catch(zr){console.error(zr)}var zo=class{async append(e,t){return(!t||!t.aborted)&&new Promise((i=>{let s={operation:"append",data:e,signal:t,callback:i};this.queue.push(s),this.pull()}))}async remove(e,t,i){return(!i||!i.aborted)&&new Promise((s=>{let r={operation:"remove",from:e,to:t,signal:i,callback:s};this.queue.unshift(r),this.pull()}))}async abort(e){return new Promise((t=>{let i,s=e=>{this.abortRequested=!1,t(e)};i=qo&&e?{operation:"safariAbort",init:e,callback:s}:{operation:"abort",callback:s};for(let{callback:e}of this.queue)e(!1);this.abortRequested=!0,i&&(this.queue=[i]),this.pull()}))}destroy(){this.destroyed=!0,this.buffer.removeEventListener("updateend",this.completeTask),this.queue=[],this.currentTask=null;try{this.buffer.abort()}catch(e){if(!(e instanceof DOMException&&"InvalidStateError"===e.name))throw e}}pull(){if((this.buffer.updating||this.currentTask||this.destroyed)&&!this.abortRequested)return;let e=this.isAbortFixEnabled?this.queue[0]:this.queue.shift();if(!e)return;if(e.signal?.aborted)return e.callback(!1),void this.pull();this.currentTask=e;let{operation:t}=this.currentTask;try{this.execute(this.currentTask)}catch(e){e instanceof DOMException&&"QuotaExceededError"===e.name&&"append"===t?this.bufferFull$.next(this.currentTask.data.byteLength):e instanceof DOMException&&"InvalidStateError"===e.name||this.error$.next({id:`BufferTaskQueue:${t}`,category:u.h.VIDEO_PIPELINE,message:"Buffer operation failed",thrown:e}),this.currentTask.callback(!1),this.currentTask=null}this.currentTask&&"abort"===this.currentTask.operation&&this.completeTask()}execute(e){let{operation:t}=e;switch(t){case"append":this.buffer.appendBuffer(e.data);break;case"remove":this.buffer.remove(e.from/1e3,e.to/1e3);break;case"abort":this.buffer.abort();break;case"safariAbort":this.buffer.abort(),this.buffer.appendBuffer(e.init);break;default:(0,u.xb)(t)}}constructor(e,t=!1){this.bufferFull$=new u.B7,this.error$=new u.B7,this.queue=[],this.currentTask=null,this.destroyed=!1,this.abortRequested=!1,this.isAbortFixEnabled=!1,this.completeTask=()=>{try{if(this.currentTask){let e=this.currentTask.signal?.aborted;this.currentTask.callback(!e),this.currentTask=null,this.isAbortFixEnabled&&this.queue.shift()}this.queue.length&&this.pull()}catch(e){this.error$.next({id:"BufferTaskQueueUnknown",category:u.h.VIDEO_PIPELINE,message:"Buffer appending or removal failed",thrown:e})}},this.buffer=e,this.isAbortFixEnabled=t,this.buffer.addEventListener("updateend",this.completeTask)}},Ho=g(ni(),1),Wo=({id:e,width:t,height:i,bitrate:s,fps:r,quality:a,streamId:n})=>{let o=(a?tr(a):void 0)??(0,u.Hf)({width:t,height:i});return o&&{id:e,quality:o,bitrate:s,size:{width:t,height:i},fps:r,streamId:n}},Qo=({id:e,bitrate:t})=>({id:e,bitrate:t}),Xo=({language:e,label:t},{id:i,url:s,isAuto:r})=>({id:i,url:s,isAuto:r,type:"internal",language:e,label:t}),Go=({id:e,language:t,label:i,codecs:s,isDefault:r})=>({id:e,language:t,label:i,codec:(0,Ho.default)(s.split("."),0),isDefault:r}),Zo=({id:e,language:t,label:i,hdr:s,codecs:r})=>({id:e,language:t,hdr:s,label:i,codec:(0,Ho.default)(r.split("."),0)}),Yo=e=>"url"in e,Jo=e=>"template"===e.type,Ko=(e,t)=>{for(let i of e)if(t(i))return i;return null},eu=e=>{let t=[];for(let i=0;i<e.length;i++){let s=Math.floor(1e3*e.start(i)),r=Math.ceil(1e3*e.end(i));t.push(s,r)}return t},tu=class{updateend(){if(!qr(this.mediaSource,this.sourceBuffer))return;let{prevRanges:e}=this,t=eu(this.sourceBuffer.buffered);this.prevRanges=t,this.isRangesRemoved(e,t)&&(this.lastUpdateTs=Date.now())}isRangesRemoved(e,t){if(e.length!==t.length)return!0;for(let i=0;i<e.length;i+=2){let s=e[i],r=e[i+1],a=t[i],n=t[i+1];if(a>s||n<r)return!0}return!1}wasUpdated(){let{lastCallTs:e,lastUpdateTs:t}=this;return this.lastCallTs=Date.now(),e<=t}destroy(){this.subscription.unsubscribe()}constructor(e,t){this.lastUpdateTs=0,this.lastCallTs=0,this.prevRanges=[],this.subscription=new u.yU,this.mediaSource=e,this.sourceBuffer=t,this.subscription.add((0,u.Rt)(this.sourceBuffer,"updateend").subscribe((()=>this.updateend())))}},iu=class{switchToWithPreviousAbort(e,t=!1){!qr(this.mediaSource,this.sourceBuffer)||e===this.downloadingRepresentationId||e===this.switchingToRepresentationId||(this.switchAbortController.abort(),this.switchAbortController=new Ca,(0,u.ZC)(this.switchAbortController.signal,async function*(e,t=!1){this.switchingToRepresentationId=e;let i=this.representations.get(e);(0,u.tZ)(i,`No such representation ${e}`);let s=this.segments.get(e),r=this.initData.get(e);if((0,u.wD)(r)||(0,u.wD)(s)?yield this.loadInit(i,"high",!1):r instanceof Promise&&(yield r),s=this.segments.get(e),(0,u.tZ)(s,"No segments for starting representation"),r=this.initData.get(e),r instanceof ArrayBuffer&&this.sourceBuffer&&qr(this.mediaSource,this.sourceBuffer)){if(yield this.abort(),yield this.sourceBufferTaskQueue.append(r,this.downloadAbortController.signal),t)this.switchingToRepresentationId=void 0,this.downloadingRepresentationId=e,yield this.dropBuffer();else{let t=this.getCurrentPosition();(0,u.R)(t)&&!this.isLive&&(this.bufferLimit=this.forwardBufferTarget,yield this.pruneBuffer(t,1/0,!0)),this.downloadingRepresentationId=e,this.switchingToRepresentationId=void 0}this.maintain()}}.bind(this))(e,t))}warmUpMediaSource(){!(0,u.wD)(this.sourceBuffer)&&!this.sourceBuffer.updating&&(this.sourceBuffer.mode="segments")}async abort(){for(let e of this.activeSegments)this.abortSegment(e.segment);return this.activeSegments.clear(),this.downloadAbortController.abort(),this.downloadAbortController=new Ca,this.abortBuffer()}maintain(e=this.getCurrentPosition()){if((0,u.wD)(e)||(0,u.wD)(this.downloadingRepresentationId)||(0,u.wD)(this.playingRepresentationId)||(0,u.wD)(this.sourceBuffer)||!qr(this.mediaSource,this.sourceBuffer)||(0,u.R)(this.switchingToRepresentationId)||this.isSeekingLive)return;let t=this.representations.get(this.downloadingRepresentationId),i=this.representations.get(this.playingRepresentationId),s=this.segments.get(this.downloadingRepresentationId),r=this.segments.get(this.playingRepresentationId);if((0,u.tZ)(t,`No such representation ${this.downloadingRepresentationId}`),(0,u.tZ)(i,`No such representation ${this.playingRepresentationId}`),(0,u.wD)(s)||(0,u.wD)(r))return;let a=s.find((t=>e>=t.time.from&&e<t.time.to));(0,u.R)(a)&&isFinite(a.time.from)&&isFinite(a.time.to)&&this.currentSegmentLength$.next(a?.time.to-a.time.from);let n=e;if(this.playingRepresentationId!==this.downloadingRepresentationId){let s=this.getForwardBufferDuration(e),r=Wo(i),o=Wo(t),h=this.useSmartRepresentationSwitch&&this.tuning.dash.useNewRepresentationSwitch&&this.tuning.dash.useSmartRepresentationSwitch&&(0,u.R)(r)&&(0,u.R)(o)&&(0,u.kW)(r.quality,o.quality),d=this.useSmartRepresentationSwitch&&this.tuning.dash.useNewRepresentationSwitch&&this.tuning.dash.useDelayedRepresentationSwitch;if(h||d?n+=Math.min(s,this.tuning.dash.representationSwitchForwardBufferGap):a&&a.time.to-e<this.tuning.dash.maxSegmentDurationLeftToSelectNextSegment&&s>=a.time.to-e+100&&(n=a?a.time.to+100:-1/0),this.tuning.dash.useNewRepresentationSwitch){let t=[...this.segments.entries()].map((([t,i])=>{let s=i.find((t=>e>=t.time.from&&e<t.time.to));return{representationId:t,status:s?.status}})).find((e=>"fed"===e.status))?.representationId;t&&(this.playingRepresentationId=t,this.playingRepresentation$.next(this.playingRepresentationId),this.playingRepresentationInit$.next(this.parsedInitData.get(this.playingRepresentationId)))}}if(isFinite(this.bufferLimit)&&yo(this.sourceBuffer.buffered)>=this.bufferLimit){let t=io(this.sourceBuffer.buffered,e),i=Math.min(this.forwardBufferTarget,this.bufferLimit)*this.tuning.dash.minSafeBufferThreshold;return void this.pruneBuffer(e,1/0,t<i).catch((e=>{this.handleAsyncError(e,"pruneBuffer")}))}let o=null;if(!this.activeSegments.size&&(o=this.selectForwardBufferSegments(s,t.segmentReference.type,n),o?.length)){let e="auto";if(this.tuning.dash.useFetchPriorityHints&&a)if((0,Fo.default)(o,a))e="high";else{let t=(0,No.default)(o,0);t&&t.time.from-a.time.to>=this.forwardBufferTarget/2&&(e="low")}this.loadSegments(o,t,e).catch((e=>{this.handleAsyncError(e,"loadSegments")}))}(!this.preloadOnly&&!this.allInitsLoaded&&a&&"fed"===a.status&&!o?.length&&io(this.sourceBuffer.buffered,e)>3e3||this.isActiveLowLatency())&&this.loadNextInit();let h=(0,No.default)(s,-1);!this.isLive&&h&&(this.fullyBuffered$.next(h.time.to-e-io(this.sourceBuffer.buffered,e)<100),this.onLastSegment$.next(e-h.time.from>0))}get lastDataObtainedTimestamp(){return this.lastDataObtainedTimestampMs}searchGaps(e,t){this.gaps=[];let i=0,s=this.isLive?this.liveInitialAdditionalOffset:0;for(let r of e)Math.trunc(r.time.from-i)>0&&this.gaps.push({representation:t.id,from:i,to:r.time.from+s,persistent:!0}),i=r.time.to;(0,u.R)(t.duration)&&t.duration-i>0&&!this.isLive&&this.gaps.push({representation:t.id,from:i,to:t.duration,persistent:!0})}getActualLiveStartingSegments(e){let t=e.segments,i=this.isActiveLowLatency()?this.tuning.dashCmafLive.lowLatency.maxTargetOffset:this.tuning.dashCmafLive.maxActiveLiveOffset,s=[],r=0,a=t.length-1;do{s.unshift(t[a]),r+=t[a].time.to-t[a].time.from,a--}while(r<i&&a>=0);return this.liveInitialAdditionalOffset=r-i,this.isActiveLowLatency()?[s[0]]:s}getLiveSegmentsToLoadState(e){let t=e?.streams[this.kind];if(!t)return;let i=(0,Uo.default)(t,(e=>e.representations)).find((e=>e.id===this.downloadingRepresentationId));if(!i)return;let s=this.segments.get(i.id);return s?.length?{from:s[0].time.from,to:s[s.length-1].time.to}:void 0}updateLive(e){if(!e||[...this.segments.values()].every((e=>!e.length)))return;let t=(0,Uo.default)(e.streams[this.kind],(e=>e.representations))??[];for(let e of t){if(!e||!Jo(e.segmentReference))return;let t=e.segmentReference.segments.map((e=>({...e,status:"none",size:void 0}))),i=100,s=this.segments.get(e.id)??[],r=(0,No.default)(s,-1)?.time.to??0,a=t?.findIndex((e=>r>=e.time.from+i&&r<=e.time.to+i));if(-1===a){this.liveUpdateSegmentIndex=0;let t=this.getActualLiveStartingSegments(e.segmentReference);this.segments.set(e.id,t)}else{let i=t.slice(a+1);this.segments.set(e.id,[...s,...i])}}}proceedLowLatencyLive(){let e=this.downloadingRepresentationId;(0,u.tZ)(e);let t=this.segments.get(e);if(t?.length){let e=t[t.length-1];this.updateLowLatencyLiveIfNeeded(e)}}setSmartRepresentationSwitch(e){this.useSmartRepresentationSwitch=e}updateLowLatencyLiveIfNeeded(e){let t=0;for(let i of this.representations.values()){let s=i.segmentReference;if(!Jo(s))return;let r=this.segments.get(i.id);if(!r)continue;let a=r.find((t=>Math.floor(t.time.from)===Math.floor(e.time.from)));if(a&&!isFinite(a.time.to)&&(a.time.to=e.time.to,t=a.time.to-a.time.from),!r.find((t=>Math.floor(t.time.from)===Math.floor(e.time.to)))&&this.isActiveLowLatency()){let t=Math.round(e.time.to*s.timescale/1e3).toString(10),i=Ja(s.segmentTemplateUrl,{segmentTime:t});r.push({status:"none",time:{from:e.time.to,to:1/0},url:i})}}this.currentLowLatencySegmentLength$.next(t)}findSegmentStartTime(e){let t=this.switchingToRepresentationId??this.downloadingRepresentationId??this.playingRepresentationId;if(!t)return;let i=this.segments.get(t);return i?i.find((t=>t.time.from<=e&&t.time.to>=e))?.time.from??void 0:void 0}setTarget(e){this.forwardBufferTarget=e}setPreloadOnly(e){this.preloadOnly=e}destroy(){if(this.initData.clear(),this.segments.clear(),this.parsedInitData.clear(),this.representations.clear(),this.sourceBufferTaskQueue?.destroy(),this.sourceBufferBufferedDiff?.destroy(),this.gapDetectionIdleCallback&&bn&&bn(this.gapDetectionIdleCallback),this.initLoadIdleCallback&&bn&&bn(this.initLoadIdleCallback),this.subscription.unsubscribe(),this.sourceBuffer)try{this.mediaSource.removeSourceBuffer(this.sourceBuffer)}catch(e){if(!(e instanceof DOMException&&"NotFoundError"===e.name))throw e}this.sourceBuffer=null,this.downloadAbortController.abort(),this.switchAbortController.abort(),this.destroyAbortController.abort(),window.clearTimeout(this.loadByteRangeSegmentsTimeoutId)}selectForwardBufferSegments(e,t,i){return this.checkEjectedSegments(),this.isLive?this.selectForwardBufferSegmentsLive(e,i):this.selectForwardBufferSegmentsRecord(e,t,i)}selectForwardBufferSegmentsLive(e,t){if(this.playingRepresentationId!==this.downloadingRepresentationId){let i=e.findIndex((e=>t>=e.time.from&&t<e.time.to));this.liveUpdateSegmentIndex=i}return this.liveUpdateSegmentIndex<e.length?e.slice(this.liveUpdateSegmentIndex++):null}selectForwardBufferSegmentsRecord(e,t,i){let s=this.getForwardBufferDuration(i),r=e.findIndex((({status:e,time:{from:t,to:r}},a)=>{let n=t>i||t<=i&&r>=i||0===a&&0===i,o=Math.min(this.forwardBufferTarget,this.bufferLimit),u=this.preloadOnly&&t<=i+o||s<o&&r-t>=o||r<=i+o;return("none"===e||"partially_ejected"===e&&n&&u&&this.sourceBuffer&&qr(this.mediaSource,this.sourceBuffer)&&!(co(this.sourceBuffer.buffered,t)&&co(this.sourceBuffer.buffered,r)))&&n&&u}));if(-1===r)return null;if("byteRange"!==t)return e.slice(r,r+1);let a=e,n=0,o=0,u=[],h=this.preloadOnly?0:this.tuning.dash.segmentRequestSize,d=this.preloadOnly?this.forwardBufferTarget:0;for(let e=r;e<a.length&&(n<=h||o<=d);e++){let t=a[e];if(n+=t.byte.to+1-t.byte.from,o+=t.time.to+1-t.time.from,"none"!==t.status&&"partially_ejected"!==t.status)break;u.push(t)}return u}async loadSegments(e,t,i="auto"){Jo(t.segmentReference)?await this.loadTemplateSegment(e[0],t,i):await this.loadByteRangeSegments(e,t,i)}async loadTemplateSegment(e,t,i="auto"){e.status="downloading";let s={segment:e,loadedBytes:0,feedingBytes:0,fedBytes:0,representationId:t.id};this.activeSegments.add(s);let{range:r,url:a,signal:n,onProgress:o,onProgressTasks:h}=this.prepareTemplateFetchSegmentParams(e,t);this.failedDownloads&&n&&(await(0,u.ZC)(n,async function*(){let e=(0,u.rX)(this.failedDownloads,this.tuning.downloadBackoff);yield new Promise((t=>setTimeout(t,e)))}.bind(this))(),n.aborted&&this.abortActiveSegments([e]));try{let e=await this.fetcher.fetch(a,{range:r,signal:n,onProgress:o,priority:i,isLowLatency:this.isActiveLowLatency(),bufferOptimisation:this.tuning.dash.fetcherBufferOptimisation});if(this.lastDataObtainedTimestampMs=(0,u.tB)(),!e)return;let d=new DataView(e),l=_n(t.mime);if(!isFinite(s.segment.time.to)){let e=t.segmentReference.timescale;s.segment.time.to=l.getChunkEndTime(d,e)}o&&s.feedingBytes&&h?await Promise.all(h):await this.sourceBufferTaskQueue.append(d,n);let{serverDataReceivedTimestamp:c,serverDataPreparedTime:p}=l.getServerLatencyTimestamps(d);c&&p&&this.currentLiveSegmentServerLatency$.next(p-c),s.segment.status="downloaded",this.onSegmentFullyAppended(s,t.id),this.failedDownloads=0}catch(t){this.abortActiveSegments([e]),_a(t)||(this.failedDownloads++,this.updateRepresentationsBaseUrlIfNeeded())}}updateRepresentationsBaseUrlIfNeeded(){if(!this.tuning.dash.enableBaseUrlSupport||!this.baseUrls.length||this.failedDownloads<=this.tuning.dash.maxSegmentRetryCount)return;this.baseUrlsIndex=(this.baseUrlsIndex+1)%this.baseUrls.length;let e=this.baseUrls[this.baseUrlsIndex];for(let t of this.representations.values())Jo(t.segmentReference)?t.segmentReference.baseUrl=e:t.segmentReference.url=e}async loadByteRangeSegments(e,t,i="auto"){if(!e.length)return;for(let i of e)i.status="downloading",this.activeSegments.add({segment:i,loadedBytes:0,feedingBytes:0,fedBytes:0,representationId:t.id});let{range:s,url:r,signal:a,onProgress:n}=this.prepareByteRangeFetchSegmentParams(e,t);this.failedDownloads&&a&&(await(0,u.ZC)(a,async function*(){let e=(0,u.rX)(this.failedDownloads,this.tuning.downloadBackoff);yield new Promise((t=>{this.loadByteRangeSegmentsTimeoutId=window.setTimeout(t,e),(0,u.Rt)(window,"online").pipe((0,u.Oo)()).subscribe((()=>{t(),window.clearTimeout(this.loadByteRangeSegmentsTimeoutId)}))}))}.bind(this))(),a.aborted&&this.abortActiveSegments(e));try{await this.fetcher.fetch(r,{range:s,onProgress:n,signal:a,priority:i,bufferOptimisation:this.tuning.dash.fetcherBufferOptimisation}),this.lastDataObtainedTimestampMs=(0,u.tB)(),this.failedDownloads=0}catch(t){this.abortActiveSegments(e),_a(t)||(this.failedDownloads++,this.updateRepresentationsBaseUrlIfNeeded())}}prepareByteRangeFetchSegmentParams(e,t){if(Jo(t.segmentReference))throw new Error("Representation is not byte range type");let i=t.segmentReference.url,s={from:(0,No.default)(e,0).byte.from,to:(0,No.default)(e,-1).byte.to},{signal:r}=this.downloadAbortController;return{url:i,range:s,signal:r,onProgress:async(e,i)=>{if(!r.aborted)try{this.lastDataObtainedTimestampMs=(0,u.tB)(),await this.onSomeByteRangesDataLoaded({dataView:e,loaded:i,signal:r,onSegmentAppendFailed:()=>this.abort(),globalFrom:s?s.from:0,representationId:t.id})}catch(e){this.error$.next({id:"SegmentFeeding",category:u.h.VIDEO_PIPELINE,message:"Error when feeding segments",thrown:e})}}}}prepareTemplateFetchSegmentParams(e,t){if(!Jo(t.segmentReference))throw new Error("Representation is not template type");let i=new URL(e.url,t.segmentReference.baseUrl);this.isActiveLowLatency()&&i.searchParams.set("low-latency","yes");let s=i.toString(),{signal:r}=this.downloadAbortController,a=[],n=this.isActiveLowLatency()||this.tuning.dash.enableSubSegmentBufferFeeding&&this.liveUpdateSegmentIndex<3?(e,i)=>{if(!r.aborted)try{this.lastDataObtainedTimestampMs=(0,u.tB)();let s=this.onSomeTemplateDataLoaded({dataView:e,loaded:i,signal:r,onSegmentAppendFailed:()=>this.abort(),representationId:t.id});a.push(s)}catch(e){this.error$.next({id:"SegmentFeeding",category:u.h.VIDEO_PIPELINE,message:"Error when feeding segments",thrown:e})}}:void 0;return{url:s,signal:r,onProgress:n,onProgressTasks:a}}abortActiveSegments(e){for(let t of this.activeSegments)(0,Fo.default)(e,t.segment)&&this.abortSegment(t.segment)}async onSomeTemplateDataLoaded({dataView:e,representationId:t,loaded:i,onSegmentAppendFailed:s,signal:r}){if(!this.activeSegments.size||!qr(this.mediaSource,this.sourceBuffer))return;let a=this.representations.get(t);if(a)for(let n of this.activeSegments){let{segment:o}=n;if(n.representationId===t){if(r.aborted){s();continue}if(n.loadedBytes=i,n.loadedBytes>n.feedingBytes){let t=new DataView(e.buffer,e.byteOffset+n.feedingBytes,n.loadedBytes-n.feedingBytes),i=_n(a.mime).parseFeedableSegmentChunk(t,this.isLive);i?.byteLength&&(o.status="partially_fed",n.feedingBytes+=i.byteLength,await this.sourceBufferTaskQueue.append(i),n.fedBytes+=i.byteLength)}}}}async onSomeByteRangesDataLoaded({dataView:e,representationId:t,globalFrom:i,loaded:s,signal:r,onSegmentAppendFailed:a}){if(!this.activeSegments.size||!qr(this.mediaSource,this.sourceBuffer))return;let n=this.representations.get(t);if(n)for(let o of this.activeSegments){if(o.representationId!==t)continue;if(r.aborted){await a();continue}let{segment:u}=o,h=u.byte.from-i,d=u.byte.to-i,l=d-h+1,c=d<=s;if(h<s)if("downloading"===u.status&&c){u.status="downloaded";let i=new DataView(e.buffer,e.byteOffset+h,l);await this.sourceBufferTaskQueue.append(i,r)&&!r.aborted?this.onSegmentFullyAppended(o,t):await a()}else if(this.tuning.dash.enableSubSegmentBufferFeeding&&("downloading"===u.status||"partially_fed"===u.status)&&(o.loadedBytes=Math.min(l,s-h),o.loadedBytes>o.feedingBytes)){let i=new DataView(e.buffer,e.byteOffset+h+o.feedingBytes,o.loadedBytes-o.feedingBytes),s=o.loadedBytes===l?i:_n(n.mime).parseFeedableSegmentChunk(i);s?.byteLength&&(u.status="partially_fed",o.feedingBytes+=s.byteLength,await this.sourceBufferTaskQueue.append(s,r)&&!r.aborted?(o.fedBytes+=s.byteLength,o.fedBytes===l&&this.onSegmentFullyAppended(o,t)):await a())}}}onSegmentFullyAppended(e,t){if(!(0,u.wD)(this.sourceBuffer)&&qr(this.mediaSource,this.sourceBuffer)){!this.isLive&&ks.browser.isSafari&&this.tuning.useSafariEndlessRequestBugfix&&(co(this.sourceBuffer.buffered,e.segment.time.from,100)&&co(this.sourceBuffer.buffered,e.segment.time.to,100)||this.error$.next({id:"EmptyAppendBuffer",category:u.h.VIDEO_PIPELINE,message:"Browser stuck on empty result of adding segment to source buffer"})),this.playingRepresentationId=t,this.playingRepresentation$.next(this.playingRepresentationId),this.playingRepresentationInit$.next(this.parsedInitData.get(this.playingRepresentationId)),e.segment.status="fed",Yo(e.segment)&&(e.segment.size=e.fedBytes);for(let i of this.representations.values()){if(i.id===t)continue;let s=this.segments.get(i.id);if(s)for(let t of s)"fed"===t.status&&Math.round(t.time.from)===Math.round(e.segment.time.from)&&Math.round(t.time.to)===Math.round(e.segment.time.to)&&(t.status="none")}this.isActiveLowLatency()&&this.updateLowLatencyLiveIfNeeded(e.segment),this.activeSegments.delete(e),this.detectGapsWhenIdle(t,e.segment)}}abortSegment(e){"partially_fed"===e.status?e.status="partially_ejected":"partially_ejected"!==e.status&&(e.status="none");for(let t of this.activeSegments.values())if(t.segment===e){this.activeSegments.delete(t);break}}loadNextInit(){if(this.allInitsLoaded||this.initLoadIdleCallback)return;let e=null,t=!1;for(let[i,s]of this.initData.entries()){t||(t=s instanceof Promise),null===s&&(e=i)}if(!e)return void(this.allInitsLoaded=!0);if(t)return;let i=this.representations.get(e);i&&(this.initLoadIdleCallback=gn((()=>(0,jo.default)(this.loadInit(i,"low",!1),(()=>this.initLoadIdleCallback=null)))))}async loadInit(e,t="auto",i=!1){let s=this.tuning.dash.useFetchPriorityHints?t:"auto",r=(!i&&this.failedDownloads>0?(0,u.ZC)(this.destroyAbortController.signal,async function*(){let e=(0,u.rX)(this.failedDownloads,this.tuning.downloadBackoff);yield new Promise((t=>setTimeout(t,e)))}.bind(this))():Promise.resolve()).then((()=>this.fetcher.fetchRepresentation(e.segmentReference,_n(e.mime),s))).then((t=>{if(!t)return;let{init:i,dataView:s,segments:r}=t,a=s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength);this.initData.set(e.id,a);let n=r;this.isLive&&Jo(e.segmentReference)&&(n=this.getActualLiveStartingSegments(e.segmentReference)),(!this.isLive||!this.segments.has(e.id))&&this.segments.set(e.id,n),i&&this.parsedInitData.set(e.id,i)})).then((()=>this.failedDownloads=0),(t=>{this.initData.set(e.id,null),i&&this.error$.next({id:"LoadInits",category:u.h.WTF,message:"loadInit threw",thrown:t})}));return this.initData.set(e.id,r),r}async dropBuffer(){for(let e of this.segments.values())for(let t of e)t.status="none";await this.pruneBuffer(0,1/0,!0)}async pruneBuffer(e,t,i=!1){if(!this.sourceBuffer||!qr(this.mediaSource,this.sourceBuffer)||!this.playingRepresentationId||(0,u.wD)(e))return!1;this.checkEjectedSegments();let s=[],r=0,a=e=>{if(r>=t)return;s.push({...e.time});let i=Yo(e)?e.size??0:e.byte.to-e.byte.from;r+=i};for(let t of this.segments.values())for(let i of t){let t=i.time.to<=e-this.tuning.dash.bufferPruningSafeZone,s=i.time.from>=e+Math.min(this.forwardBufferTarget,this.bufferLimit);(t||s)&&"fed"===i.status&&a(i)}for(let e=0;e<this.sourceBuffer.buffered.length;e++){let t=1e3*this.sourceBuffer.buffered.start(e),i=1e3*this.sourceBuffer.buffered.end(e),s=0;for(let e of this.segments.values())for(let r of e)(0,Fo.default)(["none","partially_ejected"],r.status)&&Math.round(r.time.from)<=Math.round(t)&&Math.round(r.time.to)>=Math.round(i)&&s++;if(s===this.segments.size){a({time:{from:t,to:i},url:"",status:"none"})}}if(s.length&&i){let t=Math.min(this.forwardBufferTarget,this.bufferLimit)*this.tuning.dash.minSafeBufferThreshold;for(let i of this.segments.values())for(let s of i)s.time.from>=e+t&&"fed"===s.status&&a(s)}return!!s.length&&(s=(e=>{e.sort(((e,t)=>e.from-t.from));let t=[e[0]];for(let i=1;i<e.length;i++){let{from:s,to:r}=e[i],a=t[t.length-1];a.to>=s?a.to=Math.max(a.to,r):t.push(e[i])}return t})(s),(await Promise.all(s.map((e=>this.sourceBufferTaskQueue.remove(e.from,e.to))))).reduce(((e,t)=>e||t),!1))}async abortBuffer(){if(!this.sourceBuffer||!qr(this.mediaSource,this.sourceBuffer))return!1;let e=this.playingRepresentationId&&this.initData.get(this.playingRepresentationId),t=e instanceof ArrayBuffer?e:void 0;return this.sourceBufferTaskQueue.abort(t)}getDebugBufferState(){if(this.sourceBuffer&&qr(this.mediaSource,this.sourceBuffer)&&this.sourceBuffer.buffered.length)return{from:this.sourceBuffer.buffered.start(0),to:this.sourceBuffer.buffered.end(this.sourceBuffer.buffered.length-1)}}getBufferedTo(){return this.sourceBuffer&&qr(this.mediaSource,this.sourceBuffer)&&this.sourceBuffer.buffered.length?this.sourceBuffer.buffered.end(this.sourceBuffer.buffered.length-1):null}getForwardBufferDuration(e=this.getCurrentPosition()){return this.sourceBuffer&&qr(this.mediaSource,this.sourceBuffer)&&this.sourceBuffer.buffered.length&&!(0,u.wD)(e)?io(this.sourceBuffer.buffered,e):0}detectGaps(e,t){if(!this.sourceBuffer||!qr(this.mediaSource,this.sourceBuffer))return;let{buffered:i}=this.sourceBuffer,s={representation:e,from:t.time.from,to:t.time.to,persistent:!1};for(let e=0;e<i.length;e++){let r=1e3*i.start(e),a=1e3*i.end(e);if(!(a<=t.time.from||r>=t.time.to)){if(r<=t.time.from&&a>=t.time.to){s=void 0;break}a>t.time.from&&a<t.time.to&&(s.from=a),r<t.time.to&&r>t.time.from&&(s.to=r)}}s&&s.to-s.from>1&&!this.gaps.some((e=>s&&e.from===s.from&&e.to===s.to))&&this.gaps.push(s)}detectGapsWhenIdle(e,t){if(this.gapDetectionIdleCallback||!this.sourceBuffer||!qr(this.mediaSource,this.sourceBuffer))return;let{buffered:i}=this.sourceBuffer;this.gaps=this.gaps.filter((e=>{if(e.persistent)return!0;let t=Math.round(e.from),s=Math.round(e.to);for(let e=0;e<i.length;e++)if(t>=Math.round(1e3*i.start(e))&&s<=Math.round(1e3*i.end(e)))return!1;return!0})),this.gapDetectionIdleCallback=gn((()=>{try{this.detectGaps(e,t)}catch(e){this.error$.next({id:"GapDetection",category:u.h.WTF,message:"detectGaps threw",thrown:e})}finally{this.gapDetectionIdleCallback=null}}))}checkEjectedSegments(){if((0,u.wD)(this.sourceBuffer)||!qr(this.mediaSource,this.sourceBuffer)||(0,u.wD)(this.playingRepresentationId)||this.sourceBufferBufferedDiff&&!this.sourceBufferBufferedDiff.wasUpdated())return;let e=eu(this.sourceBuffer.buffered),t=100;for(let i of this.segments.values())for(let s of i){let{status:i}=s;if("fed"!==i&&"partially_ejected"!==i)continue;let r=Math.floor(s.time.from),a=Math.ceil(s.time.to),n=!1,o=0;for(let i=0;i<e.length;i+=2){let s=e[i],u=e[i+1];n||(n=s-t<=r&&u+t>=a),(r>=s&&r<u-t||a>s+t&&a<=u)&&(o+=1)}n||(1===o||this.gaps.some((e=>e.from===s.time.from||e.to===s.time.to))?s.status="partially_ejected":s.status="none")}}handleAsyncError(e,t){this.error$.next({id:t,category:u.h.VIDEO_PIPELINE,thrown:e,message:"Something went wrong"})}calculateDurationFromSegments(){if(!this.playingRepresentationId)return 0;let e=this.segments.get(this.playingRepresentationId);return(e?(0,No.default)(e,-1)?.time.to:0)||0}constructor(e,t,i,{fetcher:s,tuning:r,getCurrentPosition:a,isActiveLowLatency:n,compatibilityMode:o=!1,manifest:h}){this.currentLiveSegmentServerLatency$=new u.Ot(0),this.currentLowLatencySegmentLength$=new u.Ot(0),this.currentSegmentLength$=new u.Ot(0),this.onLastSegment$=new u.Ot(!1),this.fullyBuffered$=new u.Ot(!1),this.playingRepresentation$=new u.Ot(void 0),this.playingRepresentationInit$=new u.Ot(void 0),this.error$=new u.B7,this.gaps=[],this.subscription=new u.yU,this.allInitsLoaded=!1,this.activeSegments=new Set,this.downloadAbortController=new Ca,this.switchAbortController=new Ca,this.destroyAbortController=new Ca,this.useSmartRepresentationSwitch=!1,this.bufferLimit=1/0,this.failedDownloads=0,this.baseUrls=[],this.baseUrlsIndex=0,this.isLive=!1,this.liveUpdateSegmentIndex=0,this.liveInitialAdditionalOffset=0,this.isSeekingLive=!1,this.index=0,this.lastDataObtainedTimestampMs=0,this.loadByteRangeSegmentsTimeoutId=0,this.sourceBufferBufferedDiff=null,this.startWith=(0,u.ZC)(this.destroyAbortController.signal,async function*(e){let t=this.representations.get(e);(0,u.tZ)(t,`Cannot find representation ${e}`),this.playingRepresentationId=e,this.downloadingRepresentationId=e,this.sourceBuffer=this.mediaSource.addSourceBuffer(`${t.mime}; codecs="${t.codecs}"`),this.sourceBufferTaskQueue=new zo(this.sourceBuffer,this.tuning.dash.useAbortMSEFix),this.sourceBufferBufferedDiff=new tu(this.mediaSource,this.sourceBuffer),this.subscription.add((0,u.Rt)(this.sourceBuffer,"updateend").subscribe((()=>{this.maintain()}))),this.subscription.add((0,u.Rt)(this.sourceBuffer,"error").subscribe((()=>this.error$.next({id:"SourceBuffer",category:u.h.VIDEO_PIPELINE,message:"SourceBuffer Error event fired"})))),this.subscription.add(this.sourceBufferTaskQueue.bufferFull$.subscribe((e=>{let t=this.getCurrentPosition();if(!this.sourceBuffer||!t||!qr(this.mediaSource,this.sourceBuffer))return;let i=Math.min(this.bufferLimit,.8*yo(this.sourceBuffer.buffered));this.bufferLimit=i;let s=io(this.sourceBuffer.buffered,t),r=Math.min(this.forwardBufferTarget,this.bufferLimit)*this.tuning.dash.minSafeBufferThreshold;this.pruneBuffer(t,2*e,s<r).catch((e=>{this.handleAsyncError(e,"pruneBuffer")}))}))),this.subscription.add(this.sourceBufferTaskQueue.error$.subscribe((e=>this.error$.next(e)))),yield this.loadInit(t,"high",!0);let i=this.initData.get(t.id),s=this.segments.get(t.id),r=this.parsedInitData.get(t.id);(0,u.tZ)(i,"No init buffer for starting representation"),(0,u.tZ)(s,"No segments for starting representation"),i instanceof ArrayBuffer&&(this.searchGaps(s,t),yield this.sourceBufferTaskQueue.append(i,this.destroyAbortController.signal),this.playingRepresentation$.next(this.playingRepresentationId),this.playingRepresentationInit$.next(r))}.bind(this)),this.switchTo=(0,u.ZC)(this.destroyAbortController.signal,async function*(e,t=!1){if(!qr(this.mediaSource,this.sourceBuffer)||e===this.downloadingRepresentationId||e===this.switchingToRepresentationId)return;this.switchingToRepresentationId=e;let i=this.representations.get(e);(0,u.tZ)(i,`No such representation ${e}`);let s=this.segments.get(e),r=this.initData.get(e);if((0,u.wD)(r)||(0,u.wD)(s)?yield this.loadInit(i,"high",!1):r instanceof Promise&&(yield r),s=this.segments.get(e),(0,u.tZ)(s,"No segments for starting representation"),r=this.initData.get(e),r&&r instanceof ArrayBuffer&&this.sourceBuffer&&qr(this.mediaSource,this.sourceBuffer)){if(yield this.abort(),yield this.sourceBufferTaskQueue.append(r,this.downloadAbortController.signal),t)this.switchingToRepresentationId=void 0,this.downloadingRepresentationId=e,yield this.dropBuffer();else{let t=this.getCurrentPosition();(0,u.R)(t)&&!this.isLive&&(this.bufferLimit=1/0,await this.pruneBuffer(t,1/0,!0)),this.switchingToRepresentationId=void 0,this.downloadingRepresentationId=e}this.maintain()}}.bind(this)),this.switchToOld=(0,u.ZC)(this.destroyAbortController.signal,async function*(e,t=!1){if(!qr(this.mediaSource,this.sourceBuffer)||e===this.downloadingRepresentationId||e===this.switchingToRepresentationId)return;this.switchingToRepresentationId=e;let i=this.representations.get(e);(0,u.tZ)(i,`No such representation ${e}`);let s=this.segments.get(e),r=this.initData.get(e);if((0,u.wD)(r)||(0,u.wD)(s)?yield this.loadInit(i,"high",!1):r instanceof Promise&&(yield r),s=this.segments.get(e),(0,u.tZ)(s,"No segments for starting representation"),r=this.initData.get(e),r&&r instanceof ArrayBuffer&&this.sourceBuffer&&qr(this.mediaSource,this.sourceBuffer))if(yield this.abort(),yield this.sourceBufferTaskQueue.append(r,this.downloadAbortController.signal),t)this.switchingToRepresentationId=void 0,this.downloadingRepresentationId=e,yield this.dropBuffer(),this.maintain();else{let t=this.getCurrentPosition();(0,u.R)(t)&&(this.isLive||(this.bufferLimit=1/0,await this.pruneBuffer(t,1/0,!0)),this.maintain(t)),this.switchingToRepresentationId=void 0,this.downloadingRepresentationId=e}}.bind(this)),this.seekLive=(0,u.ZC)(this.destroyAbortController.signal,async function*(e){let t=(0,Uo.default)(e,(e=>e.representations));if(!this.downloadingRepresentationId||!t.length)return;this.isSeekingLive=!0;for(let e of this.representations.keys()){let i=t.find((t=>t.id===e));i&&this.representations.set(e,i);let s=this.representations.get(e);if(!s||!Jo(s.segmentReference))return void(this.isSeekingLive=!1);let r=this.getActualLiveStartingSegments(s.segmentReference);this.segments.set(s.id,r)}let i=this.switchingToRepresentationId??this.downloadingRepresentationId,s=this.representations.get(i);(0,u.tZ)(s,`Representation not found by id ${i}`);let r=this.segments.get(i);(0,u.tZ)(r,"No segments for starting representation");let a=this.initData.get(i);if((0,u.tZ)(a,"No init buffer for starting representation"),!(a instanceof ArrayBuffer))return void(this.isSeekingLive=!1);let n=this.getDebugBufferState();this.liveUpdateSegmentIndex=0,yield this.abort(),n&&(yield this.sourceBufferTaskQueue.remove(1e3*n.from,1e3*n.to,this.destroyAbortController.signal)),this.searchGaps(r,s),yield this.sourceBufferTaskQueue.append(a,this.destroyAbortController.signal),this.isSeekingLive=!1}.bind(this)),this.fetcher=s,this.tuning=r,this.compatibilityMode=o,this.forwardBufferTarget=r.dash.forwardBufferTargetAuto,this.getCurrentPosition=a,this.isActiveLowLatency=n,this.isLive=!!h?.live,this.baseUrls=h?.baseUrls??[],this.initData=new Map(i.map((e=>[e.id,null]))),this.segments=new Map,this.parsedInitData=new Map,this.representations=new Map(i.map((e=>[e.id,e]))),this.kind=e,this.mediaSource=t,this.sourceBuffer=null}},su=class{onHeadersReceived(e){let{type:t,reused:i}=Va(e);this.lastConnectionType$.next(t),this.lastConnectionReused$.next(i)}async fetchRepresentation(e,t,i="auto"){let{type:s}=e;switch(s){case"byteRange":return await this.fetchByteRangeRepresentation(e,t,i)??null;case"template":return await this.fetchTemplateRepresentation(e,i)??null;default:(0,u.xb)(s)}}destroy(){this.abortAllController.abort(),this.tracer.end(),this.subscription.unsubscribe()}async doFetch(e,t){let i=await Ma(e,t);if(i.ok)return i;let s=await i.text(),r=parseInt(s);if(!isNaN(r))switch(r){case 1:this.recoverableError$.next({id:"VideoDataLinkExpiredError",message:"Video data links have expired",category:u.h.FATAL});break;case 8:this.recoverableError$.next({id:"VideoDataLinkBlockedForFloodError",message:"Url blocked for flood",category:u.h.FATAL});break;case 18:this.recoverableError$.next({id:"VideoDataLinkIllegalIpChangeError",message:"Client IP has changed",category:u.h.FATAL});break;case 21:this.recoverableError$.next({id:"VideoDataLinkIllegalHostChangeError",message:"Request HOST has changed",category:u.h.FATAL});break;default:this.error$.next({id:"GeneralVideoDataFetchError",message:`Generic video data fetch error (${r})`,category:u.h.FATAL})}}unsubscribeAbortSubscription(e){e&&(e.unsubscribe(),this.subscription.remove(e))}constructor({throughputEstimator:e,requestQuic:t,tracer:i,compatibilityMode:s=!1,useEnableSubtitlesParam:r=!1}){this.manifestRequested$=new u.B7,this.firstBytesManifest$=new u.B7,this.firstBytesRequested$=new u.B7,this.firstBytesReceived$=new u.B7,this.lastConnectionType$=new u.Ot(void 0),this.lastConnectionReused$=new u.Ot(void 0),this.lastRequestFirstBytes$=new u.Ot(void 0),this.recoverableError$=new u.B7,this.error$=new u.B7,this.abortAllController=new Ca,this.subscription=new u.V6,this.fetchManifest=(0,u.ZC)(this.abortAllController.signal,async function*(e){let t=this.tracer.createComponentTracer("FetchManifest"),i=e;this.requestQuic&&(i=Pa(i)),!this.compatibilityMode&&this.useEnableSubtitlesParam&&(i=Fa(i)),this.manifestRequested$.next();let s=yield this.doFetch(i,{signal:this.abortAllController.signal}).catch(ru);return s?(t.log("success",(0,u.YO)({url:i,message:"Request successfully executed"})),t.end(),this.onHeadersReceived(s.headers),this.firstBytesManifest$.next(),s.text()):(t.error("error",(0,u.YO)({url:i,message:"No data in request manifest"})),t.end(),null)}.bind(this)),this.fetch=(0,u.ZC)(this.abortAllController.signal,async function*(e,{rangeMethod:t=(this.compatibilityMode?0:1),range:i,onProgress:s,priority:r="auto",signal:a,measureThroughput:n=!0,isLowLatency:o=!1,bufferOptimisation:h=!1}={}){let d=e,l=new Headers,c=this.tracer.createComponentTracer("Fetch");if(i)switch(t){case 0:l.append("Range",`bytes=${i.from}-${i.to}`);break;case 1:{let e=new URL(d,location.href);e.searchParams.append("bytes",`${i.from}-${i.to}`),d=e.toString();break}default:(0,u.xb)(t)}this.requestQuic&&(d=Pa(d));let p,f=this.abortAllController.signal;if(a){let e=new Ca;if(p=(0,u.h1)((0,u.Rt)(this.abortAllController.signal,"abort"),(0,u.Rt)(a,"abort")).subscribe((()=>{try{e.abort()}catch(e){ru(e)}})),this.subscription.add(p),this.abortAllController.signal.aborted||a.aborted)try{e.abort()}catch(e){ru(e)}f=e.signal}let m=0,g=(0,u.tB)();c.log("startRequest",(0,u.YO)({url:d,priority:r,rangeMethod:t,range:i,isLowLatency:o,requestStartedAt:g})),this.firstBytesRequested$.next();let b=yield this.doFetch(d,{priority:r,headers:l,signal:f}),v=(0,u.tB)();if(!b)return c.error("error",{message:"No response in request"}),c.end(),this.unsubscribeAbortSubscription(p),null;if(this.throughputEstimator?.addRawRtt(v-g),!b.ok||!b.body){this.unsubscribeAbortSubscription(p);let e=`Fetch error ${b.status}: ${b.statusText}`;return c.error("error",{message:e}),c.end(),Promise.reject(new Error(`Fetch error ${b.status}: ${b.statusText}`))}if(this.onHeadersReceived(b.headers),!s&&!n){this.unsubscribeAbortSubscription(p);let e=(0,u.tB)(),t={requestStartedAt:g,requestEndedAt:e,duration:e-g};return c.log("endRequest",(0,u.YO)(t)),c.end(),b.arrayBuffer()}let y=b.body;if(n){let e;[y,e]=b.body.tee(),this.throughputEstimator?.trackStream(e,o)}let S,w=y.getReader(),T=parseInt(b.headers.get("content-length")??"",10);Number.isFinite(T)&&(S=T),!S&&i&&(S=i.to-i.from+1);let $=S?new Uint8Array(S):new Uint8Array(0),x=!1,k=e=>{this.unsubscribeAbortSubscription(p),x=!0,ru(e)},L=(0,u.ZC)(f,async function*({done:e,value:t}){if(0===m&&(this.lastRequestFirstBytes$.next((0,u.tB)()-g),this.firstBytesReceived$.next()),f.aborted)this.unsubscribeAbortSubscription(p);else if(!e&&t){if(h&&S)$.set(t,m),m+=t.byteLength;else{let e=new Uint8Array($.length+t.length);e.set($),e.set(t,$.length),$=e,m+=t.byteLength}s?.(new DataView($.buffer),m),yield w?.read().then(L,k)}}.bind(this));yield w?.read().then(L,k),this.unsubscribeAbortSubscription(p);let R=(0,u.tB)(),E={failed:x,requestStartedAt:g,requestEndedAt:R,duration:R-g};return x?(c.error("endRequest",(0,u.YO)(E)),c.end(),null):(c.log("endRequest",(0,u.YO)(E)),c.end(),$.buffer)}.bind(this)),this.fetchByteRangeRepresentation=(0,u.ZC)(this.abortAllController.signal,async function*(e,t,i){if("byteRange"!==e.type)return null;let s,r,{from:a,to:n}=e.initRange,o=a,u=n,h=!1;e.indexRange&&(s=e.indexRange.from,r=e.indexRange.to,h=n+1===s,h&&(o=Math.min(s,a),u=Math.max(r,n))),o=Math.min(o,0);let d=yield this.fetch(e.url,{range:{from:o,to:u},priority:i,measureThroughput:!1});if(!d)return null;let l=new DataView(d,a-o,n-o+1);if(!t.validateData(l))throw new Error("Invalid media file");let c,p=t.parseInit(l),f=e.indexRange??t.getIndexRange(p);if(!f)throw new ReferenceError("No way to load representation index");if(h)c=new DataView(d,f.from-o,f.to-f.from+1);else{let t=yield this.fetch(e.url,{range:f,priority:i,measureThroughput:!1});if(!t)return null;c=new DataView(t)}let m=t.parseSegments(c,p,f);return{init:p,dataView:new DataView(d),segments:m}}.bind(this)),this.fetchTemplateRepresentation=(0,u.ZC)(this.abortAllController.signal,async function*(e,t){if("template"!==e.type)return null;let i=new URL(e.initUrl,e.baseUrl).toString(),s=yield this.fetch(i,{priority:t,measureThroughput:!1});return s?{init:null,segments:e.segments.map((e=>({...e,status:"none",size:void 0}))),dataView:new DataView(s)}:null}.bind(this)),this.throughputEstimator=e,this.requestQuic=t,this.compatibilityMode=s,this.tracer=i.createComponentTracer("Fetcher"),this.useEnableSubtitlesParam=r}},ru=e=>{if(!_a(e))throw e},au=class e{updateLive(e){this.processStreams(e?.streams.text)}seekLive(e){this.processStreams(e)}maintain(e=this.getCurrentPosition()){if(!(0,u.wD)(e))for(let t of this.representations)for(let i of t){let t=i.segmentReference,s=t.segments.length,r=t.segments[0].time.from,a=t.segments[s-1].time.to;if(e<r||e>a)continue;let n=t.segments.find((t=>t.time.from<=e&&t.time.to>=e));!n||this.currentSegment?.time.from===n.time.from&&this.currentSegment.time.to===n.time.to||(this.currentSegment=n,this.currentRepresentation$.next({...i,label:"Live Text",language:"ru",isAuto:!0,url:new URL(n.url,t.baseUrl).toString()}))}}destroy(){this.currentRepresentation$.next(null),this.currentSegment=null,this.representations=[]}processStreams(t){for(let i of t??[]){let t=e.filterRepresentations(i.representations);if(t){this.representations[this.representationsCursor]=t,this.representationsCursor=(this.representationsCursor+1)%this.maxRepresentations;break}}}static isSupported(t){return!!t?.some((t=>e.filterRepresentations(t.representations)))}static filterRepresentations(e){return e?.filter((e=>"text"===e.kind&&"segmentReference"in e&&Jo(e.segmentReference)))}constructor(e,t){this.currentRepresentation$=new u.Ot(null),this.maxRepresentations=4,this.representationsCursor=0,this.representations=[],this.currentSegment=null,this.getCurrentPosition=t.getCurrentPosition,this.processStreams(e)}},nu=["progress","play","seeked","stalled","waiting"],ou=["timeupdate","progress","loadeddata","playing","seeked"],uu=class{setSmartRepresentationSwitch(e){this.bufferManagers.forEach((t=>t.setSmartRepresentationSwitch(e)))}async seekLive(e){(0,u.tZ)(this.element);let t="active"!==this.liveStreamStatus$.getValue()?(0,u.tB)()-this.liveStreamEndTimestamp:0,i=this.normolizeLiveOffset(e+t);this.isActiveLive$.next(0===i),this.manifestUrlString=is(this.manifestUrlString,i,2),this.manifest=await this.updateManifest(),this.manifest&&(this.isJumpGapAfterSeekLive=!0,await(this.videoBufferManager?.seekLive(this.manifest.streams.video)),await(this.audioBufferManager?.seekLive(this.manifest.streams.audio)),this.liveTextManager?.seekLive(this.manifest.streams.text))}initBuffer(){(0,u.tZ)(this.element),this.state$.setState("running");let e=(0,u.Rt)(this.element,"timeupdate");this.tuning.dash.timeupdateEventTickThrottle&&(e=e.pipe((0,u.nF)(this.tuning.dash.timeupdateEventTickThrottle))),this.subscription.add((0,u.h1)(...nu.map((e=>(0,u.Rt)(this.element,e))),(0,u.Rt)(window,"online"),e).subscribe((()=>this.tick()),(e=>{this.error$.next({id:"DashVKPlayer",category:u.h.WTF,message:"Internal logic error",thrown:e})}))),this.subscription.add((0,u.Rt)(this.element,"progress").subscribe((()=>{this.element&&this.element.readyState===HTMLMediaElement.HAVE_CURRENT_DATA&&!this.element.seeking&&(this.element.currentTime=this.element.currentTime)}))),this.subscription.add((0,u.Rt)(this.element,"waiting").subscribe((()=>{this.tuning.dash.useVideoElementWaitingCurrentTimeReassign&&this.element&&this.element.readyState===HTMLMediaElement.HAVE_CURRENT_DATA&&!this.element.seeking&&co(this.element.buffered,1e3*this.element.currentTime)&&(this.element.currentTime=this.element.currentTime);this.stallWatchdogSubscription&&(this.stallWatchdogSubscription.unsubscribe(),this.subscriptionRemovable.remove(this.stallWatchdogSubscription)),this.stallWatchdogSubscription=(0,u.YP)(50).subscribe((()=>{if(!this.element||"open"!==this.source?.readyState)return;let e=this.currentStallDuration$.getValue();e+=50,this.currentStallDuration$.next(e);let t={timeInWaiting:e},i=(0,u.tB)(),s=this.videoBufferManager?.lastDataObtainedTimestamp??0;this.videoLastDataObtainedTimestamp$.next(s);let r=this.audioBufferManager?.lastDataObtainedTimestamp??0,a=this.videoBufferManager?.getForwardBufferDuration()??0,n=this.audioBufferManager?.getForwardBufferDuration()??0,o=a<100&&i-s>this.tuning.dash.crashOnStallTWithoutDataTimeout,h=this.audioBufferManager&&n<100&&i-r>this.tuning.dash.crashOnStallTWithoutDataTimeout;if((o||h)&&e>this.tuning.dash.crashOnStallTWithoutDataTimeout||e>=this.tuning.dash.crashOnStallTimeout)throw new Error(`Stall timeout exceeded: ${e} ms`);if(this.isLive$.getValue()&&e%2e3==0){let e=this.normolizeLiveOffset(-1*this.livePositionFromPlayer$.getValue()*1e3);this.seekLive(e).catch((e=>{this.error$.next({id:"stallIntervalCallback",category:u.h.VIDEO_PIPELINE,message:"stallIntervalCallback failed",thrown:e})})),t.liveLastOffset=e}else{let e=1e3*this.element.currentTime;this.videoBufferManager?.maintain(e),this.audioBufferManager?.maintain(e),t.position=e}this.tracer.log("stallIntervalCallback",(0,u.YO)(t))}),(e=>{this.error$.next({id:"StallWatchdogCallback",category:u.h.NETWORK,message:"Can't restore DASH after stall.",thrown:e})})),this.subscriptionRemovable.add(this.stallWatchdogSubscription)}))),this.tick()}async switchRepresentation(e,t,i=!1){let s={video:this.videoBufferManager,audio:this.audioBufferManager,text:null}[e];return this.tuning.useNewSwitchTo?this.currentStallDuration$.getValue()>0?s?.switchToWithPreviousAbort(t,i):s?.switchTo(t,i):s?.switchToOld(t,i)}async seek(e,t){let i;(0,u.tZ)(this.element),(0,u.tZ)(this.videoBufferManager),i=t||1e3*this.element.duration<=this.tuning.dashSeekInSegmentDurationThreshold||Math.abs(1e3*this.element.currentTime-e)<=this.tuning.dashSeekInSegmentAlwaysSeekDelta?e:Math.max(this.videoBufferManager.findSegmentStartTime(e)??e,this.audioBufferManager?.findSegmentStartTime(e)??e),this.warmUpMediaSourceIfNeeded(i),co(this.element.buffered,i)||await Promise.all([this.videoBufferManager.abort(),this.audioBufferManager?.abort()]),!(0,u.wD)(this.element)&&!(0,u.wD)(this.videoBufferManager)&&(this.videoBufferManager.maintain(i),this.audioBufferManager?.maintain(i),this.element.currentTime=i/1e3,this.tracer.log("seek",(0,u.YO)({requestedPosition:e,forcePrecise:t,position:i})))}warmUpMediaSourceIfNeeded(e=this.element?.currentTime){(0,u.R)(this.element)&&(0,u.R)(this.source)&&(0,u.R)(e)&&"ended"===this.source?.readyState&&1e3*this.element.duration-e>this.tuning.dash.seekBiasInTheEnd&&this.bufferManagers.forEach((e=>e.warmUpMediaSource()))}get isStreamEnded(){return"ended"===this.source?.readyState}stop(){this.tracer.log("stop"),this.element?.querySelectorAll("source").forEach((e=>{URL.revokeObjectURL(e.src),e.remove()})),this.element=null,this.source=null,this.manifest=null,this.currentVideoRepresentation$.next(void 0),this.videoBufferManager?.destroy(),this.videoBufferManager=null,this.audioBufferManager?.destroy(),this.audioBufferManager=null,this.bufferManagers=[],this.state$.setState("none")}setBufferTarget(e){for(let t of this.bufferManagers)t.setTarget(e)}getStreams(){return this.manifest?.streams}getCodecs(){return this.manifest?.codecs}setPreloadOnly(e){for(let t of this.bufferManagers)t.setPreloadOnly(e)}destroy(){this.subscription.unsubscribe(),this.subscriptionRemovable.unsubscribe(),this.representationSubscription.unsubscribe(),this.timeoutSourceOpenId&&clearTimeout(this.timeoutSourceOpenId),this.destroyController.abort(),this.fetcher.destroy(),this.stop(),"open"===this.source?.readyState&&Array.from(this.source.sourceBuffers).every((e=>!e.updating))&&this.source.endOfStream(),this.source=null,this.tracer.end()}initTracerSubscription(){let e=(0,u.kD)(this.tracer.error.bind(this.tracer));this.subscription.add(this.error$.subscribe(e("error")))}isManualDecreasePlaybackInLive(){return!(!this.element||!this.isLive$.getValue())&&1-this.element.playbackRate>this.tuning.dashCmafLive.lowLatency.playbackCatchupSpeedup}normolizeLiveOffset(e){return 1e3*Math.trunc(e/1e3)}async updateLive(){this.isUpdatingLive=!0,this.manifest=await this.updateManifest(),this.manifest&&(this.bufferManagers.forEach((e=>e.updateLive(this.manifest))),this.liveTextManager?.updateLive(this.manifest)),this.isUpdatingLive=!1}jumpGap(){if(!this.element||!this.videoBufferManager)return;let e=this.videoBufferManager.getBufferedTo();if(null===e)return;let t=this.isActiveLive$.getValue()&&this.isLowLatency$.getValue(),i=this.isJumpGapAfterSeekLive,s=this.element.currentTime;this.isJumpGapAfterSeekLive&&!t&&this.element.currentTime>e&&(this.isJumpGapAfterSeekLive=!1,this.element.currentTime=0);let r=1e3*this.element.currentTime,a=null,n=this.element.readyState===HTMLMediaElement.HAVE_METADATA?this.tuning.endGapTolerance:0;for(let e of this.bufferManagers)for(let t of e.gaps)(t.persistent||e.playingRepresentation$.getValue()===t.representation)&&t.from-n<=r&&t.to+n>r&&(1e3*this.element.duration-t.to<this.tuning.endGapTolerance?a=1/0:(null===a||t.to>a)&&(a=t.to));if(null!==a){let e=a+10;this.gapWatchdogSubscription.unsubscribe(),this.gapWatchdogActive=!1,e===1/0?this.forceEnded$.next():(this.element.currentTime=e/1e3,this.tracer.log("jumpGap",(0,u.YO)({isJumpGapAfterSeekLive:i,isActiveLowLatency:t,initialCurrentTime:s,jumpTo:e,resultCurrentTime:this.element.currentTime})))}}calculateDurationFromSegments(){return Math.max(this.videoBufferManager?.calculateDurationFromSegments()||0,this.audioBufferManager?.calculateDurationFromSegments()||0)}constructor(e){this.element=null,this.manifestUrlString="",this.source=null,this.manifest=null,this.bufferManagers=[],this.subscription=new u.yU,this.subscriptionRemovable=new u.V6,this.representationSubscription=new u.yU,this.state$=new Ps("none"),this.currentVideoRepresentation$=new u.Ot(void 0),this.currentVideoRepresentationInit$=new u.Ot(void 0),this.currentAudioRepresentation$=new u.Ot(void 0),this.currentVideoSegmentLength$=new u.Ot(0),this.currentAudioSegmentLength$=new u.Ot(0),this.error$=new u.B7,this.manifestRequested$=new u.B7,this.firstBytesManifest$=new u.B7,this.manifestReceived$=new u.B7,this.firstBytesRequested$=new u.B7,this.firstBytesReceived$=new u.B7,this.lastConnectionType$=new u.Ot(void 0),this.lastConnectionReused$=new u.Ot(void 0),this.lastRequestFirstBytes$=new u.Ot(void 0),this.currentLiveTextRepresentation$=new u.Ot(null),this.isLive$=new u.Ot(!1),this.isActiveLive$=new u.Ot(!1),this.isLowLatency$=new u.Ot(!1),this.liveDuration$=new u.Ot(0),this.liveSeekableDuration$=new u.Ot(0),this.liveAvailabilityStartTime$=new u.Ot(0),this.liveStreamStatus$=new u.Ot(void 0),this.bufferLength$=new u.Ot(0),this.liveLatency$=new u.Ot(void 0),this.liveLoadBufferLength$=new u.Ot(0),this.livePositionFromPlayer$=new u.Ot(0),this.currentStallDuration$=new u.Ot(0),this.videoLastDataObtainedTimestamp$=new u.Ot(0),this.fetcherRecoverableError$=new u.B7,this.fetcherError$=new u.B7,this.liveStreamEndTimestamp=0,this.isUpdatingLive=!1,this.isJumpGapAfterSeekLive=!1,this.forceEnded$=new u.B7,this.gapWatchdogActive=!1,this.destroyController=new Ca,this.initManifest=(0,u.ZC)(this.destroyController.signal,async function*(e,t,i){this.tracer.log("initManifest"),this.element=e,this.manifestUrlString=is(t,i,2),this.state$.startTransitionTo("manifest_ready"),this.manifest=yield this.updateManifest(),this.manifest?.streams.video.length?this.state$.setState("manifest_ready"):this.error$.next({id:"NoRepresentations",category:u.h.PARSER,message:"No playable video representations"})}.bind(this)),this.updateManifest=(0,u.ZC)(this.destroyController.signal,async function*(){this.tracer.log("updateManifestStart",{manifestUrl:this.manifestUrlString});let e=yield this.fetcher.fetchManifest(this.manifestUrlString).catch((e=>{!this.manifest&&!this.bufferLength$.getValue()&&this.error$.next({id:"LoadManifest",category:u.h.NETWORK,message:"Failed to load manifest",thrown:e})}));if(!e)return null;let t=null;try{t=Ka(e??"",this.manifestUrlString),this.manifestReceived$.next()}catch(t){let i=Oa(e)??{id:"ManifestParsing",category:u.h.PARSER,message:"Failed to parse MPD manifest",thrown:t};this.error$.next(i)}if(!t)return null;let i=(e,t,i)=>!!(this.element?.canPlayType?.(t)&&gs()?.isTypeSupported?.(`${t}; codecs="${i}"`)||"text"===e);if(t.live){this.isLive$.next(!!t.live);let{availabilityStartTime:e,latestSegmentPublishTime:i,streamIsUnpublished:s,streamIsAlive:r}=t.live,a=(t.duration??0)/1e3;this.liveSeekableDuration$.next(-1*a),this.liveDuration$.next((i-e)/1e3),this.liveAvailabilityStartTime$.next(t.live.availabilityStartTime);let n="active";r||(n=s?"unpublished":"unexpectedly_down"),this.liveStreamStatus$.next(n)}let s,r,a={text:t.streams.text,video:[],audio:[]};for(let e of["video","audio"]){let n,o=t.streams[e].filter((({mime:t,codecs:s})=>i(e,t,s)));if(a[e]=o,this.tuning.dash.codecsPrioritizeEnabled){let t=o.map((({codecs:e})=>e));"audio"===e&&(r=hn(t),n=r[0]),"video"===e&&(s=un(t),n=this.forceVideoCodec&&(0,Vo.default)(s,this.forceVideoCodec)?this.forceVideoCodec:s[0]),n&&(a[e]=o.filter((({codecs:e})=>dn(e)===n)))}else{let t=new Set(o.map((({codecs:e})=>e)));n=on(t),n&&(a[e]=o.filter((({codecs:e})=>e.startsWith(n))))}if("video"===e){let e=this.tuning.preferHDR,t=a.video.some((e=>e.hdr)),i=a.video.some((e=>!e.hdr));ks.display.isHDR&&e&&t?a.video=a.video.filter((e=>e.hdr)):i&&(a.video=a.video.filter((e=>!e.hdr)))}}let n={...t,streams:a};return this.tuning.dash.codecsPrioritizeEnabled&&(n.codecs={video:s,audio:r}),this.tracer.log("updateManifestEnd",(0,u.YO)(n)),n}.bind(this)),this.initRepresentations=(0,u.ZC)(this.destroyController.signal,async function*(e,t,i){this.tracer.log("initRepresentationsStart",(0,u.YO)({initialVideo:e,initialAudio:t,sourceHls:i})),(0,u.tZ)(this.manifest),(0,u.tZ)(this.element),this.representationSubscription.unsubscribe(),this.representationSubscription=new u.yU,this.state$.startTransitionTo("representations_ready");let s=e=>{this.representationSubscription.add((0,u.Rt)(e,"error").pipe((0,u.pb)((e=>!!this.element?.played.length))).subscribe((e=>{this.error$.next({id:"VideoSource",category:u.h.VIDEO_PIPELINE,message:"Unexpected video source error",thrown:e})})))};this.source=vs();let r=document.createElement("source");if(s(r),r.src=URL.createObjectURL(this.source),this.element.appendChild(r),bs())if(i){let e=document.createElement("source");s(e),e.type="application/x-mpegurl",e.src=i.url,this.element.appendChild(e)}else this.element.disableRemotePlayback=!0;this.isActiveLive$.next(this.isLive$.getValue());let a={fetcher:this.fetcher,tuning:this.tuning,getCurrentPosition:()=>this.element?1e3*this.element.currentTime:void 0,isActiveLowLatency:()=>this.isActiveLive$.getValue()&&this.isLowLatency$.getValue(),manifest:this.manifest},n=this.manifest.streams.video.reduce(((e,t)=>[...e,...t.representations]),[]);if(this.videoBufferManager=new iu("video",this.source,n,a),this.bufferManagers=[this.videoBufferManager],(0,u.R)(t)){let e=this.manifest.streams.audio.reduce(((e,t)=>[...e,...t.representations]),[]);this.audioBufferManager=new iu("audio",this.source,e,a),this.bufferManagers.push(this.audioBufferManager)}au.isSupported(this.manifest.streams.text)&&!this.isLowLatency$.getValue()&&(this.liveTextManager=new au(this.manifest.streams.text,a)),this.representationSubscription.add(this.fetcher.lastRequestFirstBytes$.subscribe(this.lastRequestFirstBytes$));let o=()=>{this.stallWatchdogSubscription?.unsubscribe(),this.currentStallDuration$.next(0)};if(this.representationSubscription.add((0,u.h1)(...ou.map((e=>(0,u.Rt)(this.element,e)))).pipe((0,u.Tj)((e=>this.element?io(this.element.buffered,1e3*this.element.currentTime):0)),(0,u.jX)(),(0,u.Mi)((e=>{e>this.tuning.dash.bufferEmptinessTolerance&&o()}))).subscribe(this.bufferLength$)),this.representationSubscription.add((0,u.h1)((0,u.Rt)(this.element,"ended"),this.forceEnded$).subscribe((()=>{o()}))),this.isLive$.getValue()){this.subscription.add(this.liveDuration$.pipe((0,u.jX)()).subscribe((e=>this.liveStreamEndTimestamp=(0,u.tB)()))),this.subscription.add((0,u.Rt)(this.element,"pause").subscribe((()=>{this.livePauseWatchdogSubscription=(0,u.YP)(1e3).subscribe((e=>{let t=ss(this.manifestUrlString,2);this.manifestUrlString=is(this.manifestUrlString,t+1e3,2),"active"===this.liveStreamStatus$.getValue()&&this.updateManifest()})),this.subscription.add(this.livePauseWatchdogSubscription)}))).add((0,u.Rt)(this.element,"play").subscribe((e=>this.livePauseWatchdogSubscription?.unsubscribe()))),this.representationSubscription.add((0,u.kg)({isActiveLive:this.isActiveLive$,isLowLatency:this.isLowLatency$}).pipe((0,u.Tj)((({isActiveLive:e,isLowLatency:t})=>e&&t)),(0,u.jX)()).subscribe((e=>{this.isManualDecreasePlaybackInLive()||Eo(this.element,1)}))),this.representationSubscription.add((0,u.kg)({bufferLength:this.bufferLength$,isActiveLive:this.isActiveLive$,isLowLatency:this.isLowLatency$}).pipe((0,u.pb)((({bufferLength:e,isActiveLive:t,isLowLatency:i})=>t&&i&&!!e))).subscribe((({bufferLength:e})=>this.liveBuffer.next(e)))),this.representationSubscription.add(this.videoBufferManager.currentLowLatencySegmentLength$.subscribe((e=>{if(!this.isActiveLive$.getValue()&&!this.isLowLatency$.getValue()&&!e)return;let t=this.liveSeekableDuration$.getValue()-e/1e3;this.liveSeekableDuration$.next(Math.max(t,-1*this.tuning.dashCmafLive.maxLiveDuration)),this.liveDuration$.next(this.liveDuration$.getValue()+e/1e3)}))),this.representationSubscription.add((0,u.kg)({isLive:this.isLive$,rtt:this.throughputEstimator.rtt$,bufferLength:this.bufferLength$,segmentServerLatency:this.videoBufferManager.currentLiveSegmentServerLatency$}).pipe((0,u.pb)((({isLive:e})=>e)),(0,u.jX)(((e,t)=>t.bufferLength<e.bufferLength)),(0,u.Tj)((({rtt:e,bufferLength:t,segmentServerLatency:i})=>(e/2+t+i+ss(this.manifestUrlString,2))/1e3))).subscribe(this.liveLatency$)),this.representationSubscription.add((0,u.kg)({liveBuffer:this.liveBuffer.smoothed$,isActiveLive:this.isActiveLive$,isLowLatency:this.isLowLatency$}).subscribe((({liveBuffer:e,isActiveLive:t,isLowLatency:i})=>{if(!i||!t)return;let s=this.tuning.dashCmafLive.lowLatency.maxTargetOffset,r=this.tuning.dashCmafLive.lowLatency.maxTargetOffsetDeviation,a=this.tuning.dashCmafLive.lowLatency.playbackCatchupSpeedup,n=e-s;if(this.isManualDecreasePlaybackInLive())return;let o=1;Math.abs(n)>r&&(o=1+Math.sign(n)*a),Eo(this.element,o)}))),this.representationSubscription.add(this.bufferLength$.subscribe((e=>{let t=0;if(e){let e=1e3*(this.element?.currentTime??0);t=Math.min(...this.bufferManagers.map((t=>t.getLiveSegmentsToLoadState(this.manifest)?.to??e)))-e}this.liveLoadBufferLength$.getValue()!==t&&this.liveLoadBufferLength$.next(t)})));let e=0;this.representationSubscription.add((0,u.kg)({liveLoadBufferLength:this.liveLoadBufferLength$,bufferLength:this.bufferLength$}).pipe((0,u.nF)(1e3)).subscribe((async({liveLoadBufferLength:t,bufferLength:i})=>{if(!this.element||this.isUpdatingLive)return;let s=this.element.playbackRate,r=ss(this.manifestUrlString,2),a=1e3*Math.abs(this.livePositionFromPlayer$.getValue()),n=Math.min(a,this.tuning.dashCmafLive.normalizedTargetMinBufferSize*s),o=this.tuning.dashCmafLive.normalizedActualBufferOffset*s,u=this.tuning.dashCmafLive.normalizedLiveMinBufferSize*s,h=isFinite(t)?t:i,d=this.isActiveLive$.getValue()&&this.isLowLatency$.getValue(),l=a<=this.tuning.live.activeLiveDelay;this.isActiveLive$.next(l);let c="none";if(d?c="active_low_latency":this.isLowLatency$.getValue()&&l?(this.bufferManagers.forEach((e=>e.proceedLowLatencyLive())),c="active_low_latency"):0!==r&&h<n?c="live_forward_buffering":h<n+u&&(c="live_with_target_offset"),isFinite(t)&&(e=t>e?t:e),"live_forward_buffering"===c||"live_with_target_offset"===c){let i=e-(n+o),a=this.normolizeLiveOffset(Math.trunc(r+i/s)),u=Math.abs(a-r),h=0;!t||u<=this.tuning.dashCmafLive.offsetCalculationError?h=r:a>0&&u>this.tuning.dashCmafLive.offsetCalculationError&&(h=a),this.manifestUrlString=is(this.manifestUrlString,h,2)}("live_with_target_offset"===c||"live_forward_buffering"===c)&&(e=0,await this.updateLive())}),(e=>{this.error$.next({id:"updateLive",category:u.h.VIDEO_PIPELINE,thrown:e,message:"Failed to update live with subscription"})})))}let h=(0,u.h1)(...this.bufferManagers.map((e=>e.fullyBuffered$))).pipe((0,u.Tj)((()=>this.bufferManagers.every((e=>e.fullyBuffered$.getValue()))))),d=(0,u.h1)(...this.bufferManagers.map((e=>e.onLastSegment$))).pipe((0,u.Tj)((()=>this.bufferManagers.some((e=>e.onLastSegment$.getValue()))))),l=(0,u.kg)({allBuffersFull:h,someBufferEnded:d}).pipe((0,u.jX)(),(0,u.Tj)((({allBuffersFull:e,someBufferEnded:t})=>e&&t)),(0,u.pb)((e=>e)));if(this.representationSubscription.add((0,u.h1)(this.forceEnded$,l).subscribe((()=>{if(this.source&&"open"===this.source.readyState&&Array.from(this.source.sourceBuffers).every((e=>!e.updating)))try{this.source?.endOfStream()}catch(e){this.error$.next({id:"EndOfStream",category:u.h.VIDEO_PIPELINE,message:"Failed to end MediaSource stream",thrown:e})}}))),this.representationSubscription.add((0,u.h1)(...this.bufferManagers.map((e=>e.error$))).subscribe(this.error$)),this.representationSubscription.add(this.videoBufferManager.playingRepresentation$.subscribe(this.currentVideoRepresentation$)),this.representationSubscription.add(this.videoBufferManager.playingRepresentationInit$.subscribe(this.currentVideoRepresentationInit$)),this.representationSubscription.add(this.videoBufferManager.currentSegmentLength$.subscribe(this.currentVideoSegmentLength$)),this.audioBufferManager&&(this.representationSubscription.add(this.audioBufferManager.playingRepresentation$.subscribe(this.currentAudioRepresentation$)),this.representationSubscription.add(this.audioBufferManager.currentSegmentLength$.subscribe(this.currentAudioSegmentLength$))),this.liveTextManager&&this.representationSubscription.add(this.liveTextManager.currentRepresentation$.subscribe(this.currentLiveTextRepresentation$)),"open"!==this.source.readyState){let e=this.tuning.dash.sourceOpenTimeout>=0;yield new Promise((t=>{e&&(this.timeoutSourceOpenId=setTimeout((()=>{"open"!==this.source?.readyState?this.error$.next({id:"OpenOfStream",category:u.h.VIDEO_PIPELINE,message:"Failed to open MediaSource",thrown:new Error("Timeout reject when wait sourceopen event"),traceAsLog:!0}):t()}),this.tuning.dash.sourceOpenTimeout)),this.source?.addEventListener("sourceopen",(()=>{this.timeoutSourceOpenId&&clearTimeout(this.timeoutSourceOpenId),t()}),{once:!0})}))}if(!this.isLive$.getValue()){let e=[this.manifest.duration??0,...(0,_o.default)((0,_o.default)([...this.manifest.streams.audio,...this.manifest.streams.video],(e=>e.representations)),(e=>{let t=[];return e.duration&&t.push(e.duration),Jo(e.segmentReference)&&e.segmentReference.totalSegmentsDurationMs&&t.push(e.segmentReference.totalSegmentsDurationMs),t}))];this.source.duration=Math.max(...e)/1e3}this.audioBufferManager&&(0,u.R)(t)?yield Promise.all([this.videoBufferManager.startWith(e),this.audioBufferManager.startWith(t)]):yield this.videoBufferManager.startWith(e),this.state$.setState("representations_ready"),this.tracer.log("initRepresentationsEnd")}.bind(this)),this.tick=()=>{if(!this.element||!this.videoBufferManager||"open"!==this.source?.readyState)return;let e=1e3*this.element.currentTime;this.videoBufferManager.maintain(e),this.audioBufferManager?.maintain(e),this.liveTextManager?.maintain(e),(this.videoBufferManager.gaps.length||this.audioBufferManager?.gaps.length)&&!this.gapWatchdogActive&&(this.gapWatchdogActive=!0,this.gapWatchdogSubscription=(0,u.YP)(this.tuning.gapWatchdogInterval).subscribe((()=>this.jumpGap()),(e=>{this.error$.next({id:"GapWatchdog",category:u.h.WTF,message:"Error handling gaps",thrown:e})})),this.subscription.add(this.gapWatchdogSubscription))},this.throughputEstimator=e.throughputEstimator,this.tuning=e.tuning,this.tracer=e.tracer.createComponentTracer(this.constructor.name),this.forceVideoCodec=e.forceVideoCodec,this.fetcher=new su({throughputEstimator:this.throughputEstimator,requestQuic:this.tuning.requestQuick,compatibilityMode:e.compatibilityMode,tracer:this.tracer,useEnableSubtitlesParam:e.tuning.useEnableSubtitlesParam}),this.subscription.add(this.fetcher.recoverableError$.subscribe(this.fetcherRecoverableError$)),this.subscription.add(this.fetcher.error$.subscribe(this.fetcherError$)),this.subscription.add(this.fetcher.manifestRequested$.subscribe(this.manifestRequested$)),this.subscription.add(this.fetcher.firstBytesManifest$.subscribe(this.firstBytesManifest$)),this.subscription.add(this.fetcher.firstBytesRequested$.subscribe(this.firstBytesRequested$)),this.subscription.add(this.fetcher.firstBytesReceived$.subscribe(this.firstBytesReceived$)),this.subscription.add(this.fetcher.lastConnectionType$.subscribe(this.lastConnectionType$)),this.subscription.add(this.fetcher.lastConnectionReused$.subscribe(this.lastConnectionReused$)),this.liveBuffer=Ro.getLiveBufferSmoothedValue(this.tuning.dashCmafLive.lowLatency.maxTargetOffset,{...e.tuning.dashCmafLive.lowLatency.bufferEstimator}),this.initTracerSubscription()}},hu=class{connect({observableVideo:e,video:t}){let i=e=>{let t=e.target;this.pipSize$.next({width:t.width,height:t.height})};this.subscription.add((0,u.qi)(t).subscribe(this.videoSize$)).add(e.enterPip$.subscribe((({pictureInPictureWindow:e})=>{this.pipSize$.next({width:e.width,height:e.height}),e.addEventListener("resize",i),this.pictureInPictureWindowRemoveEventListener=()=>{e.removeEventListener("resize",i)}}))).add(e.leavePip$.subscribe((()=>{this.pictureInPictureWindowRemoveEventListener()}))).add((0,u.kg)({videoSize:this.videoSize$,pipSize:this.pipSize$,inPip:e.inPiP$}).pipe((0,u.Tj)((({videoSize:e,inPip:t,pipSize:i})=>t?i:e))).subscribe(this.elementSize$))}getValue(){return this.elementSize$.getValue()}subscribe(e,t){return this.elementSize$.subscribe(e,t)}getObservable(){return this.elementSize$}destroy(){this.pictureInPictureWindowRemoveEventListener(),this.subscription.unsubscribe()}constructor(){this.subscription=new u.yU,this.pipSize$=new u.Ot(void 0),this.videoSize$=new u.Ot(void 0),this.elementSize$=new u.Ot(void 0),this.pictureInPictureWindowRemoveEventListener=u.lQ}},du=class{getProviderSubscriptionInfo(){let{output:e,desiredState:t}=this.params;(0,u.wD)(this.observableVideo)&&(this.observableVideo=er(this.video),this.subscription.add((()=>this.observableVideo?.destroy())));let i=this.constructor.name,s=t=>{e.error$.next({id:i,category:u.h.WTF,message:`${i} internal logic error`,thrown:t})};return{output:e,desiredState:t,observableVideo:this.observableVideo,genericErrorListener:s,connect:(e,t)=>this.subscription.add(e.subscribe(t,s))}}subscribe(){let{output:e,desiredState:t,observableVideo:i,genericErrorListener:s,connect:r}=this.getProviderSubscriptionInfo();this.subscription.add(this.params.output.availableVideoTracks$.pipe((0,u.pb)((e=>!!e.length)),(0,u.Oo)()).subscribe((e=>{this.droppedFramesManager.connect({logger:this.params.dependencies.logger,video:this.video,droppedFramesChecker:this.params.tuning.droppedFramesChecker,isAuto:this.params.desiredState.autoVideoTrackSwitching,playing$:i.playing$,pause$:i.pause$,tracks:e})})));let a=this.params.desiredState.seekState.stateChangeEnded$.pipe((0,u.Tj)((e=>"none"!==e.to.state)),(0,u.jX)());this.stallsManager.init({isSeeked$:a,currentStallDuration$:this.player.currentStallDuration$,videoLastDataObtainedTimestamp$:this.player.videoLastDataObtainedTimestamp$,throughput$:this.params.dependencies.throughputEstimator.throughput$,rtt$:this.params.dependencies.throughputEstimator.rtt$,tuning:this.params.tuning.stallsManager,abrParams:this.params.tuning.autoTrackSelection,isBuffering$:i.isBuffering$,looped$:i.looped$,playing$:i.playing$,duration:this.video.duration}),r(i.ended$,e.endedEvent$),r(i.looped$,e.loopedEvent$),r(i.error$,e.error$),r(i.isBuffering$,e.isBuffering$),r(i.currentBuffer$,e.currentBuffer$),r(i.currentBuffer$,e.currentNativeBuffer$),r(i.playing$,e.firstFrameEvent$),r(i.canplay$,e.canplay$),r(i.inPiP$,e.inPiP$),r(i.inFullscreen$,e.inFullscreen$),r(i.loadedMetadata$,e.loadedMetadataEvent$),r(this.player.error$,e.error$),r(this.player.fetcherRecoverableError$,e.fetcherRecoverableError$),r(this.player.fetcherError$,e.fetcherError$),r(this.player.manifestRequested$,e.manifestRequested$),r(this.player.firstBytesManifest$,e.firstBytesManifest$),r(this.player.manifestReceived$,e.manifestReceived$),r(this.player.firstBytesRequested$,e.firstBytesRequested$),r(this.player.firstBytesReceived$,e.firstBytesReceived$),r(this.player.lastConnectionType$,e.httpConnectionType$),r(this.player.lastConnectionReused$,e.httpConnectionReused$),r(this.player.isLive$,e.isLive$),r(this.player.lastRequestFirstBytes$.pipe((0,u.pb)(u.R),(0,u.Oo)()),e.firstBytesEvent$),r(this.stallsManager.severeStallOccurred$,e.severeStallOccurred$),r(this.videoState.stateChangeEnded$.pipe((0,u.Tj)((e=>e.to))),this.params.output.playbackState$),this.subscription.add(i.looped$.subscribe((()=>this.player.warmUpMediaSourceIfNeeded()),s)),this.subscription.add(i.seeked$.subscribe(e.seekedEvent$,s)),this.subscription.add(Hs(this.video,t.isLooped,s)),this.subscription.add(Ws(this.video,t.volume,i.volumeState$,s)),this.subscription.add(i.volumeState$.subscribe(this.params.output.volume$,s)),this.subscription.add(Qs(this.video,t.playbackRate,i.playbackRateState$,s)),this.elementSizeManager.connect({video:this.video,observableVideo:i}),r(Kr(this.video,{threshold:this.params.tuning.autoTrackSelection.activeVideoAreaThreshold}),e.elementVisible$),this.subscription.add(i.playing$.subscribe((()=>{this.videoState.setState("playing"),us(t.playbackState,"playing"),this.scene3D&&this.scene3D.play()}),s)).add(i.pause$.subscribe((()=>{this.videoState.setState("paused"),us(t.playbackState,"paused")}),s)).add(i.canplay$.subscribe((()=>{"playing"===this.videoState.getState()&&this.playIfAllowed()}),s)),this.params.tuning.changePlaybackStateToPausedWhenEnded&&this.subscription.add(i.ended$.subscribe((()=>{this.videoState.setState("paused"),us(t.playbackState,"paused")}))),this.subscription.add(this.player.state$.stateChangeEnded$.subscribe((({to:e})=>{if("manifest_ready"===e){this.videoTracksMap=new Map,this.audioTracksMap=new Map,this.textTracksMap=new Map;let e=this.player.getStreams(),t=this.player.getCodecs();if((0,u.tZ)(e,"Manifest not loaded or empty"),!this.params.tuning.isAudioDisabled){let t=[];for(let i of e.audio){t.push(Go(i));let e=[];for(let t of i.representations){let s=Qo(t);e.push(s),this.audioTracksMap.set(s,{stream:i,representation:t})}this.audioStreamsMap.set(i,e)}this.params.output.availableAudioStreams$.next(t)}let i=[];for(let t of e.video){i.push(Zo(t));let e=[];for(let i of t.representations){let s=Wo({...i,streamId:t.id});s&&(e.push(s),this.videoTracksMap.set(s,{stream:t,representation:i}))}this.videoStreamsMap.set(t,e)}this.params.output.availableVideoStreams$.next(i);for(let t of e.text)for(let e of t.representations){let i=Xo(t,e);this.textTracksMap.set(i,{stream:t,representation:e})}this.params.output.availableVideoTracks$.next(Array.from(this.videoTracksMap.keys())),this.params.output.availableAudioTracks$.next(Array.from(this.audioTracksMap.keys())),this.params.output.isAudioAvailable$.next(!!this.audioTracksMap.size),t?.video&&this.params.output.availableVideoCodecs$.next(t.video),t?.audio&&this.params.output.availableAudioCodecs$.next(t.audio),this.audioTracksMap.size&&this.textTracksMap.size&&this.params.desiredState.internalTextTracks.startTransitionTo(Array.from(this.textTracksMap.keys()))}else"representations_ready"===e&&(this.videoState.setState("ready"),this.player.initBuffer())}),s));let{vktvAbrThrottle:n}=this.params.tuning.dash,o=n&&(e=>{let t=!1,i=(0,u.rj)((()=>{t=!0}),e);return()=>{try{return i(),t}finally{t=!1}}})(n)||null;this.subscription.add((0,u.h1)(this.player.currentStallDuration$,this.player.state$.stateChangeEnded$,t.videoTrack.stateChangeStarted$,t.autoVideoTrackSwitching.transitionStarted$,this.params.dependencies.throughputEstimator.rttAdjustedThroughput$,t.autoVideoTrackLimits.stateChangeStarted$,this.elementSizeManager.getObservable(),this.params.output.elementVisible$,this.droppedFramesManager.onDroopedVideoFramesLimit$,(0,u.Rt)(this.video,"progress")).pipe((0,u.pb)((()=>this.videoTracksMap.size>0))).subscribe((async()=>{let e=this.player.state$.getState(),i=this.player.state$.getTransition();if("manifest_ready"!==e&&"running"!==e||i||"running"===e&&o&&!o())return;t.autoVideoTrackSwitching.getTransition()&&t.autoVideoTrackSwitching.setState(t.autoVideoTrackSwitching.getState()),this.selectVideoAudioRepresentations();let{video:s,audio:r}=this.selectedRepresentations;if(!s)return;let a=Ko(this.videoTracksMap.keys(),(e=>this.videoTracksMap.get(e)?.representation.id===s.id));(0,u.R)(a)&&(this.stallsManager.lastVideoTrackSelected=a);let n=this.params.desiredState.autoVideoTrackLimits.getTransition();if(n&&this.params.output.autoVideoTrackLimits$.next(n.to),"manifest_ready"===e)await this.player.initRepresentations(s.id,r?.id,this.params.sourceHls);else if(await this.player.switchRepresentation("video",s.id),r){let e=!!t.audioStream.getTransition();await this.player.switchRepresentation("audio",r.id,e)}}),s)),this.subscription.add((0,u.kg)({videoState:this.videoState.stateChangeEnded$,autoVideoTrackState:(0,u.h1)((0,u.Ss)([t.autoVideoTrackSwitching.getState()]),t.autoVideoTrackSwitching.stateChangeEnded$.pipe((0,u.Tj)((e=>e.to))))}).pipe((0,u.Tj)((({videoState:e,autoVideoTrackState:t})=>"stopped"!==e.to&&t)),(0,u.jX)()).subscribe((e=>this.player.setSmartRepresentationSwitch(e)))),this.subscription.add(t.cameraOrientation.stateChangeEnded$.subscribe((({to:e})=>{this.scene3D&&e&&this.scene3D.pointCameraTo(e.x,e.y)}))),this.subscription.add(this.elementSizeManager.subscribe((e=>{this.scene3D&&e&&this.scene3D.setViewportSize(e.width,e.height)}))),this.subscription.add(this.player.currentVideoRepresentation$.pipe((0,u.jX)()).subscribe((t=>{let i=Ko(this.videoTracksMap.entries(),(([,{representation:e}])=>e.id===t));if(!i)return e.currentVideoTrack$.next(void 0),void e.currentVideoStream$.next(void 0);let[s,{stream:r}]=i,a=this.params.desiredState.videoStream.getTransition();a&&a.to&&a.to.id===r.id&&this.params.desiredState.videoStream.setState(a.to),e.currentVideoTrack$.next(s),e.currentVideoStream$.next(Zo(r));let n=this.player.calculateDurationFromSegments();n&&this.params.output.duration$.next(n/1e3)}),s)),this.subscription.add(this.player.currentAudioRepresentation$.pipe((0,u.jX)()).subscribe((t=>{let i=Ko(this.audioTracksMap.entries(),(([,{representation:e}])=>e.id===t));if(!i)return void e.currentAudioStream$.next(void 0);let[s,{stream:r}]=i,a=this.params.desiredState.audioStream.getTransition();a&&a.to&&a.to.id===r.id&&this.params.desiredState.audioStream.setState(a.to),e.currentAudioStream$.next(Go(r))}),s)),this.subscription.add(this.player.currentVideoRepresentationInit$.subscribe((t=>{if(t?.is3dVideo&&this.params.tuning.spherical?.enabled)try{this.init3DScene(t),e.is3DVideo$.next(!0)}catch(t){e.warning$.next({id:"DashProvider",message:`DashProvider could not initialize 3D-scene: ${t}`})}else this.destroy3DScene(),this.params.tuning.spherical?.enabled&&e.is3DVideo$.next(!1)}),s)),this.subscription.add(this.player.currentVideoSegmentLength$.subscribe(e.currentVideoSegmentLength$,s)),this.subscription.add(this.player.currentAudioSegmentLength$.subscribe(e.currentAudioSegmentLength$,s)),this.textTracksManager.connect(this.video,t,e);let h=t.playbackState.stateChangeStarted$.pipe((0,u.Tj)((({to:e})=>"ready"===e)),(0,u.jX)());this.subscription.add((0,u.h1)(h,t.autoVideoTrackSwitching.stateChangeStarted$,this.player.state$.stateChangeEnded$,(0,u.Ss)(["init"])).subscribe((()=>{let e=t.autoVideoTrackSwitching.getState(),i="ready"===t.playbackState.getState()?this.params.tuning.dash.forwardBufferTargetPreload:e?this.params.tuning.dash.forwardBufferTargetAuto:this.params.tuning.dash.forwardBufferTargetManual;this.player.setBufferTarget(i)}))),this.subscription.add((0,u.h1)(h,this.player.state$.stateChangeEnded$,(0,u.Ss)(["init"])).subscribe((()=>this.player.setPreloadOnly("ready"===t.playbackState.getState()))));let d=(0,u.h1)(t.playbackState.stateChangeStarted$,t.videoTrack.stateChangeStarted$,t.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,(0,u.Ss)(["init"])).pipe((0,u.sg)(0));this.subscription.add(d.subscribe(this.syncPlayback,s))}selectVideoAudioRepresentations(){if(this.player.isStreamEnded)return;let e=this.params.tuning.useNewAutoSelectVideoTrack?wr:Sr,t=this.params.tuning.useNewAutoSelectVideoTrack?Br:Er,i=this.params.tuning.useNewAutoSelectVideoTrack?Lr:Rr,{desiredState:s,output:r}=this.params,a=s.autoVideoTrackSwitching.getState(),n=s.videoTrack.getState()?.id,o=Ko(this.videoTracksMap.keys(),(e=>e.id===n)),u=r.currentVideoTrack$.getValue(),h=s.videoStream.getState()??(o&&this.videoTracksMap.get(o)?.stream)??1===this.videoStreamsMap.size?this.videoStreamsMap.keys().next().value:void 0;if(!h)return;let d=Ko(this.videoStreamsMap.keys(),(e=>e.id===h.id)),l=d&&this.videoStreamsMap.get(d);if(!l)return;let c,p=io(this.video.buffered,1e3*this.video.currentTime);c=this.player.isActiveLive$.getValue()?this.player.isLowLatency$.getValue()?this.params.tuning.dashCmafLive.lowLatency.maxTargetOffset:this.params.tuning.dashCmafLive.normalizedLiveMinBufferSize:this.player.isLive$.getValue()?this.params.tuning.dashCmafLive.normalizedTargetMinBufferSize:a?this.params.tuning.dash.forwardBufferTargetAuto:this.params.tuning.dash.forwardBufferTargetManual;let f=(1e3*this.video.duration||1/0)-1e3*this.video.currentTime,m=Math.min(p/Math.min(c,f||1/0),1),g=s.audioStream.getState()??(1===this.audioStreamsMap.size?this.audioStreamsMap.keys().next().value:void 0),b=g?.id&&Ko(this.audioStreamsMap.keys(),(e=>e.id===g.id))||this.audioStreamsMap.keys().next().value,v=0;if(b){if(o&&!a){let t=e(o,l,this.audioStreamsMap.get(b)??[],this.params.tuning.autoTrackSelection.minVideoAudioRatio);v=Math.max(v,t?.bitrate??-1/0)}if(u){let t=e(u,l,this.audioStreamsMap.get(b)??[],this.params.tuning.autoTrackSelection.minVideoAudioRatio);v=Math.max(v,t?.bitrate??-1/0)}}let y=o;(a||!y)&&(y=i(l,{container:this.elementSizeManager.getValue(),panelSize:this.params.panelSize,estimatedThroughput:this.params.dependencies.throughputEstimator.rttAdjustedThroughput$.getValue(),tuning:this.stallsManager.abrTuningParams,limits:this.params.desiredState.autoVideoTrackLimits.getState(),reserve:v,forwardBufferHealth:m,current:u,visible:this.params.output.elementVisible$.getValue(),history:this.videoTrackSwitchHistory,playbackRate:this.video.playbackRate,droppedVideoMaxQualityLimit:this.droppedFramesManager.droppedVideoMaxQualityLimit,stallsVideoMaxQualityLimit:this.stallsManager.videoMaxQualityLimit,stallsPredictedThroughput:this.stallsManager.predictedThroughput,abrLogger:this.params.dependencies.abrLogger}));let S=b&&t(y,l,this.audioStreamsMap.get(b)??[],{estimatedThroughput:this.params.dependencies.throughputEstimator.rttAdjustedThroughput$.getValue(),stallsPredictedThroughput:this.stallsManager.predictedThroughput,tuning:this.stallsManager.abrTuningParams,forwardBufferHealth:m,history:this.audioTrackSwitchHistory,playbackRate:this.video.playbackRate,abrLogger:this.params.dependencies.abrLogger}),w=this.videoTracksMap.get(y)?.representation,T=S&&this.audioTracksMap.get(S)?.representation;w&&T?(this.selectedRepresentations.video=w,this.selectedRepresentations.audio=T):w&&!T&&0===this.audioTracksMap.size&&(this.selectedRepresentations.video=w,this.selectedRepresentations.audio=null)}prepare(e=0){this.player.initManifest(this.video,this.params.source.url,e)}playIfAllowed(){Dr(this.video,(()=>{this.params.output.soundProhibitedEvent$.next()})).then((e=>{e||(this.videoState.setState("paused"),us(this.params.desiredState.playbackState,"paused",!0))}),(e=>this.params.output.error$.next({id:"ForcePlay",message:"play() failed even with workarounds",category:u.h.DOM,thrown:e})))}destroy(){this.subscription.unsubscribe(),this.droppedFramesManager.destroy(),this.stallsManager.destroy(),this.elementSizeManager.destroy(),this.destroy3DScene(),this.textTracksManager.destroy(),this.player.destroy(),this.params.output.element$.next(void 0),this.params.output.currentVideoStream$.next(void 0),js(this.video),this.tracer.end()}constructor(e){this.subscription=new u.yU,this.videoState=new Ps("stopped"),this.observableVideo=null,this.droppedFramesManager=new Yr,this.stallsManager=new va,this.elementSizeManager=new hu,this.videoTracksMap=new Map,this.audioTracksMap=new Map,this.textTracksMap=new Map,this.videoStreamsMap=new Map,this.audioStreamsMap=new Map,this.videoTrackSwitchHistory=new mr,this.audioTrackSwitchHistory=new mr,this.selectedRepresentations={audio:null,video:null},this.syncPlayback=()=>{let e=this.videoState.getState(),t=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition(),s=this.params.desiredState.seekState.getState();if(!this.videoState.getTransition()){if("requested"===s.state&&"paused"!==i?.to&&"stopped"!==e&&"stopped"!==t&&this.seek(s.position,s.forcePrecise),"stopped"===t)return void("stopped"!==e&&(this.videoState.startTransitionTo("stopped"),this.player.stop(),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.currentNativeBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState("stopped"),us(this.params.desiredState.playbackState,"stopped",!0)));switch(e){case"stopped":return this.videoState.startTransitionTo("ready"),void this.prepare();case"ready":return void("paused"===t?(this.videoState.setState("paused"),us(this.params.desiredState.playbackState,"paused")):"playing"===t?(this.videoState.startTransitionTo("playing"),this.playIfAllowed()):"ready"===i?.to&&us(this.params.desiredState.playbackState,"ready"));case"playing":return void("paused"===t?(this.videoState.startTransitionTo("paused"),this.video.paused?this.videoState.setState("paused"):this.video.pause()):"playing"===t&&this.video.paused?this.playIfAllowed():"playing"===i?.to&&us(this.params.desiredState.playbackState,"playing"));case"paused":return void("playing"===t?(this.videoState.startTransitionTo("playing"),this.playIfAllowed()):"paused"===i?.to&&us(this.params.desiredState.playbackState,"paused"));default:return(0,u.xb)(e)}}},this.init3DScene=e=>{if(this.scene3D)return;this.scene3D=new ca(this.params.container,this.video,{fov:this.params.tuning.spherical.fov,orientation:this.params.tuning.spherical.orientation||{x:e.projectionData?.pose.yaw||0,y:e.projectionData?.pose.pitch||0,z:e.projectionData?.pose.roll||0},rotationSpeed:this.params.tuning.spherical.rotationSpeed,maxYawAngle:this.params.tuning.spherical.maxYawAngle,rotationSpeedCorrection:this.params.tuning.spherical.rotationSpeedCorrection,degreeToPixelCorrection:this.params.tuning.spherical.degreeToPixelCorrection,speedFadeTime:this.params.tuning.spherical.speedFadeTime,speedFadeThreshold:this.params.tuning.spherical.speedFadeThreshold});let t=this.elementSizeManager.getValue();t&&this.scene3D.setViewportSize(t.width,t.height)},this.destroy3DScene=()=>{this.scene3D&&(this.scene3D.destroy(),this.scene3D=void 0)},this.textTracksManager=new Zs(e.source.url),this.params=e,this.video=Us(e.container,e.tuning),this.tracer=e.dependencies.tracer.createComponentTracer(this.constructor.name),this.params.output.element$.next(this.video),this.params.output.availableVideoTracks$.next([]),this.params.output.availableAudioTracks$.next([]),this.params.output.isAudioAvailable$.next(!0),this.params.output.hostname$.next(Ar(this.params.source.url)),this.params.output.isLive$.next(!1),this.params.output.autoVideoTrackLimitingAvailable$.next(!0),this.params.output.availableTextTracks$.next([]),this.params.desiredState.internalTextTracks.setState([]),this.player=new uu({throughputEstimator:this.params.dependencies.throughputEstimator,tuning:this.params.tuning,compatibilityMode:this.params.source.compatibilityMode,tracer:this.tracer,forceVideoCodec:this.params.forceVideoCodec}),this.subscribe()}},lu=class extends du{subscribe(){super.subscribe();let{output:e,observableVideo:t,connect:i}=this.getProviderSubscriptionInfo();i(t.timeUpdate$,e.position$),i(t.durationChange$,e.duration$)}seek(e,t){this.params.output.willSeekEvent$.next(),this.player.seek(e,t)}},cu=class extends du{subscribe(){super.subscribe();let e=!1,t=-1,{output:i,observableVideo:s,desiredState:r,connect:a}=this.getProviderSubscriptionInfo();this.params.output.position$.next(0),this.params.output.isLive$.next(!0),this.params.output.canPlayLiveTailBuffer$.next(!0),a(s.timeUpdate$,i.liveBufferTime$),a(this.player.liveSeekableDuration$,i.duration$),a(this.player.liveLatency$,i.liveLatency$);let n=new u.Ot(1);a(s.playbackRateState$,n),this.params.tuning.dashCmafLive.catchupLiveForMutedInactiveTab&&this.subscription.add(i.elementVisible$.pipe((0,u.jX)()).subscribe((t=>{let s=i.position$.getValue(),r=i.volume$.getValue(),a=!r.volume||r.muted;t||s||!a?t&&e&&(this.seek(0),e=!1):e=!0}))),this.subscription.add(this.params.output.position$.subscribe(this.player.livePositionFromPlayer$)).add(r.isLowLatency.stateChangeEnded$.pipe((0,u.Tj)((e=>e.to))).subscribe(this.player.isLowLatency$)).add((0,u.kg)({liveBufferTime:i.liveBufferTime$,liveAvailabilityStartTime:this.player.liveAvailabilityStartTime$}).pipe((0,u.Tj)((({liveBufferTime:e,liveAvailabilityStartTime:t})=>e&&t?e+t:void 0))).subscribe(i.liveTime$)).add(this.player.liveStreamStatus$.pipe((0,u.pb)((e=>(0,u.R)(e)))).subscribe((e=>i.isLiveEnded$.next("active"!==e&&0===i.position$.getValue())))).add((0,u.kg)({liveDuration:this.player.liveDuration$,liveStreamStatus:this.player.liveStreamStatus$,playbackRate:(0,u.h1)(s.playbackRateState$,new u.Ot(1))}).pipe((0,u.pb)((({liveStreamStatus:e,liveDuration:t})=>"active"===e&&!!t))).subscribe((({liveDuration:e,playbackRate:s})=>{let r=i.liveBufferTime$.getValue(),a=i.position$.getValue(),{playbackCatchupSpeedup:n}=this.params.tuning.dashCmafLive.lowLatency;a||s<1-n||this.video.paused||(0,u.wD)(r)||(t=e-r)}))).add((0,u.kg)({time:i.liveBufferTime$,liveDuration:this.player.liveDuration$,playbackRate:(0,u.h1)(s.playbackRateState$,new u.Ot(1))}).pipe((0,u.jX)(((e,t)=>"active"===this.player.liveStreamStatus$.getValue()?e.liveDuration===t.liveDuration:e.time===t.time))).subscribe((({time:e,liveDuration:s,playbackRate:r})=>{let a=i.position$.getValue(),{playbackCatchupSpeedup:n}=this.params.tuning.dashCmafLive.lowLatency;if(!a&&!this.video.paused&&r>=1-n||(0,u.wD)(e)||(0,u.wD)(s))return;let o=-1*(s-e-t);i.position$.next(Math.min(o,0))}))).add(this.player.currentLiveTextRepresentation$.subscribe((e=>{if(e){let t=(({language:e,label:t,id:i,url:s,isAuto:r})=>({id:i,url:s,isAuto:r,type:"internal",language:e,label:t}))(e);this.params.output.availableTextTracks$.next([t])}})))}seek(e){this.params.output.willSeekEvent$.next();let t=-e,i=Math.trunc(t/1e3<=Math.abs(this.params.output.duration$.getValue())?t:0);this.player.seekLive(i).then((()=>{this.params.output.position$.next(e/1e3)}))}constructor(e){super(e),this.textTracksManager.destroy()}},pu="X-Playback-Duration",fu=async e=>{let t=await Ma(e),i=await t.text(),s=/#EXT-X-VK-PLAYBACK-DURATION:(\d+)/m.exec(i)?.[1];return s?parseInt(s,10):t.headers.has(pu)?parseInt(t.headers.get(pu),10):void 0},mu=g(vt(),1),gu=e=>{let t=null;if(e.QUALITY&&(t=tr(e.QUALITY)),!t&&e.RESOLUTION){let[i,s]=e.RESOLUTION.split("x").map((e=>parseInt(e,10)));t=(0,u.Hf)({width:i,height:s})}return t??null},bu=0,vu=async(e,t=e,i,s)=>{let r=await(await Ma(e,s)).text();bu+=1;try{let{qualityManifests:e,textTracks:i}=((e,t)=>{let i=e.split("\n"),s=[],r=[];for(let e=0;e<i.length;e++){let a=i[e],n=a.match(/^#EXT-X-STREAM-INF:(.+)/),o=a.match(/^#EXT-X-MEDIA:TYPE=SUBTITLES,(.+)/);if(n||o){if(n){let r,a=(0,mu.default)(n[1].split(",").map((e=>e.split("=")))),o=a.QUALITY??`stream-${a.BANDWIDTH}`,u=gu(a);a.BANDWIDTH&&(r=parseInt(a.BANDWIDTH,10)/1e3||void 0),!r&&a["AVERAGE-BANDWIDTH"]&&(r=parseInt(a["AVERAGE-BANDWIDTH"],10)/1e3||void 0);let h,d=a["FRAME-RATE"]?parseFloat(a["FRAME-RATE"]):void 0;if(a.RESOLUTION){let[e,t]=a.RESOLUTION.split("x").map((e=>parseInt(e,10)));e&&t&&(h={width:e,height:t})}let l=new URL(i[++e],t).toString();u&&s.push({id:o,quality:u,url:l,bandwidth:r,size:h,fps:d})}if(o){let e=(0,mu.default)(o[1].split(",").map((e=>{let t=e.indexOf("=");return[e.substring(0,t),e.substring(t+1)]})).map((([e,t])=>[e,t.replace(/^"|"$/g,"")]))),t=e.URI?.replace(/playlist$/,"subtitles.vtt"),i=e.LANGUAGE,s=e.NAME;t&&i&&r.push({type:"internal",id:i,label:s,language:i,url:t,isAuto:!1})}}}if(!s.length)throw new Error("Empty manifest");return{qualityManifests:s,textTracks:r}})(r,t);return{qualityManifests:e,textTracks:i}}catch{if(bu<=i.manifestRetryMaxCount)return await(e=>new Promise((t=>{setTimeout((()=>{t()}),e)})))((0,u.rX)(bu-1,{start:i.manifestRetryInterval,max:i.manifestRetryMaxInterval})),vu(e,t,i)}return{qualityManifests:[],textTracks:[]}},yu=vu,Su=class{destroy(){this.subscription.unsubscribe(),this.abortControllers.destroy.abort()}async prepare(e){try{let t=new URL(e);t.searchParams.set("enable-subtitles","yes"),this.prepareUrl=t.toString();let{textTracks:i}=await this.fetchManifestData();await this.processTextTracks(i,this.params.sourceUrl)}catch(e){this.error("prepare",e)}}async processTextTracks(e,t){try{let i=await this.parseTextTracks(e,t);i&&(this.currentTextTrackData=i)}catch(e){this.error("processTextTracks",e)}}async parseTextTracks(e,t){for(let i of e){let e=new URL(i.url,t).toString(),s=await(await Ma(e,{signal:this.abortControllers.destroy.signal})).text();return{textTrack:i,playlist:this.parsePlaylist(s,e)}}}parsePlaylist(e,t){let i={mediaSequence:0,programDateTime:"",segments:[],targetDuration:0,vkPlaybackDuration:0,segmentStartTime:0,vkStartTime:""},s=e.split("\n"),r=0;for(let e=0;e<s.length;++e){let a=s[e];switch(!0){case a.startsWith("#EXTINF:"):{let n=s[++e],o=new URL(n,t).toString(),u=1e3*Number(this.extractPlaylistRowValue("#EXTINF:",a));if(i.segments.push({time:{from:r,to:r+u},url:o}),r+=u,!i.segmentStartTime){let e=new Date(i.vkStartTime).valueOf(),t=new Date(i.programDateTime).valueOf();i.segmentStartTime=t-e}break}case a.startsWith("#EXT-X-TARGETDURATION:"):i.targetDuration=Number(this.extractPlaylistRowValue("#EXT-X-TARGETDURATION:",a));break;case a.startsWith("#EXT-X-MEDIA-SEQUENCE:"):i.mediaSequence=Number(this.extractPlaylistRowValue("#EXT-X-MEDIA-SEQUENCE:",a));break;case a.startsWith("#EXT-X-VK-PLAYBACK-DURATION:"):i.vkPlaybackDuration=Number(this.extractPlaylistRowValue("#EXT-X-VK-PLAYBACK-DURATION:",a));break;case a.startsWith("#EXT-X-PROGRAM-DATE-TIME:"):{let e=this.extractPlaylistRowValue("#EXT-X-PROGRAM-DATE-TIME:",a);i.programDateTime=e;let t=new Date(e);t.setMilliseconds(0),r=t.valueOf();break}case a.startsWith("#EXT-X-VK-START-TIME:"):i.vkStartTime=this.extractPlaylistRowValue("#EXT-X-VK-START-TIME:",a)}}return i}extractPlaylistRowValue(e,t){return"#EXTINF:"===e?t.substring(e.length,t.length-1):t.substring(e.length)}processLiveTime(e){if((0,u.R)(e)&&this.currentTextTrackData){let{segments:t}=this.currentTextTrackData.playlist,{from:i}=t[0].time,{to:s}=t[t.length-1].time;if(e<i||e>s)return;s-e<this.params.downloadThreshold&&this.fetchNextManifestData();for(let i of t)if(i.time.from<=e&&i.time.to>=e){this.availableTextTracks$.next([{...this.currentTextTrackData.textTrack,url:i.url,isAuto:!0}]);break}}}async fetchNextManifestData(){try{if(this.abortControllers.nextManifest)return;this.abortControllers.nextManifest=new Ca;let{textTracks:e}=await this.fetchManifestData(),t=await this.parseTextTracks(e,this.params.sourceUrl);this.currentTextTrackData&&t&&(this.currentTextTrackData.playlist.segments=t.playlist.segments)}catch(e){this.error("fetchNextManifestData",e)}finally{this.abortControllers.nextManifest=null}}async fetchManifestData(){let e=this.prepareUrl??this.params.sourceUrl;return await this.params.fetchManifestData(e,{signal:this.abortControllers.destroy.signal})}error(e,t){this.error$.next({id:"[LiveTextManager][HLS_LIVE_CMAF]",category:u.h.WTF,thrown:t,message:e})}constructor(e,t,i,s,r){this.subscription=new u.yU,this.abortControllers={destroy:new Ca,nextManifest:null},this.prepareUrl=void 0,this.currentTextTrackData=null,this.availableTextTracks$=new u.Ot(null),this.getCurrentTime$=new u.Ot(null),this.error$=new u.B7,this.params={fetchManifestData:i,sourceUrl:s,downloadThreshold:r},this.subscription.add(e.pipe((0,u.nF)(1e3)).subscribe((e=>{this.processLiveTime(e)}))),this.getCurrentTime$.next((()=>this.currentTextTrackData?this.currentTextTrackData.playlist.segmentStartTime/1e3+t.currentTime:0))}},wu=class{selectManifest(){let{autoVideoTrackSwitching:e,videoTrack:t}=this.params.desiredState,i=e.getState(),s=t.getTransition(),r=s?.to?.id??t.getState()?.id??"master",a=this.manifests$.getValue();if(!a.length)return;let n=i?"master":r;return i&&!s&&t.startTransitionTo(this.masterManifest),a.find((e=>e.id===n))}subscribe(){let{output:e,desiredState:t}=this.params,i=t=>{e.error$.next({id:"HlsLiveProvider",category:u.h.WTF,message:"HlsLiveProvider internal logic error",thrown:t})},s=er(this.video);this.subscription.add((()=>s.destroy()));let r=(e,t)=>this.subscription.add(e.subscribe(t,i));r(s.ended$,e.endedEvent$),r(s.error$,e.error$),r(s.isBuffering$,e.isBuffering$),r(s.currentBuffer$,e.currentBuffer$),r(s.currentBuffer$,e.currentNativeBuffer$),r(s.loadedMetadata$,e.firstBytesEvent$),r(s.loadedMetadata$,e.loadedMetadataEvent$),r(s.playing$,e.firstFrameEvent$),r(s.canplay$,e.canplay$),r(s.inPiP$,e.inPiP$),r(s.inFullscreen$,e.inFullscreen$),this.subscription.add(t.isLooped.stateChangeStarted$.subscribe((()=>t.isLooped.setState(!1)),i)),this.subscription.add(Ws(this.video,t.volume,s.volumeState$,i)),this.subscription.add(s.volumeState$.subscribe(this.params.output.volume$,i)),this.subscription.add(Qs(this.video,t.playbackRate,s.playbackRateState$,i)),r(Kr(this.video),e.elementVisible$),this.liveTextManager?(r(this.liveTextManager.getCurrentTime$,this.params.output.getCurrentTime$),r(this.liveTextManager.error$,this.params.output.error$)):this.textTracksManager&&this.textTracksManager.connect(this.video,t,e),this.subscription.add(s.playing$.subscribe((()=>{this.videoState.setState("playing"),us(t.playbackState,"playing")}),i)).add(s.pause$.subscribe((()=>{this.videoState.setState("paused"),us(t.playbackState,"paused")}),i)).add(s.canplay$.subscribe((()=>{"ready"===this.videoState.getTransition()?.to&&this.videoState.setState("ready"),"playing"===this.videoState.getState()&&this.playIfAllowed()}),i)),this.liveTextManager&&this.subscription.add(this.liveTextManager.availableTextTracks$.subscribe((e=>{e&&this.params.output.availableTextTracks$.next(e)}))),this.subscription.add(this.maxSeekBackTime$.pipe((0,u.jX)(),(0,u.Tj)((e=>-e/1e3))).subscribe(this.params.output.duration$,i)),this.subscription.add(s.loadedMetadata$.subscribe((()=>{let e=this.params.desiredState.seekState.getState(),t=this.videoState.getTransition(),i=this.params.desiredState.videoTrack.getTransition(),s=this.params.desiredState.autoVideoTrackSwitching.getTransition();if(i&&(0,u.R)(i.to)){let e=i.to.id;this.params.desiredState.videoTrack.setState(i.to);let t=this.manifests$.getValue().find((t=>t.id===e));t&&(this.params.output.currentVideoTrack$.next(t),this.params.output.hostname$.next(Ar(t.url)))}s&&this.params.desiredState.autoVideoTrackSwitching.setState(s.to),t&&"changing_manifest"===t.from&&this.videoState.setState(t.to),e&&"requested"===e.state&&this.seek(e.position)}),i)),this.subscription.add(s.loadedData$.subscribe((()=>{let e=this.video?.getStartDate?.()?.getTime();this.manifestStartTime$.next(e||void 0)}),i)),this.subscription.add((0,u.kg)({startTime:this.manifestStartTime$.pipe((0,u.pb)(u.R)),currentTime:s.timeUpdate$}).subscribe((({startTime:e,currentTime:t})=>this.params.output.liveTime$.next(e+1e3*t)),i)),this.subscription.add(this.manifests$.pipe((0,u.Tj)((e=>e.map((({id:e,quality:t,size:i,bandwidth:s,fps:r})=>({id:e,quality:t,size:i,fps:r,bitrate:s})))))).subscribe(this.params.output.availableVideoTracks$,i));let a=(0,u.h1)(t.playbackState.stateChangeStarted$,t.seekState.stateChangeEnded$,t.videoTrack.stateChangeStarted$,t.autoVideoTrackSwitching.stateChangeStarted$,t.autoVideoTrackLimits.stateChangeStarted$,this.videoState.stateChangeEnded$,this.manifests$,(0,u.Ss)(["init"])).pipe((0,u.sg)(0));this.subscription.add(a.subscribe(this.syncPlayback,i))}destroy(){this.subscription.unsubscribe(),this.textTracksManager?.destroy(),this.liveTextManager?.destroy(),this.params.output.element$.next(void 0),js(this.video)}prepare(){let e=this.selectManifest();if((0,u.wD)(e))return;let t=this.params.desiredState.autoVideoTrackLimits.getTransition(),i=this.params.desiredState.autoVideoTrackLimits.getState(),s=new URL(e.url);if((t||i)&&e.id===this.masterManifest.id){let{max:e,min:r}=t?.to??i??{};for(let[t,i]of[[e,"mq"],[r,"lq"]]){let e=String(parseFloat(t||""));i&&t&&s.searchParams.set(i,e)}}let r="HLS_LIVE_CMAF"===this.params.format?2:0,a=is(s.toString(),this.liveOffset.getTotalOffset(),r);this.liveTextManager?.prepare(a),this.video.setAttribute("src",a),this.video.load(),fu(a).then((e=>{if((0,u.wD)(e)){let e=this.params.source.maxSeekBackTime??this.maxSeekBackTime$.getValue();((0,u.wD)(e)||!isFinite(e))&&Ma(a).then((e=>e.text())).then((e=>{let t=/#EXT-X-STREAM-INF[^\n]+\n(.+)/m.exec(e)?.[1];if(t){let e=new URL(t,a).toString();fu(e).then((e=>{(0,u.wD)(e)||this.maxSeekBackTime$.next(e)}))}})).catch((()=>{}))}else this.maxSeekBackTime$.next(e)}))}playIfAllowed(){Dr(this.video,(()=>{this.params.output.soundProhibitedEvent$.next()})).then((e=>{e||(this.videoState.setState("paused"),this.liveOffset.pause(),us(this.params.desiredState.playbackState,"paused",!0))}),(e=>this.params.output.error$.next({id:"ForcePlay",message:"play() failed even with workarounds",category:u.h.DOM,thrown:e})))}seek(e){this.params.output.willSeekEvent$.next();let t=-e,i=t<this.maxSeekBackTime$.getValue()?t:0;this.liveOffset.resetTo(i),this.params.output.position$.next(-i/1e3),this.params.output.seekedEvent$.next()}generateLiveUrl(){let e=is(this.params.source.url);if(this.params.tuning.useHlsLiveNewTextManager){let t=new URL(e);t.searchParams.set("enable-subtitles","yes"),e=t.toString()}return e}constructor(e){this.subscription=new u.yU,this.videoState=new Ps("stopped"),this.textTracksManager=null,this.liveTextManager=null,this.manifests$=new u.Ot([]),this.liveOffset=new Ys,this.manifestStartTime$=new u.Ot(void 0),this.syncPlayback=()=>{if(!this.manifests$.getValue().length)return;let e=this.videoState.getState(),t=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition(),s=this.params.desiredState.videoTrack.getTransition(),r=this.params.desiredState.autoVideoTrackSwitching.getTransition(),a=this.params.desiredState.autoVideoTrackLimits.getTransition();if("stopped"===t)return void("stopped"!==e&&(this.videoState.startTransitionTo("stopped"),this.video.removeAttribute("src"),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.currentNativeBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState("stopped"),us(this.params.desiredState.playbackState,"stopped",!0)));if(this.videoState.getTransition())return;let n=this.params.desiredState.seekState.getState();if("stopped"===e)return this.videoState.startTransitionTo("ready"),void this.prepare();if(s||r||a){let e=this.videoState.getState();return this.videoState.setState("changing_manifest"),this.videoState.startTransitionTo(e),this.prepare(),a&&this.params.output.autoVideoTrackLimits$.next(a.to),void("none"===n.state&&this.params.desiredState.seekState.setState({state:"requested",position:-this.liveOffset.getTotalOffset(),forcePrecise:!0}))}if("paused"!==i?.to&&"requested"===n.state)return this.videoState.startTransitionTo("ready"),this.seek(n.position&&n.position-this.liveOffset.getTotalPausedTime()),void this.prepare();switch(e){case"ready":return void("ready"===t?us(this.params.desiredState.playbackState,"ready"):"paused"===t?(this.videoState.setState("paused"),this.liveOffset.pause(),us(this.params.desiredState.playbackState,"paused")):"playing"===t&&(this.videoState.startTransitionTo("playing"),this.playIfAllowed()));case"playing":return void("paused"===t?(this.videoState.startTransitionTo("paused"),this.liveOffset.pause(),this.video.paused?this.videoState.setState("paused"):this.video.pause()):"playing"===i?.to&&us(this.params.desiredState.playbackState,"playing"));case"paused":if("playing"===t)if(this.videoState.startTransitionTo("playing"),this.liveOffset.getTotalPausedTime()<this.params.config.maxPausedTime&&this.liveOffset.getTotalOffset()<this.maxSeekBackTime$.getValue())this.liveOffset.resume(),this.playIfAllowed(),this.params.output.position$.next(-this.liveOffset.getTotalOffset()/1e3);else{let e=this.liveOffset.getTotalOffset();e>=this.maxSeekBackTime$.getValue()&&(e=0,this.liveOffset.resetTo(e)),this.liveOffset.resume(),this.params.output.position$.next(-e/1e3),this.prepare()}else"paused"===i?.to&&(us(this.params.desiredState.playbackState,"paused"),this.liveOffset.pause());return;case"changing_manifest":break;default:return(0,u.xb)(e)}},this.params=e,this.video=Us(e.container,e.tuning),this.params.output.element$.next(this.video),this.masterManifest={id:"master",quality:u.Xb.INVARIANT,url:this.params.source.url};let t=(e,t)=>yu(e,this.params.source.url,{manifestRetryInterval:this.params.tuning.manifestRetryInterval,manifestRetryMaxInterval:this.params.tuning.manifestRetryMaxInterval,manifestRetryMaxCount:this.params.tuning.manifestRetryMaxCount},t);this.params.tuning.useHlsLiveNewTextManager?this.liveTextManager=new Su(this.params.output.liveTime$,this.video,t,this.params.source.url,this.params.tuning.hlsLiveNewTextManagerDownloadThreshold):this.textTracksManager=new Zs(e.source.url),t(this.generateLiveUrl()).then((({qualityManifests:e,textTracks:t})=>{0===e.length&&this.params.output.error$.next({id:"HlsLiveProviderInternal:empty_manifest",category:u.h.WTF,message:"HlsLiveProvider: there are no qualities in manifest"}),this.liveTextManager?.processTextTracks(t,this.params.source.url),this.manifests$.next([this.masterManifest,...e])})).catch((e=>{this.params.output.error$.next({id:"ExtractHlsQualities",category:u.h.NETWORK,message:"Error fetching manifest and extracting qualities",thrown:e})})),this.params.output.isLive$.next(!0),this.params.output.canChangePlaybackSpeed$.next(!1),this.params.output.availableVideoTracks$.next([]),this.params.output.availableAudioTracks$.next([]),this.params.output.isAudioAvailable$.next(!0),this.params.output.hostname$.next(Ar(this.params.source.url)),this.params.output.availableTextTracks$.next([]),this.params.desiredState.internalTextTracks.setState([]),this.maxSeekBackTime$=new u.Ot(e.source.maxSeekBackTime??1/0),this.subscribe()}},Tu=class{selectManifest(){let{autoVideoTrackSwitching:e,videoTrack:t}=this.params.desiredState,i=e.getState(),s=t.getTransition(),r=s?.to?.id??t.getState()?.id??"master",a=this.manifests$.getValue();if(!a.length)return;let n=i?"master":r;return i&&(!s||!s.from)&&t.startTransitionTo(this.masterManifest),a.find((e=>e.id===n))}subscribe(){let{output:e,desiredState:t}=this.params,i=t=>{e.error$.next({id:"HlsProvider",category:u.h.WTF,message:"HlsProvider internal logic error",thrown:t})},s=er(this.video);this.subscription.add((()=>s.destroy()));let r=(e,t)=>this.subscription.add(e.subscribe(t));if(r(s.timeUpdate$,e.position$),r(s.durationChange$,e.duration$),r(s.ended$,e.endedEvent$),r(s.looped$,e.loopedEvent$),r(s.error$,e.error$),r(s.isBuffering$,e.isBuffering$),r(s.currentBuffer$,e.currentBuffer$),r(s.currentBuffer$,e.currentNativeBuffer$),r(s.loadedMetadata$,e.firstBytesEvent$),r(s.loadedMetadata$,e.loadedMetadataEvent$),r(s.playing$,e.firstFrameEvent$),r(s.canplay$,e.canplay$),r(s.seeked$,e.seekedEvent$),r(s.inPiP$,e.inPiP$),r(s.inFullscreen$,e.inFullscreen$),r(this.videoState.stateChangeEnded$.pipe((0,u.Tj)((e=>e.to))),this.params.output.playbackState$),this.subscription.add(Hs(this.video,t.isLooped,i)),this.subscription.add(s.volumeState$.subscribe(this.params.output.volume$,i)),this.subscription.add(Qs(this.video,t.playbackRate,s.playbackRateState$,i)),Sa({subscription:this.subscription,desiredState:t,videoElement$:this.params.output.element$,observableVideo:s}),this.subscription.add(Ws(this.video,t.volume,s.volumeState$,i)),this.textTracksManager.connect(this.video,t,e),this.subscription.add(s.playing$.subscribe((()=>{this.videoState.setState("playing"),us(t.playbackState,"playing")}),i)).add(s.pause$.subscribe((()=>{this.videoState.setState("paused"),us(t.playbackState,"paused")}),i)).add(s.canplay$.subscribe((()=>{"ready"===this.videoState.getTransition()?.to&&this.videoState.setState("ready"),"playing"===this.videoState.getState()&&this.playIfAllowed()}),i).add(s.loadedMetadata$.subscribe((()=>{let e=this.params.desiredState.seekState.getState(),t=this.videoState.getTransition(),i=this.params.desiredState.videoTrack.getTransition(),s=this.params.desiredState.autoVideoTrackSwitching.getTransition();if(i&&(0,u.R)(i.to)){let e=i.to.id;this.params.desiredState.videoTrack.setState(i.to);let t=this.manifests$.getValue().find((t=>t.id===e));t&&(this.params.output.currentVideoTrack$.next(t),this.params.output.hostname$.next(Ar(t.url)))}let r=this.params.desiredState.playbackRate.getState(),a=this.params.output.element$.getValue()?.playbackRate;if(r!==a){let e=this.params.output.element$.getValue();e&&(this.params.desiredState.playbackRate.setState(r),e.playbackRate=r)}s&&this.params.desiredState.autoVideoTrackSwitching.setState(s.to),t&&"changing_manifest"===t.from&&this.videoState.setState(t.to),"requested"===e.state&&this.seek(e.position)}),i))),this.params.tuning.changePlaybackStateToPausedWhenEnded&&this.subscription.add(s.ended$.subscribe((()=>{this.videoState.setState("paused"),us(t.playbackState,"paused")}))),this.subscription.add(this.manifests$.pipe((0,u.Tj)((e=>e.map((({id:e,quality:t,size:i,bandwidth:s,fps:r})=>({id:e,quality:t,size:i,fps:r,bitrate:s})))))).subscribe(this.params.output.availableVideoTracks$,i)),!ks.device.isIOS||!this.params.tuning.useNativeHLSTextTracks){let{textTracks:e}=this.video;this.subscription.add((0,u.h1)((0,u.Rt)(e,"addtrack"),(0,u.Rt)(e,"removetrack"),(0,u.Rt)(e,"change"),(0,u.Ss)(["init"])).subscribe((()=>{for(let t=0;t<e.length;t++)e[t].mode="hidden"}),i))}let a=(0,u.h1)(t.playbackState.stateChangeStarted$,t.seekState.stateChangeEnded$,t.videoTrack.stateChangeStarted$,t.autoVideoTrackSwitching.stateChangeStarted$,t.autoVideoTrackLimits.stateChangeStarted$,this.videoState.stateChangeEnded$,this.manifests$,(0,u.Ss)(["init"])).pipe((0,u.sg)(0));this.subscription.add(a.subscribe(this.syncPlayback,i))}destroy(){this.subscription.unsubscribe(),this.textTracksManager.destroy(),this.params.output.element$.next(void 0),js(this.video)}prepare(){let e=this.selectManifest();if((0,u.wD)(e))return;let t=this.params.desiredState.autoVideoTrackLimits.getTransition(),i=this.params.desiredState.autoVideoTrackLimits.getState(),s=new URL(e.url);if((t||i)&&e.id===this.masterManifest.id){let{max:e,min:r}=t?.to??i??{};for(let[t,i]of[[e,"mq"],[r,"lq"]]){let e=String(parseFloat(t||""));i&&t&&s.searchParams.set(i,e)}}this.video.setAttribute("src",s.toString()),this.video.load()}playIfAllowed(){Dr(this.video,(()=>{this.params.output.soundProhibitedEvent$.next()})).then((e=>{e||(this.videoState.setState("paused"),us(this.params.desiredState.playbackState,"paused",!0))}),(e=>this.params.output.error$.next({id:"ForcePlay",message:"play() failed even with workarounds",category:u.h.DOM,thrown:e})))}seek(e){this.params.output.willSeekEvent$.next(),this.video.currentTime=e/1e3}constructor(e){this.subscription=new u.yU,this.videoState=new Ps("stopped"),this.manifests$=new u.Ot([]),this.unmuteAfterBrowserResetsHappened=new u.Ot(!1),this.syncPlayback=()=>{if(!this.manifests$.getValue().length)return;let e=this.videoState.getState(),t=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition(),s=this.params.desiredState.videoTrack.getTransition(),r=this.params.desiredState.autoVideoTrackSwitching.getTransition(),a=this.params.desiredState.autoVideoTrackLimits.getTransition();if("stopped"===t)return void("stopped"!==e&&(this.videoState.startTransitionTo("stopped"),this.video.removeAttribute("src"),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.currentNativeBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState("stopped"),us(this.params.desiredState.playbackState,"stopped",!0)));if(this.videoState.getTransition())return;let n=this.params.desiredState.seekState.getState();if("stopped"===e)return this.videoState.startTransitionTo("ready"),void this.prepare();if(s||r||a){let e=this.videoState.getState();this.videoState.setState("changing_manifest"),this.videoState.startTransitionTo(e);let{currentTime:t}=this.video;return this.prepare(),a&&this.params.output.autoVideoTrackLimits$.next(a.to),void("none"===n.state&&this.params.desiredState.seekState.setState({state:"requested",position:1e3*t,forcePrecise:!0}))}switch("paused"!==i?.to&&"requested"===n.state&&this.seek(n.position),e){case"ready":return void("ready"===t?us(this.params.desiredState.playbackState,"ready"):"paused"===t?(this.videoState.setState("paused"),us(this.params.desiredState.playbackState,"paused")):"playing"===t&&(this.videoState.startTransitionTo("playing"),this.playIfAllowed()));case"playing":return void("paused"===t?(this.videoState.startTransitionTo("paused"),this.video.paused?this.videoState.setState("paused"):this.video.pause()):"playing"===i?.to&&us(this.params.desiredState.playbackState,"playing"));case"paused":return void("playing"===t?(this.videoState.startTransitionTo("playing"),this.playIfAllowed()):"paused"===i?.to&&us(this.params.desiredState.playbackState,"paused"));case"changing_manifest":break;default:return(0,u.xb)(e)}},this.textTracksManager=new Zs(e.source.url),this.params=e,this.video=Us(e.container,e.tuning),this.params.output.element$.next(this.video),this.masterManifest={id:"master",quality:u.Xb.INVARIANT,url:this.params.source.url},this.params.output.isLive$.next(!1),this.params.output.availableVideoTracks$.next([]),this.params.output.availableAudioTracks$.next([]),this.params.output.isAudioAvailable$.next(!0),this.params.output.hostname$.next(Ar(this.params.source.url)),this.params.output.autoVideoTrackLimitingAvailable$.next(!0),this.params.output.manifestRequested$.next(),yu(is(this.params.source.url),this.params.source.url,{manifestRetryInterval:this.params.tuning.manifestRetryInterval,manifestRetryMaxInterval:this.params.tuning.manifestRetryMaxInterval,manifestRetryMaxCount:this.params.tuning.manifestRetryMaxCount}).then((({qualityManifests:e,textTracks:t})=>{this.params.output.firstBytesManifest$.next(),this.manifests$.next([this.masterManifest,...e]),this.params.output.manifestReceived$.next(),this.params.tuning.useNativeHLSTextTracks||this.params.desiredState.internalTextTracks.startTransitionTo(t)}),(e=>this.params.output.error$.next({id:"ExtractHlsQualities",category:u.h.NETWORK,message:"Error fetching manifest and extracting qualities",thrown:e}))),this.subscribe()}},$u=g(Fe(),1),xu=g(Be(),1),ku=g(ni(),1),Lu=class{subscribe(){let{output:e,desiredState:t}=this.params,i=t=>{e.error$.next({id:"MpegProvider",category:u.h.WTF,message:"MpegProvider internal logic error",thrown:t})},s=er(this.video);this.subscription.add((()=>s.destroy()));let r=(e,t)=>this.subscription.add(e.subscribe(t,i));r(s.timeUpdate$,e.position$),r(s.durationChange$,e.duration$),r(s.ended$,e.endedEvent$),r(s.looped$,e.loopedEvent$),r(s.error$,e.error$),r(s.isBuffering$,e.isBuffering$),r(s.currentBuffer$,e.currentNativeBuffer$),r(s.currentBuffer$,e.currentBuffer$),r(s.loadedMetadata$,e.firstBytesEvent$),r(s.loadedMetadata$,e.loadedMetadataEvent$),r(s.playing$,e.firstFrameEvent$),r(s.canplay$,e.canplay$),r(s.seeked$,e.seekedEvent$),r(s.inPiP$,e.inPiP$),r(s.inFullscreen$,e.inFullscreen$),r(this.videoState.stateChangeEnded$.pipe((0,u.Tj)((e=>e.to))),this.params.output.playbackState$),this.subscription.add(Hs(this.video,t.isLooped,i)),Sa({subscription:this.subscription,desiredState:t,videoElement$:this.params.output.element$,observableVideo:s}),this.subscription.add(Ws(this.video,t.volume,s.volumeState$,i)),this.subscription.add(s.volumeState$.subscribe(this.params.output.volume$,i)),this.subscription.add(Qs(this.video,t.playbackRate,s.playbackRateState$,i)),r(Kr(this.video),e.elementVisible$),this.subscription.add(s.playing$.subscribe((()=>{this.videoState.setState("playing"),us(t.playbackState,"playing")}),i)).add(s.pause$.subscribe((()=>{this.videoState.setState("paused"),us(t.playbackState,"paused")}),i)).add(s.canplay$.subscribe((()=>{"ready"===this.videoState.getTransition()?.to&&this.videoState.setState("ready");let e=this.params.desiredState.videoTrack.getTransition();if(e&&(0,u.R)(e.to)){this.params.desiredState.videoTrack.setState(e.to),this.params.output.currentVideoTrack$.next(this.trackUrls[e.to.id].track);let t=this.params.desiredState.playbackRate.getState(),i=this.params.output.element$.getValue()?.playbackRate;if(t!==i){let e=this.params.output.element$.getValue();e&&(this.params.desiredState.playbackRate.setState(t),e.playbackRate=t)}}"playing"===this.videoState.getState()&&this.playIfAllowed()}),i)),this.params.tuning.changePlaybackStateToPausedWhenEnded&&this.subscription.add(s.ended$.subscribe((()=>{this.videoState.setState("paused"),us(t.playbackState,"paused")}))),this.textTracksManager.connect(this.video,t,e);let a=(0,u.h1)(t.playbackState.stateChangeStarted$,t.videoTrack.stateChangeStarted$,t.seekState.stateChangeEnded$,t.autoVideoTrackLimits.stateChangeStarted$,this.videoState.stateChangeEnded$,(0,u.Ss)(["init"])).pipe((0,u.sg)(0));this.subscription.add(a.subscribe(this.syncPlayback,i))}destroy(){this.subscription.unsubscribe(),this.textTracksManager.destroy(),this.trackUrls={},this.params.output.element$.next(void 0),js(this.video)}prepare(){let e=this.params.desiredState.videoTrack.getState()?.id;(0,u.tZ)(e,"MpegProvider: track is not selected");let{url:t}=this.trackUrls[e];(0,u.tZ)(t,`MpegProvider: No url for ${e}`),this.params.tuning.requestQuick&&(t=Pa(t)),this.video.setAttribute("src",t),this.video.load(),this.params.output.hostname$.next(Ar(t))}playIfAllowed(){Dr(this.video,(()=>{this.params.output.soundProhibitedEvent$.next()})).then((e=>{e||(this.videoState.setState("paused"),us(this.params.desiredState.playbackState,"paused",!0))}),(e=>this.params.output.error$.next({id:"ForcePlay",message:"play() failed even with workarounds",category:u.h.DOM,thrown:e})))}seek(e){this.params.output.willSeekEvent$.next(),this.video.currentTime=e/1e3}handleQualityLimitTransition(e){this.params.output.autoVideoTrackLimits$.next(e);let t=e=>{this.params.output.currentVideoTrack$.next(e),this.params.desiredState.videoTrack.startTransitionTo(e)},i=e=>{let i=Lr(a,{container:this.video.getBoundingClientRect(),panelSize:this.params.panelSize,estimatedThroughput:this.params.dependencies.throughputEstimator.throughput$.getValue(),tuning:this.params.tuning.autoTrackSelection,forwardBufferHealth:0,limits:e,abrLogger:this.params.dependencies.abrLogger});t(i)},s=this.params.output.currentVideoTrack$.getValue()?.quality,r=!(!e.max&&!e.min),a=(0,xu.default)(this.trackUrls).map((e=>e.track));if(!s||!r||dr(e,a[0].quality,(0,ku.default)(a,-1)?.quality))return void i();let n=!e.max||(0,u.X5)(s,e.max),o=!e.min||(0,u.Xp)(s,e.min);n&&o||i(e)}constructor(e){this.subscription=new u.yU,this.videoState=new Ps("stopped"),this.trackUrls={},this.textTracksManager=new Zs,this.syncPlayback=()=>{let e=this.videoState.getState(),t=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition();if("stopped"===t)return void("stopped"!==e&&(this.videoState.startTransitionTo("stopped"),this.video.removeAttribute("src"),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.currentNativeBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState("stopped"),us(this.params.desiredState.playbackState,"stopped",!0)));if(this.videoState.getTransition())return;let s=this.params.desiredState.autoVideoTrackLimits.getTransition(),r=this.params.desiredState.videoTrack.getTransition(),a=this.params.desiredState.seekState.getState();if(!s||"ready"===e||r){if("stopped"===e)return this.videoState.startTransitionTo("ready"),void this.prepare();if(r){let{currentTime:e}=this.video;return this.prepare(),void("none"===a.state&&this.params.desiredState.seekState.setState({state:"requested",position:1e3*e,forcePrecise:!0}))}switch("paused"!==i?.to&&"requested"===a.state&&this.seek(a.position),e){case"ready":return void("ready"===t?us(this.params.desiredState.playbackState,"ready"):"paused"===t?(this.videoState.setState("paused"),us(this.params.desiredState.playbackState,"paused")):"playing"===t&&(this.videoState.startTransitionTo("playing"),this.playIfAllowed()));case"playing":return void("paused"===t?(this.videoState.startTransitionTo("paused"),this.video.paused?this.videoState.setState("paused"):this.video.pause()):"playing"===i?.to&&us(this.params.desiredState.playbackState,"playing"));case"paused":return void("playing"===t?(this.videoState.startTransitionTo("playing"),this.playIfAllowed()):"paused"===i?.to&&us(this.params.desiredState.playbackState,"paused"));default:return(0,u.xb)(e)}}else this.handleQualityLimitTransition(s.to)},this.params=e,this.video=Us(e.container,e.tuning),this.params.output.element$.next(this.video),(0,$u.default)(this.params.source).reverse().forEach((([e,t],i)=>{let s=i.toString(10);this.trackUrls[s]={track:{quality:e,id:s},url:t}})),this.params.output.isLive$.next(!1),this.params.output.availableVideoTracks$.next((0,xu.default)(this.trackUrls).map((({track:e})=>e))),this.params.output.availableAudioTracks$.next([]),this.params.output.isAudioAvailable$.next(!0),this.params.desiredState.autoVideoTrackSwitching.setState(!1),this.params.output.autoVideoTrackLimitingAvailable$.next(!0),this.subscribe()}},Ru=["stun:videostun.mycdn.me:80"],Eu=()=>null,Bu=class{onStart(e){try{this.externalStartCallback=e}catch(e){this.handleSystemError(e)}}onStop(e){try{this.externalStopCallback=e}catch(e){this.handleSystemError(e)}}onError(e){try{this.externalErrorCallback=e}catch(e){this.handleSystemError(e)}}connect(){this.connectWS()}disconnect(){try{this.externalStopCallback(),this.closeConnections()}catch(e){this.handleSystemError(e)}}connectWS(){this.ws||(this.ws=new WebSocket(this.serverUrl),this.ws.onopen=this.onSocketOpen.bind(this),this.ws.onmessage=this.onSocketMessage.bind(this),this.ws.onclose=this.onSocketClose.bind(this),this.ws.onerror=this.onSocketError.bind(this))}onSocketOpen(){this.handleLogin()}onSocketClose(e){try{if(!this.ws)return;this.ws=null,e.code>1e3?(this.retryCount++,this.retryCount>this.options.maxRetryNumber?this.handleNetworkError():this.scheduleRetry()):this.externalStopCallback()}catch(e){this.handleRTCError(e)}}onSocketError(e){try{this.externalErrorCallback(new Error(e.toString()))}catch(e){this.handleRTCError(e)}}onSocketMessage(e){try{let t=this.parseMessage(e.data);switch(t.type){case"JOIN":case"CALL_JOIN":this.handleJoinMessage(t);break;case"UPDATE":this.handleUpdateMessage(t);break;case"STATUS":this.handleStatusMessage(t)}}catch(e){this.handleRTCError(e)}}handleJoinMessage(e){switch(e.inviteType){case"ANSWER":this.handleAnswer(e.sdp);break;case"CANDIDATE":this.handleCandidate(e.candidate)}}handleStatusMessage(e){if("UNPUBLISHED"===e.status)this.handleUnpublished()}async handleUpdateMessage(e){try{let t=await this.createOffer();this.peerConnection&&await this.peerConnection.setLocalDescription(t),this.handleAnswer(e.sdp)}catch(e){this.handleRTCError(e)}}async handleLogin(){try{let e={iceServers:[{urls:Ru}]};this.peerConnection=new RTCPeerConnection(e),this.peerConnection.ontrack=this.onPeerConnectionStream.bind(this),this.peerConnection.onicecandidate=this.onPeerConnectionIceCandidate.bind(this),this.peerConnection.oniceconnectionstatechange=this.onPeerConnectionIceConnectionStateChange.bind(this);let t=await this.createOffer();await this.peerConnection.setLocalDescription(t),this.send({type:this.signalingType,inviteType:"OFFER",streamKey:this.streamKey,sdp:t.sdp,callSupport:!1})}catch(e){this.handleRTCError(e)}}async handleAnswer(e){try{this.peerConnection&&await this.peerConnection.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:e}))}catch(e){this.handleRTCError(e)}}async handleCandidate(e){if(e)try{this.peerConnection&&await this.peerConnection.addIceCandidate(e)}catch(e){this.handleRTCError(e)}}handleUnpublished(){try{this.closeConnections(),this.externalStopCallback()}catch(e){this.handleRTCError(e)}}handleSystemError(e){this.options.errorChanel&&this.options.errorChanel.next({id:"webrtc-provider-error",category:u.h.WTF,message:e.message})}async onPeerConnectionStream(e){let t=e.streams[0];this.stream&&this.stream.id===t.id||(this.stream=t,this.externalStartCallback(this.stream))}onPeerConnectionIceCandidate(e){e.candidate&&this.send({type:this.signalingType,inviteType:"CANDIDATE",candidate:e.candidate})}onPeerConnectionIceConnectionStateChange(){if(this.peerConnection){let e=this.peerConnection.iceConnectionState;["failed","closed"].indexOf(e)>-1&&(this.retryCount++,this.retryCount>this.options.maxRetryNumber?this.handleNetworkError():(this.closeConnections(),this.scheduleRetry()))}}async createOffer(){if(!this.peerConnection)throw new Error("Can not create offer - no peer connection instance ");let e=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0,voiceActivityDetection:!1}),t=e.sdp||"";if(!/^a=rtpmap:\d+ H264\/\d+$/m.test(t))throw new Error("No h264 codec support error");return e}handleRTCError(e){try{this.externalErrorCallback(e||new Error("RTC connection error"))}catch(e){this.handleSystemError(e)}}handleNetworkError(){try{this.externalErrorCallback(new Error("Network error"))}catch(e){this.handleSystemError(e)}}send(e){this.ws&&this.ws.send(JSON.stringify(e))}parseMessage(e){try{return JSON.parse(e)}catch{throw new Error("Can not parse socket message")}}closeConnections(){let e=this.ws;e&&(this.ws=null,e.close(1e3)),this.removePeerConnection()}removePeerConnection(){let e=this.peerConnection;e&&(this.peerConnection=null,e.close(),e.ontrack=null,e.onicecandidate=null,e.oniceconnectionstatechange=null,e=null)}scheduleRetry(){this.retryTimeout=setTimeout(this.connectWS.bind(this),1e3)}normalizeOptions(e={}){let t={stunServerList:Ru,maxRetryNumber:3,errorChanel:null};return e.stunServerList&&(t.stunServerList=e.stunServerList),e.maxRetryNumber&&e.maxRetryNumber>0&&(t.maxRetryNumber=e.maxRetryNumber),t}constructor(e,t){this.ws=null,this.peerConnection=null,this.serverUrl="",this.streamKey="",this.stream=null,this.signalingType="JOIN",this.retryCount=0,this.externalStartCallback=Eu,this.externalStopCallback=Eu,this.externalErrorCallback=Eu,this.options=this.normalizeOptions(t);let i=e.split("/");this.serverUrl=i.slice(0,i.length-1).join("/"),this.streamKey=i[i.length-1]}},Au=class{destroy(){this.subscription.unsubscribe(),this.liveStreamClient.disconnect(),this.params.output.element$.next(void 0),js(this.video)}subscribe(){let{output:e,desiredState:t}=this.params,i=t=>{e.error$.next({id:"WebRTCLiveProvider",category:u.h.WTF,message:"WebRTCLiveProvider internal logic error",thrown:t})};this.subscription.add((0,u.h1)(this.videoState.stateChangeStarted$.pipe((0,u.Tj)((e=>({transition:e,type:"start"})))),this.videoState.stateChangeEnded$.pipe((0,u.Tj)((e=>({transition:e,type:"end"}))))).subscribe((({transition:e,type:t})=>{this.log({message:`[videoState change] ${t}: ${JSON.stringify(e)}`})})));let s=er(this.video);this.subscription.add((()=>s.destroy()));let r=(e,t)=>this.subscription.add(e.subscribe(t,i));r(s.timeUpdate$,e.liveTime$),r(s.ended$,e.endedEvent$),r(s.looped$,e.loopedEvent$),r(s.error$,e.error$),r(s.isBuffering$,e.isBuffering$),r(s.currentBuffer$,e.currentBuffer$),r(s.currentBuffer$,e.currentNativeBuffer$),r(Kr(this.video),this.params.output.elementVisible$),this.subscription.add(s.durationChange$.subscribe((t=>{e.duration$.next(t===1/0?0:t)}))).add(s.canplay$.subscribe((()=>{"ready"===this.videoState.getTransition()?.to&&this.videoState.setState("ready")}),i)).add(s.pause$.subscribe((()=>{this.videoState.setState("paused")}),i)).add(s.playing$.subscribe((()=>{this.videoState.setState("playing")}),i)).add(s.error$.subscribe(e.error$)).add(this.maxSeekBackTime$.subscribe(this.params.output.duration$)).add(Ws(this.video,t.volume,s.volumeState$,i)).add(s.volumeState$.subscribe(e.volume$,i)).add(this.videoState.stateChangeEnded$.subscribe((i=>{switch(i.to){case"stopped":e.position$.next(0),e.duration$.next(0),t.playbackState.setState("stopped");break;case"ready":break;case"paused":t.playbackState.setState("paused");break;case"playing":t.playbackState.setState("playing");break;default:return(0,u.xb)(i.to)}}),i)).add((0,u.h1)(t.playbackState.stateChangeStarted$,this.videoState.stateChangeEnded$,(0,u.Ss)(["init"])).pipe((0,u.sg)(0)).subscribe(this.syncPlayback.bind(this),i)),this.subscription.add(t.isLooped.stateChangeStarted$.subscribe((()=>t.isLooped.setState(!1)),i)),this.subscription.add(t.autoVideoTrackSwitching.stateChangeStarted$.subscribe((()=>t.autoVideoTrackSwitching.setState(!1)),i))}onLiveStreamStart(e){this.params.output.element$.next(this.video),this.params.output.duration$.next(0),this.params.output.position$.next(0),this.params.output.isLive$.next(!0),this.params.output.canChangePlaybackSpeed$.next(!1),this.params.output.hostname$.next(Ar(this.params.source.url)),this.params.output.autoVideoTrackLimitingAvailable$.next(!1),this.params.output.availableVideoTracks$.next([]),this.params.output.availableAudioTracks$.next([]),this.params.output.isAudioAvailable$.next(!0),this.params.output.currentVideoTrack$.next({id:"webrtc",quality:u.Xb.INVARIANT}),this.video.srcObject=e,us(this.params.desiredState.playbackState,"playing")}onLiveStreamStop(){this.videoState.startTransitionTo("stopped"),this.syncPlayback(),this.params.output.position$.next(0),this.params.output.duration$.next(0),this.params.output.currentBuffer$.next(void 0),this.params.output.currentNativeBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.params.output.endedEvent$.next()}onLiveStreamError(e){this.onLiveStreamStop(),this.params.output.error$.next({id:"WebRTC stream runtime error",category:u.h.EXTERNAL_API,message:e.message,thrown:e})}playIfAllowed(){Dr(this.video,(()=>{this.params.output.soundProhibitedEvent$.next()})).then((e=>{e||(this.videoState.setState("paused"),us(this.params.desiredState.playbackState,"paused",!0))}),(e=>this.params.output.error$.next({id:"ForcePlay",message:"play() failed even with workarounds",category:u.h.DOM,thrown:e})))}prepare(){this.liveStreamClient.connect()}constructor(e){this.videoState=new Ps("stopped"),this.maxSeekBackTime$=new u.Ot(0),this.syncPlayback=()=>{let e=this.videoState.getState(),t=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition();if("stopped"===t)return void("stopped"!==e&&(this.videoState.startTransitionTo("stopped"),this.video.pause(),this.video.srcObject=null,this.params.output.position$.next(0),this.params.output.duration$.next(0),this.params.output.currentBuffer$.next(void 0),this.params.output.currentNativeBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState("stopped"),us(this.params.desiredState.playbackState,"stopped",!0)));if(this.videoState.getTransition())return;let s=this.params.desiredState.videoTrack.getTransition();if("stopped"===e)return this.videoState.startTransitionTo("ready"),void this.prepare();if(s)this.prepare();else switch(e){case"ready":return void("paused"===t?(this.videoState.setState("paused"),us(this.params.desiredState.playbackState,"paused")):"playing"===t&&(this.videoState.startTransitionTo("playing"),this.playIfAllowed()));case"playing":return void("paused"===t?(this.videoState.startTransitionTo("paused"),this.video.paused?this.videoState.setState("paused"):this.video.pause()):"playing"===i?.to&&us(this.params.desiredState.playbackState,"playing"));case"paused":return void("playing"===t?(this.videoState.startTransitionTo("playing"),this.playIfAllowed()):"paused"===i?.to&&us(this.params.desiredState.playbackState,"paused"));default:return(0,u.xb)(e)}},this.subscription=new u.yU,this.params=e,this.log=this.params.dependencies.logger.createComponentLog("WebRTCLiveProvider"),this.video=Us(e.container,e.tuning),this.liveStreamClient=new Bu(this.params.source.url,{maxRetryNumber:this.params.tuning.webrtc.connectionRetryMaxNumber,errorChanel:this.params.output.error$}),this.liveStreamClient.onStart(this.onLiveStreamStart.bind(this)),this.liveStreamClient.onStop(this.onLiveStreamStop.bind(this)),this.liveStreamClient.onError(this.onLiveStreamError.bind(this)),this.params.output.availableTextTracks$.next([]),this.params.desiredState.internalTextTracks.setState([]),this.subscribe()}},Mu=class{next(){this.current=this.iterator.next(),this.index=void 0===this.index?0:this.index+1}getValue(){if(this.current.done)throw new Error("Iterable is completed");return this.current.value}isCompleted(){return!!this.current.done}isLast(){return this.index===this.length-1}constructor(e){this.length=e.length,this.iterator=e[Symbol.iterator](),this.next()}};var Cu=(s=class e{subscribe(e){ks.browser.isSafari&&"MPEG"!==e||this.subscriptions.add((0,u.kg)({video:this.providerOutput.element$,playbackState:this.providerOutput.playbackState$,volume:this.providerOutput.volume$}).pipe((0,u.pb)((({playbackState:e,video:t,volume:{muted:i,volume:s}})=>"playing"===e&&!!t&&!i&&!!s)),(0,u.Oo)()).subscribe((({video:e})=>{this.initAudioContextOnce(e).then((e=>{e||this.destroy()})).catch((e=>{this.handleError(e),this.destroy()}))})))}static isSupported(){return"AudioContext"in window&&"GainNode"in window&&"MediaElementAudioSourceNode"in window}async initAudioContextOnce(e){let{volumeMultiplier:t}=this,i=new(window.AudioContext||window.webkitAudioContext);this.audioContext=i;let s=i.createGain();if(this.gainNode=s,s.gain.value=t,s.connect(i.destination),"suspended"===i.state&&(await i.resume(),this.destroyController.signal.aborted))return!1;let r=i.createMediaElementSource(e);return this.mediaElementSource=r,r.connect(s),!0}cleanup(){this.mediaElementSource&&(this.mediaElementSource.disconnect(),this.mediaElementSource=null),this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.audioContext&&("closed"!==this.audioContext.state&&this.audioContext.close(),this.audioContext=null)}destroy(){this.destroyController.abort(),this.subscriptions.unsubscribe(),this.cleanup()}handleError(t){this.volumeMultiplierError$.next({id:e.errorId,category:u.h.VIDEO_PIPELINE,message:t?.message??`${e.errorId} exception`,thrown:t})}constructor(e,t,i,s){this.providerOutput=e,this.provider$=t,this.volumeMultiplierError$=i,this.volumeMultiplier=s,this.destroyController=new Ca,this.subscriptions=new u.yU,this.audioContext=null,this.gainNode=null,this.mediaElementSource=null,this.subscriptions.add(this.provider$.pipe((0,u.pb)((e=>!!e.type)),(0,u.Oo)()).subscribe((({type:e})=>this.subscribe(e))))}},s.errorId="VolumeMultiplierManager",s),Iu={chunkDuration:5e3,maxParallelRequests:5},Du=class{init(){Qr.reset(),this.subscription.add(this.initProviderErrorHandling()).add(this.params.dependencies.chromecastInitializer.connection$.subscribe((()=>{this.reinitProvider()}))).add(this.providerOutput.availableVideoCodecs$.subscribe((e=>{!this.videoCodecsIterator&&e.length>1&&(this.videoCodecsIterator=new Mu(e))})))}destroy(){this.destroyProvider(),this.current$.next({type:void 0}),this.subscription.unsubscribe(),this.volumeMultiplierManager?.destroy(),this.volumeMultiplierManager=null,this.tracer.end()}initProvider(){let e,t=this.chooseDestination(),i=this.chooseFormat(t);if((0,u.wD)(i))this.handleNoFormatsError(t);else{try{e=this.createProvider(t,i)}catch(e){this.providerError$.next({id:"ProviderNotConstructed",category:u.h.WTF,message:"Failed to create provider",thrown:e})}e?this.current$.next({type:i,provider:e,destination:t}):this.current$.next({type:void 0})}}reinitProvider(){this.tracer.log("reinitProvider"),this.destroyProvider(),this.initProvider()}switchToNextProvider(e){this.tracer.log("switchToNextProvider",{destination:e}),this.destroyProvider(),this.failoverIndex=void 0,this.skipFormat(e),this.initProvider()}switchToNextVideoCodec(){this.params.tuning.dash.codecsPrioritizeEnabled&&!this.videoCodecsIterator.isLast()&&(this.tracer.log("switchToNextVideoCodec"),this.destroyProvider(),this.videoCodecsIterator.next(),this.initProvider())}destroyProvider(){let e=this.current$.getValue().provider;if(!e)return;this.log({message:"destroyProvider"}),this.tracer.log("destroyProvider"),e.destroy();let t=1e3*this.providerOutput.position$.getValue(),i=this.params.desiredState.seekState.getState(),s="none"!==i.state;if(this.params.desiredState.seekState.setState({state:"requested",position:s?i.position:t,forcePrecise:!!s&&i.forcePrecise}),e.scene3D){let t=e.scene3D.getCameraRotation();this.params.desiredState.cameraOrientation.setState({x:t.x,y:t.y})}let r=this.providerOutput.isBuffering$;r.getValue()||r.next(!0)}createProvider(e,t){switch(this.log({message:`createProvider: ${e}:${t}`}),this.tracer.log("createProvider",{destination:e,format:t}),e){case"SCREEN":return this.createScreenProvider(t);case"CHROMECAST":return this.createChromecastProvider(t);default:return(0,u.xb)(e)}}createScreenProvider(e){let{sources:t,container:i,desiredState:s,panelSize:r}=this.params,a=this.providerOutput,n={container:i,source:null,desiredState:s,output:a,dependencies:this.params.dependencies,tuning:this.params.tuning,panelSize:r};switch(e){case"DASH_SEP":case"DASH_WEBM":case"DASH_WEBM_AV1":case"DASH_ONDEMAND":case"DASH_STREAMS":{let i=this.applyFailoverHost(t[e]),s=this.applyFailoverHost(t.HLS_ONDEMAND||t.HLS);return(0,u.tZ)(i),this.params.tuning.useNewDashProvider?new lu({...n,source:i,sourceHls:s,forceVideoCodec:this.videoCodecsIterator?.getValue()}):this.params.tuning.useDashProviderVirtual&&!ks.device.isMobile||this.params.tuning.useDashProviderVirtualMobile&&ks.device.isMobile?new uo({...n,source:i,sourceHls:s,forceVideoCodec:this.videoCodecsIterator?.getValue()}):new Oo({...n,source:i,sourceHls:s,forceVideoCodec:this.videoCodecsIterator?.getValue()})}case"DASH_LIVE_CMAF":{let i=this.applyFailoverHost(t[e]);return(0,u.tZ)(i),this.params.tuning.useNewDashProvider?new cu({...n,source:i}):new Po({...n,source:i})}case"HLS":case"HLS_ONDEMAND":case"HLS_FMP4":{let i=this.applyFailoverHost(t[e]);return(0,u.tZ)(i),new Tu({...n,source:i})}case"HLS_LIVE":case"HLS_LIVE_CMAF":{let i=this.applyFailoverHost(t[e]);return(0,u.tZ)(i),new wu({...n,source:i,config:{maxPausedTime:this.params.tuning.live.maxPausedTime},format:e})}case"MPEG":{let i=this.applyFailoverHost(t[e]);return(0,u.tZ)(i),new Lu({...n,source:i})}case"DASH_LIVE":{let i=this.applyFailoverHost(t[e]);return(0,u.tZ)(i),new ia({...n,source:i,config:{...Iu,maxPausedTime:this.params.tuning.live.maxPausedTime}})}case"WEB_RTC_LIVE":{let r=this.applyFailoverHost(t[e]);return(0,u.tZ)(r),new Au({container:i,source:r,desiredState:s,output:a,dependencies:this.params.dependencies,tuning:this.params.tuning})}case"DASH":case"DASH_LIVE_WEBM":throw new Error(`${e} is no longer supported`);default:return(0,u.xb)(e)}}createChromecastProvider(e){let{sources:t,container:i,desiredState:s,meta:r}=this.params,a={meta:r,container:i,source:t,format:e,desiredState:s,output:this.providerOutput,dependencies:this.params.dependencies,tuning:this.params.tuning};if(this.params.tuning.chromecastPresentationApi&&this.params.dependencies.chromecastInitializer instanceof Ms){let{chromecastConnector:e}=this.params.dependencies.chromecastInitializer;return(0,u.tZ)(e),new Bs({...a,chromecastConnector:e})}let n=this.params.dependencies.chromecastInitializer.connection$.getValue();return(0,u.tZ)(n),new Vs({...a,connection:n})}chooseDestination(){return this.params.dependencies.chromecastInitializer.connection$.getValue()?"CHROMECAST":"SCREEN"}chooseFormat(e){switch(e){case"SCREEN":return this.screenFormatsIterator.isCompleted()?void 0:this.screenFormatsIterator.getValue();case"CHROMECAST":return this.chromecastFormatsIterator.isCompleted()?void 0:this.chromecastFormatsIterator.getValue();default:return(0,u.xb)(e)}}skipFormat(e){switch(e){case"SCREEN":return this.screenFormatsIterator.next();case"CHROMECAST":return this.chromecastFormatsIterator.next();default:return(0,u.xb)(e)}}handleNoFormatsError(e){switch(e){case"SCREEN":return this.noAvailableProvidersError$.next(this.params.tuning.forceFormat),void this.current$.next({type:void 0});case"CHROMECAST":return void this.params.dependencies.chromecastInitializer.disconnect();default:return(0,u.xb)(e)}}applyFailoverHost(e){if(void 0===this.failoverIndex)return e;let t=this.params.failoverHosts[this.failoverIndex];if(!t)return e;let i=e=>{let i=new URL(e);return i.host=t,i.toString()};if(void 0===e)return e;if("type"in e){if("raw"===e.type)return e;if("url"===e.type)return{...e,url:i(e.url)}}return(0,Ds.default)((0,Is.default)(e).map((([e,t])=>[e,i(t)])))}initProviderErrorHandling(){let e=new u.yU,t=!1,i=0;e.add((0,u.h1)(this.providerOutput.error$.pipe((0,u.pb)((e=>!this.params.tuning.ignoreAudioRendererError||!e.message||!/AUDIO_RENDERER_ERROR/gi.test(e.message)))),(e=>new u.cP((t=>{let i=new u.yU,s=e.desiredPlaybackState$.stateChangeStarted$.pipe((0,u.Tj)((({from:e,to:t})=>`${e}-${t}`))),r=e.desiredPlaybackState$.stateChangeEnded$,a=e.providerChanged$.pipe((0,u.Tj)((({type:e})=>void 0!==e))),n=new u.B7,o=0,h="unknown";return i.add(s.subscribe((t=>{o&&window.clearTimeout(o),h=t,o=window.setTimeout((()=>n.next(t)),e.maxTransitionInterval),Qr({m:"hangup.set",l:t,id:o})}))),i.add(r.subscribe((()=>{Qr({m:"hangup.cl",id:o}),window.clearTimeout(o),h="unknown",o=0}))),i.add(a.subscribe((t=>{o&&(Qr({m:"hangup.rs.0",id:o}),window.clearTimeout(o),o=0,t&&(o=window.setTimeout((()=>n.next(h)),e.maxTransitionInterval),Qr({m:"hangup.rs.1",id:o})))}))),i.add(n.subscribe(t)),()=>{window.clearTimeout(o),i.unsubscribe()}})))({desiredPlaybackState$:this.params.desiredState.playbackState,maxTransitionInterval:this.params.tuning.maxPlaybackTransitionInterval,position$:this.providerOutput.position$,providerChanged$:this.current$}).pipe((0,u.Tj)((e=>({id:`ProviderHangup:${e}`,category:u.h.WTF,message:`A ${e} transition failed to complete within reasonable time`}))))).subscribe(this.providerError$)),e.add(this.providerOutput.fetcherError$.subscribe(this.providerError$)),e.add(this.current$.subscribe((()=>{t=!1;let i=this.params.desiredState.playbackState.transitionEnded$.pipe((0,u.pb)((({to:e})=>"playing"===e)),(0,u.Oo)()).subscribe((()=>t=!0));e.add(i)})));let s=()=>{let e=Qr.drain(),{logDashLiveDebug:t,sendDashLiveDebug:i}=this.params.tuning;if(t&&window.console.log("===== DASH_LIVE DEBUG START ====\n",e.map((({time:e,data:t,stack:i})=>`${e}: ${JSON.stringify(t)}${i?"\n"+i:""}`)).join("\n"),"\n===== DASH_LIVE DEBUG END ===="),i){let t=e.reduce(((e,{time:t,data:i,stack:s})=>e+=`${t}: ${(0,Is.default)(i).map((([e,t])=>`${e}:${t}`)).join(",")}${s?`: ${s}`:""};`),"");u.dm.push("core",{key:"vp_dash_live_debug",strings:[t]})}};return e.add(this.providerError$.subscribe((e=>{e.id.startsWith("ProviderHangup")&&(Qr({m:"final.0",e:e.id}),s())}))).add(this.noAvailableProvidersError$.subscribe((()=>{Qr({m:"final.1"}),s()}))),e.add(this.providerError$.subscribe((e=>{let s=this.current$.getValue().destination,r={error:e,currentDestination:s};if("CHROMECAST"===s)this.destroyProvider(),this.params.dependencies.chromecastInitializer.stopMedia().then((()=>this.switchToNextProvider("CHROMECAST")),(()=>this.params.dependencies.chromecastInitializer.disconnect()));else{let a=e.category===u.h.NETWORK,n=e.category===u.h.FATAL,o=this.params.failoverHosts.length>0&&(void 0===this.failoverIndex||this.failoverIndex<this.params.failoverHosts.length-1),h=i<this.params.tuning.providerErrorLimit&&!n,d=this.videoCodecsIterator&&!this.videoCodecsIterator.isLast()&&this.params.tuning.dash.codecsPrioritizeEnabled,l=o&&!n&&(a&&t||!h);r={...r,isNetworkError:a,isFatalError:n,haveFailoverHost:o,tryFailover:l,canReinitProvider:h},h?(i++,this.reinitProvider()):l?(this.failoverIndex=void 0===this.failoverIndex?0:this.failoverIndex+1,this.reinitProvider()):d?this.switchToNextVideoCodec():(i=0,this.switchToNextProvider(s??"SCREEN"))}e.traceAsLog?this.tracer.log("providerInfo",(0,u.YO)(r)):this.tracer.error("providerError",(0,u.YO)(r))}))),e}constructor(e){this.current$=new u.Ot({type:void 0}),this.providerError$=new u.B7,this.noAvailableProvidersError$=new u.B7,this.volumeMultiplierError$=new u.B7,this.providerOutput={position$:new u.Ot(0),duration$:new u.Ot(1/0),volume$:new u.Ot({muted:!1,volume:1}),availableVideoStreams$:new u.Ot([]),currentVideoStream$:new u.Ot(void 0),availableVideoTracks$:new u.Ot([]),currentVideoTrack$:new u.Ot(void 0),availableVideoCodecs$:new u.Ot([]),availableAudioStreams$:new u.Ot([]),currentAudioStream$:new u.Ot(void 0),availableAudioTracks$:new u.Ot([]),availableAudioCodecs$:new u.Ot([]),currentVideoSegmentLength$:new u.Ot(0),currentAudioSegmentLength$:new u.Ot(0),isAudioAvailable$:new u.Ot(!0),autoVideoTrackLimitingAvailable$:new u.Ot(!1),autoVideoTrackLimits$:new u.Ot(void 0),currentBuffer$:new u.Ot(void 0),currentNativeBuffer$:new u.Ot(void 0),isBuffering$:new u.Ot(!0),error$:new u.B7,fetcherError$:new u.B7,fetcherRecoverableError$:new u.B7,warning$:new u.B7,willSeekEvent$:new u.B7,soundProhibitedEvent$:new u.B7,seekedEvent$:new u.B7,loopedEvent$:new u.B7,endedEvent$:new u.B7,manifestRequested$:new u.B7,firstBytesManifest$:new u.B7,manifestReceived$:new u.B7,firstBytesRequested$:new u.B7,firstBytesReceived$:new u.B7,firstBytesEvent$:new u.B7,loadedMetadataEvent$:new u.B7,firstFrameEvent$:new u.B7,canplay$:new u.B7,isLive$:new u.Ot(void 0),isLiveEnded$:new u.Ot(null),canPlayLiveTailBuffer$:new u.Ot(!1),isLowLatency$:new u.Ot(!1),canChangePlaybackSpeed$:new u.Ot(!0),liveTime$:new u.Ot(void 0),liveBufferTime$:new u.Ot(void 0),liveLatency$:new u.Ot(void 0),severeStallOccurred$:new u.B7,availableTextTracks$:new u.Ot([]),currentTextTrack$:new u.Ot(void 0),hostname$:new u.Ot(void 0),httpConnectionType$:new u.Ot(void 0),httpConnectionReused$:new u.Ot(void 0),inPiP$:new u.Ot(!1),inFullscreen$:new u.Ot(!1),element$:new u.Ot(void 0),elementVisible$:new u.Ot(!0),availableSources$:new u.Ot(void 0),is3DVideo$:new u.Ot(!1),playbackState$:new u.Ot(""),getCurrentTime$:new u.Ot(null)},this.subscription=new u.yU,this.volumeMultiplierManager=null,this.params=e,this.log=this.params.dependencies.logger.createComponentLog("ProviderContainer"),this.tracer=e.dependencies.tracer.createComponentTracer(this.constructor.name);let t=Ls([...an(this.params.tuning),...rn(this.params.tuning)]).filter((t=>(0,u.R)(e.sources[t]))),{forceFormat:i,formatsToAvoid:s}=this.params.tuning,r=[];r=i?[i]:s.length?[...t.filter((e=>!(0,Cs.default)(s,e))),...t.filter((e=>(0,Cs.default)(s,e)))]:t,this.log({message:`Selected formats: ${r.join(" > ")}`}),this.tracer.log("Selected formats",(0,u.YO)(r)),this.screenFormatsIterator=new Mu(r);let a=[...nn(!0),...nn(!1)];this.chromecastFormatsIterator=new Mu(a.filter((t=>(0,u.R)(e.sources[t])))),this.providerOutput.availableSources$.next(e.sources);let{volumeMultiplier:n=1,tuning:{useVolumeMultiplier:o}}=this.params;o&&1!==n&&Cu.isSupported()&&(this.volumeMultiplierManager=new Cu(this.providerOutput,this.current$,this.volumeMultiplierError$,n))}},Ou="one_video_throughput",Pu="one_video_rtt",Vu=window.navigator.connection,_u=()=>{let e=Vu?.downlink;if((0,u.R)(e)&&10!==e)return 1e3*e},Fu=()=>{let e=Vu?.rtt;if((0,u.R)(e)&&3e3!==e)return e},Nu=(e,t,i)=>{let s=8*i;return s/(s/e+t)},Uu=class e{destroy(){this.concurrentDownloads.clear(),this.subscription.unsubscribe()}trackXHR(e){let t=0,i=(0,u.tB)(),s=new u.yU;switch(this.subscription.add(s),this.concurrentDownloads.add(e),e.readyState){case 4:break;case 3:case 2:s.add((0,u.Rt)(e,"progress").pipe((0,u.Oo)()).subscribe((e=>{t=e.loaded,i=(0,u.tB)()})));break;case 1:case 0:s.add((0,u.Rt)(e,"loadstart").subscribe((()=>{t=0,i=(0,u.tB)()})))}s.add((0,u.Rt)(e,"loadend").subscribe((r=>{if(200===e.status){let e=r.loaded,s=(0,u.tB)(),a=e-t,n=s-i;this.addRawSpeed(a,n,1)}this.concurrentDownloads.delete(e),s.unsubscribe()})))}trackStream(e,t=!1){let i=e.getReader();if(!i)return void e.cancel("Could not get reader");let s=0,r=(0,u.tB)(),a=0,n=(0,u.tB)(),o=t=>{this.concurrentDownloads.delete(e),i.releaseLock(),e.cancel(`Throughput Estimator error: ${t}`).catch((()=>{}))},h=async({done:d,value:l})=>{if(d)!t&&this.addRawSpeed(s,(0,u.tB)()-r,1),this.concurrentDownloads.delete(e);else if(l){if(t){let e=(0,u.tB)();if(e-n>this.tuningConfig.lowLatency.continuesByteSequenceInterval||e-r>this.tuningConfig.lowLatency.maxLastEvaluationTimeout){let e=n-r;e&&this.addRawSpeed(a,e,1,t),a=l.byteLength,r=(0,u.tB)()}else a+=l.byteLength;n=(0,u.tB)()}else s+=l.byteLength,a+=l.byteLength,a>=this.tuningConfig.streamMinSampleSize&&(0,u.tB)()-n>=this.tuningConfig.streamMinSampleTime&&(this.addRawSpeed(a,(0,u.tB)()-n,this.concurrentDownloads.size),a=0,n=(0,u.tB)());await(i?.read().then(h,o))}};this.concurrentDownloads.add(e),i?.read().then(h,o)}addRawSpeed(t,i,s=1,r=!1){if(e.sanityCheck(t,i,r)){let e=8*t/i;this.throughput.next(e*s)}}addRawThroughput(e){this.throughput.next(e)}addRawRtt(e){this.rtt.next(e)}static sanityCheck(e,t,i=!1){let s=8*e/t;return!(!s||!isFinite(s)||s>1e6||s<30||i&&e<1e4||!i&&e<10240||!i&&t<=20)}static load(e){let t=u.RW.get(e);if((0,u.R)(t))return parseInt(t,10)??void 0}constructor(t){this.subscription=new u.yU,this.concurrentDownloads=new Set,this.tuningConfig=t;let i=e.load(Ou)||(t.useBrowserEstimation?_u():void 0)||5e3,s=e.load(Pu)??(t.useBrowserEstimation?Fu():void 0)??0;if(this.throughput$=new u.Ot(i),this.rtt$=new u.Ot(s),this.rttAdjustedThroughput$=new u.Ot(Nu(i,s,t.rttPenaltyRequestSize)),this.throughput=Ro.getSmoothedValue(i,-1,t),this.rtt=Ro.getSmoothedValue(s,1,t),t.useBrowserEstimation){let e=()=>{let e=_u();e&&this.throughput.next(e);let t=Fu();(0,u.R)(t)&&this.rtt.next(t)};Vu&&"onchange"in Vu&&this.subscription.add((0,u.Rt)(Vu,"change").subscribe(e)),e()}this.subscription.add(this.throughput.smoothed$.subscribe((e=>{u.RW.set(Ou,e.toFixed(0))}))),this.subscription.add(this.rtt.smoothed$.subscribe((e=>{u.RW.set(Pu,e.toFixed(0))}))),this.subscription.add(this.throughput.debounced$.pipe((0,u.Tj)((e=>Math.round(e)))).subscribe(this.throughput$)),this.subscription.add(this.rtt.debounced$.subscribe(this.rtt$)),this.subscription.add((0,u.kg)({throughput:this.throughput.smoothed$,rtt:this.rtt.smoothed$}).pipe((0,u.Tj)((({throughput:e,rtt:i})=>Nu(e,i,t.rttPenaltyRequestSize))),(0,u.pb)((e=>{let i=this.rttAdjustedThroughput$.getValue()||0;return Math.abs(e-i)/i>=t.changeThreshold}))).subscribe(this.rttAdjustedThroughput$))}},ju={configName:["core"],throughputEstimator:{type:"EmaAndMa",emaAlphaSlow:.2,emaAlphaFast:.7,emaAlpha:.45,basisTrendChangeCount:10,changeThreshold:.05,useBrowserEstimation:!0,rttPenaltyRequestSize:1048576,streamMinSampleSize:10240,streamMinSampleTime:300,deviationDepth:20,deviationFactor:.5,lowLatency:{continuesByteSequenceInterval:50,maxLastEvaluationTimeout:300}},autoTrackSelection:{maxBitrateFactorAtEmptyBuffer:4,bitrateFactorAtEmptyBuffer:2.8,minBitrateFactorAtEmptyBuffer:1.5,bitrateAudioFactorAtEmptyBuffer:10,maxBitrateFactorAtFullBuffer:3,bitrateFactorAtFullBuffer:2,minBitrateFactorAtFullBuffer:1,bitrateAudioFactorAtFullBuffer:7,minVideoAudioRatio:5,minAvailableThroughputAudioRatio:5,usePixelRatio:!0,pixelRatioMultiplier:void 0,pixelRatioLogBase:3,pixelRatioLogCoefficients:[1,0,1],limitByContainer:!0,maxContainerSizeFactor:2,containerSizeFactor:1.3,minContainerSizeFactor:1,lazyQualitySwitch:!0,minBufferToSwitchUp:.4,considerPlaybackRate:!1,trackCooldownIncreaseQuality:15e3,trackCooldownDecreaseQuality:3e3,backgroundVideoQualityLimit:u.Xb.Q_4320P,activeVideoAreaThreshold:.1,highQualityLimit:u.Xb.Q_720P,trafficSavingLimit:u.Xb.Q_480P},stallsManager:{enabled:!1,ignoreDynamicAbrForShortVideo:!1,stallDurationNoDataBeforeQualityDecrease:500,stallDurationToBeCount:100,stallCountBeforeQualityDecrease:3,resetQualityRestrictionTimeout:1e4,ignoreStallsOnSeek:!0,stallsMetricsHistoryLength:20,maxPossibleStallDuration:3e4,minTvtToBeCounted:120,maxTvtToBeCounted:10800,significantTvt:600,targetStallsDurationPerTvt:1,deviationStallsDurationPerTvt:.5,criticalStallsDurationPerTvt:6,abrAdjustingSpeed:.1,emaAlpha:.6,useTotalStallsDurationPerTvt:!0,useAverageStallsDurationPerTvt:!0,useEmaStallsDurationPerTvt:!0},droppedFramesChecker:{enabled:!1,percentLimit:.1,checkTime:1e3,countLimit:3,tickCountAfterQualityChange:5,qualityUpWaitingTime:5e3,minQualityBanLimit:u.Xb.Q_480P},dash:{forwardBufferTarget:6e4,forwardBufferTargetAuto:6e4,forwardBufferTargetManual:3e5,forwardBufferTargetPreload:5e3,seekBiasInTheEnd:2e3,maxSegmentDurationLeftToSelectNextSegment:3e3,minSafeBufferThreshold:.5,bufferPruningSafeZone:1e3,segmentRequestSize:1048576,maxVirtualBufferSize:262144e3,virtualBufferPruneSize:104857600,representationSwitchForwardBufferGap:15e3,crashOnStallTimeout:25e3,crashOnStallTWithoutDataTimeout:5e3,enableSubSegmentBufferFeeding:!0,bufferEmptinessTolerance:100,useNewRepresentationSwitch:!1,useDelayedRepresentationSwitch:!1,useSmartRepresentationSwitch:!1,useFetchPriorityHints:!0,useAbortMSEFix:!1,enableBaseUrlSupport:!0,maxSegmentRetryCount:5,sourceOpenTimeout:1e3,vktvAbrThrottle:0,timeupdateEventTickThrottle:300,fetcherBufferOptimisation:!0,codecsPrioritizeEnabled:!1,usePersistentGaps:!1,abrThrottle:0,useVideoElementWaitingCurrentTimeReassign:!0,stallWatchdogInterval:100,liveUpdateInterval:1e3,liveStallReinitInterval:3e3,ignoreNetworkErrorsOnLoadInit:!1,bufferTolerance:100,actionTimeShiftFromSegment:500},dashCmafLive:{externalStopControl:!1,keepSilentStallWatchdogWhenNotActive:!1,maxActiveLiveOffset:1e4,normalizedTargetMinBufferSize:6e4,normalizedLiveMinBufferSize:5e3,normalizedActualBufferOffset:1e4,offsetCalculationError:3e3,maxLiveDuration:7200,catchupLiveForMutedInactiveTab:!0,lowLatency:{maxTargetOffset:3e3,maxTargetOffsetDeviation:250,playbackCatchupSpeedup:.05,isActiveOnDefault:!1,bufferEstimator:{emaAlpha:.45,changeThreshold:.05,deviationDepth:20,deviationFactor:.5,extremumInterval:5}}},live:{minBuffer:3e3,minBufferSegments:3,lowLatencyMinBuffer:1e3,lowLatencyMinBufferSegments:1,isLiveCatchUpMode:!1,lowLatencyActiveLiveDelay:3e3,activeLiveDelay:5e3,maxPausedTime:5e3},downloadBackoff:{bufferThreshold:100,start:100,factor:2,max:3e3,random:.1},enableWakeLock:!0,enableTelemetryAtStart:!1,forceFormat:void 0,formatsToAvoid:[],disableChromecast:!1,chromecastReceiverId:"07A4434E",chromecastPresentationApi:!1,useWebmBigRequest:!1,webmCodec:"vp9",androidPreferredFormat:"dash",iosPreferredFormat:"hls",preferCMAF:!1,preferWebRTC:!1,preferMultiStream:!1,preferHDR:!1,bigRequestMinInitSize:51200,bigRequestMinDataSize:1048576,stripRangeHeader:!0,flushShortLoopedBuffers:!0,insufficientBufferRuleMargin:1e4,seekNearDurationBias:1,dashSeekInSegmentDurationThreshold:18e4,dashSeekInSegmentAlwaysSeekDelta:1e4,endGapTolerance:300,stallIgnoreThreshold:33,gapWatchdogInterval:50,requestQuick:!1,useHlsJs:!1,useNativeHLSTextTracks:!1,useNewSwitchTo:!1,useNewDashProvider:!1,useDashProviderVirtual:!1,useDashProviderVirtualMobile:!1,useNewAutoSelectVideoTrack:!1,useSafariEndlessRequestBugfix:!0,isAudioDisabled:!1,autoplayOnlyInActiveTab:!0,dynamicImportTimeout:5e3,maxPlaybackTransitionInterval:2e4,providerErrorLimit:3,manifestRetryInterval:300,manifestRetryMaxInterval:1e4,manifestRetryMaxCount:10,audioVideoSyncRate:20,webrtc:{connectionRetryMaxNumber:3},spherical:{enabled:!1,fov:{x:135,y:76},rotationSpeed:45,maxYawAngle:175,rotationSpeedCorrection:10,degreeToPixelCorrection:5,speedFadeTime:2e3,speedFadeThreshold:50},useVolumeMultiplier:!1,ignoreAudioRendererError:!1,useEnableSubtitlesParam:!1,useHlsLiveNewTextManager:!1,exposeInternalsToGlobal:!1,hlsLiveNewTextManagerDownloadThreshold:4e3,disableYandexPiP:!1,asyncResolveClientChecker:!1,autostartOnlyIfVisible:!1,changePlaybackStateToPausedWhenEnded:!1,suppressExceptionsInObservables:!0,devNullLogEnabled:!1,collectingDecodingInfoEnabled:!1,sendDashLiveDebug:!1,logDashLiveDebug:!1},qu=({seekState:e,position$:t})=>(0,u.h1)(e.stateChangeEnded$.pipe((0,u.Tj)((({to:e})=>"none"===e.state?void 0:(e.position??NaN)/1e3)),(0,u.pb)(u.R)),t.pipe((0,u.pb)((()=>"none"===e.getState().state)))),zu=g(Fe(),1),Hu=async e=>{if(!e)return Promise.resolve({supported:!1});let t={["channels"in e?"audio":"video"]:e};return await navigator.mediaCapabilities.decodingInfo({type:"media-source",...t})},Wu=e=>{if(!e)return Promise.resolve({supported:!1});let t="channels"in e?document.createElement("audio"):document.createElement("video");return Promise.resolve({supported:"probably"===t.canPlayType(e?.contentType??"")})},Qu={H264:{contentType:'video/mp4; codecs="avc1.4D400C"',width:720,height:720,bitrate:2886,framerate:30},H265:{contentType:'video/mp4; codecs="hvc1.1.6.L123.B0"',width:720,height:720,bitrate:2886,framerate:30},VP8:{contentType:'video/webm; codecs="vp8"',width:720,height:720,bitrate:2886,framerate:30},VP9:{contentType:'video/webm; codecs="vp09.00.10.08"',width:720,height:720,bitrate:2886,framerate:30},AV1:{contentType:'video/mp4; codecs="av01.0.01M.08"',width:720,height:720,bitrate:2886,framerate:30},OPUS:{contentType:'audio/ogg; codecs="opus"',channels:"2",bitrate:128e3},AAC_LC:{contentType:'audio/mp4; codecs="mp4a.40.2"',channels:"2",bitrate:128e3},AC3:{contentType:'audio/mp4; codecs="ac-3"',channels:"6",bitrate:128e3},EAC3:{contentType:'audio/mp4; codecs="ec-3"',channels:"6",bitrate:128e3},AAC_HE_V1:{contentType:'audio/mp4; codecs="mp4a.40.5"',channels:"2",bitrate:128e3},AAC_HE_V2:{contentType:'audio/mp4; codecs="mp4a.40.29"',channels:"2",bitrate:128e3},AAC_xHE:{contentType:'audio/mp4; codecs="mp4a.40.42"',channels:"2",bitrate:128e3}},Xu=class{initVideo(e){this.config=e,this.internalsExposure?.expose({config:e,logger:this.logger,tuning:this.tuning}),this.setMuted(this.tuning.isAudioDisabled);let t=()=>{let{container:t,...i}=e;this.tracer.log("initVideo",(0,u.YO)(i)),this.domContainer=(e=>{let t="string"==typeof e.container?document.getElementById(e.container):e.container;return(0,u.tZ)(t,`Wrong container or containerId {${e.container}}`),t})(e),this.chromecastInitializer.contentId=e.meta?.videoId,this.providerContainer=new Du({sources:e.sources,meta:e.meta??{},failoverHosts:e.failoverHosts??[],container:this.domContainer,desiredState:this.desiredState,dependencies:{throughputEstimator:this.throughputEstimator,chromecastInitializer:this.chromecastInitializer,tracer:this.tracer,logger:this.logger,abrLogger:this.abrLogger},tuning:this.tuning,volumeMultiplier:e.volumeMultiplier,panelSize:e.panelSize}),this.initProviderContainerSubscription(this.providerContainer),this.initStartingVideoTrack(this.providerContainer),this.initTracerSubscription(),this.providerContainer.init(),this.setLiveLowLatency(this.tuning.dashCmafLive.lowLatency.isActiveOnDefault),this.initDebugTelemetry(),this.initWakeLock(),this.playerInited.next(!0),this.devNullLog&&this.tuning.devNullLogEnabled?(u.dm.subscribe("core",this.devNullLog),this.tuning.collectingDecodingInfoEnabled&&(this.collectDecodingInfoDestroyCb=(()=>{let e="mediaCapabilities"in navigator?Hu:Wu,t=gn((async()=>{let t=await Promise.all((0,zu.default)(Qu).map((async([t,i])=>({codec:t,supported:await e(i)})))),i=[ks.browser.current,...t.map((e=>JSON.stringify(e)))].slice(0,16);return u.dm.push("core",{key:"videoplayer_decoding_info",strings:i}),t}));return()=>bn(t)})())):u.dm.destroy("core")},i=()=>{this.tuning.autostartOnlyIfVisible&&window.requestAnimationFrame?this.playerInitRequest=window.requestAnimationFrame((()=>t())):t()},s=()=>{this.tuning.asyncResolveClientChecker?ks.isInited$.pipe((0,u.pb)((e=>!!e)),(0,u.Oo)()).subscribe((()=>{console.log("Core SDK async start"),i()})):i()};return this.isNotActiveTabCase()?(this.tracer.log("request play from hidden tab"),(0,u.Rt)(document,"visibilitychange").pipe((0,u.Oo)()).subscribe(s)):s(),this}destroy(){this.tracer.log("destroy"),window.clearTimeout(this.hasLiveOffsetByPausedTimer),this.playerInitRequest&&window.cancelAnimationFrame(this.playerInitRequest),this.events.willDestruct$.next(),this.stop(),this.providerContainer?.destroy(),this.throughputEstimator.destroy(),this.chromecastInitializer.destroy(),this.subscription.unsubscribe(),this.tracer.end(),this.internalsExposure?.destroy(),u.dm.destroy("core"),this.collectDecodingInfoDestroyCb?.()}waitInit(e){this.playerInited.getValue()?e():this.subscription.add(this.playerInited.pipe((0,u.pb)((e=>!!e)),(0,u.Oo)()).subscribe(e))}prepare(){return this.waitInit((()=>{let e=this.desiredState.playbackState;this.tracer.log("prepare",{currentPlayBackState:e.getState()}),"stopped"===e.getState()&&e.startTransitionTo("ready")})),this}play(){return this.waitInit((()=>{let e=this.desiredState.playbackState;this.tracer.log("play",{currentPlayBackState:e.getState()}),"playing"!==e.getState()&&e.startTransitionTo("playing")})),this}pause(){return this.waitInit((()=>{let e=this.desiredState.playbackState;this.tracer.log("pause",{currentPlayBackState:e.getState()}),"paused"!==e.getState()&&e.startTransitionTo("paused")})),this}stop(){return this.waitInit((()=>{let e=this.desiredState.playbackState;this.tracer.log("stop",{currentPlayBackState:e.getState()}),"stopped"!==e.getState()&&e.startTransitionTo("stopped")})),this}seekTime(e,t=!0){return this.waitInit((()=>{let i=this.info.duration$.getValue(),s=this.info.isLive$.getValue(),r=e;e>=i&&!s&&(r=i-this.tuning.seekNearDurationBias),this.tracer.log("seekTime",{duration:i,isLive:s,time:e,calculatedTime:r,forcePrecise:t}),Number.isFinite(r)&&(this.events.willSeek$.next({from:this.getExactTime(),to:r}),this.desiredState.seekState.setState({state:"requested",position:1e3*r,forcePrecise:t}))})),this}seekPercent(e){return this.waitInit((()=>{let t=this.info.duration$.getValue();this.tracer.log("seekPercent",{percent:e,duration:t}),isFinite(t)&&this.seekTime(Math.abs(t)*e,!1)})),this}setVolume(e,t){return this.waitInit((()=>{let i=this.desiredState.volume,s=i.getTransition()?.to.muted??this.info.muted$.getValue(),r=t??(this.tuning.isAudioDisabled||s);this.tracer.log("setVolume",{volume:e,isAudioDisabled:this.tuning.isAudioDisabled,chromecastState:this.chromecastInitializer.castState$.getValue(),muted:r}),"CONNECTED"!==this.chromecastInitializer.castState$.getValue()||this.chromecastInitializer instanceof Ms?i.startTransitionTo({volume:e,muted:r}):this.chromecastInitializer.setVolume(e)})),this}setMuted(e,t=!1){return this.waitInit((()=>{let i=this.desiredState.volume,s=this.tuning.isAudioDisabled&&!t||e,r=i.getTransition()?.to.volume??this.info.volume$.getValue();this.tracer.log("setMuted",{isMuted:e,nextMuted:s,volume:r,isAudioDisabled:this.tuning.isAudioDisabled,chromecastState:this.chromecastInitializer.castState$.getValue()}),"CONNECTED"!==this.chromecastInitializer.castState$.getValue()||this.chromecastInitializer instanceof Ms?i.startTransitionTo({volume:r,muted:s}):this.chromecastInitializer.setMuted(s)})),this}setVideoStream(e){return this.waitInit((()=>{this.desiredState.videoStream.startTransitionTo(e)})),this}setAudioStream(e){return this.waitInit((()=>{this.desiredState.audioStream.startTransitionTo(e)})),this}setQuality(e){return this.waitInit((()=>{(0,u.tZ)(this.providerContainer);let t=this.providerContainer.providerOutput.availableVideoTracks$.getValue();this.tracer.log("setQuality",{isDelayed:0===t.length,quality:e}),void 0===this.desiredState.videoTrack.getState()&&void 0===this.desiredState.videoTrack.getPrevState()&&0===t.length?this.wasSetStartedQuality?this.providerContainer.providerOutput.availableVideoTracks$.pipe((0,u.pb)((e=>e.length>0)),(0,u.Oo)()).subscribe((t=>{this.setVideoTrackIdByQuality(t,e)})):this.explicitInitialQuality=e:t.length>0&&this.setVideoTrackIdByQuality(t,e)})),this}setAutoQuality(e){return this.waitInit((()=>{this.tracer.log("setAutoQuality",{enable:e}),this.desiredState.autoVideoTrackSwitching.startTransitionTo(e)})),this}setAutoQualityLimits(e){return this.waitInit((()=>{this.tracer.log("setAutoQualityLimits",(0,u.YO)(e)),this.desiredState.autoVideoTrackLimits.startTransitionTo(e)})),this}setPredefinedQualityLimits(e){return this.waitInit((()=>{if(this.info.predefinedQualityLimitType$.getValue()===e)return this;let t,{highQualityLimit:i,trafficSavingLimit:s}=this.tuning.autoTrackSelection;switch(e){case"high_quality":t={min:i,max:void 0};break;case"traffic_saving":t={max:s,min:void 0};break;default:t={max:void 0,min:void 0}}this.setAutoQualityLimits(t)})),this}setPlaybackRate(e){return this.waitInit((()=>{this.tracer.log("setPlaybackRate",{playbackRate:e}),this.desiredState.playbackRate.startTransitionTo(e)})),this}setExternalTextTracks(e){return this.waitInit((()=>{e.length&&this.tracer.log("setExternalTextTracks",(0,u.YO)(e)),this.desiredState.externalTextTracks.startTransitionTo(e.map((e=>({type:"external",...e}))))})),this}selectTextTrack(e){return this.waitInit((()=>{((e,t,i,s)=>{void 0!==e&&void 0===t.getState()&&void 0===t.getPrevState()&&0===i?.getValue().length?i.pipe((0,u.pb)((e=>e.length>0)),(0,u.Oo)()).subscribe((i=>{i.find(s)&&t.startTransitionTo(e)})):(void 0===e||i?.getValue().find(s))&&t.startTransitionTo(e)})(e,this.desiredState.currentTextTrack,this.providerContainer?.providerOutput.availableTextTracks$,(t=>t.id===e)),this.tracer.log("selectTextTrack",{textTrackId:e})})),this}setTextTrackCueSettings(e){return this.waitInit((()=>{this.tracer.log("setTextTrackCueSettings",{...e}),this.desiredState.textTrackCuesSettings.startTransitionTo(e)})),this}setLiveLowLatency(e){let t=this.info.isLive$.getValue(),i=this.desiredState.isLowLatency.getState();return t&&i!==e?(this.tracer.log("live switch to low latency "+e),this.desiredState.isLowLatency.setState(e),this.seekTime(0)):this}setLooped(e){return this.waitInit((()=>{this.tracer.log("setLooped",{isLooped:e}),this.desiredState.isLooped.startTransitionTo(e)})),this}toggleChromecast(){this.tracer.log("toggleChromecast"),this.chromecastInitializer.toggleConnection()}startCameraManualRotation(e,t){return this.waitInit((()=>{let i=this.getScene3D();this.tracer.log("startCameraManualRotation",{isScene3DAvailable:!!i,mx:e,my:t}),i&&i.startCameraManualRotation(e,t)})),this}stopCameraManualRotation(e=!1){return this.waitInit((()=>{let t=this.getScene3D();this.tracer.log("stopCameraManualRotation",{isScene3DAvailable:!!t,immediate:e}),t&&t.stopCameraManualRotation(e)})),this}moveCameraFocusPX(e,t){return this.waitInit((()=>{let i=this.getScene3D();if(this.tracer.log("moveCameraFocusPX",{isScene3DAvailable:!!i,dxpx:e,dypx:t}),i){let s=i.getCameraRotation(),r=i.pixelToDegree({x:e,y:t});this.desiredState.cameraOrientation.setState({x:s.x+r.x,y:s.y+r.y})}})),this}holdCamera(){return this.waitInit((()=>{let e=this.getScene3D();e&&e.holdCamera()})),this}releaseCamera(){return this.waitInit((()=>{let e=this.getScene3D();e&&e.releaseCamera()})),this}getExactTime(){if(!this.providerContainer)return 0;let e=this.providerContainer.providerOutput.element$.getValue();if((0,u.wD)(e))return this.info.position$.getValue();let t=this.desiredState.seekState.getState(),i="none"===t.state?void 0:t.position;return(0,u.R)(i)?i/1e3:e.currentTime}getAllLogs(){return this.logger.getAllLogs()}getScene3D(){let e=this.providerContainer?.current$.getValue();if(e?.provider?.scene3D)return e.provider.scene3D}setIntrinsicVideoSize(...e){let t={width:e.reduce(((e,{width:t})=>e||t||0),0),height:e.reduce(((e,{height:t})=>e||t||0),0)};t.width&&t.height&&this.info.intrinsicVideoSize$.next({width:t.width,height:t.height})}initDesiredStateSubscriptions(){this.subscription.add((0,u.h1)(this.desiredState.playbackState.stateChangeStarted$,this.desiredState.playbackState.forceChanged$).pipe((0,u.Tj)((e=>e.to))).subscribe(this.info.playbackState$)).add(this.desiredState.isLooped.stateChangeEnded$.pipe((0,u.Tj)((e=>e.to))).subscribe(this.info.isLooped$)).add(this.desiredState.playbackRate.stateChangeEnded$.pipe((0,u.Tj)((e=>e.to))).subscribe(this.info.currentPlaybackRate$)).add(this.desiredState.autoVideoTrackSwitching.stateChangeEnded$.pipe((0,u.Tj)((e=>e.to))).subscribe(this.info.isAutoQualityEnabled$)).add(this.desiredState.autoVideoTrackLimits.stateChangeEnded$.pipe((0,u.Tj)((e=>e.to))).subscribe((e=>{this.info.autoQualityLimits$.next(e);let{highQualityLimit:t,trafficSavingLimit:i}=this.tuning.autoTrackSelection;this.info.predefinedQualityLimitType$.next(function(e,t,i){return e.max||e.min!==t?e.min||e.max!==i?"unknown":"traffic_saving":"high_quality"}(e,t,i))}))),this.subscription.add(this.desiredState.playbackState.stateChangeStarted$.pipe((0,u.pb)((({from:e})=>"stopped"===e)),(0,u.Oo)()).subscribe((()=>{this.initedAt=(0,u.tB)(),this.events.inited$.next()}))).add(this.desiredState.playbackState.stateChangeEnded$.subscribe((e=>{switch(e.to){case"ready":this.events.ready$.next();break;case"playing":this.isPlaybackStarted||this.events.started$.next(),this.isPlaybackStarted=!0,this.events.playing$.next();break;case"paused":this.events.paused$.next();break;case"stopped":this.events.stopped$.next()}}))).add(this.desiredState.playbackState.stateChangeStarted$.subscribe((e=>{switch(e.to){case"ready":this.events.willReady$.next();break;case"paused":this.events.willPause$.next();break;case"playing":this.isPlaybackStarted?this.events.willResume$.next():this.events.willStart$.next();break;case"stopped":this.events.willStop$.next()}})))}initProviderContainerSubscription(e){this.subscription.add(e.providerOutput.willSeekEvent$.subscribe((()=>{let e=this.desiredState.seekState.getState();this.tracer.log("willSeekEvent",(0,u.YO)(e)),"requested"===e.state?this.desiredState.seekState.setState({...e,state:"applying"}):this.events.managedError$.next({id:`WillSeekIn${e.state}`,category:u.h.WTF,message:"Received unexpeceted willSeek$"})}))).add(e.providerOutput.soundProhibitedEvent$.pipe((0,u.Oo)()).subscribe(this.events.autoplaySoundProhibited$)).add(e.providerOutput.severeStallOccurred$.subscribe(this.events.severeStallOccured$)).add(e.providerOutput.seekedEvent$.subscribe((()=>{let e=this.desiredState.seekState.getState();this.tracer.log("seekedEvent",(0,u.YO)(e)),"applying"===e.state&&(this.desiredState.seekState.setState({state:"none"}),this.events.seeked$.next())}))).add(e.current$.pipe((0,u.Tj)((e=>e.type))).subscribe(this.info.currentFormat$)).add(e.current$.pipe((0,u.Tj)((e=>e.destination)),(0,u.jX)()).subscribe((()=>this.isPlaybackStarted=!1))).add(e.providerOutput.availableVideoStreams$.subscribe(this.info.availableVideoStreams$)).add((0,u.kg)({availableVideoTracks:e.providerOutput.availableVideoTracks$,currentVideoStream:e.providerOutput.currentVideoStream$}).pipe((0,u.Tj)((({availableVideoTracks:e,currentVideoStream:t})=>e.filter((e=>!t||t.id===e.streamId)).map((({quality:e})=>e)).sort(((e,t)=>(0,u.C4)(e)?1:(0,u.C4)(t)?-1:(0,u.kW)(t,e)?1:-1))))).subscribe(this.info.availableQualities$)).add(e.providerOutput.availableVideoTracks$.subscribe((e=>{let t={};for(let i of e)i.fps&&(t[i.quality]=i.fps);this.info.availableQualitiesFps$.next(t)}))).add(e.providerOutput.availableAudioStreams$.subscribe(this.info.availableAudioStreams$)).add(e.providerOutput.currentVideoStream$.subscribe(this.info.currentVideoStream$)).add(e.providerOutput.currentAudioStream$.subscribe(this.info.currentAudioStream$)).add(e.providerOutput.availableAudioTracks$.subscribe(this.info.availableAudioTracks$)).add(e.providerOutput.isAudioAvailable$.pipe((0,u.jX)()).subscribe(this.info.isAudioAvailable$)).add(e.providerOutput.currentVideoTrack$.pipe((0,u.pb)((e=>(0,u.R)(e)))).subscribe((e=>{this.info.currentQuality$.next(e?.quality),this.info.videoBitrate$.next(e?.bitrate)}))).add(e.providerOutput.currentVideoSegmentLength$.pipe((0,u.jX)(((e,t)=>Math.round(e)===Math.round(t)))).subscribe(this.info.currentVideoSegmentLength$)).add(e.providerOutput.currentAudioSegmentLength$.pipe((0,u.jX)(((e,t)=>Math.round(e)===Math.round(t)))).subscribe(this.info.currentAudioSegmentLength$)).add(e.providerOutput.hostname$.pipe((0,u.jX)()).subscribe(this.info.hostname$)).add(e.providerOutput.httpConnectionType$.pipe((0,u.jX)()).subscribe(this.info.httpConnectionType$)).add(e.providerOutput.httpConnectionReused$.pipe((0,u.jX)()).subscribe(this.info.httpConnectionReused$)).add(e.providerOutput.currentTextTrack$.subscribe(this.info.currentTextTrack$)).add(e.providerOutput.availableTextTracks$.subscribe(this.info.availableTextTracks$)).add(e.providerOutput.autoVideoTrackLimitingAvailable$.subscribe(this.info.autoQualityLimitingAvailable$)).add(e.providerOutput.autoVideoTrackLimits$.subscribe((e=>{this.desiredState.autoVideoTrackLimits.setState(e??{})}))).add(e.providerOutput.currentBuffer$.pipe((0,u.Tj)((e=>e?{start:e.from,end:e.to}:{start:0,end:0}))).subscribe(this.info.currentBuffer$)).add(e.providerOutput.currentNativeBuffer$.pipe((0,u.Tj)((e=>e?{start:e.from,end:e.to}:{start:0,end:0}))).subscribe(this.info.currentNativeBuffer$)).add(e.providerOutput.duration$.subscribe(this.info.duration$)).add(e.providerOutput.isBuffering$.subscribe(this.info.isBuffering$)).add(e.providerOutput.isLive$.subscribe(this.info.isLive$)).add(e.providerOutput.isLiveEnded$.pipe((0,u.Mi)((e=>e&&this.stop()))).subscribe(this.info.isLiveEnded$)).add(e.providerOutput.canPlayLiveTailBuffer$.subscribe(this.info.canPlayLiveTailBuffer$)).add(e.providerOutput.canChangePlaybackSpeed$.subscribe(this.info.canChangePlaybackSpeed$)).add(e.providerOutput.liveTime$.subscribe(this.info.liveTime$)).add(e.providerOutput.liveBufferTime$.subscribe(this.info.liveBufferTime$)).add(e.providerOutput.liveLatency$.subscribe(this.info.liveLatency$)).add((0,u.kg)({hasLiveOffsetByPaused:(0,u.h1)(this.desiredState.playbackState.stateChangeStarted$,this.desiredState.playbackState.forceChanged$).pipe((0,u.Tj)((e=>e.to)),(0,u.jX)(),(0,u.Tj)((e=>"paused"===e))),isLowLatency:e.providerOutput.isLowLatency$}).subscribe((({hasLiveOffsetByPaused:e,isLowLatency:t})=>{window.clearTimeout(this.hasLiveOffsetByPausedTimer),e?this.hasLiveOffsetByPausedTimer=window.setTimeout((()=>{this.hasLiveOffsetByPaused.next(!0)}),this.getActiveLiveDelay(t)):this.hasLiveOffsetByPaused.next(!1)}))).add((0,u.kg)({atLiveEdge:(0,u.kg)({isLive:e.providerOutput.isLive$,isLowLatency:e.providerOutput.isLowLatency$,position:qu({seekState:this.desiredState.seekState,position$:e.providerOutput.position$})}).pipe((0,u.Tj)((({isLive:e,position:t,isLowLatency:i})=>{let s=this.getActiveLiveDelay(i);return e&&Math.abs(t)<s/1e3})),(0,u.jX)(),(0,u.Mi)((e=>e&&this.setPlaybackRate(1)))),hasPausedTimeoutCase:this.hasLiveOffsetByPaused}).pipe((0,u.Tj)((({atLiveEdge:e,hasPausedTimeoutCase:t})=>e&&!t))).subscribe(this.info.atLiveEdge$)).add((0,u.kg)({isLive:e.providerOutput.isLive$,position:e.providerOutput.position$,duration:e.providerOutput.duration$}).pipe((0,u.Tj)((({isLive:e,position:t,duration:i})=>e&&1e3*(Math.abs(i)-Math.abs(t))<this.tuning.live.activeLiveDelay)),(0,u.jX)(),(0,u.Mi)((e=>e&&this.setPlaybackRate(1)))).subscribe(this.info.atLiveDurationEdge$)).add(e.providerOutput.volume$.pipe((0,u.Tj)((e=>e.muted)),(0,u.jX)()).subscribe(this.info.muted$)).add(e.providerOutput.volume$.pipe((0,u.Tj)((e=>e.volume)),(0,u.jX)()).subscribe(this.info.volume$)).add(qu({seekState:this.desiredState.seekState,position$:e.providerOutput.position$}).subscribe(this.info.position$)).add(e.providerOutput.seekedEvent$.subscribe((()=>{this.info.isEnded$.getValue()&&this.tuning.changePlaybackStateToPausedWhenEnded&&this.play()}))).add((0,u.h1)(e.providerOutput.endedEvent$.pipe((0,u.uc)(!0)),e.providerOutput.seekedEvent$.pipe((0,u.uc)(!1))).pipe((0,u.jX)()).subscribe(this.info.isEnded$)).add(e.providerOutput.endedEvent$.subscribe(this.events.ended$)).add(e.providerOutput.loopedEvent$.subscribe(this.events.looped$)).add(e.providerError$.subscribe(this.events.managedError$)).add(e.providerOutput.fetcherRecoverableError$.subscribe(this.events.fetcherRecoverableError$)).add(e.providerOutput.fetcherError$.subscribe(this.events.fatalError$)).add(e.volumeMultiplierError$.subscribe(this.events.managedError$)).add(e.noAvailableProvidersError$.pipe((0,u.Tj)((e=>({id:e?`No${e}`:"NoProviders",category:u.h.VIDEO_PIPELINE,message:e?`${e} was forced but failed or not available`:"No suitable providers or all providers failed"})))).subscribe(this.events.fatalError$)).add(e.providerOutput.element$.subscribe(this.experimental.element$)).add(e.providerOutput.getCurrentTime$.subscribe(this.experimental.getCurrentTime$)).add(e.providerOutput.manifestRequested$.pipe((0,u.Oo)()).subscribe(this.events.manifestRequested$)).add(e.providerOutput.firstBytesManifest$.pipe((0,u.Oo)()).subscribe(this.events.firstBytesManifest$)).add(e.providerOutput.manifestReceived$.pipe((0,u.Oo)()).subscribe(this.events.manifestReceived$)).add(e.providerOutput.firstBytesRequested$.pipe((0,u.Oo)()).subscribe(this.events.firstBytesRequested$)).add(e.providerOutput.firstBytesReceived$.pipe((0,u.Oo)()).subscribe(this.events.firstBytesReceived$)).add(e.providerOutput.firstBytesEvent$.pipe((0,u.Oo)(),(0,u.Tj)((e=>e??(0,u.tB)()-this.initedAt))).subscribe(this.events.firstBytes$)).add(e.providerOutput.loadedMetadataEvent$.subscribe(this.events.loadedMetadata$)).add(e.providerOutput.firstFrameEvent$.pipe((0,u.Oo)(),(0,u.Tj)((()=>(0,u.tB)()-this.initedAt))).subscribe(this.events.firstFrame$)).add(e.providerOutput.canplay$.pipe((0,u.Oo)(),(0,u.Tj)((()=>(0,u.tB)()-this.initedAt))).subscribe(this.events.canplay$)).add(this.throughputEstimator.throughput$.subscribe(this.info.throughputEstimation$)).add(this.throughputEstimator.rtt$.subscribe(this.info.rttEstimation$)).add(e.providerOutput.availableSources$.subscribe(this.info.availableSources$));let t=new u.Ot(!1);this.subscription.add(e.providerOutput.seekedEvent$.subscribe((()=>t.next(!1)))).add(e.providerOutput.willSeekEvent$.subscribe((()=>t.next(!0))));let i=new u.Ot(!0);this.subscription.add(e.current$.subscribe((()=>i.next(!0)))).add(this.desiredState.playbackState.stateChangeEnded$.pipe((0,u.pb)((({to:e})=>"playing"===e)),(0,u.Oo)()).subscribe((()=>i.next(!1))));let s=0,r=(0,u.h1)(e.providerOutput.isBuffering$,t,i).pipe((0,u.Tj)((()=>{let s=e.providerOutput.isBuffering$.getValue(),r=t.getValue()||i.getValue();return s&&!r})),(0,u.jX)());this.subscription.add(r.subscribe((e=>{e?s=window.setTimeout((()=>this.info.isStalled$.next(!0)),this.tuning.stallIgnoreThreshold):(window.clearTimeout(s),this.info.isStalled$.next(!1))}))),this.subscription.add((0,u.h1)(e.providerOutput.canplay$,e.providerOutput.firstFrameEvent$,e.providerOutput.firstBytesEvent$).subscribe((()=>{let t=e.providerOutput.element$.getValue();this.setIntrinsicVideoSize({width:t?.videoWidth,height:t?.videoHeight})}))).add(e.providerOutput.currentVideoTrack$.subscribe((t=>{let i=e.providerOutput.element$.getValue();this.setIntrinsicVideoSize({width:t?.size?.width,height:t?.size?.height},{width:i?.videoWidth,height:i?.videoHeight})}))).add(e.providerOutput.is3DVideo$.subscribe(this.info.is3DVideo$)),this.subscription.add((0,u.h1)(e.providerOutput.inPiP$,e.providerOutput.inFullscreen$,e.providerOutput.element$,e.providerOutput.elementVisible$,this.chromecastInitializer.castState$).subscribe((()=>{let t,i=e.providerOutput.inPiP$.getValue(),s=e.providerOutput.inFullscreen$.getValue(),r=e.providerOutput.element$.getValue(),a=e.providerOutput.elementVisible$.getValue();t="CONNECTED"===this.chromecastInitializer.castState$.getValue()?"second_screen":r?a?i?"pip":s?"fullscreen":"inline":"invisible":"none",this.info.surface$.getValue()!==t&&this.info.surface$.next(t)})))}initChromecastSubscription(){this.subscription.add(this.chromecastInitializer.castState$.subscribe(this.info.chromecastState$)),this.subscription.add(this.chromecastInitializer.connection$.pipe((0,u.Tj)((e=>e?.castDevice.friendlyName))).subscribe(this.info.chromecastDeviceName$)),this.subscription.add(this.chromecastInitializer.errorEvent$.subscribe(this.events.managedError$))}initStartingVideoTrack(e){let t=new u.yU;this.subscription.add(t),this.subscription.add(e.current$.pipe((0,u.jX)(((e,t)=>e.provider===t.provider))).subscribe((()=>{t.unsubscribe(),t.add(e.providerOutput.availableVideoTracks$.pipe((0,u.pb)((e=>e.length>0)),(0,u.Oo)()).subscribe((e=>{this.setStartingVideoTrack(e)})))})))}setStartingVideoTrack(e){let t;this.wasSetStartedQuality=!0;let i=this.explicitInitialQuality??this.info.currentQuality$.getValue();i&&(t=e.find((({quality:e})=>e===i)),t||this.setAutoQuality(!0)),t||(t=Lr(e,{container:this.domContainer.getBoundingClientRect(),panelSize:this.config.panelSize,estimatedThroughput:this.throughputEstimator.throughput$.getValue(),tuning:this.tuning.autoTrackSelection,limits:this.desiredState.autoVideoTrackLimits.getState(),playbackRate:this.info.currentPlaybackRate$.getValue(),forwardBufferHealth:0,abrLogger:this.abrLogger})),this.desiredState.videoTrack.startTransitionTo(t),this.info.currentQuality$.next(t.quality),this.info.videoBitrate$.next(t.bitrate)}initLogs(){this.subscription.add((0,u.h1)(this.desiredState.videoTrack.stateChangeStarted$.pipe((0,u.Tj)((e=>({transition:e,entity:"quality",type:"start"})))),this.desiredState.videoTrack.stateChangeEnded$.pipe((0,u.Tj)((e=>({transition:e,entity:"quality",type:"end"})))),this.desiredState.autoVideoTrackSwitching.stateChangeStarted$.pipe((0,u.Tj)((e=>({transition:e,entity:"autoQualityEnabled",type:"start"})))),this.desiredState.autoVideoTrackSwitching.stateChangeEnded$.pipe((0,u.Tj)((e=>({transition:e,entity:"autoQualityEnabled",type:"end"})))),this.desiredState.seekState.stateChangeStarted$.pipe((0,u.Tj)((e=>({transition:e,entity:"seekState",type:"start"})))),this.desiredState.seekState.stateChangeEnded$.pipe((0,u.Tj)((e=>({transition:e,entity:"seekState",type:"end"})))),this.desiredState.playbackState.stateChangeStarted$.pipe((0,u.Tj)((e=>({transition:e,entity:"playbackState",type:"start"})))),this.desiredState.playbackState.stateChangeEnded$.pipe((0,u.Tj)((e=>({transition:e,entity:"playbackState",type:"end"}))))).pipe((0,u.Tj)((e=>({component:"desiredState",message:`[${e.entity} change] ${e.type}: ${JSON.stringify(e.transition)}`})))).subscribe(this.logger.log)),this.subscription.add(this.logger.log$.subscribe(this.events.log$))}initDebugTelemetry(){let e=this.providerContainer?.providerOutput;(0,u.tZ)(this.providerContainer),(0,u.tZ)(e),nr={},this.experimental.enableDebugTelemetry$.next(this.tuning.enableTelemetryAtStart),[this.experimental.enableDebugTelemetry$.subscribe((e=>(e=>{ar=e})(e))),this.providerContainer.current$.subscribe((({type:e})=>ur("provider",e))),e.duration$.subscribe((e=>ur("duration",e))),e.availableVideoTracks$.pipe((0,u.pb)((e=>!!e.length)),(0,u.Oo)()).subscribe((e=>ur("tracks",e))),this.events.fatalError$.subscribe(new hr("fatalError")),this.events.managedError$.subscribe(new hr("managedError")),e.position$.subscribe(new hr("position")),e.currentVideoTrack$.pipe((0,u.Tj)((e=>e?.quality))).subscribe(new hr("quality")),this.info.currentBuffer$.subscribe(new hr("buffer")),e.isBuffering$.subscribe(new hr("isBuffering"))].forEach((e=>this.subscription.add(e))),ur("codecs",ks.video.supportedCodecs)}initTracerSubscription(){let e=(0,u.kD)(this.tracer.log.bind(this.tracer)),t=(0,u.kD)(this.tracer.error.bind(this.tracer));this.subscription.add(this.info.playbackState$.subscribe(e("playbackState"))).add(this.info.isLooped$.subscribe(e("isLooped"))).add(this.info.currentPlaybackRate$.pipe((0,u.jX)()).subscribe(e("currentPlaybackRate"))).add(this.info.isAutoQualityEnabled$.subscribe(e("isAutoQualityEnabled"))).add(this.info.autoQualityLimits$.subscribe(e("autoQualityLimits"))).add(this.info.currentFormat$.subscribe(e("currentFormat"))).add(this.info.availableQualities$.subscribe(e("availableQualities"))).add(this.info.availableQualitiesFps$.subscribe(e("availableQualitiesFps"))).add(this.info.availableAudioTracks$.subscribe(e("availableAudioTracks"))).add(this.info.isAudioAvailable$.subscribe(e("isAudioAvailable"))).add((0,u.kg)({currentQuality:this.info.currentQuality$,videoBitrate:this.info.videoBitrate$}).pipe((0,u.pb)((({currentQuality:e,videoBitrate:t})=>!!e&&!!t)),(0,u.jX)(((e,t)=>e.currentQuality===t.currentQuality))).subscribe(e("currentVideoTrack"))).add(this.info.currentVideoSegmentLength$.pipe((0,u.pb)((e=>e>0)),(0,u.jX)()).subscribe(e("currentVideoSegmentLength"))).add(this.info.currentAudioSegmentLength$.pipe((0,u.pb)((e=>e>0)),(0,u.jX)()).subscribe(e("currentAudioSegmentLength"))).add(this.info.hostname$.subscribe(e("hostname"))).add(this.info.currentTextTrack$.subscribe(e("currentTextTrack"))).add(this.info.availableTextTracks$.subscribe(e("availableTextTracks"))).add(this.info.autoQualityLimitingAvailable$.subscribe(e("autoQualityLimitingAvailable"))).add((0,u.kg)({currentBuffer:this.info.currentBuffer$.pipe((0,u.pb)((e=>e.end>0)),(0,u.jX)(((e,t)=>e.end===t.end&&e.start===t.start))),position:this.info.position$.pipe((0,u.jX)())}).pipe((0,u.nF)(1e3)).subscribe(e("currentBufferAndPosition"))).add(this.info.duration$.pipe((0,u.jX)()).subscribe(e("duration"))).add(this.info.isBuffering$.subscribe(e("isBuffering"))).add(this.info.isLive$.pipe((0,u.jX)()).subscribe(e("isLive"))).add(this.info.canChangePlaybackSpeed$.pipe((0,u.jX)()).subscribe(e("canChangePlaybackSpeed"))).add((0,u.kg)({liveTime:this.info.liveTime$,liveBufferTime:this.info.liveBufferTime$,position:this.info.position$}).pipe((0,u.pb)((({liveTime:e,liveBufferTime:t})=>!!e&&!!t)),(0,u.nF)(1e3)).subscribe(e("liveBufferAndPosition"))).add(this.info.atLiveEdge$.pipe((0,u.jX)(),(0,u.pb)((e=>!0===e))).subscribe(e("atLiveEdge"))).add(this.info.atLiveDurationEdge$.pipe((0,u.jX)(),(0,u.pb)((e=>!0===e))).subscribe(e("atLiveDurationEdge"))).add(this.info.muted$.pipe((0,u.jX)()).subscribe(e("muted"))).add(this.info.volume$.pipe((0,u.jX)()).subscribe(e("volume"))).add(this.info.isEnded$.pipe((0,u.jX)(),(0,u.pb)((e=>!0===e))).subscribe(e("isEnded"))).add(this.info.availableSources$.subscribe(e("availableSources"))).add((0,u.kg)({throughputEstimation:this.info.throughputEstimation$,rtt:this.info.rttEstimation$}).pipe((0,u.pb)((({throughputEstimation:e,rtt:t})=>!!e&&!!t)),(0,u.nF)(3e3)).subscribe(e("throughputEstimation"))).add(this.info.isStalled$.subscribe(e("isStalled"))).add(this.info.is3DVideo$.pipe((0,u.jX)(),(0,u.pb)((e=>!0===e))).subscribe(e("is3DVideo"))).add(this.info.surface$.subscribe(e("surface"))).add(this.events.ended$.subscribe(e("ended"))).add(this.events.looped$.subscribe(e("looped"))).add(this.events.managedError$.subscribe(t("managedError"))).add(this.events.fatalError$.subscribe(t("fatalError"))).add(this.events.firstBytes$.subscribe(e("firstBytes"))).add(this.events.firstFrame$.subscribe(e("firstFrame"))).add(this.events.canplay$.subscribe(e("canplay")))}initWakeLock(){if(!window.navigator.wakeLock||!this.tuning.enableWakeLock)return;let e,t=()=>{e?.release(),e=void 0},i=async()=>{t(),e=await window.navigator.wakeLock.request("screen").catch((e=>{e instanceof DOMException&&"NotAllowedError"===e.name||this.events.managedError$.next({id:"WakeLock",category:u.h.DOM,message:String(e)})}))};this.subscription.add((0,u.h1)((0,u.Rt)(document,"visibilitychange"),(0,u.Rt)(document,"fullscreenchange"),this.desiredState.playbackState.stateChangeEnded$).subscribe((()=>{let s="visible"===document.visibilityState,r="playing"===this.desiredState.playbackState.getState();s&&r?!!e&&!e?.released||i():t()}))).add(this.events.willDestruct$.subscribe(t))}setVideoTrackIdByQuality(e,t){let i=e.find((e=>e.quality===t));this.tracer.log("setVideoTrackIdByQuality",(0,u.YO)({quality:t,availableTracks:(0,u.YO)(e),track:(0,u.YO)(i),isAutoQuality:!i})),i?this.desiredState.videoTrack.startTransitionTo(i):this.setAutoQuality(!0)}getActiveLiveDelay(e=!1){return e?this.tuning.live.lowLatencyActiveLiveDelay:this.tuning.live.activeLiveDelay}isNotActiveTabCase(){return document.hidden&&this.tuning.autoplayOnlyInActiveTab&&!Jr()}constructor(e={configName:[]},t=u.y1.createRootTracer(!1),i){this.subscription=new u.yU,this.logger=new u.Vy,this.abrLogger=this.logger.createComponentLog("ABR"),this.internalsExposure=null,this.isPlaybackStarted=!1,this.hasLiveOffsetByPaused=new u.Ot(!1),this.hasLiveOffsetByPausedTimer=0,this.playerInitRequest=0,this.playerInited=new u.Ot(!1),this.wasSetStartedQuality=!1,this.desiredState={playbackState:new Ps("stopped"),seekState:new Ps({state:"none"}),volume:new Ps({volume:1,muted:!1}),videoTrack:new Ps(void 0),videoStream:new Ps(void 0),audioStream:new Ps(void 0),autoVideoTrackSwitching:new Ps(!0),autoVideoTrackLimits:new Ps({}),isLooped:new Ps(!1),isLowLatency:new Ps(!1),playbackRate:new Ps(1),externalTextTracks:new Ps([]),internalTextTracks:new Ps([]),currentTextTrack:new Ps(void 0),textTrackCuesSettings:new Ps({}),cameraOrientation:new Ps({x:0,y:0})},this.info={playbackState$:new u.Ot(void 0),position$:new u.Ot(0),duration$:new u.Ot(1/0),muted$:new u.Ot(!1),volume$:new u.Ot(1),availableVideoStreams$:new u.Ot([]),currentVideoStream$:new u.Ot(void 0),availableQualities$:new u.Ot([]),availableQualitiesFps$:new u.Ot({}),currentQuality$:new u.Ot(void 0),isAutoQualityEnabled$:new u.Ot(!0),autoQualityLimitingAvailable$:new u.Ot(!1),autoQualityLimits$:new u.Ot({}),predefinedQualityLimitType$:new u.Ot("unknown"),availableAudioStreams$:new u.Ot([]),currentAudioStream$:new u.Ot(void 0),availableAudioTracks$:new u.Ot([]),isAudioAvailable$:new u.Ot(!0),currentPlaybackRate$:new u.Ot(1),currentBuffer$:new u.Ot({start:0,end:0}),currentNativeBuffer$:new u.Ot({start:0,end:0}),isBuffering$:new u.Ot(!0),isStalled$:new u.Ot(!1),isEnded$:new u.Ot(!1),isLooped$:new u.Ot(!1),isLive$:new u.Ot(void 0),isLiveEnded$:new u.Ot(null),canPlayLiveTailBuffer$:new u.Ot(!1),canChangePlaybackSpeed$:new u.Ot(void 0),atLiveEdge$:new u.Ot(void 0),atLiveDurationEdge$:new u.Ot(void 0),liveTime$:new u.Ot(void 0),liveBufferTime$:new u.Ot(void 0),liveLatency$:new u.Ot(void 0),currentFormat$:new u.Ot(void 0),availableTextTracks$:new u.Ot([]),currentTextTrack$:new u.Ot(void 0),throughputEstimation$:new u.Ot(void 0),rttEstimation$:new u.Ot(void 0),videoBitrate$:new u.Ot(void 0),hostname$:new u.Ot(void 0),httpConnectionType$:new u.Ot(void 0),httpConnectionReused$:new u.Ot(void 0),surface$:new u.Ot("none"),chromecastState$:new u.Ot("NOT_AVAILABLE"),chromecastDeviceName$:new u.Ot(void 0),intrinsicVideoSize$:new u.Ot(void 0),availableSources$:new u.Ot(void 0),is3DVideo$:new u.Ot(!1),currentVideoSegmentLength$:new u.Ot(0),currentAudioSegmentLength$:new u.Ot(0)},this.events={inited$:new u.B7,ready$:new u.B7,started$:new u.B7,playing$:new u.B7,paused$:new u.B7,stopped$:new u.B7,willReady$:new u.B7,willStart$:new u.B7,willResume$:new u.B7,willPause$:new u.B7,willStop$:new u.B7,willDestruct$:new u.B7,watchCoverageRecord$:new u.B7,watchCoverageLive$:new u.B7,managedError$:new u.B7,fatalError$:new u.B7,fetcherRecoverableError$:new u.B7,ended$:new u.B7,looped$:new u.B7,seeked$:new u.B7,willSeek$:new u.B7,autoplaySoundProhibited$:new u.B7,manifestRequested$:new u.B7,firstBytesManifest$:new u.B7,manifestReceived$:new u.B7,firstBytesRequested$:new u.B7,firstBytesReceived$:new u.B7,firstBytes$:new u.B7,loadedMetadata$:new u.B7,firstFrame$:new u.B7,canplay$:new u.B7,log$:new u.B7,fetcherError$:new u.B7,severeStallOccured$:new u.B7},this.experimental={element$:new u.Ot(void 0),tuningConfigName$:new u.Ot([]),enableDebugTelemetry$:new u.Ot(!1),dumpTelemetry:or,getCurrentTime$:new u.Ot(null)},this.initLogs(),this.tuning=(e=>({...(0,u.Xz)(e,ju),configName:[...e.configName??[],...ju.configName]}))(e),this.tracer=t,this.tuning.suppressExceptionsInObservables&&((0,Ji.default)(this.info).forEach((e=>e.setSuppressErrors(!0))),(0,Ji.default)(this.events).forEach((e=>e.setSuppressErrors(!0)))),this.experimental.tuningConfigName$.next(this.tuning.configName);let s={receiverApplicationId:this.tuning.chromecastReceiverId,isDisabled:this.tuning.disableChromecast,dependencies:{logger:this.logger}};if(this.chromecastInitializer=this.tuning.chromecastPresentationApi?new Ms(s):new es(s),this.throughputEstimator=new Uu(this.tuning.throughputEstimator),e.exposeInternalsToGlobal&&(this.internalsExposure=new u.cV("core",(0,u.j0)(i?.playerId)),this.internalsExposure.expose({player:this})),this.initChromecastSubscription(),this.initDesiredStateSubscriptions(),this.devNullLog=i?.onDevNullLog,u.dm.create("core"),Proxy&&Reflect)return new Proxy(this,{get:(e,t,i)=>{let s=Reflect.get(e,t,i);return"function"!=typeof s?s:(...i)=>{try{return s.apply(e,i)}catch(e){let s=i.map((e=>JSON.stringify(e,((e,t)=>{let i=typeof t;return(0,Ki.default)(["number","string","boolean"],i)?t:null===t?null:`<${i}>`})))),r=`Player.${String(t)}`,a=`Exception calling ${r} (${s.join(", ")})`;throw this.events.fatalError$.next({id:r,category:u.h.WTF,message:a,thrown:e}),e}}}})}},Gu=`@vkontakte/videoplayer-core@${Hi}`},319340:(e,t,i)=>{var s;i.d(t,{B7:()=>$t,BV:()=>Ss,C4:()=>ai,GW:()=>vi,Gz:()=>fi,HQ:()=>ri,Hf:()=>si,Mi:()=>Ki,Oo:()=>Ji,Ot:()=>Ri,R:()=>Lt,RW:()=>It,Rt:()=>Di,Ss:()=>Ii,Tj:()=>Gi,To:()=>pi,V6:()=>Oi,Vy:()=>xt,X5:()=>Kt,Xb:()=>Xt,Xp:()=>Yt,Xz:()=>oi,YO:()=>ci,YP:()=>Ci,ZC:()=>Mt,Zh:()=>Bt,cA:()=>$s,cP:()=>Tt,cV:()=>ks,cs:()=>Jt,dh:()=>Qt,dm:()=>Ls,eD:()=>ui,f2:()=>vt,h:()=>ns,h1:()=>Ai,iv:()=>ts,j0:()=>bi,jX:()=>Wi,kD:()=>Si,kW:()=>Zt,kg:()=>Bi,lQ:()=>yt,lZ:()=>ni,lx:()=>ii,nF:()=>Ni,pb:()=>ji,qL:()=>mi,qi:()=>li,rX:()=>Ct,ri:()=>yi,rj:()=>hi,sS:()=>Et,sg:()=>Vi,sj:()=>di,sm:()=>ei,tB:()=>At,tZ:()=>kt,tl:()=>ss,uc:()=>Yi,wD:()=>Rt,wR:()=>Mi,xb:()=>bt,xv:()=>mt,y1:()=>ki,yU:()=>gt});var r=Object.create,a=Object.defineProperty,n=Object.getOwnPropertyDescriptor,o=Object.getOwnPropertyNames,u=Object.getPrototypeOf,h=Object.prototype.hasOwnProperty,d=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),l=(e,t)=>{for(var i in t)a(e,i,{get:t[i],enumerable:!0})},c=(e,t,i)=>(i=null!=e?r(u(e)):{},((e,t,i,s)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let r of o(t))!h.call(e,r)&&r!==i&&a(e,r,{get:()=>t[r],enumerable:!(s=n(t,r))||s.enumerable});return e})(!t&&e&&e.__esModule?i:a(i,"default",{value:e,enumerable:!0}),e)),p=d(((e,t)=>{"use strict";var i=function(e){return e&&e.Math===Math&&e};t.exports=i("object"==typeof globalThis&&globalThis)||i("object"==typeof window&&window)||i("object"==typeof self&&self)||i("object"==typeof global&&global)||i("object"==typeof e&&e)||function(){return this}()||Function("return this")()})),f=d(((e,t)=>{"use strict";t.exports=function(e){try{return!!e()}catch{return!0}}})),m=d(((e,t)=>{"use strict";var i=f();t.exports=!i((function(){var e=function(){}.bind();return"function"!=typeof e||e.hasOwnProperty("prototype")}))})),g=d(((e,t)=>{"use strict";var i=m(),s=Function.prototype,r=s.apply,a=s.call;t.exports="object"==typeof Reflect&&Reflect.apply||(i?a.bind(r):function(){return a.apply(r,arguments)})})),b=d(((e,t)=>{"use strict";var i=m(),s=Function.prototype,r=s.call,a=i&&s.bind.bind(r,r);t.exports=i?a:function(e){return function(){return r.apply(e,arguments)}}})),v=d(((e,t)=>{"use strict";var i=b(),s=i({}.toString),r=i("".slice);t.exports=function(e){return r(s(e),8,-1)}})),y=d(((e,t)=>{"use strict";var i=v(),s=b();t.exports=function(e){if("Function"===i(e))return s(e)}})),S=d(((e,t)=>{"use strict";var i="object"==typeof document&&document.all;t.exports=typeof i>"u"&&void 0!==i?function(e){return"function"==typeof e||e===i}:function(e){return"function"==typeof e}})),w=d(((e,t)=>{"use strict";var i=f();t.exports=!i((function(){return 7!==Object.defineProperty({},1,{get:function(){return 7}})[1]}))})),T=d(((e,t)=>{"use strict";var i=m(),s=Function.prototype.call;t.exports=i?s.bind(s):function(){return s.apply(s,arguments)}})),$=d((e=>{"use strict";var t={}.propertyIsEnumerable,i=Object.getOwnPropertyDescriptor,s=i&&!t.call({1:2},1);e.f=s?function(e){var t=i(this,e);return!!t&&t.enumerable}:t})),x=d(((e,t)=>{"use strict";t.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}})),k=d(((e,t)=>{"use strict";var i=b(),s=f(),r=v(),a=Object,n=i("".split);t.exports=s((function(){return!a("z").propertyIsEnumerable(0)}))?function(e){return"String"===r(e)?n(e,""):a(e)}:a})),L=d(((e,t)=>{"use strict";t.exports=function(e){return null==e}})),R=d(((e,t)=>{"use strict";var i=L(),s=TypeError;t.exports=function(e){if(i(e))throw new s("Can't call method on "+e);return e}})),E=d(((e,t)=>{"use strict";var i=k(),s=R();t.exports=function(e){return i(s(e))}})),B=d(((e,t)=>{"use strict";var i=S();t.exports=function(e){return"object"==typeof e?null!==e:i(e)}})),A=d(((e,t)=>{"use strict";t.exports={}})),M=d(((e,t)=>{"use strict";var i=A(),s=p(),r=S(),a=function(e){return r(e)?e:void 0};t.exports=function(e,t){return arguments.length<2?a(i[e])||a(s[e]):i[e]&&i[e][t]||s[e]&&s[e][t]}})),C=d(((e,t)=>{"use strict";var i=b();t.exports=i({}.isPrototypeOf)})),I=d(((e,t)=>{"use strict";var i=p().navigator,s=i&&i.userAgent;t.exports=s?String(s):""})),D=d(((e,t)=>{"use strict";var i,s,r=p(),a=I(),n=r.process,o=r.Deno,u=n&&n.versions||o&&o.version,h=u&&u.v8;h&&(s=(i=h.split("."))[0]>0&&i[0]<4?1:+(i[0]+i[1])),!s&&a&&((!(i=a.match(/Edge\/(\d+)/))||i[1]>=74)&&((i=a.match(/Chrome\/(\d+)/))&&(s=+i[1]))),t.exports=s})),O=d(((e,t)=>{"use strict";var i=D(),s=f(),r=p().String;t.exports=!!Object.getOwnPropertySymbols&&!s((function(){var e=Symbol("symbol detection");return!r(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&i&&i<41}))})),P=d(((e,t)=>{"use strict";var i=O();t.exports=i&&!Symbol.sham&&"symbol"==typeof Symbol.iterator})),V=d(((e,t)=>{"use strict";var i=M(),s=S(),r=C(),a=P(),n=Object;t.exports=a?function(e){return"symbol"==typeof e}:function(e){var t=i("Symbol");return s(t)&&r(t.prototype,n(e))}})),_=d(((e,t)=>{"use strict";var i=String;t.exports=function(e){try{return i(e)}catch{return"Object"}}})),F=d(((e,t)=>{"use strict";var i=S(),s=_(),r=TypeError;t.exports=function(e){if(i(e))return e;throw new r(s(e)+" is not a function")}})),N=d(((e,t)=>{"use strict";var i=F(),s=L();t.exports=function(e,t){var r=e[t];return s(r)?void 0:i(r)}})),U=d(((e,t)=>{"use strict";var i=T(),s=S(),r=B(),a=TypeError;t.exports=function(e,t){var n,o;if("string"===t&&s(n=e.toString)&&!r(o=i(n,e))||s(n=e.valueOf)&&!r(o=i(n,e))||"string"!==t&&s(n=e.toString)&&!r(o=i(n,e)))return o;throw new a("Can't convert object to primitive value")}})),j=d(((e,t)=>{"use strict";t.exports=!0})),q=d(((e,t)=>{"use strict";var i=p(),s=Object.defineProperty;t.exports=function(e,t){try{s(i,e,{value:t,configurable:!0,writable:!0})}catch{i[e]=t}return t}})),z=d(((e,t)=>{"use strict";var i=j(),s=p(),r=q(),a="__core-js_shared__",n=t.exports=s[a]||r(a,{});(n.versions||(n.versions=[])).push({version:"3.43.0",mode:i?"pure":"global",copyright:"© 2014-2025 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.43.0/LICENSE",source:"https://github.com/zloirock/core-js"})})),H=d(((e,t)=>{"use strict";var i=z();t.exports=function(e,t){return i[e]||(i[e]=t||{})}})),W=d(((e,t)=>{"use strict";var i=R(),s=Object;t.exports=function(e){return s(i(e))}})),Q=d(((e,t)=>{"use strict";var i=b(),s=W(),r=i({}.hasOwnProperty);t.exports=Object.hasOwn||function(e,t){return r(s(e),t)}})),X=d(((e,t)=>{"use strict";var i=b(),s=0,r=Math.random(),a=i(1.1.toString);t.exports=function(e){return"Symbol("+(void 0===e?"":e)+")_"+a(++s+r,36)}})),G=d(((e,t)=>{"use strict";var i=p(),s=H(),r=Q(),a=X(),n=O(),o=P(),u=i.Symbol,h=s("wks"),d=o?u.for||u:u&&u.withoutSetter||a;t.exports=function(e){return r(h,e)||(h[e]=n&&r(u,e)?u[e]:d("Symbol."+e)),h[e]}})),Z=d(((e,t)=>{"use strict";var i=T(),s=B(),r=V(),a=N(),n=U(),o=G(),u=TypeError,h=o("toPrimitive");t.exports=function(e,t){if(!s(e)||r(e))return e;var o,d=a(e,h);if(d){if(void 0===t&&(t="default"),o=i(d,e,t),!s(o)||r(o))return o;throw new u("Can't convert object to primitive value")}return void 0===t&&(t="number"),n(e,t)}})),Y=d(((e,t)=>{"use strict";var i=Z(),s=V();t.exports=function(e){var t=i(e,"string");return s(t)?t:t+""}})),J=d(((e,t)=>{"use strict";var i=p(),s=B(),r=i.document,a=s(r)&&s(r.createElement);t.exports=function(e){return a?r.createElement(e):{}}})),K=d(((e,t)=>{"use strict";var i=w(),s=f(),r=J();t.exports=!i&&!s((function(){return 7!==Object.defineProperty(r("div"),"a",{get:function(){return 7}}).a}))})),ee=d((e=>{"use strict";var t=w(),i=T(),s=$(),r=x(),a=E(),n=Y(),o=Q(),u=K(),h=Object.getOwnPropertyDescriptor;e.f=t?h:function(e,t){if(e=a(e),t=n(t),u)try{return h(e,t)}catch{}if(o(e,t))return r(!i(s.f,e,t),e[t])}})),te=d(((e,t)=>{"use strict";var i=f(),s=S(),r=/#|\.prototype\./,a=function(e,t){var r=o[n(e)];return r===h||r!==u&&(s(t)?i(t):!!t)},n=a.normalize=function(e){return String(e).replace(r,".").toLowerCase()},o=a.data={},u=a.NATIVE="N",h=a.POLYFILL="P";t.exports=a})),ie=d(((e,t)=>{"use strict";var i=y(),s=F(),r=m(),a=i(i.bind);t.exports=function(e,t){return s(e),void 0===t?e:r?a(e,t):function(){return e.apply(t,arguments)}}})),se=d(((e,t)=>{"use strict";var i=w(),s=f();t.exports=i&&s((function(){return 42!==Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype}))})),re=d(((e,t)=>{"use strict";var i=B(),s=String,r=TypeError;t.exports=function(e){if(i(e))return e;throw new r(s(e)+" is not an object")}})),ae=d((e=>{"use strict";var t=w(),i=K(),s=se(),r=re(),a=Y(),n=TypeError,o=Object.defineProperty,u=Object.getOwnPropertyDescriptor,h="enumerable",d="configurable",l="writable";e.f=t?s?function(e,t,i){if(r(e),t=a(t),r(i),"function"==typeof e&&"prototype"===t&&"value"in i&&l in i&&!i[l]){var s=u(e,t);s&&s[l]&&(e[t]=i.value,i={configurable:d in i?i[d]:s[d],enumerable:h in i?i[h]:s[h],writable:!1})}return o(e,t,i)}:o:function(e,t,s){if(r(e),t=a(t),r(s),i)try{return o(e,t,s)}catch{}if("get"in s||"set"in s)throw new n("Accessors not supported");return"value"in s&&(e[t]=s.value),e}})),ne=d(((e,t)=>{"use strict";var i=w(),s=ae(),r=x();t.exports=i?function(e,t,i){return s.f(e,t,r(1,i))}:function(e,t,i){return e[t]=i,e}})),oe=d(((e,t)=>{"use strict";var i=p(),s=g(),r=y(),a=S(),n=ee().f,o=te(),u=A(),h=ie(),d=ne(),l=Q();z();var c=function(e){var t=function(i,r,a){if(this instanceof t){switch(arguments.length){case 0:return new e;case 1:return new e(i);case 2:return new e(i,r)}return new e(i,r,a)}return s(e,this,arguments)};return t.prototype=e.prototype,t};t.exports=function(e,t){var s,p,f,m,g,b,v,y,S,w=e.target,T=e.global,$=e.stat,x=e.proto,k=T?i:$?i[w]:i[w]&&i[w].prototype,L=T?u:u[w]||d(u,w,{})[w],R=L.prototype;for(m in t)p=!(s=o(T?m:w+($?".":"#")+m,e.forced))&&k&&l(k,m),b=L[m],p&&(e.dontCallGetSet?v=(S=n(k,m))&&S.value:v=k[m]),g=p&&v?v:t[m],(s||x||typeof b!=typeof g)&&(y=e.bind&&p?h(g,i):e.wrap&&p?c(g):x&&a(g)?r(g):g,(e.sham||g&&g.sham||b&&b.sham)&&d(y,"sham",!0),d(L,m,y),x&&(l(u,f=w+"Prototype")||d(u,f,{}),d(u[f],m,g),e.real&&R&&(s||!R[m])&&d(R,m,g)))}})),ue=d(((e,t)=>{"use strict";var i=Math.ceil,s=Math.floor;t.exports=Math.trunc||function(e){var t=+e;return(t>0?s:i)(t)}})),he=d(((e,t)=>{"use strict";var i=ue();t.exports=function(e){var t=+e;return t!=t||0===t?0:i(t)}})),de=d(((e,t)=>{"use strict";var i=he(),s=Math.min;t.exports=function(e){var t=i(e);return t>0?s(t,9007199254740991):0}})),le=d(((e,t)=>{"use strict";var i=de();t.exports=function(e){return i(e.length)}})),ce=d(((e,t)=>{"use strict";t.exports=function(){}})),pe=d((()=>{"use strict";var e=oe(),t=W(),i=le(),s=he(),r=ce();e({target:"Array",proto:!0},{at:function(e){var r=t(this),a=i(r),n=s(e),o=n>=0?n:a+n;return o<0||o>=a?void 0:r[o]}}),r("at")})),fe=d(((e,t)=>{"use strict";var i=M();t.exports=i})),me=d(((e,t)=>{"use strict";pe();var i=fe();t.exports=i("Array","at")})),ge=d(((e,t)=>{"use strict";var i=me();t.exports=i})),be=d(((e,t)=>{"use strict";var i=ge();t.exports=i})),ve=d(((e,t)=>{"use strict";var i=H(),s=X(),r=i("keys");t.exports=function(e){return r[e]||(r[e]=s(e))}})),ye=d(((e,t)=>{"use strict";var i=f();t.exports=!i((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype}))})),Se=d(((e,t)=>{"use strict";var i=Q(),s=S(),r=W(),a=ve(),n=ye(),o=a("IE_PROTO"),u=Object,h=u.prototype;t.exports=n?u.getPrototypeOf:function(e){var t=r(e);if(i(t,o))return t[o];var a=t.constructor;return s(a)&&t instanceof a?a.prototype:t instanceof u?h:null}})),we=d(((e,t)=>{"use strict";var i=he(),s=Math.max,r=Math.min;t.exports=function(e,t){var a=i(e);return a<0?s(a+t,0):r(a,t)}})),Te=d(((e,t)=>{"use strict";var i=E(),s=we(),r=le(),a=function(e){return function(t,a,n){var o=i(t),u=r(o);if(0===u)return!e&&-1;var h,d=s(n,u);if(e&&a!=a){for(;u>d;)if((h=o[d++])!=h)return!0}else for(;u>d;d++)if((e||d in o)&&o[d]===a)return e||d||0;return!e&&-1}};t.exports={includes:a(!0),indexOf:a(!1)}})),$e=d(((e,t)=>{"use strict";t.exports={}})),xe=d(((e,t)=>{"use strict";var i=b(),s=Q(),r=E(),a=Te().indexOf,n=$e(),o=i([].push);t.exports=function(e,t){var i,u=r(e),h=0,d=[];for(i in u)!s(n,i)&&s(u,i)&&o(d,i);for(;t.length>h;)s(u,i=t[h++])&&(~a(d,i)||o(d,i));return d}})),ke=d(((e,t)=>{"use strict";t.exports=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"]})),Le=d(((e,t)=>{"use strict";var i=xe(),s=ke();t.exports=Object.keys||function(e){return i(e,s)}})),Re=d(((e,t)=>{"use strict";var i=w(),s=f(),r=b(),a=Se(),n=Le(),o=E(),u=r($().f),h=r([].push),d=i&&s((function(){var e=Object.create(null);return e[2]=2,!u(e,2)})),l=function(e){return function(t){for(var s,r=o(t),l=n(r),c=d&&null===a(r),p=l.length,f=0,m=[];p>f;)s=l[f++],(!i||(c?s in r:u(r,s)))&&h(m,e?[s,r[s]]:r[s]);return m}};t.exports={entries:l(!0),values:l(!1)}})),Ee=d((()=>{"use strict";var e=oe(),t=Re().entries;e({target:"Object",stat:!0},{entries:function(e){return t(e)}})})),Be=d(((e,t)=>{"use strict";Ee();var i=A();t.exports=i.Object.entries})),Ae=d(((e,t)=>{"use strict";var i=Be();t.exports=i})),Me=d(((e,t)=>{"use strict";var i=Ae();t.exports=i})),Ce=d((()=>{"use strict";var e=oe(),t=Te().includes,i=f(),s=ce();e({target:"Array",proto:!0,forced:i((function(){return!Array(1).includes()}))},{includes:function(e){return t(this,e,arguments.length>1?arguments[1]:void 0)}}),s("includes")})),Ie=d(((e,t)=>{"use strict";Ce();var i=fe();t.exports=i("Array","includes")})),De=d(((e,t)=>{"use strict";var i=Ie();t.exports=i})),Oe=d(((e,t)=>{"use strict";var i=De();t.exports=i})),Pe=d(((e,t)=>{"use strict";t.exports={}})),Ve=d(((e,t)=>{"use strict";var i=p(),s=S(),r=i.WeakMap;t.exports=s(r)&&/native code/.test(String(r))})),_e=d(((e,t)=>{"use strict";var i,s,r,a,n,o=Ve(),u=p(),h=B(),d=ne(),l=Q(),c=z(),f=ve(),m=$e(),g="Object already initialized",b=u.TypeError,v=u.WeakMap;o||c.state?((a=c.state||(c.state=new v)).get=a.get,a.has=a.has,a.set=a.set,i=function(e,t){if(a.has(e))throw new b(g);return t.facade=e,a.set(e,t),t},s=function(e){return a.get(e)||{}},r=function(e){return a.has(e)}):(m[n=f("state")]=!0,i=function(e,t){if(l(e,n))throw new b(g);return t.facade=e,d(e,n,t),t},s=function(e){return l(e,n)?e[n]:{}},r=function(e){return l(e,n)}),t.exports={set:i,get:s,has:r,enforce:function(e){return r(e)?s(e):i(e,{})},getterFor:function(e){return function(t){var i;if(!h(t)||(i=s(t)).type!==e)throw new b("Incompatible receiver, "+e+" required");return i}}}})),Fe=d(((e,t)=>{"use strict";var i=w(),s=Q(),r=Function.prototype,a=i&&Object.getOwnPropertyDescriptor,n=s(r,"name"),o=n&&"something"===function(){}.name,u=n&&(!i||i&&a(r,"name").configurable);t.exports={EXISTS:n,PROPER:o,CONFIGURABLE:u}})),Ne=d((e=>{"use strict";var t=w(),i=se(),s=ae(),r=re(),a=E(),n=Le();e.f=t&&!i?Object.defineProperties:function(e,t){r(e);for(var i,o=a(t),u=n(t),h=u.length,d=0;h>d;)s.f(e,i=u[d++],o[i]);return e}})),Ue=d(((e,t)=>{"use strict";var i=M();t.exports=i("document","documentElement")})),je=d(((e,t)=>{"use strict";var i,s=re(),r=Ne(),a=ke(),n=$e(),o=Ue(),u=J(),h=ve(),d="prototype",l="script",c=h("IE_PROTO"),p=function(){},f=function(e){return"<"+l+">"+e+"</"+l+">"},m=function(e){e.write(f("")),e.close();var t=e.parentWindow.Object;return e=null,t},g=function(){try{i=new ActiveXObject("htmlfile")}catch{}g=typeof document<"u"?document.domain&&i?m(i):function(){var e,t=u("iframe"),i="java"+l+":";return t.style.display="none",o.appendChild(t),t.src=String(i),(e=t.contentWindow.document).open(),e.write(f("document.F=Object")),e.close(),e.F}():m(i);for(var e=a.length;e--;)delete g[d][a[e]];return g()};n[c]=!0,t.exports=Object.create||function(e,t){var i;return null!==e?(p[d]=s(e),i=new p,p[d]=null,i[c]=e):i=g(),void 0===t?i:r.f(i,t)}})),qe=d(((e,t)=>{"use strict";var i=ne();t.exports=function(e,t,s,r){return r&&r.enumerable?e[t]=s:i(e,t,s),e}})),ze=d(((e,t)=>{"use strict";var i,s,r,a=f(),n=S(),o=B(),u=je(),h=Se(),d=qe(),l=G(),c=j(),p=l("iterator"),m=!1;[].keys&&("next"in(r=[].keys())?(s=h(h(r)))!==Object.prototype&&(i=s):m=!0),!o(i)||a((function(){var e={};return i[p].call(e)!==e}))?i={}:c&&(i=u(i)),n(i[p])||d(i,p,(function(){return this})),t.exports={IteratorPrototype:i,BUGGY_SAFARI_ITERATORS:m}})),He=d(((e,t)=>{"use strict";var i={};i[G()("toStringTag")]="z",t.exports="[object z]"===String(i)})),We=d(((e,t)=>{"use strict";var i=He(),s=S(),r=v(),a=G()("toStringTag"),n=Object,o="Arguments"===r(function(){return arguments}());t.exports=i?r:function(e){var t,i,u;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(i=function(e,t){try{return e[t]}catch{}}(t=n(e),a))?i:o?r(t):"Object"===(u=r(t))&&s(t.callee)?"Arguments":u}})),Qe=d(((e,t)=>{"use strict";var i=He(),s=We();t.exports=i?{}.toString:function(){return"[object "+s(this)+"]"}})),Xe=d(((e,t)=>{"use strict";var i=He(),s=ae().f,r=ne(),a=Q(),n=Qe(),o=G()("toStringTag");t.exports=function(e,t,u,h){var d=u?e:e&&e.prototype;d&&(a(d,o)||s(d,o,{configurable:!0,value:t}),h&&!i&&r(d,"toString",n))}})),Ge=d(((e,t)=>{"use strict";var i=ze().IteratorPrototype,s=je(),r=x(),a=Xe(),n=Pe(),o=function(){return this};t.exports=function(e,t,u,h){var d=t+" Iterator";return e.prototype=s(i,{next:r(+!h,u)}),a(e,d,!1,!0),n[d]=o,e}})),Ze=d(((e,t)=>{"use strict";var i=b(),s=F();t.exports=function(e,t,r){try{return i(s(Object.getOwnPropertyDescriptor(e,t)[r]))}catch{}}})),Ye=d(((e,t)=>{"use strict";var i=B();t.exports=function(e){return i(e)||null===e}})),Je=d(((e,t)=>{"use strict";var i=Ye(),s=String,r=TypeError;t.exports=function(e){if(i(e))return e;throw new r("Can't set "+s(e)+" as a prototype")}})),Ke=d(((e,t)=>{"use strict";var i=Ze(),s=B(),r=R(),a=Je();t.exports=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,n={};try{(e=i(Object.prototype,"__proto__","set"))(n,[]),t=n instanceof Array}catch{}return function(i,n){return r(i),a(n),s(i)&&(t?e(i,n):i.__proto__=n),i}}():void 0)})),et=d(((e,t)=>{"use strict";var i=oe(),s=T(),r=j(),a=Fe(),n=S(),o=Ge(),u=Se(),h=Ke(),d=Xe(),l=ne(),c=qe(),p=G(),f=Pe(),m=ze(),g=a.PROPER,b=a.CONFIGURABLE,v=m.IteratorPrototype,y=m.BUGGY_SAFARI_ITERATORS,w=p("iterator"),$="keys",x="values",k="entries",L=function(){return this};t.exports=function(e,t,a,p,m,S,T){o(a,t,p);var R,E,B,A=function(e){if(e===m&&O)return O;if(!y&&e&&e in I)return I[e];switch(e){case $:case x:case k:return function(){return new a(this,e)}}return function(){return new a(this)}},M=t+" Iterator",C=!1,I=e.prototype,D=I[w]||I["@@iterator"]||m&&I[m],O=!y&&D||A(m),P="Array"===t&&I.entries||D;if(P&&((R=u(P.call(new e)))!==Object.prototype&&R.next&&(!r&&u(R)!==v&&(h?h(R,v):n(R[w])||c(R,w,L)),d(R,M,!0,!0),r&&(f[M]=L))),g&&m===x&&D&&D.name!==x&&(!r&&b?l(I,"name",x):(C=!0,O=function(){return s(D,this)})),m)if(E={values:A(x),keys:S?O:A($),entries:A(k)},T)for(B in E)(y||C||!(B in I))&&c(I,B,E[B]);else i({target:t,proto:!0,forced:y||C},E);return(!r||T)&&I[w]!==O&&c(I,w,O,{name:m}),f[t]=O,E}})),tt=d(((e,t)=>{"use strict";t.exports=function(e,t){return{value:e,done:t}}})),it=d(((e,t)=>{"use strict";var i=E(),s=ce(),r=Pe(),a=_e(),n=ae().f,o=et(),u=tt(),h=j(),d=w(),l="Array Iterator",c=a.set,p=a.getterFor(l);t.exports=o(Array,"Array",(function(e,t){c(this,{type:l,target:i(e),index:0,kind:t})}),(function(){var e=p(this),t=e.target,i=e.index++;if(!t||i>=t.length)return e.target=null,u(void 0,!0);switch(e.kind){case"keys":return u(i,!1);case"values":return u(t[i],!1)}return u([i,t[i]],!1)}),"values");var f=r.Arguments=r.Array;if(s("keys"),s("values"),s("entries"),!h&&d&&"values"!==f.name)try{n(f,"name",{value:"values"})}catch{}})),st=d(((e,t)=>{"use strict";var i=G(),s=Pe(),r=i("iterator"),a=Array.prototype;t.exports=function(e){return void 0!==e&&(s.Array===e||a[r]===e)}})),rt=d(((e,t)=>{"use strict";var i=We(),s=N(),r=L(),a=Pe(),n=G()("iterator");t.exports=function(e){if(!r(e))return s(e,n)||s(e,"@@iterator")||a[i(e)]}})),at=d(((e,t)=>{"use strict";var i=T(),s=F(),r=re(),a=_(),n=rt(),o=TypeError;t.exports=function(e,t){var u=arguments.length<2?n(e):t;if(s(u))return r(i(u,e));throw new o(a(e)+" is not iterable")}})),nt=d(((e,t)=>{"use strict";var i=T(),s=re(),r=N();t.exports=function(e,t,a){var n,o;s(e);try{if(!(n=r(e,"return"))){if("throw"===t)throw a;return a}n=i(n,e)}catch(e){o=!0,n=e}if("throw"===t)throw a;if(o)throw n;return s(n),a}})),ot=d(((e,t)=>{"use strict";var i=ie(),s=T(),r=re(),a=_(),n=st(),o=le(),u=C(),h=at(),d=rt(),l=nt(),c=TypeError,p=function(e,t){this.stopped=e,this.result=t},f=p.prototype;t.exports=function(e,t,m){var g,b,v,y,S,w,T,$=m&&m.that,x=!(!m||!m.AS_ENTRIES),k=!(!m||!m.IS_RECORD),L=!(!m||!m.IS_ITERATOR),R=!(!m||!m.INTERRUPTED),E=i(t,$),B=function(e){return g&&l(g,"normal"),new p(!0,e)},A=function(e){return x?(r(e),R?E(e[0],e[1],B):E(e[0],e[1])):R?E(e,B):E(e)};if(k)g=e.iterator;else if(L)g=e;else{if(!(b=d(e)))throw new c(a(e)+" is not iterable");if(n(b)){for(v=0,y=o(e);y>v;v++)if((S=A(e[v]))&&u(f,S))return S;return new p(!1)}g=h(e,b)}for(w=k?e.next:g.next;!(T=s(w,g)).done;){try{S=A(T.value)}catch(e){l(g,"throw",e)}if("object"==typeof S&&S&&u(f,S))return S}return new p(!1)}})),ut=d(((e,t)=>{"use strict";var i=w(),s=ae(),r=x();t.exports=function(e,t,a){i?s.f(e,t,r(0,a)):e[t]=a}})),ht=d((()=>{"use strict";var e=oe(),t=ot(),i=ut();e({target:"Object",stat:!0},{fromEntries:function(e){var s={};return t(e,(function(e,t){i(s,e,t)}),{AS_ENTRIES:!0}),s}})})),dt=d(((e,t)=>{"use strict";it(),ht();var i=A();t.exports=i.Object.fromEntries})),lt=d(((e,t)=>{"use strict";t.exports={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0}})),ct=d((()=>{"use strict";it();var e,t=lt(),i=p(),s=Xe(),r=Pe();for(e in t)s(i[e],e),r[e]=r.Array})),pt=d(((e,t)=>{"use strict";var i=dt();ct(),t.exports=i})),ft=d(((e,t)=>{"use strict";var i=pt();t.exports=i})),mt="1.0.78",gt=class{unsubscribe(){let e=this.subscriptions;this.subscriptions=[],e.forEach((e=>{"function"==typeof e?e():e.unsubscribe()}))}add(e){return this.subscriptions.push(e),this}constructor(){this.subscriptions=[]}},bt=e=>{throw new Error(`${e} is value of unexpected type`)},vt=e=>{},yt=()=>{},St=e=>{throw console.error(e),e},wt=e=>{console.error(e)},Tt=class{setSuppressErrors(e){this.suppressErrors=e}subscribe(e,t){let i,s=this.suppressErrors?wt:St;i=t?"function"==typeof t?{next:t,error:yt}:{next:e=>t.next(e),error:e=>t.error?.(e)}:{next:s,error:yt};let r,a="function"==typeof e?{next:t=>{try{let s=e(t);s instanceof Promise&&s.catch((e=>i.next(e)))}catch(e){i.next(e)}},error:e=>i.next(e)}:{next:t=>e.next(t),error:t=>e.error?e.error(t):i.next(t)};try{r=this._subscribe(a)}catch(e){a.error?.(e)}return(new gt).add((()=>{switch(a.next=yt,a.error=yt,typeof r){case"function":return void r();case"object":return void r.unsubscribe();case"undefined":return;default:return bt(r)}}))}pipe(...e){return e.reduce(((e,t)=>t(e)),this)}_subscribe(e){}constructor(e){this.suppressErrors=!1,e&&(this._subscribe=e)}},$t=class extends Tt{next(e){this.subscribers.forEach((t=>t.next(e)))}error(e){this.subscribers.forEach((t=>t.error?.(e)))}_subscribe(e){let t=this.keyCounter++;return this.subscribers.set(t,e),(new gt).add((()=>this.subscribers.delete(t)))}constructor(){super(),this.keyCounter=0,this.subscribers=new Map}},xt=class{createCustomLog(e){return(...t)=>{let i;try{i=e(...t)}catch{i={message:"error in `createCustomLog`",component:"Logger"}}this.log(i)}}createComponentLog(e){return this.createCustomLog((t=>({component:e,...t})))}constructor(){this.log$=new $t,this.logs=[],this.log=e=>{let t={...e,timestamp:Date.now()};this.logs.push(t),this.log$.next(t)},this.getAllLogs=()=>this.logs}};function kt(e,t='Assertion "value is not nullable" failed'){if(null==e)throw new Error(t)}function Lt(e){return typeof e<"u"&&null!==e}function Rt(e){return null==e}function Et(e,t){if(!e?.length)throw new Error(t)}var Bt=(e,t,i)=>new Promise(((s,r)=>{t.addEventListener("abort",(()=>{u(),h.remove()}));let a,n=()=>{u(),r("error")},o=()=>{u(),s()},u=()=>{a&&clearTimeout(a),h.removeEventListener("load",o),h.removeEventListener("error",n)};i&&(a=window.setTimeout((()=>{u(),r("timeout")}),i));let h=document.createElement("script");h.addEventListener("load",o),h.addEventListener("error",n),h.src=e,document.head.appendChild(h)})),At="function"==typeof window.performance?.now?()=>window.performance.now():()=>Date.now(),Mt=(e,t)=>async(...i)=>{let s,r=t(...i),a=e.aborted;for(;!a&&!e.aborted;)try{let e=await r.next(s);a=e.done??!1,s=e.value}catch(e){await r.throw(e)}return s},Ct=(e,{start:t=0,factor:i=2,max:s=1/0,min:r=t,random:a=0}={})=>{let n=t;return n*=i**e,n*=Math.random()*a*2-a+1,n=Math.round(n),n=Math.min(n,s),n=Math.max(n,r),n},It={};l(It,{clear:()=>zt,get:()=>Nt,has:()=>jt,isPersistent:()=>Ft,remove:()=>qt,set:()=>Ut});var Dt,Ot,Pt,Vt=`vk-videoplayer-dummy-key-${Math.random()}`,_t=()=>{if(void 0!==Ot)return Ot;try{localStorage.setItem(Vt,"test"),localStorage.removeItem(Vt),Ot=0}catch(e){if(!(e instanceof DOMException||e instanceof TypeError))throw e;try{sessionStorage.getItem(Vt),Ot=1}catch(e){if(!(e instanceof DOMException||e instanceof TypeError))throw e;Ot=2}}return 2===Ot&&(Dt=new Map),Ot},Ft=()=>0===_t(),Nt=e=>{let t=_t();switch(t){case 0:return localStorage.getItem(e)??void 0;case 1:return sessionStorage.getItem(e)??void 0;case 2:return Dt?.get(e);default:bt(t)}},Ut=(e,t)=>{let i=_t();switch(i){case 0:try{localStorage.setItem(e,t)}catch(e){if(!(e instanceof DOMException))throw e;console.error(e)}break;case 1:try{sessionStorage.setItem(e,t)}catch(e){if(!(e instanceof DOMException))throw e;console.error(e)}break;case 2:return void Dt?.set(e,t);default:bt(i)}},jt=e=>{let t=_t();switch(t){case 0:return e in localStorage;case 1:return e in sessionStorage;case 2:return Dt?.has(e)??!1;default:return bt(t),!1}},qt=e=>{let t=_t();switch(t){case 0:return localStorage.removeItem(e);case 1:return sessionStorage.removeItem(e);case 2:return void Dt?.delete(e);default:bt(t)}},zt=()=>{let e=_t();switch(e){case 0:return localStorage.clear();case 1:return sessionStorage.clear();case 2:return Dt?.clear();default:bt(e)}},Ht=(e,t,i)=>{if("function"==typeof e.canParse)return e.canParse(t,i);try{return new e(t,i),!0}catch{return!1}},Wt=c(be(),1),Qt=()=>{let e,t=[];try{e=window.self!==window.top}catch(t){t instanceof DOMException&&"SecurityError"===t.name?e=!0:(e=!1,console.error(t))}try{window.location.ancestorOrigins&&(t=[...window.location.ancestorOrigins])}catch(e){console.error(e)}try{!t.length&&document.referrer&&(t=[new URL(document.referrer).origin])}catch(e){console.error(e)}return t=t.filter((e=>Ht(URL,e))),{isEmbed:e,origins:t,topOrigin:(0,Wt.default)(t,-1),immediateOrigin:(0,Wt.default)(t,0)}},Xt=((Pt=Xt||{}).INVARIANT="Invariant quality",Pt.Q_144P="144p",Pt.Q_240P="240p",Pt.Q_360P="360p",Pt.Q_480P="480p",Pt.Q_576P="576p",Pt.Q_720P="720p",Pt.Q_1080P="1080p",Pt.Q_1440P="1440p",Pt.Q_2160P="2160p",Pt.Q_4320P="4320p",Pt),Gt={"144p":{width:256,height:144},"240p":{width:428,height:240},"360p":{width:640,height:360},"480p":{width:856,height:480},"576p":{width:1024,height:576},"720p":{width:1280,height:720},"1080p":{width:1920,height:1080},"1440p":{width:2560,height:1440},"2160p":{width:3840,height:2160},"4320p":{width:7680,height:4320}},Zt=(e,t)=>Gt[e].height>Gt[t].height,Yt=(e,t)=>Gt[e].height>=Gt[t].height,Jt=(e,t)=>Gt[e].height<Gt[t].height,Kt=(e,t)=>Gt[e].height<=Gt[t].height,ei=e=>e.sort(((e,t)=>e===t?0:"Invariant quality"===e?1:"Invariant quality"===t?-1:Jt(e,t)?1:-1))[0],ti=Object.keys(Gt).sort(((e,t)=>Jt(e,t)?-1:1)),ii=(e,t=.02)=>[...ti].find((i=>Gt[i].height*(1+t)>=e)),si=({width:e,height:t})=>{let i=Math.min(e,t),s=Math.max(e,t);return ti.find((e=>{let t=Gt[e];return t.width>=s&&t.height>=i}))},ri=e=>Gt[e].height,ai=e=>"Invariant quality"===e;var ni=e=>{switch(e){case"4320p":return"8K";case"2160p":return"4K";case"1440p":return"QHD";case"1080p":return"FHD";case"720p":return"HD";default:return""}},oi=(e,t)=>{let i={};for(let s of Object.keys(t)){let r=t[s],a=e[s];Array.isArray(r)&&Array.isArray(a)?i[s]=a:i[s]="object"==typeof r&&"object"==typeof a?oi(a,r):s in e?a:r}return i};function ui(e,t=0,i){let s,r,a,n,o,u,h=0,d=!1,l=!1,c=!0,p=!t&&0!==t&&"function"==typeof window.requestAnimationFrame;function f(t){let i=s,a=r;return s=r=void 0,h=t,n=e.apply(a,i),n}function m(e,t){return p?(o&&window.cancelAnimationFrame(o),window.requestAnimationFrame(e)):setTimeout(e,t)}function g(e){let i=e-u;return void 0===u||i>=t||i<0||l&&e-h>=a}function b(){let e=Date.now();if(g(e))return v(e);o=m(b,function(e){let i=e-h,s=t-(e-u);return l?Math.min(s,a-i):s}(e))}function v(e){return o=void 0,c&&s?f(e):(s=r=void 0,n)}function y(...e){let i=Date.now(),a=g(i);if(s=e,r=this,u=i,a){if(void 0===o)return function(e){return h=e,o=m(b,t),d?f(e):n}(u);if(l)return o=m(b,t),f(u)}return void 0===o&&(o=m(b,t)),n}return i&&(d=!!i.leading,l="maxWait"in i,a=i?.maxWait?Math.max(+i?.maxWait||0,t):a,c="trailing"in i?!!i.trailing:c),y.cancel=function(){var e;void 0!==o&&(e=o,p?window.cancelAnimationFrame(e):clearTimeout(e)),h=0,s=u=r=o=void 0},y.flush=function(){return void 0===o?n:v(Date.now())},y.pending=function(){return void 0!==o},y}var hi=(e,t=0,i)=>ui(e,t,{leading:!0,trailing:!0,...i,maxWait:t}),di=(e,t)=>{if(null===e||"object"!=typeof e)return e;let i=Array.isArray(e)?[]:{};for(let s in e){if("function"==typeof t){let r=t(e[s],s,e,i);if(void 0!==r){i[s]=r;continue}}"object"==typeof e[s]?i[s]=di(e[s],t):i[s]=e[s]}return i},li=(e,t=300)=>new Tt((i=>{let{width:s,height:r}=e.getBoundingClientRect();if(i.next({width:s,height:r}),!window.ResizeObserver)return;let a=new ResizeObserver(hi((e=>{let t,s,r=e[0];r&&(r.contentBoxSize&&r.contentBoxSize[0]?(s=r.contentBoxSize[0].blockSize,t=r.contentBoxSize[0].inlineSize):r.contentRect&&(t=r.contentRect.width,s=r.contentRect.height),Lt(t)&&Lt(s)&&i.next({width:t,height:s}))}),t));return a.observe(e),()=>a.disconnect()})),ci=(e,t=6,i=".")=>{let s={};for(let r in e)if(e.hasOwnProperty(r)&&!(e[r]instanceof HTMLElement)&&t)if("object"==typeof e[r]&&null!==e[r]){let a=ci(e[r],t-1);for(let e in a)a.hasOwnProperty(e)&&(s[r+i+e]=a[e])}else s[r]=e[r];return s},pi=e=>{e.removeAttribute("src"),e.load()},fi=e=>{let t;try{t=new URL(e)}catch{return!1}return"https:"===t.protocol},mi=(e,t)=>!(e.right<t.left||e.left>t.right||e.bottom<t.top||e.top>t.bottom),gi=(()=>{let e=0;return()=>{let t=e;return e=(e+1)%Number.MAX_SAFE_INTEGER,t}})(),bi=e=>void 0!==e&&""!==e?e:gi().toString();function vi(e,t,i){if(e<=t[0])return i[0];if(e>=t[t.length-1])return i[i.length-1];let s=1;for(;s<t.length&&t[s]<e;)s++;s>=t.length&&(s=t.length-1);let r=t[s-1],a=t[s],n=i[s-1],o=i[s];return e===r?n:e===a?o:n+(e-r)/(a-r)*(o-n)}function yi(e,t,i){if(e<=0||i<0)return[];let s=[],r=t-Math.floor((e-1)/2),a=t+Math.floor(e/2);r<0&&(a+=Math.abs(r),r=0),a>i&&(r-=a-i,a=i),r=Math.max(0,r),a=Math.min(i,a);for(let e=r;e<=a;e++)s.push(e);return s}var Si=e=>t=>i=>{let s="object"==typeof i;null==i||s&&!Object.keys(i).length||e(t,s?ci(i):{value:i})},wi=(e={})=>{let t=e=>{let t=e;return void 0===e?t="undefined":null===e?t="null":("number"==typeof e||"boolean"==typeof e)&&(t=e.toString()),t},i={};for(let s in e)Array.isArray(e[s])?i[s]=e[s].map(t):i[s]=t(e[s]);return i},Ti=(s=class e{init({name:t,getParentContext:i},s){this.span=e.rootTracer.startSpan(t,{startTime:s},i?.()),this.context=e.dynamicImports.opentelemetryApi.trace.setSpan(e.dynamicImports.opentelemetryApi.context.active(),this.span)}async loadOpentelemetry(){if("not_started"===e.dynamicImportStatus){e.dynamicImportStatus="in_progress";try{let t=new Promise(((e,t)=>setTimeout(t,this.dynamicImportTimeout))),s=Promise.all([Promise.all([i.e(28976),i.e(32855),i.e("langs/core_spa/28976+32855")]).then(i.bind(i,132855)),Promise.all([i.e(28976),i.e(75687),i.e("langs/core_spa/28976+75687")]).then(i.bind(i,275687)),Promise.all([i.e(92105),i.e("langs/core_spa/92105")]).then(i.bind(i,392105))]),[r,a,n]=await Promise.race([s,t]);e.dynamicImports={opentelemetryApi:r,opentelemetrySdk:a,tracer:n},e.dynamicImportStatus="completed"}catch{e.dynamicImportStatus="failed"}}}isComponentTracerNotInitialized(){return Rt(this.span)||"failed"===e.dynamicImportStatus}log(e,t){let i=Date.now();this.initPromise.then((s=>{this.isComponentTracerNotInitialized()||this.span.addEvent(e,{...wi(t),type:"log"},i)}))}error(e,t){let i=Date.now();this.initPromise.then((s=>{this.isComponentTracerNotInitialized()||this.span.addEvent(e,{...wi(t),type:"error"},i)}))}critical(e,t){let i=Date.now();this.initPromise.then((s=>{this.isComponentTracerNotInitialized()||this.span.addEvent(e,{...wi(t),type:"critical"},i)}))}createComponentTracer(t){let i=new e({name:t,getParentContext:()=>this.context});return this.childTracers.push(i),i}end(){this.initPromise.then((e=>{this.isComponentTracerNotInitialized()||(this.childTracers.forEach((e=>e.end())),this.span.end())}))}constructor({name:t,getParentContext:i}){this.dynamicImportTimeout=5e3,this.childTracers=[],"not_started"===e.dynamicImportStatus&&(e.dynamicImportPromise=this.loadOpentelemetry());let s=Date.now();this.initPromise=e.dynamicImportPromise.then((r=>{"completed"===e.dynamicImportStatus&&this.init({name:t,getParentContext:i},s)}))}},s.dynamicImportStatus="not_started",s),$i=class extends Ti{init({name:e,getParentContext:t},i){let s=Ti.dynamicImports.tracer.initTracerOpenTelemetry({serviceName:"videoplayer-sdk-web",appToken:"L9SBoka6ZWk4xPjaK7tmfSfYvMhcge7nvGDjpdMmscb",spanLimits:{attributeCountLimit:1/0,eventCountLimit:1/0,attributePerEventCountLimit:1/0}}).getProvider(),r=new Ti.dynamicImports.tracer.TracerMemorySpanExporter;this.spanExporter=r,s.addSpanProcessor(new Ti.dynamicImports.tracer.TracerAllSpansProcessor({startedSpansExporter:r})),Ti.rootTracer=s.getTracer("sdk-videoplayer-tracer"),super.init({name:e,getParentContext:t},i)}getFinishedSpans(){if(!this.isComponentTracerNotInitialized())return this.spanExporter?.getJsonData()}getTraceId(){return this.isComponentTracerNotInitialized()?"":this.span.spanContext().traceId}constructor(){super({name:"Root"})}},xi=class e{log(e,t){}error(e,t){}critical(e,t){}createComponentTracer(t){return new e({name:t})}end(){}getFinishedSpans(){}getTraceId(){return this.fakeTraceId}constructor(e){}},ki=class{static createRootTracer(e=!1){return e?new $i:new xi}},Li=class extends $t{next(e){this.cursorEnd+=1,this.cursorStart=this.cursorEnd>=this.bufferSize?this.cursorStart+1:0,this.buffer[this.cursorEnd%this.bufferSize]=e,this.subscribers.forEach((t=>t.next(e)))}_subscribe(e){for(let t=this.cursorStart;t<=this.cursorEnd;t++)e.next(this.buffer[t%this.bufferSize]);let t=this.keyCounter++;return this.subscribers.set(t,e),(new gt).add((()=>this.subscribers.delete(t)))}constructor(e){super(),this.buffer=[],this.cursorEnd=-1,this.cursorStart=0,this.bufferSize=e,this.buffer=Array(e)}},Ri=class extends $t{next(e){super.next(this.value=e)}error(e){super.error(this.value=e)}getValue(){return this.value}_subscribe(e){let t=super._subscribe(e);return e.next(this.value),t}constructor(e){super(),this.value=e}},Ei=c(Me(),1);function Bi(e){return new Tt((t=>{let i={},s=Object.keys(e).length;return(0,Ei.default)(e).reduce(((e,[r,a])=>e.add(a.subscribe((e=>r=>{e in i||s--,i[e]=r,0===s&&t.next(i)})(r)))),new gt)}))}function Ai(...e){return new Tt((t=>e.reduce(((e,i)=>e.add(i.subscribe(t))),new gt)))}var Mi=e=>new Tt((t=>{let i=window.setTimeout((()=>{try{t.next()}catch(e){if(!t.error)throw e;t.error(e)}}),e);return()=>window.clearTimeout(i)})),Ci=e=>new Tt((t=>{let i=window.setInterval((()=>t.next()),e);return()=>{i&&(window.clearInterval(i),i=void 0)}})),Ii=e=>new Tt((t=>{e.forEach((e=>t.next(e)))})),Di=(e,t)=>new Tt((i=>{let s=e=>i.next(e);return e.addEventListener(t,s),()=>e.removeEventListener(t,s)})),Oi=class extends gt{remove(e){this.subscriptions=this.subscriptions.filter((t=>t!==e))}};var Pi={leading:!1,trailing:!0};function Vi(e,t=Pi){return i=>new Tt((s=>i.subscribe(new _i(s,e,t))))}var _i=class{next(e){this.lastValue=e,Lt(this.timeout)?window.clearTimeout(this.timeout):this.config.leading&&this.destination.next(e),this.timeout=window.setTimeout((()=>{if(this.config.trailing)try{this.destination.next(this.lastValue)}catch(e){if(!this.destination.error)throw e;this.destination.error(e)}this.timeout=void 0}),this.time)}error(e){this.destination.error?.(e)}constructor(e,t,i){this.destination=e,this.time=t,this.config=i}},Fi={leading:!0,trailing:!1};function Ni(e,t=Fi){return i=>new Tt((s=>i.subscribe(new Ui(s,e,t))))}var Ui=class{next(e){this.lastValue=e,Rt(this.timeout)&&(this.config.leading&&this.destination.next(e),this.timeout=window.setTimeout((()=>{this.config.trailing&&this.destination.next(this.lastValue),this.timeout=void 0}),this.time))}error(e){this.destination.error?.(e)}constructor(e,t,i){this.destination=e,this.time=t,this.config=i}};function ji(e){return t=>new Tt((i=>t.subscribe(new qi(i,e))))}var qi=class{next(e){let t;try{t=this.predicate(e)}catch(e){throw this.error(e),e}t&&this.destination.next(e)}error(e){this.destination.error?.(e)}constructor(e,t){this.destination=e,this.predicate=t}},zi=c(Oe(),1),Hi=(e,t)=>e instanceof Object&&t instanceof Object?((e,t)=>{let i=(e,t)=>{let i=Object.keys(e);for(let s in t)if(!(0,zi.default)(i,s)||t[s]!==e[s])return!1;return!0};return i(e,t)&&i(t,e)})(e,t):e===t;function Wi(e=Hi){return t=>new Tt((i=>t.subscribe(new Xi(i,e))))}var Qi={},Xi=class{next(e){let t;try{t=this.lastValue===Qi||!this.predicate(this.lastValue,e),this.lastValue=e instanceof Object&&!Array.isArray(e)?{...e}:e}catch(e){throw this.error(e),e}t&&this.destination.next(e)}error(e){this.destination.error?.(e)}constructor(e,t){this.destination=e,this.predicate=t,this.lastValue=Qi}};function Gi(e){return t=>new Tt((i=>t.subscribe(new Zi(i,e))))}var Zi=class{next(e){let t;try{t=this.mapper(e)}catch(e){throw this.error(e),e}this.destination.next(t)}error(e){this.destination.error?.(e)}constructor(e,t){this.destination=e,this.mapper=t}};function Yi(e){return Gi((()=>e))}function Ji(){return e=>new Tt((t=>{let i=!1,s=!1,r=e.subscribe((e=>{i||(i=!0,t.next(e)),s&&r.unsubscribe()}),(e=>{i=!0,t.error?.(e),s&&r.unsubscribe()}));return s=!0,i&&r.unsubscribe(),r}))}function Ki(e){return t=>new Tt((i=>t.subscribe(new es(i,e))))}var es=class{next(e){try{this.effect(e)}catch(e){throw this.error(e),e}this.destination.next(e)}error(e){this.destination.error?.(e)}constructor(e,t){this.destination=e,this.effect=t}};function ts(e){return t=>new Tt((i=>t.subscribe(new is(i,e))))}var is=class{next(e){0===this.count?this.destination.next(e):this.count--}error(e){this.destination.error?.(e)}constructor(e,t){this.destination=e,this.count=t,t<0&&this.destination.error?.(new Error("Count can not be less than zero"))}};function ss(e=0){return t=>{let i=0,s=new Li(e),r=t.subscribe(s);return new Tt((e=>(i++,(e=>()=>{e.unsubscribe(),i--,0===i&&r.unsubscribe()})(s.subscribe(e)))))}}var rs,as,ns=((rs=ns||{}).NETWORK="network",rs.VIDEO_PIPELINE="video_pipeline",rs.EXTERNAL_API="external_api",rs.PARSER="parser",rs.DOM="dom",rs.WTF="wtf",rs.FATAL="fatal",rs),{NativeAbortSignal:os,NativeAbortController:us}={NativeAbortSignal:(as=typeof self<"u"?self:global).AbortSignal,NativeAbortController:as.AbortController};var hs=class{addEventListener(e,t,i){e in this.listeners||(this.listeners[e]=[]),this.listeners[e].push({callback:t,options:i})}removeEventListener(e,t){if(!(e in this.listeners))return;let i=this.listeners[e];for(let e=0,s=i.length;e<s;e++)if(i[e].callback===t)return void i.splice(e,1)}dispatchEvent(e){if(!(e.type in this.listeners))return;let t=this.listeners[e.type].slice();for(let i=0,s=t.length;i<s;i++){let s=t[i];try{s.callback.call(this,e)}catch(e){Promise.resolve().then((()=>{throw e}))}s.options&&s.options.once&&this.removeEventListener(e.type,s.callback)}return!e.defaultPrevented}constructor(){Object.defineProperty(this,"listeners",{value:{},writable:!0,configurable:!0})}},ds=class extends hs{toString(){return"[object AbortSignal]"}dispatchEvent(e){"abort"===e.type&&(this.aborted=!0,"function"==typeof this.onabort&&this.onabort.call(this,e)),super.dispatchEvent(e)}throwIfAborted(){let{aborted:e,reason:t="Aborted"}=this;if(e)throw t}static timeout(e){let t=new ls;return setTimeout((()=>t.abort(new DOMException(`This signal is timeout in ${e}ms`,"TimeoutError"))),e),t.signal}static any(e){let t=new ls;function i(){t.abort(this.reason),function(){for(let t of e)t.removeEventListener("abort",i)}()}for(let s of e){if(s.aborted){t.abort(s.reason);break}s.addEventListener("abort",i)}return t.signal}constructor(){super(),this.listeners||hs.call(this),Object.defineProperty(this,"aborted",{value:!1,writable:!0,configurable:!0}),Object.defineProperty(this,"onabort",{value:null,writable:!0,configurable:!0}),Object.defineProperty(this,"reason",{value:void 0,writable:!0,configurable:!0})}},ls=class{abort(e){let t=function(e){if(void 0===e)if(typeof document>"u")(e=new Error("This operation was aborted")).name="AbortError";else try{e=new DOMException("signal is aborted without reason"),Object.defineProperty(e,"name",{value:"AbortError"})}catch{(e=new Error("This operation was aborted")).name="AbortError"}return e}(e),i=function(e){let t;try{t=new Event("abort")}catch{typeof document<"u"?document.createEvent?(t=document.createEvent("Event"),t.initEvent("abort",!1,!1)):(t=document.createEventObject(),t.type="abort"):t={type:"abort",bubbles:!1,cancelable:!1}}return t.reason=e,t}(t);this.signal.reason=t,this.signal.dispatchEvent(i)}toString(){return"[object AbortController]"}constructor(){Object.defineProperty(this,"signal",{value:new ds,writable:!0,configurable:!0})}};function cs(e){return e.__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL?(console.log("__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL=true is set, will force install polyfill"),!0):"function"==typeof e.Request&&!e.Request.prototype.hasOwnProperty("signal")||!e.AbortController}typeof Symbol<"u"&&Symbol.toStringTag&&(ls.prototype[Symbol.toStringTag]="AbortController",ds.prototype[Symbol.toStringTag]="AbortSignal");var ps,fs="fetch"in window&&cs({fetch:window.fetch,Request:window.Request,AbortController:window.AbortController}),ms=fs?function(e){"function"==typeof e&&(e={fetch:e});let{fetch:t,Request:i=t.Request,AbortController:s,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:r=!1}=e;if(!cs({fetch:t,Request:i,AbortController:s,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:r}))return{fetch:t,Request:a};let a=i;(a&&!a.prototype.hasOwnProperty("signal")||r)&&(a=function(e,t){let s;t&&t.signal&&(s=t.signal,delete t.signal);let r=new i(e,t);return s&&Object.defineProperty(r,"signal",{writable:!1,enumerable:!1,configurable:!0,value:s}),r},a.prototype=i.prototype);let n=t;return{fetch:(e,t)=>{let i=a&&a.prototype.isPrototypeOf(e)?e.signal:t?t.signal:void 0;if(i){let s;try{s=new DOMException("Aborted","AbortError")}catch{s=new Error("Aborted"),s.name="AbortError"}if(i.aborted)return Promise.reject(s);let r=new Promise(((e,t)=>{i.addEventListener("abort",(()=>t(s)),{once:!0})}));return t&&t.signal&&delete t.signal,Promise.race([r,n(e,t)])}return n(e,t)},Request:a}}({fetch:window.fetch,Request:window.Request,AbortController:window.AbortController}):void 0,gs=fs?ms.fetch:window.fetch,bs=(fs?ms.Request:window.Request,fs||window.AbortController,fs||window.AbortSignal,c(Me(),1)),vs=c(ft(),1),ys=(e=>(e.Armenian="58",e.Azerbaijani="57",e.Belarusian="114",e.English="3",e.Kazakh="97",e.Portuguese="73",e.Russian="0",e.Spanish="4",e.Ukrainian="1",e.Uzbek="65",e.Vietnamese="75",e))(ys||{}),Ss=async(e,t,i)=>{let s=new URL("https://vk.com/js/lang-pack.js");s.searchParams.set("format","json"),s.searchParams.set("name",t),void 0!==e&&s.searchParams.set("lang",e);let r=await(await gs(s.toString())).json();return ws(r,i)},ws=(e,t)=>(0,vs.default)((0,bs.default)(e.keys).map((([e,i])=>[e.substring(`${t}_`.length),Ts(i)]))),Ts=e=>Array.isArray(e)?e[0]:e,$s=((ps=$s||{}).RU="ru",ps.EN="en",ps),xs="__vk_vp_internals_exposure",ks=class{getWindowObject(){if(typeof window>"u")return{};let e=this.playerId,t=this.type;return window[xs]?.[e]?.[t]??{}}initWindowObjects(){if(typeof window>"u")return;let e=this.playerId,t=this.type;window[xs]||(window[xs]={}),window[xs][e]||(window[xs][e]={}),window[xs][e][t]||(window[xs][e][t]={})}expose(e){typeof window>"u"||Object.assign(this.getWindowObject(),e)}destroy(){if(typeof window>"u")return;let e=this.playerId,t=this.type;window[xs]&&window[xs][e]&&window[xs][e][t]&&(delete window[xs][e][t],Object.keys(window[xs][e]).length||delete window[xs][e],Object.keys(window[xs]).length||delete window[xs])}constructor(e,t){this.playerId=t,this.type=e,this.initWindowObjects()}},Ls={};l(Ls,{create:()=>Es,destroy:()=>Bs,push:()=>As,subscribe:()=>Ms});var Rs=new Map,Es=(e,t)=>Rs.set(e,t??[]),Bs=e=>Rs.delete(e),As=(e,t)=>{let i=Rs.get(e);i&&("function"==typeof i?i(t):i.push(t))},Ms=(e,t)=>{let i=Rs.get(e);if(i){if(i&&Array.isArray(i))for(let e of i)t(e);Rs.set(e,t)}}}}]),"undefined"!=typeof window&&window.stManager?.done?.("dist/core_spa/chunks/99758.e7a4ecc0.js")}catch(e){throw"undefined"!=typeof window&&window.stManager?.fail?.("dist/core_spa/chunks/99758.e7a4ecc0.js",e),e}